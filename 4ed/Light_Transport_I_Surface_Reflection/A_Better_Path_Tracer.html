
<!doctype html>
<html lang="en">
<head>

<!-- all praise to https://realfavicongenerator.net -->
<link rel="icon" href="/favicon.ico?v=2" /> <!-- force refresh -->
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">

  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="/fonts.css">
  <link rel="stylesheet" href="../pbrstyle.css">
  <link rel="stylesheet" href="/fontawesome-free-5.15.3-web/css/all.css">

<script async src="https://cse.google.com/cse.js?cx=22a43cef261a245ea"></script>  <script src="/react.min.js"></script>
  <script src="/react-dom.min.js"></script>
  <script src="/jeri.min.js"></script>
  <link rel="preload" href="/exr.worker.js" as="script" crossorigin="anonymous">
  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="/bootstrap.min.css">

  <title>A Better Path Tracer</title>
</head>
        
<body>

<nav class="fixed-top-lg-navbar navbar navbar-expand bg-light navbar-light">
  <ul class="nav navbar-nav">
    <a class="navbar-brand" href="../contents.html"><img src="../pbr.jpg" width=25 height=25></a>
    <li class="nav-item"><a class="nav-link" href="../Light_Transport_I_Surface_Reflection.html">Light Transport I: Surface Reflection</a></li>
    <span class="navbar-text">/</span>
    <li class="nav-item"><a class="nav-link" href="#">A Better Path Tracer</a></li>
    <span class="navbar-text">&nbsp;&nbsp;</span>
    <li class="nav-item"><a class="nav-link" href="../Light_Transport_I_Surface_Reflection/A_Simple_Path_Tracer.html">(Previous: A Simple Path Tracer)</a></li>
  </ul>

  <ul class="nav navbar-nav ml-auto d-none d-md-block">
        <li class="nav-item"><div class="gcse-search"></div></li>
    </ul>
  <ul class="nav navbar-nav d-block d-md-none">
        <li class="nav-item"><div class="gcse-search"></div></li>
    </ul>
</nav>

<div class="maincontainer">
<div class="container-fluid">

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">
<a href="#"><i class="fas fa-link "></i></a>
</div>
<div class="col-md-10 col-lg-8">
<span class="anchor" id="sec:path-implementation"></span><h2>13.4 A Better Path Tracer</h2><p>



</p>
<p>The <a href="#PathIntegrator"><tt>PathIntegrator</tt></a> is based on the same path tracing approach as the
<a href="../Light_Transport_I_Surface_Reflection/A_Simple_Path_Tracer.html#SimplePathIntegrator"><tt>SimplePathIntegrator</tt></a> but incorporates a number of improvements.  They
include these:
</p>
<ul>
<li> The direct lighting calculation is performed by sampling both the
BSDF and the sampled light source and weighting both samples using multiple
importance sampling.  This approach can substantially reduce variance
compared to sampling the light alone.

<li> Any <a href="../Light_Sources/Light_Sampling.html#LightSampler"><tt>LightSampler</tt></a> can be used, which makes it possible to
use effective light sampling algorithms like the one implemented in <a href="../Light_Sources/Light_Sampling.html#BVHLightSampler"><tt>BVHLightSampler</tt></a> to
choose lights.

<li> It initializes the <a href="../Cameras_and_Film/Film_and_Imaging.html#VisibleSurface"><tt>VisibleSurface</tt></a> when it is provided, giving geometric
information about the first intersection point to <tt>Film</tt>
implementations like <a href="../Cameras_and_Film/Film_and_Imaging.html#GBufferFilm"><tt>GBufferFilm</tt></a>.

<li> Russian roulette is used to terminate paths, which can significantly
boost the integrator&rsquo;s efficiency.

<li> A technique known as <em>path regularization</em> can be applied in
order to reduce variance from difficult-to-sample paths.
</ul><p>

While these additions make its implementation more complex, they also
substantially improve efficiency; see Figure&nbsp;<a href="#fig:simplepath-vs-path-integrators">13.7</a>
for a comparison of the two.

</p>
<p></p>
<span class="anchor" id="fig:simplepath-vs-path-integrators"></span><div class="card outerfigure"><div class="card-body figure"><p>


</p>

<div class="card-img-top" style="display:block; width: 100%; padding-top: 64.388%;  position:relative;">
<div id="xa_SimplePathIntegrator57" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0;"></div></div>
<script>
Jeri.renderViewer(document.getElementById('xa_SimplePathIntegrator57'), {
  title: '(a)_SimplePathIntegrator57', children: [
 { title: '(a) SimplePathIntegrator', image: 'sanmiguel-simplepath.exr' },  { title: '(b) PathIntegrator', image: 'sanmiguel-path.exr' }]});
</script>
<button data-toggle="tooltip" data-placement="left" class="btn yojeri" title="This image is interactive. Click and drag to pan and use the mouse-wheel to zoom. After clicking on the image to select it, type '?' to see a summary of keyboard controls."><i class="fa fa-snowflake fa-border"></i></button><p>

</p>
<figcaption class="caption">Figure 13.7: Comparison of the <a href="../Light_Transport_I_Surface_Reflection/A_Simple_Path_Tracer.html#SimplePathIntegrator"><tt>SimplePathIntegrator</tt></a> and the
<a href="#PathIntegrator"><tt>PathIntegrator</tt></a>. <span class="legend">
(a)&nbsp;Rendered using the <a href="../Light_Transport_I_Surface_Reflection/A_Simple_Path_Tracer.html#SimplePathIntegrator"><tt>SimplePathIntegrator</tt></a> with 64 samples per
pixel.
(b)&nbsp;The <a href="#PathIntegrator"><tt>PathIntegrator</tt></a>, also with 64 samples per pixel.
Once again, improving the underlying sampling algorithms leads to a 
substantial reduction in error.   Not only is MSE improved by a factor of
<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.134ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 1780 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">1.97</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2E" d="M192 53c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-39" d="M457 329c0 -215 -122 -351 -251 -351c-85 0 -139 41 -139 108c0 39 30 48 46 48c22 0 46 -15 46 -46c0 -17 -8 -46 -52 -46c27 -34 81 -36 98 -36c58 0 162 46 162 280v32c-23 -58 -64 -100 -125 -100c-112 0 -200 98 -200 223c0 75 23 117 64 162c43 45 92 63 147 63 c89 0 204 -68 204 -337zM365 421c0 46 -4 109 -16 141c-17 45 -50 79 -96 79c-35 0 -73 -13 -100 -63c-21 -37 -21 -84 -21 -138c0 -49 0 -99 18 -136c31 -63 77 -63 93 -63c88 0 122 97 122 180Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-37" d="M485 644c0 -21 0 -23 -9 -35l-135 -190c-44 -62 -58 -148 -62 -171c-8 -54 -11 -109 -11 -164v-51c0 -10 0 -55 -46 -55s-46 45 -46 55c0 102 33 241 123 376l112 158h-207c-13 0 -91 0 -98 -6c-13 -12 -22 -75 -25 -91h-25l33 206h25c4 -19 6 -32 128 -32h243Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-31"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2E" x="500" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-39" x="779" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-37" x="1279" y="0"></use>
</g>
</svg>, but execution time is <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.942ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 2558.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">4.44 times</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-34" d="M471 165h-100v-87c0 -36 2 -47 76 -47h21v-31c-41 3 -94 3 -136 3s-94 0 -135 -3v31h21c74 0 76 11 76 47v87h-266v31l307 469c8 12 11 12 20 12c16 0 16 -6 16 -26v-455h100v-31zM300 196v373l-244 -373h244Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2E" d="M192 53c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-D7" d="M624 15c-7 -8 -20 -8 -28 0l-207 207l-207 -207c-8 -8 -21 -8 -28 0c-8 7 -8 20 0 28l207 207l-207 207c-8 8 -8 21 0 28c7 8 20 8 28 0l207 -207l207 207c8 8 21 8 28 0c8 -7 8 -20 0 -28l-207 -207l207 -207c8 -8 8 -21 0 -28Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-34"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2E" x="500" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-34" x="779" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-34" x="1279" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-D7" x="1780" y="0"></use>
</g>
</svg> faster, giving an overall
efficiency improvement of <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.942ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 2558.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">8.75 times</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-38" d="M457 168c0 -107 -95 -190 -208 -190c-105 0 -207 67 -207 173c0 99 86 155 144 184c-25 17 -62 42 -73 54c-42 47 -44 92 -44 110c0 93 81 167 181 167c91 0 180 -57 180 -149c0 -66 -49 -118 -121 -155c64 -40 80 -50 99 -71c38 -42 49 -87 49 -123zM386 517 c0 72 -64 124 -137 124c-71 0 -136 -42 -136 -103c0 -17 4 -51 50 -81l124 -80c60 35 99 83 99 140zM407 132c0 61 -47 91 -75 110l-123 78c-85 -47 -117 -111 -117 -169c0 -83 72 -145 158 -145c82 0 157 52 157 126Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2E" d="M192 53c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-37" d="M485 644c0 -21 0 -23 -9 -35l-135 -190c-44 -62 -58 -148 -62 -171c-8 -54 -11 -109 -11 -164v-51c0 -10 0 -55 -46 -55s-46 45 -46 55c0 102 33 241 123 376l112 158h-207c-13 0 -91 0 -98 -6c-13 -12 -22 -75 -25 -91h-25l33 206h25c4 -19 6 -32 128 -32h243Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-35" d="M449 201c0 -127 -102 -223 -218 -223c-112 0 -181 97 -181 183c0 46 35 53 49 53c33 0 50 -25 50 -49s-17 -49 -50 -49c-11 0 -14 1 -17 2c17 -59 74 -112 147 -112c46 0 83 26 107 65c24 42 24 102 24 137c0 50 -2 89 -18 126c-8 18 -33 64 -85 64 c-81 0 -118 -54 -129 -70c-4 -6 -6 -9 -13 -9c-14 0 -14 8 -14 26v296c0 16 0 24 10 24c0 0 4 0 12 -3c47 -21 93 -28 133 -28c67 0 116 20 136 29c5 3 8 3 8 3c7 0 10 -5 10 -11c0 -13 -70 -104 -193 -104c-32 0 -65 7 -85 13v-195c36 35 79 51 127 51 c108 0 190 -100 190 -219Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-D7" d="M624 15c-7 -8 -20 -8 -28 0l-207 207l-207 -207c-8 -8 -21 -8 -28 0c-8 7 -8 20 0 28l207 207l-207 207c-8 8 -8 21 0 28c7 8 20 8 28 0l207 -207l207 207c8 8 21 8 28 0c8 -7 8 -20 0 -28l-207 -207l207 -207c8 -8 8 -21 0 -28Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-38"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2E" x="500" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-37" x="779" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-35" x="1279" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-D7" x="1780" y="0"></use>
</g>
</svg>.
<em>(Scene courtesy of Guillermo M. Leal Llaguno.)</em>
</span>
</figcaption><p>


</p>
</div></div><p>


</p>
<p>The most important of these differences is how the direct lighting
calculation is performed.  In the <a href="../Light_Transport_I_Surface_Reflection/A_Simple_Path_Tracer.html#SimplePathIntegrator"><tt>SimplePathIntegrator</tt></a>, a light was
chosen with uniform probability and then that light sampled a direction;
the corresponding estimator was given by Equation&nbsp;(<a href="../Light_Transport_I_Surface_Reflection/A_Simple_Path_Tracer.html#eq:simple-pt-pathcontrib">13.9</a>).  More
generally, the path contribution estimator can be expressed in terms of an
arbitrary directional probability distribution <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.243ex" height="2.009ex" style="vertical-align: -0.671ex; margin-left: -0.073ex;" viewBox="-31.5 -576.1 535 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">p</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45D" d="M490 282c0 -147 -125 -293 -241 -293c-51 0 -79 35 -92 64c-7 -25 -49 -188 -49 -200c0 -9 0 -16 50 -16c14 0 24 0 24 -11c0 -20 -13 -20 -18 -20c-32 0 -66 3 -99 3c-28 0 -57 -3 -84 -3c-8 0 -13 4 -13 12c0 19 11 19 23 19c44 0 46 7 54 41l112 445c4 17 7 28 7 51 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c37 0 80 -21 90 -75c33 39 81 75 131 75c76 0 133 -66 133 -160zM418 326c0 59 -24 94 -64 94c-17 0 -46 -7 -81 -38c-18 -15 -45 -43 -52 -70 l-49 -196c-3 -12 -3 -16 -3 -16c0 -6 13 -89 79 -89c37 0 85 33 119 103c18 38 51 153 51 212Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
</g>
</svg>, which gives
</p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">
<div class="displaymath"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="67.267ex" height="6.509ex" style="vertical-align: -2.671ex;" viewBox="0 -1652.5 28961.9 2802.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">upper P left-parenthesis normal p Subscript Baseline overbar Subscript i Baseline right-parenthesis almost-equals StartFraction upper L Subscript normal e Baseline left-parenthesis normal p Subscript i Baseline right-arrow normal p Subscript i minus 1 Baseline right-parenthesis f Subscript Baseline left-parenthesis normal p Subscript i Baseline right-arrow normal p Subscript i minus 1 Baseline right-arrow normal p Subscript i minus 2 Baseline right-parenthesis StartAbsoluteValue cosine theta Subscript i Baseline EndAbsoluteValue upper V left-parenthesis normal p Subscript i Baseline left-right-arrow normal p Subscript i minus 1 Baseline right-parenthesis Over p left-parenthesis omega Subscript i Baseline right-parenthesis EndFraction beta period</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D443" d="M754 532c0 -112 -139 -216 -281 -216h-170l-62 -250c-1 -6 -3 -11 -3 -17c0 -18 28 -18 65 -18c19 0 28 0 28 -11c0 -20 -13 -20 -20 -20c-21 0 -43 2 -65 2l-64 1l-127 -3c-3 0 -15 0 -15 12c0 19 11 19 28 19c79 0 81 8 91 47l134 537c3 12 4 15 4 19 c0 11 -6 14 -22 16c-12 1 -30 2 -43 2c-20 0 -29 0 -29 12c0 19 11 19 30 19h324c131 0 197 -74 197 -151zM661 556c0 69 -53 96 -136 96h-96c-43 0 -45 -3 -54 -38l-68 -272h141c44 0 104 8 154 53c39 36 59 122 59 161Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-AF" d="M431 589h-361v31h361v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D456" d="M284 625c0 -30 -30 -53 -53 -53c-24 0 -38 17 -38 36c0 27 27 53 54 53c23 0 37 -16 37 -36zM293 143c0 -9 -37 -154 -131 -154c-48 0 -82 35 -82 82c0 21 13 54 23 80c16 43 61 159 69 185c4 10 11 31 11 52c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124 c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 38 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -13 -53c-10 -27 -10 -29 -22 -58l-39 -105c-23 -61 -29 -75 -29 -100c0 -23 7 -33 24 -33c51 0 84 61 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2248" d="M717 438v-2c-20 -93 -56 -149 -139 -169c-11 -3 -23 -4 -35 -4c-62 0 -120 37 -172 76c-43 32 -89 67 -138 67c-9 0 -17 -1 -26 -3c-67 -17 -111 -49 -127 -124c-1 -5 -6 -9 -12 -9c-7 0 -12 5 -12 12v2c20 93 56 149 139 169c12 3 24 4 35 4c62 0 120 -37 172 -76 c43 -32 89 -67 139 -67c8 0 16 1 25 3c67 17 111 49 127 124c2 5 6 9 12 9c7 0 12 -5 12 -12zM717 218v-2c-20 -93 -56 -149 -139 -169c-11 -3 -23 -4 -35 -4c-62 0 -120 37 -172 76c-43 32 -89 67 -138 67c-9 0 -17 -1 -26 -3c-67 -17 -111 -49 -127 -124 c-1 -5 -6 -9 -12 -9c-7 0 -12 5 -12 12v2c20 93 56 149 139 169c12 3 24 4 35 4c62 0 120 -37 172 -76c43 -32 89 -67 139 -67c8 0 16 1 25 3c67 17 111 49 127 124c2 5 6 9 12 9c7 0 12 -5 12 -12Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D43F" d="M643 247c0 0 0 -3 -4 -14l-79 -216c-6 -17 -7 -17 -31 -17h-463c-18 0 -27 0 -27 11c0 20 10 20 27 20c79 0 81 8 91 47l134 537c3 12 4 15 4 19c0 13 -9 14 -27 16c-17 2 -38 2 -38 2c-19 0 -28 0 -28 11c0 20 12 20 19 20l133 -3l148 3c5 0 16 0 16 -12 c0 -19 -8 -19 -38 -19c-94 0 -97 -11 -106 -47l-135 -540c-5 -18 -5 -20 -5 -23c0 -8 3 -9 13 -10c6 -1 8 -1 22 -1h94c173 0 217 114 251 206c7 16 8 21 17 21s12 -7 12 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-65" d="M415 119c0 -19 -45 -130 -167 -130c-115 0 -220 97 -220 231c0 125 92 228 208 228c125 0 179 -97 179 -196c0 -21 -3 -21 -25 -21h-279c0 -36 0 -102 30 -150c23 -37 63 -67 113 -67c10 0 100 0 135 103c2 8 4 14 13 14c5 0 13 -2 13 -12zM349 252 c0 39 -10 174 -113 174c-34 0 -118 -25 -124 -174h237Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-69" d="M247 0c-34 1 -69 3 -104 3l-110 -3v31c67 0 78 0 78 45v269c0 49 -9 55 -74 55v31l140 11v-367c0 -39 4 -44 70 -44v-31zM192 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2192" d="M943 250c0 -6 -4 -11 -9 -13c-57 -19 -101 -59 -137 -104c-28 -36 -49 -80 -58 -127c-2 -9 -10 -16 -20 -16c-11 0 -20 9 -20 20c0 1 1 3 1 4c10 53 33 102 66 144c22 28 48 52 78 72h-766c-11 0 -20 9 -20 20s9 20 20 20h766c-30 20 -56 44 -78 72 c-33 42 -56 91 -66 144c0 1 -1 3 -1 4c0 11 9 20 20 20c10 0 18 -7 20 -16c9 -47 30 -91 58 -127c36 -45 80 -85 137 -104c5 -2 9 -7 9 -13Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2212" d="M722 250c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D453" d="M552 636c0 -38 -29 -60 -55 -60c-19 0 -37 12 -37 35c0 15 10 50 54 54c-19 18 -45 18 -49 18c-21 0 -38 -15 -47 -34c-6 -12 -20 -83 -24 -104c-11 -58 -10 -56 -21 -114h83c17 0 27 0 27 -11c0 -20 -10 -20 -30 -20h-86l-60 -317c-1 -7 -24 -128 -56 -191 c-18 -38 -58 -97 -113 -97c-41 0 -85 24 -85 69c0 38 29 60 55 60c19 0 37 -12 37 -35c0 -15 -9 -51 -55 -54c19 -18 44 -18 48 -18c52 0 69 91 87 188l75 395h-66c-19 0 -28 0 -28 12c0 19 11 19 30 19h69c24 126 27 136 33 157c30 99 93 117 127 117c41 0 87 -23 87 -69Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-32" d="M449 174l-28 -174h-371c0 24 0 26 11 37l192 214c55 62 105 141 105 221c0 82 -43 163 -134 163c-58 0 -112 -37 -135 -102c3 1 5 1 13 1c35 0 53 -26 53 -52c0 -41 -35 -53 -52 -53c-3 0 -53 0 -53 56c0 89 74 181 187 181c122 0 212 -80 212 -194 c0 -100 -60 -154 -216 -292l-106 -103h180c22 0 88 0 95 8c10 15 17 59 22 89h25Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-7C" d="M159 -230c0 -11 -9 -20 -20 -20s-20 9 -20 20v960c0 11 9 20 20 20s20 -9 20 -20v-960Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-63" d="M415 119c0 -10 -32 -130 -166 -130c-116 0 -215 99 -215 227c0 124 92 232 217 232c77 0 153 -39 153 -107c0 -30 -20 -47 -46 -47c-28 0 -46 20 -46 46c0 13 6 43 47 46c-35 36 -98 37 -107 37c-53 0 -135 -42 -135 -205c0 -161 88 -204 141 -204c37 0 102 12 131 105 c2 6 4 10 13 10c3 0 13 0 13 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6F" d="M471 214c0 -127 -101 -225 -222 -225c-117 0 -221 96 -221 225c0 125 97 234 222 234c121 0 221 -106 221 -234zM388 222c0 38 0 96 -26 139s-69 65 -113 65c-40 0 -87 -21 -114 -67c-24 -44 -24 -98 -24 -137c0 -36 0 -97 25 -141c27 -46 71 -67 114 -67 c50 0 94 29 116 74c22 44 22 98 22 134Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-73" d="M360 128c0 -72 -46 -139 -161 -139c-21 0 -66 1 -110 43c-18 -19 -18 -21 -20 -23c-19 -19 -20 -20 -25 -20c-11 0 -11 7 -11 24v132c0 18 0 25 13 25c10 0 11 -4 14 -17c19 -85 55 -142 139 -142c78 0 113 40 113 91c0 72 -82 88 -104 92c-72 14 -100 20 -132 46 c-27 22 -43 50 -43 85c0 56 38 123 160 123c15 0 56 0 94 -28c4 3 14 12 17 16c13 12 15 12 20 12c11 0 11 -7 11 -24v-101c0 -19 0 -24 -13 -24c0 0 -11 0 -12 9c-2 31 -7 121 -117 121c-86 0 -112 -41 -112 -76c0 -58 67 -71 123 -82c42 -8 81 -16 114 -48 c12 -12 42 -42 42 -95Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D703" d="M455 500c0 -224 -152 -511 -293 -511c-91 0 -120 111 -120 205c0 229 154 511 293 511c102 0 120 -139 120 -205zM389 562c0 57 -6 121 -55 121c-45 0 -82 -56 -109 -105c-40 -71 -60 -151 -77 -215h209c24 99 32 150 32 199zM348 331h-208c-26 -98 -32 -156 -32 -198 c0 -93 21 -122 54 -122c43 0 81 49 116 117c38 72 59 157 70 203Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D449" d="M769 671c0 0 -1 -18 -13 -19c-37 -2 -79 -5 -128 -83l-360 -573c-8 -13 -12 -18 -28 -18c-13 0 -17 3 -20 23l-79 617c-3 25 -4 34 -60 34c-16 0 -25 0 -25 12c0 19 12 19 19 19c17 0 36 -2 54 -2s37 -1 55 -1c41 0 84 3 124 3c6 0 14 -2 14 -11c0 -20 -11 -20 -25 -20 c-46 0 -69 -13 -69 -30l68 -529l307 488s15 23 15 38c0 21 -19 31 -46 33c-7 0 -16 1 -16 12c0 19 13 19 19 19c32 0 66 -3 99 -3c27 0 56 3 82 3c8 0 13 -4 13 -12Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2194" d="M942 250c0 -6 -4 -11 -9 -13c-57 -19 -101 -59 -137 -104c-28 -36 -49 -80 -58 -127c-2 -9 -10 -16 -20 -16c-11 0 -20 9 -20 20c0 1 1 3 1 4c10 53 33 102 66 144c22 28 48 52 78 72h-686c30 -20 56 -44 78 -72c33 -42 56 -91 66 -144c0 -1 1 -3 1 -4 c0 -11 -9 -20 -20 -20c-10 0 -18 7 -20 16c-9 47 -30 91 -58 127c-36 45 -80 85 -137 104c-5 2 -9 7 -9 13s4 11 9 13c57 19 101 59 137 104c28 36 49 80 58 127c2 9 10 16 20 16c11 0 20 -9 20 -20c0 -1 -1 -3 -1 -4c-10 -53 -33 -102 -66 -144c-22 -28 -48 -52 -78 -72 h686c-30 20 -56 44 -78 72c-33 42 -56 91 -66 144c0 1 -1 3 -1 4c0 11 9 20 20 20c10 0 18 -7 20 -16c9 -47 30 -91 58 -127c36 -45 80 -85 137 -104c5 -2 9 -7 9 -13Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45D" d="M490 282c0 -147 -125 -293 -241 -293c-51 0 -79 35 -92 64c-7 -25 -49 -188 -49 -200c0 -9 0 -16 50 -16c14 0 24 0 24 -11c0 -20 -13 -20 -18 -20c-32 0 -66 3 -99 3c-28 0 -57 -3 -84 -3c-8 0 -13 4 -13 12c0 19 11 19 23 19c44 0 46 7 54 41l112 445c4 17 7 28 7 51 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c37 0 80 -21 90 -75c33 39 81 75 131 75c76 0 133 -66 133 -160zM418 326c0 59 -24 94 -64 94c-17 0 -46 -7 -81 -38c-18 -15 -45 -43 -52 -70 l-49 -196c-3 -12 -3 -16 -3 -16c0 -6 13 -89 79 -89c37 0 85 33 119 103c18 38 51 153 51 212Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D6FD" d="M574 574c0 -12 -2 -24 -5 -37c-11 -45 -41 -86 -81 -116c-10 -8 -20 -14 -30 -20c17 -11 31 -26 43 -43c20 -31 30 -68 30 -108c0 -20 -3 -42 -8 -64c-14 -53 -51 -104 -99 -140c-52 -38 -113 -57 -170 -57c-68 0 -114 40 -131 98l-68 -274c-1 -4 -5 -7 -10 -7h-5 c-6 0 -10 4 -10 12l154 615c34 136 125 273 245 273c47 0 89 -18 116 -50c18 -22 29 -51 29 -82zM518 592c0 19 -3 36 -12 51c-16 26 -44 40 -78 40c-110 0 -188 -129 -220 -255l-60 -242c-4 -17 -6 -33 -6 -49c0 -71 41 -126 113 -126c44 0 91 19 129 52 c39 35 61 82 73 128c7 29 12 59 12 87c0 25 -4 48 -14 69c-7 16 -17 29 -30 39c-25 -9 -50 -13 -75 -13c-35 0 -76 0 -76 24c0 0 0 5 1 7c7 27 49 27 85 27c24 0 47 -5 67 -13c9 5 18 12 26 19c31 29 49 67 58 105c5 17 7 34 7 50zM395 403c-11 3 -23 5 -36 5 c-24 0 -57 0 -60 -9c-1 -4 30 -4 52 -4c14 0 29 3 44 8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2E" d="M192 53c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D443" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="754" y="0"></use>
<g transform="translate(1144,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-AF" x="28" y="-38"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="787" y="-326"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="2044" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2248" x="2712" y="0"></use>
<g transform="translate(3485,0)">
<g transform="translate(397,0)">
<rect stroke="none" width="24105" height="60" x="0" y="220"></rect>
<g transform="translate(60,770)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D43F" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-65" x="963" y="-213"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="1095" y="0"></use>
<g transform="translate(1485,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="787" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2192" x="2616" y="0"></use>
<g transform="translate(3894,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
<g transform="translate(556,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="278" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1057" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="5652" y="0"></use>
<g transform="translate(6042,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D453" x="0" y="0"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="6799" y="0"></use>
<g transform="translate(7188,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="787" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2192" x="8319" y="0"></use>
<g transform="translate(9598,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
<g transform="translate(556,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="278" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1057" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2192" x="11633" y="0"></use>
<g transform="translate(12912,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
<g transform="translate(556,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="278" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-32" x="1057" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="14669" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-7C" x="15226" y="0"></use>
<g transform="translate(15504,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-63"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-6F" x="444" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-73" x="945" y="0"></use>
</g>
<g transform="translate(17010,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D703" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="663" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-7C" x="17824" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D449" x="18269" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="19039" y="0"></use>
<g transform="translate(19428,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="787" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2194" x="20559" y="0"></use>
<g transform="translate(21838,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
<g transform="translate(556,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="278" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1057" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="23596" y="0"></use>
</g>
<g transform="translate(10951,-769)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="503" y="0"></use>
<g transform="translate(893,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="880" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="1812" y="0"></use>
</g>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D6FD" x="28108" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2E" x="28683" y="0"></use>
</g>
</svg>
</div>
<p>


</p>
<p>It may seem that using only a sampling PDF that matches the <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.545ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 1095.8 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">upper L Subscript normal e</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D43F" d="M643 247c0 0 0 -3 -4 -14l-79 -216c-6 -17 -7 -17 -31 -17h-463c-18 0 -27 0 -27 11c0 20 10 20 27 20c79 0 81 8 91 47l134 537c3 12 4 15 4 19c0 13 -9 14 -27 16c-17 2 -38 2 -38 2c-19 0 -28 0 -28 11c0 20 12 20 19 20l133 -3l148 3c5 0 16 0 16 -12 c0 -19 -8 -19 -38 -19c-94 0 -97 -11 -106 -47l-135 -540c-5 -18 -5 -20 -5 -23c0 -8 3 -9 13 -10c6 -1 8 -1 22 -1h94c173 0 217 114 251 206c7 16 8 21 17 21s12 -7 12 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-65" d="M415 119c0 -19 -45 -130 -167 -130c-115 0 -220 97 -220 231c0 125 92 228 208 228c125 0 179 -97 179 -196c0 -21 -3 -21 -25 -21h-279c0 -36 0 -102 30 -150c23 -37 63 -67 113 -67c10 0 100 0 135 103c2 8 4 14 13 14c5 0 13 -2 13 -12zM349 252 c0 39 -10 174 -113 174c-34 0 -118 -25 -124 -174h237Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D43F" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-65" x="963" y="-213"></use>
</g>
</svg>
factor to sample these directions, as done by the
<a href="../Light_Transport_I_Surface_Reflection/A_Simple_Path_Tracer.html#SimplePathIntegrator"><tt>SimplePathIntegrator</tt></a>, would be a good strategy; after all, the
radiance <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.545ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 1095.8 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">upper L Subscript normal e</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D43F" d="M643 247c0 0 0 -3 -4 -14l-79 -216c-6 -17 -7 -17 -31 -17h-463c-18 0 -27 0 -27 11c0 20 10 20 27 20c79 0 81 8 91 47l134 537c3 12 4 15 4 19c0 13 -9 14 -27 16c-17 2 -38 2 -38 2c-19 0 -28 0 -28 11c0 20 12 20 19 20l133 -3l148 3c5 0 16 0 16 -12 c0 -19 -8 -19 -38 -19c-94 0 -97 -11 -106 -47l-135 -540c-5 -18 -5 -20 -5 -23c0 -8 3 -9 13 -10c6 -1 8 -1 22 -1h94c173 0 217 114 251 206c7 16 8 21 17 21s12 -7 12 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-65" d="M415 119c0 -19 -45 -130 -167 -130c-115 0 -220 97 -220 231c0 125 92 228 208 228c125 0 179 -97 179 -196c0 -21 -3 -21 -25 -21h-279c0 -36 0 -102 30 -150c23 -37 63 -67 113 -67c10 0 100 0 135 103c2 8 4 14 13 14c5 0 13 -2 13 -12zM349 252 c0 39 -10 174 -113 174c-34 0 -118 -25 -124 -174h237Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D43F" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-65" x="963" y="-213"></use>
</g>
</svg> can then be expected to be nonzero for
the sampled direction.  If we instead drew samples using the
BSDF&rsquo;s sampling distribution, we might choose directions that did not
intersect a light source at all, finding no emitted radiance after
incurring the expense of tracing a ray in the hope of intersecting a light.

</p>
<p>However, there are cases where sampling the BSDF can be the more effective
strategy.  For a very smooth surface, the BSDF is nonzero for a small set
of directions.  Sampling the light source will be unlikely to find
directions that have a significant effect on scattering from the surface,
especially if the light source is large and close by.  Even worse, when
such a light sample happens to lie in the BSDF lobe, an estimate with large
magnitude will be the result due to the combination of a high contribution
from the numerator and a small value for the PDF in the denominator.  The
estimator has high variance.

</p>
<p>Figure&nbsp;<a href="#fig:sample-bsdf-light">13.8</a> shows a variety of cases where each of
these sampling methods is much better than the other. In this scene, four
rectangular surfaces ranging from very smooth (top) to very rough (bottom)
are illuminated by spherical light sources of decreasing size.
Figures&nbsp;<a href="#fig:sample-bsdf-light">13.8</a>(a) and&nbsp;(b) show the BSDF and light
sampling strategies on their own.  As the example illustrates, sampling the
BSDF is much more effective when it takes on large values on a narrow
set of directions that is much smaller than the set of directions that
would be obtained by sampling the light sources. This case is most visible
in the top left reflection of a large light source in a low-roughness
surface.  On the other hand, sampling the light sources can be considerably
more effective in the opposite case&mdash;when the light source is small and
the BSDF lobe is less concentrated (this case is most visible in the bottom
right reflection).

</p>
<p> </p>
<span class="anchor" id="fig:sample-bsdf-light"></span><div class="card outerfigure"><div class="card-body figure"><p>


</p>
<div class="figure-row">
  <a href="pha13f08.svg" title=""><img src="pha13f08.svg" width=966 height=264 style="max-width: 100%;"></a>
</div>
<p>

</p>
<figcaption class="caption">Figure 13.8: <span class="legend"> 
Four surfaces ranging from very smooth (top) to very rough (bottom)
illuminated by spherical light sources of decreasing size and rendered
with different sampling techniques (modeled after a scene by Eric Veach).
(a)&nbsp;BSDF sampling, (b)&nbsp;light sampling, and (c)&nbsp;both techniques combined
using MIS. Sampling the BSDF is generally more
effective for highly specular materials and large light sources, as
illumination is coming from many directions, but the BSDF&rsquo;s value is large for
only a few of them (top left reflection). The converse is true for small sources and rough materials
(bottom right reflection), where sampling the light source is more effective.</span>
</figcaption><p>


</p>
</div></div><p>


</p>
<p>

</p>
<p>Taking a single sample with each sampling technique and averaging the
estimators would be of limited benefit. The resulting estimator would still
have high variance in cases where one of the sampling strategies was
ineffective and that strategy happened to sample a direction with nonzero
contribution.

</p>
<p>This situation is therefore a natural for the application of multiple importance
sampling&mdash;we have multiple sampling techniques, each of which is sometimes
effective and sometimes not.  That approach is used in the
<a href="#PathIntegrator"><tt>PathIntegrator</tt></a> with one light sample <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="7.081ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 3048.9 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">omega Subscript normal l Baseline tilde p Subscript normal l</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6C" d="M255 0l-111 3l-111 -3v31c67 0 78 0 78 45v520c0 49 -8 56 -78 56v31l144 11v-618c0 -45 11 -45 78 -45v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-223C" d="M717 354c-4 -116 -34 -183 -119 -211c-15 -4 -30 -7 -45 -7c-66 0 -130 46 -184 95c-44 39 -93 81 -146 81c-10 0 -21 -1 -31 -5c-70 -23 -109 -67 -112 -161c0 -7 -6 -12 -12 -12c-7 0 -12 5 -12 12c4 116 34 183 120 211c14 4 29 7 44 7c66 0 130 -46 184 -95 c44 -39 93 -81 146 -81c11 0 21 1 32 5c69 23 108 67 111 161c0 7 6 12 12 12c7 0 12 -5 12 -12Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45D" d="M490 282c0 -147 -125 -293 -241 -293c-51 0 -79 35 -92 64c-7 -25 -49 -188 -49 -200c0 -9 0 -16 50 -16c14 0 24 0 24 -11c0 -20 -13 -20 -18 -20c-32 0 -66 3 -99 3c-28 0 -57 -3 -84 -3c-8 0 -13 4 -13 12c0 19 11 19 23 19c44 0 46 7 54 41l112 445c4 17 7 28 7 51 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c37 0 80 -21 90 -75c33 39 81 75 131 75c76 0 133 -66 133 -160zM418 326c0 59 -24 94 -64 94c-17 0 -46 -7 -81 -38c-18 -15 -45 -43 -52 -70 l-49 -196c-3 -12 -3 -16 -3 -16c0 -6 13 -89 79 -89c37 0 85 33 119 103c18 38 51 153 51 212Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6C" x="880" y="-213"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-223C" x="1197" y="0"></use>
<g transform="translate(2248,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6C" x="712" y="-213"></use>
</g>
</g>
</svg> and one BSDF sample
<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="7.995ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 3442.1 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">omega Subscript normal b Baseline tilde p Subscript normal b</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-62" d="M521 216c0 -129 -104 -227 -223 -227c-74 0 -116 50 -131 73l-36 -62h-25v596c0 49 -8 56 -78 56v31l144 11v-317c16 18 59 65 137 65c114 0 212 -99 212 -226zM438 217c0 41 -3 98 -29 139c-24 38 -60 64 -105 64c-24 0 -79 -8 -118 -64c-11 -16 -11 -17 -11 -36v-206 c0 -18 0 -21 14 -42c24 -37 60 -61 105 -61c54 0 92 33 113 64c29 45 31 105 31 142Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-223C" d="M717 354c-4 -116 -34 -183 -119 -211c-15 -4 -30 -7 -45 -7c-66 0 -130 46 -184 95c-44 39 -93 81 -146 81c-10 0 -21 -1 -31 -5c-70 -23 -109 -67 -112 -161c0 -7 -6 -12 -12 -12c-7 0 -12 5 -12 12c4 116 34 183 120 211c14 4 29 7 44 7c66 0 130 -46 184 -95 c44 -39 93 -81 146 -81c11 0 21 1 32 5c69 23 108 67 111 161c0 7 6 12 12 12c7 0 12 -5 12 -12Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45D" d="M490 282c0 -147 -125 -293 -241 -293c-51 0 -79 35 -92 64c-7 -25 -49 -188 -49 -200c0 -9 0 -16 50 -16c14 0 24 0 24 -11c0 -20 -13 -20 -18 -20c-32 0 -66 3 -99 3c-28 0 -57 -3 -84 -3c-8 0 -13 4 -13 12c0 19 11 19 23 19c44 0 46 7 54 41l112 445c4 17 7 28 7 51 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c37 0 80 -21 90 -75c33 39 81 75 131 75c76 0 133 -66 133 -160zM418 326c0 59 -24 94 -64 94c-17 0 -46 -7 -81 -38c-18 -15 -45 -43 -52 -70 l-49 -196c-3 -12 -3 -16 -3 -16c0 -6 13 -89 79 -89c37 0 85 33 119 103c18 38 51 153 51 212Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-62" x="880" y="-213"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-223C" x="1393" y="0"></use>
<g transform="translate(2445,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-62" x="712" y="-213"></use>
</g>
</g>
</svg>, giving the estimator
</p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">
<span class="anchor" id="eq:mis-direct-lighting-estimator"></span><div class="displaymath"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="81.591ex" height="13.509ex" style="vertical-align: -6.171ex;" viewBox="0 -3159.4 35129.4 5816.5" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">StartLayout 1st Row 1st Column upper P left-parenthesis normal p Subscript Baseline overbar Subscript i Baseline right-parenthesis almost-equals 2nd Column w Subscript normal l Baseline left-parenthesis omega Subscript normal l Baseline right-parenthesis StartFraction upper L Subscript normal e Baseline left-parenthesis normal p Subscript normal l Baseline right-arrow normal p Subscript i minus 1 Baseline right-parenthesis f Subscript Baseline left-parenthesis normal p Subscript normal l Baseline right-arrow normal p Subscript i minus 1 Baseline right-arrow normal p Subscript i minus 2 Baseline right-parenthesis StartAbsoluteValue cosine theta Subscript normal l Baseline EndAbsoluteValue upper V left-parenthesis normal p Subscript normal l Baseline left-right-arrow normal p Subscript i minus 1 Baseline right-parenthesis Over p Subscript normal l Baseline left-parenthesis omega Subscript normal l Baseline right-parenthesis EndFraction beta plus 2nd Row 1st Column Blank 2nd Column w Subscript normal b Baseline left-parenthesis omega Subscript normal b Baseline right-parenthesis StartFraction upper L Subscript normal e Baseline left-parenthesis normal p Subscript normal b Baseline right-arrow normal p Subscript i minus 1 Baseline right-parenthesis f Subscript Baseline left-parenthesis normal p Subscript normal b Baseline right-arrow normal p Subscript i minus 1 Baseline right-arrow normal p Subscript i minus 2 Baseline right-parenthesis StartAbsoluteValue cosine theta Subscript normal b Baseline EndAbsoluteValue upper V left-parenthesis normal p Subscript normal b Baseline left-right-arrow normal p Subscript i minus 1 Baseline right-parenthesis Over p Subscript normal b Baseline left-parenthesis omega Subscript normal b Baseline right-parenthesis EndFraction beta comma EndLayout</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D443" d="M754 532c0 -112 -139 -216 -281 -216h-170l-62 -250c-1 -6 -3 -11 -3 -17c0 -18 28 -18 65 -18c19 0 28 0 28 -11c0 -20 -13 -20 -20 -20c-21 0 -43 2 -65 2l-64 1l-127 -3c-3 0 -15 0 -15 12c0 19 11 19 28 19c79 0 81 8 91 47l134 537c3 12 4 15 4 19 c0 11 -6 14 -22 16c-12 1 -30 2 -43 2c-20 0 -29 0 -29 12c0 19 11 19 30 19h324c131 0 197 -74 197 -151zM661 556c0 69 -53 96 -136 96h-96c-43 0 -45 -3 -54 -38l-68 -272h141c44 0 104 8 154 53c39 36 59 122 59 161Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-AF" d="M431 589h-361v31h361v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D456" d="M284 625c0 -30 -30 -53 -53 -53c-24 0 -38 17 -38 36c0 27 27 53 54 53c23 0 37 -16 37 -36zM293 143c0 -9 -37 -154 -131 -154c-48 0 -82 35 -82 82c0 21 13 54 23 80c16 43 61 159 69 185c4 10 11 31 11 52c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124 c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 38 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -13 -53c-10 -27 -10 -29 -22 -58l-39 -105c-23 -61 -29 -75 -29 -100c0 -23 7 -33 24 -33c51 0 84 61 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2248" d="M717 438v-2c-20 -93 -56 -149 -139 -169c-11 -3 -23 -4 -35 -4c-62 0 -120 37 -172 76c-43 32 -89 67 -138 67c-9 0 -17 -1 -26 -3c-67 -17 -111 -49 -127 -124c-1 -5 -6 -9 -12 -9c-7 0 -12 5 -12 12v2c20 93 56 149 139 169c12 3 24 4 35 4c62 0 120 -37 172 -76 c43 -32 89 -67 139 -67c8 0 16 1 25 3c67 17 111 49 127 124c2 5 6 9 12 9c7 0 12 -5 12 -12zM717 218v-2c-20 -93 -56 -149 -139 -169c-11 -3 -23 -4 -35 -4c-62 0 -120 37 -172 76c-43 32 -89 67 -138 67c-9 0 -17 -1 -26 -3c-67 -17 -111 -49 -127 -124 c-1 -5 -6 -9 -12 -9c-7 0 -12 5 -12 12v2c20 93 56 149 139 169c12 3 24 4 35 4c62 0 120 -37 172 -76c43 -32 89 -67 139 -67c8 0 16 1 25 3c67 17 111 49 127 124c2 5 6 9 12 9c7 0 12 -5 12 -12Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D464" d="M691 372c0 -48 -32 -182 -66 -260c-26 -60 -70 -123 -145 -123c-30 0 -99 6 -125 70c-40 -70 -87 -70 -104 -70c-75 0 -142 35 -142 126c0 38 12 84 56 202c7 17 18 45 18 70c0 32 -16 33 -25 33c-35 0 -74 -31 -101 -124c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10 c0 9 37 154 132 154c49 0 82 -37 82 -82c0 -20 -6 -34 -17 -64c-47 -123 -52 -162 -52 -194c0 -17 0 -91 80 -91c39 0 69 31 92 84c-1 5 -1 7 -1 18c0 18 2 36 9 66c7 26 54 217 57 224c7 20 25 28 37 28c15 0 29 -9 29 -27c0 -6 -10 -43 -15 -65l-42 -168 c-4 -14 -11 -45 -11 -73c0 -57 27 -87 74 -87c49 0 84 35 110 88c26 51 55 149 55 183c0 48 -25 74 -36 85c-9 8 -15 14 -15 27c0 22 25 48 50 48c17 0 44 -15 44 -70Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6C" d="M255 0l-111 3l-111 -3v31c67 0 78 0 78 45v520c0 49 -8 56 -78 56v31l144 11v-618c0 -45 11 -45 78 -45v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D43F" d="M643 247c0 0 0 -3 -4 -14l-79 -216c-6 -17 -7 -17 -31 -17h-463c-18 0 -27 0 -27 11c0 20 10 20 27 20c79 0 81 8 91 47l134 537c3 12 4 15 4 19c0 13 -9 14 -27 16c-17 2 -38 2 -38 2c-19 0 -28 0 -28 11c0 20 12 20 19 20l133 -3l148 3c5 0 16 0 16 -12 c0 -19 -8 -19 -38 -19c-94 0 -97 -11 -106 -47l-135 -540c-5 -18 -5 -20 -5 -23c0 -8 3 -9 13 -10c6 -1 8 -1 22 -1h94c173 0 217 114 251 206c7 16 8 21 17 21s12 -7 12 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-65" d="M415 119c0 -19 -45 -130 -167 -130c-115 0 -220 97 -220 231c0 125 92 228 208 228c125 0 179 -97 179 -196c0 -21 -3 -21 -25 -21h-279c0 -36 0 -102 30 -150c23 -37 63 -67 113 -67c10 0 100 0 135 103c2 8 4 14 13 14c5 0 13 -2 13 -12zM349 252 c0 39 -10 174 -113 174c-34 0 -118 -25 -124 -174h237Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2192" d="M943 250c0 -6 -4 -11 -9 -13c-57 -19 -101 -59 -137 -104c-28 -36 -49 -80 -58 -127c-2 -9 -10 -16 -20 -16c-11 0 -20 9 -20 20c0 1 1 3 1 4c10 53 33 102 66 144c22 28 48 52 78 72h-766c-11 0 -20 9 -20 20s9 20 20 20h766c-30 20 -56 44 -78 72 c-33 42 -56 91 -66 144c0 1 -1 3 -1 4c0 11 9 20 20 20c10 0 18 -7 20 -16c9 -47 30 -91 58 -127c36 -45 80 -85 137 -104c5 -2 9 -7 9 -13Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-69" d="M247 0c-34 1 -69 3 -104 3l-110 -3v31c67 0 78 0 78 45v269c0 49 -9 55 -74 55v31l140 11v-367c0 -39 4 -44 70 -44v-31zM192 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2212" d="M722 250c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D453" d="M552 636c0 -38 -29 -60 -55 -60c-19 0 -37 12 -37 35c0 15 10 50 54 54c-19 18 -45 18 -49 18c-21 0 -38 -15 -47 -34c-6 -12 -20 -83 -24 -104c-11 -58 -10 -56 -21 -114h83c17 0 27 0 27 -11c0 -20 -10 -20 -30 -20h-86l-60 -317c-1 -7 -24 -128 -56 -191 c-18 -38 -58 -97 -113 -97c-41 0 -85 24 -85 69c0 38 29 60 55 60c19 0 37 -12 37 -35c0 -15 -9 -51 -55 -54c19 -18 44 -18 48 -18c52 0 69 91 87 188l75 395h-66c-19 0 -28 0 -28 12c0 19 11 19 30 19h69c24 126 27 136 33 157c30 99 93 117 127 117c41 0 87 -23 87 -69Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-32" d="M449 174l-28 -174h-371c0 24 0 26 11 37l192 214c55 62 105 141 105 221c0 82 -43 163 -134 163c-58 0 -112 -37 -135 -102c3 1 5 1 13 1c35 0 53 -26 53 -52c0 -41 -35 -53 -52 -53c-3 0 -53 0 -53 56c0 89 74 181 187 181c122 0 212 -80 212 -194 c0 -100 -60 -154 -216 -292l-106 -103h180c22 0 88 0 95 8c10 15 17 59 22 89h25Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-7C" d="M159 -230c0 -11 -9 -20 -20 -20s-20 9 -20 20v960c0 11 9 20 20 20s20 -9 20 -20v-960Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-63" d="M415 119c0 -10 -32 -130 -166 -130c-116 0 -215 99 -215 227c0 124 92 232 217 232c77 0 153 -39 153 -107c0 -30 -20 -47 -46 -47c-28 0 -46 20 -46 46c0 13 6 43 47 46c-35 36 -98 37 -107 37c-53 0 -135 -42 -135 -205c0 -161 88 -204 141 -204c37 0 102 12 131 105 c2 6 4 10 13 10c3 0 13 0 13 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6F" d="M471 214c0 -127 -101 -225 -222 -225c-117 0 -221 96 -221 225c0 125 97 234 222 234c121 0 221 -106 221 -234zM388 222c0 38 0 96 -26 139s-69 65 -113 65c-40 0 -87 -21 -114 -67c-24 -44 -24 -98 -24 -137c0 -36 0 -97 25 -141c27 -46 71 -67 114 -67 c50 0 94 29 116 74c22 44 22 98 22 134Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-73" d="M360 128c0 -72 -46 -139 -161 -139c-21 0 -66 1 -110 43c-18 -19 -18 -21 -20 -23c-19 -19 -20 -20 -25 -20c-11 0 -11 7 -11 24v132c0 18 0 25 13 25c10 0 11 -4 14 -17c19 -85 55 -142 139 -142c78 0 113 40 113 91c0 72 -82 88 -104 92c-72 14 -100 20 -132 46 c-27 22 -43 50 -43 85c0 56 38 123 160 123c15 0 56 0 94 -28c4 3 14 12 17 16c13 12 15 12 20 12c11 0 11 -7 11 -24v-101c0 -19 0 -24 -13 -24c0 0 -11 0 -12 9c-2 31 -7 121 -117 121c-86 0 -112 -41 -112 -76c0 -58 67 -71 123 -82c42 -8 81 -16 114 -48 c12 -12 42 -42 42 -95Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D703" d="M455 500c0 -224 -152 -511 -293 -511c-91 0 -120 111 -120 205c0 229 154 511 293 511c102 0 120 -139 120 -205zM389 562c0 57 -6 121 -55 121c-45 0 -82 -56 -109 -105c-40 -71 -60 -151 -77 -215h209c24 99 32 150 32 199zM348 331h-208c-26 -98 -32 -156 -32 -198 c0 -93 21 -122 54 -122c43 0 81 49 116 117c38 72 59 157 70 203Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D449" d="M769 671c0 0 -1 -18 -13 -19c-37 -2 -79 -5 -128 -83l-360 -573c-8 -13 -12 -18 -28 -18c-13 0 -17 3 -20 23l-79 617c-3 25 -4 34 -60 34c-16 0 -25 0 -25 12c0 19 12 19 19 19c17 0 36 -2 54 -2s37 -1 55 -1c41 0 84 3 124 3c6 0 14 -2 14 -11c0 -20 -11 -20 -25 -20 c-46 0 -69 -13 -69 -30l68 -529l307 488s15 23 15 38c0 21 -19 31 -46 33c-7 0 -16 1 -16 12c0 19 13 19 19 19c32 0 66 -3 99 -3c27 0 56 3 82 3c8 0 13 -4 13 -12Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2194" d="M942 250c0 -6 -4 -11 -9 -13c-57 -19 -101 -59 -137 -104c-28 -36 -49 -80 -58 -127c-2 -9 -10 -16 -20 -16c-11 0 -20 9 -20 20c0 1 1 3 1 4c10 53 33 102 66 144c22 28 48 52 78 72h-686c30 -20 56 -44 78 -72c33 -42 56 -91 66 -144c0 -1 1 -3 1 -4 c0 -11 -9 -20 -20 -20c-10 0 -18 7 -20 16c-9 47 -30 91 -58 127c-36 45 -80 85 -137 104c-5 2 -9 7 -9 13s4 11 9 13c57 19 101 59 137 104c28 36 49 80 58 127c2 9 10 16 20 16c11 0 20 -9 20 -20c0 -1 -1 -3 -1 -4c-10 -53 -33 -102 -66 -144c-22 -28 -48 -52 -78 -72 h686c-30 20 -56 44 -78 72c-33 42 -56 91 -66 144c0 1 -1 3 -1 4c0 11 9 20 20 20c10 0 18 -7 20 -16c9 -47 30 -91 58 -127c36 -45 80 -85 137 -104c5 -2 9 -7 9 -13Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45D" d="M490 282c0 -147 -125 -293 -241 -293c-51 0 -79 35 -92 64c-7 -25 -49 -188 -49 -200c0 -9 0 -16 50 -16c14 0 24 0 24 -11c0 -20 -13 -20 -18 -20c-32 0 -66 3 -99 3c-28 0 -57 -3 -84 -3c-8 0 -13 4 -13 12c0 19 11 19 23 19c44 0 46 7 54 41l112 445c4 17 7 28 7 51 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c37 0 80 -21 90 -75c33 39 81 75 131 75c76 0 133 -66 133 -160zM418 326c0 59 -24 94 -64 94c-17 0 -46 -7 -81 -38c-18 -15 -45 -43 -52 -70 l-49 -196c-3 -12 -3 -16 -3 -16c0 -6 13 -89 79 -89c37 0 85 33 119 103c18 38 51 153 51 212Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D6FD" d="M574 574c0 -12 -2 -24 -5 -37c-11 -45 -41 -86 -81 -116c-10 -8 -20 -14 -30 -20c17 -11 31 -26 43 -43c20 -31 30 -68 30 -108c0 -20 -3 -42 -8 -64c-14 -53 -51 -104 -99 -140c-52 -38 -113 -57 -170 -57c-68 0 -114 40 -131 98l-68 -274c-1 -4 -5 -7 -10 -7h-5 c-6 0 -10 4 -10 12l154 615c34 136 125 273 245 273c47 0 89 -18 116 -50c18 -22 29 -51 29 -82zM518 592c0 19 -3 36 -12 51c-16 26 -44 40 -78 40c-110 0 -188 -129 -220 -255l-60 -242c-4 -17 -6 -33 -6 -49c0 -71 41 -126 113 -126c44 0 91 19 129 52 c39 35 61 82 73 128c7 29 12 59 12 87c0 25 -4 48 -14 69c-7 16 -17 29 -30 39c-25 -9 -50 -13 -75 -13c-35 0 -76 0 -76 24c0 0 0 5 1 7c7 27 49 27 85 27c24 0 47 -5 67 -13c9 5 18 12 26 19c31 29 49 67 58 105c5 17 7 34 7 50zM395 403c-11 3 -23 5 -36 5 c-24 0 -57 0 -60 -9c-1 -4 30 -4 52 -4c14 0 29 3 44 8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2B" d="M722 250c0 -11 -9 -20 -20 -20h-293v-293c0 -11 -9 -20 -20 -20s-20 9 -20 20v293h-293c-11 0 -20 9 -20 20s9 20 20 20h293v293c0 11 9 20 20 20s20 -9 20 -20v-293h293c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-62" d="M521 216c0 -129 -104 -227 -223 -227c-74 0 -116 50 -131 73l-36 -62h-25v596c0 49 -8 56 -78 56v31l144 11v-317c16 18 59 65 137 65c114 0 212 -99 212 -226zM438 217c0 41 -3 98 -29 139c-24 38 -60 64 -105 64c-24 0 -79 -8 -118 -64c-11 -16 -11 -17 -11 -36v-206 c0 -18 0 -21 14 -42c24 -37 60 -61 105 -61c54 0 92 33 113 64c29 45 31 105 31 142Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
<g transform="translate(167,0)">
<g transform="translate(-11,0)">
<g transform="translate(0,1517)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D443" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="754" y="0"></use>
<g transform="translate(1144,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-AF" x="28" y="-38"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="787" y="-326"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="2044" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2248" x="2712" y="0"></use>
</g>
</g>
<g transform="translate(3752,0)">
<g transform="translate(0,1517)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D464" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6C" x="1013" y="-213"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="1013" y="0"></use>
<g transform="translate(1402,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6C" x="880" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="2322" y="0"></use>
<g transform="translate(2711,0)">
<g transform="translate(120,0)">
<rect stroke="none" width="24058" height="60" x="0" y="220"></rect>
<g transform="translate(60,770)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D43F" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-65" x="963" y="-213"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="1095" y="0"></use>
<g transform="translate(1485,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6C" x="787" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2192" x="2616" y="0"></use>
<g transform="translate(3894,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
<g transform="translate(556,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="278" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1057" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="5652" y="0"></use>
<g transform="translate(6042,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D453" x="0" y="0"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="6799" y="0"></use>
<g transform="translate(7188,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6C" x="787" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2192" x="8319" y="0"></use>
<g transform="translate(9598,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
<g transform="translate(556,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="278" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1057" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2192" x="11633" y="0"></use>
<g transform="translate(12912,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
<g transform="translate(556,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="278" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-32" x="1057" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="14669" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-7C" x="15226" y="0"></use>
<g transform="translate(15504,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-63"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-6F" x="444" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-73" x="945" y="0"></use>
</g>
<g transform="translate(17010,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D703" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6C" x="663" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-7C" x="17777" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D449" x="18222" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="18991" y="0"></use>
<g transform="translate(19381,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6C" x="787" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2194" x="20512" y="0"></use>
<g transform="translate(21790,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
<g transform="translate(556,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="278" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1057" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="23548" y="0"></use>
</g>
<g transform="translate(10779,-769)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6C" x="712" y="-213"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="800" y="0"></use>
<g transform="translate(1189,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6C" x="880" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="2109" y="0"></use>
</g>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D6FD" x="27010" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2B" x="27584" y="0"></use>
</g>
<g transform="translate(0,-1522)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D464" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-62" x="1013" y="-213"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="1210" y="0"></use>
<g transform="translate(1599,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-62" x="880" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="2715" y="0"></use>
<g transform="translate(3105,0)">
<g transform="translate(120,0)">
<rect stroke="none" width="24844" height="60" x="0" y="220"></rect>
<g transform="translate(60,770)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D43F" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-65" x="963" y="-213"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="1095" y="0"></use>
<g transform="translate(1485,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-62" x="787" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2192" x="2813" y="0"></use>
<g transform="translate(4091,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
<g transform="translate(556,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="278" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1057" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="5849" y="0"></use>
<g transform="translate(6238,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D453" x="0" y="0"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="6995" y="0"></use>
<g transform="translate(7385,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-62" x="787" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2192" x="8713" y="0"></use>
<g transform="translate(9991,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
<g transform="translate(556,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="278" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1057" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2192" x="12027" y="0"></use>
<g transform="translate(13305,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
<g transform="translate(556,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="278" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-32" x="1057" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="15063" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-7C" x="15619" y="0"></use>
<g transform="translate(15897,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-63"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-6F" x="444" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-73" x="945" y="0"></use>
</g>
<g transform="translate(17403,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D703" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-62" x="663" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-7C" x="18366" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D449" x="18812" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="19581" y="0"></use>
<g transform="translate(19971,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-62" x="787" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2194" x="21298" y="0"></use>
<g transform="translate(22577,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
<g transform="translate(556,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="278" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="1057" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="24334" y="0"></use>
</g>
<g transform="translate(10976,-769)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-62" x="712" y="-213"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="997" y="0"></use>
<g transform="translate(1386,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-62" x="880" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="2502" y="0"></use>
</g>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D6FD" x="28189" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="28764" y="0"></use>
</g>
</g>
</g>
</g>
</svg>
</div>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">
<div class="eqno">(<a href="#eq:mis-direct-lighting-estimator">13.10</a>)</div>
</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">
<p>

where the surface intersection points corresponding to the two sampled
directions are respectively denoted <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.982ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 853.4 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">normal p Subscript normal l</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6C" d="M255 0l-111 3l-111 -3v31c67 0 78 0 78 45v520c0 49 -8 56 -78 56v31l144 11v-618c0 -45 11 -45 78 -45v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6C" x="787" y="-213"></use>
</g>
</svg> and <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.439ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 1050 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">normal p Subscript normal b</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-62" d="M521 216c0 -129 -104 -227 -223 -227c-74 0 -116 50 -131 73l-36 -62h-25v596c0 49 -8 56 -78 56v31l144 11v-317c16 18 59 65 137 65c114 0 212 -99 212 -226zM438 217c0 41 -3 98 -29 139c-24 38 -60 64 -105 64c-24 0 -79 -8 -118 -64c-11 -16 -11 -17 -11 -36v-206 c0 -18 0 -21 14 -42c24 -37 60 -61 105 -61c54 0 92 33 113 64c29 45 31 105 31 142Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-62" x="787" y="-213"></use>
</g>
</svg> and each term
includes a corresponding multiple importance sampling (MIS)
weight <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.354ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 1013.4 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">w Subscript normal l</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D464" d="M691 372c0 -48 -32 -182 -66 -260c-26 -60 -70 -123 -145 -123c-30 0 -99 6 -125 70c-40 -70 -87 -70 -104 -70c-75 0 -142 35 -142 126c0 38 12 84 56 202c7 17 18 45 18 70c0 32 -16 33 -25 33c-35 0 -74 -31 -101 -124c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10 c0 9 37 154 132 154c49 0 82 -37 82 -82c0 -20 -6 -34 -17 -64c-47 -123 -52 -162 -52 -194c0 -17 0 -91 80 -91c39 0 69 31 92 84c-1 5 -1 7 -1 18c0 18 2 36 9 66c7 26 54 217 57 224c7 20 25 28 37 28c15 0 29 -9 29 -27c0 -6 -10 -43 -15 -65l-42 -168 c-4 -14 -11 -45 -11 -73c0 -57 27 -87 74 -87c49 0 84 35 110 88c26 51 55 149 55 183c0 48 -25 74 -36 85c-9 8 -15 14 -15 27c0 22 25 48 50 48c17 0 44 -15 44 -70Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6C" d="M255 0l-111 3l-111 -3v31c67 0 78 0 78 45v520c0 49 -8 56 -78 56v31l144 11v-618c0 -45 11 -45 78 -45v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D464" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6C" x="1013" y="-213"></use>
</g>
</svg> or <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.81ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 1210 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">w Subscript normal b</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D464" d="M691 372c0 -48 -32 -182 -66 -260c-26 -60 -70 -123 -145 -123c-30 0 -99 6 -125 70c-40 -70 -87 -70 -104 -70c-75 0 -142 35 -142 126c0 38 12 84 56 202c7 17 18 45 18 70c0 32 -16 33 -25 33c-35 0 -74 -31 -101 -124c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10 c0 9 37 154 132 154c49 0 82 -37 82 -82c0 -20 -6 -34 -17 -64c-47 -123 -52 -162 -52 -194c0 -17 0 -91 80 -91c39 0 69 31 92 84c-1 5 -1 7 -1 18c0 18 2 36 9 66c7 26 54 217 57 224c7 20 25 28 37 28c15 0 29 -9 29 -27c0 -6 -10 -43 -15 -65l-42 -168 c-4 -14 -11 -45 -11 -73c0 -57 27 -87 74 -87c49 0 84 35 110 88c26 51 55 149 55 183c0 48 -25 74 -36 85c-9 8 -15 14 -15 27c0 22 25 48 50 48c17 0 44 -15 44 -70Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-62" d="M521 216c0 -129 -104 -227 -223 -227c-74 0 -116 50 -131 73l-36 -62h-25v596c0 49 -8 56 -78 56v31l144 11v-317c16 18 59 65 137 65c114 0 212 -99 212 -226zM438 217c0 41 -3 98 -29 139c-24 38 -60 64 -105 64c-24 0 -79 -8 -118 -64c-11 -16 -11 -17 -11 -36v-206 c0 -18 0 -21 14 -42c24 -37 60 -61 105 -61c54 0 92 33 113 64c29 45 31 105 31 142Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D464" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-62" x="1013" y="-213"></use>
</g>
</svg> that can be computed,
for example, using the balance heuristic from
Equation&nbsp;(<a href="../Monte_Carlo_Integration/Improving_Efficiency.html#eq:balance-heuristic">2.14</a>) or the power heuristic from
Equation&nbsp;(<a href="../Monte_Carlo_Integration/Improving_Efficiency.html#eq:mis-power-heuristic">2.15</a>).
Figure&nbsp;<a href="#fig:sample-bsdf-light">13.8</a>(c) shows the effectiveness of combining
these two sampling techniques with multiple importance sampling.

</p>
<p>With that context established, we can start the implementation of the
<tt>PathIntegrator</tt>.  It is another <a href="../Introduction/pbrt_System_Overview.html#RayIntegrator"><tt>RayIntegrator</tt></a>.

</p>
<p></p>
<span class="anchor" id="fragment-PathIntegratorDefinition-0"></span><div class="fragmentname">&lt;&lt;PathIntegrator Definition&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">class <span class="anchor" id="PathIntegrator"></span>PathIntegrator : public <a href="../Introduction/pbrt_System_Overview.html#RayIntegrator" class="code">RayIntegrator</a> {
  public:
    &lt;&lt;<span class="fragmentname">PathIntegrator Public Methods</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1855" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1855"><i></i></a><div id="fragbit-1855" class="collapse show"><div class="fragmentcode">       PathIntegrator(int maxDepth, <a href="../Cameras_and_Film/Camera_Interface.html#Camera" class="code">Camera</a> camera, <a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler" class="code">Sampler</a> sampler,
                      <a href="../Primitives_and_Intersection_Acceleration/Primitive_Interface_and_Geometric_Primitives.html#Primitive" class="code">Primitive</a> aggregate, std::vector&lt;<a href="../Light_Sources/Light_Interface.html#Light" class="code">Light</a>&gt; lights,
                      const std::string &amp;lightSampleStrategy = "bvh",
                      bool regularize = false);
       
       <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> Li(<a href="../Geometry_and_Transformations/Rays.html#RayDifferential" class="code">RayDifferential</a> ray, <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledWavelengths" class="code">SampledWavelengths</a> &amp;lambda,
                          <a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler" class="code">Sampler</a> sampler, <a href="../Utilities/Containers_and_Memory_Management.html#ScratchBuffer" class="code">ScratchBuffer</a> &amp;scratchBuffer,
                          <a href="../Cameras_and_Film/Film_and_Imaging.html#VisibleSurface" class="code">VisibleSurface</a> *visibleSurface) const;
       
       static std::unique_ptr&lt;PathIntegrator&gt; Create(
           const ParameterDictionary &amp;parameters, <a href="../Cameras_and_Film/Camera_Interface.html#Camera" class="code">Camera</a> camera, <a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler" class="code">Sampler</a> sampler,
           <a href="../Primitives_and_Intersection_Acceleration/Primitive_Interface_and_Geometric_Primitives.html#Primitive" class="code">Primitive</a> aggregate, std::vector&lt;<a href="../Light_Sources/Light_Interface.html#Light" class="code">Light</a>&gt; lights, const FileLoc *loc);
       
       std::string ToString() const;</div></div>
  private:
    &lt;&lt;<span class="fragmentname">PathIntegrator Private Methods</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1856" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1856"><i></i></a><div id="fragbit-1856" class="collapse show"><div class="fragmentcode">       <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> SampleLd(const <a href="../Geometry_and_Transformations/Interactions.html#SurfaceInteraction" class="code">SurfaceInteraction</a> &amp;intr, const <a href="../Reflection_Models/BSDF_Representation.html#BSDF" class="code">BSDF</a> *bsdf,
                                <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledWavelengths" class="code">SampledWavelengths</a> &amp;lambda,
                                <a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler" class="code">Sampler</a> sampler) const;</div></div>
    &lt;&lt;<span class="fragmentname"><a href="#fragment-PathIntegratorPrivateMembers-0">PathIntegrator Private Members</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1857" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1857"><i></i></a><div id="fragbit-1857" class="collapse show"><div class="fragmentcode">       int maxDepth;
       <a href="../Light_Sources/Light_Sampling.html#LightSampler" class="code">LightSampler</a> lightSampler;
       bool regularize;</div></div>
};</div><p>


</p>
<p>Three member variables affect the <a href="#PathIntegrator"><tt>PathIntegrator</tt></a>&rsquo;s operation: a
maximum path depth; the <tt>lightSampler</tt> used to sample a light source;
and <tt>regularize</tt>, which controls whether path regularization is used.

</p>
<p></p>
<span class="anchor" id="fragment-PathIntegratorPrivateMembers-0"></span><div class="fragmentname">&lt;&lt;PathIntegrator Private Members&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">int <span class="anchor" id="PathIntegrator::maxDepth"></span>maxDepth;
<a href="../Light_Sources/Light_Sampling.html#LightSampler" class="code">LightSampler</a> <span class="anchor" id="PathIntegrator::lightSampler"></span>lightSampler;
bool <span class="anchor" id="PathIntegrator::regularize"></span>regularize;</div><p>


</p>
<p>

</p>
<p>

</p>
<p>The form of the <tt>Li()</tt> method is similar to
<a href="../Light_Transport_I_Surface_Reflection/A_Simple_Path_Tracer.html#SimplePathIntegrator::Li"><tt>SimplePathIntegrator::Li()</tt></a>.

</p>
<p></p>
<span class="anchor" id="fragment-PathIntegratorMethodDefinitions-0"></span><div class="fragmentname">&lt;&lt;PathIntegrator Method Definitions&gt;&gt;=&nbsp;<a href="#fragment-PathIntegratorMethodDefinitions-1"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode"><a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> <span class="anchor" id="PathIntegrator::Li"></span>PathIntegrator::Li(<a href="../Geometry_and_Transformations/Rays.html#RayDifferential" class="code">RayDifferential</a> ray,
        <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledWavelengths" class="code">SampledWavelengths</a> &amp;lambda, <a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler" class="code">Sampler</a> sampler,
        <a href="../Utilities/Containers_and_Memory_Management.html#ScratchBuffer" class="code">ScratchBuffer</a> &amp;scratchBuffer, <a href="../Cameras_and_Film/Film_and_Imaging.html#VisibleSurface" class="code">VisibleSurface</a> *visibleSurf) const {
    &lt;&lt;<span class="fragmentname"><a href="#fragment-DeclarelocalvariablesformonoPathIntegrator::Li-0">Declare local variables for <tt>PathIntegrator::Li()</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1858" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1858"><i></i></a><div id="fragbit-1858" class="collapse show"><div class="fragmentcode">       <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> L(0.f), beta(1.f);
       int depth = 0;
       Float p_b, etaScale = 1;
       bool specularBounce = false, anyNonSpecularBounces = false;
       <a href="../Light_Sources/Light_Interface.html#LightSampleContext" class="code">LightSampleContext</a> prevIntrCtx;</div></div>
    &lt;&lt;<span class="fragmentname"><a href="#fragment-Samplepathfromcameraandaccumulateradianceestimate-0">Sample path from camera and accumulate radiance estimate</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1859" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1859"><i></i></a><div id="fragbit-1859" class="collapse show"><div class="fragmentcode">       while (true) {
           &lt;&lt;<span class="fragmentname"><a href="#fragment-TracerayandfindclosestpathvertexanditsBSDF-0">Trace ray and find closest path vertex and its BSDF</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1860" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1860"><i></i></a><div id="fragbit-1860" class="collapse show"><div class="fragmentcode">              pstd::optional&lt;<a href="../Shapes/Basic_Shape_Interface.html#ShapeIntersection" class="code">ShapeIntersection</a>&gt; si = <a href="../Introduction/pbrt_System_Overview.html#Integrator::Intersect" class="code">Intersect</a>(ray);
              &lt;&lt;<span class="fragmentname"><a href="#fragment-Addemittedlightatintersectionpointorfromtheenvironment-0">Add emitted light at intersection point or from the environment</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1861" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1861"><i></i></a><div id="fragbit-1861" class="collapse show"><div class="fragmentcode">                 if (!si) {
                     &lt;&lt;<span class="fragmentname"><a href="#fragment-Incorporateemissionfrominfinitelightsforescapedray-0">Incorporate emission from infinite lights for escaped ray</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1862" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1862"><i></i></a><div id="fragbit-1862" class="collapse show"><div class="fragmentcode">                        for (const auto &amp;light : <a href="../Introduction/pbrt_System_Overview.html#Integrator::infiniteLights" class="code">infiniteLights</a>) {
                            <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> <a href="../Light_Sources/Light_Interface.html#Light::Le" class="code">Le</a> = light.<a href="../Light_Sources/Light_Interface.html#Light::Le" class="code">Le</a>(ray, lambda);
                            if (depth == 0 || specularBounce)
                                L += beta * <a href="../Light_Sources/Light_Interface.html#Light::Le" class="code">Le</a>;
                            else {
                                &lt;&lt;<span class="fragmentname"><a href="#fragment-ComputeMISweightforinfinitelight-0">Compute MIS weight for infinite light</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1863" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1863"><i></i></a><div id="fragbit-1863" class="collapse show"><div class="fragmentcode">                                   Float p_l = <a href="#PathIntegrator::lightSampler" class="code">lightSampler</a>.<a href="../Light_Sources/Light_Sampling.html#LightSampler::PMF" class="code">PMF</a>(prevIntrCtx, light) *
                                       light.<a href="../Light_Sources/Light_Interface.html#Light::PDF_Li" class="code">PDF_Li</a>(prevIntrCtx, ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a>, true);
                                   Float w_b = <a href="../Monte_Carlo_Integration/Improving_Efficiency.html#PowerHeuristic" class="code">PowerHeuristic</a>(1, p_b, 1, p_l);</div></div>
                                L += beta * w_b * <a href="../Light_Sources/Light_Interface.html#Light::Le" class="code">Le</a>;
                            }
                        }</div></div>
                     break;
                 }
                 &lt;&lt;<span class="fragmentname">Incorporate emission from surface hit by ray</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1864" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1864"><i></i></a><div id="fragbit-1864" class="collapse show"><div class="fragmentcode">                    <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> Le = si-&gt;intr.Le(-ray.d, lambda);
                    if (Le) {
                        if (depth == 0 || specularBounce)
                            L += beta * Le;
                        else {
                            &lt;&lt;<span class="fragmentname">Compute MIS weight for area light</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1865" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1865"><i></i></a><div id="fragbit-1865" class="collapse show"><div class="fragmentcode">                               <a href="../Light_Sources/Light_Interface.html#Light" class="code">Light</a> areaLight(si-&gt;intr.areaLight);
                               Float lightPDF = lightSampler.PMF(prevIntrCtx, areaLight) *
                                   areaLight.PDF_Li(prevIntrCtx, ray.d, true);
                               Float w_l = PowerHeuristic(1, bsdfPDF, 1, lightPDF);</div></div>
                            L += beta * w_l * Le;
                        }
                    }</div></div></div></div>
              <a href="../Geometry_and_Transformations/Interactions.html#SurfaceInteraction" class="code">SurfaceInteraction</a> &amp;isect = si-&gt;<a href="../Shapes/Basic_Shape_Interface.html#ShapeIntersection::intr" class="code">intr</a>;
              &lt;&lt;<span class="fragmentname"><a href="A_Simple_Path_Tracer.html#fragment-GetBSDFandskipovermediumboundaries-0">Get BSDF and skip over medium boundaries</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1866" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1866"><i></i></a><div id="fragbit-1866" class="collapse show"><div class="fragmentcode">                 <a href="../Reflection_Models/BSDF_Representation.html#BSDF" class="code">BSDF</a> bsdf = isect.<a href="../Textures_and_Materials/Material_Interface_and_Implementations.html#SurfaceInteraction::GetBSDF" class="code">GetBSDF</a>(ray, lambda, camera, scratchBuffer, sampler);
                 if (!bsdf) {
                     isect.<a href="../Textures_and_Materials/Texture_Sampling_and_Antialiasing.html#SurfaceInteraction::SkipIntersection" class="code">SkipIntersection</a>(&amp;ray, si-&gt;<a href="../Shapes/Basic_Shape_Interface.html#ShapeIntersection::tHit" class="code">tHit</a>);
                     continue;
                 }</div></div>
              &lt;&lt;<span class="fragmentname"><a href="#fragment-InitializemonovisibleSurfatfirstintersection-0">Initialize <tt>visibleSurf</tt> at first intersection</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1867" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1867"><i></i></a><div id="fragbit-1867" class="collapse show"><div class="fragmentcode">                 if (depth == 0 &amp;&amp; visibleSurf) {
                     &lt;&lt;<span class="fragmentname"><a href="#fragment-EstimateBSDFsalbedo-0">Estimate BSDF&rsquo;s albedo</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1868" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1868"><i></i></a><div id="fragbit-1868" class="collapse show"><div class="fragmentcode">                        &lt;&lt;<span class="fragmentname">Define sample arrays <tt>ucRho</tt> and <tt>uRho</tt> for reflectance estimate</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1869" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1869"><i></i></a><div id="fragbit-1869" class="collapse show"><div class="fragmentcode">                           constexpr int nRhoSamples = 16;
                           const Float ucRho[nRhoSamples] = { 0.75741637, 0.37870818, 0.7083487, 0.18935409, 0.9149363, 0.35417435, 0.5990858, 0.09467703, 0.8578725, 0.45746812, 0.686759, 0.17708716, 0.9674518, 0.2995429, 0.5083201, 0.047338516 };
                           const <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a> uRho[nRhoSamples] = { <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.855985, 0.570367), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.381823, 0.851844), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.285328, 0.764262), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.733380, 0.114073), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.542663, 0.344465), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.127274, 0.414848), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.964700, 0.947162), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.594089, 0.643463), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.095109, 0.170369), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.825444, 0.263359), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.429467, 0.454469), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.244460, 0.816459), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.756135, 0.731258), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.516165, 0.152852), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.180888, 0.214174), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.898579, 0.503897) };</div></div>
                        <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> albedo = bsdf.<a href="../Reflection_Models/BSDF_Representation.html#BSDF::rho" class="code">rho</a>(isect.<a href="../Geometry_and_Transformations/Interactions.html#Interaction::wo" class="code">wo</a>, ucRho, uRho);</div></div>
                     *visibleSurf = <a href="../Cameras_and_Film/Film_and_Imaging.html#VisibleSurface" class="code">VisibleSurface</a>(isect, albedo, lambda);
                 }</div></div>
              &lt;&lt;<span class="fragmentname"><a href="#fragment-PossiblyregularizetheBSDF-0">Possibly regularize the BSDF</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1870" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1870"><i></i></a><div id="fragbit-1870" class="collapse show"><div class="fragmentcode">                 if (<a href="#PathIntegrator::regularize" class="code">regularize</a> &amp;&amp; anyNonSpecularBounces)
                     bsdf.<a href="#BSDF::Regularize" class="code">Regularize</a>();
                 </div></div>
              </div></div>
           &lt;&lt;<span class="fragmentname"><a href="A_Simple_Path_Tracer.html#fragment-Endpathifmaximumdepthreached-0">End path if maximum depth reached</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1871" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1871"><i></i></a><div id="fragbit-1871" class="collapse show"><div class="fragmentcode">              if (depth++ == <a href="../Light_Transport_I_Surface_Reflection/A_Simple_Path_Tracer.html#SimplePathIntegrator::maxDepth" class="code">maxDepth</a>)
                  break;</div></div>
           &lt;&lt;<span class="fragmentname"><a href="#fragment-Sampledirectilluminationfromthelightsources-0">Sample direct illumination from the light sources</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1872" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1872"><i></i></a><div id="fragbit-1872" class="collapse show"><div class="fragmentcode">              if (<a href="../Reflection_Models/BSDF_Representation.html#BxDFFlags::IsNonSpecular" class="code">IsNonSpecular</a>(bsdf.<a href="../Reflection_Models/BSDF_Representation.html#BSDF::Flags" class="code">Flags</a>())) {
                  <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> Ld = <a href="#PathIntegrator::SampleLd" class="code">SampleLd</a>(isect, &amp;bsdf, lambda, sampler);
                  L += beta * Ld;
              }</div></div>
           &lt;&lt;<span class="fragmentname"><a href="#fragment-SampleBSDFtogetnewpathdirection-0">Sample BSDF to get new path direction</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1873" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1873"><i></i></a><div id="fragbit-1873" class="collapse show"><div class="fragmentcode">              <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> wo = -ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a>;
              Float u = sampler.<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::Get1D" class="code">Get1D</a>();
              pstd::optional&lt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample" class="code">BSDFSample</a>&gt; bs = bsdf.<a href="../Reflection_Models/BSDF_Representation.html#BSDF::Sample_f" class="code">Sample_f</a>(wo, u, sampler.<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::Get2D" class="code">Get2D</a>());
              if (!bs)
                  break;
              &lt;&lt;<span class="fragmentname"><a href="#fragment-Updatepathstatevariablesaftersurfacescattering-0">Update path state variables after surface scattering</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1874" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1874"><i></i></a><div id="fragbit-1874" class="collapse show"><div class="fragmentcode">                 beta *= bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::f" class="code">f</a> * <a href="../Geometry_and_Transformations/Vectors.html#AbsDot" class="code">AbsDot</a>(bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>, isect.shading.<a href="../Geometry_and_Transformations/Interactions.html#SurfaceInteraction::shading::n" class="code">n</a>) / bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::pdf" class="code">pdf</a>;
                 p_b = bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::pdfIsProportional" class="code">pdfIsProportional</a> ? bsdf.<a href="../Reflection_Models/BSDF_Representation.html#BSDF::PDF" class="code">PDF</a>(wo, bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>) : bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::pdf" class="code">pdf</a>;
                 specularBounce = bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::IsSpecular" class="code">IsSpecular</a>();
                 anyNonSpecularBounces |= !bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::IsSpecular" class="code">IsSpecular</a>();
                 if (bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::IsTransmission" class="code">IsTransmission</a>())
                     etaScale *= <a href="../Utilities/Mathematical_Infrastructure.html#Sqr" class="code">Sqr</a>(bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::eta" class="code">eta</a>);
                 prevIntrCtx = si-&gt;<a href="../Shapes/Basic_Shape_Interface.html#ShapeIntersection::intr" class="code">intr</a>;</div></div> 
              ray = isect.<a href="../Textures_and_Materials/Texture_Sampling_and_Antialiasing.html#SurfaceInteraction::SpawnRay" class="code">SpawnRay</a>(ray, bsdf, bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>, bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::flags" class="code">flags</a>, bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::eta" class="code">eta</a>);</div></div>
           &lt;&lt;<span class="fragmentname"><a href="#fragment-PossiblyterminatethepathwithRussianroulette-0">Possibly terminate the path with Russian roulette</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1875" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1875"><i></i></a><div id="fragbit-1875" class="collapse show"><div class="fragmentcode">              <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> rrBeta = beta * etaScale;
              if (rrBeta.<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum::MaxComponentValue" class="code">MaxComponentValue</a>() &lt; 1 &amp;&amp; depth &gt; 1) {
                  Float q = std::max&lt;Float&gt;(0, 1 - rrBeta.<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum::MaxComponentValue" class="code">MaxComponentValue</a>());
                  if (sampler.<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::Get1D" class="code">Get1D</a>() &lt; q)
                      break;
                  beta /= 1 - q;
              }</div></div>
       }
       return L;</div></div>
}</div><p>


</p>
<p>The <tt>L</tt>, <tt>beta</tt>, and <tt>depth</tt> variables play the same role as the
corresponding variables did in the <a href="../Light_Transport_I_Surface_Reflection/A_Simple_Path_Tracer.html#SimplePathIntegrator"><tt>SimplePathIntegrator</tt></a>.

</p>
<p></p>
<span class="anchor" id="fragment-DeclarelocalvariablesformonoPathIntegrator::Li-0"></span><div class="fragmentname">&lt;&lt;Declare local variables for <tt>PathIntegrator::Li()</tt>&gt;&gt;=&nbsp;<a href="#fragment-DeclarelocalvariablesformonoPathIntegrator::Li-1"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode"><a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> L(0.f), beta(1.f);
int depth = 0;</div><p>


</p>
<p>
Also similarly, each iteration of the <tt>while</tt> loop traces a ray to
find its closest intersection and its BSDF.  Note that a number of code fragments from the
<a href="../Light_Transport_I_Surface_Reflection/A_Simple_Path_Tracer.html#SimplePathIntegrator"><tt>SimplePathIntegrator</tt></a> are reused here and in what follows to define
the body of the <tt>while</tt> loop.  The loop continues until either the
maximum path length is reached or the path is terminated via Russian
roulette.

</p>
<p></p>
<span class="anchor" id="fragment-Samplepathfromcameraandaccumulateradianceestimate-0"></span><div class="fragmentname">&lt;&lt;Sample path from camera and accumulate radiance estimate&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">while (true) {
    &lt;&lt;<span class="fragmentname"><a href="#fragment-TracerayandfindclosestpathvertexanditsBSDF-0">Trace ray and find closest path vertex and its BSDF</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1876" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1876"><i></i></a><div id="fragbit-1876" class="collapse show"><div class="fragmentcode">       pstd::optional&lt;<a href="../Shapes/Basic_Shape_Interface.html#ShapeIntersection" class="code">ShapeIntersection</a>&gt; si = <a href="../Introduction/pbrt_System_Overview.html#Integrator::Intersect" class="code">Intersect</a>(ray);
       &lt;&lt;<span class="fragmentname"><a href="#fragment-Addemittedlightatintersectionpointorfromtheenvironment-0">Add emitted light at intersection point or from the environment</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1877" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1877"><i></i></a><div id="fragbit-1877" class="collapse show"><div class="fragmentcode">          if (!si) {
              &lt;&lt;<span class="fragmentname"><a href="#fragment-Incorporateemissionfrominfinitelightsforescapedray-0">Incorporate emission from infinite lights for escaped ray</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1878" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1878"><i></i></a><div id="fragbit-1878" class="collapse show"><div class="fragmentcode">                 for (const auto &amp;light : <a href="../Introduction/pbrt_System_Overview.html#Integrator::infiniteLights" class="code">infiniteLights</a>) {
                     <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> <a href="../Light_Sources/Light_Interface.html#Light::Le" class="code">Le</a> = light.<a href="../Light_Sources/Light_Interface.html#Light::Le" class="code">Le</a>(ray, lambda);
                     if (depth == 0 || specularBounce)
                         L += beta * <a href="../Light_Sources/Light_Interface.html#Light::Le" class="code">Le</a>;
                     else {
                         &lt;&lt;<span class="fragmentname"><a href="#fragment-ComputeMISweightforinfinitelight-0">Compute MIS weight for infinite light</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1879" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1879"><i></i></a><div id="fragbit-1879" class="collapse show"><div class="fragmentcode">                            Float p_l = <a href="#PathIntegrator::lightSampler" class="code">lightSampler</a>.<a href="../Light_Sources/Light_Sampling.html#LightSampler::PMF" class="code">PMF</a>(prevIntrCtx, light) *
                                light.<a href="../Light_Sources/Light_Interface.html#Light::PDF_Li" class="code">PDF_Li</a>(prevIntrCtx, ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a>, true);
                            Float w_b = <a href="../Monte_Carlo_Integration/Improving_Efficiency.html#PowerHeuristic" class="code">PowerHeuristic</a>(1, p_b, 1, p_l);</div></div>
                         L += beta * w_b * <a href="../Light_Sources/Light_Interface.html#Light::Le" class="code">Le</a>;
                     }
                 }</div></div>
              break;
          }
          &lt;&lt;<span class="fragmentname">Incorporate emission from surface hit by ray</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1880" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1880"><i></i></a><div id="fragbit-1880" class="collapse show"><div class="fragmentcode">             <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> Le = si-&gt;intr.Le(-ray.d, lambda);
             if (Le) {
                 if (depth == 0 || specularBounce)
                     L += beta * Le;
                 else {
                     &lt;&lt;<span class="fragmentname">Compute MIS weight for area light</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1881" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1881"><i></i></a><div id="fragbit-1881" class="collapse show"><div class="fragmentcode">                        <a href="../Light_Sources/Light_Interface.html#Light" class="code">Light</a> areaLight(si-&gt;intr.areaLight);
                        Float lightPDF = lightSampler.PMF(prevIntrCtx, areaLight) *
                            areaLight.PDF_Li(prevIntrCtx, ray.d, true);
                        Float w_l = PowerHeuristic(1, bsdfPDF, 1, lightPDF);</div></div>
                     L += beta * w_l * Le;
                 }
             }</div></div></div></div>
       <a href="../Geometry_and_Transformations/Interactions.html#SurfaceInteraction" class="code">SurfaceInteraction</a> &amp;isect = si-&gt;<a href="../Shapes/Basic_Shape_Interface.html#ShapeIntersection::intr" class="code">intr</a>;
       &lt;&lt;<span class="fragmentname"><a href="A_Simple_Path_Tracer.html#fragment-GetBSDFandskipovermediumboundaries-0">Get BSDF and skip over medium boundaries</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1882" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1882"><i></i></a><div id="fragbit-1882" class="collapse show"><div class="fragmentcode">          <a href="../Reflection_Models/BSDF_Representation.html#BSDF" class="code">BSDF</a> bsdf = isect.<a href="../Textures_and_Materials/Material_Interface_and_Implementations.html#SurfaceInteraction::GetBSDF" class="code">GetBSDF</a>(ray, lambda, camera, scratchBuffer, sampler);
          if (!bsdf) {
              isect.<a href="../Textures_and_Materials/Texture_Sampling_and_Antialiasing.html#SurfaceInteraction::SkipIntersection" class="code">SkipIntersection</a>(&amp;ray, si-&gt;<a href="../Shapes/Basic_Shape_Interface.html#ShapeIntersection::tHit" class="code">tHit</a>);
              continue;
          }</div></div>
       &lt;&lt;<span class="fragmentname"><a href="#fragment-InitializemonovisibleSurfatfirstintersection-0">Initialize <tt>visibleSurf</tt> at first intersection</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1883" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1883"><i></i></a><div id="fragbit-1883" class="collapse show"><div class="fragmentcode">          if (depth == 0 &amp;&amp; visibleSurf) {
              &lt;&lt;<span class="fragmentname"><a href="#fragment-EstimateBSDFsalbedo-0">Estimate BSDF&rsquo;s albedo</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1884" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1884"><i></i></a><div id="fragbit-1884" class="collapse show"><div class="fragmentcode">                 &lt;&lt;<span class="fragmentname">Define sample arrays <tt>ucRho</tt> and <tt>uRho</tt> for reflectance estimate</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1885" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1885"><i></i></a><div id="fragbit-1885" class="collapse show"><div class="fragmentcode">                    constexpr int nRhoSamples = 16;
                    const Float ucRho[nRhoSamples] = { 0.75741637, 0.37870818, 0.7083487, 0.18935409, 0.9149363, 0.35417435, 0.5990858, 0.09467703, 0.8578725, 0.45746812, 0.686759, 0.17708716, 0.9674518, 0.2995429, 0.5083201, 0.047338516 };
                    const <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a> uRho[nRhoSamples] = { <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.855985, 0.570367), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.381823, 0.851844), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.285328, 0.764262), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.733380, 0.114073), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.542663, 0.344465), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.127274, 0.414848), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.964700, 0.947162), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.594089, 0.643463), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.095109, 0.170369), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.825444, 0.263359), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.429467, 0.454469), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.244460, 0.816459), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.756135, 0.731258), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.516165, 0.152852), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.180888, 0.214174), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.898579, 0.503897) };</div></div>
                 <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> albedo = bsdf.<a href="../Reflection_Models/BSDF_Representation.html#BSDF::rho" class="code">rho</a>(isect.<a href="../Geometry_and_Transformations/Interactions.html#Interaction::wo" class="code">wo</a>, ucRho, uRho);</div></div>
              *visibleSurf = <a href="../Cameras_and_Film/Film_and_Imaging.html#VisibleSurface" class="code">VisibleSurface</a>(isect, albedo, lambda);
          }</div></div>
       &lt;&lt;<span class="fragmentname"><a href="#fragment-PossiblyregularizetheBSDF-0">Possibly regularize the BSDF</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1886" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1886"><i></i></a><div id="fragbit-1886" class="collapse show"><div class="fragmentcode">          if (<a href="#PathIntegrator::regularize" class="code">regularize</a> &amp;&amp; anyNonSpecularBounces)
              bsdf.<a href="#BSDF::Regularize" class="code">Regularize</a>();
          </div></div>
       </div></div>
    &lt;&lt;<span class="fragmentname"><a href="A_Simple_Path_Tracer.html#fragment-Endpathifmaximumdepthreached-0">End path if maximum depth reached</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1887" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1887"><i></i></a><div id="fragbit-1887" class="collapse show"><div class="fragmentcode">       if (depth++ == <a href="../Light_Transport_I_Surface_Reflection/A_Simple_Path_Tracer.html#SimplePathIntegrator::maxDepth" class="code">maxDepth</a>)
           break;</div></div>
    &lt;&lt;<span class="fragmentname"><a href="#fragment-Sampledirectilluminationfromthelightsources-0">Sample direct illumination from the light sources</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1888" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1888"><i></i></a><div id="fragbit-1888" class="collapse show"><div class="fragmentcode">       if (<a href="../Reflection_Models/BSDF_Representation.html#BxDFFlags::IsNonSpecular" class="code">IsNonSpecular</a>(bsdf.<a href="../Reflection_Models/BSDF_Representation.html#BSDF::Flags" class="code">Flags</a>())) {
           <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> Ld = <a href="#PathIntegrator::SampleLd" class="code">SampleLd</a>(isect, &amp;bsdf, lambda, sampler);
           L += beta * Ld;
       }</div></div>
    &lt;&lt;<span class="fragmentname"><a href="#fragment-SampleBSDFtogetnewpathdirection-0">Sample BSDF to get new path direction</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1889" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1889"><i></i></a><div id="fragbit-1889" class="collapse show"><div class="fragmentcode">       <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> wo = -ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a>;
       Float u = sampler.<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::Get1D" class="code">Get1D</a>();
       pstd::optional&lt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample" class="code">BSDFSample</a>&gt; bs = bsdf.<a href="../Reflection_Models/BSDF_Representation.html#BSDF::Sample_f" class="code">Sample_f</a>(wo, u, sampler.<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::Get2D" class="code">Get2D</a>());
       if (!bs)
           break;
       &lt;&lt;<span class="fragmentname"><a href="#fragment-Updatepathstatevariablesaftersurfacescattering-0">Update path state variables after surface scattering</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1890" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1890"><i></i></a><div id="fragbit-1890" class="collapse show"><div class="fragmentcode">          beta *= bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::f" class="code">f</a> * <a href="../Geometry_and_Transformations/Vectors.html#AbsDot" class="code">AbsDot</a>(bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>, isect.shading.<a href="../Geometry_and_Transformations/Interactions.html#SurfaceInteraction::shading::n" class="code">n</a>) / bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::pdf" class="code">pdf</a>;
          p_b = bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::pdfIsProportional" class="code">pdfIsProportional</a> ? bsdf.<a href="../Reflection_Models/BSDF_Representation.html#BSDF::PDF" class="code">PDF</a>(wo, bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>) : bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::pdf" class="code">pdf</a>;
          specularBounce = bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::IsSpecular" class="code">IsSpecular</a>();
          anyNonSpecularBounces |= !bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::IsSpecular" class="code">IsSpecular</a>();
          if (bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::IsTransmission" class="code">IsTransmission</a>())
              etaScale *= <a href="../Utilities/Mathematical_Infrastructure.html#Sqr" class="code">Sqr</a>(bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::eta" class="code">eta</a>);
          prevIntrCtx = si-&gt;<a href="../Shapes/Basic_Shape_Interface.html#ShapeIntersection::intr" class="code">intr</a>;</div></div> 
       ray = isect.<a href="../Textures_and_Materials/Texture_Sampling_and_Antialiasing.html#SurfaceInteraction::SpawnRay" class="code">SpawnRay</a>(ray, bsdf, bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>, bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::flags" class="code">flags</a>, bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::eta" class="code">eta</a>);</div></div>
    &lt;&lt;<span class="fragmentname"><a href="#fragment-PossiblyterminatethepathwithRussianroulette-0">Possibly terminate the path with Russian roulette</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1891" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1891"><i></i></a><div id="fragbit-1891" class="collapse show"><div class="fragmentcode">       <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> rrBeta = beta * etaScale;
       if (rrBeta.<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum::MaxComponentValue" class="code">MaxComponentValue</a>() &lt; 1 &amp;&amp; depth &gt; 1) {
           Float q = std::max&lt;Float&gt;(0, 1 - rrBeta.<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum::MaxComponentValue" class="code">MaxComponentValue</a>());
           if (sampler.<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::Get1D" class="code">Get1D</a>() &lt; q)
               break;
           beta /= 1 - q;
       }</div></div>
}
return L;</div><p>


</p>
<p>We will defer discussing the implementation of the first fragment used
below, &lt;&lt;<span class="fragmentname"><a href="#fragment-Addemittedlightatintersectionpointorfromtheenvironment-0">Add emitted light at intersection point or from the environment</a></span>&gt;&gt;,
until later in this section after more details of the implementation of the
MIS direct lighting calculation have been introduced.

</p>
<p></p>
<span class="anchor" id="fragment-TracerayandfindclosestpathvertexanditsBSDF-0"></span><div class="fragmentname">&lt;&lt;Trace ray and find closest path vertex and its BSDF&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">pstd::optional&lt;<a href="../Shapes/Basic_Shape_Interface.html#ShapeIntersection" class="code">ShapeIntersection</a>&gt; si = <a href="../Introduction/pbrt_System_Overview.html#Integrator::Intersect" class="code">Intersect</a>(ray);
&lt;&lt;<span class="fragmentname"><a href="#fragment-Addemittedlightatintersectionpointorfromtheenvironment-0">Add emitted light at intersection point or from the environment</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1892" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1892"><i></i></a><div id="fragbit-1892" class="collapse show"><div class="fragmentcode">   if (!si) {
       &lt;&lt;<span class="fragmentname"><a href="#fragment-Incorporateemissionfrominfinitelightsforescapedray-0">Incorporate emission from infinite lights for escaped ray</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1893" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1893"><i></i></a><div id="fragbit-1893" class="collapse show"><div class="fragmentcode">          for (const auto &amp;light : <a href="../Introduction/pbrt_System_Overview.html#Integrator::infiniteLights" class="code">infiniteLights</a>) {
              <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> <a href="../Light_Sources/Light_Interface.html#Light::Le" class="code">Le</a> = light.<a href="../Light_Sources/Light_Interface.html#Light::Le" class="code">Le</a>(ray, lambda);
              if (depth == 0 || specularBounce)
                  L += beta * <a href="../Light_Sources/Light_Interface.html#Light::Le" class="code">Le</a>;
              else {
                  &lt;&lt;<span class="fragmentname"><a href="#fragment-ComputeMISweightforinfinitelight-0">Compute MIS weight for infinite light</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1894" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1894"><i></i></a><div id="fragbit-1894" class="collapse show"><div class="fragmentcode">                     Float p_l = <a href="#PathIntegrator::lightSampler" class="code">lightSampler</a>.<a href="../Light_Sources/Light_Sampling.html#LightSampler::PMF" class="code">PMF</a>(prevIntrCtx, light) *
                         light.<a href="../Light_Sources/Light_Interface.html#Light::PDF_Li" class="code">PDF_Li</a>(prevIntrCtx, ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a>, true);
                     Float w_b = <a href="../Monte_Carlo_Integration/Improving_Efficiency.html#PowerHeuristic" class="code">PowerHeuristic</a>(1, p_b, 1, p_l);</div></div>
                  L += beta * w_b * <a href="../Light_Sources/Light_Interface.html#Light::Le" class="code">Le</a>;
              }
          }</div></div>
       break;
   }
   &lt;&lt;<span class="fragmentname">Incorporate emission from surface hit by ray</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1895" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1895"><i></i></a><div id="fragbit-1895" class="collapse show"><div class="fragmentcode">      <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> Le = si-&gt;intr.Le(-ray.d, lambda);
      if (Le) {
          if (depth == 0 || specularBounce)
              L += beta * Le;
          else {
              &lt;&lt;<span class="fragmentname">Compute MIS weight for area light</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1896" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1896"><i></i></a><div id="fragbit-1896" class="collapse show"><div class="fragmentcode">                 <a href="../Light_Sources/Light_Interface.html#Light" class="code">Light</a> areaLight(si-&gt;intr.areaLight);
                 Float lightPDF = lightSampler.PMF(prevIntrCtx, areaLight) *
                     areaLight.PDF_Li(prevIntrCtx, ray.d, true);
                 Float w_l = PowerHeuristic(1, bsdfPDF, 1, lightPDF);</div></div>
              L += beta * w_l * Le;
          }
      }</div></div></div></div>
<a href="../Geometry_and_Transformations/Interactions.html#SurfaceInteraction" class="code">SurfaceInteraction</a> &amp;isect = si-&gt;<a href="../Shapes/Basic_Shape_Interface.html#ShapeIntersection::intr" class="code">intr</a>;
&lt;&lt;<span class="fragmentname"><a href="A_Simple_Path_Tracer.html#fragment-GetBSDFandskipovermediumboundaries-0">Get BSDF and skip over medium boundaries</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1897" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1897"><i></i></a><div id="fragbit-1897" class="collapse show"><div class="fragmentcode">   <a href="../Reflection_Models/BSDF_Representation.html#BSDF" class="code">BSDF</a> bsdf = isect.<a href="../Textures_and_Materials/Material_Interface_and_Implementations.html#SurfaceInteraction::GetBSDF" class="code">GetBSDF</a>(ray, lambda, camera, scratchBuffer, sampler);
   if (!bsdf) {
       isect.<a href="../Textures_and_Materials/Texture_Sampling_and_Antialiasing.html#SurfaceInteraction::SkipIntersection" class="code">SkipIntersection</a>(&amp;ray, si-&gt;<a href="../Shapes/Basic_Shape_Interface.html#ShapeIntersection::tHit" class="code">tHit</a>);
       continue;
   }</div></div>
&lt;&lt;<span class="fragmentname"><a href="#fragment-InitializemonovisibleSurfatfirstintersection-0">Initialize <tt>visibleSurf</tt> at first intersection</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1898" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1898"><i></i></a><div id="fragbit-1898" class="collapse show"><div class="fragmentcode">   if (depth == 0 &amp;&amp; visibleSurf) {
       &lt;&lt;<span class="fragmentname"><a href="#fragment-EstimateBSDFsalbedo-0">Estimate BSDF&rsquo;s albedo</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1899" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1899"><i></i></a><div id="fragbit-1899" class="collapse show"><div class="fragmentcode">          &lt;&lt;<span class="fragmentname">Define sample arrays <tt>ucRho</tt> and <tt>uRho</tt> for reflectance estimate</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1900" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1900"><i></i></a><div id="fragbit-1900" class="collapse show"><div class="fragmentcode">             constexpr int nRhoSamples = 16;
             const Float ucRho[nRhoSamples] = { 0.75741637, 0.37870818, 0.7083487, 0.18935409, 0.9149363, 0.35417435, 0.5990858, 0.09467703, 0.8578725, 0.45746812, 0.686759, 0.17708716, 0.9674518, 0.2995429, 0.5083201, 0.047338516 };
             const <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a> uRho[nRhoSamples] = { <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.855985, 0.570367), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.381823, 0.851844), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.285328, 0.764262), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.733380, 0.114073), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.542663, 0.344465), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.127274, 0.414848), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.964700, 0.947162), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.594089, 0.643463), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.095109, 0.170369), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.825444, 0.263359), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.429467, 0.454469), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.244460, 0.816459), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.756135, 0.731258), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.516165, 0.152852), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.180888, 0.214174), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.898579, 0.503897) };</div></div>
          <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> albedo = bsdf.<a href="../Reflection_Models/BSDF_Representation.html#BSDF::rho" class="code">rho</a>(isect.<a href="../Geometry_and_Transformations/Interactions.html#Interaction::wo" class="code">wo</a>, ucRho, uRho);</div></div>
       *visibleSurf = <a href="../Cameras_and_Film/Film_and_Imaging.html#VisibleSurface" class="code">VisibleSurface</a>(isect, albedo, lambda);
   }</div></div>
&lt;&lt;<span class="fragmentname"><a href="#fragment-PossiblyregularizetheBSDF-0">Possibly regularize the BSDF</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1901" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1901"><i></i></a><div id="fragbit-1901" class="collapse show"><div class="fragmentcode">   if (<a href="#PathIntegrator::regularize" class="code">regularize</a> &amp;&amp; anyNonSpecularBounces)
       bsdf.<a href="#BSDF::Regularize" class="code">Regularize</a>();
   </div></div>
</div><p>


</p>
<p>If the <tt>Film</tt> being used takes a <a href="../Cameras_and_Film/Film_and_Imaging.html#VisibleSurface"><tt>VisibleSurface</tt></a>,
then a non-<tt>nullptr</tt> <tt>VisibleSurface *</tt> is passed to the
<tt>Li()</tt> method.  It is initialized at the first intersection.

</p>
<p></p>
<span class="anchor" id="fragment-InitializemonovisibleSurfatfirstintersection-0"></span><div class="fragmentname">&lt;&lt;Initialize <tt>visibleSurf</tt> at first intersection&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">if (depth == 0 &amp;&amp; visibleSurf) {
    &lt;&lt;<span class="fragmentname"><a href="#fragment-EstimateBSDFsalbedo-0">Estimate BSDF&rsquo;s albedo</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1902" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1902"><i></i></a><div id="fragbit-1902" class="collapse show"><div class="fragmentcode">       &lt;&lt;<span class="fragmentname">Define sample arrays <tt>ucRho</tt> and <tt>uRho</tt> for reflectance estimate</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1903" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1903"><i></i></a><div id="fragbit-1903" class="collapse show"><div class="fragmentcode">          constexpr int nRhoSamples = 16;
          const Float ucRho[nRhoSamples] = { 0.75741637, 0.37870818, 0.7083487, 0.18935409, 0.9149363, 0.35417435, 0.5990858, 0.09467703, 0.8578725, 0.45746812, 0.686759, 0.17708716, 0.9674518, 0.2995429, 0.5083201, 0.047338516 };
          const <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a> uRho[nRhoSamples] = { <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.855985, 0.570367), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.381823, 0.851844), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.285328, 0.764262), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.733380, 0.114073), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.542663, 0.344465), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.127274, 0.414848), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.964700, 0.947162), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.594089, 0.643463), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.095109, 0.170369), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.825444, 0.263359), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.429467, 0.454469), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.244460, 0.816459), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.756135, 0.731258), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.516165, 0.152852), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.180888, 0.214174), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.898579, 0.503897) };</div></div>
       <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> albedo = bsdf.<a href="../Reflection_Models/BSDF_Representation.html#BSDF::rho" class="code">rho</a>(isect.<a href="../Geometry_and_Transformations/Interactions.html#Interaction::wo" class="code">wo</a>, ucRho, uRho);</div></div>
    *visibleSurf = <a href="../Cameras_and_Film/Film_and_Imaging.html#VisibleSurface" class="code">VisibleSurface</a>(isect, albedo, lambda);
}</div><p>


</p>
<p>The only quantity that is not immediately available from the <a href="../Geometry_and_Transformations/Interactions.html#SurfaceInteraction"><tt>SurfaceInteraction</tt></a> is the albedo of the
surface, which is computed here as the hemispherical-directional
reflectance, Equation&nbsp;(<a href="../Radiometry,_Spectra,_and_Color/Surface_Reflection.html#eq:rho-hd">4.12</a>).  Recall that the <a href="../Reflection_Models/BSDF_Representation.html#BSDF::rho"><tt>BSDF::rho()</tt></a>
method estimates this value using Monte Carlo integration.  Here, a set of
16 precomputed Owen-scrambled Halton points in arrays <tt>ucRho</tt> and
<tt>uRho</tt>, not included in the text, are used for the estimate.

</p>
<p>The use of Monte Carlo with this many samples is somewhat unsatisfying.
The computed albedo is most commonly used for image-space denoising
algorithms after rendering; most of these start by dividing the final color
at each pixel by the first visible surface&rsquo;s albedo in order to approximate
the incident illumination alone.  It is therefore important that the albedo
value itself not have very much error.
However, the albedo can be computed analytically for some BSDFs (e.g., the
ideal Lambertian BRDF).  In those cases, executing both the BSDF
sampling and evaluation algorithms repeatedly is wasteful.  An exercise at
the end of the chapter discusses this matter further.

</p>
<p></p>
<span class="anchor" id="fragment-EstimateBSDFsalbedo-0"></span><div class="fragmentname">&lt;&lt;Estimate BSDF&rsquo;s albedo&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">&lt;&lt;<span class="fragmentname">Define sample arrays <tt>ucRho</tt> and <tt>uRho</tt> for reflectance estimate</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1904" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1904"><i></i></a><div id="fragbit-1904" class="collapse show"><div class="fragmentcode">   constexpr int nRhoSamples = 16;
   const Float ucRho[nRhoSamples] = { 0.75741637, 0.37870818, 0.7083487, 0.18935409, 0.9149363, 0.35417435, 0.5990858, 0.09467703, 0.8578725, 0.45746812, 0.686759, 0.17708716, 0.9674518, 0.2995429, 0.5083201, 0.047338516 };
   const <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a> uRho[nRhoSamples] = { <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.855985, 0.570367), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.381823, 0.851844), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.285328, 0.764262), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.733380, 0.114073), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.542663, 0.344465), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.127274, 0.414848), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.964700, 0.947162), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.594089, 0.643463), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.095109, 0.170369), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.825444, 0.263359), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.429467, 0.454469), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.244460, 0.816459), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.756135, 0.731258), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.516165, 0.152852), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.180888, 0.214174), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0.898579, 0.503897) };</div></div>
<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> albedo = bsdf.<a href="../Reflection_Models/BSDF_Representation.html#BSDF::rho" class="code">rho</a>(isect.<a href="../Geometry_and_Transformations/Interactions.html#Interaction::wo" class="code">wo</a>, ucRho, uRho);</div><p>


</p>
<p>

</p>
<p>The next task is to sample a light source to find a direction <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.135ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 919.4 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">omega Subscript normal i</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-69" d="M247 0c-34 1 -69 3 -104 3l-110 -3v31c67 0 78 0 78 45v269c0 49 -9 55 -74 55v31l140 11v-367c0 -39 4 -44 70 -44v-31zM192 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="880" y="-213"></use>
</g>
</svg> to use
to estimate the first term of Equation&nbsp;(<a href="#eq:mis-direct-lighting-estimator">13.10</a>).
However, if the BSDF is purely
specular, there is no reason to do this work, since the value of
the BSDF for a sampled point on a light will certainly be zero.

</p>
<p></p>
<span class="anchor" id="fragment-Sampledirectilluminationfromthelightsources-0"></span><div class="fragmentname">&lt;&lt;Sample direct illumination from the light sources&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">if (<a href="../Reflection_Models/BSDF_Representation.html#BxDFFlags::IsNonSpecular" class="code">IsNonSpecular</a>(bsdf.<a href="../Reflection_Models/BSDF_Representation.html#BSDF::Flags" class="code">Flags</a>())) {
    <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> Ld = <a href="#PathIntegrator::SampleLd" class="code">SampleLd</a>(isect, &amp;bsdf, lambda, sampler);
    L += beta * Ld;
}</div><p>


</p>
<p>Although <tt>SampleLd()</tt> is only called once and thus could be expanded
inline in the <tt>Li()</tt> method, there are multiple points along the way
where it may return early.  We therefore prefer a function here, as it
avoids deeply nested <tt>if</tt> statements that would be needed otherwise.

</p>
<p></p>
<span class="anchor" id="fragment-PathIntegratorMethodDefinitions-1"></span><div class="fragmentname">&lt;&lt;PathIntegrator Method Definitions&gt;&gt;+=&nbsp;<a href="#fragment-PathIntegratorMethodDefinitions-0"><span class="fa fa-caret-up"></span></a></div>
<div class="fragmentcode"><a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> <span class="anchor" id="PathIntegrator::SampleLd"></span>PathIntegrator::SampleLd(
        const <a href="../Geometry_and_Transformations/Interactions.html#SurfaceInteraction" class="code">SurfaceInteraction</a> &amp;intr, const <a href="../Reflection_Models/BSDF_Representation.html#BSDF" class="code">BSDF</a> *bsdf,
        <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledWavelengths" class="code">SampledWavelengths</a> &amp;lambda, <a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler" class="code">Sampler</a> sampler) const {
    &lt;&lt;<span class="fragmentname"><a href="#fragment-InitializemonoLightSampleContextforlightsampling-0">Initialize <tt>LightSampleContext</tt> for light sampling</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1905" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1905"><i></i></a><div id="fragbit-1905" class="collapse show"><div class="fragmentcode">       <a href="../Light_Sources/Light_Interface.html#LightSampleContext" class="code">LightSampleContext</a> ctx(intr);
       &lt;&lt;<span class="fragmentname"><a href="#fragment-Trytonudgethelightsamplingpositiontocorrectsideofthesurface-0">Try to nudge the light sampling position to correct side of the surface</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1906" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1906"><i></i></a><div id="fragbit-1906" class="collapse show"><div class="fragmentcode">          <a href="../Reflection_Models/BSDF_Representation.html#BxDFFlags" class="code">BxDFFlags</a> flags = bsdf-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDF::Flags" class="code">Flags</a>();
          if (<a href="../Reflection_Models/BSDF_Representation.html#BxDFFlags::IsReflective" class="code">IsReflective</a>(flags) &amp;&amp; !<a href="../Reflection_Models/BSDF_Representation.html#BxDFFlags::IsTransmissive" class="code">IsTransmissive</a>(flags))
              ctx.<a href="../Light_Sources/Light_Interface.html#LightSampleContext::pi" class="code">pi</a> = intr.<a href="../Shapes/Managing_Rounding_Error.html#Interaction::OffsetRayOrigin" class="code">OffsetRayOrigin</a>(intr.<a href="../Geometry_and_Transformations/Interactions.html#Interaction::wo" class="code">wo</a>);
          else if (<a href="../Reflection_Models/BSDF_Representation.html#BxDFFlags::IsTransmissive" class="code">IsTransmissive</a>(flags) &amp;&amp; !<a href="../Reflection_Models/BSDF_Representation.html#BxDFFlags::IsReflective" class="code">IsReflective</a>(flags))
              ctx.<a href="../Light_Sources/Light_Interface.html#LightSampleContext::pi" class="code">pi</a> = intr.<a href="../Shapes/Managing_Rounding_Error.html#Interaction::OffsetRayOrigin" class="code">OffsetRayOrigin</a>(-intr.<a href="../Geometry_and_Transformations/Interactions.html#Interaction::wo" class="code">wo</a>);</div></div></div></div>
    &lt;&lt;<span class="fragmentname"><a href="#fragment-Choosealightsourceforthedirectlightingcalculation-0">Choose a light source for the direct lighting calculation</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1907" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1907"><i></i></a><div id="fragbit-1907" class="collapse show"><div class="fragmentcode">       Float u = sampler.<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::Get1D" class="code">Get1D</a>();
       pstd::optional&lt;<a href="../Light_Sources/Light_Sampling.html#SampledLight" class="code">SampledLight</a>&gt; sampledLight = <a href="#PathIntegrator::lightSampler" class="code">lightSampler</a>.<a href="../Light_Sources/Light_Sampling.html#LightSampler::Sample" class="code">Sample</a>(ctx, u);
       <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a> uLight = sampler.<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::Get2D" class="code">Get2D</a>();
       if (!sampledLight) return {};</div></div>
    &lt;&lt;<span class="fragmentname"><a href="#fragment-Sampleapointonthelightsourcefordirectlighting-0">Sample a point on the light source for direct lighting</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1908" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1908"><i></i></a><div id="fragbit-1908" class="collapse show"><div class="fragmentcode">       <a href="../Light_Sources/Light_Interface.html#Light" class="code">Light</a> <a href="../Light_Sources/Light_Sampling.html#SampledLight::light" class="code">light</a> = sampledLight-&gt;<a href="../Light_Sources/Light_Sampling.html#SampledLight::light" class="code">light</a>;
       pstd::optional&lt;<a href="../Light_Sources/Light_Interface.html#LightLiSample" class="code">LightLiSample</a>&gt; ls = <a href="../Light_Sources/Light_Sampling.html#SampledLight::light" class="code">light</a>.<a href="../Light_Sources/Light_Interface.html#Light::SampleLi" class="code">SampleLi</a>(ctx, uLight, lambda, true);
       if (!ls || !ls-&gt;<a href="../Light_Sources/Light_Interface.html#LightLiSample::L" class="code">L</a> || ls-&gt;<a href="../Light_Sources/Light_Interface.html#LightLiSample::pdf" class="code">pdf</a> == 0)
           return {};</div></div>
    &lt;&lt;<span class="fragmentname"><a href="#fragment-EvaluateBSDFforlightsampleandchecklightvisibility-0">Evaluate BSDF for light sample and check light visibility</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1909" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1909"><i></i></a><div id="fragbit-1909" class="collapse show"><div class="fragmentcode">       <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> <a href="../Geometry_and_Transformations/Interactions.html#Interaction::wo" class="code">wo</a> = intr.<a href="../Geometry_and_Transformations/Interactions.html#Interaction::wo" class="code">wo</a>, <a href="../Light_Sources/Light_Interface.html#LightLiSample::wi" class="code">wi</a> = ls-&gt;<a href="../Light_Sources/Light_Interface.html#LightLiSample::wi" class="code">wi</a>;
       <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> <a href="../Reflection_Models/BSDF_Representation.html#BSDF::f" class="code">f</a> = bsdf-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDF::f" class="code">f</a>(<a href="../Geometry_and_Transformations/Interactions.html#Interaction::wo" class="code">wo</a>, <a href="../Light_Sources/Light_Interface.html#LightLiSample::wi" class="code">wi</a>) * <a href="../Geometry_and_Transformations/Vectors.html#AbsDot" class="code">AbsDot</a>(<a href="../Light_Sources/Light_Interface.html#LightLiSample::wi" class="code">wi</a>, intr.shading.<a href="../Geometry_and_Transformations/Interactions.html#SurfaceInteraction::shading::n" class="code">n</a>);
       if (!<a href="../Reflection_Models/BSDF_Representation.html#BSDF::f" class="code">f</a> || !<a href="../Light_Transport_I_Surface_Reflection/A_Simple_Path_Tracer.html#Integrator::Unoccluded" class="code">Unoccluded</a>(intr, ls-&gt;<a href="../Light_Sources/Light_Interface.html#LightLiSample::pLight" class="code">pLight</a>))
           return {};</div></div>
    &lt;&lt;<span class="fragmentname"><a href="#fragment-Returnlightscontributiontoreflectedradiance-0">Return light&rsquo;s contribution to reflected radiance</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1910" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1910"><i></i></a><div id="fragbit-1910" class="collapse show"><div class="fragmentcode">       Float p_l = sampledLight-&gt;<a href="../Light_Sources/Light_Sampling.html#SampledLight::p" class="code">p</a> * ls-&gt;<a href="../Light_Sources/Light_Interface.html#LightLiSample::pdf" class="code">pdf</a>;
       if (<a href="../Light_Sources/Light_Interface.html#IsDeltaLight" class="code">IsDeltaLight</a>(light.<a href="../Light_Sources/Light_Interface.html#Light::Type" class="code">Type</a>()))
           return ls-&gt;<a href="../Light_Sources/Light_Interface.html#LightLiSample::L" class="code">L</a> * f / p_l;
       else {
           Float p_b = bsdf-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDF::PDF" class="code">PDF</a>(wo, wi);
           Float w_l = <a href="../Monte_Carlo_Integration/Improving_Efficiency.html#PowerHeuristic" class="code">PowerHeuristic</a>(1, p_l, 1, p_b);
           return w_l * ls-&gt;<a href="../Light_Sources/Light_Interface.html#LightLiSample::L" class="code">L</a> * f  / p_l;
       }</div></div>
}</div><p>


</p>
<p>A <a href="../Light_Sources/Light_Interface.html#LightSampleContext"><tt>LightSampleContext</tt></a> is necessary both for choosing a specific light
source and for sampling a point on it.  One is initialized
using the constructor that takes a <a href="../Geometry_and_Transformations/Interactions.html#SurfaceInteraction"><tt>SurfaceInteraction</tt></a>.

</p>
<p></p>
<span class="anchor" id="fragment-InitializemonoLightSampleContextforlightsampling-0"></span><div class="fragmentname">&lt;&lt;Initialize <tt>LightSampleContext</tt> for light sampling&gt;&gt;=&nbsp;</div>
<div class="fragmentcode"><a href="../Light_Sources/Light_Interface.html#LightSampleContext" class="code">LightSampleContext</a> ctx(intr);
&lt;&lt;<span class="fragmentname"><a href="#fragment-Trytonudgethelightsamplingpositiontocorrectsideofthesurface-0">Try to nudge the light sampling position to correct side of the surface</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1911" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1911"><i></i></a><div id="fragbit-1911" class="collapse show"><div class="fragmentcode">   <a href="../Reflection_Models/BSDF_Representation.html#BxDFFlags" class="code">BxDFFlags</a> flags = bsdf-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDF::Flags" class="code">Flags</a>();
   if (<a href="../Reflection_Models/BSDF_Representation.html#BxDFFlags::IsReflective" class="code">IsReflective</a>(flags) &amp;&amp; !<a href="../Reflection_Models/BSDF_Representation.html#BxDFFlags::IsTransmissive" class="code">IsTransmissive</a>(flags))
       ctx.<a href="../Light_Sources/Light_Interface.html#LightSampleContext::pi" class="code">pi</a> = intr.<a href="../Shapes/Managing_Rounding_Error.html#Interaction::OffsetRayOrigin" class="code">OffsetRayOrigin</a>(intr.<a href="../Geometry_and_Transformations/Interactions.html#Interaction::wo" class="code">wo</a>);
   else if (<a href="../Reflection_Models/BSDF_Representation.html#BxDFFlags::IsTransmissive" class="code">IsTransmissive</a>(flags) &amp;&amp; !<a href="../Reflection_Models/BSDF_Representation.html#BxDFFlags::IsReflective" class="code">IsReflective</a>(flags))
       ctx.<a href="../Light_Sources/Light_Interface.html#LightSampleContext::pi" class="code">pi</a> = intr.<a href="../Shapes/Managing_Rounding_Error.html#Interaction::OffsetRayOrigin" class="code">OffsetRayOrigin</a>(-intr.<a href="../Geometry_and_Transformations/Interactions.html#Interaction::wo" class="code">wo</a>);</div></div></div><p>


</p>
<p>If the surface is purely reflective or purely transmissive, then the
reference point used for sampling <tt>pi</tt> is shifted slightly so that it lies on the side
of the surface from which the outgoing ray will leave the intersection
point toward the light.  Doing so helps avoid a subtle error that is the result of the
combination of floating-point round-off error in the computed intersection
point and a ray that intersects an emitter that does not have a completely
absorbing BSDF.  The problem is illustrated in
Figure&nbsp;<a href="#fig:shift-origin-for-light-intersections">13.9</a>.

</p>
<p> </p>
<span class="anchor" id="fig:shift-origin-for-light-intersections"></span><div class="card outerfigure"><div class="card-body figure"><p>



</p>
<div class="figure-row">
  <a href="pha13f09.svg" title=""><img src="pha13f09.svg" width=239 height=185 style="max-width: 100%;"></a>
</div>
<p>


</p>
<figcaption class="caption">Figure 13.9: <span class="legend">
The <a href="../Light_Sources/Light_Interface.html#LightSampleContext"><tt>LightSampleContext</tt></a> stores the error bounds around the
computed intersection point <tt>pi</tt>.  Typically, the center of these
bounds (filled circle) is used as the reference point for sampling a point
on the light source.  If a ray intersects the non-emissive side of a
one-sided light, the light&rsquo;s BSDF is nonzero, and if the center of the
<tt>pi</tt> bounds is on the emissive side of the light, then it may seem that
the intersection point is illuminated by the light.  The result is an
occasional bright pixel on the back side of light sources.  Offsetting the
reference point to the side of the surface from which the outgoing
ray will leave (open circle) works around this problem.</span>
</figcaption><p>


</p>
</div></div><p>


</p>
<p></p>
<span class="anchor" id="fragment-Trytonudgethelightsamplingpositiontocorrectsideofthesurface-0"></span><div class="fragmentname">&lt;&lt;Try to nudge the light sampling position to correct side of the surface&gt;&gt;=&nbsp;</div>
<div class="fragmentcode"><a href="../Reflection_Models/BSDF_Representation.html#BxDFFlags" class="code">BxDFFlags</a> flags = bsdf-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDF::Flags" class="code">Flags</a>();
if (<a href="../Reflection_Models/BSDF_Representation.html#BxDFFlags::IsReflective" class="code">IsReflective</a>(flags) &amp;&amp; !<a href="../Reflection_Models/BSDF_Representation.html#BxDFFlags::IsTransmissive" class="code">IsTransmissive</a>(flags))
    ctx.<a href="../Light_Sources/Light_Interface.html#LightSampleContext::pi" class="code">pi</a> = intr.<a href="../Shapes/Managing_Rounding_Error.html#Interaction::OffsetRayOrigin" class="code">OffsetRayOrigin</a>(intr.<a href="../Geometry_and_Transformations/Interactions.html#Interaction::wo" class="code">wo</a>);
else if (<a href="../Reflection_Models/BSDF_Representation.html#BxDFFlags::IsTransmissive" class="code">IsTransmissive</a>(flags) &amp;&amp; !<a href="../Reflection_Models/BSDF_Representation.html#BxDFFlags::IsReflective" class="code">IsReflective</a>(flags))
    ctx.<a href="../Light_Sources/Light_Interface.html#LightSampleContext::pi" class="code">pi</a> = intr.<a href="../Shapes/Managing_Rounding_Error.html#Interaction::OffsetRayOrigin" class="code">OffsetRayOrigin</a>(-intr.<a href="../Geometry_and_Transformations/Interactions.html#Interaction::wo" class="code">wo</a>);</div><p>


</p>
<p>Next, the <a href="../Light_Sources/Light_Sampling.html#LightSampler"><tt>LightSampler</tt></a> selects a light.  One thing to note in
the implementation here is that two more dimensions are consumed from the
<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler"><tt>Sampler</tt></a> even if the <tt>LightSampler</tt> does not return a valid
light.  This is done in order to keep the allocation of <a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler"><tt>Sampler</tt></a>
dimensions consistent across all the pixel samples. (Recall the
discussion of this issue in Section&nbsp;<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#sec:sampling-interface">8.3</a>.)

</p>
<p></p>
<span class="anchor" id="fragment-Choosealightsourceforthedirectlightingcalculation-0"></span><div class="fragmentname">&lt;&lt;Choose a light source for the direct lighting calculation&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">Float u = sampler.<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::Get1D" class="code">Get1D</a>();
pstd::optional&lt;<a href="../Light_Sources/Light_Sampling.html#SampledLight" class="code">SampledLight</a>&gt; sampledLight = <a href="#PathIntegrator::lightSampler" class="code">lightSampler</a>.<a href="../Light_Sources/Light_Sampling.html#LightSampler::Sample" class="code">Sample</a>(ctx, u);
<a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a> uLight = sampler.<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::Get2D" class="code">Get2D</a>();
if (!sampledLight) return {};</div><p>


</p>
<p>Sampling a direction with the light proceeds using <a href="../Light_Sources/Light_Interface.html#Light::SampleLi"><tt>Light::SampleLi()</tt></a>,
though here a <tt>true</tt> value is passed for its <tt>allowIncompletePDF</tt>
parameter.  Because we will use a second sampling technique, BSDF sampling,
for the estimator in Equation&nbsp;(<a href="#eq:mis-direct-lighting-estimator">13.10</a>), and
that technique has nonzero probability of sampling all directions <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.135ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 919.4 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">omega Subscript normal i</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-69" d="M247 0c-34 1 -69 3 -104 3l-110 -3v31c67 0 78 0 78 45v269c0 49 -9 55 -74 55v31l140 11v-367c0 -39 4 -44 70 -44v-31zM192 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="880" y="-213"></use>
</g>
</svg>
where the integrand is nonzero, the light sampling distribution may not
include directions where the light&rsquo;s emission is relatively low.  (The
motivation for this was discussed in
Section&nbsp;<a href="../Monte_Carlo_Integration/Improving_Efficiency.html#sec:multiple-importance-sampling">2.2.3</a> in the context of MIS
compensation.)

</p>
<p>Given a light sample, it is worth checking for various cases that require
no further processing here.  As an example, consider a spotlight where the
intersection point is outside of its emission cone; the <a href="../Light_Sources/Light_Interface.html#LightLiSample"><tt>LightLiSample</tt></a>
will have a zero radiance value in that case.  It is worthwhile to find
that there is no incident radiance before incurring the cost of evaluating
the BSDF.

</p>
<p></p>
<span class="anchor" id="fragment-Sampleapointonthelightsourcefordirectlighting-0"></span><div class="fragmentname">&lt;&lt;Sample a point on the light source for direct lighting&gt;&gt;=&nbsp;</div>
<div class="fragmentcode"><a href="../Light_Sources/Light_Interface.html#Light" class="code">Light</a> <a href="../Light_Sources/Light_Sampling.html#SampledLight::light" class="code">light</a> = sampledLight-&gt;<a href="../Light_Sources/Light_Sampling.html#SampledLight::light" class="code">light</a>;
pstd::optional&lt;<a href="../Light_Sources/Light_Interface.html#LightLiSample" class="code">LightLiSample</a>&gt; ls = <a href="../Light_Sources/Light_Sampling.html#SampledLight::light" class="code">light</a>.<a href="../Light_Sources/Light_Interface.html#Light::SampleLi" class="code">SampleLi</a>(ctx, uLight, lambda, true);
if (!ls || !ls-&gt;<a href="../Light_Sources/Light_Interface.html#LightLiSample::L" class="code">L</a> || ls-&gt;<a href="../Light_Sources/Light_Interface.html#LightLiSample::pdf" class="code">pdf</a> == 0)
    return {};</div><p>


</p>
<p>A shadow ray is only traced if the BSDF for the sampled direction is
nonzero.  It is not unusual for the BSDF to be zero here: for example,
given a surface that is reflective but not transmissive, any sampled
direction that is on the other side of the surface than the incident ray
will have zero contribution.

</p>
<p></p>
<span class="anchor" id="fragment-EvaluateBSDFforlightsampleandchecklightvisibility-0"></span><div class="fragmentname">&lt;&lt;Evaluate BSDF for light sample and check light visibility&gt;&gt;=&nbsp;</div>
<div class="fragmentcode"><a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> <a href="../Geometry_and_Transformations/Interactions.html#Interaction::wo" class="code">wo</a> = intr.<a href="../Geometry_and_Transformations/Interactions.html#Interaction::wo" class="code">wo</a>, <a href="../Light_Sources/Light_Interface.html#LightLiSample::wi" class="code">wi</a> = ls-&gt;<a href="../Light_Sources/Light_Interface.html#LightLiSample::wi" class="code">wi</a>;
<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> <a href="../Reflection_Models/BSDF_Representation.html#BSDF::f" class="code">f</a> = bsdf-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDF::f" class="code">f</a>(<a href="../Geometry_and_Transformations/Interactions.html#Interaction::wo" class="code">wo</a>, <a href="../Light_Sources/Light_Interface.html#LightLiSample::wi" class="code">wi</a>) * <a href="../Geometry_and_Transformations/Vectors.html#AbsDot" class="code">AbsDot</a>(<a href="../Light_Sources/Light_Interface.html#LightLiSample::wi" class="code">wi</a>, intr.shading.<a href="../Geometry_and_Transformations/Interactions.html#SurfaceInteraction::shading::n" class="code">n</a>);
if (!<a href="../Reflection_Models/BSDF_Representation.html#BSDF::f" class="code">f</a> || !<a href="../Light_Transport_I_Surface_Reflection/A_Simple_Path_Tracer.html#Integrator::Unoccluded" class="code">Unoccluded</a>(intr, ls-&gt;<a href="../Light_Sources/Light_Interface.html#LightLiSample::pLight" class="code">pLight</a>))
    return {};</div><p>


</p>
<p></p>
<span class="anchor" id="fig:path-balance-vs-power"></span><div class="card outerfigure"><div class="card-body figure"><p>



</p>
<div class="figure-row">
  <a href="pha13f10.svg" title=""><img src="pha13f10.svg" width=750 height=395 style="max-width: 100%;"></a>
</div>
<p>


</p>
<figcaption class="caption">Figure 13.10: Comparison of the Balance and Power Heuristics for Direct
Lighting. <span class="legend">
A zoomed-in region of Figure&nbsp;<a href="#fig:sample-bsdf-light">13.8</a> is shown here.
(a)&nbsp;Rendered using the balance heuristic to weight BSDF and light
samples in the direct lighting calculation.
(b)&nbsp;Rendered using the power heuristic.  The pixels behind the
light source have a visible reduction in noise.</span>
</figcaption><p>
 

</p>
</div></div><p>


</p>
<p>The light sample&rsquo;s contribution can now be computed; recall that the
returned value corresponds to the first term of
Equation&nbsp;(<a href="#eq:mis-direct-lighting-estimator">13.10</a>), save for the <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.334ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 574.5 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">beta</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D6FD" d="M574 574c0 -12 -2 -24 -5 -37c-11 -45 -41 -86 -81 -116c-10 -8 -20 -14 -30 -20c17 -11 31 -26 43 -43c20 -31 30 -68 30 -108c0 -20 -3 -42 -8 -64c-14 -53 -51 -104 -99 -140c-52 -38 -113 -57 -170 -57c-68 0 -114 40 -131 98l-68 -274c-1 -4 -5 -7 -10 -7h-5 c-6 0 -10 4 -10 12l154 615c34 136 125 273 245 273c47 0 89 -18 116 -50c18 -22 29 -51 29 -82zM518 592c0 19 -3 36 -12 51c-16 26 -44 40 -78 40c-110 0 -188 -129 -220 -255l-60 -242c-4 -17 -6 -33 -6 -49c0 -71 41 -126 113 -126c44 0 91 19 129 52 c39 35 61 82 73 128c7 29 12 59 12 87c0 25 -4 48 -14 69c-7 16 -17 29 -30 39c-25 -9 -50 -13 -75 -13c-35 0 -76 0 -76 24c0 0 0 5 1 7c7 27 49 27 85 27c24 0 47 -5 67 -13c9 5 18 12 26 19c31 29 49 67 58 105c5 17 7 34 7 50zM395 403c-11 3 -23 5 -36 5 c-24 0 -57 0 -60 -9c-1 -4 30 -4 52 -4c14 0 29 3 44 8Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D6FD" x="0" y="0"></use>
</g>
</svg>
factor.  The case of a light that is described by a delta distribution
receives special treatment here; recall from Section&nbsp;<a href="../Light_Sources/Light_Interface.html#sec:light">12.1</a> that
in that case there is an implied delta distribution in the emitted
radiance value returned from <tt>SampleLi()</tt> as well as the PDF and that
they cancel out when the estimator is evaluated.  Further, BSDF
sampling is unable to generate a light sample and therefore we must not
try to apply multiple importance sampling but should evaluate the standard
estimator, Equation&nbsp;(<a href="../Light_Transport_I_Surface_Reflection/A_Simple_Path_Tracer.html#eq:simple-pt-pathcontrib">13.9</a>), instead.  If we do
not have a delta distribution light source, then the value of the BSDF&rsquo;s
PDF for sampling the direction <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.135ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 919.4 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">omega Subscript normal i</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-69" d="M247 0c-34 1 -69 3 -104 3l-110 -3v31c67 0 78 0 78 45v269c0 49 -9 55 -74 55v31l140 11v-367c0 -39 4 -44 70 -44v-31zM192 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="880" y="-213"></use>
</g>
</svg> is found by calling <a href="../Reflection_Models/BSDF_Representation.html#BSDF::PDF"><tt>BSDF::PDF()</tt></a>
and the MIS weight is computed using the power heuristic.  (See
Figure&nbsp;<a href="#fig:path-balance-vs-power">13.10</a> for a comparison between the balance
heuristic and power heuristic for this computation.)

</p>
<p></p>
<span class="anchor" id="fragment-Returnlightscontributiontoreflectedradiance-0"></span><div class="fragmentname">&lt;&lt;Return light&rsquo;s contribution to reflected radiance&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">Float p_l = sampledLight-&gt;<a href="../Light_Sources/Light_Sampling.html#SampledLight::p" class="code">p</a> * ls-&gt;<a href="../Light_Sources/Light_Interface.html#LightLiSample::pdf" class="code">pdf</a>;
if (<a href="../Light_Sources/Light_Interface.html#IsDeltaLight" class="code">IsDeltaLight</a>(light.<a href="../Light_Sources/Light_Interface.html#Light::Type" class="code">Type</a>()))
    return ls-&gt;<a href="../Light_Sources/Light_Interface.html#LightLiSample::L" class="code">L</a> * f / p_l;
else {
    Float p_b = bsdf-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDF::PDF" class="code">PDF</a>(wo, wi);
    Float w_l = <a href="../Monte_Carlo_Integration/Improving_Efficiency.html#PowerHeuristic" class="code">PowerHeuristic</a>(1, p_l, 1, p_b);
    return w_l * ls-&gt;<a href="../Light_Sources/Light_Interface.html#LightLiSample::L" class="code">L</a> * f  / p_l;
}</div><p>


</p>
<p>Returning now to the <tt>Li()</tt> method implementation, the next step is to
sample the BSDF at the intersection to get an
outgoing direction for the next ray to trace.  That ray will be used
to sample indirect illumination as well as for the BSDF sample for the
direct lighting estimator.

</p>
<p></p>
<span class="anchor" id="fragment-SampleBSDFtogetnewpathdirection-0"></span><div class="fragmentname">&lt;&lt;Sample BSDF to get new path direction&gt;&gt;=&nbsp;</div>
<div class="fragmentcode"><a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> wo = -ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a>;
Float u = sampler.<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::Get1D" class="code">Get1D</a>();
pstd::optional&lt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample" class="code">BSDFSample</a>&gt; bs = bsdf.<a href="../Reflection_Models/BSDF_Representation.html#BSDF::Sample_f" class="code">Sample_f</a>(wo, u, sampler.<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::Get2D" class="code">Get2D</a>());
if (!bs)
    break;
&lt;&lt;<span class="fragmentname"><a href="#fragment-Updatepathstatevariablesaftersurfacescattering-0">Update path state variables after surface scattering</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1912" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1912"><i></i></a><div id="fragbit-1912" class="collapse show"><div class="fragmentcode">   beta *= bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::f" class="code">f</a> * <a href="../Geometry_and_Transformations/Vectors.html#AbsDot" class="code">AbsDot</a>(bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>, isect.shading.<a href="../Geometry_and_Transformations/Interactions.html#SurfaceInteraction::shading::n" class="code">n</a>) / bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::pdf" class="code">pdf</a>;
   p_b = bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::pdfIsProportional" class="code">pdfIsProportional</a> ? bsdf.<a href="../Reflection_Models/BSDF_Representation.html#BSDF::PDF" class="code">PDF</a>(wo, bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>) : bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::pdf" class="code">pdf</a>;
   specularBounce = bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::IsSpecular" class="code">IsSpecular</a>();
   anyNonSpecularBounces |= !bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::IsSpecular" class="code">IsSpecular</a>();
   if (bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::IsTransmission" class="code">IsTransmission</a>())
       etaScale *= <a href="../Utilities/Mathematical_Infrastructure.html#Sqr" class="code">Sqr</a>(bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::eta" class="code">eta</a>);
   prevIntrCtx = si-&gt;<a href="../Shapes/Basic_Shape_Interface.html#ShapeIntersection::intr" class="code">intr</a>;</div></div> 
ray = isect.<a href="../Textures_and_Materials/Texture_Sampling_and_Antialiasing.html#SurfaceInteraction::SpawnRay" class="code">SpawnRay</a>(ray, bsdf, bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>, bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::flags" class="code">flags</a>, bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::eta" class="code">eta</a>);</div><p>


</p>
<p>In addition to the path throughput weight <tt>beta</tt>, a number of
additional values related to the path are maintained, as follows:
</p>
<ul>
<li> <tt>p_b</tt> is the PDF for sampling the direction <tt>bs-&gt;wi</tt>;
this value is needed for the MIS-based direct lighting estimate.  One nit
comes from BSDFs like the <a href="../Light_Transport_II_Volume_Rendering/Scattering_from_Layered_Materials.html#LayeredBxDF"><tt>LayeredBxDF</tt></a> that return a <a href="../Reflection_Models/BSDF_Representation.html#BSDFSample"><tt>BSDFSample</tt></a>
where the <tt>f</tt> and <tt>pdf</tt> are only proportional to their true
values.  In that case, an explicit call to <tt>BSDF::PDF()</tt> is required to
get an estimate of the true PDF.

<li> As in the <a href="../Light_Transport_I_Surface_Reflection/A_Simple_Path_Tracer.html#SimplePathIntegrator"><tt>SimplePathIntegrator</tt></a>, <tt>specularBounce</tt> tracks
whether the last scattering event was from a perfect specular surface.

<li> <tt>anyNonSpecularBounces</tt> tracks whether any scattering event
along the ray&rsquo;s path has been non-perfect specular.  This value is used
for path regularization if it is enabled.

<li> <tt>etaScale</tt> is the accumulated product of scaling factors that
have been applied to <tt>beta</tt> due to rays being transmitted between
media of different indices of refraction&mdash;a detail that is discussed in
Section&nbsp;<a href="../Reflection_Models/Dielectric_BSDF.html#sec:non-symmetric">9.5.2</a>. This value will be used in
the Russian roulette computation.

<li> Finally, <tt>prevIntrCtx</tt> stores geometric information about the
intersection point from which the sampled ray is leaving.  This value is
also used in the MIS computation for direct lighting. 
</ul><p>


</p>
<p></p>
<span class="anchor" id="fragment-Updatepathstatevariablesaftersurfacescattering-0"></span><div class="fragmentname">&lt;&lt;Update path state variables after surface scattering&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">beta *= bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::f" class="code">f</a> * <a href="../Geometry_and_Transformations/Vectors.html#AbsDot" class="code">AbsDot</a>(bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>, isect.shading.<a href="../Geometry_and_Transformations/Interactions.html#SurfaceInteraction::shading::n" class="code">n</a>) / bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::pdf" class="code">pdf</a>;
p_b = bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::pdfIsProportional" class="code">pdfIsProportional</a> ? bsdf.<a href="../Reflection_Models/BSDF_Representation.html#BSDF::PDF" class="code">PDF</a>(wo, bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>) : bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::pdf" class="code">pdf</a>;
specularBounce = bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::IsSpecular" class="code">IsSpecular</a>();
anyNonSpecularBounces |= !bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::IsSpecular" class="code">IsSpecular</a>();
if (bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::IsTransmission" class="code">IsTransmission</a>())
    etaScale *= <a href="../Utilities/Mathematical_Infrastructure.html#Sqr" class="code">Sqr</a>(bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::eta" class="code">eta</a>);
prevIntrCtx = si-&gt;<a href="../Shapes/Basic_Shape_Interface.html#ShapeIntersection::intr" class="code">intr</a>;</div><p>


</p>
<p></p>
<span class="anchor" id="fragment-DeclarelocalvariablesformonoPathIntegrator::Li-1"></span><div class="fragmentname">&lt;&lt;Declare local variables for <tt>PathIntegrator::Li()</tt>&gt;&gt;+=&nbsp;<a href="#fragment-DeclarelocalvariablesformonoPathIntegrator::Li-0"><span class="fa fa-caret-up"></span></a></div>
<div class="fragmentcode">Float p_b, etaScale = 1;
bool specularBounce = false, anyNonSpecularBounces = false;
<a href="../Light_Sources/Light_Interface.html#LightSampleContext" class="code">LightSampleContext</a> prevIntrCtx;</div><p>


</p>
<p>The new ray will account for indirect illumination at the intersection
point in the following execution of the <tt>while</tt> loop.

</p>
<p>Returning now to the &lt;&lt;<span class="fragmentname"><a href="#fragment-Addemittedlightatintersectionpointorfromtheenvironment-0">Add emitted light at intersection point or from the
environment</a></span>&gt;&gt; fragment at the start of the loop, we can see how the 
ray from the previous iteration of the <tt>while</tt> loop can take care of
the BSDF sample in Equation&nbsp;(<a href="#eq:mis-direct-lighting-estimator">13.10</a>).
The ray&rsquo;s direction was chosen by sampling the BSDF, and so if it
happens to hit a light source, then we have everything we need to evaluate
the second term of the estimate other than the MIS weight <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="6.065ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 2611.5 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">w Subscript normal b Baseline left-parenthesis omega Subscript Baseline right-parenthesis</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D464" d="M691 372c0 -48 -32 -182 -66 -260c-26 -60 -70 -123 -145 -123c-30 0 -99 6 -125 70c-40 -70 -87 -70 -104 -70c-75 0 -142 35 -142 126c0 38 12 84 56 202c7 17 18 45 18 70c0 32 -16 33 -25 33c-35 0 -74 -31 -101 -124c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10 c0 9 37 154 132 154c49 0 82 -37 82 -82c0 -20 -6 -34 -17 -64c-47 -123 -52 -162 -52 -194c0 -17 0 -91 80 -91c39 0 69 31 92 84c-1 5 -1 7 -1 18c0 18 2 36 9 66c7 26 54 217 57 224c7 20 25 28 37 28c15 0 29 -9 29 -27c0 -6 -10 -43 -15 -65l-42 -168 c-4 -14 -11 -45 -11 -73c0 -57 27 -87 74 -87c49 0 84 35 110 88c26 51 55 149 55 183c0 48 -25 74 -36 85c-9 8 -15 14 -15 27c0 22 25 48 50 48c17 0 44 -15 44 -70Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-62" d="M521 216c0 -129 -104 -227 -223 -227c-74 0 -116 50 -131 73l-36 -62h-25v596c0 49 -8 56 -78 56v31l144 11v-317c16 18 59 65 137 65c114 0 212 -99 212 -226zM438 217c0 41 -3 98 -29 139c-24 38 -60 64 -105 64c-24 0 -79 -8 -118 -64c-11 -16 -11 -17 -11 -36v-206 c0 -18 0 -21 14 -42c24 -37 60 -61 105 -61c54 0 92 33 113 64c29 45 31 105 31 142Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D464" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-62" x="1013" y="-213"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="1210" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="1599" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="2222" y="0"></use>
</g>
</svg>.  If
the ray does not hit a light source, then that term is zero for the BSDF
sample and there is no further work to do.

</p>
<p>There are two cases to handle: infinite lights for rays that do not
intersect any geometry, and surface emission for rays that do.  In the
first case, the ray path can terminate once lights have been considered.

</p>
<p></p>
<span class="anchor" id="fragment-Addemittedlightatintersectionpointorfromtheenvironment-0"></span><div class="fragmentname">&lt;&lt;Add emitted light at intersection point or from the environment&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">if (!si) {
    &lt;&lt;<span class="fragmentname"><a href="#fragment-Incorporateemissionfrominfinitelightsforescapedray-0">Incorporate emission from infinite lights for escaped ray</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1913" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1913"><i></i></a><div id="fragbit-1913" class="collapse show"><div class="fragmentcode">       for (const auto &amp;light : <a href="../Introduction/pbrt_System_Overview.html#Integrator::infiniteLights" class="code">infiniteLights</a>) {
           <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> <a href="../Light_Sources/Light_Interface.html#Light::Le" class="code">Le</a> = light.<a href="../Light_Sources/Light_Interface.html#Light::Le" class="code">Le</a>(ray, lambda);
           if (depth == 0 || specularBounce)
               L += beta * <a href="../Light_Sources/Light_Interface.html#Light::Le" class="code">Le</a>;
           else {
               &lt;&lt;<span class="fragmentname"><a href="#fragment-ComputeMISweightforinfinitelight-0">Compute MIS weight for infinite light</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1914" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1914"><i></i></a><div id="fragbit-1914" class="collapse show"><div class="fragmentcode">                  Float p_l = <a href="#PathIntegrator::lightSampler" class="code">lightSampler</a>.<a href="../Light_Sources/Light_Sampling.html#LightSampler::PMF" class="code">PMF</a>(prevIntrCtx, light) *
                      light.<a href="../Light_Sources/Light_Interface.html#Light::PDF_Li" class="code">PDF_Li</a>(prevIntrCtx, ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a>, true);
                  Float w_b = <a href="../Monte_Carlo_Integration/Improving_Efficiency.html#PowerHeuristic" class="code">PowerHeuristic</a>(1, p_b, 1, p_l);</div></div>
               L += beta * w_b * <a href="../Light_Sources/Light_Interface.html#Light::Le" class="code">Le</a>;
           }
       }</div></div>
    break;
}
&lt;&lt;<span class="fragmentname">Incorporate emission from surface hit by ray</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1915" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1915"><i></i></a><div id="fragbit-1915" class="collapse show"><div class="fragmentcode">   <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> Le = si-&gt;intr.Le(-ray.d, lambda);
   if (Le) {
       if (depth == 0 || specularBounce)
           L += beta * Le;
       else {
           &lt;&lt;<span class="fragmentname">Compute MIS weight for area light</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1916" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1916"><i></i></a><div id="fragbit-1916" class="collapse show"><div class="fragmentcode">              <a href="../Light_Sources/Light_Interface.html#Light" class="code">Light</a> areaLight(si-&gt;intr.areaLight);
              Float lightPDF = lightSampler.PMF(prevIntrCtx, areaLight) *
                  areaLight.PDF_Li(prevIntrCtx, ray.d, true);
              Float w_l = PowerHeuristic(1, bsdfPDF, 1, lightPDF);</div></div>
           L += beta * w_l * Le;
       }
   }</div></div></div><p>


</p>
<p>For the initial ray from the camera or after a perfect specular scattering
event, emitted radiance should be included in the path without any MIS weighting, since
light sampling was not performed at the previous vertex of the
path.  At this point in execution, <tt>beta</tt> already includes the BSDF,
cosine factor, and PDF value from the previous scattering event, so
multiplying <tt>beta</tt> by the emitted radiance gives the correct
contribution.

</p>
<p></p>
<span class="anchor" id="fragment-Incorporateemissionfrominfinitelightsforescapedray-0"></span><div class="fragmentname">&lt;&lt;Incorporate emission from infinite lights for escaped ray&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">for (const auto &amp;light : <a href="../Introduction/pbrt_System_Overview.html#Integrator::infiniteLights" class="code">infiniteLights</a>) {
    <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> <a href="../Light_Sources/Light_Interface.html#Light::Le" class="code">Le</a> = light.<a href="../Light_Sources/Light_Interface.html#Light::Le" class="code">Le</a>(ray, lambda);
    if (depth == 0 || specularBounce)
        L += beta * <a href="../Light_Sources/Light_Interface.html#Light::Le" class="code">Le</a>;
    else {
        &lt;&lt;<span class="fragmentname"><a href="#fragment-ComputeMISweightforinfinitelight-0">Compute MIS weight for infinite light</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1917" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1917"><i></i></a><div id="fragbit-1917" class="collapse show"><div class="fragmentcode">           Float p_l = <a href="#PathIntegrator::lightSampler" class="code">lightSampler</a>.<a href="../Light_Sources/Light_Sampling.html#LightSampler::PMF" class="code">PMF</a>(prevIntrCtx, light) *
               light.<a href="../Light_Sources/Light_Interface.html#Light::PDF_Li" class="code">PDF_Li</a>(prevIntrCtx, ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a>, true);
           Float w_b = <a href="../Monte_Carlo_Integration/Improving_Efficiency.html#PowerHeuristic" class="code">PowerHeuristic</a>(1, p_b, 1, p_l);</div></div>
        L += beta * w_b * <a href="../Light_Sources/Light_Interface.html#Light::Le" class="code">Le</a>;
    }
}</div><p>


</p>
<p>Otherwise, it is necessary to compute the MIS weight <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.81ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 1210 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">w Subscript normal b</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D464" d="M691 372c0 -48 -32 -182 -66 -260c-26 -60 -70 -123 -145 -123c-30 0 -99 6 -125 70c-40 -70 -87 -70 -104 -70c-75 0 -142 35 -142 126c0 38 12 84 56 202c7 17 18 45 18 70c0 32 -16 33 -25 33c-35 0 -74 -31 -101 -124c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10 c0 9 37 154 132 154c49 0 82 -37 82 -82c0 -20 -6 -34 -17 -64c-47 -123 -52 -162 -52 -194c0 -17 0 -91 80 -91c39 0 69 31 92 84c-1 5 -1 7 -1 18c0 18 2 36 9 66c7 26 54 217 57 224c7 20 25 28 37 28c15 0 29 -9 29 -27c0 -6 -10 -43 -15 -65l-42 -168 c-4 -14 -11 -45 -11 -73c0 -57 27 -87 74 -87c49 0 84 35 110 88c26 51 55 149 55 183c0 48 -25 74 -36 85c-9 8 -15 14 -15 27c0 22 25 48 50 48c17 0 44 -15 44 -70Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-62" d="M521 216c0 -129 -104 -227 -223 -227c-74 0 -116 50 -131 73l-36 -62h-25v596c0 49 -8 56 -78 56v31l144 11v-317c16 18 59 65 137 65c114 0 212 -99 212 -226zM438 217c0 41 -3 98 -29 139c-24 38 -60 64 -105 64c-24 0 -79 -8 -118 -64c-11 -16 -11 -17 -11 -36v-206 c0 -18 0 -21 14 -42c24 -37 60 -61 105 -61c54 0 92 33 113 64c29 45 31 105 31 142Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D464" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-62" x="1013" y="-213"></use>
</g>
</svg>.
<tt>p_b</tt> gives us the BSDF&rsquo;s PDF from the previous
scattering event, so all we need is
the PDF for the ray&rsquo;s direction from sampling the light.  This value
is given by the product of the probability of sampling the light under
consideration times the probability the light returns for sampling the
direction.

</p>
<p>Note that the <tt>PDF_Li()</tt> method is passed a <tt>true</tt> value for
<tt>allowIncompletePDF</tt> here, again reflecting the fact that because BSDF
sampling is capable of sampling all valid directions, it is not required
that light sampling do so as well.

</p>
<p></p>
<span class="anchor" id="fragment-ComputeMISweightforinfinitelight-0"></span><div class="fragmentname">&lt;&lt;Compute MIS weight for infinite light&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">Float p_l = <a href="#PathIntegrator::lightSampler" class="code">lightSampler</a>.<a href="../Light_Sources/Light_Sampling.html#LightSampler::PMF" class="code">PMF</a>(prevIntrCtx, light) *
    light.<a href="../Light_Sources/Light_Interface.html#Light::PDF_Li" class="code">PDF_Li</a>(prevIntrCtx, ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a>, true);
Float w_b = <a href="../Monte_Carlo_Integration/Improving_Efficiency.html#PowerHeuristic" class="code">PowerHeuristic</a>(1, p_b, 1, p_l);</div><p>


</p>
<p>The code for the case of a ray hitting an emissive surface is in the
fragment &lt;&lt;<span class="fragmentname">Incorporate emission from surface hit by ray</span>&gt;&gt;.
It is almost the same as the infinite light case, so we will not include it
here.

</p>
<p>

</p>
<p>The final issue is Russian roulette&ndash;based path termination.  As outlined in
Section&nbsp;<a href="../Light_Transport_I_Surface_Reflection/Path_Tracing.html#sec:path-tracing-overview">13.2.1</a>, the task is easy: we compute a
termination probability <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.051ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 452.5 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">q</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45E" d="M452 431l-138 -556c-2 -9 -4 -15 -4 -22c0 -9 0 -16 48 -16c16 0 26 0 26 -11c0 -20 -13 -20 -18 -20c-33 0 -69 3 -103 3c-33 0 -68 -3 -100 -3c-13 0 -13 11 -13 11c0 20 10 20 23 20c56 1 64 5 72 33l45 179c-36 -36 -75 -60 -118 -60c-73 0 -132 62 -132 160 c0 145 123 293 241 293c32 0 71 -16 93 -70c17 29 57 69 68 69c7 0 10 -6 10 -10zM360 332c0 7 -14 88 -79 88c-41 0 -93 -42 -124 -116c-17 -42 -46 -151 -46 -199c0 -17 4 -94 64 -94c56 0 112 64 127 92c3 4 58 223 58 229Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45E" x="0" y="0"></use>
</g>
</svg> however we like, make a random choice as to
whether to terminate the path, and update <tt>beta</tt> if the path is not
terminated so that all subsequent <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.654ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 2434.3 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">upper P left-parenthesis normal p Subscript Baseline overbar Subscript i Baseline right-parenthesis</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D443" d="M754 532c0 -112 -139 -216 -281 -216h-170l-62 -250c-1 -6 -3 -11 -3 -17c0 -18 28 -18 65 -18c19 0 28 0 28 -11c0 -20 -13 -20 -20 -20c-21 0 -43 2 -65 2l-64 1l-127 -3c-3 0 -15 0 -15 12c0 19 11 19 28 19c79 0 81 8 91 47l134 537c3 12 4 15 4 19 c0 11 -6 14 -22 16c-12 1 -30 2 -43 2c-20 0 -29 0 -29 12c0 19 11 19 30 19h324c131 0 197 -74 197 -151zM661 556c0 69 -53 96 -136 96h-96c-43 0 -45 -3 -54 -38l-68 -272h141c44 0 104 8 154 53c39 36 59 122 59 161Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-AF" d="M431 589h-361v31h361v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D456" d="M284 625c0 -30 -30 -53 -53 -53c-24 0 -38 17 -38 36c0 27 27 53 54 53c23 0 37 -16 37 -36zM293 143c0 -9 -37 -154 -131 -154c-48 0 -82 35 -82 82c0 21 13 54 23 80c16 43 61 159 69 185c4 10 11 31 11 52c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124 c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 38 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -13 -53c-10 -27 -10 -29 -22 -58l-39 -105c-23 -61 -29 -75 -29 -100c0 -23 7 -33 24 -33c51 0 84 61 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D443" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="754" y="0"></use>
<g transform="translate(1144,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-AF" x="28" y="-38"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="787" y="-326"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="2044" y="0"></use>
</g>
</svg> terms will be scaled
appropriately.

</p>
<p>However, the details of how <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.051ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 452.5 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">q</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45E" d="M452 431l-138 -556c-2 -9 -4 -15 -4 -22c0 -9 0 -16 48 -16c16 0 26 0 26 -11c0 -20 -13 -20 -18 -20c-33 0 -69 3 -103 3c-33 0 -68 -3 -100 -3c-13 0 -13 11 -13 11c0 20 10 20 23 20c56 1 64 5 72 33l45 179c-36 -36 -75 -60 -118 -60c-73 0 -132 62 -132 160 c0 145 123 293 241 293c32 0 71 -16 93 -70c17 29 57 69 68 69c7 0 10 -6 10 -10zM360 332c0 7 -14 88 -79 88c-41 0 -93 -42 -124 -116c-17 -42 -46 -151 -46 -199c0 -17 4 -94 64 -94c56 0 112 64 127 92c3 4 58 223 58 229Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45E" x="0" y="0"></use>
</g>
</svg> is set can make a big
difference.<button style="button" data-toggle="tooltip" data-placement="right" data-html="true" class="btn footnote-button" title="By this we mean that this is a place where the current
version of <tt>pbrt</tt> does markedly better than previous ones.">
      <sup>&dagger;</sup>
    </button>
		  In general, it
is a good idea for the termination probability to be based on the path
throughput weight; in this way, if the BSDF&rsquo;s value is small, it is more
likely that the path will be terminated.  Further, if the path is not
terminated, then the scaling factor will generally cause <tt>beta</tt> to have
a value around&nbsp;1.  Thus, all rays that are traced tend to make the
same contribution to the image, which improves efficiency.

</p>
<p>Another issue is that it is best if the <tt>beta</tt> value used to compute
<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.051ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 452.5 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">q</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45E" d="M452 431l-138 -556c-2 -9 -4 -15 -4 -22c0 -9 0 -16 48 -16c16 0 26 0 26 -11c0 -20 -13 -20 -18 -20c-33 0 -69 3 -103 3c-33 0 -68 -3 -100 -3c-13 0 -13 11 -13 11c0 20 10 20 23 20c56 1 64 5 72 33l45 179c-36 -36 -75 -60 -118 -60c-73 0 -132 62 -132 160 c0 145 123 293 241 293c32 0 71 -16 93 -70c17 29 57 69 68 69c7 0 10 -6 10 -10zM360 332c0 7 -14 88 -79 88c-41 0 -93 -42 -124 -116c-17 -42 -46 -151 -46 -199c0 -17 4 -94 64 -94c56 0 112 64 127 92c3 4 58 223 58 229Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45E" x="0" y="0"></use>
</g>
</svg> does not include radiance scaling due to refraction.  Consider a ray
that passes through a glass object with a relative index of refraction
of&nbsp;1.5: when it enters the object, <tt>beta</tt> will pick up a factor
of <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="13.572ex" height="3.176ex" style="vertical-align: -0.838ex;" viewBox="0 -1006.6 5843.5 1367.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">1 slash 1.5 squared almost-equals 0.44</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2F" d="M445 730c0 -2 0 -5 -1 -7l-349 -960c-3 -8 -10 -13 -19 -13c-11 0 -20 9 -20 20c0 2 0 5 1 7l349 960c3 8 10 13 19 13c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2E" d="M192 53c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-35" d="M449 201c0 -127 -102 -223 -218 -223c-112 0 -181 97 -181 183c0 46 35 53 49 53c33 0 50 -25 50 -49s-17 -49 -50 -49c-11 0 -14 1 -17 2c17 -59 74 -112 147 -112c46 0 83 26 107 65c24 42 24 102 24 137c0 50 -2 89 -18 126c-8 18 -33 64 -85 64 c-81 0 -118 -54 -129 -70c-4 -6 -6 -9 -13 -9c-14 0 -14 8 -14 26v296c0 16 0 24 10 24c0 0 4 0 12 -3c47 -21 93 -28 133 -28c67 0 116 20 136 29c5 3 8 3 8 3c7 0 10 -5 10 -11c0 -13 -70 -104 -193 -104c-32 0 -65 7 -85 13v-195c36 35 79 51 127 51 c108 0 190 -100 190 -219Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-32" d="M449 174l-28 -174h-371c0 24 0 26 11 37l192 214c55 62 105 141 105 221c0 82 -43 163 -134 163c-58 0 -112 -37 -135 -102c3 1 5 1 13 1c35 0 53 -26 53 -52c0 -41 -35 -53 -52 -53c-3 0 -53 0 -53 56c0 89 74 181 187 181c122 0 212 -80 212 -194 c0 -100 -60 -154 -216 -292l-106 -103h180c22 0 88 0 95 8c10 15 17 59 22 89h25Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2248" d="M717 438v-2c-20 -93 -56 -149 -139 -169c-11 -3 -23 -4 -35 -4c-62 0 -120 37 -172 76c-43 32 -89 67 -138 67c-9 0 -17 -1 -26 -3c-67 -17 -111 -49 -127 -124c-1 -5 -6 -9 -12 -9c-7 0 -12 5 -12 12v2c20 93 56 149 139 169c12 3 24 4 35 4c62 0 120 -37 172 -76 c43 -32 89 -67 139 -67c8 0 16 1 25 3c67 17 111 49 127 124c2 5 6 9 12 9c7 0 12 -5 12 -12zM717 218v-2c-20 -93 -56 -149 -139 -169c-11 -3 -23 -4 -35 -4c-62 0 -120 37 -172 76c-43 32 -89 67 -138 67c-9 0 -17 -1 -26 -3c-67 -17 -111 -49 -127 -124 c-1 -5 -6 -9 -12 -9c-7 0 -12 5 -12 12v2c20 93 56 149 139 169c12 3 24 4 35 4c62 0 120 -37 172 -76c43 -32 89 -67 139 -67c8 0 16 1 25 3c67 17 111 49 127 124c2 5 6 9 12 9c7 0 12 -5 12 -12Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-30" d="M460 320c0 -79 -5 -157 -37 -226c-44 -95 -120 -116 -174 -116c-49 0 -122 20 -165 101c-41 76 -45 166 -45 241c0 80 5 158 37 227c41 93 114 119 174 119c42 0 124 -16 170 -112c35 -74 40 -154 40 -234zM377 332c0 63 0 139 -10 195c-19 99 -85 117 -118 117 c-25 0 -100 -9 -119 -128c-8 -54 -8 -120 -8 -184c0 -59 0 -151 11 -211c18 -96 77 -121 116 -121c45 0 102 30 117 125c11 64 11 132 11 207Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-34" d="M471 165h-100v-87c0 -36 2 -47 76 -47h21v-31c-41 3 -94 3 -136 3s-94 0 -135 -3v31h21c74 0 76 11 76 47v87h-266v31l307 469c8 12 11 12 20 12c16 0 16 -6 16 -26v-455h100v-31zM300 196v373l-244 -373h244Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-31" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2F" x="500" y="0"></use>
<g transform="translate(1001,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-31"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2E" x="500" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-35" x="779" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-32" x="1809" y="557"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2248" x="3012" y="0"></use>
<g transform="translate(4063,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-30"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2E" x="500" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-34" x="779" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-34" x="1279" y="0"></use>
</g>
</g>
</svg>, but when it exits, that factor will cancel
and <tt>beta</tt> will be back to&nbsp;1.  For ray paths that would exit, to have
terminated them after the first refraction would be the wrong decision.
Therefore, <tt>etaScale</tt> tracks those factors in <tt>beta</tt> so that they
can be removed.
The image in Figure&nbsp;<a href="#fig:rr-with-eta-scale">13.11</a> shows the increase in noise if this
effect is not corrected for.

</p>
<p></p>
<span class="anchor" id="fig:rr-with-eta-scale"></span><div class="card outerfigure"><div class="card-body figure"><p>


</p>
<div class="figure-row">
  <a href="pha13f11.svg" title=""><img src="pha13f11.svg" width=763 height=658 style="max-width: 100%;"></a>
</div>
<p>

</p>
<figcaption class="caption">Figure 13.11: The Effect of Including Radiance Scaling Due to Transmission in
the Russian Roulette Probability <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.051ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 452.5 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">q</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45E" d="M452 431l-138 -556c-2 -9 -4 -15 -4 -22c0 -9 0 -16 48 -16c16 0 26 0 26 -11c0 -20 -13 -20 -18 -20c-33 0 -69 3 -103 3c-33 0 -68 -3 -100 -3c-13 0 -13 11 -13 11c0 20 10 20 23 20c56 1 64 5 72 33l45 179c-36 -36 -75 -60 -118 -60c-73 0 -132 62 -132 160 c0 145 123 293 241 293c32 0 71 -16 93 -70c17 29 57 69 68 69c7 0 10 -6 10 -10zM360 332c0 7 -14 88 -79 88c-41 0 -93 -42 -124 -116c-17 -42 -46 -151 -46 -199c0 -17 4 -94 64 -94c56 0 112 64 127 92c3 4 58 223 58 229Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45E" x="0" y="0"></use>
</g>
</svg>. <span class="legend">
(a)&nbsp;If <tt>etaScale</tt> is not included in the probability, then some rays
that would have passed through the glass object are terminated
unnecessarily, leading to noise in the corresponding parts of
the image.
(b)&nbsp;Including <tt>etaScale</tt> in the computation of <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.051ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 452.5 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">q</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45E" d="M452 431l-138 -556c-2 -9 -4 -15 -4 -22c0 -9 0 -16 48 -16c16 0 26 0 26 -11c0 -20 -13 -20 -18 -20c-33 0 -69 3 -103 3c-33 0 -68 -3 -100 -3c-13 0 -13 11 -13 11c0 20 10 20 23 20c56 1 64 5 72 33l45 179c-36 -36 -75 -60 -118 -60c-73 0 -132 62 -132 160 c0 145 123 293 241 293c32 0 71 -16 93 -70c17 29 57 69 68 69c7 0 10 -6 10 -10zM360 332c0 7 -14 88 -79 88c-41 0 -93 -42 -124 -116c-17 -42 -46 -151 -46 -199c0 -17 4 -94 64 -94c56 0 112 64 127 92c3 4 58 223 58 229Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45E" x="0" y="0"></use>
</g>
</svg> fixes this issue.
<em>(Transparent Machines scene courtesy of Beeple.)</em>
</span>
</figcaption><p>


</p>
</div></div><p>


</p>
<p>Finally, note that the termination probability is set according to the
maximum component value of <tt>rrBeta</tt> rather than, for example, its
average. Doing so gives better results when surface reflectances are highly
saturated and some of the wavelength samples have much lower <tt>beta</tt>
values than others, since it prevents any of the <tt>beta</tt> components
from going above&nbsp;1 due to Russian roulette.

</p>
<p></p>
<span class="anchor" id="fragment-PossiblyterminatethepathwithRussianroulette-0"></span><div class="fragmentname">&lt;&lt;Possibly terminate the path with Russian roulette&gt;&gt;=&nbsp;</div>
<div class="fragmentcode"><a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> rrBeta = beta * etaScale;
if (rrBeta.<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum::MaxComponentValue" class="code">MaxComponentValue</a>() &lt; 1 &amp;&amp; depth &gt; 1) {
    Float q = std::max&lt;Float&gt;(0, 1 - rrBeta.<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum::MaxComponentValue" class="code">MaxComponentValue</a>());
    if (sampler.<a href="../Sampling_and_Reconstruction/Sampling_Interface.html#Sampler::Get1D" class="code">Get1D</a>() &lt; q)
        break;
    beta /= 1 - q;
}</div><p>


</p>
<p>Recall that Russian roulette only increases variance.  Because it
terminates some paths, this must be so, as the final image includes less
information when it is applied.  However, it can improve efficiency by
allowing the renderer to focus its efforts on tracing rays that make the
greatest contribution to the final image.  Table&nbsp;<a href="#tab:rr-mc-efficiency">13.1</a>
presents measurements of efficiency improvements from Russian roulette for
a number of scenes.

</p>
<p></p>
<span class="anchor" id="tab:rr-mc-efficiency"></span><div class="card outerfigure"><div class="card-body figure"><p>

</p>
<figcaption class="caption">Table 13.1: Monte Carlo Efficiency Benefits from Russian Roulette. <span class="legend">
Measurements of MSE and rendering time when using Russian roulette.
All values reported are relative to rendering the same scene without
Russian roulette.  As expected, MSE increases to varying degrees due to ray termination, but
the performance benefit more than makes up for it, leading to an increase
in Monte Carlo efficiency.
</span>
</figcaption><p>


<table class="table table-hover table-light table-sm"><thead><tr>
<th>Scene</th><th> MSE</th><th>Time</th><th>Efficiency</th></tr>
</thead>
<tbody>
<tr>
<td><em>Kroken</em> (Figure&nbsp;<a href="../Light_Transport_I_Surface_Reflection/Path_Tracing.html#fig:path-tracing-example">13.4</a>)</td><td> <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.134ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 1780 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">1.31</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2E" d="M192 53c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-33" d="M457 171c0 -102 -91 -193 -213 -193c-109 0 -202 66 -202 157c0 44 32 58 56 58c29 0 56 -20 56 -56c0 -38 -31 -60 -66 -55c35 -59 110 -76 153 -76c44 0 113 29 113 165c0 98 -37 166 -119 166h-44c-17 0 -24 0 -24 11c0 10 7 11 15 12c7 0 31 2 39 3c25 1 59 4 89 52 c26 44 28 102 28 114c0 90 -55 112 -96 112c-36 0 -102 -13 -133 -62c15 0 62 0 62 -50c0 -29 -20 -51 -51 -51c-29 0 -51 19 -51 52c0 76 76 136 177 136c96 0 184 -56 184 -138c0 -79 -58 -149 -140 -176c104 -21 167 -99 167 -181Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-31"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2E" x="500" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-33" x="779" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-31" x="1279" y="0"></use>
</g>
</svg> </td><td> <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.297ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 2280.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">0.261</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-30" d="M460 320c0 -79 -5 -157 -37 -226c-44 -95 -120 -116 -174 -116c-49 0 -122 20 -165 101c-41 76 -45 166 -45 241c0 80 5 158 37 227c41 93 114 119 174 119c42 0 124 -16 170 -112c35 -74 40 -154 40 -234zM377 332c0 63 0 139 -10 195c-19 99 -85 117 -118 117 c-25 0 -100 -9 -119 -128c-8 -54 -8 -120 -8 -184c0 -59 0 -151 11 -211c18 -96 77 -121 116 -121c45 0 102 30 117 125c11 64 11 132 11 207Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2E" d="M192 53c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-32" d="M449 174l-28 -174h-371c0 24 0 26 11 37l192 214c55 62 105 141 105 221c0 82 -43 163 -134 163c-58 0 -112 -37 -135 -102c3 1 5 1 13 1c35 0 53 -26 53 -52c0 -41 -35 -53 -52 -53c-3 0 -53 0 -53 56c0 89 74 181 187 181c122 0 212 -80 212 -194 c0 -100 -60 -154 -216 -292l-106 -103h180c22 0 88 0 95 8c10 15 17 59 22 89h25Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-36" d="M457 204c0 -132 -95 -226 -206 -226c-93 0 -209 71 -209 338c0 221 135 350 263 350c83 0 127 -48 127 -108c0 -39 -30 -48 -46 -48c-22 0 -46 15 -46 46c0 45 40 45 55 45c-22 34 -64 40 -88 40c-51 0 -175 -36 -175 -289v-24c20 48 57 99 125 99 c111 0 200 -96 200 -223zM367 205c0 49 0 100 -18 137c-31 62 -77 62 -93 62c-90 0 -122 -100 -122 -178c0 -18 0 -98 18 -145c6 -15 36 -75 99 -75c23 0 69 5 99 65c17 36 17 86 17 134Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-30"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2E" x="500" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-32" x="779" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-36" x="1279" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-31" x="1780" y="0"></use>
</g>
</svg> </td><td> <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.134ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 1780 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">2.92</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-32" d="M449 174l-28 -174h-371c0 24 0 26 11 37l192 214c55 62 105 141 105 221c0 82 -43 163 -134 163c-58 0 -112 -37 -135 -102c3 1 5 1 13 1c35 0 53 -26 53 -52c0 -41 -35 -53 -52 -53c-3 0 -53 0 -53 56c0 89 74 181 187 181c122 0 212 -80 212 -194 c0 -100 -60 -154 -216 -292l-106 -103h180c22 0 88 0 95 8c10 15 17 59 22 89h25Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2E" d="M192 53c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-39" d="M457 329c0 -215 -122 -351 -251 -351c-85 0 -139 41 -139 108c0 39 30 48 46 48c22 0 46 -15 46 -46c0 -17 -8 -46 -52 -46c27 -34 81 -36 98 -36c58 0 162 46 162 280v32c-23 -58 -64 -100 -125 -100c-112 0 -200 98 -200 223c0 75 23 117 64 162c43 45 92 63 147 63 c89 0 204 -68 204 -337zM365 421c0 46 -4 109 -16 141c-17 45 -50 79 -96 79c-35 0 -73 -13 -100 -63c-21 -37 -21 -84 -21 -138c0 -49 0 -99 18 -136c31 -63 77 -63 93 -63c88 0 122 97 122 180Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-32"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2E" x="500" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-39" x="779" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-32" x="1279" y="0"></use>
</g>
</svg> </td></tr>
<tr>
<td><em>Watercolor</em> (Figure&nbsp;<a href="../Light_Transport_I_Surface_Reflection/A_Simple_Path_Tracer.html#fig:randomwalk-vs-simplepath-integrators">13.6</a>)</td><td> <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.134ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 1780 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">1.19</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2E" d="M192 53c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-39" d="M457 329c0 -215 -122 -351 -251 -351c-85 0 -139 41 -139 108c0 39 30 48 46 48c22 0 46 -15 46 -46c0 -17 -8 -46 -52 -46c27 -34 81 -36 98 -36c58 0 162 46 162 280v32c-23 -58 -64 -100 -125 -100c-112 0 -200 98 -200 223c0 75 23 117 64 162c43 45 92 63 147 63 c89 0 204 -68 204 -337zM365 421c0 46 -4 109 -16 141c-17 45 -50 79 -96 79c-35 0 -73 -13 -100 -63c-21 -37 -21 -84 -21 -138c0 -49 0 -99 18 -136c31 -63 77 -63 93 -63c88 0 122 97 122 180Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-31"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2E" x="500" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-31" x="779" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-39" x="1279" y="0"></use>
</g>
</svg> </td><td> <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.297ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 2280.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">0.187</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-30" d="M460 320c0 -79 -5 -157 -37 -226c-44 -95 -120 -116 -174 -116c-49 0 -122 20 -165 101c-41 76 -45 166 -45 241c0 80 5 158 37 227c41 93 114 119 174 119c42 0 124 -16 170 -112c35 -74 40 -154 40 -234zM377 332c0 63 0 139 -10 195c-19 99 -85 117 -118 117 c-25 0 -100 -9 -119 -128c-8 -54 -8 -120 -8 -184c0 -59 0 -151 11 -211c18 -96 77 -121 116 -121c45 0 102 30 117 125c11 64 11 132 11 207Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2E" d="M192 53c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-38" d="M457 168c0 -107 -95 -190 -208 -190c-105 0 -207 67 -207 173c0 99 86 155 144 184c-25 17 -62 42 -73 54c-42 47 -44 92 -44 110c0 93 81 167 181 167c91 0 180 -57 180 -149c0 -66 -49 -118 -121 -155c64 -40 80 -50 99 -71c38 -42 49 -87 49 -123zM386 517 c0 72 -64 124 -137 124c-71 0 -136 -42 -136 -103c0 -17 4 -51 50 -81l124 -80c60 35 99 83 99 140zM407 132c0 61 -47 91 -75 110l-123 78c-85 -47 -117 -111 -117 -169c0 -83 72 -145 158 -145c82 0 157 52 157 126Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-37" d="M485 644c0 -21 0 -23 -9 -35l-135 -190c-44 -62 -58 -148 -62 -171c-8 -54 -11 -109 -11 -164v-51c0 -10 0 -55 -46 -55s-46 45 -46 55c0 102 33 241 123 376l112 158h-207c-13 0 -91 0 -98 -6c-13 -12 -22 -75 -25 -91h-25l33 206h25c4 -19 6 -32 128 -32h243Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-30"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2E" x="500" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-31" x="779" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-38" x="1279" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-37" x="1780" y="0"></use>
</g>
</svg> </td><td> <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.134ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 1780 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">4.51</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-34" d="M471 165h-100v-87c0 -36 2 -47 76 -47h21v-31c-41 3 -94 3 -136 3s-94 0 -135 -3v31h21c74 0 76 11 76 47v87h-266v31l307 469c8 12 11 12 20 12c16 0 16 -6 16 -26v-455h100v-31zM300 196v373l-244 -373h244Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2E" d="M192 53c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-35" d="M449 201c0 -127 -102 -223 -218 -223c-112 0 -181 97 -181 183c0 46 35 53 49 53c33 0 50 -25 50 -49s-17 -49 -50 -49c-11 0 -14 1 -17 2c17 -59 74 -112 147 -112c46 0 83 26 107 65c24 42 24 102 24 137c0 50 -2 89 -18 126c-8 18 -33 64 -85 64 c-81 0 -118 -54 -129 -70c-4 -6 -6 -9 -13 -9c-14 0 -14 8 -14 26v296c0 16 0 24 10 24c0 0 4 0 12 -3c47 -21 93 -28 133 -28c67 0 116 20 136 29c5 3 8 3 8 3c7 0 10 -5 10 -11c0 -13 -70 -104 -193 -104c-32 0 -65 7 -85 13v-195c36 35 79 51 127 51 c108 0 190 -100 190 -219Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-34"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2E" x="500" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-35" x="779" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-31" x="1279" y="0"></use>
</g>
</svg> </td></tr>
<tr>
<td><em>San Miguel</em> (Figure&nbsp;<a href="#fig:simplepath-vs-path-integrators">13.7</a>)</td><td> <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.134ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 1780 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">1.00</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2E" d="M192 53c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-30" d="M460 320c0 -79 -5 -157 -37 -226c-44 -95 -120 -116 -174 -116c-49 0 -122 20 -165 101c-41 76 -45 166 -45 241c0 80 5 158 37 227c41 93 114 119 174 119c42 0 124 -16 170 -112c35 -74 40 -154 40 -234zM377 332c0 63 0 139 -10 195c-19 99 -85 117 -118 117 c-25 0 -100 -9 -119 -128c-8 -54 -8 -120 -8 -184c0 -59 0 -151 11 -211c18 -96 77 -121 116 -121c45 0 102 30 117 125c11 64 11 132 11 207Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-31"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2E" x="500" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-30" x="779" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-30" x="1279" y="0"></use>
</g>
</svg> </td><td> <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.297ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 2280.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">0.239</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-30" d="M460 320c0 -79 -5 -157 -37 -226c-44 -95 -120 -116 -174 -116c-49 0 -122 20 -165 101c-41 76 -45 166 -45 241c0 80 5 158 37 227c41 93 114 119 174 119c42 0 124 -16 170 -112c35 -74 40 -154 40 -234zM377 332c0 63 0 139 -10 195c-19 99 -85 117 -118 117 c-25 0 -100 -9 -119 -128c-8 -54 -8 -120 -8 -184c0 -59 0 -151 11 -211c18 -96 77 -121 116 -121c45 0 102 30 117 125c11 64 11 132 11 207Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2E" d="M192 53c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-32" d="M449 174l-28 -174h-371c0 24 0 26 11 37l192 214c55 62 105 141 105 221c0 82 -43 163 -134 163c-58 0 -112 -37 -135 -102c3 1 5 1 13 1c35 0 53 -26 53 -52c0 -41 -35 -53 -52 -53c-3 0 -53 0 -53 56c0 89 74 181 187 181c122 0 212 -80 212 -194 c0 -100 -60 -154 -216 -292l-106 -103h180c22 0 88 0 95 8c10 15 17 59 22 89h25Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-33" d="M457 171c0 -102 -91 -193 -213 -193c-109 0 -202 66 -202 157c0 44 32 58 56 58c29 0 56 -20 56 -56c0 -38 -31 -60 -66 -55c35 -59 110 -76 153 -76c44 0 113 29 113 165c0 98 -37 166 -119 166h-44c-17 0 -24 0 -24 11c0 10 7 11 15 12c7 0 31 2 39 3c25 1 59 4 89 52 c26 44 28 102 28 114c0 90 -55 112 -96 112c-36 0 -102 -13 -133 -62c15 0 62 0 62 -50c0 -29 -20 -51 -51 -51c-29 0 -51 19 -51 52c0 76 76 136 177 136c96 0 184 -56 184 -138c0 -79 -58 -149 -140 -176c104 -21 167 -99 167 -181Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-39" d="M457 329c0 -215 -122 -351 -251 -351c-85 0 -139 41 -139 108c0 39 30 48 46 48c22 0 46 -15 46 -46c0 -17 -8 -46 -52 -46c27 -34 81 -36 98 -36c58 0 162 46 162 280v32c-23 -58 -64 -100 -125 -100c-112 0 -200 98 -200 223c0 75 23 117 64 162c43 45 92 63 147 63 c89 0 204 -68 204 -337zM365 421c0 46 -4 109 -16 141c-17 45 -50 79 -96 79c-35 0 -73 -13 -100 -63c-21 -37 -21 -84 -21 -138c0 -49 0 -99 18 -136c31 -63 77 -63 93 -63c88 0 122 97 122 180Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-30"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2E" x="500" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-32" x="779" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-33" x="1279" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-39" x="1780" y="0"></use>
</g>
</svg> </td><td> <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.134ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 1780 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">4.17</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-34" d="M471 165h-100v-87c0 -36 2 -47 76 -47h21v-31c-41 3 -94 3 -136 3s-94 0 -135 -3v31h21c74 0 76 11 76 47v87h-266v31l307 469c8 12 11 12 20 12c16 0 16 -6 16 -26v-455h100v-31zM300 196v373l-244 -373h244Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2E" d="M192 53c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-37" d="M485 644c0 -21 0 -23 -9 -35l-135 -190c-44 -62 -58 -148 -62 -171c-8 -54 -11 -109 -11 -164v-51c0 -10 0 -55 -46 -55s-46 45 -46 55c0 102 33 241 123 376l112 158h-207c-13 0 -91 0 -98 -6c-13 -12 -22 -75 -25 -91h-25l33 206h25c4 -19 6 -32 128 -32h243Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-34"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2E" x="500" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-31" x="779" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-37" x="1279" y="0"></use>
</g>
</svg> </td></tr>
<tr>
<td>BMW M6 (Figure&nbsp;<a href="#fig:tricky-indirect-lighting">13.12</a>)</td><td> <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.134ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 1780 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">1.00</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2E" d="M192 53c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-30" d="M460 320c0 -79 -5 -157 -37 -226c-44 -95 -120 -116 -174 -116c-49 0 -122 20 -165 101c-41 76 -45 166 -45 241c0 80 5 158 37 227c41 93 114 119 174 119c42 0 124 -16 170 -112c35 -74 40 -154 40 -234zM377 332c0 63 0 139 -10 195c-19 99 -85 117 -118 117 c-25 0 -100 -9 -119 -128c-8 -54 -8 -120 -8 -184c0 -59 0 -151 11 -211c18 -96 77 -121 116 -121c45 0 102 30 117 125c11 64 11 132 11 207Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-31"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2E" x="500" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-30" x="779" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-30" x="1279" y="0"></use>
</g>
</svg> </td><td> <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.297ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 2280.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">0.801</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-30" d="M460 320c0 -79 -5 -157 -37 -226c-44 -95 -120 -116 -174 -116c-49 0 -122 20 -165 101c-41 76 -45 166 -45 241c0 80 5 158 37 227c41 93 114 119 174 119c42 0 124 -16 170 -112c35 -74 40 -154 40 -234zM377 332c0 63 0 139 -10 195c-19 99 -85 117 -118 117 c-25 0 -100 -9 -119 -128c-8 -54 -8 -120 -8 -184c0 -59 0 -151 11 -211c18 -96 77 -121 116 -121c45 0 102 30 117 125c11 64 11 132 11 207Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2E" d="M192 53c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-38" d="M457 168c0 -107 -95 -190 -208 -190c-105 0 -207 67 -207 173c0 99 86 155 144 184c-25 17 -62 42 -73 54c-42 47 -44 92 -44 110c0 93 81 167 181 167c91 0 180 -57 180 -149c0 -66 -49 -118 -121 -155c64 -40 80 -50 99 -71c38 -42 49 -87 49 -123zM386 517 c0 72 -64 124 -137 124c-71 0 -136 -42 -136 -103c0 -17 4 -51 50 -81l124 -80c60 35 99 83 99 140zM407 132c0 61 -47 91 -75 110l-123 78c-85 -47 -117 -111 -117 -169c0 -83 72 -145 158 -145c82 0 157 52 157 126Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-30"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2E" x="500" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-38" x="779" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-30" x="1279" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-31" x="1780" y="0"></use>
</g>
</svg> </td><td> <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.134ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 1780 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">1.25</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2E" d="M192 53c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-32" d="M449 174l-28 -174h-371c0 24 0 26 11 37l192 214c55 62 105 141 105 221c0 82 -43 163 -134 163c-58 0 -112 -37 -135 -102c3 1 5 1 13 1c35 0 53 -26 53 -52c0 -41 -35 -53 -52 -53c-3 0 -53 0 -53 56c0 89 74 181 187 181c122 0 212 -80 212 -194 c0 -100 -60 -154 -216 -292l-106 -103h180c22 0 88 0 95 8c10 15 17 59 22 89h25Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-35" d="M449 201c0 -127 -102 -223 -218 -223c-112 0 -181 97 -181 183c0 46 35 53 49 53c33 0 50 -25 50 -49s-17 -49 -50 -49c-11 0 -14 1 -17 2c17 -59 74 -112 147 -112c46 0 83 26 107 65c24 42 24 102 24 137c0 50 -2 89 -18 126c-8 18 -33 64 -85 64 c-81 0 -118 -54 -129 -70c-4 -6 -6 -9 -13 -9c-14 0 -14 8 -14 26v296c0 16 0 24 10 24c0 0 4 0 12 -3c47 -21 93 -28 133 -28c67 0 116 20 136 29c5 3 8 3 8 3c7 0 10 -5 10 -11c0 -13 -70 -104 -193 -104c-32 0 -65 7 -85 13v-195c36 35 79 51 127 51 c108 0 190 -100 190 -219Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-31"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2E" x="500" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-32" x="779" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-35" x="1279" y="0"></use>
</g>
</svg> </td></tr>
</tbody></table>

</p>
</div></div><p>


</p>
<p>

</p>
<p></p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">
<a href="#PathRegularization"><i class="fas fa-link h3h4marginlink"></i></a>
</div>
<div class="col-md-10 col-lg-8">
<span class="anchor" id="sec:path-regularization"></span><span id="PathRegularization"></span><h3>13.4.1  Path Regularization</h3><p>



</p>
<p>Scenes with concentrated indirect lighting can pose a challenge to the
path-tracing algorithm: the problem is that if the incident indirect radiance at
a point has substantial variation but BSDF sampling is being used to
generate the direction of indirect rays, then the sampling distribution may
be a poor match for the integrand.  Variance spikes then occur when the
ratio <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="9.893ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 4259.5 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">f left-parenthesis x right-parenthesis slash p left-parenthesis x right-parenthesis</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D453" d="M552 636c0 -38 -29 -60 -55 -60c-19 0 -37 12 -37 35c0 15 10 50 54 54c-19 18 -45 18 -49 18c-21 0 -38 -15 -47 -34c-6 -12 -20 -83 -24 -104c-11 -58 -10 -56 -21 -114h83c17 0 27 0 27 -11c0 -20 -10 -20 -30 -20h-86l-60 -317c-1 -7 -24 -128 -56 -191 c-18 -38 -58 -97 -113 -97c-41 0 -85 24 -85 69c0 38 29 60 55 60c19 0 37 -12 37 -35c0 -15 -9 -51 -55 -54c19 -18 44 -18 48 -18c52 0 69 91 87 188l75 395h-66c-19 0 -28 0 -28 12c0 19 11 19 30 19h69c24 126 27 136 33 157c30 99 93 117 127 117c41 0 87 -23 87 -69Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D465" d="M527 376c0 -40 -32 -58 -54 -58c-27 0 -38 19 -38 35c0 24 20 49 48 54c-21 13 -45 13 -50 13c-70 0 -93 -92 -99 -118l-34 -137c-11 -44 -17 -66 -17 -88c0 -34 16 -66 55 -66c32 0 100 24 133 131c2 7 4 11 13 11c3 0 12 0 12 -10c0 -25 -57 -154 -160 -154 c-60 0 -96 39 -108 76c-3 -6 -39 -76 -105 -76c-44 0 -94 20 -94 66c0 32 25 58 55 58c15 0 37 -8 37 -35c0 -28 -22 -49 -47 -54c21 -13 44 -13 50 -13c44 0 79 42 95 104c37 140 54 207 54 238c0 58 -35 67 -54 67c-34 0 -100 -25 -134 -131c-2 -9 -5 -11 -13 -11 c0 0 -12 0 -12 10c0 25 57 154 161 154c29 0 83 -10 108 -76c12 23 47 76 105 76c34 0 93 -14 93 -66Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2F" d="M445 730c0 -2 0 -5 -1 -7l-349 -960c-3 -8 -10 -13 -19 -13c-11 0 -20 9 -20 20c0 2 0 5 1 7l349 960c3 8 10 13 19 13c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45D" d="M490 282c0 -147 -125 -293 -241 -293c-51 0 -79 35 -92 64c-7 -25 -49 -188 -49 -200c0 -9 0 -16 50 -16c14 0 24 0 24 -11c0 -20 -13 -20 -18 -20c-32 0 -66 3 -99 3c-28 0 -57 -3 -84 -3c-8 0 -13 4 -13 12c0 19 11 19 23 19c44 0 46 7 54 41l112 445c4 17 7 28 7 51 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c37 0 80 -21 90 -75c33 39 81 75 131 75c76 0 133 -66 133 -160zM418 326c0 59 -24 94 -64 94c-17 0 -46 -7 -81 -38c-18 -15 -45 -43 -52 -70 l-49 -196c-3 -12 -3 -16 -3 -16c0 -6 13 -89 79 -89c37 0 85 33 119 103c18 38 51 153 51 212Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D453" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="552" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D465" x="942" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="1514" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2F" x="1904" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="2404" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="2908" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D465" x="3297" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="3870" y="0"></use>
</g>
</svg> in the Monte Carlo estimator is large.

</p>
<p></p>
<span class="anchor" id="fig:tricky-indirect-lighting"></span><div class="card outerfigure"><div class="card-body figure"><p>


</p>
<div class="figure-row">
<img src="bmw-m6-no-regularize.png" style="max-width: 100%; height: auto;" width=700 height=500>
</div>
<p>

</p>
<figcaption class="caption">Figure 13.12: Image with High Variance Due to Difficult-to-Sample
Indirect Lighting. <span class="legend">
The environment map illuminating the scene includes the sun, which is not
only bright but also subtends a small solid angle.  When an indirect lighting sample
hits a specular surface and reflects to the sun&rsquo;s direction, variance
spikes in the image result because its contribution is not sampled well.
<em>(Car model courtesy of tyrant monkey, via Blend Swap.)</em>
</span>
</figcaption><p>


</p>
</div></div><p>


</p>
<p>Figure&nbsp;<a href="#fig:tricky-indirect-lighting">13.12</a> shows an example of this issue.
The car is illuminated by
a sky environment map where a bright sun occupies a small number of
pixels.  Consider sampling indirect lighting at a point on the ground
near one of the wheels: the ground material is fairly diffuse, so any
direction will be sampled with equal (cosine-weighted) probability.
Rarely, a direction will be sampled that both hits the highly specular wheel and
then also reflects to a direction where the sun is visible.  This is the cause
of the bright pixels on the ground.  (The lighting in the car interior is
similarly difficult to sample, since the glass prevents light source
sampling; the variance spikes there follow.)

</p>
<p></p>
<span class="anchor" id="fig:roughened-bsdfs"></span><div class="card outerfigure"><div class="card-body figure"><p>


</p>

<div class="card-img-top" style="display:block; width: 100%; padding-top: 73.143%;  position:relative;">
<div id="xa_Increasing_roughness_everywhere58" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0;"></div></div>
<script>
Jeri.renderViewer(document.getElementById('xa_Increasing_roughness_everywhere58'), {
  title: '(a)_Increasing_roughness_everywhere58', children: [
 { title: '(a) Increasing roughness everywhere', image: 'bmw-m6-regularize-all.png' },  { title: '(b) Increasing roughness after scattering', image: 'bmw-m6-regularize.png' }]});
</script>
<button data-toggle="tooltip" data-placement="left" class="btn yojeri" title="This image is interactive. Click and drag to pan and use the mouse-wheel to zoom. After clicking on the image to select it, type '?' to see a summary of keyboard controls."><i class="fa fa-snowflake fa-border"></i></button><p>

</p>
<figcaption class="caption">Figure 13.13: Scene from Figure&nbsp;<a href="#fig:tricky-indirect-lighting">13.12</a> with
Roughened BSDFs. <span class="legend">
(a)&nbsp;Increasing the roughness of all the BSDFs eliminates the variance spikes by
allowing the use of MIS at all indirect ray intersection points, though this
substantially changes the appearance of the scene.  (Note that the car
paint is duller and the window glass and headlight covers have the
appearance of frosted glass.)
(b)&nbsp;Roughening BSDFs only after the first non-specular scattering event
along the path preserves visual detail while reducing the error from
difficult light paths.
<em>(Car model courtesy of tyrant monkey, via Blend Swap.)</em>
</span>
</figcaption><p>


</p>
</div></div><p>


</p>
<p>Informally, the idea behind path regularization is to blur the function
being integrated in the case that it cannot be sampled effectively (or
cannot be sampled in the first place).  See Figure&nbsp;<a href="#fig:roughened-bsdfs">13.13</a>, which shows the
same scene, but with all the BSDFs made more rough: perfect specular
surfaces are glossy specular, and glossy specular surfaces are more diffuse.
Although the overall characteristics of the image are quite different, the
high variance on the ground has been eliminated: when an indirect lighting
ray hits one of the wheels, it is now possible to use a lower variance MIS-based direct
lighting calculation in place of following whichever direction is dictated
by the law of specular reflection.

</p>
<p>Blurring all the BSDFs in this way is an undesirable solution, but there
is no need to do so for the camera rays or for rays that have only
undergone perfect specular scattering: in those cases, we would like to
leave the scene as it was specified.  We can consider non-specular
scattering itself to be a sort of blurring of the incident light, such that
blurring the scene that is encountered after it occurs is less likely to be
objectionable&mdash;thus the motivation to track this case via the
<tt>anyNonSpecularBounces</tt> variable.

</p>
<p></p>
<span class="anchor" id="fragment-PossiblyregularizetheBSDF-0"></span><div class="fragmentname">&lt;&lt;Possibly regularize the BSDF&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">if (<a href="#PathIntegrator::regularize" class="code">regularize</a> &amp;&amp; anyNonSpecularBounces)
    bsdf.<a href="#BSDF::Regularize" class="code">Regularize</a>();
</div><p>


</p>
<p>The <tt>BSDF</tt> class provides a <tt>Regularize()</tt> method that forwards the request
on to its <tt>BxDF</tt>.

</p>
<p></p>
<span class="anchor" id="fragment-BSDFPublicMethods-7"></span><div class="fragmentname">&lt;&lt;BSDF Public Methods&gt;&gt;+=&nbsp;<a href="../Reflection_Models/BSDF_Representation.html#fragment-BSDFPublicMethods-6"><span class="fa fa-caret-up"></span></a></div>
<div class="fragmentcode">void <span class="anchor" id="BSDF::Regularize"></span><a href="#BxDF::Regularize" class="code">Regularize</a>() { <a href="../Reflection_Models/BSDF_Representation.html#BSDF::bxdf" class="code">bxdf</a>.<a href="#BxDF::Regularize" class="code">Regularize</a>(); }</div><p>


</p>
<p>The <tt>BxDF</tt> interface in turn requires the implementation of a
<tt>Regularize()</tt> method.  For <tt>BxDF</tt>s that are already fairly broad
(e.g., the <a href="../Reflection_Models/Diffuse_Reflection.html#DiffuseBxDF"><tt>DiffuseBxDF</tt></a>), the corresponding method implementation is
empty.

</p>
<p></p>
<span class="anchor" id="fragment-BxDFInterface-4"></span><div class="fragmentname">&lt;&lt;BxDF Interface&gt;&gt;+=&nbsp;<a href="../Reflection_Models/BSDF_Representation.html#fragment-BxDFInterface-3"><span class="fa fa-caret-up"></span></a></div>
<div class="fragmentcode">void <span class="anchor" id="BxDF::Regularize"></span>Regularize();</div><p>


</p>
<p>However, both the <a href="../Reflection_Models/Dielectric_BSDF.html#DielectricBxDF"><tt>DielectricBxDF</tt></a> and <a href="../Reflection_Models/Conductor_BRDF.html#ConductorBxDF"><tt>ConductorBxDF</tt></a> can
be nearly specular or perfect specular, depending on how smooth their microfacet
distribution is.  Therefore, their <tt>Regularize()</tt> method
implementations do adjust their scattering properties, through a call to
yet one more method named <tt>Regularize()</tt>, this one implemented by the
<a href="../Reflection_Models/Roughness_Using_Microfacet_Theory.html#TrowbridgeReitzDistribution"><tt>TrowbridgeReitzDistribution</tt></a>.

</p>
<p></p>
<span class="anchor" id="fragment-DielectricBxDFPublicMethods-2"></span><div class="fragmentname">&lt;&lt;DielectricBxDF Public Methods&gt;&gt;+=&nbsp;<a href="../Reflection_Models/Dielectric_BSDF.html#fragment-DielectricBxDFPublicMethods-1"><span class="fa fa-caret-up"></span></a></div>
<div class="fragmentcode">void <span class="anchor" id="DielectricBxDF::Regularize"></span><a href="#TrowbridgeReitzDistribution::Regularize" class="code">Regularize</a>() { <a href="../Reflection_Models/Dielectric_BSDF.html#DielectricBxDF::mfDistrib" class="code">mfDistrib</a>.<a href="#TrowbridgeReitzDistribution::Regularize" class="code">Regularize</a>(); }</div><p>


</p>
<p>

</p>
<p>Unless the surface is already fairly rough, the
<a href="../Reflection_Models/Roughness_Using_Microfacet_Theory.html#TrowbridgeReitzDistribution"><tt>TrowbridgeReitzDistribution</tt></a>&rsquo;s <tt>Regularize()</tt> method doubles the
<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.488ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 640.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">alpha</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D6FC" d="M602 383c0 0 -21 -117 -115 -235c-10 -12 -10 -14 -10 -35c0 -24 0 -102 31 -102c0 0 38 0 56 49c3 7 6 10 13 10c6 0 12 -3 12 -10c0 -16 -31 -71 -84 -71c-45 0 -78 31 -91 84c-76 -61 -148 -84 -211 -84c-102 0 -162 76 -162 169c0 141 132 284 269 284 c74 0 167 -49 167 -206v-62c47 59 80 135 98 198c5 18 5 21 15 21c11 0 12 -10 12 -10zM410 99c-2 17 -2 75 -2 112c0 78 0 209 -99 209c-35 0 -89 -19 -136 -92c-32 -51 -58 -159 -58 -208c0 -64 30 -109 90 -109c40 0 117 11 205 88Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D6FC" x="0" y="0"></use>
</g>
</svg> parameters and then clamps them&mdash;to ensure both that perfect
specular surfaces with a roughness of zero become non-perfect specular
and that surfaces are not excessively roughened.

</p>
<p></p>
<span class="anchor" id="fragment-TrowbridgeReitzDistributionPublicMethods-10"></span><div class="fragmentname">&lt;&lt;TrowbridgeReitzDistribution Public Methods&gt;&gt;+=&nbsp;<a href="../Textures_and_Materials/Material_Interface_and_Implementations.html#fragment-TrowbridgeReitzDistributionPublicMethods-9"><span class="fa fa-caret-up"></span></a></div>
<div class="fragmentcode">void <span class="anchor" id="TrowbridgeReitzDistribution::Regularize"></span>Regularize() {
    if (<a href="../Reflection_Models/Roughness_Using_Microfacet_Theory.html#TrowbridgeReitzDistribution::alpha_x" class="code">alpha_x</a> &lt; 0.3f) <a href="../Reflection_Models/Roughness_Using_Microfacet_Theory.html#TrowbridgeReitzDistribution::alpha_x" class="code">alpha_x</a> = <a href="../Utilities/Mathematical_Infrastructure.html#Clamp" class="code">Clamp</a>(2 * <a href="../Reflection_Models/Roughness_Using_Microfacet_Theory.html#TrowbridgeReitzDistribution::alpha_x" class="code">alpha_x</a>, 0.1f, 0.3f);
    if (<a href="../Reflection_Models/Roughness_Using_Microfacet_Theory.html#TrowbridgeReitzDistribution::alpha_y" class="code">alpha_y</a> &lt; 0.3f) <a href="../Reflection_Models/Roughness_Using_Microfacet_Theory.html#TrowbridgeReitzDistribution::alpha_y" class="code">alpha_y</a> = <a href="../Utilities/Mathematical_Infrastructure.html#Clamp" class="code">Clamp</a>(2 * <a href="../Reflection_Models/Roughness_Using_Microfacet_Theory.html#TrowbridgeReitzDistribution::alpha_y" class="code">alpha_y</a>, 0.1f, 0.3f);
}</div><p>


</p>
<p>

</p>
<p></p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

</div>  <!-- container-fluid -->
</div>  <!-- maincontainer -->

<nav class="navbar navbar-expand-md bg-light navbar-light">
<div class="container-fluid">
  <span class="navbar-text"><i>Physically Based Rendering: From Theory To Implementation</i>,<br>
<a href="https://creativecommons.org/licenses/by-nc-nd/4.0/">&copy; 2004-2023</a> Matt Pharr, Wenzel Jakob, and Greg Humphreys.
<a href="https://github.com/mmp/pbr-book-website/"><span class="fab fa-github"></span></a><br>
Purchase a printed copy: <a href="https://www.amazon.com/Physically-Based-Rendering-fourth-Implementation/dp/0262048027?keywords=physically+based+rendering+4th+edition&qid=1671730412&sprefix=physically+based%!C(MISSING)aps%!C(MISSING)145&sr=8-1&linkCode=ll1&tag=pharr-20&linkId=81a816d90f0c7e872617f1f930a51fd6&language=en_US&ref_=as_li_ss_tl"><span class="fab fa-amazon"></span></a>
<a href="https://mitpress.mit.edu/9780262048026/physically-based-rendering/"><img src="/mitpress.png" width=10 height=16></a>
</span>
</div>
  <div class="container">
    <ul class="nav navbar-nav ml-auto">
      <li class="nav-item">Next: <a href="../Light_Transport_I_Surface_Reflection/Further_Reading.html">Light Transport I: Surface Reflection / Further Reading</a></li>
    </ul>
  </div>

</nav>

<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
<script>
  $(function () {
    $('[data-toggle="popover"]').popover()
    $('[data-toggle="tooltip"]').tooltip()
   })
</script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>

<script>
// https://stackoverflow.com/a/17535094
// The function actually applying the offset
function offsetAnchor() {
  if (location.hash.length !== 0) {
    window.scrollTo(window.scrollX, window.scrollY - window.innerHeight / 8);
  }
}

// Captures click events of all <a> elements with href starting with #
$(document).on('click', 'a[href^="#"]', function(event) {
  // Click events are captured before hashchanges. Timeout
  // causes offsetAnchor to be called after the page jump.
  window.setTimeout(function() {
    offsetAnchor();
  }, 500);
});

// Set the offset when entering page with hash present in the url
window.setTimeout(offsetAnchor, 1500);
</script>

</body>
</html>
