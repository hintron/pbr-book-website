
<!doctype html>
<html lang="en">
<head>

<!-- all praise to https://realfavicongenerator.net -->
<link rel="icon" href="/favicon.ico?v=2" /> <!-- force refresh -->
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">

  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="/fonts.css">
  <link rel="stylesheet" href="../pbrstyle.css">
  <link rel="stylesheet" href="/fontawesome-free-5.15.3-web/css/all.css">

<script async src="https://cse.google.com/cse.js?cx=22a43cef261a245ea"></script>  <script src="/react.min.js"></script>
  <script src="/react-dom.min.js"></script>
  <script src="/jeri.min.js"></script>
  <link rel="preload" href="/exr.worker.js" as="script" crossorigin="anonymous">
  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="/bootstrap.min.css">

  <title>Light Sampling</title>
</head>
        
<body>

<nav class="fixed-top-lg-navbar navbar navbar-expand bg-light navbar-light">
  <ul class="nav navbar-nav">
    <a class="navbar-brand" href="../contents.html"><img src="../pbr.jpg" width=25 height=25></a>
    <li class="nav-item"><a class="nav-link" href="../Light_Sources.html">Light Sources</a></li>
    <span class="navbar-text">/</span>
    <li class="nav-item"><a class="nav-link" href="#">Light Sampling</a></li>
    <span class="navbar-text">&nbsp;&nbsp;</span>
    <li class="nav-item"><a class="nav-link" href="../Light_Sources/Infinite_Area_Lights.html">(Previous: Infinite Area Lights)</a></li>
  </ul>

  <ul class="nav navbar-nav ml-auto d-none d-md-block">
        <li class="nav-item"><div class="gcse-search"></div></li>
    </ul>
  <ul class="nav navbar-nav d-block d-md-none">
        <li class="nav-item"><div class="gcse-search"></div></li>
    </ul>
</nav>

<div class="maincontainer">
<div class="container-fluid">

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">
<a href="#"><i class="fas fa-link "></i></a>
</div>
<div class="col-md-10 col-lg-8">
<span class="anchor" id="sec:light-sampling"></span><h2>12.6 Light Sampling</h2><p>



</p>
<p>Due to the linearity assumption in radiometry, illumination at a point in
a scene with multiple light sources can be computed by summing the independent
contributions of each light.  As we have seen before, however, correctness
alone is not always sufficient&mdash;if it were, we might have sampled
<a href="../Light_Sources/Infinite_Area_Lights.html#ImageInfiniteLight"><tt>ImageInfiniteLight</tt></a>s uniformly with the suggestion that one take
thousands of samples per pixel until error has been reduced
sufficiently.
Especially in scenes with thousands or more independent light sources,
considering all of them carries too much of a performance cost.

</p>
<p>Fortunately, here, too, is a setting where stochastic sampling can be
applied.  An unbiased estimator for a sum of terms <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.939ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 834.8 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">f Subscript i</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D453" d="M552 636c0 -38 -29 -60 -55 -60c-19 0 -37 12 -37 35c0 15 10 50 54 54c-19 18 -45 18 -49 18c-21 0 -38 -15 -47 -34c-6 -12 -20 -83 -24 -104c-11 -58 -10 -56 -21 -114h83c17 0 27 0 27 -11c0 -20 -10 -20 -30 -20h-86l-60 -317c-1 -7 -24 -128 -56 -191 c-18 -38 -58 -97 -113 -97c-41 0 -85 24 -85 69c0 38 29 60 55 60c19 0 37 -12 37 -35c0 -15 -9 -51 -55 -54c19 -18 44 -18 48 -18c52 0 69 91 87 188l75 395h-66c-19 0 -28 0 -28 12c0 19 11 19 30 19h69c24 126 27 136 33 157c30 99 93 117 127 117c41 0 87 -23 87 -69Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D456" d="M284 625c0 -30 -30 -53 -53 -53c-24 0 -38 17 -38 36c0 27 27 53 54 53c23 0 37 -16 37 -36zM293 143c0 -9 -37 -154 -131 -154c-48 0 -82 35 -82 82c0 21 13 54 23 80c16 43 61 159 69 185c4 10 11 31 11 52c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124 c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 38 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -13 -53c-10 -27 -10 -29 -22 -58l-39 -105c-23 -61 -29 -75 -29 -100c0 -23 7 -33 24 -33c51 0 84 61 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D453" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="693" y="-213"></use>
</g>
</svg> is given by
</p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">
<span class="anchor" id="eq:mc-sampled-sum"></span><div class="displaymath"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="14.188ex" height="6.843ex" style="vertical-align: -3.005ex;" viewBox="0 -1652.5 6108.5 2946.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">sigma-summation Underscript i Overscript n Endscripts f Subscript i Baseline almost-equals StartFraction f Subscript j Baseline Over p left-parenthesis j right-parenthesis EndFraction comma</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNSIZE1-2211" d="M1387 -130l-121 -320h-1182c-18 0 -27 0 -27 11c0 0 0 6 10 18l518 607l-529 724c0 11 0 30 1 33c3 6 4 7 27 7h1182l121 -281h-25c-34 81 -102 126 -127 142c-79 50 -166 67 -220 75c-9 2 -100 16 -234 16h-548l466 -637c7 -10 7 -15 7 -15c0 -5 -2 -8 -9 -16l-509 -597 h603c192 0 290 26 311 31c115 30 221 98 260 202h25Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D456" d="M284 625c0 -30 -30 -53 -53 -53c-24 0 -38 17 -38 36c0 27 27 53 54 53c23 0 37 -16 37 -36zM293 143c0 -9 -37 -154 -131 -154c-48 0 -82 35 -82 82c0 21 13 54 23 80c16 43 61 159 69 185c4 10 11 31 11 52c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124 c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 38 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -13 -53c-10 -27 -10 -29 -22 -58l-39 -105c-23 -61 -29 -75 -29 -100c0 -23 7 -33 24 -33c51 0 84 61 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45B" d="M571 143c0 -8 -37 -154 -131 -154c-47 0 -82 35 -82 82c0 11 1 23 10 46c16 43 65 171 65 233c0 33 -9 70 -54 70c-95 0 -148 -91 -163 -122l-13 -50c-5 -23 -11 -45 -17 -67l-22 -90c-6 -25 -18 -72 -19 -74c-7 -20 -25 -28 -37 -28c-15 0 -29 9 -29 27c0 5 6 28 9 43 l58 231c13 52 16 63 16 84c0 33 -11 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 4 14 63 30 97c10 18 29 57 75 57s87 -31 92 -87c17 23 66 87 156 87c72 0 115 -40 115 -107c0 -57 -42 -167 -61 -220c-9 -22 -18 -46 -18 -71 c0 -23 7 -33 24 -33c49 0 82 56 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D453" d="M552 636c0 -38 -29 -60 -55 -60c-19 0 -37 12 -37 35c0 15 10 50 54 54c-19 18 -45 18 -49 18c-21 0 -38 -15 -47 -34c-6 -12 -20 -83 -24 -104c-11 -58 -10 -56 -21 -114h83c17 0 27 0 27 -11c0 -20 -10 -20 -30 -20h-86l-60 -317c-1 -7 -24 -128 -56 -191 c-18 -38 -58 -97 -113 -97c-41 0 -85 24 -85 69c0 38 29 60 55 60c19 0 37 -12 37 -35c0 -15 -9 -51 -55 -54c19 -18 44 -18 48 -18c52 0 69 91 87 188l75 395h-66c-19 0 -28 0 -28 12c0 19 11 19 30 19h69c24 126 27 136 33 157c30 99 93 117 127 117c41 0 87 -23 87 -69Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2248" d="M717 438v-2c-20 -93 -56 -149 -139 -169c-11 -3 -23 -4 -35 -4c-62 0 -120 37 -172 76c-43 32 -89 67 -138 67c-9 0 -17 -1 -26 -3c-67 -17 -111 -49 -127 -124c-1 -5 -6 -9 -12 -9c-7 0 -12 5 -12 12v2c20 93 56 149 139 169c12 3 24 4 35 4c62 0 120 -37 172 -76 c43 -32 89 -67 139 -67c8 0 16 1 25 3c67 17 111 49 127 124c2 5 6 9 12 9c7 0 12 -5 12 -12zM717 218v-2c-20 -93 -56 -149 -139 -169c-11 -3 -23 -4 -35 -4c-62 0 -120 37 -172 76c-43 32 -89 67 -138 67c-9 0 -17 -1 -26 -3c-67 -17 -111 -49 -127 -124 c-1 -5 -6 -9 -12 -9c-7 0 -12 5 -12 12v2c20 93 56 149 139 169c12 3 24 4 35 4c62 0 120 -37 172 -76c43 -32 89 -67 139 -67c8 0 16 1 25 3c67 17 111 49 127 124c2 5 6 9 12 9c7 0 12 -5 12 -12Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D457" d="M397 625c0 -27 -27 -53 -54 -53c-23 0 -37 16 -37 36c0 30 30 53 53 53c24 0 38 -17 38 -36zM360 350c0 -3 0 -17 -5 -37l-92 -366c-25 -99 -118 -152 -188 -152c-48 0 -88 22 -88 62c0 36 29 57 54 57c27 0 38 -19 38 -35c0 -20 -15 -46 -45 -53c18 -9 33 -9 39 -9 c56 0 104 57 123 133l94 373c4 17 7 28 7 51c0 42 -18 46 -32 46c-55 0 -101 -61 -126 -122c-8 -19 -9 -20 -18 -20c0 0 -12 0 -12 10c0 9 57 154 159 154c50 0 92 -35 92 -92Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45D" d="M490 282c0 -147 -125 -293 -241 -293c-51 0 -79 35 -92 64c-7 -25 -49 -188 -49 -200c0 -9 0 -16 50 -16c14 0 24 0 24 -11c0 -20 -13 -20 -18 -20c-32 0 -66 3 -99 3c-28 0 -57 -3 -84 -3c-8 0 -13 4 -13 12c0 19 11 19 23 19c44 0 46 7 54 41l112 445c4 17 7 28 7 51 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c37 0 80 -21 90 -75c33 39 81 75 131 75c76 0 133 -66 133 -160zM418 326c0 59 -24 94 -64 94c-17 0 -46 -7 -81 -38c-18 -15 -45 -43 -52 -70 l-49 -196c-3 -12 -3 -16 -3 -16c0 -6 13 -89 79 -89c37 0 85 33 119 103c18 38 51 153 51 212Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNSIZE1-2211" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="848" y="-1536"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D45B" x="721" y="1627"></use>
<g transform="translate(1611,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D453" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="693" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2248" x="2723" y="0"></use>
<g transform="translate(3497,0)">
<g transform="translate(397,0)">
<rect stroke="none" width="1815" height="60" x="0" y="220"></rect>
<g transform="translate(466,815)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D453" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D457" x="693" y="-213"></use>
</g>
<g transform="translate(60,-769)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="503" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D457" x="893" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="1305" y="0"></use>
</g>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="5830" y="0"></use>
</g>
</svg>
</div>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">
<div class="eqno">(<a href="#eq:mc-sampled-sum">12.2</a>)</div>
</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">
<p>

where the probability mass function (PMF) <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="8.271ex" height="2.843ex" style="vertical-align: -0.838ex; margin-left: -0.073ex;" viewBox="-31.5 -863.1 3561.1 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">p left-parenthesis j right-parenthesis greater-than 0</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45D" d="M490 282c0 -147 -125 -293 -241 -293c-51 0 -79 35 -92 64c-7 -25 -49 -188 -49 -200c0 -9 0 -16 50 -16c14 0 24 0 24 -11c0 -20 -13 -20 -18 -20c-32 0 -66 3 -99 3c-28 0 -57 -3 -84 -3c-8 0 -13 4 -13 12c0 19 11 19 23 19c44 0 46 7 54 41l112 445c4 17 7 28 7 51 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c37 0 80 -21 90 -75c33 39 81 75 131 75c76 0 133 -66 133 -160zM418 326c0 59 -24 94 -64 94c-17 0 -46 -7 -81 -38c-18 -15 -45 -43 -52 -70 l-49 -196c-3 -12 -3 -16 -3 -16c0 -6 13 -89 79 -89c37 0 85 33 119 103c18 38 51 153 51 212Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D457" d="M397 625c0 -27 -27 -53 -54 -53c-23 0 -37 16 -37 36c0 30 30 53 53 53c24 0 38 -17 38 -36zM360 350c0 -3 0 -17 -5 -37l-92 -366c-25 -99 -118 -152 -188 -152c-48 0 -88 22 -88 62c0 36 29 57 54 57c27 0 38 -19 38 -35c0 -20 -15 -46 -45 -53c18 -9 33 -9 39 -9 c56 0 104 57 123 133l94 373c4 17 7 28 7 51c0 42 -18 46 -32 46c-55 0 -101 -61 -126 -122c-8 -19 -9 -20 -18 -20c0 0 -12 0 -12 10c0 9 57 154 159 154c50 0 92 -35 92 -92Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3E" d="M688 230l-581 -275c-25 -11 -42 25 -18 36l548 259l-548 259c-24 11 -7 47 18 36l581 -275c17 -8 17 -32 0 -40Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-30" d="M460 320c0 -79 -5 -157 -37 -226c-44 -95 -120 -116 -174 -116c-49 0 -122 20 -165 101c-41 76 -45 166 -45 241c0 80 5 158 37 227c41 93 114 119 174 119c42 0 124 -16 170 -112c35 -74 40 -154 40 -234zM377 332c0 63 0 139 -10 195c-19 99 -85 117 -118 117 c-25 0 -100 -9 -119 -128c-8 -54 -8 -120 -8 -184c0 -59 0 -151 11 -211c18 -96 77 -121 116 -121c45 0 102 30 117 125c11 64 11 132 11 207Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="503" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D457" x="893" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="1305" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-3E" x="1972" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-30" x="3029" y="0"></use>
</g>
</svg>
for any term where <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.049ex" height="2.843ex" style="vertical-align: -1.005ex;" viewBox="0 -791.3 882.2 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">f Subscript j</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D453" d="M552 636c0 -38 -29 -60 -55 -60c-19 0 -37 12 -37 35c0 15 10 50 54 54c-19 18 -45 18 -49 18c-21 0 -38 -15 -47 -34c-6 -12 -20 -83 -24 -104c-11 -58 -10 -56 -21 -114h83c17 0 27 0 27 -11c0 -20 -10 -20 -30 -20h-86l-60 -317c-1 -7 -24 -128 -56 -191 c-18 -38 -58 -97 -113 -97c-41 0 -85 24 -85 69c0 38 29 60 55 60c19 0 37 -12 37 -35c0 -15 -9 -51 -55 -54c19 -18 44 -18 48 -18c52 0 69 91 87 188l75 395h-66c-19 0 -28 0 -28 12c0 19 11 19 30 19h69c24 126 27 136 33 157c30 99 93 117 127 117c41 0 87 -23 87 -69Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D457" d="M397 625c0 -27 -27 -53 -54 -53c-23 0 -37 16 -37 36c0 30 30 53 53 53c24 0 38 -17 38 -36zM360 350c0 -3 0 -17 -5 -37l-92 -366c-25 -99 -118 -152 -188 -152c-48 0 -88 22 -88 62c0 36 29 57 54 57c27 0 38 -19 38 -35c0 -20 -15 -46 -45 -53c18 -9 33 -9 39 -9 c56 0 104 57 123 133l94 373c4 17 7 28 7 51c0 42 -18 46 -32 46c-55 0 -101 -61 -126 -122c-8 -19 -9 -20 -18 -20c0 0 -12 0 -12 10c0 9 57 154 159 154c50 0 92 -35 92 -92Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D453" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D457" x="693" y="-213"></use>
</g>
</svg> is nonzero and where <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.243ex" height="2.509ex" style="vertical-align: -0.671ex; margin-left: -0.029ex;" viewBox="-12.5 -791.3 2257.6 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">j tilde p</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D457" d="M397 625c0 -27 -27 -53 -54 -53c-23 0 -37 16 -37 36c0 30 30 53 53 53c24 0 38 -17 38 -36zM360 350c0 -3 0 -17 -5 -37l-92 -366c-25 -99 -118 -152 -188 -152c-48 0 -88 22 -88 62c0 36 29 57 54 57c27 0 38 -19 38 -35c0 -20 -15 -46 -45 -53c18 -9 33 -9 39 -9 c56 0 104 57 123 133l94 373c4 17 7 28 7 51c0 42 -18 46 -32 46c-55 0 -101 -61 -126 -122c-8 -19 -9 -20 -18 -20c0 0 -12 0 -12 10c0 9 57 154 159 154c50 0 92 -35 92 -92Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-223C" d="M717 354c-4 -116 -34 -183 -119 -211c-15 -4 -30 -7 -45 -7c-66 0 -130 46 -184 95c-44 39 -93 81 -146 81c-10 0 -21 -1 -31 -5c-70 -23 -109 -67 -112 -161c0 -7 -6 -12 -12 -12c-7 0 -12 5 -12 12c4 116 34 183 120 211c14 4 29 7 44 7c66 0 130 -46 184 -95 c44 -39 93 -81 146 -81c11 0 21 1 32 5c69 23 108 67 111 161c0 7 6 12 12 12c7 0 12 -5 12 -12Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45D" d="M490 282c0 -147 -125 -293 -241 -293c-51 0 -79 35 -92 64c-7 -25 -49 -188 -49 -200c0 -9 0 -16 50 -16c14 0 24 0 24 -11c0 -20 -13 -20 -18 -20c-32 0 -66 3 -99 3c-28 0 -57 -3 -84 -3c-8 0 -13 4 -13 12c0 19 11 19 23 19c44 0 46 7 54 41l112 445c4 17 7 28 7 51 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c37 0 80 -21 90 -75c33 39 81 75 131 75c76 0 133 -66 133 -160zM418 326c0 59 -24 94 -64 94c-17 0 -46 -7 -81 -38c-18 -15 -45 -43 -52 -70 l-49 -196c-3 -12 -3 -16 -3 -16c0 -6 13 -89 79 -89c37 0 85 33 119 103c18 38 51 153 51 212Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D457" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-223C" x="690" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="1741" y="0"></use>
</g>
</svg>.  This is the discrete analog to the integral Monte Carlo
estimator, Equation&nbsp;(<a href="../Monte_Carlo_Integration/Monte_Carlo_Basics.html#eq:MC-estimator">2.7</a>).  Therefore, we can replace any
sum over all the scene&rsquo;s light sources with a sum over just one or a
few of them, where the contributions are weighted by one over the
probability of sampling the ones selected.

</p>
<p>Figure&nbsp;<a href="#fig:many-lights-scene">12.23</a> is a rendered image of a scene with 8,878 light sources.  A few
observations motivate some of the light sampling algorithms to come.  At
any given point in the scene, some lights are facing away and others are
occluded.  Ideally, such lights would be given a zero sampling probability.
Furthermore, often many lights are both far away from a given point and
have relatively low power; such lights should have a low probability of
being sampled.  (Consider, for example, the small yellow lights inset in the
machinery.)  Of course, even a small and dim light is important to points close
to it.  Therefore, the most effective light sampling probabilities will
vary across the scene depending on position, surface normal, the BSDF, and
so forth.

</p>
<p></p>
<span class="anchor" id="fig:many-lights-scene"></span><div class="card outerfigure"><div class="card-body figure"><p>


</p>
<div class="figure-row">
<img src="zero-day-frame35.png" style="max-width: 100%; height: auto;" width=1920 height=840>
</div>
<p>

</p>
<figcaption class="caption">Figure 12.23: <em>Zero Day</em> Scene, with 8,878 Light Sources. <span class="legend">
It is infeasible to consider every
light when computing reflected radiance at a point on a surface, and
therefore light sampling methods from this section are necessary to render
this scene efficiently.
<em>(Scene courtesy of Beeple.)</em>
</span>
</figcaption>
</div></div><p>


</p>
<p>The <tt>LightSampler</tt> class defines the
<tt>LightSampler</tt> interface for
sampling light sources.<button style="button" data-toggle="tooltip" data-placement="right" data-html="true" class="btn footnote-button" title="Our use of the term
&ldquo;sampling light sources&rdquo; is admittedly overloaded: it can refer to both
sampling a point on the surface of a light or a direction toward it, as
well as choosing an individual light source.  The intended meaning should
always be clear in context.">
      <sup>&dagger;</sup>
    </button>
		  It is defined in the file
<a href="https://github.com/mmp/pbrt-v4/tree/master/src/pbrt/base/lightsampler.h"><tt>base/lightsampler.h</tt></a>.  <tt>LightSampler</tt> implementations can
be found in <a href="https://github.com/mmp/pbrt-v4/tree/master/src/pbrt/lightsamplers.h"><tt>lightsamplers.h</tt></a> and
<a href="https://github.com/mmp/pbrt-v4/tree/master/src/pbrt/lightsamplers.cpp"><tt>lightsamplers.cpp</tt></a>.

</p>
<p></p>
<span class="anchor" id="fragment-LightSamplerDefinition-0"></span><div class="fragmentname">&lt;&lt;LightSampler Definition&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">class <span class="anchor" id="LightSampler"></span>LightSampler :
    public <a href="../Utilities/Containers_and_Memory_Management.html#TaggedPointer" class="code">TaggedPointer</a>&lt;<a href="#UniformLightSampler" class="code">UniformLightSampler</a>, <a href="#PowerLightSampler" class="code">PowerLightSampler</a>,
                         <a href="#BVHLightSampler" class="code">BVHLightSampler</a>&gt; {
  public:
    &lt;&lt;<span class="fragmentname"><a href="#fragment-LightSamplerInterface-0">LightSampler Interface</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1709" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1709"><i></i></a><div id="fragbit-1709" class="collapse show"><div class="fragmentcode">       using <a href="../Utilities/Containers_and_Memory_Management.html#TaggedPointer" class="code">TaggedPointer</a>::<a href="../Utilities/Containers_and_Memory_Management.html#TaggedPointer" class="code">TaggedPointer</a>;
       
       static <a href="#LightSampler" class="code">LightSampler</a> Create(const std::string &amp;name,
                                        pstd::span&lt;const <a href="../Light_Sources/Light_Interface.html#Light" class="code">Light</a>&gt; lights,
                                        Allocator alloc);
       
       std::string ToString() const;
       pstd::optional&lt;SampledLight&gt; Sample(const <a href="../Light_Sources/Light_Interface.html#LightSampleContext" class="code">LightSampleContext</a> &amp;ctx, 
                                           Float u) const;
       Float PMF(const <a href="../Light_Sources/Light_Interface.html#LightSampleContext" class="code">LightSampleContext</a> &amp;ctx, <a href="../Light_Sources/Light_Interface.html#Light" class="code">Light</a> light) const;
       pstd::optional&lt;SampledLight&gt; Sample(Float u) const;
       Float PMF(<a href="../Light_Sources/Light_Interface.html#Light" class="code">Light</a> light) const;</div></div>
};</div><p>


</p>
<p>

</p>
<p>The key <tt>LightSampler</tt> method is <tt>Sample()</tt>, which takes a uniform
1D sample and information about a reference point in the form of a
<a href="../Light_Sources/Light_Interface.html#LightSampleContext"><tt>LightSampleContext</tt></a>.  When sampling is successful, a
<a href="#SampledLight"><tt>SampledLight</tt></a> is returned.  Otherwise, the optional value is left
unset, as may happen if the light sampler is able to determine that no
lights illuminate the provided point.

</p>
<p></p>
<span class="anchor" id="fragment-LightSamplerInterface-0"></span><div class="fragmentname">&lt;&lt;LightSampler Interface&gt;&gt;=&nbsp;<a href="#fragment-LightSamplerInterface-1"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode">pstd::optional&lt;SampledLight&gt; <span class="anchor" id="LightSampler::Sample"></span>Sample(const <a href="../Light_Sources/Light_Interface.html#LightSampleContext" class="code">LightSampleContext</a> &amp;ctx, 
                                    Float u) const;</div><p>


</p>
<p><tt>SampledLight</tt> just wraps up a light and the discrete probability
for it having been sampled.

</p>
<p></p>
<span class="anchor" id="fragment-SampledLightDefinition-0"></span><div class="fragmentname">&lt;&lt;SampledLight Definition&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">struct <span class="anchor" id="SampledLight"></span>SampledLight {
    <a href="../Light_Sources/Light_Interface.html#Light" class="code">Light</a> <span class="anchor" id="SampledLight::light"></span>light;
    Float <span class="anchor" id="SampledLight::p"></span>p = 0;
};</div><p>


</p>
<p>In order to compute the MIS weighting term when a ray happens to hit a
light source, it is necessary to be able to find the value of the
probability mass function for sampling a particular light.  This task is
handled by <tt>PMF()</tt> method implementations.

</p>
<p></p>
<span class="anchor" id="fragment-LightSamplerInterface-1"></span><div class="fragmentname">&lt;&lt;LightSampler Interface&gt;&gt;+=&nbsp;<a href="#fragment-LightSamplerInterface-0"><span class="fa fa-caret-up"></span></a>&nbsp;<a href="#fragment-LightSamplerInterface-2"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode">Float <span class="anchor" id="LightSampler::PMF"></span>PMF(const <a href="../Light_Sources/Light_Interface.html#LightSampleContext" class="code">LightSampleContext</a> &amp;ctx, <a href="../Light_Sources/Light_Interface.html#Light" class="code">Light</a> light) const;</div><p>


</p>
<p><tt>LightSampler</tt>s must also provide methods to sample a light and
return the corresponding probability independent
of a specific point being illuminated.  These
methods are useful for light transport algorithms like
bidirectional path tracing that start paths at the light sources.

</p>
<p></p>
<span class="anchor" id="fragment-LightSamplerInterface-2"></span><div class="fragmentname">&lt;&lt;LightSampler Interface&gt;&gt;+=&nbsp;<a href="#fragment-LightSamplerInterface-1"><span class="fa fa-caret-up"></span></a></div>
<div class="fragmentcode">pstd::optional&lt;SampledLight&gt; Sample(Float u) const;
Float PMF(<a href="../Light_Sources/Light_Interface.html#Light" class="code">Light</a> light) const;</div><p>


</p>
<p>

</p>
<p></p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">
<a href="#UniformLightSampling"><i class="fas fa-link h3h4marginlink"></i></a>
</div>
<div class="col-md-10 col-lg-8">
<span id="UniformLightSampling"></span><h3>12.6.1  Uniform Light Sampling</h3><p>


</p>
<p><tt>UniformLightSampler</tt> is the simplest possible light sampler: it
samples all lights with uniform probability.  In practice, more
sophisticated sampling algorithms are usually much more effective, but this
one is easy to implement and provides a useful baseline for comparing light
sampling techniques.

</p>
<p></p>
<span class="anchor" id="fragment-UniformLightSamplerDefinition-0"></span><div class="fragmentname">&lt;&lt;UniformLightSampler Definition&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">class <span class="anchor" id="UniformLightSampler"></span>UniformLightSampler {
  public:
    &lt;&lt;<span class="fragmentname"><a href="#fragment-UniformLightSamplerPublicMethods-0">UniformLightSampler Public Methods</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1710" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1710"><i></i></a><div id="fragbit-1710" class="collapse show"><div class="fragmentcode">       UniformLightSampler(pstd::span&lt;const <a href="../Light_Sources/Light_Interface.html#Light" class="code">Light</a>&gt; <a href="#UniformLightSampler::lights" class="code">lights</a>, Allocator alloc)
           : <a href="#UniformLightSampler::lights" class="code">lights</a>(<a href="#UniformLightSampler::lights" class="code">lights</a>.begin(), <a href="#UniformLightSampler::lights" class="code">lights</a>.end(), alloc) {}
       pstd::optional&lt;<a href="#SampledLight" class="code">SampledLight</a>&gt; Sample(Float u) const {
           if (<a href="#UniformLightSampler::lights" class="code">lights</a>.empty()) return {};
           int lightIndex = std::min&lt;int&gt;(u * <a href="#UniformLightSampler::lights" class="code">lights</a>.size(), <a href="#UniformLightSampler::lights" class="code">lights</a>.size() - 1);
           return <a href="#SampledLight" class="code">SampledLight</a>{<a href="#UniformLightSampler::lights" class="code">lights</a>[lightIndex], 1.f / <a href="#UniformLightSampler::lights" class="code">lights</a>.size()};
       }
       Float PMF(<a href="../Light_Sources/Light_Interface.html#Light" class="code">Light</a> light) const {
           if (<a href="#UniformLightSampler::lights" class="code">lights</a>.empty()) return 0;
           return 1.f / <a href="#UniformLightSampler::lights" class="code">lights</a>.size();
       }
       PBRT_CPU_GPU
       pstd::optional&lt;<a href="#SampledLight" class="code">SampledLight</a>&gt; Sample(const <a href="../Light_Sources/Light_Interface.html#LightSampleContext" class="code">LightSampleContext</a> &amp;ctx, Float u) const {
           return Sample(u);
       }
       
       PBRT_CPU_GPU
       Float PMF(const <a href="../Light_Sources/Light_Interface.html#LightSampleContext" class="code">LightSampleContext</a> &amp;ctx, <a href="../Light_Sources/Light_Interface.html#Light" class="code">Light</a> light) const { return PMF(light); }
       
       std::string ToString() const { return "UniformLightSampler"; }</div></div>
  private:
    &lt;&lt;<span class="fragmentname"><a href="#fragment-UniformLightSamplerPrivateMembers-0">UniformLightSampler Private Members</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1711" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1711"><i></i></a><div id="fragbit-1711" class="collapse show"><div class="fragmentcode">       pstd::vector&lt;<a href="../Light_Sources/Light_Interface.html#Light" class="code">Light</a>&gt; lights;</div></div>
};</div><p>


</p>
<p>As with all light samplers, an array of all the lights in the scene is
provided to the constructor; <a href="#UniformLightSampler"><tt>UniformLightSampler</tt></a> makes a copy of
them in a member variable.

</p>
<p></p>
<span class="anchor" id="fragment-UniformLightSamplerPublicMethods-0"></span><div class="fragmentname">&lt;&lt;UniformLightSampler Public Methods&gt;&gt;=&nbsp;<a href="#fragment-UniformLightSamplerPublicMethods-1"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode">UniformLightSampler(pstd::span&lt;const <a href="../Light_Sources/Light_Interface.html#Light" class="code">Light</a>&gt; <a href="#UniformLightSampler::lights" class="code">lights</a>, Allocator alloc)
    : <a href="#UniformLightSampler::lights" class="code">lights</a>(<a href="#UniformLightSampler::lights" class="code">lights</a>.begin(), <a href="#UniformLightSampler::lights" class="code">lights</a>.end(), alloc) {}</div><p>


</p>
<p></p>
<span class="anchor" id="fragment-UniformLightSamplerPrivateMembers-0"></span><div class="fragmentname">&lt;&lt;UniformLightSampler Private Members&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">pstd::vector&lt;<a href="../Light_Sources/Light_Interface.html#Light" class="code">Light</a>&gt; <span class="anchor" id="UniformLightSampler::lights"></span>lights;</div><p>


</p>
<p>Since the light sampling probabilities do not depend on the lookup point,
we will only include the variants of <tt>Sample()</tt> and <tt>PMF()</tt> 
that do not take a <a href="../Light_Sources/Light_Interface.html#LightSampleContext"><tt>LightSampleContext</tt></a> here.  The versions of these methods
that do take a context just call these variants.  For sampling, a light is chosen by
scaling the provided uniform sample by the array size and returning the
corresponding light.

</p>
<p></p>
<span class="anchor" id="fragment-UniformLightSamplerPublicMethods-1"></span><div class="fragmentname">&lt;&lt;UniformLightSampler Public Methods&gt;&gt;+=&nbsp;<a href="#fragment-UniformLightSamplerPublicMethods-0"><span class="fa fa-caret-up"></span></a>&nbsp;<a href="#fragment-UniformLightSamplerPublicMethods-2"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode">pstd::optional&lt;<a href="#SampledLight" class="code">SampledLight</a>&gt; <span class="anchor" id="UniformLightSampler::Sample"></span>Sample(Float u) const {
    if (<a href="#UniformLightSampler::lights" class="code">lights</a>.empty()) return {};
    int lightIndex = std::min&lt;int&gt;(u * <a href="#UniformLightSampler::lights" class="code">lights</a>.size(), <a href="#UniformLightSampler::lights" class="code">lights</a>.size() - 1);
    return <a href="#SampledLight" class="code">SampledLight</a>{<a href="#UniformLightSampler::lights" class="code">lights</a>[lightIndex], 1.f / <a href="#UniformLightSampler::lights" class="code">lights</a>.size()};
}</div><p>


</p>
<p>Given uniform sampling probabilities, the value of the PMF is always one
over the number of lights.

</p>
<p></p>
<span class="anchor" id="fragment-UniformLightSamplerPublicMethods-2"></span><div class="fragmentname">&lt;&lt;UniformLightSampler Public Methods&gt;&gt;+=&nbsp;<a href="#fragment-UniformLightSamplerPublicMethods-1"><span class="fa fa-caret-up"></span></a></div>
<div class="fragmentcode">Float <span class="anchor" id="UniformLightSampler::PMF"></span>PMF(<a href="../Light_Sources/Light_Interface.html#Light" class="code">Light</a> light) const {
    if (<a href="#UniformLightSampler::lights" class="code">lights</a>.empty()) return 0;
    return 1.f / <a href="#UniformLightSampler::lights" class="code">lights</a>.size();
}</div><p>


</p>
<p>

</p>
<p>

</p>
<p></p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">
<a href="#PowerLightSampler"><i class="fas fa-link h3h4marginlink"></i></a>
</div>
<div class="col-md-10 col-lg-8">
<span id="PowerLightSampler"></span><h3>12.6.2  Power Light Sampler</h3><p>


</p>
<p><tt>PowerLightSampler</tt> sets the probability for sampling each light
according to its power.  Doing so generally gives better results than
sampling uniformly, but the lack of spatial variation in sampling
probabilities limits its effectiveness.  (We will return to this topic at the
end of this section where some comparisons between the two techniques are
presented.)

</p>
<p></p>
<span class="anchor" id="fragment-PowerLightSamplerDefinition-0"></span><div class="fragmentname">&lt;&lt;PowerLightSampler Definition&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">class <span class="anchor" id="PowerLightSampler"></span>PowerLightSampler {
  public:
    &lt;&lt;<span class="fragmentname"><a href="#fragment-PowerLightSamplerPublicMethods-0">PowerLightSampler Public Methods</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1712" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1712"><i></i></a><div id="fragbit-1712" class="collapse show"><div class="fragmentcode">       PowerLightSampler(pstd::span&lt;const <a href="../Light_Sources/Light_Interface.html#Light" class="code">Light</a>&gt; <a href="#PowerLightSampler::lights" class="code">lights</a>, Allocator alloc);
       pstd::optional&lt;<a href="#SampledLight" class="code">SampledLight</a>&gt; <a href="../Sampling_Algorithms/The_Alias_Method.html#AliasTable::Sample" class="code">Sample</a>(Float u) const {
           if (!<a href="#PowerLightSampler::aliasTable" class="code">aliasTable</a>.size()) return {};
           Float pmf;
           int lightIndex = <a href="#PowerLightSampler::aliasTable" class="code">aliasTable</a>.<a href="../Sampling_Algorithms/The_Alias_Method.html#AliasTable::Sample" class="code">Sample</a>(u, &amp;pmf);
           return <a href="#SampledLight" class="code">SampledLight</a>{<a href="#PowerLightSampler::lights" class="code">lights</a>[lightIndex], pmf};
       }
       Float <a href="../Sampling_Algorithms/The_Alias_Method.html#AliasTable::PMF" class="code">PMF</a>(<a href="../Light_Sources/Light_Interface.html#Light" class="code">Light</a> light) const {
           if (!<a href="#PowerLightSampler::aliasTable" class="code">aliasTable</a>.size()) return 0;
           return <a href="#PowerLightSampler::aliasTable" class="code">aliasTable</a>.<a href="../Sampling_Algorithms/The_Alias_Method.html#AliasTable::PMF" class="code">PMF</a>(<a href="#PowerLightSampler::lightToIndex" class="code">lightToIndex</a>[light]);
       }
       PBRT_CPU_GPU
       pstd::optional&lt;<a href="#SampledLight" class="code">SampledLight</a>&gt; <a href="../Sampling_Algorithms/The_Alias_Method.html#AliasTable::Sample" class="code">Sample</a>(const <a href="../Light_Sources/Light_Interface.html#LightSampleContext" class="code">LightSampleContext</a> &amp;ctx, Float u) const {
           return <a href="../Sampling_Algorithms/The_Alias_Method.html#AliasTable::Sample" class="code">Sample</a>(u);
       }
       
       PBRT_CPU_GPU
       Float <a href="../Sampling_Algorithms/The_Alias_Method.html#AliasTable::PMF" class="code">PMF</a>(const <a href="../Light_Sources/Light_Interface.html#LightSampleContext" class="code">LightSampleContext</a> &amp;ctx, <a href="../Light_Sources/Light_Interface.html#Light" class="code">Light</a> light) const { return <a href="../Sampling_Algorithms/The_Alias_Method.html#AliasTable::PMF" class="code">PMF</a>(light); }
       
       std::string ToString() const;</div></div>
  private:
    &lt;&lt;<span class="fragmentname"><a href="#fragment-PowerLightSamplerPrivateMembers-0">PowerLightSampler Private Members</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1713" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1713"><i></i></a><div id="fragbit-1713" class="collapse show"><div class="fragmentcode">       pstd::vector&lt;<a href="../Light_Sources/Light_Interface.html#Light" class="code">Light</a>&gt; lights;
       <a href="../Utilities/Containers_and_Memory_Management.html#HashMap" class="code">HashMap</a>&lt;<a href="../Light_Sources/Light_Interface.html#Light" class="code">Light</a>, size_t&gt; lightToIndex;
       <a href="../Sampling_Algorithms/The_Alias_Method.html#AliasTable" class="code">AliasTable</a> aliasTable;</div></div>
};</div><p>


</p>
<p>

</p>
<p>Its constructor also makes a copy of the provided lights but initializes
some additional data structures as well.

</p>
<p></p>
<span class="anchor" id="fragment-PowerLightSamplerMethodDefinitions-0"></span><div class="fragmentname">&lt;&lt;PowerLightSampler Method Definitions&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">PowerLightSampler::PowerLightSampler(pstd::span&lt;const <a href="../Light_Sources/Light_Interface.html#Light" class="code">Light</a>&gt; <a href="#PowerLightSampler::lights" class="code">lights</a>,
                                     Allocator alloc)
    : <a href="#PowerLightSampler::lights" class="code">lights</a>(<a href="#PowerLightSampler::lights" class="code">lights</a>.begin(), <a href="#PowerLightSampler::lights" class="code">lights</a>.end(), alloc), <a href="#PowerLightSampler::lightToIndex" class="code">lightToIndex</a>(alloc), 
      <a href="#PowerLightSampler::aliasTable" class="code">aliasTable</a>(alloc) {
    if (<a href="#PowerLightSampler::lights" class="code">lights</a>.empty()) return;
    &lt;&lt;<span class="fragmentname"><a href="#fragment-InitializemonolightToIndexhashtable-0">Initialize <tt>lightToIndex</tt> hash table</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1714" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1714"><i></i></a><div id="fragbit-1714" class="collapse show"><div class="fragmentcode">       for (size_t i = 0; i &lt; <a href="#PowerLightSampler::lights" class="code">lights</a>.size(); ++i)
           <a href="#PowerLightSampler::lightToIndex" class="code">lightToIndex</a>.Insert(<a href="#PowerLightSampler::lights" class="code">lights</a>[i], i);</div></div>
    &lt;&lt;<span class="fragmentname"><a href="#fragment-Computelightspowerandinitializealiastable-0">Compute lights&rsquo; power and initialize alias table</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1715" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1715"><i></i></a><div id="fragbit-1715" class="collapse show"><div class="fragmentcode">       pstd::vector&lt;Float&gt; lightPower;
       <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledWavelengths" class="code">SampledWavelengths</a> lambda = <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledWavelengths" class="code">SampledWavelengths</a>::SampleVisible(0.5f);
       for (const auto &amp;light : lights) {
           <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> phi = <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum::SafeDiv" class="code">SafeDiv</a>(light.<a href="../Light_Sources/Light_Interface.html#Light::Phi" class="code">Phi</a>(lambda), lambda.<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledWavelengths::PDF" class="code">PDF</a>());
           lightPower.push_back(phi.<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum::Average" class="code">Average</a>());
       }
       <a href="#PowerLightSampler::aliasTable" class="code">aliasTable</a> = AliasTable(lightPower, alloc);</div></div>
}</div><p>


</p>
<p></p>
<span class="anchor" id="fragment-PowerLightSamplerPrivateMembers-0"></span><div class="fragmentname">&lt;&lt;PowerLightSampler Private Members&gt;&gt;=&nbsp;<a href="#fragment-PowerLightSamplerPrivateMembers-1"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode">pstd::vector&lt;<a href="../Light_Sources/Light_Interface.html#Light" class="code">Light</a>&gt; <span class="anchor" id="PowerLightSampler::lights"></span>lights;</div><p>


</p>
<p>To efficiently return the value of the PMF for a given light, it is necessary
to be able to find the index in the
<tt>lights</tt> array of a given light.  Therefore, the constructor also initializes a hash
table that maps from <a href="../Light_Sources/Light_Interface.html#Light"><tt>Light</tt></a>s to indices.

</p>
<p></p>
<span class="anchor" id="fragment-InitializemonolightToIndexhashtable-0"></span><div class="fragmentname">&lt;&lt;Initialize <tt>lightToIndex</tt> hash table&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">for (size_t i = 0; i &lt; <a href="#PowerLightSampler::lights" class="code">lights</a>.size(); ++i)
    <a href="#PowerLightSampler::lightToIndex" class="code">lightToIndex</a>.Insert(<a href="#PowerLightSampler::lights" class="code">lights</a>[i], i);</div><p>


</p>
<p></p>
<span class="anchor" id="fragment-PowerLightSamplerPrivateMembers-1"></span><div class="fragmentname">&lt;&lt;PowerLightSampler Private Members&gt;&gt;+=&nbsp;<a href="#fragment-PowerLightSamplerPrivateMembers-0"><span class="fa fa-caret-up"></span></a>&nbsp;<a href="#fragment-PowerLightSamplerPrivateMembers-2"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode"><a href="../Utilities/Containers_and_Memory_Management.html#HashMap" class="code">HashMap</a>&lt;<a href="../Light_Sources/Light_Interface.html#Light" class="code">Light</a>, size_t&gt; <span class="anchor" id="PowerLightSampler::lightToIndex"></span>lightToIndex;</div><p>


</p>
<p>The <a href="#PowerLightSampler"><tt>PowerLightSampler</tt></a> uses an <a href="../Sampling_Algorithms/The_Alias_Method.html#AliasTable"><tt>AliasTable</tt></a> for sampling.  It is
initialized here with weights based on the emitted power returned by each
light&rsquo;s <tt>Phi()</tt> method.
Note that if the light&rsquo;s emission distribution is spiky (e.g., as with many
fluorescent lights), there is a risk of underestimating its power if a spike
is missed.  We have not found this to be a problem in practice, however.

</p>
<p></p>
<span class="anchor" id="fragment-Computelightspowerandinitializealiastable-0"></span><div class="fragmentname">&lt;&lt;Compute lights&rsquo; power and initialize alias table&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">pstd::vector&lt;Float&gt; lightPower;
<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledWavelengths" class="code">SampledWavelengths</a> lambda = <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledWavelengths" class="code">SampledWavelengths</a>::SampleVisible(0.5f);
for (const auto &amp;light : lights) {
    <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> phi = <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum::SafeDiv" class="code">SafeDiv</a>(light.<a href="../Light_Sources/Light_Interface.html#Light::Phi" class="code">Phi</a>(lambda), lambda.<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledWavelengths::PDF" class="code">PDF</a>());
    lightPower.push_back(phi.<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum::Average" class="code">Average</a>());
}
<a href="#PowerLightSampler::aliasTable" class="code">aliasTable</a> = AliasTable(lightPower, alloc);</div><p>


</p>
<p></p>
<span class="anchor" id="fragment-PowerLightSamplerPrivateMembers-2"></span><div class="fragmentname">&lt;&lt;PowerLightSampler Private Members&gt;&gt;+=&nbsp;<a href="#fragment-PowerLightSamplerPrivateMembers-1"><span class="fa fa-caret-up"></span></a></div>
<div class="fragmentcode"><a href="../Sampling_Algorithms/The_Alias_Method.html#AliasTable" class="code">AliasTable</a> <span class="anchor" id="PowerLightSampler::aliasTable"></span>aliasTable;</div><p>


</p>
<p>Given the alias table, sampling is easy.

</p>
<p></p>
<span class="anchor" id="fragment-PowerLightSamplerPublicMethods-0"></span><div class="fragmentname">&lt;&lt;PowerLightSampler Public Methods&gt;&gt;=&nbsp;<a href="#fragment-PowerLightSamplerPublicMethods-1"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode">pstd::optional&lt;<a href="#SampledLight" class="code">SampledLight</a>&gt; <span class="anchor" id="PowerLightSampler::Sample"></span><a href="../Sampling_Algorithms/The_Alias_Method.html#AliasTable::Sample" class="code">Sample</a>(Float u) const {
    if (!<a href="#PowerLightSampler::aliasTable" class="code">aliasTable</a>.size()) return {};
    Float pmf;
    int lightIndex = <a href="#PowerLightSampler::aliasTable" class="code">aliasTable</a>.<a href="../Sampling_Algorithms/The_Alias_Method.html#AliasTable::Sample" class="code">Sample</a>(u, &amp;pmf);
    return <a href="#SampledLight" class="code">SampledLight</a>{<a href="#PowerLightSampler::lights" class="code">lights</a>[lightIndex], pmf};
}</div><p>


</p>
<p>To evaluate the PMF, the hash table gives the mapping to an index in the
array of lights.  In turn, the PMF returned by the alias table for the
corresponding entry is the probability of sampling the light.

</p>
<p></p>
<span class="anchor" id="fragment-PowerLightSamplerPublicMethods-1"></span><div class="fragmentname">&lt;&lt;PowerLightSampler Public Methods&gt;&gt;+=&nbsp;<a href="#fragment-PowerLightSamplerPublicMethods-0"><span class="fa fa-caret-up"></span></a></div>
<div class="fragmentcode">Float <span class="anchor" id="PowerLightSampler::PMF"></span><a href="../Sampling_Algorithms/The_Alias_Method.html#AliasTable::PMF" class="code">PMF</a>(<a href="../Light_Sources/Light_Interface.html#Light" class="code">Light</a> light) const {
    if (!<a href="#PowerLightSampler::aliasTable" class="code">aliasTable</a>.size()) return 0;
    return <a href="#PowerLightSampler::aliasTable" class="code">aliasTable</a>.<a href="../Sampling_Algorithms/The_Alias_Method.html#AliasTable::PMF" class="code">PMF</a>(<a href="#PowerLightSampler::lightToIndex" class="code">lightToIndex</a>[light]);
}</div><p>


</p>
<p>As with the <a href="#UniformLightSampler"><tt>UniformLightSampler</tt></a>, the <tt>Sample()</tt> and <tt>PMF()</tt>
methods that do take a <a href="../Light_Sources/Light_Interface.html#LightSampleContext"><tt>LightSampleContext</tt></a> just call the corresponding
methods that do not take one. 

</p>
<p>

</p>
<p>Sampling lights based on their power usually works well.
Figure&nbsp;<a href="#fig:sample-lights-uniform-vs-power">12.24</a>
compares both sampling methods using the <em>Zero Day</em> scene.  For this scene, noise
is visibly reduced when sampling according to power, and mean squared error
(MSE) is improved by a factor of 12.4.

</p>
<p></p>
<span class="anchor" id="fig:sample-lights-uniform-vs-power"></span><div class="card outerfigure"><div class="card-body figure"><p>


</p>

<div class="card-img-top" style="display:block; width: 100%; padding-top: 45.417%;  position:relative;">
<div id="xa_Uniform_sampling51" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0;"></div></div>
<script>
Jeri.renderViewer(document.getElementById('xa_Uniform_sampling51'), {
  title: '(a)_Uniform_sampling51', children: [
 { title: '(a) Uniform sampling', image: 'zero-day-uniform.exr' },  { title: '(b) Sampling by power', image: 'zero-day-power.exr' }]});
</script>
<button data-toggle="tooltip" data-placement="left" class="btn yojeri" title="This image is interactive. Click and drag to pan and use the mouse-wheel to zoom. After clicking on the image to select it, type '?' to see a summary of keyboard controls."><i class="fa fa-snowflake fa-border"></i></button><p>

</p>
<figcaption class="caption">Figure 12.24: Sampling Lights Uniformly versus by Emitted Power with the
<em>Zero Day</em> Scene. <span class="legend">
(a)&nbsp;Rendered with uniform light sampling.
(b)&nbsp;Rendered with lights sampled according to power.
Both images are rendered with 16 samples per pixel and rendering time is
nearly the same.  Sampling lights according to power reduces MSE by a
factor of 12.4 for this scene.
<em>(Scene courtesy of Beeple.)</em>
</span>
</figcaption>
</div></div><p>


</p>
<p>Although sampling according to power generally works well, it is not
optimal.  Like uniform sampling, it is hindered by not taking the geometry
of emitters and the relationship between emitters and the receiving point
into account.  Relatively dim light sources may make the greatest visual
contribution in a scene, especially if the bright ones are far away, mostly
occluded, or not visible at all.

</p>
<p>As an extreme example of this problem with sampling according to power,
consider a large triangular light source that emits a small amount of
radiance.  The triangle&rsquo;s emitted power can be made arbitrarily large by
scaling it to increase its total area.  However, at any point in the scene
the triangle can do no more than subtend a hemisphere, which limits its
effect on the total incident radiance at a point.  Sampling by power can
devote far too many samples to such lights.

</p>
<p>

</p>
<p>
</p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">
<a href="#BVHLightSampling"><i class="fas fa-link h3h4marginlink"></i></a>
</div>
<div class="col-md-10 col-lg-8">
<span class="anchor" id="sec:bvh-light-sampling"></span><span id="BVHLightSampling"></span><h3>12.6.3  BVH Light Sampling<button data-toggle="tooltip" data-placement="right" class="btn difficult-button"
title="This section contains advanced content and may be skipped on a first reading.">
<i class="fas fa-exclamation-triangle midredtext"></i></button>
</h3><p>



</p>
<p>
Varying the light sampling probabilities based on the point being shaded
can be an effective light sampling strategy, though if there are more than a
handful of lights, some sort of data structure is necessary to do this
without having to consider every light at each point being shaded.  One
widely used approach is to construct a hierarchy over the light sources
with the effect of multiple lights aggregated into the higher nodes of the
hierarchy.  This representation makes it possible to traverse the hierarchy
to find the important lights near a given point.

</p>
<p>Given a good light hierarchy, it is possible to render scenes with hundreds
of thousands or even millions of light sources nearly as efficiently as a
scene with just one light.  In this section, we will describe the
implementation of the <a href="#BVHLightSampler"><tt>BVHLightSampler</tt></a>, which applies bounding volume
hierarchies to this task.

</p>
<p>

</p>
<p></p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">
<a href="#x3-BoundingLights"><i class="fas fa-link h3h4marginlink"></i></a>
</div>
<div class="col-md-10 col-lg-8">
<span id="x3-BoundingLights"></span><h4>Bounding Lights</h4><p>


</p>
<p>When bounding volume hierarchies (BVHs) were used
for intersection acceleration structures in
Section&nbsp;<a href="../Primitives_and_Intersection_Acceleration/Bounding_Volume_Hierarchies.html#sec:bvh">7.3</a>, it was necessary to abstract away the details of the
various types of primitives and underlying shapes that they stored so that
the <a href="../Primitives_and_Intersection_Acceleration/Bounding_Volume_Hierarchies.html#BVHAggregate"><tt>BVHAggregate</tt></a> did not have to be explicitly aware of each of them.
There, the primitives&rsquo; rendering-space bounding boxes were used for
building the hierarchy.  Although there were cases where the quality of the
acceleration structure might have been improved using shape-specific information
(e.g., if the acceleration structure was aware of skinny diagonal triangles
with large bounding boxes with
respect to the triangle&rsquo;s area), the <tt>BVHAggregate</tt>&rsquo;s implementation
was substantially simplified with that approach.

</p>
<p>We would like to have a similar decoupling for the <a href="#BVHLightSampler"><tt>BVHLightSampler</tt></a>,
though it is less obvious what the right abstraction should be.  For
example, we might want to know that a spotlight only emits light in a
particular cone, so that the sampler does not choose it for points outside
the cone.  Similarly, we might want to know that a one-sided area light
only shines light on one side of a particular plane.  For all sorts of
lights, knowing their total power would be helpful so that brighter lights
can be sampled preferentially to dimmer ones.  Of course, power does not
tell the whole story, as the light&rsquo;s spatial extent and relationship to a
receiving point affect how much power is potentially received at that point.

</p>
<p>The <tt>LightBounds</tt> structure provides the abstraction used by <tt>pbrt</tt> for these purposes.  It stores a variety of values that make it possible to
represent the emission distribution of a variety of types of light.

</p>
<p></p>
<span class="anchor" id="fragment-LightBoundsDefinition-0"></span><div class="fragmentname">&lt;&lt;LightBounds Definition&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">class <span class="anchor" id="LightBounds"></span>LightBounds {
public:
    &lt;&lt;<span class="fragmentname"><a href="#fragment-LightBoundsPublicMethods-0">LightBounds Public Methods</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1716" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1716"><i></i></a><div id="fragbit-1716" class="collapse show"><div class="fragmentcode">       <a href="#LightBounds" class="code">LightBounds</a>(const <a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3f" class="code">Bounds3f</a> &amp;b, <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> w, Float phi, Float cosTheta_o,
                   Float cosTheta_e, bool twoSided);
       <a href="../Geometry_and_Transformations/Points.html#Point3f" class="code">Point3f</a> Centroid() const { return (<a href="#LightBounds::bounds" class="code">bounds</a>.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3::pMin" class="code">pMin</a> + <a href="#LightBounds::bounds" class="code">bounds</a>.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3::pMax" class="code">pMax</a>) / 2; }
       PBRT_CPU_GPU
       Float Importance(<a href="../Geometry_and_Transformations/Points.html#Point3f" class="code">Point3f</a> p, <a href="../Geometry_and_Transformations/Normals.html#Normal3f" class="code">Normal3f</a> n) const;
       std::string ToString() const;</div></div>
    &lt;&lt;<span class="fragmentname"><a href="#fragment-LightBoundsPublicMembers-0">LightBounds Public Members</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1717" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1717"><i></i></a><div id="fragbit-1717" class="collapse show"><div class="fragmentcode">       <a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3f" class="code">Bounds3f</a> bounds;
       Float phi = 0;
       <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> w;
       Float cosTheta_o, cosTheta_e;
       bool twoSided;</div></div>
};</div><p>


</p>
<p>It is evident that the spatial bounds of the light and its emitted power
will be useful quantities, so those are included in <tt>LightBounds</tt>.
However, this representation excludes light sources at infinity such as the
<a href="../Light_Sources/Distant_Lights.html#DistantLight"><tt>DistantLight</tt></a> and the various infinite lights.  That limitation is
fine, however, since it is unclear how such light sources would be stored in a
BVH anyway.  (The <a href="#BVHLightSampler"><tt>BVHLightSampler</tt></a> therefore handles these types of lights
separately.)

</p>
<p></p>
<span class="anchor" id="fragment-LightBoundsPublicMembers-0"></span><div class="fragmentname">&lt;&lt;LightBounds Public Members&gt;&gt;=&nbsp;<a href="#fragment-LightBoundsPublicMembers-1"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode"><a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3f" class="code">Bounds3f</a> <span class="anchor" id="LightBounds::bounds"></span>bounds;
Float <span class="anchor" id="LightBounds::phi"></span>phi = 0;</div><p>


</p>
<p>As suggested earlier, bounding a light&rsquo;s directional emission distribution
is important for sampling lights effectively.  The representation used here
is based on a unit vector <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.446ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 622.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">omega Subscript</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
</g>
</svg> that specifies a principal direction for
the emitter&rsquo;s surface normal and two angles that specify its variation.
First, <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.145ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 923.4 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">theta Subscript normal o</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D703" d="M455 500c0 -224 -152 -511 -293 -511c-91 0 -120 111 -120 205c0 229 154 511 293 511c102 0 120 -139 120 -205zM389 562c0 57 -6 121 -55 121c-45 0 -82 -56 -109 -105c-40 -71 -60 -151 -77 -215h209c24 99 32 150 32 199zM348 331h-208c-26 -98 -32 -156 -32 -198 c0 -93 21 -122 54 -122c43 0 81 49 116 117c38 72 59 157 70 203Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6F" d="M471 214c0 -127 -101 -225 -222 -225c-117 0 -221 96 -221 225c0 125 97 234 222 234c121 0 221 -106 221 -234zM388 222c0 38 0 96 -26 139s-69 65 -113 65c-40 0 -87 -21 -114 -67c-24 -44 -24 -98 -24 -137c0 -36 0 -97 25 -141c27 -46 71 -67 114 -67 c50 0 94 29 116 74c22 44 22 98 22 134Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D703" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6F" x="663" y="-213"></use>
</g>
</svg> specifies the maximum deviation of the emitter&rsquo;s
surface normal from the principal normal direction <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.446ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 622.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">omega Subscript</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
</g>
</svg>.  Second,
<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.053ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 883.8 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">theta Subscript normal e</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D703" d="M455 500c0 -224 -152 -511 -293 -511c-91 0 -120 111 -120 205c0 229 154 511 293 511c102 0 120 -139 120 -205zM389 562c0 57 -6 121 -55 121c-45 0 -82 -56 -109 -105c-40 -71 -60 -151 -77 -215h209c24 99 32 150 32 199zM348 331h-208c-26 -98 -32 -156 -32 -198 c0 -93 21 -122 54 -122c43 0 81 49 116 117c38 72 59 157 70 203Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-65" d="M415 119c0 -19 -45 -130 -167 -130c-115 0 -220 97 -220 231c0 125 92 228 208 228c125 0 179 -97 179 -196c0 -21 -3 -21 -25 -21h-279c0 -36 0 -102 30 -150c23 -37 63 -67 113 -67c10 0 100 0 135 103c2 8 4 14 13 14c5 0 13 -2 13 -12zM349 252 c0 39 -10 174 -113 174c-34 0 -118 -25 -124 -174h237Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D703" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-65" x="663" y="-213"></use>
</g>
</svg> specifies the angle beyond <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.145ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 923.4 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">theta Subscript normal o</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D703" d="M455 500c0 -224 -152 -511 -293 -511c-91 0 -120 111 -120 205c0 229 154 511 293 511c102 0 120 -139 120 -205zM389 562c0 57 -6 121 -55 121c-45 0 -82 -56 -109 -105c-40 -71 -60 -151 -77 -215h209c24 99 32 150 32 199zM348 331h-208c-26 -98 -32 -156 -32 -198 c0 -93 21 -122 54 -122c43 0 81 49 116 117c38 72 59 157 70 203Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6F" d="M471 214c0 -127 -101 -225 -222 -225c-117 0 -221 96 -221 225c0 125 97 234 222 234c121 0 221 -106 221 -234zM388 222c0 38 0 96 -26 139s-69 65 -113 65c-40 0 -87 -21 -114 -67c-24 -44 -24 -98 -24 -137c0 -36 0 -97 25 -141c27 -46 71 -67 114 -67 c50 0 94 29 116 74c22 44 22 98 22 134Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D703" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6F" x="663" y="-213"></use>
</g>
</svg> up to
which there may be emission (see
Figure&nbsp;<a href="#fig:light-potential-emission-directions">12.25</a>).  Thus, directions
that make an angle up to <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="7.038ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 3030.2 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">theta Subscript normal o Baseline plus theta Subscript normal e</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D703" d="M455 500c0 -224 -152 -511 -293 -511c-91 0 -120 111 -120 205c0 229 154 511 293 511c102 0 120 -139 120 -205zM389 562c0 57 -6 121 -55 121c-45 0 -82 -56 -109 -105c-40 -71 -60 -151 -77 -215h209c24 99 32 150 32 199zM348 331h-208c-26 -98 -32 -156 -32 -198 c0 -93 21 -122 54 -122c43 0 81 49 116 117c38 72 59 157 70 203Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6F" d="M471 214c0 -127 -101 -225 -222 -225c-117 0 -221 96 -221 225c0 125 97 234 222 234c121 0 221 -106 221 -234zM388 222c0 38 0 96 -26 139s-69 65 -113 65c-40 0 -87 -21 -114 -67c-24 -44 -24 -98 -24 -137c0 -36 0 -97 25 -141c27 -46 71 -67 114 -67 c50 0 94 29 116 74c22 44 22 98 22 134Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2B" d="M722 250c0 -11 -9 -20 -20 -20h-293v-293c0 -11 -9 -20 -20 -20s-20 9 -20 20v293h-293c-11 0 -20 9 -20 20s9 20 20 20h293v293c0 11 9 20 20 20s20 -9 20 -20v-293h293c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-65" d="M415 119c0 -19 -45 -130 -167 -130c-115 0 -220 97 -220 231c0 125 92 228 208 228c125 0 179 -97 179 -196c0 -21 -3 -21 -25 -21h-279c0 -36 0 -102 30 -150c23 -37 63 -67 113 -67c10 0 100 0 135 103c2 8 4 14 13 14c5 0 13 -2 13 -12zM349 252 c0 39 -10 174 -113 174c-34 0 -118 -25 -124 -174h237Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D703" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6F" x="663" y="-213"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2B" x="1145" y="0"></use>
<g transform="translate(2146,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D703" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-65" x="663" y="-213"></use>
</g>
</g>
</svg> with <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.446ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 622.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">omega Subscript</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
</g>
</svg>
may receive illumination from a light and those that make a greater angle
certainly do not.

</p>
<p></p>
<span class="anchor" id="fig:light-potential-emission-directions"></span><div class="card outerfigure"><div class="card-body figure"><p>



</p>
<div class="figure-row">
  <a href="pha12f25.svg" title=""><img src="pha12f25.svg" width=171 height=168 style="max-width: 100%;"></a>
</div>
<p>


</p>
<figcaption class="caption">Figure 12.25: Specification of Potential Emission Directions for a Light. <span class="legend">
Lights specify a principal direction of their distribution of surface
normals <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.446ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 622.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">omega Subscript</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
</g>
</svg> as well as two angles, <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.145ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 923.4 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">theta Subscript normal o</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D703" d="M455 500c0 -224 -152 -511 -293 -511c-91 0 -120 111 -120 205c0 229 154 511 293 511c102 0 120 -139 120 -205zM389 562c0 57 -6 121 -55 121c-45 0 -82 -56 -109 -105c-40 -71 -60 -151 -77 -215h209c24 99 32 150 32 199zM348 331h-208c-26 -98 -32 -156 -32 -198 c0 -93 21 -122 54 -122c43 0 81 49 116 117c38 72 59 157 70 203Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6F" d="M471 214c0 -127 -101 -225 -222 -225c-117 0 -221 96 -221 225c0 125 97 234 222 234c121 0 221 -106 221 -234zM388 222c0 38 0 96 -26 139s-69 65 -113 65c-40 0 -87 -21 -114 -67c-24 -44 -24 -98 -24 -137c0 -36 0 -97 25 -141c27 -46 71 -67 114 -67 c50 0 94 29 116 74c22 44 22 98 22 134Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D703" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6F" x="663" y="-213"></use>
</g>
</svg> and
<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.053ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 883.8 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">theta Subscript normal e</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D703" d="M455 500c0 -224 -152 -511 -293 -511c-91 0 -120 111 -120 205c0 229 154 511 293 511c102 0 120 -139 120 -205zM389 562c0 57 -6 121 -55 121c-45 0 -82 -56 -109 -105c-40 -71 -60 -151 -77 -215h209c24 99 32 150 32 199zM348 331h-208c-26 -98 -32 -156 -32 -198 c0 -93 21 -122 54 -122c43 0 81 49 116 117c38 72 59 157 70 203Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-65" d="M415 119c0 -19 -45 -130 -167 -130c-115 0 -220 97 -220 231c0 125 92 228 208 228c125 0 179 -97 179 -196c0 -21 -3 -21 -25 -21h-279c0 -36 0 -102 30 -150c23 -37 63 -67 113 -67c10 0 100 0 135 103c2 8 4 14 13 14c5 0 13 -2 13 -12zM349 252 c0 39 -10 174 -113 174c-34 0 -118 -25 -124 -174h237Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D703" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-65" x="663" y="-213"></use>
</g>
</svg>.  The first angle bounds the variation in surface
normals from <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.446ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 622.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">omega Subscript</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
</g>
</svg> and the second gives the additional angle beyond which
emission is possible.</span>
</figcaption>
</div></div><p>


</p>
<p>While this representation may seem overly specialized for emissive shapes
alone, it works well for all of <tt>pbrt</tt>&rsquo;s (noninfinite) light types.  For
example, a point light can be represented with an arbitrary average normal
<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.446ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 622.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">omega Subscript</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
</g>
</svg> and an angle of <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.325ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 570.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">pi</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D70B" d="M567 407c0 -34 -36 -34 -49 -34h-114c-11 -52 -18 -106 -18 -159c0 -28 0 -93 29 -165c6 -14 6 -16 6 -22c0 -20 -21 -38 -41 -38c-15 0 -26 6 -36 50c-8 34 -8 61 -8 76c0 67 9 110 42 258h-113l-56 -221c-13 -50 -13 -52 -27 -98c-12 -37 -20 -65 -50 -65 c-13 0 -29 8 -29 27c0 7 0 9 8 24c42 91 96 212 128 333h-57c-20 0 -78 0 -127 -77c-6 -8 -8 -12 -16 -12c-12 0 -12 10 -12 10c0 5 26 51 61 90c44 47 82 47 104 47h335c19 0 40 0 40 -24Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D70B" x="0" y="0"></use>
</g>
</svg> for <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.145ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 923.4 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">theta Subscript normal o</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D703" d="M455 500c0 -224 -152 -511 -293 -511c-91 0 -120 111 -120 205c0 229 154 511 293 511c102 0 120 -139 120 -205zM389 562c0 57 -6 121 -55 121c-45 0 -82 -56 -109 -105c-40 -71 -60 -151 -77 -215h209c24 99 32 150 32 199zM348 331h-208c-26 -98 -32 -156 -32 -198 c0 -93 21 -122 54 -122c43 0 81 49 116 117c38 72 59 157 70 203Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6F" d="M471 214c0 -127 -101 -225 -222 -225c-117 0 -221 96 -221 225c0 125 97 234 222 234c121 0 221 -106 221 -234zM388 222c0 38 0 96 -26 139s-69 65 -113 65c-40 0 -87 -21 -114 -67c-24 -44 -24 -98 -24 -137c0 -36 0 -97 25 -141c27 -46 71 -67 114 -67 c50 0 94 29 116 74c22 44 22 98 22 134Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D703" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6F" x="663" y="-213"></use>
</g>
</svg>.  A spotlight can use
the direction it is facing for <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.446ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 622.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">omega Subscript</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
</g>
</svg>, its central cone angle for
<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.145ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 923.4 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">theta Subscript normal o</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D703" d="M455 500c0 -224 -152 -511 -293 -511c-91 0 -120 111 -120 205c0 229 154 511 293 511c102 0 120 -139 120 -205zM389 562c0 57 -6 121 -55 121c-45 0 -82 -56 -109 -105c-40 -71 -60 -151 -77 -215h209c24 99 32 150 32 199zM348 331h-208c-26 -98 -32 -156 -32 -198 c0 -93 21 -122 54 -122c43 0 81 49 116 117c38 72 59 157 70 203Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6F" d="M471 214c0 -127 -101 -225 -222 -225c-117 0 -221 96 -221 225c0 125 97 234 222 234c121 0 221 -106 221 -234zM388 222c0 38 0 96 -26 139s-69 65 -113 65c-40 0 -87 -21 -114 -67c-24 -44 -24 -98 -24 -137c0 -36 0 -97 25 -141c27 -46 71 -67 114 -67 c50 0 94 29 116 74c22 44 22 98 22 134Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D703" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6F" x="663" y="-213"></use>
</g>
</svg>, and the angular width of its falloff region for
<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.053ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 883.8 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">theta Subscript normal e</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D703" d="M455 500c0 -224 -152 -511 -293 -511c-91 0 -120 111 -120 205c0 229 154 511 293 511c102 0 120 -139 120 -205zM389 562c0 57 -6 121 -55 121c-45 0 -82 -56 -109 -105c-40 -71 -60 -151 -77 -215h209c24 99 32 150 32 199zM348 331h-208c-26 -98 -32 -156 -32 -198 c0 -93 21 -122 54 -122c43 0 81 49 116 117c38 72 59 157 70 203Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-65" d="M415 119c0 -19 -45 -130 -167 -130c-115 0 -220 97 -220 231c0 125 92 228 208 228c125 0 179 -97 179 -196c0 -21 -3 -21 -25 -21h-279c0 -36 0 -102 30 -150c23 -37 63 -67 113 -67c10 0 100 0 135 103c2 8 4 14 13 14c5 0 13 -2 13 -12zM349 252 c0 39 -10 174 -113 174c-34 0 -118 -25 -124 -174h237Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D703" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-65" x="663" y="-213"></use>
</g>
</svg>.

</p>
<p>Our implementation stores the cosine of these angles rather than the angles
themselves; this representation will make it possible to avoid the expense
of evaluating a number of trigonometric functions in the following.

</p>
<p></p>
<span class="anchor" id="fragment-LightBoundsPublicMembers-1"></span><div class="fragmentname">&lt;&lt;LightBounds Public Members&gt;&gt;+=&nbsp;<a href="#fragment-LightBoundsPublicMembers-0"><span class="fa fa-caret-up"></span></a>&nbsp;<a href="#fragment-LightBoundsPublicMembers-2"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode"><a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> <span class="anchor" id="LightBounds::w"></span>w;
Float <span class="anchor" id="LightBounds::cosTheta_o"></span>cosTheta_o, <span class="anchor" id="LightBounds::cosTheta_e"></span>cosTheta_e;</div><p>


</p>
<p>The last part of the emission bounds for a light is a <tt>twoSided</tt> flag,
which indicates whether the direction <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.446ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 622.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">omega Subscript</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
</g>
</svg> should be negated to specify a
second cone that uses the same pair of angles.

</p>
<p></p>
<span class="anchor" id="fragment-LightBoundsPublicMembers-2"></span><div class="fragmentname">&lt;&lt;LightBounds Public Members&gt;&gt;+=&nbsp;<a href="#fragment-LightBoundsPublicMembers-1"><span class="fa fa-caret-up"></span></a></div>
<div class="fragmentcode">bool <span class="anchor" id="LightBounds::twoSided"></span>twoSided;</div><p>


</p>
<p>The <tt>LightBounds</tt> constructor takes corresponding parameters and
initializes the member variables.  The implementation is straightforward,
and so is not included here.

</p>
<p></p>
<span class="anchor" id="fragment-LightBoundsPublicMethods-0"></span><div class="fragmentname">&lt;&lt;LightBounds Public Methods&gt;&gt;=&nbsp;<a href="#fragment-LightBoundsPublicMethods-1"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode"><a href="#LightBounds" class="code">LightBounds</a>(const <a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3f" class="code">Bounds3f</a> &amp;b, <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> w, Float phi, Float cosTheta_o,
            Float cosTheta_e, bool twoSided);</div><p>


</p>
<p>

</p>
<p>To cluster lights into a hierarchy, we will need to be able to
find the bounds that encompass two specified <tt>LightBounds</tt> objects.
This capability is provided by the <tt>Union()</tt> function.

</p>
<p></p>
<span class="anchor" id="fragment-LightBoundsInlineMethods-0"></span><div class="fragmentname">&lt;&lt;LightBounds Inline Methods&gt;&gt;=&nbsp;</div>
<div class="fragmentcode"><a href="#LightBounds" class="code">LightBounds</a> <span class="anchor" id="LightBounds::Union"></span>Union(const <a href="#LightBounds" class="code">LightBounds</a> &amp;a, const <a href="#LightBounds" class="code">LightBounds</a> &amp;b) {
    &lt;&lt;<span class="fragmentname"><a href="#fragment-IfonemonoLightBoundshaszeropowerreturntheother-0">If one <tt>LightBounds</tt> has zero power, return the other</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1718" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1718"><i></i></a><div id="fragbit-1718" class="collapse show"><div class="fragmentcode">       if (a.<a href="#LightBounds::phi" class="code">phi</a> == 0) return b;
       if (b.<a href="#LightBounds::phi" class="code">phi</a> == 0) return a;</div></div>
    &lt;&lt;<span class="fragmentname"><a href="#fragment-FindaveragedirectionandupdatedanglesformonoLightBounds-0">Find average direction and updated angles for <tt>LightBounds</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1719" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1719"><i></i></a><div id="fragbit-1719" class="collapse show"><div class="fragmentcode">       <a href="../Geometry_and_Transformations/Spherical_Geometry.html#DirectionCone" class="code">DirectionCone</a> cone = <a href="../Geometry_and_Transformations/Spherical_Geometry.html#DirectionCone::Union" class="code">Union</a>(<a href="../Geometry_and_Transformations/Spherical_Geometry.html#DirectionCone" class="code">DirectionCone</a>(a.<a href="#LightBounds::w" class="code">w</a>, a.<a href="#LightBounds::cosTheta_o" class="code">cosTheta_o</a>),
                                  <a href="../Geometry_and_Transformations/Spherical_Geometry.html#DirectionCone" class="code">DirectionCone</a>(b.<a href="#LightBounds::w" class="code">w</a>, b.<a href="#LightBounds::cosTheta_o" class="code">cosTheta_o</a>));
       Float <a href="#LightBounds::cosTheta_o" class="code">cosTheta_o</a> = cone.<a href="../Geometry_and_Transformations/Spherical_Geometry.html#DirectionCone::cosTheta" class="code">cosTheta</a>;
       Float <a href="#LightBounds::cosTheta_e" class="code">cosTheta_e</a> = std::min(a.<a href="#LightBounds::cosTheta_e" class="code">cosTheta_e</a>, b.<a href="#LightBounds::cosTheta_e" class="code">cosTheta_e</a>);</div></div>
    &lt;&lt;<span class="fragmentname"><a href="#fragment-ReturnfinalmonoLightBoundsunion-0">Return final <tt>LightBounds</tt> union</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1720" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1720"><i></i></a><div id="fragbit-1720" class="collapse show"><div class="fragmentcode">       return <a href="#LightBounds" class="code">LightBounds</a>(Union(a.<a href="#LightBounds::bounds" class="code">bounds</a>, b.<a href="#LightBounds::bounds" class="code">bounds</a>), cone.<a href="../Geometry_and_Transformations/Spherical_Geometry.html#DirectionCone::w" class="code">w</a>, a.<a href="#LightBounds::phi" class="code">phi</a> + b.<a href="#LightBounds::phi" class="code">phi</a>,
                          cosTheta_o, cosTheta_e, a.<a href="#LightBounds::twoSided" class="code">twoSided</a> | b.<a href="#LightBounds::twoSided" class="code">twoSided</a>);</div></div>
}</div><p>


</p>
<p>It is worthwhile to start out by checking for the easy case of one or the
other specified <tt>LightBounds</tt> having zero power.  In this case, the
other can be returned immediately.

</p>
<p></p>
<span class="anchor" id="fragment-IfonemonoLightBoundshaszeropowerreturntheother-0"></span><div class="fragmentname">&lt;&lt;If one <tt>LightBounds</tt> has zero power, return the other&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">if (a.<a href="#LightBounds::phi" class="code">phi</a> == 0) return b;
if (b.<a href="#LightBounds::phi" class="code">phi</a> == 0) return a;</div><p>


</p>
<p>Otherwise, a new average normal direction and updated angles
<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.145ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 923.4 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">theta Subscript normal o</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D703" d="M455 500c0 -224 -152 -511 -293 -511c-91 0 -120 111 -120 205c0 229 154 511 293 511c102 0 120 -139 120 -205zM389 562c0 57 -6 121 -55 121c-45 0 -82 -56 -109 -105c-40 -71 -60 -151 -77 -215h209c24 99 32 150 32 199zM348 331h-208c-26 -98 -32 -156 -32 -198 c0 -93 21 -122 54 -122c43 0 81 49 116 117c38 72 59 157 70 203Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6F" d="M471 214c0 -127 -101 -225 -222 -225c-117 0 -221 96 -221 225c0 125 97 234 222 234c121 0 221 -106 221 -234zM388 222c0 38 0 96 -26 139s-69 65 -113 65c-40 0 -87 -21 -114 -67c-24 -44 -24 -98 -24 -137c0 -36 0 -97 25 -141c27 -46 71 -67 114 -67 c50 0 94 29 116 74c22 44 22 98 22 134Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D703" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6F" x="663" y="-213"></use>
</g>
</svg> and <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.053ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 883.8 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">theta Subscript normal e</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D703" d="M455 500c0 -224 -152 -511 -293 -511c-91 0 -120 111 -120 205c0 229 154 511 293 511c102 0 120 -139 120 -205zM389 562c0 57 -6 121 -55 121c-45 0 -82 -56 -109 -105c-40 -71 -60 -151 -77 -215h209c24 99 32 150 32 199zM348 331h-208c-26 -98 -32 -156 -32 -198 c0 -93 21 -122 54 -122c43 0 81 49 116 117c38 72 59 157 70 203Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-65" d="M415 119c0 -19 -45 -130 -167 -130c-115 0 -220 97 -220 231c0 125 92 228 208 228c125 0 179 -97 179 -196c0 -21 -3 -21 -25 -21h-279c0 -36 0 -102 30 -150c23 -37 63 -67 113 -67c10 0 100 0 135 103c2 8 4 14 13 14c5 0 13 -2 13 -12zM349 252 c0 39 -10 174 -113 174c-34 0 -118 -25 -124 -174h237Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D703" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-65" x="663" y="-213"></use>
</g>
</svg> must be computed.  Most of the
work involved is handled by the <a href="../Geometry_and_Transformations/Spherical_Geometry.html#DirectionCone"><tt>DirectionCone</tt></a>&rsquo;s
<tt>Union()</tt> method, which takes a
pair of cones of directions and returns one that bounds the two of them.
The cosine of the new angle <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.145ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 923.4 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">theta Subscript normal o</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D703" d="M455 500c0 -224 -152 -511 -293 -511c-91 0 -120 111 -120 205c0 229 154 511 293 511c102 0 120 -139 120 -205zM389 562c0 57 -6 121 -55 121c-45 0 -82 -56 -109 -105c-40 -71 -60 -151 -77 -215h209c24 99 32 150 32 199zM348 331h-208c-26 -98 -32 -156 -32 -198 c0 -93 21 -122 54 -122c43 0 81 49 116 117c38 72 59 157 70 203Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6F" d="M471 214c0 -127 -101 -225 -222 -225c-117 0 -221 96 -221 225c0 125 97 234 222 234c121 0 221 -106 221 -234zM388 222c0 38 0 96 -26 139s-69 65 -113 65c-40 0 -87 -21 -114 -67c-24 -44 -24 -98 -24 -137c0 -36 0 -97 25 -141c27 -46 71 -67 114 -67 c50 0 94 29 116 74c22 44 22 98 22 134Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D703" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6F" x="663" y="-213"></use>
</g>
</svg> is then given by the cosine
of the spread angle of that cone.

</p>
<p>The value of <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.053ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 883.8 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">theta Subscript normal e</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D703" d="M455 500c0 -224 -152 -511 -293 -511c-91 0 -120 111 -120 205c0 229 154 511 293 511c102 0 120 -139 120 -205zM389 562c0 57 -6 121 -55 121c-45 0 -82 -56 -109 -105c-40 -71 -60 -151 -77 -215h209c24 99 32 150 32 199zM348 331h-208c-26 -98 -32 -156 -32 -198 c0 -93 21 -122 54 -122c43 0 81 49 116 117c38 72 59 157 70 203Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-65" d="M415 119c0 -19 -45 -130 -167 -130c-115 0 -220 97 -220 231c0 125 92 228 208 228c125 0 179 -97 179 -196c0 -21 -3 -21 -25 -21h-279c0 -36 0 -102 30 -150c23 -37 63 -67 113 -67c10 0 100 0 135 103c2 8 4 14 13 14c5 0 13 -2 13 -12zM349 252 c0 39 -10 174 -113 174c-34 0 -118 -25 -124 -174h237Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D703" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-65" x="663" y="-213"></use>
</g>
</svg> should be the maximum of the
<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.053ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 883.8 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">theta Subscript normal e</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D703" d="M455 500c0 -224 -152 -511 -293 -511c-91 0 -120 111 -120 205c0 229 154 511 293 511c102 0 120 -139 120 -205zM389 562c0 57 -6 121 -55 121c-45 0 -82 -56 -109 -105c-40 -71 -60 -151 -77 -215h209c24 99 32 150 32 199zM348 331h-208c-26 -98 -32 -156 -32 -198 c0 -93 21 -122 54 -122c43 0 81 49 116 117c38 72 59 157 70 203Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-65" d="M415 119c0 -19 -45 -130 -167 -130c-115 0 -220 97 -220 231c0 125 92 228 208 228c125 0 179 -97 179 -196c0 -21 -3 -21 -25 -21h-279c0 -36 0 -102 30 -150c23 -37 63 -67 113 -67c10 0 100 0 135 103c2 8 4 14 13 14c5 0 13 -2 13 -12zM349 252 c0 39 -10 174 -113 174c-34 0 -118 -25 -124 -174h237Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D703" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-65" x="663" y="-213"></use>
</g>
</svg> values for the two cones.  However, because
<a href="#LightBounds"><tt>LightBounds</tt></a> stores the cosines of the angles and because the cosine
function is monotonically decreasing over the range of possible <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.09ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 469.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">theta</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D703" d="M455 500c0 -224 -152 -511 -293 -511c-91 0 -120 111 -120 205c0 229 154 511 293 511c102 0 120 -139 120 -205zM389 562c0 57 -6 121 -55 121c-45 0 -82 -56 -109 -105c-40 -71 -60 -151 -77 -215h209c24 99 32 150 32 199zM348 331h-208c-26 -98 -32 -156 -32 -198 c0 -93 21 -122 54 -122c43 0 81 49 116 117c38 72 59 157 70 203Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D703" x="0" y="0"></use>
</g>
</svg>
values, <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.815ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 2073.2 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">left-bracket 0 comma pi right-bracket</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-5B" d="M256 -230c0 -11 -9 -20 -20 -20h-122v1000h122c11 0 20 -9 20 -20s-9 -20 -20 -20h-82v-920h82c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-30" d="M460 320c0 -79 -5 -157 -37 -226c-44 -95 -120 -116 -174 -116c-49 0 -122 20 -165 101c-41 76 -45 166 -45 241c0 80 5 158 37 227c41 93 114 119 174 119c42 0 124 -16 170 -112c35 -74 40 -154 40 -234zM377 332c0 63 0 139 -10 195c-19 99 -85 117 -118 117 c-25 0 -100 -9 -119 -128c-8 -54 -8 -120 -8 -184c0 -59 0 -151 11 -211c18 -96 77 -121 116 -121c45 0 102 30 117 125c11 64 11 132 11 207Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D70B" d="M567 407c0 -34 -36 -34 -49 -34h-114c-11 -52 -18 -106 -18 -159c0 -28 0 -93 29 -165c6 -14 6 -16 6 -22c0 -20 -21 -38 -41 -38c-15 0 -26 6 -36 50c-8 34 -8 61 -8 76c0 67 9 110 42 258h-113l-56 -221c-13 -50 -13 -52 -27 -98c-12 -37 -20 -65 -50 -65 c-13 0 -29 8 -29 27c0 7 0 9 8 24c42 91 96 212 128 333h-57c-20 0 -78 0 -127 -77c-6 -8 -8 -12 -16 -12c-12 0 -12 10 -12 10c0 5 26 51 61 90c44 47 82 47 104 47h335c19 0 40 0 40 -24Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-5D" d="M164 -250h-122c-11 0 -20 9 -20 20s9 20 20 20h82v920h-82c-11 0 -20 9 -20 20s9 20 20 20h122v-1000Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-5B" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-30" x="278" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="779" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D70B" x="1224" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-5D" x="1794" y="0"></use>
</g>
</svg>, we take the minimum cosine of the two angles.

</p>
<p></p>
<span class="anchor" id="fragment-FindaveragedirectionandupdatedanglesformonoLightBounds-0"></span><div class="fragmentname">&lt;&lt;Find average direction and updated angles for <tt>LightBounds</tt>&gt;&gt;=&nbsp;</div>
<div class="fragmentcode"><a href="../Geometry_and_Transformations/Spherical_Geometry.html#DirectionCone" class="code">DirectionCone</a> cone = <a href="../Geometry_and_Transformations/Spherical_Geometry.html#DirectionCone::Union" class="code">Union</a>(<a href="../Geometry_and_Transformations/Spherical_Geometry.html#DirectionCone" class="code">DirectionCone</a>(a.<a href="#LightBounds::w" class="code">w</a>, a.<a href="#LightBounds::cosTheta_o" class="code">cosTheta_o</a>),
                           <a href="../Geometry_and_Transformations/Spherical_Geometry.html#DirectionCone" class="code">DirectionCone</a>(b.<a href="#LightBounds::w" class="code">w</a>, b.<a href="#LightBounds::cosTheta_o" class="code">cosTheta_o</a>));
Float <a href="#LightBounds::cosTheta_o" class="code">cosTheta_o</a> = cone.<a href="../Geometry_and_Transformations/Spherical_Geometry.html#DirectionCone::cosTheta" class="code">cosTheta</a>;
Float <a href="#LightBounds::cosTheta_e" class="code">cosTheta_e</a> = std::min(a.<a href="#LightBounds::cosTheta_e" class="code">cosTheta_e</a>, b.<a href="#LightBounds::cosTheta_e" class="code">cosTheta_e</a>);</div><p>


</p>
<p>The remainder of the parameter values for the <tt>LightBounds</tt>
constructor are easily computed from the two <tt>LightBounds</tt> that were provided.

</p>
<p></p>
<span class="anchor" id="fragment-ReturnfinalmonoLightBoundsunion-0"></span><div class="fragmentname">&lt;&lt;Return final <tt>LightBounds</tt> union&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">return <a href="#LightBounds" class="code">LightBounds</a>(Union(a.<a href="#LightBounds::bounds" class="code">bounds</a>, b.<a href="#LightBounds::bounds" class="code">bounds</a>), cone.<a href="../Geometry_and_Transformations/Spherical_Geometry.html#DirectionCone::w" class="code">w</a>, a.<a href="#LightBounds::phi" class="code">phi</a> + b.<a href="#LightBounds::phi" class="code">phi</a>,
                   cosTheta_o, cosTheta_e, a.<a href="#LightBounds::twoSided" class="code">twoSided</a> | b.<a href="#LightBounds::twoSided" class="code">twoSided</a>);</div><p>


</p>
<p>A utility method returns the centroid of the spatial bounds; this value
will be handy when building the light BVH.

</p>
<p></p>
<span class="anchor" id="fragment-LightBoundsPublicMethods-1"></span><div class="fragmentname">&lt;&lt;LightBounds Public Methods&gt;&gt;+=&nbsp;<a href="#fragment-LightBoundsPublicMethods-0"><span class="fa fa-caret-up"></span></a></div>
<div class="fragmentcode"><a href="../Geometry_and_Transformations/Points.html#Point3f" class="code">Point3f</a> <span class="anchor" id="LightBounds::Centroid"></span>Centroid() const { return (<a href="#LightBounds::bounds" class="code">bounds</a>.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3::pMin" class="code">pMin</a> + <a href="#LightBounds::bounds" class="code">bounds</a>.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3::pMax" class="code">pMax</a>) / 2; }</div><p>


</p>
<p>

</p>
<p>The <tt>Importance()</tt> method provides the key <tt>LightBounds</tt>
functionality: it returns a scalar value that estimates the contribution of
the light or lights represented in the <tt>LightBounds</tt> at a given point.
If the provided normal is nondegenerate, it is assumed to be the surface
normal at the receiving point.  Scattering points in participating media
pass a zero-valued <tt>Normal3f</tt>.

</p>
<p></p>
<span class="anchor" id="fragment-LightBoundsMethodDefinitions-0"></span><div class="fragmentname">&lt;&lt;LightBounds Method Definitions&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">Float <span class="anchor" id="LightBounds::Importance"></span><a href="#LightBounds" class="code">LightBounds</a>::Importance(<a href="../Geometry_and_Transformations/Points.html#Point3f" class="code">Point3f</a> p, <a href="../Geometry_and_Transformations/Normals.html#Normal3f" class="code">Normal3f</a> n) const {
    &lt;&lt;<span class="fragmentname"><a href="#fragment-Returnimportanceforlightboundsatreferencepoint-0">Return importance for light bounds at reference point</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1721" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1721"><i></i></a><div id="fragbit-1721" class="collapse show"><div class="fragmentcode">       &lt;&lt;<span class="fragmentname"><a href="#fragment-Computeclampedsquareddistancetoreferencepoint-0">Compute clamped squared distance to reference point</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1722" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1722"><i></i></a><div id="fragbit-1722" class="collapse show"><div class="fragmentcode">          <a href="../Geometry_and_Transformations/Points.html#Point3f" class="code">Point3f</a> pc = (<a href="#LightBounds::bounds" class="code">bounds</a>.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3::pMin" class="code">pMin</a> + <a href="#LightBounds::bounds" class="code">bounds</a>.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3::pMax" class="code">pMax</a>) / 2;
          Float d2 = <a href="../Geometry_and_Transformations/Points.html#DistanceSquared" class="code">DistanceSquared</a>(p, pc);
          d2 = std::max(d2, <a href="../Geometry_and_Transformations/Vectors.html#Length" class="code">Length</a>(<a href="#LightBounds::bounds" class="code">bounds</a>.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3::Diagonal" class="code">Diagonal</a>()) / 2);</div></div>
       &lt;&lt;<span class="fragmentname"><a href="#fragment-Definecosineandsineclampedsubtractionlambdas-0">Define cosine and sine clamped subtraction lambdas</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1723" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1723"><i></i></a><div id="fragbit-1723" class="collapse show"><div class="fragmentcode">          auto cosSubClamped = [](Float sinTheta_a, Float cosTheta_a,
                                  Float sinTheta_b, Float cosTheta_b) -&gt; Float {
              if (cosTheta_a &gt; cosTheta_b)
                  return 1;
              return cosTheta_a * cosTheta_b + sinTheta_a * sinTheta_b;
          };
          auto sinSubClamped = [](Float sinTheta_a, Float cosTheta_a,
                                  Float sinTheta_b, Float cosTheta_b) -&gt; Float {
              if (cosTheta_a &gt; cosTheta_b)
                  return 0;
              return sinTheta_a * cosTheta_b - cosTheta_a * sinTheta_b;
          };</div></div>
       &lt;&lt;<span class="fragmentname"><a href="#fragment-Computesineandcosineofangletovectormonowtheta_romanw-0">Compute sine and cosine of angle to vector <tt>w</tt>, <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.509ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 1080.4 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">theta Subscript normal w</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D703" d="M455 500c0 -224 -152 -511 -293 -511c-91 0 -120 111 -120 205c0 229 154 511 293 511c102 0 120 -139 120 -205zM389 562c0 57 -6 121 -55 121c-45 0 -82 -56 -109 -105c-40 -71 -60 -151 -77 -215h209c24 99 32 150 32 199zM348 331h-208c-26 -98 -32 -156 -32 -198 c0 -93 21 -122 54 -122c43 0 81 49 116 117c38 72 59 157 70 203Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-77" d="M703 400c-35 -1 -66 -14 -84 -64l-117 -328c-4 -10 -7 -19 -20 -19s-16 8 -20 19l-102 284l-101 -283c-5 -14 -7 -20 -20 -20s-16 8 -21 22l-126 354c-12 32 -24 35 -74 35v31l93 -3l109 3v-31c-20 0 -59 0 -59 -27c0 -4 0 -6 5 -18l95 -267l86 242c-7 19 -18 49 -23 55 c-10 13 -26 15 -63 15v31c30 -2 59 -3 89 -3l104 3v-31c-20 0 -59 0 -59 -27c0 -5 1 -7 5 -19l99 -279l91 256c5 13 5 15 5 21c0 29 -22 47 -58 48v31l93 -3c22 0 51 1 73 3v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D703" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-77" x="663" y="-213"></use>
</g>
</svg></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1724" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1724"><i></i></a><div id="fragbit-1724" class="collapse show"><div class="fragmentcode">          <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> wi = <a href="../Geometry_and_Transformations/Vectors.html#Normalize" class="code">Normalize</a>(p - pc);
          Float cosTheta_w = <a href="../Geometry_and_Transformations/Vectors.html#Dot" class="code">Dot</a>(<a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a>(<a href="#LightBounds::w" class="code">w</a>), wi);
          if (<a href="#LightBounds::twoSided" class="code">twoSided</a>)
              cosTheta_w = std::abs(cosTheta_w);
          Float sinTheta_w = <a href="../Utilities/Mathematical_Infrastructure.html#SafeSqrt" class="code">SafeSqrt</a>(1 - <a href="../Utilities/Mathematical_Infrastructure.html#Sqr" class="code">Sqr</a>(cosTheta_w));</div></div>
       &lt;&lt;<span class="fragmentname"><a href="#fragment-Computecostheta_romanbforreferencepoint-0">Compute <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="6.509ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 2802.5 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">cosine theta Subscript normal b</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-63" d="M415 119c0 -10 -32 -130 -166 -130c-116 0 -215 99 -215 227c0 124 92 232 217 232c77 0 153 -39 153 -107c0 -30 -20 -47 -46 -47c-28 0 -46 20 -46 46c0 13 6 43 47 46c-35 36 -98 37 -107 37c-53 0 -135 -42 -135 -205c0 -161 88 -204 141 -204c37 0 102 12 131 105 c2 6 4 10 13 10c3 0 13 0 13 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6F" d="M471 214c0 -127 -101 -225 -222 -225c-117 0 -221 96 -221 225c0 125 97 234 222 234c121 0 221 -106 221 -234zM388 222c0 38 0 96 -26 139s-69 65 -113 65c-40 0 -87 -21 -114 -67c-24 -44 -24 -98 -24 -137c0 -36 0 -97 25 -141c27 -46 71 -67 114 -67 c50 0 94 29 116 74c22 44 22 98 22 134Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-73" d="M360 128c0 -72 -46 -139 -161 -139c-21 0 -66 1 -110 43c-18 -19 -18 -21 -20 -23c-19 -19 -20 -20 -25 -20c-11 0 -11 7 -11 24v132c0 18 0 25 13 25c10 0 11 -4 14 -17c19 -85 55 -142 139 -142c78 0 113 40 113 91c0 72 -82 88 -104 92c-72 14 -100 20 -132 46 c-27 22 -43 50 -43 85c0 56 38 123 160 123c15 0 56 0 94 -28c4 3 14 12 17 16c13 12 15 12 20 12c11 0 11 -7 11 -24v-101c0 -19 0 -24 -13 -24c0 0 -11 0 -12 9c-2 31 -7 121 -117 121c-86 0 -112 -41 -112 -76c0 -58 67 -71 123 -82c42 -8 81 -16 114 -48 c12 -12 42 -42 42 -95Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D703" d="M455 500c0 -224 -152 -511 -293 -511c-91 0 -120 111 -120 205c0 229 154 511 293 511c102 0 120 -139 120 -205zM389 562c0 57 -6 121 -55 121c-45 0 -82 -56 -109 -105c-40 -71 -60 -151 -77 -215h209c24 99 32 150 32 199zM348 331h-208c-26 -98 -32 -156 -32 -198 c0 -93 21 -122 54 -122c43 0 81 49 116 117c38 72 59 157 70 203Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-62" d="M521 216c0 -129 -104 -227 -223 -227c-74 0 -116 50 -131 73l-36 -62h-25v596c0 49 -8 56 -78 56v31l144 11v-317c16 18 59 65 137 65c114 0 212 -99 212 -226zM438 217c0 41 -3 98 -29 139c-24 38 -60 64 -105 64c-24 0 -79 -8 -118 -64c-11 -16 -11 -17 -11 -36v-206 c0 -18 0 -21 14 -42c24 -37 60 -61 105 -61c54 0 92 33 113 64c29 45 31 105 31 142Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-63"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-6F" x="444" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-73" x="945" y="0"></use>
<g transform="translate(1672,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D703" x="0" y="0"></use>
<g transform="translate(469,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-62" x="235" y="0"></use>
</g>
</g>
</g>
</svg> for reference point</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1725" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1725"><i></i></a><div id="fragbit-1725" class="collapse show"><div class="fragmentcode">          Float cosTheta_b = <a href="../Geometry_and_Transformations/Spherical_Geometry.html#DirectionCone::BoundSubtendedDirections" class="code">BoundSubtendedDirections</a>(<a href="#LightBounds::bounds" class="code">bounds</a>, p).<a href="../Geometry_and_Transformations/Spherical_Geometry.html#DirectionCone::cosTheta" class="code">cosTheta</a>;
          Float sinTheta_b = <a href="../Utilities/Mathematical_Infrastructure.html#SafeSqrt" class="code">SafeSqrt</a>(1 - <a href="../Utilities/Mathematical_Infrastructure.html#Sqr" class="code">Sqr</a>(cosTheta_b));</div></div>
       &lt;&lt;<span class="fragmentname"><a href="#fragment-Computecosthetaandtestagainstcostheta_romane-0">Compute <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.877ex" height="2.343ex" style="vertical-align: -0.338ex;" viewBox="0 -863.1 2530.5 1008.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">cosine theta prime</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-63" d="M415 119c0 -10 -32 -130 -166 -130c-116 0 -215 99 -215 227c0 124 92 232 217 232c77 0 153 -39 153 -107c0 -30 -20 -47 -46 -47c-28 0 -46 20 -46 46c0 13 6 43 47 46c-35 36 -98 37 -107 37c-53 0 -135 -42 -135 -205c0 -161 88 -204 141 -204c37 0 102 12 131 105 c2 6 4 10 13 10c3 0 13 0 13 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6F" d="M471 214c0 -127 -101 -225 -222 -225c-117 0 -221 96 -221 225c0 125 97 234 222 234c121 0 221 -106 221 -234zM388 222c0 38 0 96 -26 139s-69 65 -113 65c-40 0 -87 -21 -114 -67c-24 -44 -24 -98 -24 -137c0 -36 0 -97 25 -141c27 -46 71 -67 114 -67 c50 0 94 29 116 74c22 44 22 98 22 134Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-73" d="M360 128c0 -72 -46 -139 -161 -139c-21 0 -66 1 -110 43c-18 -19 -18 -21 -20 -23c-19 -19 -20 -20 -25 -20c-11 0 -11 7 -11 24v132c0 18 0 25 13 25c10 0 11 -4 14 -17c19 -85 55 -142 139 -142c78 0 113 40 113 91c0 72 -82 88 -104 92c-72 14 -100 20 -132 46 c-27 22 -43 50 -43 85c0 56 38 123 160 123c15 0 56 0 94 -28c4 3 14 12 17 16c13 12 15 12 20 12c11 0 11 -7 11 -24v-101c0 -19 0 -24 -13 -24c0 0 -11 0 -12 9c-2 31 -7 121 -117 121c-86 0 -112 -41 -112 -76c0 -58 67 -71 123 -82c42 -8 81 -16 114 -48 c12 -12 42 -42 42 -95Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D703" d="M455 500c0 -224 -152 -511 -293 -511c-91 0 -120 111 -120 205c0 229 154 511 293 511c102 0 120 -139 120 -205zM389 562c0 57 -6 121 -55 121c-45 0 -82 -56 -109 -105c-40 -71 -60 -151 -77 -215h209c24 99 32 150 32 199zM348 331h-208c-26 -98 -32 -156 -32 -198 c0 -93 21 -122 54 -122c43 0 81 49 116 117c38 72 59 157 70 203Z"></path>
<path stroke-width="1" id="E1-LATINMODERNVARIANTS-2032" d="M340 496c0 -10 -3 -20 -8 -28l-227 -372h-38l171 424c6 15 26 29 48 29c30 0 54 -24 54 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-63"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-6F" x="444" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-73" x="945" y="0"></use>
<g transform="translate(1672,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D703" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNVARIANTS-2032" x="663" y="513"></use>
</g>
</g>
</svg> and test against <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.938ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 2556.6 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">cosine theta Subscript normal e</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-63" d="M415 119c0 -10 -32 -130 -166 -130c-116 0 -215 99 -215 227c0 124 92 232 217 232c77 0 153 -39 153 -107c0 -30 -20 -47 -46 -47c-28 0 -46 20 -46 46c0 13 6 43 47 46c-35 36 -98 37 -107 37c-53 0 -135 -42 -135 -205c0 -161 88 -204 141 -204c37 0 102 12 131 105 c2 6 4 10 13 10c3 0 13 0 13 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6F" d="M471 214c0 -127 -101 -225 -222 -225c-117 0 -221 96 -221 225c0 125 97 234 222 234c121 0 221 -106 221 -234zM388 222c0 38 0 96 -26 139s-69 65 -113 65c-40 0 -87 -21 -114 -67c-24 -44 -24 -98 -24 -137c0 -36 0 -97 25 -141c27 -46 71 -67 114 -67 c50 0 94 29 116 74c22 44 22 98 22 134Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-73" d="M360 128c0 -72 -46 -139 -161 -139c-21 0 -66 1 -110 43c-18 -19 -18 -21 -20 -23c-19 -19 -20 -20 -25 -20c-11 0 -11 7 -11 24v132c0 18 0 25 13 25c10 0 11 -4 14 -17c19 -85 55 -142 139 -142c78 0 113 40 113 91c0 72 -82 88 -104 92c-72 14 -100 20 -132 46 c-27 22 -43 50 -43 85c0 56 38 123 160 123c15 0 56 0 94 -28c4 3 14 12 17 16c13 12 15 12 20 12c11 0 11 -7 11 -24v-101c0 -19 0 -24 -13 -24c0 0 -11 0 -12 9c-2 31 -7 121 -117 121c-86 0 -112 -41 -112 -76c0 -58 67 -71 123 -82c42 -8 81 -16 114 -48 c12 -12 42 -42 42 -95Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D703" d="M455 500c0 -224 -152 -511 -293 -511c-91 0 -120 111 -120 205c0 229 154 511 293 511c102 0 120 -139 120 -205zM389 562c0 57 -6 121 -55 121c-45 0 -82 -56 -109 -105c-40 -71 -60 -151 -77 -215h209c24 99 32 150 32 199zM348 331h-208c-26 -98 -32 -156 -32 -198 c0 -93 21 -122 54 -122c43 0 81 49 116 117c38 72 59 157 70 203Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-65" d="M415 119c0 -19 -45 -130 -167 -130c-115 0 -220 97 -220 231c0 125 92 228 208 228c125 0 179 -97 179 -196c0 -21 -3 -21 -25 -21h-279c0 -36 0 -102 30 -150c23 -37 63 -67 113 -67c10 0 100 0 135 103c2 8 4 14 13 14c5 0 13 -2 13 -12zM349 252 c0 39 -10 174 -113 174c-34 0 -118 -25 -124 -174h237Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-63"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-6F" x="444" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-73" x="945" y="0"></use>
<g transform="translate(1672,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D703" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-65" x="663" y="-213"></use>
</g>
</g>
</svg></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1726" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1726"><i></i></a><div id="fragbit-1726" class="collapse show"><div class="fragmentcode">          Float sinTheta_o = <a href="../Utilities/Mathematical_Infrastructure.html#SafeSqrt" class="code">SafeSqrt</a>(1 - <a href="../Utilities/Mathematical_Infrastructure.html#Sqr" class="code">Sqr</a>(cosTheta_o));
          Float cosTheta_x =
              cosSubClamped(sinTheta_w, cosTheta_w, sinTheta_o, cosTheta_o);
          Float sinTheta_x =
              sinSubClamped(sinTheta_w, cosTheta_w, sinTheta_o, cosTheta_o);
          Float cosThetap =
              cosSubClamped(sinTheta_x, cosTheta_x, sinTheta_b, cosTheta_b);
          if (cosThetap &lt;= cosTheta_e)
              return 0;</div></div>
       &lt;&lt;<span class="fragmentname"><a href="#fragment-Returnfinalimportanceatreferencepoint-0">Return final importance at reference point</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1727" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1727"><i></i></a><div id="fragbit-1727" class="collapse show"><div class="fragmentcode">          Float importance = phi * cosThetap / d2;
          &lt;&lt;<span class="fragmentname"><a href="#fragment-Accountforcostheta_romaniinimportanceatsurfaces-0">Account for <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.278ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 2272.6 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">cosine theta Subscript normal i</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-63" d="M415 119c0 -10 -32 -130 -166 -130c-116 0 -215 99 -215 227c0 124 92 232 217 232c77 0 153 -39 153 -107c0 -30 -20 -47 -46 -47c-28 0 -46 20 -46 46c0 13 6 43 47 46c-35 36 -98 37 -107 37c-53 0 -135 -42 -135 -205c0 -161 88 -204 141 -204c37 0 102 12 131 105 c2 6 4 10 13 10c3 0 13 0 13 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6F" d="M471 214c0 -127 -101 -225 -222 -225c-117 0 -221 96 -221 225c0 125 97 234 222 234c121 0 221 -106 221 -234zM388 222c0 38 0 96 -26 139s-69 65 -113 65c-40 0 -87 -21 -114 -67c-24 -44 -24 -98 -24 -137c0 -36 0 -97 25 -141c27 -46 71 -67 114 -67 c50 0 94 29 116 74c22 44 22 98 22 134Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-73" d="M360 128c0 -72 -46 -139 -161 -139c-21 0 -66 1 -110 43c-18 -19 -18 -21 -20 -23c-19 -19 -20 -20 -25 -20c-11 0 -11 7 -11 24v132c0 18 0 25 13 25c10 0 11 -4 14 -17c19 -85 55 -142 139 -142c78 0 113 40 113 91c0 72 -82 88 -104 92c-72 14 -100 20 -132 46 c-27 22 -43 50 -43 85c0 56 38 123 160 123c15 0 56 0 94 -28c4 3 14 12 17 16c13 12 15 12 20 12c11 0 11 -7 11 -24v-101c0 -19 0 -24 -13 -24c0 0 -11 0 -12 9c-2 31 -7 121 -117 121c-86 0 -112 -41 -112 -76c0 -58 67 -71 123 -82c42 -8 81 -16 114 -48 c12 -12 42 -42 42 -95Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D703" d="M455 500c0 -224 -152 -511 -293 -511c-91 0 -120 111 -120 205c0 229 154 511 293 511c102 0 120 -139 120 -205zM389 562c0 57 -6 121 -55 121c-45 0 -82 -56 -109 -105c-40 -71 -60 -151 -77 -215h209c24 99 32 150 32 199zM348 331h-208c-26 -98 -32 -156 -32 -198 c0 -93 21 -122 54 -122c43 0 81 49 116 117c38 72 59 157 70 203Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-69" d="M247 0c-34 1 -69 3 -104 3l-110 -3v31c67 0 78 0 78 45v269c0 49 -9 55 -74 55v31l140 11v-367c0 -39 4 -44 70 -44v-31zM192 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-63"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-6F" x="444" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-73" x="945" y="0"></use>
<g transform="translate(1506,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D703" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="663" y="-213"></use>
</g>
</g>
</svg> in importance at surfaces</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1728" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1728"><i></i></a><div id="fragbit-1728" class="collapse show"><div class="fragmentcode">             if (n != <a href="../Geometry_and_Transformations/Normals.html#Normal3f" class="code">Normal3f</a>(0, 0, 0)) {
                 Float cosTheta_i = <a href="../Geometry_and_Transformations/Vectors.html#AbsDot" class="code">AbsDot</a>(wi, n);
                 Float sinTheta_i = <a href="../Utilities/Mathematical_Infrastructure.html#SafeSqrt" class="code">SafeSqrt</a>(1 - <a href="../Utilities/Mathematical_Infrastructure.html#Sqr" class="code">Sqr</a>(cosTheta_i));
                 Float cosThetap_i = cosSubClamped(sinTheta_i, cosTheta_i,
                                                   sinTheta_b, cosTheta_b);
                 importance *= cosThetap_i;
             }</div></div> 
          return importance;</div></div></div></div>
}</div><p>


</p>
<p>It is necessary to make a number of assumptions in order to estimate the
amount of light arriving at a point given a <tt>LightBounds</tt>.  While it
will be possible to make use of principles such as the received power
falling off with the squared distance from the emitter or the incident
irradiance at a surface varying according to Lambert&rsquo;s law, some
approximations are inevitable, given the loss of specifics that comes with
adopting the <tt>LightBounds</tt> representation.

</p>
<p></p>
<span class="anchor" id="fragment-Returnimportanceforlightboundsatreferencepoint-0"></span><div class="fragmentname">&lt;&lt;Return importance for light bounds at reference point&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">&lt;&lt;<span class="fragmentname"><a href="#fragment-Computeclampedsquareddistancetoreferencepoint-0">Compute clamped squared distance to reference point</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1729" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1729"><i></i></a><div id="fragbit-1729" class="collapse show"><div class="fragmentcode">   <a href="../Geometry_and_Transformations/Points.html#Point3f" class="code">Point3f</a> pc = (<a href="#LightBounds::bounds" class="code">bounds</a>.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3::pMin" class="code">pMin</a> + <a href="#LightBounds::bounds" class="code">bounds</a>.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3::pMax" class="code">pMax</a>) / 2;
   Float d2 = <a href="../Geometry_and_Transformations/Points.html#DistanceSquared" class="code">DistanceSquared</a>(p, pc);
   d2 = std::max(d2, <a href="../Geometry_and_Transformations/Vectors.html#Length" class="code">Length</a>(<a href="#LightBounds::bounds" class="code">bounds</a>.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3::Diagonal" class="code">Diagonal</a>()) / 2);</div></div>
&lt;&lt;<span class="fragmentname"><a href="#fragment-Definecosineandsineclampedsubtractionlambdas-0">Define cosine and sine clamped subtraction lambdas</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1730" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1730"><i></i></a><div id="fragbit-1730" class="collapse show"><div class="fragmentcode">   auto cosSubClamped = [](Float sinTheta_a, Float cosTheta_a,
                           Float sinTheta_b, Float cosTheta_b) -&gt; Float {
       if (cosTheta_a &gt; cosTheta_b)
           return 1;
       return cosTheta_a * cosTheta_b + sinTheta_a * sinTheta_b;
   };
   auto sinSubClamped = [](Float sinTheta_a, Float cosTheta_a,
                           Float sinTheta_b, Float cosTheta_b) -&gt; Float {
       if (cosTheta_a &gt; cosTheta_b)
           return 0;
       return sinTheta_a * cosTheta_b - cosTheta_a * sinTheta_b;
   };</div></div>
&lt;&lt;<span class="fragmentname"><a href="#fragment-Computesineandcosineofangletovectormonowtheta_romanw-0">Compute sine and cosine of angle to vector <tt>w</tt>, <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.509ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 1080.4 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">theta Subscript normal w</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D703" d="M455 500c0 -224 -152 -511 -293 -511c-91 0 -120 111 -120 205c0 229 154 511 293 511c102 0 120 -139 120 -205zM389 562c0 57 -6 121 -55 121c-45 0 -82 -56 -109 -105c-40 -71 -60 -151 -77 -215h209c24 99 32 150 32 199zM348 331h-208c-26 -98 -32 -156 -32 -198 c0 -93 21 -122 54 -122c43 0 81 49 116 117c38 72 59 157 70 203Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-77" d="M703 400c-35 -1 -66 -14 -84 -64l-117 -328c-4 -10 -7 -19 -20 -19s-16 8 -20 19l-102 284l-101 -283c-5 -14 -7 -20 -20 -20s-16 8 -21 22l-126 354c-12 32 -24 35 -74 35v31l93 -3l109 3v-31c-20 0 -59 0 -59 -27c0 -4 0 -6 5 -18l95 -267l86 242c-7 19 -18 49 -23 55 c-10 13 -26 15 -63 15v31c30 -2 59 -3 89 -3l104 3v-31c-20 0 -59 0 -59 -27c0 -5 1 -7 5 -19l99 -279l91 256c5 13 5 15 5 21c0 29 -22 47 -58 48v31l93 -3c22 0 51 1 73 3v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D703" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-77" x="663" y="-213"></use>
</g>
</svg></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1731" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1731"><i></i></a><div id="fragbit-1731" class="collapse show"><div class="fragmentcode">   <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> wi = <a href="../Geometry_and_Transformations/Vectors.html#Normalize" class="code">Normalize</a>(p - pc);
   Float cosTheta_w = <a href="../Geometry_and_Transformations/Vectors.html#Dot" class="code">Dot</a>(<a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a>(<a href="#LightBounds::w" class="code">w</a>), wi);
   if (<a href="#LightBounds::twoSided" class="code">twoSided</a>)
       cosTheta_w = std::abs(cosTheta_w);
   Float sinTheta_w = <a href="../Utilities/Mathematical_Infrastructure.html#SafeSqrt" class="code">SafeSqrt</a>(1 - <a href="../Utilities/Mathematical_Infrastructure.html#Sqr" class="code">Sqr</a>(cosTheta_w));</div></div>
&lt;&lt;<span class="fragmentname"><a href="#fragment-Computecostheta_romanbforreferencepoint-0">Compute <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="6.509ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 2802.5 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">cosine theta Subscript normal b</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-63" d="M415 119c0 -10 -32 -130 -166 -130c-116 0 -215 99 -215 227c0 124 92 232 217 232c77 0 153 -39 153 -107c0 -30 -20 -47 -46 -47c-28 0 -46 20 -46 46c0 13 6 43 47 46c-35 36 -98 37 -107 37c-53 0 -135 -42 -135 -205c0 -161 88 -204 141 -204c37 0 102 12 131 105 c2 6 4 10 13 10c3 0 13 0 13 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6F" d="M471 214c0 -127 -101 -225 -222 -225c-117 0 -221 96 -221 225c0 125 97 234 222 234c121 0 221 -106 221 -234zM388 222c0 38 0 96 -26 139s-69 65 -113 65c-40 0 -87 -21 -114 -67c-24 -44 -24 -98 -24 -137c0 -36 0 -97 25 -141c27 -46 71 -67 114 -67 c50 0 94 29 116 74c22 44 22 98 22 134Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-73" d="M360 128c0 -72 -46 -139 -161 -139c-21 0 -66 1 -110 43c-18 -19 -18 -21 -20 -23c-19 -19 -20 -20 -25 -20c-11 0 -11 7 -11 24v132c0 18 0 25 13 25c10 0 11 -4 14 -17c19 -85 55 -142 139 -142c78 0 113 40 113 91c0 72 -82 88 -104 92c-72 14 -100 20 -132 46 c-27 22 -43 50 -43 85c0 56 38 123 160 123c15 0 56 0 94 -28c4 3 14 12 17 16c13 12 15 12 20 12c11 0 11 -7 11 -24v-101c0 -19 0 -24 -13 -24c0 0 -11 0 -12 9c-2 31 -7 121 -117 121c-86 0 -112 -41 -112 -76c0 -58 67 -71 123 -82c42 -8 81 -16 114 -48 c12 -12 42 -42 42 -95Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D703" d="M455 500c0 -224 -152 -511 -293 -511c-91 0 -120 111 -120 205c0 229 154 511 293 511c102 0 120 -139 120 -205zM389 562c0 57 -6 121 -55 121c-45 0 -82 -56 -109 -105c-40 -71 -60 -151 -77 -215h209c24 99 32 150 32 199zM348 331h-208c-26 -98 -32 -156 -32 -198 c0 -93 21 -122 54 -122c43 0 81 49 116 117c38 72 59 157 70 203Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-62" d="M521 216c0 -129 -104 -227 -223 -227c-74 0 -116 50 -131 73l-36 -62h-25v596c0 49 -8 56 -78 56v31l144 11v-317c16 18 59 65 137 65c114 0 212 -99 212 -226zM438 217c0 41 -3 98 -29 139c-24 38 -60 64 -105 64c-24 0 -79 -8 -118 -64c-11 -16 -11 -17 -11 -36v-206 c0 -18 0 -21 14 -42c24 -37 60 -61 105 -61c54 0 92 33 113 64c29 45 31 105 31 142Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-63"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-6F" x="444" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-73" x="945" y="0"></use>
<g transform="translate(1672,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D703" x="0" y="0"></use>
<g transform="translate(469,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-62" x="235" y="0"></use>
</g>
</g>
</g>
</svg> for reference point</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1732" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1732"><i></i></a><div id="fragbit-1732" class="collapse show"><div class="fragmentcode">   Float cosTheta_b = <a href="../Geometry_and_Transformations/Spherical_Geometry.html#DirectionCone::BoundSubtendedDirections" class="code">BoundSubtendedDirections</a>(<a href="#LightBounds::bounds" class="code">bounds</a>, p).<a href="../Geometry_and_Transformations/Spherical_Geometry.html#DirectionCone::cosTheta" class="code">cosTheta</a>;
   Float sinTheta_b = <a href="../Utilities/Mathematical_Infrastructure.html#SafeSqrt" class="code">SafeSqrt</a>(1 - <a href="../Utilities/Mathematical_Infrastructure.html#Sqr" class="code">Sqr</a>(cosTheta_b));</div></div>
&lt;&lt;<span class="fragmentname"><a href="#fragment-Computecosthetaandtestagainstcostheta_romane-0">Compute <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.877ex" height="2.343ex" style="vertical-align: -0.338ex;" viewBox="0 -863.1 2530.5 1008.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">cosine theta prime</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-63" d="M415 119c0 -10 -32 -130 -166 -130c-116 0 -215 99 -215 227c0 124 92 232 217 232c77 0 153 -39 153 -107c0 -30 -20 -47 -46 -47c-28 0 -46 20 -46 46c0 13 6 43 47 46c-35 36 -98 37 -107 37c-53 0 -135 -42 -135 -205c0 -161 88 -204 141 -204c37 0 102 12 131 105 c2 6 4 10 13 10c3 0 13 0 13 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6F" d="M471 214c0 -127 -101 -225 -222 -225c-117 0 -221 96 -221 225c0 125 97 234 222 234c121 0 221 -106 221 -234zM388 222c0 38 0 96 -26 139s-69 65 -113 65c-40 0 -87 -21 -114 -67c-24 -44 -24 -98 -24 -137c0 -36 0 -97 25 -141c27 -46 71 -67 114 -67 c50 0 94 29 116 74c22 44 22 98 22 134Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-73" d="M360 128c0 -72 -46 -139 -161 -139c-21 0 -66 1 -110 43c-18 -19 -18 -21 -20 -23c-19 -19 -20 -20 -25 -20c-11 0 -11 7 -11 24v132c0 18 0 25 13 25c10 0 11 -4 14 -17c19 -85 55 -142 139 -142c78 0 113 40 113 91c0 72 -82 88 -104 92c-72 14 -100 20 -132 46 c-27 22 -43 50 -43 85c0 56 38 123 160 123c15 0 56 0 94 -28c4 3 14 12 17 16c13 12 15 12 20 12c11 0 11 -7 11 -24v-101c0 -19 0 -24 -13 -24c0 0 -11 0 -12 9c-2 31 -7 121 -117 121c-86 0 -112 -41 -112 -76c0 -58 67 -71 123 -82c42 -8 81 -16 114 -48 c12 -12 42 -42 42 -95Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D703" d="M455 500c0 -224 -152 -511 -293 -511c-91 0 -120 111 -120 205c0 229 154 511 293 511c102 0 120 -139 120 -205zM389 562c0 57 -6 121 -55 121c-45 0 -82 -56 -109 -105c-40 -71 -60 -151 -77 -215h209c24 99 32 150 32 199zM348 331h-208c-26 -98 -32 -156 -32 -198 c0 -93 21 -122 54 -122c43 0 81 49 116 117c38 72 59 157 70 203Z"></path>
<path stroke-width="1" id="E1-LATINMODERNVARIANTS-2032" d="M340 496c0 -10 -3 -20 -8 -28l-227 -372h-38l171 424c6 15 26 29 48 29c30 0 54 -24 54 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-63"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-6F" x="444" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-73" x="945" y="0"></use>
<g transform="translate(1672,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D703" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNVARIANTS-2032" x="663" y="513"></use>
</g>
</g>
</svg> and test against <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.938ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 2556.6 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">cosine theta Subscript normal e</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-63" d="M415 119c0 -10 -32 -130 -166 -130c-116 0 -215 99 -215 227c0 124 92 232 217 232c77 0 153 -39 153 -107c0 -30 -20 -47 -46 -47c-28 0 -46 20 -46 46c0 13 6 43 47 46c-35 36 -98 37 -107 37c-53 0 -135 -42 -135 -205c0 -161 88 -204 141 -204c37 0 102 12 131 105 c2 6 4 10 13 10c3 0 13 0 13 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6F" d="M471 214c0 -127 -101 -225 -222 -225c-117 0 -221 96 -221 225c0 125 97 234 222 234c121 0 221 -106 221 -234zM388 222c0 38 0 96 -26 139s-69 65 -113 65c-40 0 -87 -21 -114 -67c-24 -44 -24 -98 -24 -137c0 -36 0 -97 25 -141c27 -46 71 -67 114 -67 c50 0 94 29 116 74c22 44 22 98 22 134Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-73" d="M360 128c0 -72 -46 -139 -161 -139c-21 0 -66 1 -110 43c-18 -19 -18 -21 -20 -23c-19 -19 -20 -20 -25 -20c-11 0 -11 7 -11 24v132c0 18 0 25 13 25c10 0 11 -4 14 -17c19 -85 55 -142 139 -142c78 0 113 40 113 91c0 72 -82 88 -104 92c-72 14 -100 20 -132 46 c-27 22 -43 50 -43 85c0 56 38 123 160 123c15 0 56 0 94 -28c4 3 14 12 17 16c13 12 15 12 20 12c11 0 11 -7 11 -24v-101c0 -19 0 -24 -13 -24c0 0 -11 0 -12 9c-2 31 -7 121 -117 121c-86 0 -112 -41 -112 -76c0 -58 67 -71 123 -82c42 -8 81 -16 114 -48 c12 -12 42 -42 42 -95Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D703" d="M455 500c0 -224 -152 -511 -293 -511c-91 0 -120 111 -120 205c0 229 154 511 293 511c102 0 120 -139 120 -205zM389 562c0 57 -6 121 -55 121c-45 0 -82 -56 -109 -105c-40 -71 -60 -151 -77 -215h209c24 99 32 150 32 199zM348 331h-208c-26 -98 -32 -156 -32 -198 c0 -93 21 -122 54 -122c43 0 81 49 116 117c38 72 59 157 70 203Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-65" d="M415 119c0 -19 -45 -130 -167 -130c-115 0 -220 97 -220 231c0 125 92 228 208 228c125 0 179 -97 179 -196c0 -21 -3 -21 -25 -21h-279c0 -36 0 -102 30 -150c23 -37 63 -67 113 -67c10 0 100 0 135 103c2 8 4 14 13 14c5 0 13 -2 13 -12zM349 252 c0 39 -10 174 -113 174c-34 0 -118 -25 -124 -174h237Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-63"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-6F" x="444" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-73" x="945" y="0"></use>
<g transform="translate(1672,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D703" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-65" x="663" y="-213"></use>
</g>
</g>
</svg></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1733" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1733"><i></i></a><div id="fragbit-1733" class="collapse show"><div class="fragmentcode">   Float sinTheta_o = <a href="../Utilities/Mathematical_Infrastructure.html#SafeSqrt" class="code">SafeSqrt</a>(1 - <a href="../Utilities/Mathematical_Infrastructure.html#Sqr" class="code">Sqr</a>(cosTheta_o));
   Float cosTheta_x =
       cosSubClamped(sinTheta_w, cosTheta_w, sinTheta_o, cosTheta_o);
   Float sinTheta_x =
       sinSubClamped(sinTheta_w, cosTheta_w, sinTheta_o, cosTheta_o);
   Float cosThetap =
       cosSubClamped(sinTheta_x, cosTheta_x, sinTheta_b, cosTheta_b);
   if (cosThetap &lt;= cosTheta_e)
       return 0;</div></div>
&lt;&lt;<span class="fragmentname"><a href="#fragment-Returnfinalimportanceatreferencepoint-0">Return final importance at reference point</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1734" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1734"><i></i></a><div id="fragbit-1734" class="collapse show"><div class="fragmentcode">   Float importance = phi * cosThetap / d2;
   &lt;&lt;<span class="fragmentname"><a href="#fragment-Accountforcostheta_romaniinimportanceatsurfaces-0">Account for <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.278ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 2272.6 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">cosine theta Subscript normal i</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-63" d="M415 119c0 -10 -32 -130 -166 -130c-116 0 -215 99 -215 227c0 124 92 232 217 232c77 0 153 -39 153 -107c0 -30 -20 -47 -46 -47c-28 0 -46 20 -46 46c0 13 6 43 47 46c-35 36 -98 37 -107 37c-53 0 -135 -42 -135 -205c0 -161 88 -204 141 -204c37 0 102 12 131 105 c2 6 4 10 13 10c3 0 13 0 13 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6F" d="M471 214c0 -127 -101 -225 -222 -225c-117 0 -221 96 -221 225c0 125 97 234 222 234c121 0 221 -106 221 -234zM388 222c0 38 0 96 -26 139s-69 65 -113 65c-40 0 -87 -21 -114 -67c-24 -44 -24 -98 -24 -137c0 -36 0 -97 25 -141c27 -46 71 -67 114 -67 c50 0 94 29 116 74c22 44 22 98 22 134Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-73" d="M360 128c0 -72 -46 -139 -161 -139c-21 0 -66 1 -110 43c-18 -19 -18 -21 -20 -23c-19 -19 -20 -20 -25 -20c-11 0 -11 7 -11 24v132c0 18 0 25 13 25c10 0 11 -4 14 -17c19 -85 55 -142 139 -142c78 0 113 40 113 91c0 72 -82 88 -104 92c-72 14 -100 20 -132 46 c-27 22 -43 50 -43 85c0 56 38 123 160 123c15 0 56 0 94 -28c4 3 14 12 17 16c13 12 15 12 20 12c11 0 11 -7 11 -24v-101c0 -19 0 -24 -13 -24c0 0 -11 0 -12 9c-2 31 -7 121 -117 121c-86 0 -112 -41 -112 -76c0 -58 67 -71 123 -82c42 -8 81 -16 114 -48 c12 -12 42 -42 42 -95Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D703" d="M455 500c0 -224 -152 -511 -293 -511c-91 0 -120 111 -120 205c0 229 154 511 293 511c102 0 120 -139 120 -205zM389 562c0 57 -6 121 -55 121c-45 0 -82 -56 -109 -105c-40 -71 -60 -151 -77 -215h209c24 99 32 150 32 199zM348 331h-208c-26 -98 -32 -156 -32 -198 c0 -93 21 -122 54 -122c43 0 81 49 116 117c38 72 59 157 70 203Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-69" d="M247 0c-34 1 -69 3 -104 3l-110 -3v31c67 0 78 0 78 45v269c0 49 -9 55 -74 55v31l140 11v-367c0 -39 4 -44 70 -44v-31zM192 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-63"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-6F" x="444" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-73" x="945" y="0"></use>
<g transform="translate(1506,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D703" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="663" y="-213"></use>
</g>
</g>
</svg> in importance at surfaces</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1735" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1735"><i></i></a><div id="fragbit-1735" class="collapse show"><div class="fragmentcode">      if (n != <a href="../Geometry_and_Transformations/Normals.html#Normal3f" class="code">Normal3f</a>(0, 0, 0)) {
          Float cosTheta_i = <a href="../Geometry_and_Transformations/Vectors.html#AbsDot" class="code">AbsDot</a>(wi, n);
          Float sinTheta_i = <a href="../Utilities/Mathematical_Infrastructure.html#SafeSqrt" class="code">SafeSqrt</a>(1 - <a href="../Utilities/Mathematical_Infrastructure.html#Sqr" class="code">Sqr</a>(cosTheta_i));
          Float cosThetap_i = cosSubClamped(sinTheta_i, cosTheta_i,
                                            sinTheta_b, cosTheta_b);
          importance *= cosThetap_i;
      }</div></div> 
   return importance;</div></div></div><p>


</p>
<p>Even computing the squared distance for the falloff of received power is
challenging if <tt>bounds</tt> is not degenerate: to which point in
<tt>bounds</tt> should the distance be computed?  It may seem that finding
the minimum distance from the point <tt>p</tt> to the bounds would be a safe
choice, though this would imply a very small distance for a point close to
the bounds and a zero distance for a point inside it.  Either of these
would lead to a very large <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.428ex" height="3.009ex" style="vertical-align: -0.838ex;" viewBox="0 -934.9 1906.4 1295.7" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">1 slash r squared</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2F" d="M445 730c0 -2 0 -5 -1 -7l-349 -960c-3 -8 -10 -13 -19 -13c-11 0 -20 9 -20 20c0 2 0 5 1 7l349 960c3 8 10 13 19 13c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45F" d="M436 377c0 -36 -28 -59 -55 -59s-38 19 -38 35c0 26 22 50 52 55c0 0 -16 12 -42 12c-43 0 -72 -26 -80 -33c-24 -22 -52 -69 -56 -82l-32 -130c-4 -18 -38 -154 -40 -158c-7 -20 -25 -28 -37 -28c-15 0 -29 9 -29 27c0 5 6 28 9 43l58 231c13 52 16 63 16 84 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c47 0 83 -32 91 -77c19 28 63 77 128 77c51 0 83 -30 83 -65Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-32" d="M449 174l-28 -174h-371c0 24 0 26 11 37l192 214c55 62 105 141 105 221c0 82 -43 163 -134 163c-58 0 -112 -37 -135 -102c3 1 5 1 13 1c35 0 53 -26 53 -52c0 -41 -35 -53 -52 -53c-3 0 -53 0 -53 56c0 89 74 181 187 181c122 0 212 -80 212 -194 c0 -100 -60 -154 -216 -292l-106 -103h180c22 0 88 0 95 8c10 15 17 59 22 89h25Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-31" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2F" x="500" y="0"></use>
<g transform="translate(1001,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45F" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-32" x="638" y="513"></use>
</g>
</g>
</svg> factor and potentially high error due to
giving too much preference to such a <tt>LightBounds</tt>.  Further, choosing
between the two child <tt>LightBounds</tt> of a node when a point is inside
both would be impossible, given infinite weights for each.

</p>
<p>Therefore, our first fudge is to compute the distance from the center of
the bounding box but further to ensure that the squared distance is not too
small with respect to the length of the diagonal of the bounding box.
Thus, for larger bounding boxes with corresponding uncertainty about what
the actual spatial distribution of emission is, the inverse squared distance factor
cannot become too large.

</p>
<p></p>
<span class="anchor" id="fragment-Computeclampedsquareddistancetoreferencepoint-0"></span><div class="fragmentname">&lt;&lt;Compute clamped squared distance to reference point&gt;&gt;=&nbsp;</div>
<div class="fragmentcode"><a href="../Geometry_and_Transformations/Points.html#Point3f" class="code">Point3f</a> pc = (<a href="#LightBounds::bounds" class="code">bounds</a>.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3::pMin" class="code">pMin</a> + <a href="#LightBounds::bounds" class="code">bounds</a>.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3::pMax" class="code">pMax</a>) / 2;
Float d2 = <a href="../Geometry_and_Transformations/Points.html#DistanceSquared" class="code">DistanceSquared</a>(p, pc);
d2 = std::max(d2, <a href="../Geometry_and_Transformations/Vectors.html#Length" class="code">Length</a>(<a href="#LightBounds::bounds" class="code">bounds</a>.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3::Diagonal" class="code">Diagonal</a>()) / 2);</div><p>


</p>
<p>
In the following computations, we will need to produce a series of values of the
form <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="20.861ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 8981.7 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">cosine left-parenthesis max left-parenthesis 0 comma theta Subscript normal a Baseline minus theta Subscript normal b Baseline right-parenthesis right-parenthesis</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E2-LATINMODERNMAIN-63" d="M415 119c0 -10 -32 -130 -166 -130c-116 0 -215 99 -215 227c0 124 92 232 217 232c77 0 153 -39 153 -107c0 -30 -20 -47 -46 -47c-28 0 -46 20 -46 46c0 13 6 43 47 46c-35 36 -98 37 -107 37c-53 0 -135 -42 -135 -205c0 -161 88 -204 141 -204c37 0 102 12 131 105 c2 6 4 10 13 10c3 0 13 0 13 -10Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-6F" d="M471 214c0 -127 -101 -225 -222 -225c-117 0 -221 96 -221 225c0 125 97 234 222 234c121 0 221 -106 221 -234zM388 222c0 38 0 96 -26 139s-69 65 -113 65c-40 0 -87 -21 -114 -67c-24 -44 -24 -98 -24 -137c0 -36 0 -97 25 -141c27 -46 71 -67 114 -67 c50 0 94 29 116 74c22 44 22 98 22 134Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-73" d="M360 128c0 -72 -46 -139 -161 -139c-21 0 -66 1 -110 43c-18 -19 -18 -21 -20 -23c-19 -19 -20 -20 -25 -20c-11 0 -11 7 -11 24v132c0 18 0 25 13 25c10 0 11 -4 14 -17c19 -85 55 -142 139 -142c78 0 113 40 113 91c0 72 -82 88 -104 92c-72 14 -100 20 -132 46 c-27 22 -43 50 -43 85c0 56 38 123 160 123c15 0 56 0 94 -28c4 3 14 12 17 16c13 12 15 12 20 12c11 0 11 -7 11 -24v-101c0 -19 0 -24 -13 -24c0 0 -11 0 -12 9c-2 31 -7 121 -117 121c-86 0 -112 -41 -112 -76c0 -58 67 -71 123 -82c42 -8 81 -16 114 -48 c12 -12 42 -42 42 -95Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-6D" d="M813 0l-112 3l-113 -3v31c67 0 78 0 78 45v233c0 57 -11 111 -74 111c-64 0 -135 -56 -135 -160v-184c0 -45 11 -45 78 -45v-31l-112 3l-113 -3v31c67 0 78 0 78 45v233c0 57 -11 111 -74 111c-64 0 -135 -56 -135 -160v-184c0 -45 11 -45 78 -45v-31l-112 3l-113 -3v31 c67 0 78 0 78 45v268c0 49 -8 56 -78 56v31l141 11v-105c28 62 75 105 148 105c45 0 119 -11 133 -98c17 38 61 98 145 98c58 0 91 -20 105 -37c31 -36 31 -67 31 -153v-191c1 -30 26 -30 78 -30v-31Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-61" d="M483 89c0 -81 -61 -95 -82 -95c-47 0 -74 42 -78 82c-19 -47 -65 -87 -131 -87c-63 0 -160 25 -160 106c0 44 25 96 100 130c63 30 133 33 184 36v37c0 89 -57 128 -106 128c-32 0 -81 -11 -108 -46c46 -1 51 -34 51 -46c0 -26 -18 -46 -46 -46c-26 0 -46 17 -46 47 c0 66 69 113 151 113c48 0 98 -16 137 -55c36 -37 36 -76 36 -118v-200c0 -5 4 -50 37 -50c11 0 36 6 36 64v56h25v-56zM316 140v100c-165 -6 -207 -89 -207 -144c0 -50 41 -85 90 -85c45 0 117 34 117 129Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-78" d="M516 0c-30 2 -69 3 -96 3l-108 -3v31c27 1 36 16 36 25c0 6 -13 22 -21 33l-76 100c-61 -72 -90 -105 -90 -127c0 -15 7 -28 29 -31v-31l-95 3c-26 0 -57 -1 -83 -3v31c21 0 80 2 128 60c47 57 47 59 94 119l-99 129c-47 60 -48 61 -118 61v31c27 -2 74 -3 95 -3l108 3 v-31c-20 -1 -35 -10 -35 -25c0 -6 0 -8 9 -18l78 -101l62 78c5 6 15 19 15 35s-8 29 -29 31v31c13 -1 66 -3 96 -3c26 0 56 1 82 3v-31c-47 -1 -88 -16 -119 -52c-24 -26 -62 -75 -92 -113l134 -173c23 -29 41 -31 95 -31v-31Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-30" d="M460 320c0 -79 -5 -157 -37 -226c-44 -95 -120 -116 -174 -116c-49 0 -122 20 -165 101c-41 76 -45 166 -45 241c0 80 5 158 37 227c41 93 114 119 174 119c42 0 124 -16 170 -112c35 -74 40 -154 40 -234zM377 332c0 63 0 139 -10 195c-19 99 -85 117 -118 117 c-25 0 -100 -9 -119 -128c-8 -54 -8 -120 -8 -184c0 -59 0 -151 11 -211c18 -96 77 -121 116 -121c45 0 102 30 117 125c11 64 11 132 11 207Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E2-LATINMODERNNORMAL-1D703" d="M455 500c0 -224 -152 -511 -293 -511c-91 0 -120 111 -120 205c0 229 154 511 293 511c102 0 120 -139 120 -205zM389 562c0 57 -6 121 -55 121c-45 0 -82 -56 -109 -105c-40 -71 -60 -151 -77 -215h209c24 99 32 150 32 199zM348 331h-208c-26 -98 -32 -156 -32 -198 c0 -93 21 -122 54 -122c43 0 81 49 116 117c38 72 59 157 70 203Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-2212" d="M722 250c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-62" d="M521 216c0 -129 -104 -227 -223 -227c-74 0 -116 50 -131 73l-36 -62h-25v596c0 49 -8 56 -78 56v31l144 11v-317c16 18 59 65 137 65c114 0 212 -99 212 -226zM438 217c0 41 -3 98 -29 139c-24 38 -60 64 -105 64c-24 0 -79 -8 -118 -64c-11 -16 -11 -17 -11 -36v-206 c0 -18 0 -21 14 -42c24 -37 60 -61 105 -61c54 0 92 33 113 64c29 45 31 105 31 142Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E2-LATINMODERNMAIN-63"></use>
 <use xlink:href="#E2-LATINMODERNMAIN-6F" x="444" y="0"></use>
 <use xlink:href="#E2-LATINMODERNMAIN-73" x="945" y="0"></use>
 <use xlink:href="#E2-LATINMODERNMAIN-28" x="1339" y="0"></use>
<g transform="translate(1729,0)">
 <use xlink:href="#E2-LATINMODERNMAIN-6D"></use>
 <use xlink:href="#E2-LATINMODERNMAIN-61" x="833" y="0"></use>
 <use xlink:href="#E2-LATINMODERNMAIN-78" x="1334" y="0"></use>
</g>
 <use xlink:href="#E2-LATINMODERNMAIN-28" x="3591" y="0"></use>
 <use xlink:href="#E2-LATINMODERNMAIN-30" x="3981" y="0"></use>
 <use xlink:href="#E2-LATINMODERNMAIN-2C" x="4481" y="0"></use>
<g transform="translate(4926,0)">
 <use xlink:href="#E2-LATINMODERNNORMAL-1D703" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E2-LATINMODERNMAIN-61" x="663" y="-213"></use>
</g>
 <use xlink:href="#E2-LATINMODERNMAIN-2212" x="6072" y="0"></use>
<g transform="translate(7073,0)">
 <use xlink:href="#E2-LATINMODERNNORMAL-1D703" x="0" y="0"></use>
<g transform="translate(469,-150)">
 <use transform="scale(0.707)" xlink:href="#E2-LATINMODERNMAIN-62" x="235" y="0"></use>
</g>
</g>
 <use xlink:href="#E2-LATINMODERNMAIN-29" x="8202" y="0"></use>
 <use xlink:href="#E2-LATINMODERNMAIN-29" x="8592" y="0"></use>
</g>
</svg> and <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="20.605ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 8871.7 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">sine left-parenthesis max left-parenthesis 0 comma theta Subscript normal a Baseline minus theta Subscript normal b Baseline right-parenthesis right-parenthesis</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E2-LATINMODERNMAIN-73" d="M360 128c0 -72 -46 -139 -161 -139c-21 0 -66 1 -110 43c-18 -19 -18 -21 -20 -23c-19 -19 -20 -20 -25 -20c-11 0 -11 7 -11 24v132c0 18 0 25 13 25c10 0 11 -4 14 -17c19 -85 55 -142 139 -142c78 0 113 40 113 91c0 72 -82 88 -104 92c-72 14 -100 20 -132 46 c-27 22 -43 50 -43 85c0 56 38 123 160 123c15 0 56 0 94 -28c4 3 14 12 17 16c13 12 15 12 20 12c11 0 11 -7 11 -24v-101c0 -19 0 -24 -13 -24c0 0 -11 0 -12 9c-2 31 -7 121 -117 121c-86 0 -112 -41 -112 -76c0 -58 67 -71 123 -82c42 -8 81 -16 114 -48 c12 -12 42 -42 42 -95Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-69" d="M247 0c-34 1 -69 3 -104 3l-110 -3v31c67 0 78 0 78 45v269c0 49 -9 55 -74 55v31l140 11v-367c0 -39 4 -44 70 -44v-31zM192 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-6E" d="M535 0l-112 3l-113 -3v31c67 0 78 0 78 45v233c0 57 -11 111 -74 111c-64 0 -135 -56 -135 -160v-184c0 -45 11 -45 78 -45v-31l-112 3l-113 -3v31c67 0 78 0 78 45v268c0 49 -8 56 -78 56v31l141 11v-105c28 62 75 105 148 105c58 0 91 -20 105 -37 c31 -36 31 -67 31 -153v-191c1 -30 26 -30 78 -30v-31Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-6D" d="M813 0l-112 3l-113 -3v31c67 0 78 0 78 45v233c0 57 -11 111 -74 111c-64 0 -135 -56 -135 -160v-184c0 -45 11 -45 78 -45v-31l-112 3l-113 -3v31c67 0 78 0 78 45v233c0 57 -11 111 -74 111c-64 0 -135 -56 -135 -160v-184c0 -45 11 -45 78 -45v-31l-112 3l-113 -3v31 c67 0 78 0 78 45v268c0 49 -8 56 -78 56v31l141 11v-105c28 62 75 105 148 105c45 0 119 -11 133 -98c17 38 61 98 145 98c58 0 91 -20 105 -37c31 -36 31 -67 31 -153v-191c1 -30 26 -30 78 -30v-31Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-61" d="M483 89c0 -81 -61 -95 -82 -95c-47 0 -74 42 -78 82c-19 -47 -65 -87 -131 -87c-63 0 -160 25 -160 106c0 44 25 96 100 130c63 30 133 33 184 36v37c0 89 -57 128 -106 128c-32 0 -81 -11 -108 -46c46 -1 51 -34 51 -46c0 -26 -18 -46 -46 -46c-26 0 -46 17 -46 47 c0 66 69 113 151 113c48 0 98 -16 137 -55c36 -37 36 -76 36 -118v-200c0 -5 4 -50 37 -50c11 0 36 6 36 64v56h25v-56zM316 140v100c-165 -6 -207 -89 -207 -144c0 -50 41 -85 90 -85c45 0 117 34 117 129Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-78" d="M516 0c-30 2 -69 3 -96 3l-108 -3v31c27 1 36 16 36 25c0 6 -13 22 -21 33l-76 100c-61 -72 -90 -105 -90 -127c0 -15 7 -28 29 -31v-31l-95 3c-26 0 -57 -1 -83 -3v31c21 0 80 2 128 60c47 57 47 59 94 119l-99 129c-47 60 -48 61 -118 61v31c27 -2 74 -3 95 -3l108 3 v-31c-20 -1 -35 -10 -35 -25c0 -6 0 -8 9 -18l78 -101l62 78c5 6 15 19 15 35s-8 29 -29 31v31c13 -1 66 -3 96 -3c26 0 56 1 82 3v-31c-47 -1 -88 -16 -119 -52c-24 -26 -62 -75 -92 -113l134 -173c23 -29 41 -31 95 -31v-31Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-30" d="M460 320c0 -79 -5 -157 -37 -226c-44 -95 -120 -116 -174 -116c-49 0 -122 20 -165 101c-41 76 -45 166 -45 241c0 80 5 158 37 227c41 93 114 119 174 119c42 0 124 -16 170 -112c35 -74 40 -154 40 -234zM377 332c0 63 0 139 -10 195c-19 99 -85 117 -118 117 c-25 0 -100 -9 -119 -128c-8 -54 -8 -120 -8 -184c0 -59 0 -151 11 -211c18 -96 77 -121 116 -121c45 0 102 30 117 125c11 64 11 132 11 207Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E2-LATINMODERNNORMAL-1D703" d="M455 500c0 -224 -152 -511 -293 -511c-91 0 -120 111 -120 205c0 229 154 511 293 511c102 0 120 -139 120 -205zM389 562c0 57 -6 121 -55 121c-45 0 -82 -56 -109 -105c-40 -71 -60 -151 -77 -215h209c24 99 32 150 32 199zM348 331h-208c-26 -98 -32 -156 -32 -198 c0 -93 21 -122 54 -122c43 0 81 49 116 117c38 72 59 157 70 203Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-2212" d="M722 250c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-62" d="M521 216c0 -129 -104 -227 -223 -227c-74 0 -116 50 -131 73l-36 -62h-25v596c0 49 -8 56 -78 56v31l144 11v-317c16 18 59 65 137 65c114 0 212 -99 212 -226zM438 217c0 41 -3 98 -29 139c-24 38 -60 64 -105 64c-24 0 -79 -8 -118 -64c-11 -16 -11 -17 -11 -36v-206 c0 -18 0 -21 14 -42c24 -37 60 -61 105 -61c54 0 92 33 113 64c29 45 31 105 31 142Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E2-LATINMODERNMAIN-73"></use>
 <use xlink:href="#E2-LATINMODERNMAIN-69" x="394" y="0"></use>
 <use xlink:href="#E2-LATINMODERNMAIN-6E" x="673" y="0"></use>
 <use xlink:href="#E2-LATINMODERNMAIN-28" x="1229" y="0"></use>
<g transform="translate(1619,0)">
 <use xlink:href="#E2-LATINMODERNMAIN-6D"></use>
 <use xlink:href="#E2-LATINMODERNMAIN-61" x="833" y="0"></use>
 <use xlink:href="#E2-LATINMODERNMAIN-78" x="1334" y="0"></use>
</g>
 <use xlink:href="#E2-LATINMODERNMAIN-28" x="3481" y="0"></use>
 <use xlink:href="#E2-LATINMODERNMAIN-30" x="3871" y="0"></use>
 <use xlink:href="#E2-LATINMODERNMAIN-2C" x="4371" y="0"></use>
<g transform="translate(4816,0)">
 <use xlink:href="#E2-LATINMODERNNORMAL-1D703" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E2-LATINMODERNMAIN-61" x="663" y="-213"></use>
</g>
 <use xlink:href="#E2-LATINMODERNMAIN-2212" x="5962" y="0"></use>
<g transform="translate(6963,0)">
 <use xlink:href="#E2-LATINMODERNNORMAL-1D703" x="0" y="0"></use>
<g transform="translate(469,-150)">
 <use transform="scale(0.707)" xlink:href="#E2-LATINMODERNMAIN-62" x="235" y="0"></use>
</g>
</g>
 <use xlink:href="#E2-LATINMODERNMAIN-29" x="8092" y="0"></use>
 <use xlink:href="#E2-LATINMODERNMAIN-29" x="8482" y="0"></use>
</g>
</svg>.  Given the sine and cosine of
<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.145ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 923.4 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">theta Subscript normal a</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D703" d="M455 500c0 -224 -152 -511 -293 -511c-91 0 -120 111 -120 205c0 229 154 511 293 511c102 0 120 -139 120 -205zM389 562c0 57 -6 121 -55 121c-45 0 -82 -56 -109 -105c-40 -71 -60 -151 -77 -215h209c24 99 32 150 32 199zM348 331h-208c-26 -98 -32 -156 -32 -198 c0 -93 21 -122 54 -122c43 0 81 49 116 117c38 72 59 157 70 203Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-61" d="M483 89c0 -81 -61 -95 -82 -95c-47 0 -74 42 -78 82c-19 -47 -65 -87 -131 -87c-63 0 -160 25 -160 106c0 44 25 96 100 130c63 30 133 33 184 36v37c0 89 -57 128 -106 128c-32 0 -81 -11 -108 -46c46 -1 51 -34 51 -46c0 -26 -18 -46 -46 -46c-26 0 -46 17 -46 47 c0 66 69 113 151 113c48 0 98 -16 137 -55c36 -37 36 -76 36 -118v-200c0 -5 4 -50 37 -50c11 0 36 6 36 64v56h25v-56zM316 140v100c-165 -6 -207 -89 -207 -144c0 -50 41 -85 90 -85c45 0 117 34 117 129Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D703" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-61" x="663" y="-213"></use>
</g>
</svg> and <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.624ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 1129.7 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">theta Subscript normal b</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D703" d="M455 500c0 -224 -152 -511 -293 -511c-91 0 -120 111 -120 205c0 229 154 511 293 511c102 0 120 -139 120 -205zM389 562c0 57 -6 121 -55 121c-45 0 -82 -56 -109 -105c-40 -71 -60 -151 -77 -215h209c24 99 32 150 32 199zM348 331h-208c-26 -98 -32 -156 -32 -198 c0 -93 21 -122 54 -122c43 0 81 49 116 117c38 72 59 157 70 203Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-62" d="M521 216c0 -129 -104 -227 -223 -227c-74 0 -116 50 -131 73l-36 -62h-25v596c0 49 -8 56 -78 56v31l144 11v-317c16 18 59 65 137 65c114 0 212 -99 212 -226zM438 217c0 41 -3 98 -29 139c-24 38 -60 64 -105 64c-24 0 -79 -8 -118 -64c-11 -16 -11 -17 -11 -36v-206 c0 -18 0 -21 14 -42c24 -37 60 -61 105 -61c54 0 92 33 113 64c29 45 31 105 31 142Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D703" x="0" y="0"></use>
<g transform="translate(469,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-62" x="235" y="0"></use>
</g>
</g>
</svg>, it is possible to do so without
evaluating any trigonometric functions.  To see how, consider the cosine:
<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="11.87ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 5110.6 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">theta Subscript normal a Baseline minus theta Subscript normal b Baseline less-than 0</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D703" d="M455 500c0 -224 -152 -511 -293 -511c-91 0 -120 111 -120 205c0 229 154 511 293 511c102 0 120 -139 120 -205zM389 562c0 57 -6 121 -55 121c-45 0 -82 -56 -109 -105c-40 -71 -60 -151 -77 -215h209c24 99 32 150 32 199zM348 331h-208c-26 -98 -32 -156 -32 -198 c0 -93 21 -122 54 -122c43 0 81 49 116 117c38 72 59 157 70 203Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-61" d="M483 89c0 -81 -61 -95 -82 -95c-47 0 -74 42 -78 82c-19 -47 -65 -87 -131 -87c-63 0 -160 25 -160 106c0 44 25 96 100 130c63 30 133 33 184 36v37c0 89 -57 128 -106 128c-32 0 -81 -11 -108 -46c46 -1 51 -34 51 -46c0 -26 -18 -46 -46 -46c-26 0 -46 17 -46 47 c0 66 69 113 151 113c48 0 98 -16 137 -55c36 -37 36 -76 36 -118v-200c0 -5 4 -50 37 -50c11 0 36 6 36 64v56h25v-56zM316 140v100c-165 -6 -207 -89 -207 -144c0 -50 41 -85 90 -85c45 0 117 34 117 129Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2212" d="M722 250c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-62" d="M521 216c0 -129 -104 -227 -223 -227c-74 0 -116 50 -131 73l-36 -62h-25v596c0 49 -8 56 -78 56v31l144 11v-317c16 18 59 65 137 65c114 0 212 -99 212 -226zM438 217c0 41 -3 98 -29 139c-24 38 -60 64 -105 64c-24 0 -79 -8 -118 -64c-11 -16 -11 -17 -11 -36v-206 c0 -18 0 -21 14 -42c24 -37 60 -61 105 -61c54 0 92 33 113 64c29 45 31 105 31 142Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3C" d="M689 -9c24 -11 7 -47 -18 -36l-581 275c-17 8 -17 32 0 40l581 275c25 11 42 -25 18 -36l-548 -259Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-30" d="M460 320c0 -79 -5 -157 -37 -226c-44 -95 -120 -116 -174 -116c-49 0 -122 20 -165 101c-41 76 -45 166 -45 241c0 80 5 158 37 227c41 93 114 119 174 119c42 0 124 -16 170 -112c35 -74 40 -154 40 -234zM377 332c0 63 0 139 -10 195c-19 99 -85 117 -118 117 c-25 0 -100 -9 -119 -128c-8 -54 -8 -120 -8 -184c0 -59 0 -151 11 -211c18 -96 77 -121 116 -121c45 0 102 30 117 125c11 64 11 132 11 207Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D703" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-61" x="663" y="-213"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2212" x="1145" y="0"></use>
<g transform="translate(2146,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D703" x="0" y="0"></use>
<g transform="translate(469,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-62" x="235" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-3C" x="3553" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-30" x="4610" y="0"></use>
</g>
</svg> implies that
<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="7.867ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 3387.1 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">theta Subscript normal a Baseline less-than theta Subscript normal b</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D703" d="M455 500c0 -224 -152 -511 -293 -511c-91 0 -120 111 -120 205c0 229 154 511 293 511c102 0 120 -139 120 -205zM389 562c0 57 -6 121 -55 121c-45 0 -82 -56 -109 -105c-40 -71 -60 -151 -77 -215h209c24 99 32 150 32 199zM348 331h-208c-26 -98 -32 -156 -32 -198 c0 -93 21 -122 54 -122c43 0 81 49 116 117c38 72 59 157 70 203Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-61" d="M483 89c0 -81 -61 -95 -82 -95c-47 0 -74 42 -78 82c-19 -47 -65 -87 -131 -87c-63 0 -160 25 -160 106c0 44 25 96 100 130c63 30 133 33 184 36v37c0 89 -57 128 -106 128c-32 0 -81 -11 -108 -46c46 -1 51 -34 51 -46c0 -26 -18 -46 -46 -46c-26 0 -46 17 -46 47 c0 66 69 113 151 113c48 0 98 -16 137 -55c36 -37 36 -76 36 -118v-200c0 -5 4 -50 37 -50c11 0 36 6 36 64v56h25v-56zM316 140v100c-165 -6 -207 -89 -207 -144c0 -50 41 -85 90 -85c45 0 117 34 117 129Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3C" d="M689 -9c24 -11 7 -47 -18 -36l-581 275c-17 8 -17 32 0 40l581 275c25 11 42 -25 18 -36l-548 -259Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-62" d="M521 216c0 -129 -104 -227 -223 -227c-74 0 -116 50 -131 73l-36 -62h-25v596c0 49 -8 56 -78 56v31l144 11v-317c16 18 59 65 137 65c114 0 212 -99 212 -226zM438 217c0 41 -3 98 -29 139c-24 38 -60 64 -105 64c-24 0 -79 -8 -118 -64c-11 -16 -11 -17 -11 -36v-206 c0 -18 0 -21 14 -42c24 -37 60 -61 105 -61c54 0 92 33 113 64c29 45 31 105 31 142Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D703" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-61" x="663" y="-213"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-3C" x="1201" y="0"></use>
<g transform="translate(2257,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D703" x="0" y="0"></use>
<g transform="translate(469,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-62" x="235" y="0"></use>
</g>
</g>
</g>
</svg> and that therefore <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="14.863ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 6399.5 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">cosine theta Subscript normal a Baseline greater-than cosine theta Subscript normal b</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-63" d="M415 119c0 -10 -32 -130 -166 -130c-116 0 -215 99 -215 227c0 124 92 232 217 232c77 0 153 -39 153 -107c0 -30 -20 -47 -46 -47c-28 0 -46 20 -46 46c0 13 6 43 47 46c-35 36 -98 37 -107 37c-53 0 -135 -42 -135 -205c0 -161 88 -204 141 -204c37 0 102 12 131 105 c2 6 4 10 13 10c3 0 13 0 13 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6F" d="M471 214c0 -127 -101 -225 -222 -225c-117 0 -221 96 -221 225c0 125 97 234 222 234c121 0 221 -106 221 -234zM388 222c0 38 0 96 -26 139s-69 65 -113 65c-40 0 -87 -21 -114 -67c-24 -44 -24 -98 -24 -137c0 -36 0 -97 25 -141c27 -46 71 -67 114 -67 c50 0 94 29 116 74c22 44 22 98 22 134Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-73" d="M360 128c0 -72 -46 -139 -161 -139c-21 0 -66 1 -110 43c-18 -19 -18 -21 -20 -23c-19 -19 -20 -20 -25 -20c-11 0 -11 7 -11 24v132c0 18 0 25 13 25c10 0 11 -4 14 -17c19 -85 55 -142 139 -142c78 0 113 40 113 91c0 72 -82 88 -104 92c-72 14 -100 20 -132 46 c-27 22 -43 50 -43 85c0 56 38 123 160 123c15 0 56 0 94 -28c4 3 14 12 17 16c13 12 15 12 20 12c11 0 11 -7 11 -24v-101c0 -19 0 -24 -13 -24c0 0 -11 0 -12 9c-2 31 -7 121 -117 121c-86 0 -112 -41 -112 -76c0 -58 67 -71 123 -82c42 -8 81 -16 114 -48 c12 -12 42 -42 42 -95Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D703" d="M455 500c0 -224 -152 -511 -293 -511c-91 0 -120 111 -120 205c0 229 154 511 293 511c102 0 120 -139 120 -205zM389 562c0 57 -6 121 -55 121c-45 0 -82 -56 -109 -105c-40 -71 -60 -151 -77 -215h209c24 99 32 150 32 199zM348 331h-208c-26 -98 -32 -156 -32 -198 c0 -93 21 -122 54 -122c43 0 81 49 116 117c38 72 59 157 70 203Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-61" d="M483 89c0 -81 -61 -95 -82 -95c-47 0 -74 42 -78 82c-19 -47 -65 -87 -131 -87c-63 0 -160 25 -160 106c0 44 25 96 100 130c63 30 133 33 184 36v37c0 89 -57 128 -106 128c-32 0 -81 -11 -108 -46c46 -1 51 -34 51 -46c0 -26 -18 -46 -46 -46c-26 0 -46 17 -46 47 c0 66 69 113 151 113c48 0 98 -16 137 -55c36 -37 36 -76 36 -118v-200c0 -5 4 -50 37 -50c11 0 36 6 36 64v56h25v-56zM316 140v100c-165 -6 -207 -89 -207 -144c0 -50 41 -85 90 -85c45 0 117 34 117 129Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3E" d="M688 230l-581 -275c-25 -11 -42 25 -18 36l548 259l-548 259c-24 11 -7 47 18 36l581 -275c17 -8 17 -32 0 -40Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-62" d="M521 216c0 -129 -104 -227 -223 -227c-74 0 -116 50 -131 73l-36 -62h-25v596c0 49 -8 56 -78 56v31l144 11v-317c16 18 59 65 137 65c114 0 212 -99 212 -226zM438 217c0 41 -3 98 -29 139c-24 38 -60 64 -105 64c-24 0 -79 -8 -118 -64c-11 -16 -11 -17 -11 -36v-206 c0 -18 0 -21 14 -42c24 -37 60 -61 105 -61c54 0 92 33 113 64c29 45 31 105 31 142Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-63"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-6F" x="444" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-73" x="945" y="0"></use>
<g transform="translate(1506,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D703" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-61" x="663" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-3E" x="2707" y="0"></use>
<g transform="translate(3763,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-63"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-6F" x="444" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-73" x="945" y="0"></use>
</g>
<g transform="translate(5269,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D703" x="0" y="0"></use>
<g transform="translate(469,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-62" x="235" y="0"></use>
</g>
</g>
</g>
</svg>.  We thus start by checking
that case and returning <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="8.922ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 3841.2 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">cosine 0 equals 1</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-63" d="M415 119c0 -10 -32 -130 -166 -130c-116 0 -215 99 -215 227c0 124 92 232 217 232c77 0 153 -39 153 -107c0 -30 -20 -47 -46 -47c-28 0 -46 20 -46 46c0 13 6 43 47 46c-35 36 -98 37 -107 37c-53 0 -135 -42 -135 -205c0 -161 88 -204 141 -204c37 0 102 12 131 105 c2 6 4 10 13 10c3 0 13 0 13 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6F" d="M471 214c0 -127 -101 -225 -222 -225c-117 0 -221 96 -221 225c0 125 97 234 222 234c121 0 221 -106 221 -234zM388 222c0 38 0 96 -26 139s-69 65 -113 65c-40 0 -87 -21 -114 -67c-24 -44 -24 -98 -24 -137c0 -36 0 -97 25 -141c27 -46 71 -67 114 -67 c50 0 94 29 116 74c22 44 22 98 22 134Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-73" d="M360 128c0 -72 -46 -139 -161 -139c-21 0 -66 1 -110 43c-18 -19 -18 -21 -20 -23c-19 -19 -20 -20 -25 -20c-11 0 -11 7 -11 24v132c0 18 0 25 13 25c10 0 11 -4 14 -17c19 -85 55 -142 139 -142c78 0 113 40 113 91c0 72 -82 88 -104 92c-72 14 -100 20 -132 46 c-27 22 -43 50 -43 85c0 56 38 123 160 123c15 0 56 0 94 -28c4 3 14 12 17 16c13 12 15 12 20 12c11 0 11 -7 11 -24v-101c0 -19 0 -24 -13 -24c0 0 -11 0 -12 9c-2 31 -7 121 -117 121c-86 0 -112 -41 -112 -76c0 -58 67 -71 123 -82c42 -8 81 -16 114 -48 c12 -12 42 -42 42 -95Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-30" d="M460 320c0 -79 -5 -157 -37 -226c-44 -95 -120 -116 -174 -116c-49 0 -122 20 -165 101c-41 76 -45 166 -45 241c0 80 5 158 37 227c41 93 114 119 174 119c42 0 124 -16 170 -112c35 -74 40 -154 40 -234zM377 332c0 63 0 139 -10 195c-19 99 -85 117 -118 117 c-25 0 -100 -9 -119 -128c-8 -54 -8 -120 -8 -184c0 -59 0 -151 11 -211c18 -96 77 -121 116 -121c45 0 102 30 117 125c11 64 11 132 11 207Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3D" d="M722 347c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20zM722 153c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-63"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-6F" x="444" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-73" x="945" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-30" x="1506" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="2284" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-31" x="3340" y="0"></use>
</g>
</svg> if it is true.  We are otherwise left
with <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="12.529ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 5394.5 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">cosine left-parenthesis theta Subscript normal a Baseline minus theta Subscript normal b Baseline right-parenthesis</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-63" d="M415 119c0 -10 -32 -130 -166 -130c-116 0 -215 99 -215 227c0 124 92 232 217 232c77 0 153 -39 153 -107c0 -30 -20 -47 -46 -47c-28 0 -46 20 -46 46c0 13 6 43 47 46c-35 36 -98 37 -107 37c-53 0 -135 -42 -135 -205c0 -161 88 -204 141 -204c37 0 102 12 131 105 c2 6 4 10 13 10c3 0 13 0 13 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6F" d="M471 214c0 -127 -101 -225 -222 -225c-117 0 -221 96 -221 225c0 125 97 234 222 234c121 0 221 -106 221 -234zM388 222c0 38 0 96 -26 139s-69 65 -113 65c-40 0 -87 -21 -114 -67c-24 -44 -24 -98 -24 -137c0 -36 0 -97 25 -141c27 -46 71 -67 114 -67 c50 0 94 29 116 74c22 44 22 98 22 134Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-73" d="M360 128c0 -72 -46 -139 -161 -139c-21 0 -66 1 -110 43c-18 -19 -18 -21 -20 -23c-19 -19 -20 -20 -25 -20c-11 0 -11 7 -11 24v132c0 18 0 25 13 25c10 0 11 -4 14 -17c19 -85 55 -142 139 -142c78 0 113 40 113 91c0 72 -82 88 -104 92c-72 14 -100 20 -132 46 c-27 22 -43 50 -43 85c0 56 38 123 160 123c15 0 56 0 94 -28c4 3 14 12 17 16c13 12 15 12 20 12c11 0 11 -7 11 -24v-101c0 -19 0 -24 -13 -24c0 0 -11 0 -12 9c-2 31 -7 121 -117 121c-86 0 -112 -41 -112 -76c0 -58 67 -71 123 -82c42 -8 81 -16 114 -48 c12 -12 42 -42 42 -95Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D703" d="M455 500c0 -224 -152 -511 -293 -511c-91 0 -120 111 -120 205c0 229 154 511 293 511c102 0 120 -139 120 -205zM389 562c0 57 -6 121 -55 121c-45 0 -82 -56 -109 -105c-40 -71 -60 -151 -77 -215h209c24 99 32 150 32 199zM348 331h-208c-26 -98 -32 -156 -32 -198 c0 -93 21 -122 54 -122c43 0 81 49 116 117c38 72 59 157 70 203Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-61" d="M483 89c0 -81 -61 -95 -82 -95c-47 0 -74 42 -78 82c-19 -47 -65 -87 -131 -87c-63 0 -160 25 -160 106c0 44 25 96 100 130c63 30 133 33 184 36v37c0 89 -57 128 -106 128c-32 0 -81 -11 -108 -46c46 -1 51 -34 51 -46c0 -26 -18 -46 -46 -46c-26 0 -46 17 -46 47 c0 66 69 113 151 113c48 0 98 -16 137 -55c36 -37 36 -76 36 -118v-200c0 -5 4 -50 37 -50c11 0 36 6 36 64v56h25v-56zM316 140v100c-165 -6 -207 -89 -207 -144c0 -50 41 -85 90 -85c45 0 117 34 117 129Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2212" d="M722 250c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-62" d="M521 216c0 -129 -104 -227 -223 -227c-74 0 -116 50 -131 73l-36 -62h-25v596c0 49 -8 56 -78 56v31l144 11v-317c16 18 59 65 137 65c114 0 212 -99 212 -226zM438 217c0 41 -3 98 -29 139c-24 38 -60 64 -105 64c-24 0 -79 -8 -118 -64c-11 -16 -11 -17 -11 -36v-206 c0 -18 0 -21 14 -42c24 -37 60 -61 105 -61c54 0 92 33 113 64c29 45 31 105 31 142Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-63"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-6F" x="444" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-73" x="945" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="1339" y="0"></use>
<g transform="translate(1729,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D703" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-61" x="663" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2212" x="2874" y="0"></use>
<g transform="translate(3875,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D703" x="0" y="0"></use>
<g transform="translate(469,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-62" x="235" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="5005" y="0"></use>
</g>
</svg>, which can be expressed in
terms of the sines and cosines of the two angles using a trigonometric
identity, <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="26.633ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 11467.1 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">cosine theta Subscript normal a cosine theta Subscript normal b plus sine theta Subscript normal a sine theta Subscript normal b</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-63" d="M415 119c0 -10 -32 -130 -166 -130c-116 0 -215 99 -215 227c0 124 92 232 217 232c77 0 153 -39 153 -107c0 -30 -20 -47 -46 -47c-28 0 -46 20 -46 46c0 13 6 43 47 46c-35 36 -98 37 -107 37c-53 0 -135 -42 -135 -205c0 -161 88 -204 141 -204c37 0 102 12 131 105 c2 6 4 10 13 10c3 0 13 0 13 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6F" d="M471 214c0 -127 -101 -225 -222 -225c-117 0 -221 96 -221 225c0 125 97 234 222 234c121 0 221 -106 221 -234zM388 222c0 38 0 96 -26 139s-69 65 -113 65c-40 0 -87 -21 -114 -67c-24 -44 -24 -98 -24 -137c0 -36 0 -97 25 -141c27 -46 71 -67 114 -67 c50 0 94 29 116 74c22 44 22 98 22 134Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-73" d="M360 128c0 -72 -46 -139 -161 -139c-21 0 -66 1 -110 43c-18 -19 -18 -21 -20 -23c-19 -19 -20 -20 -25 -20c-11 0 -11 7 -11 24v132c0 18 0 25 13 25c10 0 11 -4 14 -17c19 -85 55 -142 139 -142c78 0 113 40 113 91c0 72 -82 88 -104 92c-72 14 -100 20 -132 46 c-27 22 -43 50 -43 85c0 56 38 123 160 123c15 0 56 0 94 -28c4 3 14 12 17 16c13 12 15 12 20 12c11 0 11 -7 11 -24v-101c0 -19 0 -24 -13 -24c0 0 -11 0 -12 9c-2 31 -7 121 -117 121c-86 0 -112 -41 -112 -76c0 -58 67 -71 123 -82c42 -8 81 -16 114 -48 c12 -12 42 -42 42 -95Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D703" d="M455 500c0 -224 -152 -511 -293 -511c-91 0 -120 111 -120 205c0 229 154 511 293 511c102 0 120 -139 120 -205zM389 562c0 57 -6 121 -55 121c-45 0 -82 -56 -109 -105c-40 -71 -60 -151 -77 -215h209c24 99 32 150 32 199zM348 331h-208c-26 -98 -32 -156 -32 -198 c0 -93 21 -122 54 -122c43 0 81 49 116 117c38 72 59 157 70 203Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-61" d="M483 89c0 -81 -61 -95 -82 -95c-47 0 -74 42 -78 82c-19 -47 -65 -87 -131 -87c-63 0 -160 25 -160 106c0 44 25 96 100 130c63 30 133 33 184 36v37c0 89 -57 128 -106 128c-32 0 -81 -11 -108 -46c46 -1 51 -34 51 -46c0 -26 -18 -46 -46 -46c-26 0 -46 17 -46 47 c0 66 69 113 151 113c48 0 98 -16 137 -55c36 -37 36 -76 36 -118v-200c0 -5 4 -50 37 -50c11 0 36 6 36 64v56h25v-56zM316 140v100c-165 -6 -207 -89 -207 -144c0 -50 41 -85 90 -85c45 0 117 34 117 129Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-62" d="M521 216c0 -129 -104 -227 -223 -227c-74 0 -116 50 -131 73l-36 -62h-25v596c0 49 -8 56 -78 56v31l144 11v-317c16 18 59 65 137 65c114 0 212 -99 212 -226zM438 217c0 41 -3 98 -29 139c-24 38 -60 64 -105 64c-24 0 -79 -8 -118 -64c-11 -16 -11 -17 -11 -36v-206 c0 -18 0 -21 14 -42c24 -37 60 -61 105 -61c54 0 92 33 113 64c29 45 31 105 31 142Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2B" d="M722 250c0 -11 -9 -20 -20 -20h-293v-293c0 -11 -9 -20 -20 -20s-20 9 -20 20v293h-293c-11 0 -20 9 -20 20s9 20 20 20h293v293c0 11 9 20 20 20s20 -9 20 -20v-293h293c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-69" d="M247 0c-34 1 -69 3 -104 3l-110 -3v31c67 0 78 0 78 45v269c0 49 -9 55 -74 55v31l140 11v-367c0 -39 4 -44 70 -44v-31zM192 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6E" d="M535 0l-112 3l-113 -3v31c67 0 78 0 78 45v233c0 57 -11 111 -74 111c-64 0 -135 -56 -135 -160v-184c0 -45 11 -45 78 -45v-31l-112 3l-113 -3v31c67 0 78 0 78 45v268c0 49 -8 56 -78 56v31l141 11v-105c28 62 75 105 148 105c58 0 91 -20 105 -37 c31 -36 31 -67 31 -153v-191c1 -30 26 -30 78 -30v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-63"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-6F" x="444" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-73" x="945" y="0"></use>
<g transform="translate(1506,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D703" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-61" x="663" y="-213"></use>
</g>
<g transform="translate(2596,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-63"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-6F" x="444" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-73" x="945" y="0"></use>
</g>
<g transform="translate(4102,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D703" x="0" y="0"></use>
<g transform="translate(469,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-62" x="235" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2B" x="5454" y="0"></use>
<g transform="translate(6455,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-73"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-69" x="394" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-6E" x="673" y="0"></use>
</g>
<g transform="translate(7851,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D703" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-61" x="663" y="-213"></use>
</g>
<g transform="translate(8941,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-73"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-69" x="394" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-6E" x="673" y="0"></use>
</g>
<g transform="translate(10337,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D703" x="0" y="0"></use>
<g transform="translate(469,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-62" x="235" y="0"></use>
</g>
</g>
</g>
</svg>.  The case for sine follows
analogously.

</p>
<p>Two simple lambda functions provide these capabilities.  (Only the one for
cosine is included in the text, as <tt>sinSubClamped</tt> follows a similar
form.)

</p>
<p></p>
<span class="anchor" id="fragment-Definecosineandsineclampedsubtractionlambdas-0"></span><div class="fragmentname">&lt;&lt;Define cosine and sine clamped subtraction lambdas&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">auto cosSubClamped = [](Float sinTheta_a, Float cosTheta_a,
                        Float sinTheta_b, Float cosTheta_b) -&gt; Float {
    if (cosTheta_a &gt; cosTheta_b)
        return 1;
    return cosTheta_a * cosTheta_b + sinTheta_a * sinTheta_b;
};</div><p>


</p>
<p>

</p>
<p>There are a number of angles involved in the importance computation.  In
addition to the ones that specify the directional emission bounds,
<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.145ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 923.4 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">theta Subscript normal o</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D703" d="M455 500c0 -224 -152 -511 -293 -511c-91 0 -120 111 -120 205c0 229 154 511 293 511c102 0 120 -139 120 -205zM389 562c0 57 -6 121 -55 121c-45 0 -82 -56 -109 -105c-40 -71 -60 -151 -77 -215h209c24 99 32 150 32 199zM348 331h-208c-26 -98 -32 -156 -32 -198 c0 -93 21 -122 54 -122c43 0 81 49 116 117c38 72 59 157 70 203Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6F" d="M471 214c0 -127 -101 -225 -222 -225c-117 0 -221 96 -221 225c0 125 97 234 222 234c121 0 221 -106 221 -234zM388 222c0 38 0 96 -26 139s-69 65 -113 65c-40 0 -87 -21 -114 -67c-24 -44 -24 -98 -24 -137c0 -36 0 -97 25 -141c27 -46 71 -67 114 -67 c50 0 94 29 116 74c22 44 22 98 22 134Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D703" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6F" x="663" y="-213"></use>
</g>
</svg> and <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.053ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 883.8 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">theta Subscript normal e</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D703" d="M455 500c0 -224 -152 -511 -293 -511c-91 0 -120 111 -120 205c0 229 154 511 293 511c102 0 120 -139 120 -205zM389 562c0 57 -6 121 -55 121c-45 0 -82 -56 -109 -105c-40 -71 -60 -151 -77 -215h209c24 99 32 150 32 199zM348 331h-208c-26 -98 -32 -156 -32 -198 c0 -93 21 -122 54 -122c43 0 81 49 116 117c38 72 59 157 70 203Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-65" d="M415 119c0 -19 -45 -130 -167 -130c-115 0 -220 97 -220 231c0 125 92 228 208 228c125 0 179 -97 179 -196c0 -21 -3 -21 -25 -21h-279c0 -36 0 -102 30 -150c23 -37 63 -67 113 -67c10 0 100 0 135 103c2 8 4 14 13 14c5 0 13 -2 13 -12zM349 252 c0 39 -10 174 -113 174c-34 0 -118 -25 -124 -174h237Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D703" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-65" x="663" y="-213"></use>
</g>
</svg>, we will start by computing the
sine and cosine of <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.509ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 1080.4 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">theta Subscript normal w</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D703" d="M455 500c0 -224 -152 -511 -293 -511c-91 0 -120 111 -120 205c0 229 154 511 293 511c102 0 120 -139 120 -205zM389 562c0 57 -6 121 -55 121c-45 0 -82 -56 -109 -105c-40 -71 -60 -151 -77 -215h209c24 99 32 150 32 199zM348 331h-208c-26 -98 -32 -156 -32 -198 c0 -93 21 -122 54 -122c43 0 81 49 116 117c38 72 59 157 70 203Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-77" d="M703 400c-35 -1 -66 -14 -84 -64l-117 -328c-4 -10 -7 -19 -20 -19s-16 8 -20 19l-102 284l-101 -283c-5 -14 -7 -20 -20 -20s-16 8 -21 22l-126 354c-12 32 -24 35 -74 35v31l93 -3l109 3v-31c-20 0 -59 0 -59 -27c0 -4 0 -6 5 -18l95 -267l86 242c-7 19 -18 49 -23 55 c-10 13 -26 15 -63 15v31c30 -2 59 -3 89 -3l104 3v-31c-20 0 -59 0 -59 -27c0 -5 1 -7 5 -19l99 -279l91 256c5 13 5 15 5 21c0 29 -22 47 -58 48v31l93 -3c22 0 51 1 73 3v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D703" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-77" x="663" y="-213"></use>
</g>
</svg>, the angle between the principal
normal direction and the vector from the center of the light bounds to the
reference point (Figure&nbsp;<a href="#fig:light-bounds-thetaw-thetab">12.26</a>(a)).

</p>
<p> </p>
<span class="anchor" id="fig:light-bounds-thetaw-thetab"></span><div class="card outerfigure"><div class="card-body figure"><p>



</p>
<div class="figure-row">
  <a href="pha12f26.svg" title=""><img src="pha12f26.svg" width=406 height=180 style="max-width: 100%;"></a>
</div>
<p>


</p>
<figcaption class="caption">Figure 12.26: <span class="legend">
(a)&nbsp;<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.509ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 1080.4 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">theta Subscript normal w</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D703" d="M455 500c0 -224 -152 -511 -293 -511c-91 0 -120 111 -120 205c0 229 154 511 293 511c102 0 120 -139 120 -205zM389 562c0 57 -6 121 -55 121c-45 0 -82 -56 -109 -105c-40 -71 -60 -151 -77 -215h209c24 99 32 150 32 199zM348 331h-208c-26 -98 -32 -156 -32 -198 c0 -93 21 -122 54 -122c43 0 81 49 116 117c38 72 59 157 70 203Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-77" d="M703 400c-35 -1 -66 -14 -84 -64l-117 -328c-4 -10 -7 -19 -20 -19s-16 8 -20 19l-102 284l-101 -283c-5 -14 -7 -20 -20 -20s-16 8 -21 22l-126 354c-12 32 -24 35 -74 35v31l93 -3l109 3v-31c-20 0 -59 0 -59 -27c0 -4 0 -6 5 -18l95 -267l86 242c-7 19 -18 49 -23 55 c-10 13 -26 15 -63 15v31c30 -2 59 -3 89 -3l104 3v-31c-20 0 -59 0 -59 -27c0 -5 1 -7 5 -19l99 -279l91 256c5 13 5 15 5 21c0 29 -22 47 -58 48v31l93 -3c22 0 51 1 73 3v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D703" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-77" x="663" y="-213"></use>
</g>
</svg> measures the angle between the principal normal
direction <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.446ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 622.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">omega Subscript</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
</g>
</svg> and the vector from the center of the bounding box to the
reference point.
(b)&nbsp;<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.237ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 963 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">theta Subscript normal b</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D703" d="M455 500c0 -224 -152 -511 -293 -511c-91 0 -120 111 -120 205c0 229 154 511 293 511c102 0 120 -139 120 -205zM389 562c0 57 -6 121 -55 121c-45 0 -82 -56 -109 -105c-40 -71 -60 -151 -77 -215h209c24 99 32 150 32 199zM348 331h-208c-26 -98 -32 -156 -32 -198 c0 -93 21 -122 54 -122c43 0 81 49 116 117c38 72 59 157 70 203Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-62" d="M521 216c0 -129 -104 -227 -223 -227c-74 0 -116 50 -131 73l-36 -62h-25v596c0 49 -8 56 -78 56v31l144 11v-317c16 18 59 65 137 65c114 0 212 -99 212 -226zM438 217c0 41 -3 98 -29 139c-24 38 -60 64 -105 64c-24 0 -79 -8 -118 -64c-11 -16 -11 -17 -11 -36v-206 c0 -18 0 -21 14 -42c24 -37 60 -61 105 -61c54 0 92 33 113 64c29 45 31 105 31 142Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D703" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-62" x="663" y="-213"></use>
</g>
</svg> is the angle that the <tt>LightBounds</tt>&rsquo;s
bounding box, <tt>bounds</tt>, subtends with respect to the reference point.</span>
</figcaption>
</div></div><p>


</p>
<p></p>
<span class="anchor" id="fragment-Computesineandcosineofangletovectormonowtheta_romanw-0"></span><div class="fragmentname">&lt;&lt;Compute sine and cosine of angle to vector <tt>w</tt>, <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.509ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 1080.4 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">theta Subscript normal w</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D703" d="M455 500c0 -224 -152 -511 -293 -511c-91 0 -120 111 -120 205c0 229 154 511 293 511c102 0 120 -139 120 -205zM389 562c0 57 -6 121 -55 121c-45 0 -82 -56 -109 -105c-40 -71 -60 -151 -77 -215h209c24 99 32 150 32 199zM348 331h-208c-26 -98 -32 -156 -32 -198 c0 -93 21 -122 54 -122c43 0 81 49 116 117c38 72 59 157 70 203Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-77" d="M703 400c-35 -1 -66 -14 -84 -64l-117 -328c-4 -10 -7 -19 -20 -19s-16 8 -20 19l-102 284l-101 -283c-5 -14 -7 -20 -20 -20s-16 8 -21 22l-126 354c-12 32 -24 35 -74 35v31l93 -3l109 3v-31c-20 0 -59 0 -59 -27c0 -4 0 -6 5 -18l95 -267l86 242c-7 19 -18 49 -23 55 c-10 13 -26 15 -63 15v31c30 -2 59 -3 89 -3l104 3v-31c-20 0 -59 0 -59 -27c0 -5 1 -7 5 -19l99 -279l91 256c5 13 5 15 5 21c0 29 -22 47 -58 48v31l93 -3c22 0 51 1 73 3v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D703" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-77" x="663" y="-213"></use>
</g>
</svg>&gt;&gt;=&nbsp;</div>
<div class="fragmentcode"><a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> wi = <a href="../Geometry_and_Transformations/Vectors.html#Normalize" class="code">Normalize</a>(p - pc);
Float cosTheta_w = <a href="../Geometry_and_Transformations/Vectors.html#Dot" class="code">Dot</a>(<a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a>(<a href="#LightBounds::w" class="code">w</a>), wi);
if (<a href="#LightBounds::twoSided" class="code">twoSided</a>)
    cosTheta_w = std::abs(cosTheta_w);
Float sinTheta_w = <a href="../Utilities/Mathematical_Infrastructure.html#SafeSqrt" class="code">SafeSqrt</a>(1 - <a href="../Utilities/Mathematical_Infrastructure.html#Sqr" class="code">Sqr</a>(cosTheta_w));</div><p>


</p>
<p>To bound the variation of various angles across the extent of the
bounding box, we will also make use of the angle that the bounding box
subtends with respect to the reference point (see
Figure&nbsp;<a href="#fig:light-bounds-thetaw-thetab">12.26</a>(b)). We
will denote this angle <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.624ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 1129.7 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">theta Subscript normal b</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D703" d="M455 500c0 -224 -152 -511 -293 -511c-91 0 -120 111 -120 205c0 229 154 511 293 511c102 0 120 -139 120 -205zM389 562c0 57 -6 121 -55 121c-45 0 -82 -56 -109 -105c-40 -71 -60 -151 -77 -215h209c24 99 32 150 32 199zM348 331h-208c-26 -98 -32 -156 -32 -198 c0 -93 21 -122 54 -122c43 0 81 49 116 117c38 72 59 157 70 203Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-62" d="M521 216c0 -129 -104 -227 -223 -227c-74 0 -116 50 -131 73l-36 -62h-25v596c0 49 -8 56 -78 56v31l144 11v-317c16 18 59 65 137 65c114 0 212 -99 212 -226zM438 217c0 41 -3 98 -29 139c-24 38 -60 64 -105 64c-24 0 -79 -8 -118 -64c-11 -16 -11 -17 -11 -36v-206 c0 -18 0 -21 14 -42c24 -37 60 -61 105 -61c54 0 92 33 113 64c29 45 31 105 31 142Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D703" x="0" y="0"></use>
<g transform="translate(469,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-62" x="235" y="0"></use>
</g>
</g>
</svg>.  The preexisting
<a href="../Geometry_and_Transformations/Spherical_Geometry.html#DirectionCone::BoundSubtendedDirections"><tt>DirectionCone::BoundSubtendedDirections()</tt></a> function takes care of
computing its cosine.  Its sine follows directly.

</p>
<p></p>
<span class="anchor" id="fragment-Computecostheta_romanbforreferencepoint-0"></span><div class="fragmentname">&lt;&lt;Compute <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="6.509ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 2802.5 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">cosine theta Subscript normal b</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-63" d="M415 119c0 -10 -32 -130 -166 -130c-116 0 -215 99 -215 227c0 124 92 232 217 232c77 0 153 -39 153 -107c0 -30 -20 -47 -46 -47c-28 0 -46 20 -46 46c0 13 6 43 47 46c-35 36 -98 37 -107 37c-53 0 -135 -42 -135 -205c0 -161 88 -204 141 -204c37 0 102 12 131 105 c2 6 4 10 13 10c3 0 13 0 13 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6F" d="M471 214c0 -127 -101 -225 -222 -225c-117 0 -221 96 -221 225c0 125 97 234 222 234c121 0 221 -106 221 -234zM388 222c0 38 0 96 -26 139s-69 65 -113 65c-40 0 -87 -21 -114 -67c-24 -44 -24 -98 -24 -137c0 -36 0 -97 25 -141c27 -46 71 -67 114 -67 c50 0 94 29 116 74c22 44 22 98 22 134Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-73" d="M360 128c0 -72 -46 -139 -161 -139c-21 0 -66 1 -110 43c-18 -19 -18 -21 -20 -23c-19 -19 -20 -20 -25 -20c-11 0 -11 7 -11 24v132c0 18 0 25 13 25c10 0 11 -4 14 -17c19 -85 55 -142 139 -142c78 0 113 40 113 91c0 72 -82 88 -104 92c-72 14 -100 20 -132 46 c-27 22 -43 50 -43 85c0 56 38 123 160 123c15 0 56 0 94 -28c4 3 14 12 17 16c13 12 15 12 20 12c11 0 11 -7 11 -24v-101c0 -19 0 -24 -13 -24c0 0 -11 0 -12 9c-2 31 -7 121 -117 121c-86 0 -112 -41 -112 -76c0 -58 67 -71 123 -82c42 -8 81 -16 114 -48 c12 -12 42 -42 42 -95Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D703" d="M455 500c0 -224 -152 -511 -293 -511c-91 0 -120 111 -120 205c0 229 154 511 293 511c102 0 120 -139 120 -205zM389 562c0 57 -6 121 -55 121c-45 0 -82 -56 -109 -105c-40 -71 -60 -151 -77 -215h209c24 99 32 150 32 199zM348 331h-208c-26 -98 -32 -156 -32 -198 c0 -93 21 -122 54 -122c43 0 81 49 116 117c38 72 59 157 70 203Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-62" d="M521 216c0 -129 -104 -227 -223 -227c-74 0 -116 50 -131 73l-36 -62h-25v596c0 49 -8 56 -78 56v31l144 11v-317c16 18 59 65 137 65c114 0 212 -99 212 -226zM438 217c0 41 -3 98 -29 139c-24 38 -60 64 -105 64c-24 0 -79 -8 -118 -64c-11 -16 -11 -17 -11 -36v-206 c0 -18 0 -21 14 -42c24 -37 60 -61 105 -61c54 0 92 33 113 64c29 45 31 105 31 142Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-63"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-6F" x="444" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-73" x="945" y="0"></use>
<g transform="translate(1672,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D703" x="0" y="0"></use>
<g transform="translate(469,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-62" x="235" y="0"></use>
</g>
</g>
</g>
</svg> for reference point&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">Float cosTheta_b = <a href="../Geometry_and_Transformations/Spherical_Geometry.html#DirectionCone::BoundSubtendedDirections" class="code">BoundSubtendedDirections</a>(<a href="#LightBounds::bounds" class="code">bounds</a>, p).<a href="../Geometry_and_Transformations/Spherical_Geometry.html#DirectionCone::cosTheta" class="code">cosTheta</a>;
Float sinTheta_b = <a href="../Utilities/Mathematical_Infrastructure.html#SafeSqrt" class="code">SafeSqrt</a>(1 - <a href="../Utilities/Mathematical_Infrastructure.html#Sqr" class="code">Sqr</a>(cosTheta_b));</div><p>


</p>
<p>The last angle we will use is the minimum angle between the emitter&rsquo;s
normal and the vector to the reference point.  We will denote it by
<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.992ex" height="2.343ex" style="vertical-align: -0.338ex;" viewBox="0 -863.1 857.6 1008.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">theta prime</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D703" d="M455 500c0 -224 -152 -511 -293 -511c-91 0 -120 111 -120 205c0 229 154 511 293 511c102 0 120 -139 120 -205zM389 562c0 57 -6 121 -55 121c-45 0 -82 -56 -109 -105c-40 -71 -60 -151 -77 -215h209c24 99 32 150 32 199zM348 331h-208c-26 -98 -32 -156 -32 -198 c0 -93 21 -122 54 -122c43 0 81 49 116 117c38 72 59 157 70 203Z"></path>
<path stroke-width="1" id="E1-LATINMODERNVARIANTS-2032" d="M340 496c0 -10 -3 -20 -8 -28l-227 -372h-38l171 424c6 15 26 29 48 29c30 0 54 -24 54 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D703" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNVARIANTS-2032" x="663" y="513"></use>
</g>
</svg>, and it is given by
</p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">
<div class="displaymath"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="27.027ex" height="3.009ex" style="vertical-align: -0.838ex;" viewBox="0 -934.9 11636.7 1295.7" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">theta prime equals max left-parenthesis 0 comma theta Subscript normal w Baseline minus theta Subscript normal o Baseline minus theta Subscript normal b Baseline right-parenthesis semicolon</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E2-LATINMODERNNORMAL-1D703" d="M455 500c0 -224 -152 -511 -293 -511c-91 0 -120 111 -120 205c0 229 154 511 293 511c102 0 120 -139 120 -205zM389 562c0 57 -6 121 -55 121c-45 0 -82 -56 -109 -105c-40 -71 -60 -151 -77 -215h209c24 99 32 150 32 199zM348 331h-208c-26 -98 -32 -156 -32 -198 c0 -93 21 -122 54 -122c43 0 81 49 116 117c38 72 59 157 70 203Z"></path>
<path stroke-width="1" id="E2-LATINMODERNVARIANTS-2032" d="M340 496c0 -10 -3 -20 -8 -28l-227 -372h-38l171 424c6 15 26 29 48 29c30 0 54 -24 54 -53Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-3D" d="M722 347c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20zM722 153c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-6D" d="M813 0l-112 3l-113 -3v31c67 0 78 0 78 45v233c0 57 -11 111 -74 111c-64 0 -135 -56 -135 -160v-184c0 -45 11 -45 78 -45v-31l-112 3l-113 -3v31c67 0 78 0 78 45v233c0 57 -11 111 -74 111c-64 0 -135 -56 -135 -160v-184c0 -45 11 -45 78 -45v-31l-112 3l-113 -3v31 c67 0 78 0 78 45v268c0 49 -8 56 -78 56v31l141 11v-105c28 62 75 105 148 105c45 0 119 -11 133 -98c17 38 61 98 145 98c58 0 91 -20 105 -37c31 -36 31 -67 31 -153v-191c1 -30 26 -30 78 -30v-31Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-61" d="M483 89c0 -81 -61 -95 -82 -95c-47 0 -74 42 -78 82c-19 -47 -65 -87 -131 -87c-63 0 -160 25 -160 106c0 44 25 96 100 130c63 30 133 33 184 36v37c0 89 -57 128 -106 128c-32 0 -81 -11 -108 -46c46 -1 51 -34 51 -46c0 -26 -18 -46 -46 -46c-26 0 -46 17 -46 47 c0 66 69 113 151 113c48 0 98 -16 137 -55c36 -37 36 -76 36 -118v-200c0 -5 4 -50 37 -50c11 0 36 6 36 64v56h25v-56zM316 140v100c-165 -6 -207 -89 -207 -144c0 -50 41 -85 90 -85c45 0 117 34 117 129Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-78" d="M516 0c-30 2 -69 3 -96 3l-108 -3v31c27 1 36 16 36 25c0 6 -13 22 -21 33l-76 100c-61 -72 -90 -105 -90 -127c0 -15 7 -28 29 -31v-31l-95 3c-26 0 -57 -1 -83 -3v31c21 0 80 2 128 60c47 57 47 59 94 119l-99 129c-47 60 -48 61 -118 61v31c27 -2 74 -3 95 -3l108 3 v-31c-20 -1 -35 -10 -35 -25c0 -6 0 -8 9 -18l78 -101l62 78c5 6 15 19 15 35s-8 29 -29 31v31c13 -1 66 -3 96 -3c26 0 56 1 82 3v-31c-47 -1 -88 -16 -119 -52c-24 -26 -62 -75 -92 -113l134 -173c23 -29 41 -31 95 -31v-31Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-30" d="M460 320c0 -79 -5 -157 -37 -226c-44 -95 -120 -116 -174 -116c-49 0 -122 20 -165 101c-41 76 -45 166 -45 241c0 80 5 158 37 227c41 93 114 119 174 119c42 0 124 -16 170 -112c35 -74 40 -154 40 -234zM377 332c0 63 0 139 -10 195c-19 99 -85 117 -118 117 c-25 0 -100 -9 -119 -128c-8 -54 -8 -120 -8 -184c0 -59 0 -151 11 -211c18 -96 77 -121 116 -121c45 0 102 30 117 125c11 64 11 132 11 207Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-77" d="M703 400c-35 -1 -66 -14 -84 -64l-117 -328c-4 -10 -7 -19 -20 -19s-16 8 -20 19l-102 284l-101 -283c-5 -14 -7 -20 -20 -20s-16 8 -21 22l-126 354c-12 32 -24 35 -74 35v31l93 -3l109 3v-31c-20 0 -59 0 -59 -27c0 -4 0 -6 5 -18l95 -267l86 242c-7 19 -18 49 -23 55 c-10 13 -26 15 -63 15v31c30 -2 59 -3 89 -3l104 3v-31c-20 0 -59 0 -59 -27c0 -5 1 -7 5 -19l99 -279l91 256c5 13 5 15 5 21c0 29 -22 47 -58 48v31l93 -3c22 0 51 1 73 3v-31Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-2212" d="M722 250c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-6F" d="M471 214c0 -127 -101 -225 -222 -225c-117 0 -221 96 -221 225c0 125 97 234 222 234c121 0 221 -106 221 -234zM388 222c0 38 0 96 -26 139s-69 65 -113 65c-40 0 -87 -21 -114 -67c-24 -44 -24 -98 -24 -137c0 -36 0 -97 25 -141c27 -46 71 -67 114 -67 c50 0 94 29 116 74c22 44 22 98 22 134Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-62" d="M521 216c0 -129 -104 -227 -223 -227c-74 0 -116 50 -131 73l-36 -62h-25v596c0 49 -8 56 -78 56v31l144 11v-317c16 18 59 65 137 65c114 0 212 -99 212 -226zM438 217c0 41 -3 98 -29 139c-24 38 -60 64 -105 64c-24 0 -79 -8 -118 -64c-11 -16 -11 -17 -11 -36v-206 c0 -18 0 -21 14 -42c24 -37 60 -61 105 -61c54 0 92 33 113 64c29 45 31 105 31 142Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-3B" d="M192 378c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53zM195 3c0 -116 -72 -196 -83 -196c-5 0 -10 4 -10 11c0 3 0 5 7 13c64 74 64 152 64 180c-8 -7 -19 -9 -26 -10c0 0 -3 -1 -8 -1c-36 0 -53 27 -53 53s18 53 53 53c54 0 56 -74 56 -103Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E2-LATINMODERNNORMAL-1D703" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E2-LATINMODERNVARIANTS-2032" x="663" y="583"></use>
 <use xlink:href="#E2-LATINMODERNMAIN-3D" x="1135" y="0"></use>
<g transform="translate(2191,0)">
 <use xlink:href="#E2-LATINMODERNMAIN-6D"></use>
 <use xlink:href="#E2-LATINMODERNMAIN-61" x="833" y="0"></use>
 <use xlink:href="#E2-LATINMODERNMAIN-78" x="1334" y="0"></use>
</g>
 <use xlink:href="#E2-LATINMODERNMAIN-28" x="4054" y="0"></use>
 <use xlink:href="#E2-LATINMODERNMAIN-30" x="4443" y="0"></use>
 <use xlink:href="#E2-LATINMODERNMAIN-2C" x="4944" y="0"></use>
<g transform="translate(5389,0)">
 <use xlink:href="#E2-LATINMODERNNORMAL-1D703" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E2-LATINMODERNMAIN-77" x="663" y="-213"></use>
</g>
 <use xlink:href="#E2-LATINMODERNMAIN-2212" x="6691" y="0"></use>
<g transform="translate(7692,0)">
 <use xlink:href="#E2-LATINMODERNNORMAL-1D703" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E2-LATINMODERNMAIN-6F" x="663" y="-213"></use>
</g>
 <use xlink:href="#E2-LATINMODERNMAIN-2212" x="8838" y="0"></use>
<g transform="translate(9839,0)">
 <use xlink:href="#E2-LATINMODERNNORMAL-1D703" x="0" y="0"></use>
<g transform="translate(469,-150)">
 <use transform="scale(0.707)" xlink:href="#E2-LATINMODERNMAIN-62" x="235" y="0"></use>
</g>
</g>
 <use xlink:href="#E2-LATINMODERNMAIN-29" x="10968" y="0"></use>
 <use xlink:href="#E2-LATINMODERNMAIN-3B" x="11358" y="0"></use>
</g>
</svg>
</div>
<p>

see Figure&nbsp;<a href="#fig:light-bounds-theta-prime">12.27</a>.  As with the other angles,
we only need its sine
and cosine, which can be computed one subtraction at a time.

</p>
<p></p>
<span class="anchor" id="fig:light-bounds-theta-prime"></span><div class="card outerfigure"><div class="card-body figure"><p>



</p>
<div class="figure-row">
  <a href="pha12f27.svg" title=""><img src="pha12f27.svg" width=404 height=187 style="max-width: 100%;"></a>
</div>
<p>


</p>
<figcaption class="caption">Figure 12.27: <span class="legend">
<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.992ex" height="2.343ex" style="vertical-align: -0.338ex;" viewBox="0 -863.1 857.6 1008.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">theta prime</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D703" d="M455 500c0 -224 -152 -511 -293 -511c-91 0 -120 111 -120 205c0 229 154 511 293 511c102 0 120 -139 120 -205zM389 562c0 57 -6 121 -55 121c-45 0 -82 -56 -109 -105c-40 -71 -60 -151 -77 -215h209c24 99 32 150 32 199zM348 331h-208c-26 -98 -32 -156 -32 -198 c0 -93 21 -122 54 -122c43 0 81 49 116 117c38 72 59 157 70 203Z"></path>
<path stroke-width="1" id="E1-LATINMODERNVARIANTS-2032" d="M340 496c0 -10 -3 -20 -8 -28l-227 -372h-38l171 424c6 15 26 29 48 29c30 0 54 -24 54 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D703" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNVARIANTS-2032" x="663" y="513"></use>
</g>
</svg> is the minimum angle between the emitter and
the vector to the reference point.</span>
</figcaption>
</div></div><p>


</p>
<p>If this angle is greater than <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.053ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 883.8 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">theta Subscript normal e</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D703" d="M455 500c0 -224 -152 -511 -293 -511c-91 0 -120 111 -120 205c0 229 154 511 293 511c102 0 120 -139 120 -205zM389 562c0 57 -6 121 -55 121c-45 0 -82 -56 -109 -105c-40 -71 -60 -151 -77 -215h209c24 99 32 150 32 199zM348 331h-208c-26 -98 -32 -156 -32 -198 c0 -93 21 -122 54 -122c43 0 81 49 116 117c38 72 59 157 70 203Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-65" d="M415 119c0 -19 -45 -130 -167 -130c-115 0 -220 97 -220 231c0 125 92 228 208 228c125 0 179 -97 179 -196c0 -21 -3 -21 -25 -21h-279c0 -36 0 -102 30 -150c23 -37 63 -67 113 -67c10 0 100 0 135 103c2 8 4 14 13 14c5 0 13 -2 13 -12zM349 252 c0 39 -10 174 -113 174c-34 0 -118 -25 -124 -174h237Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D703" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-65" x="663" y="-213"></use>
</g>
</svg> (or, here, if its cosine
is less than <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.551ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 2390 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">cosine theta Subscript normal e</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-63" d="M415 119c0 -10 -32 -130 -166 -130c-116 0 -215 99 -215 227c0 124 92 232 217 232c77 0 153 -39 153 -107c0 -30 -20 -47 -46 -47c-28 0 -46 20 -46 46c0 13 6 43 47 46c-35 36 -98 37 -107 37c-53 0 -135 -42 -135 -205c0 -161 88 -204 141 -204c37 0 102 12 131 105 c2 6 4 10 13 10c3 0 13 0 13 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6F" d="M471 214c0 -127 -101 -225 -222 -225c-117 0 -221 96 -221 225c0 125 97 234 222 234c121 0 221 -106 221 -234zM388 222c0 38 0 96 -26 139s-69 65 -113 65c-40 0 -87 -21 -114 -67c-24 -44 -24 -98 -24 -137c0 -36 0 -97 25 -141c27 -46 71 -67 114 -67 c50 0 94 29 116 74c22 44 22 98 22 134Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-73" d="M360 128c0 -72 -46 -139 -161 -139c-21 0 -66 1 -110 43c-18 -19 -18 -21 -20 -23c-19 -19 -20 -20 -25 -20c-11 0 -11 7 -11 24v132c0 18 0 25 13 25c10 0 11 -4 14 -17c19 -85 55 -142 139 -142c78 0 113 40 113 91c0 72 -82 88 -104 92c-72 14 -100 20 -132 46 c-27 22 -43 50 -43 85c0 56 38 123 160 123c15 0 56 0 94 -28c4 3 14 12 17 16c13 12 15 12 20 12c11 0 11 -7 11 -24v-101c0 -19 0 -24 -13 -24c0 0 -11 0 -12 9c-2 31 -7 121 -117 121c-86 0 -112 -41 -112 -76c0 -58 67 -71 123 -82c42 -8 81 -16 114 -48 c12 -12 42 -42 42 -95Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D703" d="M455 500c0 -224 -152 -511 -293 -511c-91 0 -120 111 -120 205c0 229 154 511 293 511c102 0 120 -139 120 -205zM389 562c0 57 -6 121 -55 121c-45 0 -82 -56 -109 -105c-40 -71 -60 -151 -77 -215h209c24 99 32 150 32 199zM348 331h-208c-26 -98 -32 -156 -32 -198 c0 -93 21 -122 54 -122c43 0 81 49 116 117c38 72 59 157 70 203Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-65" d="M415 119c0 -19 -45 -130 -167 -130c-115 0 -220 97 -220 231c0 125 92 228 208 228c125 0 179 -97 179 -196c0 -21 -3 -21 -25 -21h-279c0 -36 0 -102 30 -150c23 -37 63 -67 113 -67c10 0 100 0 135 103c2 8 4 14 13 14c5 0 13 -2 13 -12zM349 252 c0 39 -10 174 -113 174c-34 0 -118 -25 -124 -174h237Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-63"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-6F" x="444" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-73" x="945" y="0"></use>
<g transform="translate(1506,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D703" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-65" x="663" y="-213"></use>
</g>
</g>
</svg>), then it is certain that the lights
represented by the bounds do not illuminate the reference point and an importance value
of&nbsp;0 can be returned immediately.

</p>
<p>


</p>
<p></p>
<span class="anchor" id="fragment-Computecosthetaandtestagainstcostheta_romane-0"></span><div class="fragmentname">&lt;&lt;Compute <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.877ex" height="2.343ex" style="vertical-align: -0.338ex;" viewBox="0 -863.1 2530.5 1008.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">cosine theta prime</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-63" d="M415 119c0 -10 -32 -130 -166 -130c-116 0 -215 99 -215 227c0 124 92 232 217 232c77 0 153 -39 153 -107c0 -30 -20 -47 -46 -47c-28 0 -46 20 -46 46c0 13 6 43 47 46c-35 36 -98 37 -107 37c-53 0 -135 -42 -135 -205c0 -161 88 -204 141 -204c37 0 102 12 131 105 c2 6 4 10 13 10c3 0 13 0 13 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6F" d="M471 214c0 -127 -101 -225 -222 -225c-117 0 -221 96 -221 225c0 125 97 234 222 234c121 0 221 -106 221 -234zM388 222c0 38 0 96 -26 139s-69 65 -113 65c-40 0 -87 -21 -114 -67c-24 -44 -24 -98 -24 -137c0 -36 0 -97 25 -141c27 -46 71 -67 114 -67 c50 0 94 29 116 74c22 44 22 98 22 134Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-73" d="M360 128c0 -72 -46 -139 -161 -139c-21 0 -66 1 -110 43c-18 -19 -18 -21 -20 -23c-19 -19 -20 -20 -25 -20c-11 0 -11 7 -11 24v132c0 18 0 25 13 25c10 0 11 -4 14 -17c19 -85 55 -142 139 -142c78 0 113 40 113 91c0 72 -82 88 -104 92c-72 14 -100 20 -132 46 c-27 22 -43 50 -43 85c0 56 38 123 160 123c15 0 56 0 94 -28c4 3 14 12 17 16c13 12 15 12 20 12c11 0 11 -7 11 -24v-101c0 -19 0 -24 -13 -24c0 0 -11 0 -12 9c-2 31 -7 121 -117 121c-86 0 -112 -41 -112 -76c0 -58 67 -71 123 -82c42 -8 81 -16 114 -48 c12 -12 42 -42 42 -95Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D703" d="M455 500c0 -224 -152 -511 -293 -511c-91 0 -120 111 -120 205c0 229 154 511 293 511c102 0 120 -139 120 -205zM389 562c0 57 -6 121 -55 121c-45 0 -82 -56 -109 -105c-40 -71 -60 -151 -77 -215h209c24 99 32 150 32 199zM348 331h-208c-26 -98 -32 -156 -32 -198 c0 -93 21 -122 54 -122c43 0 81 49 116 117c38 72 59 157 70 203Z"></path>
<path stroke-width="1" id="E1-LATINMODERNVARIANTS-2032" d="M340 496c0 -10 -3 -20 -8 -28l-227 -372h-38l171 424c6 15 26 29 48 29c30 0 54 -24 54 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-63"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-6F" x="444" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-73" x="945" y="0"></use>
<g transform="translate(1672,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D703" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNVARIANTS-2032" x="663" y="513"></use>
</g>
</g>
</svg> and test against <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.938ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 2556.6 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">cosine theta Subscript normal e</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-63" d="M415 119c0 -10 -32 -130 -166 -130c-116 0 -215 99 -215 227c0 124 92 232 217 232c77 0 153 -39 153 -107c0 -30 -20 -47 -46 -47c-28 0 -46 20 -46 46c0 13 6 43 47 46c-35 36 -98 37 -107 37c-53 0 -135 -42 -135 -205c0 -161 88 -204 141 -204c37 0 102 12 131 105 c2 6 4 10 13 10c3 0 13 0 13 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6F" d="M471 214c0 -127 -101 -225 -222 -225c-117 0 -221 96 -221 225c0 125 97 234 222 234c121 0 221 -106 221 -234zM388 222c0 38 0 96 -26 139s-69 65 -113 65c-40 0 -87 -21 -114 -67c-24 -44 -24 -98 -24 -137c0 -36 0 -97 25 -141c27 -46 71 -67 114 -67 c50 0 94 29 116 74c22 44 22 98 22 134Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-73" d="M360 128c0 -72 -46 -139 -161 -139c-21 0 -66 1 -110 43c-18 -19 -18 -21 -20 -23c-19 -19 -20 -20 -25 -20c-11 0 -11 7 -11 24v132c0 18 0 25 13 25c10 0 11 -4 14 -17c19 -85 55 -142 139 -142c78 0 113 40 113 91c0 72 -82 88 -104 92c-72 14 -100 20 -132 46 c-27 22 -43 50 -43 85c0 56 38 123 160 123c15 0 56 0 94 -28c4 3 14 12 17 16c13 12 15 12 20 12c11 0 11 -7 11 -24v-101c0 -19 0 -24 -13 -24c0 0 -11 0 -12 9c-2 31 -7 121 -117 121c-86 0 -112 -41 -112 -76c0 -58 67 -71 123 -82c42 -8 81 -16 114 -48 c12 -12 42 -42 42 -95Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D703" d="M455 500c0 -224 -152 -511 -293 -511c-91 0 -120 111 -120 205c0 229 154 511 293 511c102 0 120 -139 120 -205zM389 562c0 57 -6 121 -55 121c-45 0 -82 -56 -109 -105c-40 -71 -60 -151 -77 -215h209c24 99 32 150 32 199zM348 331h-208c-26 -98 -32 -156 -32 -198 c0 -93 21 -122 54 -122c43 0 81 49 116 117c38 72 59 157 70 203Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-65" d="M415 119c0 -19 -45 -130 -167 -130c-115 0 -220 97 -220 231c0 125 92 228 208 228c125 0 179 -97 179 -196c0 -21 -3 -21 -25 -21h-279c0 -36 0 -102 30 -150c23 -37 63 -67 113 -67c10 0 100 0 135 103c2 8 4 14 13 14c5 0 13 -2 13 -12zM349 252 c0 39 -10 174 -113 174c-34 0 -118 -25 -124 -174h237Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-63"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-6F" x="444" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-73" x="945" y="0"></use>
<g transform="translate(1672,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D703" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-65" x="663" y="-213"></use>
</g>
</g>
</svg>&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">Float sinTheta_o = <a href="../Utilities/Mathematical_Infrastructure.html#SafeSqrt" class="code">SafeSqrt</a>(1 - <a href="../Utilities/Mathematical_Infrastructure.html#Sqr" class="code">Sqr</a>(cosTheta_o));
Float cosTheta_x =
    cosSubClamped(sinTheta_w, cosTheta_w, sinTheta_o, cosTheta_o);
Float sinTheta_x =
    sinSubClamped(sinTheta_w, cosTheta_w, sinTheta_o, cosTheta_o);
Float cosThetap =
    cosSubClamped(sinTheta_x, cosTheta_x, sinTheta_b, cosTheta_b);
if (cosThetap &lt;= cosTheta_e)
    return 0;</div><p>


</p>
<p>The importance value can now be computed.  It starts with the product of
the power of the lights, the <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.49ex" height="2.343ex" style="vertical-align: -0.338ex;" viewBox="0 -863.1 2363.8 1008.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">cosine theta prime</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-63" d="M415 119c0 -10 -32 -130 -166 -130c-116 0 -215 99 -215 227c0 124 92 232 217 232c77 0 153 -39 153 -107c0 -30 -20 -47 -46 -47c-28 0 -46 20 -46 46c0 13 6 43 47 46c-35 36 -98 37 -107 37c-53 0 -135 -42 -135 -205c0 -161 88 -204 141 -204c37 0 102 12 131 105 c2 6 4 10 13 10c3 0 13 0 13 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6F" d="M471 214c0 -127 -101 -225 -222 -225c-117 0 -221 96 -221 225c0 125 97 234 222 234c121 0 221 -106 221 -234zM388 222c0 38 0 96 -26 139s-69 65 -113 65c-40 0 -87 -21 -114 -67c-24 -44 -24 -98 -24 -137c0 -36 0 -97 25 -141c27 -46 71 -67 114 -67 c50 0 94 29 116 74c22 44 22 98 22 134Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-73" d="M360 128c0 -72 -46 -139 -161 -139c-21 0 -66 1 -110 43c-18 -19 -18 -21 -20 -23c-19 -19 -20 -20 -25 -20c-11 0 -11 7 -11 24v132c0 18 0 25 13 25c10 0 11 -4 14 -17c19 -85 55 -142 139 -142c78 0 113 40 113 91c0 72 -82 88 -104 92c-72 14 -100 20 -132 46 c-27 22 -43 50 -43 85c0 56 38 123 160 123c15 0 56 0 94 -28c4 3 14 12 17 16c13 12 15 12 20 12c11 0 11 -7 11 -24v-101c0 -19 0 -24 -13 -24c0 0 -11 0 -12 9c-2 31 -7 121 -117 121c-86 0 -112 -41 -112 -76c0 -58 67 -71 123 -82c42 -8 81 -16 114 -48 c12 -12 42 -42 42 -95Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D703" d="M455 500c0 -224 -152 -511 -293 -511c-91 0 -120 111 -120 205c0 229 154 511 293 511c102 0 120 -139 120 -205zM389 562c0 57 -6 121 -55 121c-45 0 -82 -56 -109 -105c-40 -71 -60 -151 -77 -215h209c24 99 32 150 32 199zM348 331h-208c-26 -98 -32 -156 -32 -198 c0 -93 21 -122 54 -122c43 0 81 49 116 117c38 72 59 157 70 203Z"></path>
<path stroke-width="1" id="E1-LATINMODERNVARIANTS-2032" d="M340 496c0 -10 -3 -20 -8 -28l-227 -372h-38l171 424c6 15 26 29 48 29c30 0 54 -24 54 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-63"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-6F" x="444" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-73" x="945" y="0"></use>
<g transform="translate(1506,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D703" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNVARIANTS-2032" x="663" y="513"></use>
</g>
</g>
</svg> factor that accounts for the
cosine at the emitter, and the inverse squared distance.

</p>
<p></p>
<span class="anchor" id="fragment-Returnfinalimportanceatreferencepoint-0"></span><div class="fragmentname">&lt;&lt;Return final importance at reference point&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">Float importance = phi * cosThetap / d2;
&lt;&lt;<span class="fragmentname"><a href="#fragment-Accountforcostheta_romaniinimportanceatsurfaces-0">Account for <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.278ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 2272.6 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">cosine theta Subscript normal i</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-63" d="M415 119c0 -10 -32 -130 -166 -130c-116 0 -215 99 -215 227c0 124 92 232 217 232c77 0 153 -39 153 -107c0 -30 -20 -47 -46 -47c-28 0 -46 20 -46 46c0 13 6 43 47 46c-35 36 -98 37 -107 37c-53 0 -135 -42 -135 -205c0 -161 88 -204 141 -204c37 0 102 12 131 105 c2 6 4 10 13 10c3 0 13 0 13 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6F" d="M471 214c0 -127 -101 -225 -222 -225c-117 0 -221 96 -221 225c0 125 97 234 222 234c121 0 221 -106 221 -234zM388 222c0 38 0 96 -26 139s-69 65 -113 65c-40 0 -87 -21 -114 -67c-24 -44 -24 -98 -24 -137c0 -36 0 -97 25 -141c27 -46 71 -67 114 -67 c50 0 94 29 116 74c22 44 22 98 22 134Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-73" d="M360 128c0 -72 -46 -139 -161 -139c-21 0 -66 1 -110 43c-18 -19 -18 -21 -20 -23c-19 -19 -20 -20 -25 -20c-11 0 -11 7 -11 24v132c0 18 0 25 13 25c10 0 11 -4 14 -17c19 -85 55 -142 139 -142c78 0 113 40 113 91c0 72 -82 88 -104 92c-72 14 -100 20 -132 46 c-27 22 -43 50 -43 85c0 56 38 123 160 123c15 0 56 0 94 -28c4 3 14 12 17 16c13 12 15 12 20 12c11 0 11 -7 11 -24v-101c0 -19 0 -24 -13 -24c0 0 -11 0 -12 9c-2 31 -7 121 -117 121c-86 0 -112 -41 -112 -76c0 -58 67 -71 123 -82c42 -8 81 -16 114 -48 c12 -12 42 -42 42 -95Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D703" d="M455 500c0 -224 -152 -511 -293 -511c-91 0 -120 111 -120 205c0 229 154 511 293 511c102 0 120 -139 120 -205zM389 562c0 57 -6 121 -55 121c-45 0 -82 -56 -109 -105c-40 -71 -60 -151 -77 -215h209c24 99 32 150 32 199zM348 331h-208c-26 -98 -32 -156 -32 -198 c0 -93 21 -122 54 -122c43 0 81 49 116 117c38 72 59 157 70 203Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-69" d="M247 0c-34 1 -69 3 -104 3l-110 -3v31c67 0 78 0 78 45v269c0 49 -9 55 -74 55v31l140 11v-367c0 -39 4 -44 70 -44v-31zM192 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-63"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-6F" x="444" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-73" x="945" y="0"></use>
<g transform="translate(1506,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D703" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="663" y="-213"></use>
</g>
</g>
</svg> in importance at surfaces</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1736" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1736"><i></i></a><div id="fragbit-1736" class="collapse show"><div class="fragmentcode">   if (n != <a href="../Geometry_and_Transformations/Normals.html#Normal3f" class="code">Normal3f</a>(0, 0, 0)) {
       Float cosTheta_i = <a href="../Geometry_and_Transformations/Vectors.html#AbsDot" class="code">AbsDot</a>(wi, n);
       Float sinTheta_i = <a href="../Utilities/Mathematical_Infrastructure.html#SafeSqrt" class="code">SafeSqrt</a>(1 - <a href="../Utilities/Mathematical_Infrastructure.html#Sqr" class="code">Sqr</a>(cosTheta_i));
       Float cosThetap_i = cosSubClamped(sinTheta_i, cosTheta_i,
                                         sinTheta_b, cosTheta_b);
       importance *= cosThetap_i;
   }</div></div> 
return importance;</div><p>


</p>
<p>At a surface, the importance also accounts for a conservative estimate of
the incident cosine factor there.  We have <tt>wi</tt>, the unit vector from
the reference point to the center of the <a href="#LightBounds"><tt>LightBounds</tt></a>, but would like
to conservatively set the importance based on the maximum value of the
incident cosine over the entire bounding box.  The corresponding minimum
angle with the surface normal is given by <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="15.576ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 6706.2 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">max left-parenthesis 0 comma theta Subscript normal i Baseline minus theta Subscript normal b Baseline right-parenthesis</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E2-LATINMODERNMAIN-6D" d="M813 0l-112 3l-113 -3v31c67 0 78 0 78 45v233c0 57 -11 111 -74 111c-64 0 -135 -56 -135 -160v-184c0 -45 11 -45 78 -45v-31l-112 3l-113 -3v31c67 0 78 0 78 45v233c0 57 -11 111 -74 111c-64 0 -135 -56 -135 -160v-184c0 -45 11 -45 78 -45v-31l-112 3l-113 -3v31 c67 0 78 0 78 45v268c0 49 -8 56 -78 56v31l141 11v-105c28 62 75 105 148 105c45 0 119 -11 133 -98c17 38 61 98 145 98c58 0 91 -20 105 -37c31 -36 31 -67 31 -153v-191c1 -30 26 -30 78 -30v-31Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-61" d="M483 89c0 -81 -61 -95 -82 -95c-47 0 -74 42 -78 82c-19 -47 -65 -87 -131 -87c-63 0 -160 25 -160 106c0 44 25 96 100 130c63 30 133 33 184 36v37c0 89 -57 128 -106 128c-32 0 -81 -11 -108 -46c46 -1 51 -34 51 -46c0 -26 -18 -46 -46 -46c-26 0 -46 17 -46 47 c0 66 69 113 151 113c48 0 98 -16 137 -55c36 -37 36 -76 36 -118v-200c0 -5 4 -50 37 -50c11 0 36 6 36 64v56h25v-56zM316 140v100c-165 -6 -207 -89 -207 -144c0 -50 41 -85 90 -85c45 0 117 34 117 129Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-78" d="M516 0c-30 2 -69 3 -96 3l-108 -3v31c27 1 36 16 36 25c0 6 -13 22 -21 33l-76 100c-61 -72 -90 -105 -90 -127c0 -15 7 -28 29 -31v-31l-95 3c-26 0 -57 -1 -83 -3v31c21 0 80 2 128 60c47 57 47 59 94 119l-99 129c-47 60 -48 61 -118 61v31c27 -2 74 -3 95 -3l108 3 v-31c-20 -1 -35 -10 -35 -25c0 -6 0 -8 9 -18l78 -101l62 78c5 6 15 19 15 35s-8 29 -29 31v31c13 -1 66 -3 96 -3c26 0 56 1 82 3v-31c-47 -1 -88 -16 -119 -52c-24 -26 -62 -75 -92 -113l134 -173c23 -29 41 -31 95 -31v-31Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-30" d="M460 320c0 -79 -5 -157 -37 -226c-44 -95 -120 -116 -174 -116c-49 0 -122 20 -165 101c-41 76 -45 166 -45 241c0 80 5 158 37 227c41 93 114 119 174 119c42 0 124 -16 170 -112c35 -74 40 -154 40 -234zM377 332c0 63 0 139 -10 195c-19 99 -85 117 -118 117 c-25 0 -100 -9 -119 -128c-8 -54 -8 -120 -8 -184c0 -59 0 -151 11 -211c18 -96 77 -121 116 -121c45 0 102 30 117 125c11 64 11 132 11 207Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E2-LATINMODERNNORMAL-1D703" d="M455 500c0 -224 -152 -511 -293 -511c-91 0 -120 111 -120 205c0 229 154 511 293 511c102 0 120 -139 120 -205zM389 562c0 57 -6 121 -55 121c-45 0 -82 -56 -109 -105c-40 -71 -60 -151 -77 -215h209c24 99 32 150 32 199zM348 331h-208c-26 -98 -32 -156 -32 -198 c0 -93 21 -122 54 -122c43 0 81 49 116 117c38 72 59 157 70 203Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-69" d="M247 0c-34 1 -69 3 -104 3l-110 -3v31c67 0 78 0 78 45v269c0 49 -9 55 -74 55v31l140 11v-367c0 -39 4 -44 70 -44v-31zM192 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-2212" d="M722 250c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-62" d="M521 216c0 -129 -104 -227 -223 -227c-74 0 -116 50 -131 73l-36 -62h-25v596c0 49 -8 56 -78 56v31l144 11v-317c16 18 59 65 137 65c114 0 212 -99 212 -226zM438 217c0 41 -3 98 -29 139c-24 38 -60 64 -105 64c-24 0 -79 -8 -118 -64c-11 -16 -11 -17 -11 -36v-206 c0 -18 0 -21 14 -42c24 -37 60 -61 105 -61c54 0 92 33 113 64c29 45 31 105 31 142Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E2-LATINMODERNMAIN-6D"></use>
 <use xlink:href="#E2-LATINMODERNMAIN-61" x="833" y="0"></use>
 <use xlink:href="#E2-LATINMODERNMAIN-78" x="1334" y="0"></use>
 <use xlink:href="#E2-LATINMODERNMAIN-28" x="1862" y="0"></use>
 <use xlink:href="#E2-LATINMODERNMAIN-30" x="2252" y="0"></use>
 <use xlink:href="#E2-LATINMODERNMAIN-2C" x="2752" y="0"></use>
<g transform="translate(3197,0)">
 <use xlink:href="#E2-LATINMODERNNORMAL-1D703" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E2-LATINMODERNMAIN-69" x="663" y="-213"></use>
</g>
 <use xlink:href="#E2-LATINMODERNMAIN-2212" x="4186" y="0"></use>
<g transform="translate(5187,0)">
 <use xlink:href="#E2-LATINMODERNNORMAL-1D703" x="0" y="0"></use>
<g transform="translate(469,-150)">
 <use transform="scale(0.707)" xlink:href="#E2-LATINMODERNMAIN-62" x="235" y="0"></use>
</g>
</g>
 <use xlink:href="#E2-LATINMODERNMAIN-29" x="6316" y="0"></use>
</g>
</svg> (see Figure&nbsp;<a href="#fig:light-sample-thetai-prime">12.28</a>).

</p>
<p></p>
<span class="anchor" id="fig:light-sample-thetai-prime"></span><div class="card outerfigure"><div class="card-body figure"><p>



</p>
<div class="figure-row">
  <a href="pha12f28.svg" title=""><img src="pha12f28.svg" width=414 height=182 style="max-width: 100%;"></a>
</div>
<p>


</p>
<figcaption class="caption">Figure 12.28: <span class="legend"> An angle <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.992ex" height="2.843ex" style="vertical-align: -1.005ex;" viewBox="0 -791.3 857.6 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">theta prime Subscript normal i</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D703" d="M455 500c0 -224 -152 -511 -293 -511c-91 0 -120 111 -120 205c0 229 154 511 293 511c102 0 120 -139 120 -205zM389 562c0 57 -6 121 -55 121c-45 0 -82 -56 -109 -105c-40 -71 -60 -151 -77 -215h209c24 99 32 150 32 199zM348 331h-208c-26 -98 -32 -156 -32 -198 c0 -93 21 -122 54 -122c43 0 81 49 116 117c38 72 59 157 70 203Z"></path>
<path stroke-width="1" id="E1-LATINMODERNVARIANTS-2032" d="M340 496c0 -10 -3 -20 -8 -28l-227 -372h-38l171 424c6 15 26 29 48 29c30 0 54 -24 54 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-69" d="M247 0c-34 1 -69 3 -104 3l-110 -3v31c67 0 78 0 78 45v269c0 49 -9 55 -74 55v31l140 11v-367c0 -39 4 -44 70 -44v-31zM192 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D703" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNVARIANTS-2032" x="663" y="392"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="663" y="-426"></use>
</g>
</svg> that gives a lower bound on the
angle between the incident lighting direction and the surface normal can be
found by subtracting <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.624ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 1129.7 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">theta Subscript normal b</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D703" d="M455 500c0 -224 -152 -511 -293 -511c-91 0 -120 111 -120 205c0 229 154 511 293 511c102 0 120 -139 120 -205zM389 562c0 57 -6 121 -55 121c-45 0 -82 -56 -109 -105c-40 -71 -60 -151 -77 -215h209c24 99 32 150 32 199zM348 331h-208c-26 -98 -32 -156 -32 -198 c0 -93 21 -122 54 -122c43 0 81 49 116 117c38 72 59 157 70 203Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-62" d="M521 216c0 -129 -104 -227 -223 -227c-74 0 -116 50 -131 73l-36 -62h-25v596c0 49 -8 56 -78 56v31l144 11v-317c16 18 59 65 137 65c114 0 212 -99 212 -226zM438 217c0 41 -3 98 -29 139c-24 38 -60 64 -105 64c-24 0 -79 -8 -118 -64c-11 -16 -11 -17 -11 -36v-206 c0 -18 0 -21 14 -42c24 -37 60 -61 105 -61c54 0 92 33 113 64c29 45 31 105 31 142Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D703" x="0" y="0"></use>
<g transform="translate(469,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-62" x="235" y="0"></use>
</g>
</g>
</svg>, the angle that the bounding box
subtends with respect to the reference point <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.293ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 556.5 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">normal p</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="0" y="0"></use>
</g>
</svg>, from <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.78ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 766.4 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">theta Subscript normal i</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D703" d="M455 500c0 -224 -152 -511 -293 -511c-91 0 -120 111 -120 205c0 229 154 511 293 511c102 0 120 -139 120 -205zM389 562c0 57 -6 121 -55 121c-45 0 -82 -56 -109 -105c-40 -71 -60 -151 -77 -215h209c24 99 32 150 32 199zM348 331h-208c-26 -98 -32 -156 -32 -198 c0 -93 21 -122 54 -122c43 0 81 49 116 117c38 72 59 157 70 203Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-69" d="M247 0c-34 1 -69 3 -104 3l-110 -3v31c67 0 78 0 78 45v269c0 49 -9 55 -74 55v31l140 11v-367c0 -39 4 -44 70 -44v-31zM192 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D703" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="663" y="-213"></use>
</g>
</svg>, the
angle between the surface normal and the vector to the center of the box.</span>
</figcaption>
</div></div><p>


</p>
<p>Our implementation of this computation uses the <tt>cosSubClamped()</tt>
lambda function introduced earlier to compute the cosine of the angle
<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.992ex" height="2.843ex" style="vertical-align: -1.005ex;" viewBox="0 -791.3 857.6 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">theta prime Subscript normal i</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D703" d="M455 500c0 -224 -152 -511 -293 -511c-91 0 -120 111 -120 205c0 229 154 511 293 511c102 0 120 -139 120 -205zM389 562c0 57 -6 121 -55 121c-45 0 -82 -56 -109 -105c-40 -71 -60 -151 -77 -215h209c24 99 32 150 32 199zM348 331h-208c-26 -98 -32 -156 -32 -198 c0 -93 21 -122 54 -122c43 0 81 49 116 117c38 72 59 157 70 203Z"></path>
<path stroke-width="1" id="E1-LATINMODERNVARIANTS-2032" d="M340 496c0 -10 -3 -20 -8 -28l-227 -372h-38l171 424c6 15 26 29 48 29c30 0 54 -24 54 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-69" d="M247 0c-34 1 -69 3 -104 3l-110 -3v31c67 0 78 0 78 45v269c0 49 -9 55 -74 55v31l140 11v-367c0 -39 4 -44 70 -44v-31zM192 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D703" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNVARIANTS-2032" x="663" y="392"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="663" y="-426"></use>
</g>
</svg> directly using the sines and cosines of the two
contributing angles.

</p>
<p></p>
<span class="anchor" id="fragment-Accountforcostheta_romaniinimportanceatsurfaces-0"></span><div class="fragmentname">&lt;&lt;Account for <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.278ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 2272.6 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">cosine theta Subscript normal i</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-63" d="M415 119c0 -10 -32 -130 -166 -130c-116 0 -215 99 -215 227c0 124 92 232 217 232c77 0 153 -39 153 -107c0 -30 -20 -47 -46 -47c-28 0 -46 20 -46 46c0 13 6 43 47 46c-35 36 -98 37 -107 37c-53 0 -135 -42 -135 -205c0 -161 88 -204 141 -204c37 0 102 12 131 105 c2 6 4 10 13 10c3 0 13 0 13 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6F" d="M471 214c0 -127 -101 -225 -222 -225c-117 0 -221 96 -221 225c0 125 97 234 222 234c121 0 221 -106 221 -234zM388 222c0 38 0 96 -26 139s-69 65 -113 65c-40 0 -87 -21 -114 -67c-24 -44 -24 -98 -24 -137c0 -36 0 -97 25 -141c27 -46 71 -67 114 -67 c50 0 94 29 116 74c22 44 22 98 22 134Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-73" d="M360 128c0 -72 -46 -139 -161 -139c-21 0 -66 1 -110 43c-18 -19 -18 -21 -20 -23c-19 -19 -20 -20 -25 -20c-11 0 -11 7 -11 24v132c0 18 0 25 13 25c10 0 11 -4 14 -17c19 -85 55 -142 139 -142c78 0 113 40 113 91c0 72 -82 88 -104 92c-72 14 -100 20 -132 46 c-27 22 -43 50 -43 85c0 56 38 123 160 123c15 0 56 0 94 -28c4 3 14 12 17 16c13 12 15 12 20 12c11 0 11 -7 11 -24v-101c0 -19 0 -24 -13 -24c0 0 -11 0 -12 9c-2 31 -7 121 -117 121c-86 0 -112 -41 -112 -76c0 -58 67 -71 123 -82c42 -8 81 -16 114 -48 c12 -12 42 -42 42 -95Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D703" d="M455 500c0 -224 -152 -511 -293 -511c-91 0 -120 111 -120 205c0 229 154 511 293 511c102 0 120 -139 120 -205zM389 562c0 57 -6 121 -55 121c-45 0 -82 -56 -109 -105c-40 -71 -60 -151 -77 -215h209c24 99 32 150 32 199zM348 331h-208c-26 -98 -32 -156 -32 -198 c0 -93 21 -122 54 -122c43 0 81 49 116 117c38 72 59 157 70 203Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-69" d="M247 0c-34 1 -69 3 -104 3l-110 -3v31c67 0 78 0 78 45v269c0 49 -9 55 -74 55v31l140 11v-367c0 -39 4 -44 70 -44v-31zM192 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-63"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-6F" x="444" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-73" x="945" y="0"></use>
<g transform="translate(1506,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D703" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="663" y="-213"></use>
</g>
</g>
</svg> in importance at surfaces&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">if (n != <a href="../Geometry_and_Transformations/Normals.html#Normal3f" class="code">Normal3f</a>(0, 0, 0)) {
    Float cosTheta_i = <a href="../Geometry_and_Transformations/Vectors.html#AbsDot" class="code">AbsDot</a>(wi, n);
    Float sinTheta_i = <a href="../Utilities/Mathematical_Infrastructure.html#SafeSqrt" class="code">SafeSqrt</a>(1 - <a href="../Utilities/Mathematical_Infrastructure.html#Sqr" class="code">Sqr</a>(cosTheta_i));
    Float cosThetap_i = cosSubClamped(sinTheta_i, cosTheta_i,
                                      sinTheta_b, cosTheta_b);
    importance *= cosThetap_i;
}</div><p>


</p>
<p>

</p>
<p>

</p>
<p></p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">
<a href="#x3-BoundsforLightImplementations"><i class="fas fa-link h3h4marginlink"></i></a>
</div>
<div class="col-md-10 col-lg-8">
<span id="x3-BoundsforLightImplementations"></span><h4>Bounds for Light Implementations</h4><p>


</p>
<p>Given the definition of <a href="#LightBounds"><tt>LightBounds</tt></a>, we will add another method to
the <a href="../Light_Sources/Light_Interface.html#Light"><tt>Light</tt></a> interface to allow lights to return bounds on their
emission.

</p>
<p></p>
<span class="anchor" id="fragment-LightInterface-7"></span><div class="fragmentname">&lt;&lt;Light Interface&gt;&gt;+=&nbsp;<a href="Light_Interface.html#fragment-LightInterface-6"><span class="fa fa-caret-up"></span></a></div>
<div class="fragmentcode">pstd::optional&lt;<a href="#LightBounds" class="code">LightBounds</a>&gt; <span class="anchor" id="Light::Bounds"></span>Bounds() const;</div><p>


</p>
<p>Lights at infinity return an unset <tt>optional</tt> value.  Here, for
example, is the implementation of this method for <a href="../Light_Sources/Infinite_Area_Lights.html#ImageInfiniteLight"><tt>ImageInfiniteLight</tt></a>.  The
other infinite lights and the <a href="../Light_Sources/Distant_Lights.html#DistantLight"><tt>DistantLight</tt></a> do likewise.

</p>
<p></p>
<span class="anchor" id="fragment-ImageInfiniteLightPublicMethods-2"></span><div class="fragmentname">&lt;&lt;ImageInfiniteLight Public Methods&gt;&gt;+=&nbsp;<a href="Infinite_Area_Lights.html#fragment-ImageInfiniteLightPublicMethods-1"><span class="fa fa-caret-up"></span></a></div>
<div class="fragmentcode">pstd::optional&lt;<a href="#LightBounds" class="code">LightBounds</a>&gt; <span class="anchor" id="ImageInfiniteLight::Bounds"></span>Bounds() const { return {}; }</div><p>


</p>
<p>The <a href="../Light_Sources/Point_Lights.html#PointLight"><tt>PointLight</tt></a>&rsquo;s implementation is just a few lines of code, as
befitting the simplicity of that type of light source.  The spatial bounds
are given by the light&rsquo;s rendering space position and the total emitted power
is easily computed following the approach in <a href="../Light_Sources/Point_Lights.html#PointLight::Phi"><tt>PointLight::Phi()</tt></a>.
Because this light shines in all directions, the average normal direction
is arbitrary and <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.145ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 923.4 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">theta Subscript normal o</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D703" d="M455 500c0 -224 -152 -511 -293 -511c-91 0 -120 111 -120 205c0 229 154 511 293 511c102 0 120 -139 120 -205zM389 562c0 57 -6 121 -55 121c-45 0 -82 -56 -109 -105c-40 -71 -60 -151 -77 -215h209c24 99 32 150 32 199zM348 331h-208c-26 -98 -32 -156 -32 -198 c0 -93 21 -122 54 -122c43 0 81 49 116 117c38 72 59 157 70 203Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6F" d="M471 214c0 -127 -101 -225 -222 -225c-117 0 -221 96 -221 225c0 125 97 234 222 234c121 0 221 -106 221 -234zM388 222c0 38 0 96 -26 139s-69 65 -113 65c-40 0 -87 -21 -114 -67c-24 -44 -24 -98 -24 -137c0 -36 0 -97 25 -141c27 -46 71 -67 114 -67 c50 0 94 29 116 74c22 44 22 98 22 134Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D703" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6F" x="663" y="-213"></use>
</g>
</svg> is <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.325ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 570.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">pi</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D70B" d="M567 407c0 -34 -36 -34 -49 -34h-114c-11 -52 -18 -106 -18 -159c0 -28 0 -93 29 -165c6 -14 6 -16 6 -22c0 -20 -21 -38 -41 -38c-15 0 -26 6 -36 50c-8 34 -8 61 -8 76c0 67 9 110 42 258h-113l-56 -221c-13 -50 -13 -52 -27 -98c-12 -37 -20 -65 -50 -65 c-13 0 -29 8 -29 27c0 7 0 9 8 24c42 91 96 212 128 333h-57c-20 0 -78 0 -127 -77c-6 -8 -8 -12 -16 -12c-12 0 -12 10 -12 10c0 5 26 51 61 90c44 47 82 47 104 47h335c19 0 40 0 40 -24Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D70B" x="0" y="0"></use>
</g>
</svg>, corresponding to the full
sphere of directions.

</p>
<p>

</p>
<p></p>
<span class="anchor" id="fragment-PointLightMethodDefinitions-1"></span><div class="fragmentname">&lt;&lt;PointLight Method Definitions&gt;&gt;+=&nbsp;<a href="Point_Lights.html#fragment-PointLightMethodDefinitions-0"><span class="fa fa-caret-up"></span></a></div>
<div class="fragmentcode">pstd::optional&lt;<a href="#LightBounds" class="code">LightBounds</a>&gt; <span class="anchor" id="PointLight::Bounds"></span>PointLight::Bounds() const {
    <a href="../Geometry_and_Transformations/Points.html#Point3f" class="code">Point3f</a> p = <a href="../Light_Sources/Light_Interface.html#LightBase::renderFromLight" class="code">renderFromLight</a>(<a href="../Geometry_and_Transformations/Points.html#Point3f" class="code">Point3f</a>(0, 0, 0));
    Float phi = 4 * <a href="../Utilities/Mathematical_Infrastructure.html#Pi" class="code">Pi</a> * <a href="../Light_Sources/Point_Lights.html#PointLight::scale" class="code">scale</a> * <a href="../Light_Sources/Point_Lights.html#PointLight::I" class="code">I</a>-&gt;<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#Spectrum::MaxValue" class="code">MaxValue</a>();
    return <a href="#LightBounds" class="code">LightBounds</a>(<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3f" class="code">Bounds3f</a>(p, p), <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a>(0, 0, 1), phi, std::cos(<a href="../Utilities/Mathematical_Infrastructure.html#Pi" class="code">Pi</a>),
                       std::cos(<a href="../Utilities/Mathematical_Infrastructure.html#Pi" class="code">Pi</a> / 2), false);
}</div><p>


</p>
<p>The <a href="../Light_Sources/Point_Lights.html#SpotLight"><tt>SpotLight</tt></a>&rsquo;s bounding method is a bit more interesting: now the average
normal vector is relevant; it is set here to be the light&rsquo;s direction.  The
<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.145ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 923.4 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">theta Subscript normal o</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D703" d="M455 500c0 -224 -152 -511 -293 -511c-91 0 -120 111 -120 205c0 229 154 511 293 511c102 0 120 -139 120 -205zM389 562c0 57 -6 121 -55 121c-45 0 -82 -56 -109 -105c-40 -71 -60 -151 -77 -215h209c24 99 32 150 32 199zM348 331h-208c-26 -98 -32 -156 -32 -198 c0 -93 21 -122 54 -122c43 0 81 49 116 117c38 72 59 157 70 203Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6F" d="M471 214c0 -127 -101 -225 -222 -225c-117 0 -221 96 -221 225c0 125 97 234 222 234c121 0 221 -106 221 -234zM388 222c0 38 0 96 -26 139s-69 65 -113 65c-40 0 -87 -21 -114 -67c-24 -44 -24 -98 -24 -137c0 -36 0 -97 25 -141c27 -46 71 -67 114 -67 c50 0 94 29 116 74c22 44 22 98 22 134Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D703" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6F" x="663" y="-213"></use>
</g>
</svg> range is set to be the angular width of the inner cone
of the light and <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.053ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 883.8 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">theta Subscript normal e</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D703" d="M455 500c0 -224 -152 -511 -293 -511c-91 0 -120 111 -120 205c0 229 154 511 293 511c102 0 120 -139 120 -205zM389 562c0 57 -6 121 -55 121c-45 0 -82 -56 -109 -105c-40 -71 -60 -151 -77 -215h209c24 99 32 150 32 199zM348 331h-208c-26 -98 -32 -156 -32 -198 c0 -93 21 -122 54 -122c43 0 81 49 116 117c38 72 59 157 70 203Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-65" d="M415 119c0 -19 -45 -130 -167 -130c-115 0 -220 97 -220 231c0 125 92 228 208 228c125 0 179 -97 179 -196c0 -21 -3 -21 -25 -21h-279c0 -36 0 -102 30 -150c23 -37 63 -67 113 -67c10 0 100 0 135 103c2 8 4 14 13 14c5 0 13 -2 13 -12zM349 252 c0 39 -10 174 -113 174c-34 0 -118 -25 -124 -174h237Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D703" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-65" x="663" y="-213"></use>
</g>
</svg> corresponds to the width of its falloff
at the edges.  While this falloff does not exactly match the cosine-weighted
falloff used in the <a href="#LightBounds::Importance"><tt>LightBounds::Importance()</tt></a> method, it is
close enough for these purposes.

</p>
<p>

</p>
<p>There is a subtlety in the computation of <tt>phi</tt> for this light: it is
computed as if the light source was an isotropic point source and is not
affected by the spotlight&rsquo;s cone angle, like the computation in
<a href="../Light_Sources/Point_Lights.html#SpotLight::Phi"><tt>SpotLight::Phi()</tt></a> is.  To understand the reason for this, consider two
spotlights with the same radiant intensity, one with a very narrow cone
and one with a wide cone, both illuminating some point in the scene.  The
total power emitted by the former is much less than the latter, though for
a point inside both of their cones, both should be sampled with equal
probability&mdash;effectively, the cone is accounted for in the light
importance function and so should not be included in the <tt>phi</tt> value
supplied here.

</p>
<p></p>
<span class="anchor" id="fragment-SpotLightMethodDefinitions-2"></span><div class="fragmentname">&lt;&lt;SpotLight Method Definitions&gt;&gt;+=&nbsp;<a href="Point_Lights.html#fragment-SpotLightMethodDefinitions-1"><span class="fa fa-caret-up"></span></a></div>
<div class="fragmentcode">pstd::optional&lt;<a href="#LightBounds" class="code">LightBounds</a>&gt; SpotLight::Bounds() const {
    <a href="../Geometry_and_Transformations/Points.html#Point3f" class="code">Point3f</a> p = <a href="../Light_Sources/Light_Interface.html#LightBase::renderFromLight" class="code">renderFromLight</a>(<a href="../Geometry_and_Transformations/Points.html#Point3f" class="code">Point3f</a>(0, 0, 0));
    <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> w = <a href="../Geometry_and_Transformations/Vectors.html#Normalize" class="code">Normalize</a>(<a href="../Light_Sources/Light_Interface.html#LightBase::renderFromLight" class="code">renderFromLight</a>(<a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a>(0, 0, 1)));
    Float phi = <a href="../Light_Sources/Point_Lights.html#SpotLight::scale" class="code">scale</a> * <a href="../Light_Sources/Point_Lights.html#SpotLight::Iemit" class="code">Iemit</a>-&gt;<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#Spectrum::MaxValue" class="code">MaxValue</a>() * 4 * <a href="../Utilities/Mathematical_Infrastructure.html#Pi" class="code">Pi</a>;
    Float cosTheta_e = std::cos(std::acos(<a href="../Light_Sources/Point_Lights.html#SpotLight::cosFalloffEnd" class="code">cosFalloffEnd</a>) -
                                std::acos(<a href="../Light_Sources/Point_Lights.html#SpotLight::cosFalloffStart" class="code">cosFalloffStart</a>));
    return <a href="#LightBounds" class="code">LightBounds</a>(<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3f" class="code">Bounds3f</a>(p, p), w, phi, <a href="../Light_Sources/Point_Lights.html#SpotLight::cosFalloffStart" class="code">cosFalloffStart</a>,
                       cosTheta_e, false);
}</div><p>


</p>
<p>We will skip past the implementations of the <a href="../Light_Sources/Point_Lights.html#ProjectionLight"><tt>ProjectionLight</tt></a> and
<a href="../Light_Sources/Point_Lights.html#GoniometricLight"><tt>GoniometricLight</tt></a> <tt>Bounds()</tt> methods, which are along similar lines.

</p>
<p>

</p>
<p>The <tt>DiffuseAreaLight</tt>&rsquo;s <tt>Bounds()</tt> implementation is different
than the previous ones.  The utility of the
<a href="../Shapes/Basic_Shape_Interface.html#Shape::NormalBounds"><tt>Shape::NormalBounds()</tt></a> method may now be better appreciated; the
cone of directions that it returns gives the average normal direction <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.446ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 622.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">omega Subscript</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
</g>
</svg>
and its spread angle <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.145ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 923.4 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">theta Subscript normal o</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D703" d="M455 500c0 -224 -152 -511 -293 -511c-91 0 -120 111 -120 205c0 229 154 511 293 511c102 0 120 -139 120 -205zM389 562c0 57 -6 121 -55 121c-45 0 -82 -56 -109 -105c-40 -71 -60 -151 -77 -215h209c24 99 32 150 32 199zM348 331h-208c-26 -98 -32 -156 -32 -198 c0 -93 21 -122 54 -122c43 0 81 49 116 117c38 72 59 157 70 203Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6F" d="M471 214c0 -127 -101 -225 -222 -225c-117 0 -221 96 -221 225c0 125 97 234 222 234c121 0 221 -106 221 -234zM388 222c0 38 0 96 -26 139s-69 65 -113 65c-40 0 -87 -21 -114 -67c-24 -44 -24 -98 -24 -137c0 -36 0 -97 25 -141c27 -46 71 -67 114 -67 c50 0 94 29 116 74c22 44 22 98 22 134Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D703" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6F" x="663" y="-213"></use>
</g>
</svg>.
For area lights, <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="8.801ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 3789.4 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">theta Subscript normal e Baseline equals pi slash 2</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D703" d="M455 500c0 -224 -152 -511 -293 -511c-91 0 -120 111 -120 205c0 229 154 511 293 511c102 0 120 -139 120 -205zM389 562c0 57 -6 121 -55 121c-45 0 -82 -56 -109 -105c-40 -71 -60 -151 -77 -215h209c24 99 32 150 32 199zM348 331h-208c-26 -98 -32 -156 -32 -198 c0 -93 21 -122 54 -122c43 0 81 49 116 117c38 72 59 157 70 203Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-65" d="M415 119c0 -19 -45 -130 -167 -130c-115 0 -220 97 -220 231c0 125 92 228 208 228c125 0 179 -97 179 -196c0 -21 -3 -21 -25 -21h-279c0 -36 0 -102 30 -150c23 -37 63 -67 113 -67c10 0 100 0 135 103c2 8 4 14 13 14c5 0 13 -2 13 -12zM349 252 c0 39 -10 174 -113 174c-34 0 -118 -25 -124 -174h237Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3D" d="M722 347c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20zM722 153c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D70B" d="M567 407c0 -34 -36 -34 -49 -34h-114c-11 -52 -18 -106 -18 -159c0 -28 0 -93 29 -165c6 -14 6 -16 6 -22c0 -20 -21 -38 -41 -38c-15 0 -26 6 -36 50c-8 34 -8 61 -8 76c0 67 9 110 42 258h-113l-56 -221c-13 -50 -13 -52 -27 -98c-12 -37 -20 -65 -50 -65 c-13 0 -29 8 -29 27c0 7 0 9 8 24c42 91 96 212 128 333h-57c-20 0 -78 0 -127 -77c-6 -8 -8 -12 -16 -12c-12 0 -12 10 -12 10c0 5 26 51 61 90c44 47 82 47 104 47h335c19 0 40 0 40 -24Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2F" d="M445 730c0 -2 0 -5 -1 -7l-349 -960c-3 -8 -10 -13 -19 -13c-11 0 -20 9 -20 20c0 2 0 5 1 7l349 960c3 8 10 13 19 13c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-32" d="M449 174l-28 -174h-371c0 24 0 26 11 37l192 214c55 62 105 141 105 221c0 82 -43 163 -134 163c-58 0 -112 -37 -135 -102c3 1 5 1 13 1c35 0 53 -26 53 -52c0 -41 -35 -53 -52 -53c-3 0 -53 0 -53 56c0 89 74 181 187 181c122 0 212 -80 212 -194 c0 -100 -60 -154 -216 -292l-106 -103h180c22 0 88 0 95 8c10 15 17 59 22 89h25Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D703" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-65" x="663" y="-213"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="1161" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D70B" x="2217" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2F" x="2788" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-32" x="3288" y="0"></use>
</g>
</svg>, since illumination is emitted in
the entire hemisphere around each surface normal.

</p>
<p></p>
<span class="anchor" id="fragment-DiffuseAreaLightMethodDefinitions-3"></span><div class="fragmentname">&lt;&lt;DiffuseAreaLight Method Definitions&gt;&gt;+=&nbsp;<a href="Area_Lights.html#fragment-DiffuseAreaLightMethodDefinitions-2"><span class="fa fa-caret-up"></span></a></div>
<div class="fragmentcode">pstd::optional&lt;<a href="#LightBounds" class="code">LightBounds</a>&gt; <span class="anchor" id="DiffuseAreaLight::Bounds"></span>DiffuseAreaLight::<a href="../Shapes/Basic_Shape_Interface.html#Shape::Bounds" class="code">Bounds</a>() const {
    &lt;&lt;<span class="fragmentname"><a href="#fragment-Computemonophifordiffusearealightbounds-0">Compute <tt>phi</tt> for diffuse area light bounds</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1737" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1737"><i></i></a><div id="fragbit-1737" class="collapse show"><div class="fragmentcode">       Float phi = 0;
       if (image) {
           &lt;&lt;<span class="fragmentname">Compute average <tt>DiffuseAreaLight</tt> image channel value</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1738" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1738"><i></i></a><div id="fragbit-1738" class="collapse show"><div class="fragmentcode">              // Assume no distortion in the mapping, FWIW...
              for (int y = 0; y &lt; image.Resolution().y; ++y)
                  for (int x = 0; x &lt; image.Resolution().x; ++x)
                      for (int c = 0; c &lt; 3; ++c)
                          phi += image.GetChannel({x, y}, c);
              phi /= 3 * image.Resolution().x * image.Resolution().y;</div></div>
       } else
           phi = <a href="../Light_Sources/Area_Lights.html#DiffuseAreaLight::Lemit" class="code">Lemit</a>-&gt;<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#Spectrum::MaxValue" class="code">MaxValue</a>();
       phi *= <a href="../Light_Sources/Area_Lights.html#DiffuseAreaLight::scale" class="code">scale</a> * <a href="../Light_Sources/Area_Lights.html#DiffuseAreaLight::area" class="code">area</a> * <a href="../Utilities/Mathematical_Infrastructure.html#Pi" class="code">Pi</a>;</div></div>
    <a href="../Geometry_and_Transformations/Spherical_Geometry.html#DirectionCone" class="code">DirectionCone</a> nb = <a href="../Light_Sources/Area_Lights.html#DiffuseAreaLight::shape" class="code">shape</a>.<a href="../Shapes/Basic_Shape_Interface.html#Shape::NormalBounds" class="code">NormalBounds</a>();
    return <a href="#LightBounds" class="code">LightBounds</a>(<a href="../Light_Sources/Area_Lights.html#DiffuseAreaLight::shape" class="code">shape</a>.<a href="../Shapes/Basic_Shape_Interface.html#Shape::Bounds" class="code">Bounds</a>(), nb.<a href="../Geometry_and_Transformations/Spherical_Geometry.html#DirectionCone::w" class="code">w</a>, phi, nb.<a href="../Geometry_and_Transformations/Spherical_Geometry.html#DirectionCone::cosTheta" class="code">cosTheta</a>,
                       std::cos(<a href="../Utilities/Mathematical_Infrastructure.html#Pi" class="code">Pi</a> / 2), <a href="../Light_Sources/Area_Lights.html#DiffuseAreaLight::twoSided" class="code">twoSided</a>);
}</div><p>


</p>
<p>The <tt>phi</tt> value is found by integrating over the light&rsquo;s area.  For
lights that use an <a href="../Utilities/Images.html#Image"><tt>Image</tt></a> for spatially varying emission, the
&lt;&lt;<span class="fragmentname">Compute average <tt>DiffuseAreaLight</tt> image channel value</span>&gt;&gt;
fragment, not included here, computes its average value.  Because
<a href="#LightBounds"><tt>LightBounds</tt></a> accounts for whether the emitter is one- or two-sided, it
is important not to double the shape&rsquo;s area if it is two-sided; that factor
is already included in the importance computation.  (This subtlety is
similar to the one for the <tt>SpotLight</tt>&rsquo;s <tt>phi</tt> value.)
See Figure&nbsp;<a href="#fig:one-two-sided-lights">12.29</a>
for an illustration of how this detail makes a difference.

</p>
<p></p>
<span class="anchor" id="fig:one-two-sided-lights"></span><div class="card outerfigure"><div class="card-body figure"><p>


</p>

<div class="card-img-top" style="display:block; width: 100%; padding-top: 67.436%;  position:relative;">
<div id="xa_Incorrect_Bounds52" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0;"></div></div>
<script>
Jeri.renderViewer(document.getElementById('xa_Incorrect_Bounds52'), {
  title: '(a)_Incorrect_Bounds52', children: [
 { title: '(a) Incorrect Bounds', image: 'dragon-blp-twosided-bad.exr' },  { title: '(b) Accurate bounds', image: 'dragon-blp-twosided-good.exr' }]});
</script>
<button data-toggle="tooltip" data-placement="left" class="btn yojeri" title="This image is interactive. Click and drag to pan and use the mouse-wheel to zoom. After clicking on the image to select it, type '?' to see a summary of keyboard controls."><i class="fa fa-snowflake fa-border"></i></button><p>

</p>
<figcaption class="caption">Figure 12.29: Simple Scene with Two Area Lights. <span class="legend">
The quadrilateral on the right emits light from both sides, while the one on the
left only emits from the front side.
(a)&nbsp;If the <a href="#DiffuseAreaLight::Bounds"><tt>DiffuseAreaLight::Bounds()</tt></a> method includes an additional
factor of&nbsp;2 for the two-sided light&rsquo;s importance, then it receives more
samples than it should.
(b)&nbsp;Without this factor, the light importance values are more accurate, which in
turn gives a visible reduction in error.  The MSE improvement is a factor
of 1.42.</span>
</figcaption>
</div></div><p>


</p>
<p></p>
<span class="anchor" id="fragment-Computemonophifordiffusearealightbounds-0"></span><div class="fragmentname">&lt;&lt;Compute <tt>phi</tt> for diffuse area light bounds&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">Float phi = 0;
if (image) {
    &lt;&lt;<span class="fragmentname">Compute average <tt>DiffuseAreaLight</tt> image channel value</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1739" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1739"><i></i></a><div id="fragbit-1739" class="collapse show"><div class="fragmentcode">       // Assume no distortion in the mapping, FWIW...
       for (int y = 0; y &lt; image.Resolution().y; ++y)
           for (int x = 0; x &lt; image.Resolution().x; ++x)
               for (int c = 0; c &lt; 3; ++c)
                   phi += image.GetChannel({x, y}, c);
       phi /= 3 * image.Resolution().x * image.Resolution().y;</div></div>
} else
    phi = <a href="../Light_Sources/Area_Lights.html#DiffuseAreaLight::Lemit" class="code">Lemit</a>-&gt;<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#Spectrum::MaxValue" class="code">MaxValue</a>();
phi *= <a href="../Light_Sources/Area_Lights.html#DiffuseAreaLight::scale" class="code">scale</a> * <a href="../Light_Sources/Area_Lights.html#DiffuseAreaLight::area" class="code">area</a> * <a href="../Utilities/Mathematical_Infrastructure.html#Pi" class="code">Pi</a>;</div><p>


</p>
<p>

</p>
<p>

</p>
<p></p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">
<a href="#x3-CompactlyBoundingLights"><i class="fas fa-link h3h4marginlink"></i></a>
</div>
<div class="col-md-10 col-lg-8">
<span id="x3-CompactlyBoundingLights"></span><h4>Compactly Bounding Lights</h4><p>


</p>
<p>The <a href="#LightBounds"><tt>LightBounds</tt></a> class uses 52 bytes of storage.  This is not a
problem as far as the total amount of memory consumed for the lights in the
scene, but it does affect
performance from the amount of space it uses in the cache.  For scenes with
thousands of lights, multiple instances of the <a href="#LightBounds"><tt>LightBounds</tt></a> will be
accessed when traversing the light BVH, and so minimizing its storage
requirements improves cache performance and thus overall performance.
(This is especially the case on the GPU, since many threads run
concurrently on each processor and each will generally follow a different
path through the light BVH and thus access different <a href="#LightBounds"><tt>LightBounds</tt></a>
instances.)

</p>
<p>Therefore, we have also implemented a <a href="#CompactLightBounds"><tt>CompactLightBounds</tt></a> class, which
applies a number of techniques to reduce storage requirements for the
<a href="#LightBounds"><tt>LightBounds</tt></a> information.  It uses just 24 bytes of storage.  We use
both classes in <tt>pbrt</tt>: the uncompressed <a href="#LightBounds"><tt>LightBounds</tt></a> is convenient for
lights to return from their <tt>Bounds()</tt> methods and is also a good
representation to use when building the light BVH.
<a href="#CompactLightBounds"><tt>CompactLightBounds</tt></a> is used solely in the in-memory representation of
light BVH nodes, where minimizing size is beneficial to performance.

</p>
<p></p>
<span class="anchor" id="fragment-CompactLightBoundsDefinition-0"></span><div class="fragmentname">&lt;&lt;CompactLightBounds Definition&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">class <span class="anchor" id="CompactLightBounds"></span>CompactLightBounds {
public:
    &lt;&lt;<span class="fragmentname"><a href="#fragment-CompactLightBoundsPublicMethods-0">CompactLightBounds Public Methods</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1740" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1740"><i></i></a><div id="fragbit-1740" class="collapse show"><div class="fragmentcode">       CompactLightBounds() = default;
       CompactLightBounds(const <a href="#LightBounds" class="code">LightBounds</a> &amp;lb, const <a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3f" class="code">Bounds3f</a> &amp;allb) 
           : <a href="#LightBounds::w" class="code">w</a>(<a href="../Geometry_and_Transformations/Vectors.html#Normalize" class="code">Normalize</a>(lb.<a href="#LightBounds::w" class="code">w</a>)), <a href="#LightBounds::phi" class="code">phi</a>(lb.<a href="#LightBounds::phi" class="code">phi</a>), 
             <a href="#CompactLightBounds::qCosTheta_o" class="code">qCosTheta_o</a>(<a href="#CompactLightBounds::QuantizeCos" class="code">QuantizeCos</a>(lb.<a href="#LightBounds::cosTheta_o" class="code">cosTheta_o</a>)),
             <a href="#CompactLightBounds::qCosTheta_e" class="code">qCosTheta_e</a>(<a href="#CompactLightBounds::QuantizeCos" class="code">QuantizeCos</a>(lb.<a href="#LightBounds::cosTheta_e" class="code">cosTheta_e</a>)), <a href="#CompactLightBounds::twoSided" class="code">twoSided</a>(lb.<a href="#CompactLightBounds::twoSided" class="code">twoSided</a>) {
          &lt;&lt;<span class="fragmentname"><a href="#fragment-Quantizeboundingboxintomonoqb-0">Quantize bounding box into <tt>qb</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1741" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1741"><i></i></a><div id="fragbit-1741" class="collapse show"><div class="fragmentcode">             for (int c = 0; c &lt; 3; ++c) {
                 qb[0][c] = pstd::floor(<a href="#CompactLightBounds::QuantizeBounds" class="code">QuantizeBounds</a>(lb.<a href="#LightBounds::bounds" class="code">bounds</a>[0][c],
                                                       allb.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3::pMin" class="code">pMin</a>[c], allb.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3::pMin" class="code">pMax</a>[c]));
                 qb[1][c] = pstd::ceil(<a href="#CompactLightBounds::QuantizeBounds" class="code">QuantizeBounds</a>(lb.<a href="#LightBounds::bounds" class="code">bounds</a>[1][c],
                                                      allb.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3::pMin" class="code">pMin</a>[c], allb.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3::pMin" class="code">pMax</a>[c]));
             }</div></div>
       }
       std::string ToString() const;
       std::string ToString(const <a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3f" class="code">Bounds3f</a> &amp;allBounds) const;
       bool TwoSided() const { return <a href="#CompactLightBounds::twoSided" class="code">twoSided</a>; }
       Float <a href="#CompactLightBounds::CosTheta_o" class="code">CosTheta_o</a>() const { return 2 * (<a href="#CompactLightBounds::qCosTheta_o" class="code">qCosTheta_o</a> / 32767.f) - 1; }
       Float <a href="#CompactLightBounds::CosTheta_e" class="code">CosTheta_e</a>() const { return 2 * (<a href="#CompactLightBounds::qCosTheta_e" class="code">qCosTheta_e</a> / 32767.f) - 1; }
       <a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3f" class="code">Bounds3f</a> <a href="#CompactLightBounds::Bounds" class="code">Bounds</a>(const <a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3f" class="code">Bounds3f</a> &amp;allb) const {
           return {<a href="../Geometry_and_Transformations/Points.html#Point3f" class="code">Point3f</a>(<a href="../Monte_Carlo_Integration/Sampling_Using_the_Inversion_Method.html#Lerp" class="code">Lerp</a>(<a href="#CompactLightBounds::qb" class="code">qb</a>[0][0] / 65535.f, allb.pMin.x, allb.pMax.x),
                           <a href="../Monte_Carlo_Integration/Sampling_Using_the_Inversion_Method.html#Lerp" class="code">Lerp</a>(<a href="#CompactLightBounds::qb" class="code">qb</a>[0][1] / 65535.f, allb.pMin.y, allb.pMax.y),
                           <a href="../Monte_Carlo_Integration/Sampling_Using_the_Inversion_Method.html#Lerp" class="code">Lerp</a>(<a href="#CompactLightBounds::qb" class="code">qb</a>[0][2] / 65535.f, allb.pMin.z, allb.pMax.z)),
                   <a href="../Geometry_and_Transformations/Points.html#Point3f" class="code">Point3f</a>(<a href="../Monte_Carlo_Integration/Sampling_Using_the_Inversion_Method.html#Lerp" class="code">Lerp</a>(<a href="#CompactLightBounds::qb" class="code">qb</a>[1][0] / 65535.f, allb.pMin.x, allb.pMax.x),
                           <a href="../Monte_Carlo_Integration/Sampling_Using_the_Inversion_Method.html#Lerp" class="code">Lerp</a>(<a href="#CompactLightBounds::qb" class="code">qb</a>[1][1] / 65535.f, allb.pMin.y, allb.pMax.y),
                           <a href="../Monte_Carlo_Integration/Sampling_Using_the_Inversion_Method.html#Lerp" class="code">Lerp</a>(<a href="#CompactLightBounds::qb" class="code">qb</a>[1][2] / 65535.f, allb.pMin.z, allb.pMax.z))};
       }
       Float Importance(<a href="../Geometry_and_Transformations/Points.html#Point3f" class="code">Point3f</a> p, <a href="../Geometry_and_Transformations/Normals.html#Normal3f" class="code">Normal3f</a> n, const <a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3f" class="code">Bounds3f</a> &amp;allb) const {
           <a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3f" class="code">Bounds3f</a> bounds = <a href="#CompactLightBounds::Bounds" class="code">Bounds</a>(allb);
           Float <a href="#LightBounds::cosTheta_o" class="code">cosTheta_o</a> = <a href="#CompactLightBounds::CosTheta_o" class="code">CosTheta_o</a>(), <a href="#LightBounds::cosTheta_e" class="code">cosTheta_e</a> = <a href="#CompactLightBounds::CosTheta_e" class="code">CosTheta_e</a>();
           &lt;&lt;<span class="fragmentname"><a href="#fragment-Returnimportanceforlightboundsatreferencepoint-0">Return importance for light bounds at reference point</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1742" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1742"><i></i></a><div id="fragbit-1742" class="collapse show"><div class="fragmentcode">              &lt;&lt;<span class="fragmentname"><a href="#fragment-Computeclampedsquareddistancetoreferencepoint-0">Compute clamped squared distance to reference point</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1743" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1743"><i></i></a><div id="fragbit-1743" class="collapse show"><div class="fragmentcode">                 <a href="../Geometry_and_Transformations/Points.html#Point3f" class="code">Point3f</a> pc = (<a href="#LightBounds::bounds" class="code">bounds</a>.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3::pMin" class="code">pMin</a> + <a href="#LightBounds::bounds" class="code">bounds</a>.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3::pMax" class="code">pMax</a>) / 2;
                 Float d2 = <a href="../Geometry_and_Transformations/Points.html#DistanceSquared" class="code">DistanceSquared</a>(p, pc);
                 d2 = std::max(d2, <a href="../Geometry_and_Transformations/Vectors.html#Length" class="code">Length</a>(<a href="#LightBounds::bounds" class="code">bounds</a>.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3::Diagonal" class="code">Diagonal</a>()) / 2);</div></div>
              &lt;&lt;<span class="fragmentname"><a href="#fragment-Definecosineandsineclampedsubtractionlambdas-0">Define cosine and sine clamped subtraction lambdas</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1744" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1744"><i></i></a><div id="fragbit-1744" class="collapse show"><div class="fragmentcode">                 auto cosSubClamped = [](Float sinTheta_a, Float cosTheta_a,
                                         Float sinTheta_b, Float cosTheta_b) -&gt; Float {
                     if (cosTheta_a &gt; cosTheta_b)
                         return 1;
                     return cosTheta_a * cosTheta_b + sinTheta_a * sinTheta_b;
                 };
                 auto sinSubClamped = [](Float sinTheta_a, Float cosTheta_a,
                                         Float sinTheta_b, Float cosTheta_b) -&gt; Float {
                     if (cosTheta_a &gt; cosTheta_b)
                         return 0;
                     return sinTheta_a * cosTheta_b - cosTheta_a * sinTheta_b;
                 };</div></div>
              &lt;&lt;<span class="fragmentname"><a href="#fragment-Computesineandcosineofangletovectormonowtheta_romanw-0">Compute sine and cosine of angle to vector <tt>w</tt>, <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.509ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 1080.4 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">theta Subscript normal w</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D703" d="M455 500c0 -224 -152 -511 -293 -511c-91 0 -120 111 -120 205c0 229 154 511 293 511c102 0 120 -139 120 -205zM389 562c0 57 -6 121 -55 121c-45 0 -82 -56 -109 -105c-40 -71 -60 -151 -77 -215h209c24 99 32 150 32 199zM348 331h-208c-26 -98 -32 -156 -32 -198 c0 -93 21 -122 54 -122c43 0 81 49 116 117c38 72 59 157 70 203Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-77" d="M703 400c-35 -1 -66 -14 -84 -64l-117 -328c-4 -10 -7 -19 -20 -19s-16 8 -20 19l-102 284l-101 -283c-5 -14 -7 -20 -20 -20s-16 8 -21 22l-126 354c-12 32 -24 35 -74 35v31l93 -3l109 3v-31c-20 0 -59 0 -59 -27c0 -4 0 -6 5 -18l95 -267l86 242c-7 19 -18 49 -23 55 c-10 13 -26 15 -63 15v31c30 -2 59 -3 89 -3l104 3v-31c-20 0 -59 0 -59 -27c0 -5 1 -7 5 -19l99 -279l91 256c5 13 5 15 5 21c0 29 -22 47 -58 48v31l93 -3c22 0 51 1 73 3v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D703" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-77" x="663" y="-213"></use>
</g>
</svg></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1745" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1745"><i></i></a><div id="fragbit-1745" class="collapse show"><div class="fragmentcode">                 <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> wi = <a href="../Geometry_and_Transformations/Vectors.html#Normalize" class="code">Normalize</a>(p - pc);
                 Float cosTheta_w = <a href="../Geometry_and_Transformations/Vectors.html#Dot" class="code">Dot</a>(<a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a>(<a href="#LightBounds::w" class="code">w</a>), wi);
                 if (<a href="#LightBounds::twoSided" class="code">twoSided</a>)
                     cosTheta_w = std::abs(cosTheta_w);
                 Float sinTheta_w = <a href="../Utilities/Mathematical_Infrastructure.html#SafeSqrt" class="code">SafeSqrt</a>(1 - <a href="../Utilities/Mathematical_Infrastructure.html#Sqr" class="code">Sqr</a>(cosTheta_w));</div></div>
              &lt;&lt;<span class="fragmentname"><a href="#fragment-Computecostheta_romanbforreferencepoint-0">Compute <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="6.509ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 2802.5 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">cosine theta Subscript normal b</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-63" d="M415 119c0 -10 -32 -130 -166 -130c-116 0 -215 99 -215 227c0 124 92 232 217 232c77 0 153 -39 153 -107c0 -30 -20 -47 -46 -47c-28 0 -46 20 -46 46c0 13 6 43 47 46c-35 36 -98 37 -107 37c-53 0 -135 -42 -135 -205c0 -161 88 -204 141 -204c37 0 102 12 131 105 c2 6 4 10 13 10c3 0 13 0 13 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6F" d="M471 214c0 -127 -101 -225 -222 -225c-117 0 -221 96 -221 225c0 125 97 234 222 234c121 0 221 -106 221 -234zM388 222c0 38 0 96 -26 139s-69 65 -113 65c-40 0 -87 -21 -114 -67c-24 -44 -24 -98 -24 -137c0 -36 0 -97 25 -141c27 -46 71 -67 114 -67 c50 0 94 29 116 74c22 44 22 98 22 134Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-73" d="M360 128c0 -72 -46 -139 -161 -139c-21 0 -66 1 -110 43c-18 -19 -18 -21 -20 -23c-19 -19 -20 -20 -25 -20c-11 0 -11 7 -11 24v132c0 18 0 25 13 25c10 0 11 -4 14 -17c19 -85 55 -142 139 -142c78 0 113 40 113 91c0 72 -82 88 -104 92c-72 14 -100 20 -132 46 c-27 22 -43 50 -43 85c0 56 38 123 160 123c15 0 56 0 94 -28c4 3 14 12 17 16c13 12 15 12 20 12c11 0 11 -7 11 -24v-101c0 -19 0 -24 -13 -24c0 0 -11 0 -12 9c-2 31 -7 121 -117 121c-86 0 -112 -41 -112 -76c0 -58 67 -71 123 -82c42 -8 81 -16 114 -48 c12 -12 42 -42 42 -95Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D703" d="M455 500c0 -224 -152 -511 -293 -511c-91 0 -120 111 -120 205c0 229 154 511 293 511c102 0 120 -139 120 -205zM389 562c0 57 -6 121 -55 121c-45 0 -82 -56 -109 -105c-40 -71 -60 -151 -77 -215h209c24 99 32 150 32 199zM348 331h-208c-26 -98 -32 -156 -32 -198 c0 -93 21 -122 54 -122c43 0 81 49 116 117c38 72 59 157 70 203Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-62" d="M521 216c0 -129 -104 -227 -223 -227c-74 0 -116 50 -131 73l-36 -62h-25v596c0 49 -8 56 -78 56v31l144 11v-317c16 18 59 65 137 65c114 0 212 -99 212 -226zM438 217c0 41 -3 98 -29 139c-24 38 -60 64 -105 64c-24 0 -79 -8 -118 -64c-11 -16 -11 -17 -11 -36v-206 c0 -18 0 -21 14 -42c24 -37 60 -61 105 -61c54 0 92 33 113 64c29 45 31 105 31 142Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-63"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-6F" x="444" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-73" x="945" y="0"></use>
<g transform="translate(1672,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D703" x="0" y="0"></use>
<g transform="translate(469,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-62" x="235" y="0"></use>
</g>
</g>
</g>
</svg> for reference point</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1746" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1746"><i></i></a><div id="fragbit-1746" class="collapse show"><div class="fragmentcode">                 Float cosTheta_b = <a href="../Geometry_and_Transformations/Spherical_Geometry.html#DirectionCone::BoundSubtendedDirections" class="code">BoundSubtendedDirections</a>(<a href="#LightBounds::bounds" class="code">bounds</a>, p).<a href="../Geometry_and_Transformations/Spherical_Geometry.html#DirectionCone::cosTheta" class="code">cosTheta</a>;
                 Float sinTheta_b = <a href="../Utilities/Mathematical_Infrastructure.html#SafeSqrt" class="code">SafeSqrt</a>(1 - <a href="../Utilities/Mathematical_Infrastructure.html#Sqr" class="code">Sqr</a>(cosTheta_b));</div></div>
              &lt;&lt;<span class="fragmentname"><a href="#fragment-Computecosthetaandtestagainstcostheta_romane-0">Compute <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.877ex" height="2.343ex" style="vertical-align: -0.338ex;" viewBox="0 -863.1 2530.5 1008.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">cosine theta prime</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-63" d="M415 119c0 -10 -32 -130 -166 -130c-116 0 -215 99 -215 227c0 124 92 232 217 232c77 0 153 -39 153 -107c0 -30 -20 -47 -46 -47c-28 0 -46 20 -46 46c0 13 6 43 47 46c-35 36 -98 37 -107 37c-53 0 -135 -42 -135 -205c0 -161 88 -204 141 -204c37 0 102 12 131 105 c2 6 4 10 13 10c3 0 13 0 13 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6F" d="M471 214c0 -127 -101 -225 -222 -225c-117 0 -221 96 -221 225c0 125 97 234 222 234c121 0 221 -106 221 -234zM388 222c0 38 0 96 -26 139s-69 65 -113 65c-40 0 -87 -21 -114 -67c-24 -44 -24 -98 -24 -137c0 -36 0 -97 25 -141c27 -46 71 -67 114 -67 c50 0 94 29 116 74c22 44 22 98 22 134Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-73" d="M360 128c0 -72 -46 -139 -161 -139c-21 0 -66 1 -110 43c-18 -19 -18 -21 -20 -23c-19 -19 -20 -20 -25 -20c-11 0 -11 7 -11 24v132c0 18 0 25 13 25c10 0 11 -4 14 -17c19 -85 55 -142 139 -142c78 0 113 40 113 91c0 72 -82 88 -104 92c-72 14 -100 20 -132 46 c-27 22 -43 50 -43 85c0 56 38 123 160 123c15 0 56 0 94 -28c4 3 14 12 17 16c13 12 15 12 20 12c11 0 11 -7 11 -24v-101c0 -19 0 -24 -13 -24c0 0 -11 0 -12 9c-2 31 -7 121 -117 121c-86 0 -112 -41 -112 -76c0 -58 67 -71 123 -82c42 -8 81 -16 114 -48 c12 -12 42 -42 42 -95Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D703" d="M455 500c0 -224 -152 -511 -293 -511c-91 0 -120 111 -120 205c0 229 154 511 293 511c102 0 120 -139 120 -205zM389 562c0 57 -6 121 -55 121c-45 0 -82 -56 -109 -105c-40 -71 -60 -151 -77 -215h209c24 99 32 150 32 199zM348 331h-208c-26 -98 -32 -156 -32 -198 c0 -93 21 -122 54 -122c43 0 81 49 116 117c38 72 59 157 70 203Z"></path>
<path stroke-width="1" id="E1-LATINMODERNVARIANTS-2032" d="M340 496c0 -10 -3 -20 -8 -28l-227 -372h-38l171 424c6 15 26 29 48 29c30 0 54 -24 54 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-63"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-6F" x="444" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-73" x="945" y="0"></use>
<g transform="translate(1672,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D703" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNVARIANTS-2032" x="663" y="513"></use>
</g>
</g>
</svg> and test against <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.938ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 2556.6 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">cosine theta Subscript normal e</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-63" d="M415 119c0 -10 -32 -130 -166 -130c-116 0 -215 99 -215 227c0 124 92 232 217 232c77 0 153 -39 153 -107c0 -30 -20 -47 -46 -47c-28 0 -46 20 -46 46c0 13 6 43 47 46c-35 36 -98 37 -107 37c-53 0 -135 -42 -135 -205c0 -161 88 -204 141 -204c37 0 102 12 131 105 c2 6 4 10 13 10c3 0 13 0 13 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6F" d="M471 214c0 -127 -101 -225 -222 -225c-117 0 -221 96 -221 225c0 125 97 234 222 234c121 0 221 -106 221 -234zM388 222c0 38 0 96 -26 139s-69 65 -113 65c-40 0 -87 -21 -114 -67c-24 -44 -24 -98 -24 -137c0 -36 0 -97 25 -141c27 -46 71 -67 114 -67 c50 0 94 29 116 74c22 44 22 98 22 134Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-73" d="M360 128c0 -72 -46 -139 -161 -139c-21 0 -66 1 -110 43c-18 -19 -18 -21 -20 -23c-19 -19 -20 -20 -25 -20c-11 0 -11 7 -11 24v132c0 18 0 25 13 25c10 0 11 -4 14 -17c19 -85 55 -142 139 -142c78 0 113 40 113 91c0 72 -82 88 -104 92c-72 14 -100 20 -132 46 c-27 22 -43 50 -43 85c0 56 38 123 160 123c15 0 56 0 94 -28c4 3 14 12 17 16c13 12 15 12 20 12c11 0 11 -7 11 -24v-101c0 -19 0 -24 -13 -24c0 0 -11 0 -12 9c-2 31 -7 121 -117 121c-86 0 -112 -41 -112 -76c0 -58 67 -71 123 -82c42 -8 81 -16 114 -48 c12 -12 42 -42 42 -95Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D703" d="M455 500c0 -224 -152 -511 -293 -511c-91 0 -120 111 -120 205c0 229 154 511 293 511c102 0 120 -139 120 -205zM389 562c0 57 -6 121 -55 121c-45 0 -82 -56 -109 -105c-40 -71 -60 -151 -77 -215h209c24 99 32 150 32 199zM348 331h-208c-26 -98 -32 -156 -32 -198 c0 -93 21 -122 54 -122c43 0 81 49 116 117c38 72 59 157 70 203Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-65" d="M415 119c0 -19 -45 -130 -167 -130c-115 0 -220 97 -220 231c0 125 92 228 208 228c125 0 179 -97 179 -196c0 -21 -3 -21 -25 -21h-279c0 -36 0 -102 30 -150c23 -37 63 -67 113 -67c10 0 100 0 135 103c2 8 4 14 13 14c5 0 13 -2 13 -12zM349 252 c0 39 -10 174 -113 174c-34 0 -118 -25 -124 -174h237Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-63"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-6F" x="444" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-73" x="945" y="0"></use>
<g transform="translate(1672,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D703" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-65" x="663" y="-213"></use>
</g>
</g>
</svg></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1747" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1747"><i></i></a><div id="fragbit-1747" class="collapse show"><div class="fragmentcode">                 Float sinTheta_o = <a href="../Utilities/Mathematical_Infrastructure.html#SafeSqrt" class="code">SafeSqrt</a>(1 - <a href="../Utilities/Mathematical_Infrastructure.html#Sqr" class="code">Sqr</a>(cosTheta_o));
                 Float cosTheta_x =
                     cosSubClamped(sinTheta_w, cosTheta_w, sinTheta_o, cosTheta_o);
                 Float sinTheta_x =
                     sinSubClamped(sinTheta_w, cosTheta_w, sinTheta_o, cosTheta_o);
                 Float cosThetap =
                     cosSubClamped(sinTheta_x, cosTheta_x, sinTheta_b, cosTheta_b);
                 if (cosThetap &lt;= cosTheta_e)
                     return 0;</div></div>
              &lt;&lt;<span class="fragmentname"><a href="#fragment-Returnfinalimportanceatreferencepoint-0">Return final importance at reference point</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1748" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1748"><i></i></a><div id="fragbit-1748" class="collapse show"><div class="fragmentcode">                 Float importance = phi * cosThetap / d2;
                 &lt;&lt;<span class="fragmentname"><a href="#fragment-Accountforcostheta_romaniinimportanceatsurfaces-0">Account for <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.278ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 2272.6 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">cosine theta Subscript normal i</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-63" d="M415 119c0 -10 -32 -130 -166 -130c-116 0 -215 99 -215 227c0 124 92 232 217 232c77 0 153 -39 153 -107c0 -30 -20 -47 -46 -47c-28 0 -46 20 -46 46c0 13 6 43 47 46c-35 36 -98 37 -107 37c-53 0 -135 -42 -135 -205c0 -161 88 -204 141 -204c37 0 102 12 131 105 c2 6 4 10 13 10c3 0 13 0 13 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6F" d="M471 214c0 -127 -101 -225 -222 -225c-117 0 -221 96 -221 225c0 125 97 234 222 234c121 0 221 -106 221 -234zM388 222c0 38 0 96 -26 139s-69 65 -113 65c-40 0 -87 -21 -114 -67c-24 -44 -24 -98 -24 -137c0 -36 0 -97 25 -141c27 -46 71 -67 114 -67 c50 0 94 29 116 74c22 44 22 98 22 134Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-73" d="M360 128c0 -72 -46 -139 -161 -139c-21 0 -66 1 -110 43c-18 -19 -18 -21 -20 -23c-19 -19 -20 -20 -25 -20c-11 0 -11 7 -11 24v132c0 18 0 25 13 25c10 0 11 -4 14 -17c19 -85 55 -142 139 -142c78 0 113 40 113 91c0 72 -82 88 -104 92c-72 14 -100 20 -132 46 c-27 22 -43 50 -43 85c0 56 38 123 160 123c15 0 56 0 94 -28c4 3 14 12 17 16c13 12 15 12 20 12c11 0 11 -7 11 -24v-101c0 -19 0 -24 -13 -24c0 0 -11 0 -12 9c-2 31 -7 121 -117 121c-86 0 -112 -41 -112 -76c0 -58 67 -71 123 -82c42 -8 81 -16 114 -48 c12 -12 42 -42 42 -95Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D703" d="M455 500c0 -224 -152 -511 -293 -511c-91 0 -120 111 -120 205c0 229 154 511 293 511c102 0 120 -139 120 -205zM389 562c0 57 -6 121 -55 121c-45 0 -82 -56 -109 -105c-40 -71 -60 -151 -77 -215h209c24 99 32 150 32 199zM348 331h-208c-26 -98 -32 -156 -32 -198 c0 -93 21 -122 54 -122c43 0 81 49 116 117c38 72 59 157 70 203Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-69" d="M247 0c-34 1 -69 3 -104 3l-110 -3v31c67 0 78 0 78 45v269c0 49 -9 55 -74 55v31l140 11v-367c0 -39 4 -44 70 -44v-31zM192 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-63"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-6F" x="444" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-73" x="945" y="0"></use>
<g transform="translate(1506,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D703" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="663" y="-213"></use>
</g>
</g>
</svg> in importance at surfaces</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1749" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1749"><i></i></a><div id="fragbit-1749" class="collapse show"><div class="fragmentcode">                    if (n != <a href="../Geometry_and_Transformations/Normals.html#Normal3f" class="code">Normal3f</a>(0, 0, 0)) {
                        Float cosTheta_i = <a href="../Geometry_and_Transformations/Vectors.html#AbsDot" class="code">AbsDot</a>(wi, n);
                        Float sinTheta_i = <a href="../Utilities/Mathematical_Infrastructure.html#SafeSqrt" class="code">SafeSqrt</a>(1 - <a href="../Utilities/Mathematical_Infrastructure.html#Sqr" class="code">Sqr</a>(cosTheta_i));
                        Float cosThetap_i = cosSubClamped(sinTheta_i, cosTheta_i,
                                                          sinTheta_b, cosTheta_b);
                        importance *= cosThetap_i;
                    }</div></div> 
                 return importance;</div></div></div></div>
       }</div></div>
private:
    &lt;&lt;<span class="fragmentname"><a href="#fragment-CompactLightBoundsPrivateMethods-0">CompactLightBounds Private Methods</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1750" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1750"><i></i></a><div id="fragbit-1750" class="collapse show"><div class="fragmentcode">       static unsigned int QuantizeCos(Float c) {
           return pstd::floor(32767.f * ((c + 1) / 2));
       }
       static Float QuantizeBounds(Float c, Float min, Float max) {
           if (min == max) return 0;
           return 65535.f * <a href="../Utilities/Mathematical_Infrastructure.html#Clamp" class="code">Clamp</a>((c - min) / (max - min), 0, 1);
       }</div></div>
    &lt;&lt;<span class="fragmentname"><a href="#fragment-CompactLightBoundsPrivateMembers-0">CompactLightBounds Private Members</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1751" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1751"><i></i></a><div id="fragbit-1751" class="collapse show"><div class="fragmentcode">       <a href="../Geometry_and_Transformations/Spherical_Geometry.html#OctahedralVector" class="code">OctahedralVector</a> w;
       Float phi = 0;
       struct {
           unsigned int qCosTheta_o: 15;
           unsigned int qCosTheta_e: 15;
           unsigned int twoSided: 1;
       };
       uint16_t qb[2][3];</div></div>
};</div><p>


</p>
<p>

</p>
<p>Its constructor takes both a <a href="#LightBounds"><tt>LightBounds</tt></a> instance and a bounding box
<tt>allb</tt> that must completely bound <a href="#LightBounds::bounds"><tt>LightBounds::bounds</tt></a>.
This bounding box is used to compute quantized bounding box vertex
positions to reduce their storage requirements.

</p>
<p></p>
<span class="anchor" id="fragment-CompactLightBoundsPublicMethods-0"></span><div class="fragmentname">&lt;&lt;CompactLightBounds Public Methods&gt;&gt;=&nbsp;<a href="#fragment-CompactLightBoundsPublicMethods-1"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode">CompactLightBounds(const <a href="#LightBounds" class="code">LightBounds</a> &amp;lb, const <a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3f" class="code">Bounds3f</a> &amp;allb) 
    : <a href="#LightBounds::w" class="code">w</a>(<a href="../Geometry_and_Transformations/Vectors.html#Normalize" class="code">Normalize</a>(lb.<a href="#LightBounds::w" class="code">w</a>)), <a href="#LightBounds::phi" class="code">phi</a>(lb.<a href="#LightBounds::phi" class="code">phi</a>), 
      qCosTheta_o(<a href="#CompactLightBounds::QuantizeCos" class="code">QuantizeCos</a>(lb.<a href="#LightBounds::cosTheta_o" class="code">cosTheta_o</a>)),
      qCosTheta_e(<a href="#CompactLightBounds::QuantizeCos" class="code">QuantizeCos</a>(lb.<a href="#LightBounds::cosTheta_e" class="code">cosTheta_e</a>)), <a href="#LightBounds::twoSided" class="code">twoSided</a>(lb.<a href="#LightBounds::twoSided" class="code">twoSided</a>) {
   &lt;&lt;<span class="fragmentname"><a href="#fragment-Quantizeboundingboxintomonoqb-0">Quantize bounding box into <tt>qb</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1752" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1752"><i></i></a><div id="fragbit-1752" class="collapse show"><div class="fragmentcode">      for (int c = 0; c &lt; 3; ++c) {
          qb[0][c] = pstd::floor(<a href="#CompactLightBounds::QuantizeBounds" class="code">QuantizeBounds</a>(lb.<a href="#LightBounds::bounds" class="code">bounds</a>[0][c],
                                                allb.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3::pMin" class="code">pMin</a>[c], allb.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3::pMin" class="code">pMax</a>[c]));
          qb[1][c] = pstd::ceil(<a href="#CompactLightBounds::QuantizeBounds" class="code">QuantizeBounds</a>(lb.<a href="#LightBounds::bounds" class="code">bounds</a>[1][c],
                                               allb.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3::pMin" class="code">pMin</a>[c], allb.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3::pMin" class="code">pMax</a>[c]));
      }</div></div>
}</div><p>


</p>
<p>The <a href="../Geometry_and_Transformations/Spherical_Geometry.html#OctahedralVector"><tt>OctahedralVector</tt></a> class from Section&nbsp;<a href="../Geometry_and_Transformations/Spherical_Geometry.html#sec:octahedral-vector">3.8.3</a>
stores a unit vector in 4&nbsp;bytes, saving&nbsp;8 from the <a href="../Geometry_and_Transformations/Vectors.html#Vector3"><tt>Vector3</tt></a> used in
<a href="#LightBounds"><tt>LightBounds</tt></a>.  Then, the two cosines and the <tt>twoSided</tt> flag are
packed into another 4&nbsp;bytes using a bitfield, saving another&nbsp;8.  We have
left <tt>phi</tt> alone, since the various compactions already implemented
are sufficient for <tt>pbrt</tt>&rsquo;s current requirements.

</p>
<p></p>
<span class="anchor" id="fragment-CompactLightBoundsPrivateMembers-0"></span><div class="fragmentname">&lt;&lt;CompactLightBounds Private Members&gt;&gt;=&nbsp;<a href="#fragment-CompactLightBoundsPrivateMembers-1"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode"><a href="../Geometry_and_Transformations/Spherical_Geometry.html#OctahedralVector" class="code">OctahedralVector</a> <span class="anchor" id="CompactLightBounds::w"></span>w;
Float <span class="anchor" id="CompactLightBounds::phi"></span>phi = 0;
struct {
    unsigned int <span class="anchor" id="CompactLightBounds::qCosTheta_o"></span>qCosTheta_o: 15;
    unsigned int <span class="anchor" id="CompactLightBounds::qCosTheta_e"></span>qCosTheta_e: 15;
    unsigned int <span class="anchor" id="CompactLightBounds::twoSided"></span>twoSided: 1;
};</div><p>


</p>
<p><tt>QuantizeCos()</tt> maps the provided value (which is expected to be the
cosine of an angle and thus between <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.971ex" height="2.343ex" style="vertical-align: -0.505ex;" viewBox="0 -791.3 1279 1008.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">negative 1</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-2212" d="M722 250c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-2212" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-31" x="778" y="0"></use>
</g>
</svg> and 1) to a 15-bit unsigned
integer.  After being remapped to be in <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.653ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 2003.2 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">left-bracket 0 comma 1 right-bracket</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-5B" d="M256 -230c0 -11 -9 -20 -20 -20h-122v1000h122c11 0 20 -9 20 -20s-9 -20 -20 -20h-82v-920h82c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-30" d="M460 320c0 -79 -5 -157 -37 -226c-44 -95 -120 -116 -174 -116c-49 0 -122 20 -165 101c-41 76 -45 166 -45 241c0 80 5 158 37 227c41 93 114 119 174 119c42 0 124 -16 170 -112c35 -74 40 -154 40 -234zM377 332c0 63 0 139 -10 195c-19 99 -85 117 -118 117 c-25 0 -100 -9 -119 -128c-8 -54 -8 -120 -8 -184c0 -59 0 -151 11 -211c18 -96 77 -121 116 -121c45 0 102 30 117 125c11 64 11 132 11 207Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-5D" d="M164 -250h-122c-11 0 -20 9 -20 20s9 20 20 20h82v920h-82c-11 0 -20 9 -20 20s9 20 20 20h122v-1000Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-5B" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-30" x="278" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="779" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-31" x="1224" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-5D" x="1724" y="0"></use>
</g>
</svg>, multiplying by the largest
representable 15-bit unsigned integer, <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="16.599ex" height="3.009ex" style="vertical-align: -0.671ex;" viewBox="0 -1006.6 7146.8 1295.7" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">2 Superscript 15 Baseline minus 1 equals 32,767</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-32" d="M449 174l-28 -174h-371c0 24 0 26 11 37l192 214c55 62 105 141 105 221c0 82 -43 163 -134 163c-58 0 -112 -37 -135 -102c3 1 5 1 13 1c35 0 53 -26 53 -52c0 -41 -35 -53 -52 -53c-3 0 -53 0 -53 56c0 89 74 181 187 181c122 0 212 -80 212 -194 c0 -100 -60 -154 -216 -292l-106 -103h180c22 0 88 0 95 8c10 15 17 59 22 89h25Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-35" d="M449 201c0 -127 -102 -223 -218 -223c-112 0 -181 97 -181 183c0 46 35 53 49 53c33 0 50 -25 50 -49s-17 -49 -50 -49c-11 0 -14 1 -17 2c17 -59 74 -112 147 -112c46 0 83 26 107 65c24 42 24 102 24 137c0 50 -2 89 -18 126c-8 18 -33 64 -85 64 c-81 0 -118 -54 -129 -70c-4 -6 -6 -9 -13 -9c-14 0 -14 8 -14 26v296c0 16 0 24 10 24c0 0 4 0 12 -3c47 -21 93 -28 133 -28c67 0 116 20 136 29c5 3 8 3 8 3c7 0 10 -5 10 -11c0 -13 -70 -104 -193 -104c-32 0 -65 7 -85 13v-195c36 35 79 51 127 51 c108 0 190 -100 190 -219Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2212" d="M722 250c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3D" d="M722 347c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20zM722 153c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-33" d="M457 171c0 -102 -91 -193 -213 -193c-109 0 -202 66 -202 157c0 44 32 58 56 58c29 0 56 -20 56 -56c0 -38 -31 -60 -66 -55c35 -59 110 -76 153 -76c44 0 113 29 113 165c0 98 -37 166 -119 166h-44c-17 0 -24 0 -24 11c0 10 7 11 15 12c7 0 31 2 39 3c25 1 59 4 89 52 c26 44 28 102 28 114c0 90 -55 112 -96 112c-36 0 -102 -13 -133 -62c15 0 62 0 62 -50c0 -29 -20 -51 -51 -51c-29 0 -51 19 -51 52c0 76 76 136 177 136c96 0 184 -56 184 -138c0 -79 -58 -149 -140 -176c104 -21 167 -99 167 -181Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-37" d="M485 644c0 -21 0 -23 -9 -35l-135 -190c-44 -62 -58 -148 -62 -171c-8 -54 -11 -109 -11 -164v-51c0 -10 0 -55 -46 -55s-46 45 -46 55c0 102 33 241 123 376l112 158h-207c-13 0 -91 0 -98 -6c-13 -12 -22 -75 -25 -91h-25l33 206h25c4 -19 6 -32 128 -32h243Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-36" d="M457 204c0 -132 -95 -226 -206 -226c-93 0 -209 71 -209 338c0 221 135 350 263 350c83 0 127 -48 127 -108c0 -39 -30 -48 -46 -48c-22 0 -46 15 -46 46c0 45 40 45 55 45c-22 34 -64 40 -88 40c-51 0 -175 -36 -175 -289v-24c20 48 57 99 125 99 c111 0 200 -96 200 -223zM367 205c0 49 0 100 -18 137c-31 62 -77 62 -93 62c-90 0 -122 -100 -122 -178c0 -18 0 -98 18 -145c6 -15 36 -75 99 -75c23 0 69 5 99 65c17 36 17 86 17 134Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-32" x="0" y="0"></use>
<g transform="translate(500,393)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-35" x="500" y="0"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2212" x="1530" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-31" x="2531" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="3309" y="0"></use>
<g transform="translate(4365,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-33"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-32" x="500" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="1001" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-37" x="1279" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-36" x="1780" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-37" x="2280" y="0"></use>
</g>
</g>
</svg>, gives a value
that spans the valid range.

</p>
<p>Note the use of <tt>pstd::floor()</tt> to round the quantized cosine value
down before returning it: this is preferable to, say, rounding to the
nearest integer, since it ensures that any quantization error serves to
slightly increase the corresponding angle rather than decreasing it.
(Decreasing it could lead to inadvertently determining that the light did
not illuminate a point that it actually did.)

</p>
<p></p>
<span class="anchor" id="fragment-CompactLightBoundsPrivateMethods-0"></span><div class="fragmentname">&lt;&lt;CompactLightBounds Private Methods&gt;&gt;=&nbsp;<a href="#fragment-CompactLightBoundsPrivateMethods-1"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode">static unsigned int <span class="anchor" id="CompactLightBounds::QuantizeCos"></span>QuantizeCos(Float c) {
    return pstd::floor(32767.f * ((c + 1) / 2));
}</div><p>


</p>
<p>The bounding box corners are also quantized.  Each coordinate of each
corner gets 16 bits, all of them stored in the <tt>qb</tt> member variable.
This brings the storage for the bounds down to 12&nbsp;bytes, from 24&nbsp;before.
Here the quantization is also conservative, rounding down at the lower end
of the extent and rounding up at the upper end.

</p>
<p></p>
<span class="anchor" id="fragment-Quantizeboundingboxintomonoqb-0"></span><div class="fragmentname">&lt;&lt;Quantize bounding box into <tt>qb</tt>&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">for (int c = 0; c &lt; 3; ++c) {
    qb[0][c] = pstd::floor(<a href="#CompactLightBounds::QuantizeBounds" class="code">QuantizeBounds</a>(lb.<a href="#LightBounds::bounds" class="code">bounds</a>[0][c],
                                          allb.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3::pMin" class="code">pMin</a>[c], allb.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3::pMin" class="code">pMax</a>[c]));
    qb[1][c] = pstd::ceil(<a href="#CompactLightBounds::QuantizeBounds" class="code">QuantizeBounds</a>(lb.<a href="#LightBounds::bounds" class="code">bounds</a>[1][c],
                                         allb.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3::pMin" class="code">pMin</a>[c], allb.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3::pMin" class="code">pMax</a>[c]));
}</div><p>


</p>
<p></p>
<span class="anchor" id="fragment-CompactLightBoundsPrivateMembers-1"></span><div class="fragmentname">&lt;&lt;CompactLightBounds Private Members&gt;&gt;+=&nbsp;<a href="#fragment-CompactLightBoundsPrivateMembers-0"><span class="fa fa-caret-up"></span></a></div>
<div class="fragmentcode">uint16_t <span class="anchor" id="CompactLightBounds::qb"></span>qb[2][3];</div><p>


</p>
<p><tt>QuantizeBounds()</tt> remaps a coordinate value <tt>c</tt> between
<tt>min</tt> and <tt>max</tt> to the range <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="10.532ex" height="3.176ex" style="vertical-align: -0.838ex;" viewBox="0 -1006.6 4534.4 1367.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">left-bracket 0 comma 2 Superscript 16 Baseline minus 1 right-bracket</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-5B" d="M256 -230c0 -11 -9 -20 -20 -20h-122v1000h122c11 0 20 -9 20 -20s-9 -20 -20 -20h-82v-920h82c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-30" d="M460 320c0 -79 -5 -157 -37 -226c-44 -95 -120 -116 -174 -116c-49 0 -122 20 -165 101c-41 76 -45 166 -45 241c0 80 5 158 37 227c41 93 114 119 174 119c42 0 124 -16 170 -112c35 -74 40 -154 40 -234zM377 332c0 63 0 139 -10 195c-19 99 -85 117 -118 117 c-25 0 -100 -9 -119 -128c-8 -54 -8 -120 -8 -184c0 -59 0 -151 11 -211c18 -96 77 -121 116 -121c45 0 102 30 117 125c11 64 11 132 11 207Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-32" d="M449 174l-28 -174h-371c0 24 0 26 11 37l192 214c55 62 105 141 105 221c0 82 -43 163 -134 163c-58 0 -112 -37 -135 -102c3 1 5 1 13 1c35 0 53 -26 53 -52c0 -41 -35 -53 -52 -53c-3 0 -53 0 -53 56c0 89 74 181 187 181c122 0 212 -80 212 -194 c0 -100 -60 -154 -216 -292l-106 -103h180c22 0 88 0 95 8c10 15 17 59 22 89h25Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-36" d="M457 204c0 -132 -95 -226 -206 -226c-93 0 -209 71 -209 338c0 221 135 350 263 350c83 0 127 -48 127 -108c0 -39 -30 -48 -46 -48c-22 0 -46 15 -46 46c0 45 40 45 55 45c-22 34 -64 40 -88 40c-51 0 -175 -36 -175 -289v-24c20 48 57 99 125 99 c111 0 200 -96 200 -223zM367 205c0 49 0 100 -18 137c-31 62 -77 62 -93 62c-90 0 -122 -100 -122 -178c0 -18 0 -98 18 -145c6 -15 36 -75 99 -75c23 0 69 5 99 65c17 36 17 86 17 134Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2212" d="M722 250c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-5D" d="M164 -250h-122c-11 0 -20 9 -20 20s9 20 20 20h82v920h-82c-11 0 -20 9 -20 20s9 20 20 20h122v-1000Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-5B" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-30" x="278" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="779" y="0"></use>
<g transform="translate(1224,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-32" x="0" y="0"></use>
<g transform="translate(500,393)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-36" x="500" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2212" x="2754" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-31" x="3755" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-5D" x="4255" y="0"></use>
</g>
</svg>, the range of values
that an unsigned 16-bit integer can store.

</p>
<p></p>
<span class="anchor" id="fragment-CompactLightBoundsPrivateMethods-1"></span><div class="fragmentname">&lt;&lt;CompactLightBounds Private Methods&gt;&gt;+=&nbsp;<a href="#fragment-CompactLightBoundsPrivateMethods-0"><span class="fa fa-caret-up"></span></a></div>
<div class="fragmentcode">static Float <span class="anchor" id="CompactLightBounds::QuantizeBounds"></span>QuantizeBounds(Float c, Float min, Float max) {
    if (min == max) return 0;
    return 65535.f * <a href="../Utilities/Mathematical_Infrastructure.html#Clamp" class="code">Clamp</a>((c - min) / (max - min), 0, 1);
}</div><p>


</p>
<p>

</p>
<p>A few convenience methods make the values of various member variables
available.  For the two quantized cosines, the inverse computation of
<tt>QuantizeCos()</tt> is performed.

</p>
<p></p>
<span class="anchor" id="fragment-CompactLightBoundsPublicMethods-1"></span><div class="fragmentname">&lt;&lt;CompactLightBounds Public Methods&gt;&gt;+=&nbsp;<a href="#fragment-CompactLightBoundsPublicMethods-0"><span class="fa fa-caret-up"></span></a>&nbsp;<a href="#fragment-CompactLightBoundsPublicMethods-2"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode">bool <span class="anchor" id="CompactLightBounds::TwoSided"></span>TwoSided() const { return <a href="#CompactLightBounds::twoSided" class="code">twoSided</a>; }
Float <span class="anchor" id="CompactLightBounds::CosTheta_o"></span>CosTheta_o() const { return 2 * (<a href="#CompactLightBounds::qCosTheta_o" class="code">qCosTheta_o</a> / 32767.f) - 1; }
Float <span class="anchor" id="CompactLightBounds::CosTheta_e"></span>CosTheta_e() const { return 2 * (<a href="#CompactLightBounds::qCosTheta_e" class="code">qCosTheta_e</a> / 32767.f) - 1; }</div><p>


</p>
<p>The <tt>Bounds()</tt> method returns the <tt>Bounds3f</tt> for the
<a href="#CompactLightBounds"><tt>CompactLightBounds</tt></a>.  It must be passed the same <a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3f"><tt>Bounds3f</tt></a> as was
originally passed to its constructor for the correct result to be returned.

</p>
<p></p>
<span class="anchor" id="fragment-CompactLightBoundsPublicMethods-2"></span><div class="fragmentname">&lt;&lt;CompactLightBounds Public Methods&gt;&gt;+=&nbsp;<a href="#fragment-CompactLightBoundsPublicMethods-1"><span class="fa fa-caret-up"></span></a>&nbsp;<a href="#fragment-CompactLightBoundsPublicMethods-3"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode"><a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3f" class="code">Bounds3f</a> <span class="anchor" id="CompactLightBounds::Bounds"></span>Bounds(const <a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3f" class="code">Bounds3f</a> &amp;allb) const {
    return {<a href="../Geometry_and_Transformations/Points.html#Point3f" class="code">Point3f</a>(<a href="../Monte_Carlo_Integration/Sampling_Using_the_Inversion_Method.html#Lerp" class="code">Lerp</a>(<a href="#CompactLightBounds::qb" class="code">qb</a>[0][0] / 65535.f, allb.pMin.x, allb.pMax.x),
                    <a href="../Monte_Carlo_Integration/Sampling_Using_the_Inversion_Method.html#Lerp" class="code">Lerp</a>(<a href="#CompactLightBounds::qb" class="code">qb</a>[0][1] / 65535.f, allb.pMin.y, allb.pMax.y),
                    <a href="../Monte_Carlo_Integration/Sampling_Using_the_Inversion_Method.html#Lerp" class="code">Lerp</a>(<a href="#CompactLightBounds::qb" class="code">qb</a>[0][2] / 65535.f, allb.pMin.z, allb.pMax.z)),
            <a href="../Geometry_and_Transformations/Points.html#Point3f" class="code">Point3f</a>(<a href="../Monte_Carlo_Integration/Sampling_Using_the_Inversion_Method.html#Lerp" class="code">Lerp</a>(<a href="#CompactLightBounds::qb" class="code">qb</a>[1][0] / 65535.f, allb.pMin.x, allb.pMax.x),
                    <a href="../Monte_Carlo_Integration/Sampling_Using_the_Inversion_Method.html#Lerp" class="code">Lerp</a>(<a href="#CompactLightBounds::qb" class="code">qb</a>[1][1] / 65535.f, allb.pMin.y, allb.pMax.y),
                    <a href="../Monte_Carlo_Integration/Sampling_Using_the_Inversion_Method.html#Lerp" class="code">Lerp</a>(<a href="#CompactLightBounds::qb" class="code">qb</a>[1][2] / 65535.f, allb.pMin.z, allb.pMax.z))};
}</div><p>


</p>
<p>



</p>
<p>Finally, <tt>CompactLightBounds()</tt> also provides an <tt>Importance()</tt>
method.  Its implementation also requires that the original <a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3f"><tt>Bounds3f</tt></a>
be provided so that the <tt>Bounds()</tt> method can be called.  Given the
unquantized bounds and cosines made available in appropriately named local
variables, the remainder of the implementation can share the same fragments
as were used in the implementation of <a href="#LightBounds::Importance"><tt>LightBounds::Importance()</tt></a>.

</p>
<p></p>
<span class="anchor" id="fragment-CompactLightBoundsPublicMethods-3"></span><div class="fragmentname">&lt;&lt;CompactLightBounds Public Methods&gt;&gt;+=&nbsp;<a href="#fragment-CompactLightBoundsPublicMethods-2"><span class="fa fa-caret-up"></span></a></div>
<div class="fragmentcode">Float <span class="anchor" id="CompactLightBounds::Importance"></span>Importance(<a href="../Geometry_and_Transformations/Points.html#Point3f" class="code">Point3f</a> p, <a href="../Geometry_and_Transformations/Normals.html#Normal3f" class="code">Normal3f</a> n, const <a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3f" class="code">Bounds3f</a> &amp;allb) const {
    <a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3f" class="code">Bounds3f</a> bounds = <a href="#CompactLightBounds::Bounds" class="code">Bounds</a>(allb);
    Float cosTheta_o = <a href="#CompactLightBounds::CosTheta_o" class="code">CosTheta_o</a>(), cosTheta_e = <a href="#CompactLightBounds::CosTheta_e" class="code">CosTheta_e</a>();
    &lt;&lt;<span class="fragmentname"><a href="#fragment-Returnimportanceforlightboundsatreferencepoint-0">Return importance for light bounds at reference point</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1753" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1753"><i></i></a><div id="fragbit-1753" class="collapse show"><div class="fragmentcode">       &lt;&lt;<span class="fragmentname"><a href="#fragment-Computeclampedsquareddistancetoreferencepoint-0">Compute clamped squared distance to reference point</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1754" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1754"><i></i></a><div id="fragbit-1754" class="collapse show"><div class="fragmentcode">          <a href="../Geometry_and_Transformations/Points.html#Point3f" class="code">Point3f</a> pc = (<a href="#LightBounds::bounds" class="code">bounds</a>.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3::pMin" class="code">pMin</a> + <a href="#LightBounds::bounds" class="code">bounds</a>.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3::pMax" class="code">pMax</a>) / 2;
          Float d2 = <a href="../Geometry_and_Transformations/Points.html#DistanceSquared" class="code">DistanceSquared</a>(p, pc);
          d2 = std::max(d2, <a href="../Geometry_and_Transformations/Vectors.html#Length" class="code">Length</a>(<a href="#LightBounds::bounds" class="code">bounds</a>.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3::Diagonal" class="code">Diagonal</a>()) / 2);</div></div>
       &lt;&lt;<span class="fragmentname"><a href="#fragment-Definecosineandsineclampedsubtractionlambdas-0">Define cosine and sine clamped subtraction lambdas</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1755" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1755"><i></i></a><div id="fragbit-1755" class="collapse show"><div class="fragmentcode">          auto cosSubClamped = [](Float sinTheta_a, Float cosTheta_a,
                                  Float sinTheta_b, Float cosTheta_b) -&gt; Float {
              if (cosTheta_a &gt; cosTheta_b)
                  return 1;
              return cosTheta_a * cosTheta_b + sinTheta_a * sinTheta_b;
          };
          auto sinSubClamped = [](Float sinTheta_a, Float cosTheta_a,
                                  Float sinTheta_b, Float cosTheta_b) -&gt; Float {
              if (cosTheta_a &gt; cosTheta_b)
                  return 0;
              return sinTheta_a * cosTheta_b - cosTheta_a * sinTheta_b;
          };</div></div>
       &lt;&lt;<span class="fragmentname"><a href="#fragment-Computesineandcosineofangletovectormonowtheta_romanw-0">Compute sine and cosine of angle to vector <tt>w</tt>, <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.509ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 1080.4 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">theta Subscript normal w</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D703" d="M455 500c0 -224 -152 -511 -293 -511c-91 0 -120 111 -120 205c0 229 154 511 293 511c102 0 120 -139 120 -205zM389 562c0 57 -6 121 -55 121c-45 0 -82 -56 -109 -105c-40 -71 -60 -151 -77 -215h209c24 99 32 150 32 199zM348 331h-208c-26 -98 -32 -156 -32 -198 c0 -93 21 -122 54 -122c43 0 81 49 116 117c38 72 59 157 70 203Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-77" d="M703 400c-35 -1 -66 -14 -84 -64l-117 -328c-4 -10 -7 -19 -20 -19s-16 8 -20 19l-102 284l-101 -283c-5 -14 -7 -20 -20 -20s-16 8 -21 22l-126 354c-12 32 -24 35 -74 35v31l93 -3l109 3v-31c-20 0 -59 0 -59 -27c0 -4 0 -6 5 -18l95 -267l86 242c-7 19 -18 49 -23 55 c-10 13 -26 15 -63 15v31c30 -2 59 -3 89 -3l104 3v-31c-20 0 -59 0 -59 -27c0 -5 1 -7 5 -19l99 -279l91 256c5 13 5 15 5 21c0 29 -22 47 -58 48v31l93 -3c22 0 51 1 73 3v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D703" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-77" x="663" y="-213"></use>
</g>
</svg></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1756" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1756"><i></i></a><div id="fragbit-1756" class="collapse show"><div class="fragmentcode">          <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> wi = <a href="../Geometry_and_Transformations/Vectors.html#Normalize" class="code">Normalize</a>(p - pc);
          Float cosTheta_w = <a href="../Geometry_and_Transformations/Vectors.html#Dot" class="code">Dot</a>(<a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a>(<a href="#LightBounds::w" class="code">w</a>), wi);
          if (<a href="#LightBounds::twoSided" class="code">twoSided</a>)
              cosTheta_w = std::abs(cosTheta_w);
          Float sinTheta_w = <a href="../Utilities/Mathematical_Infrastructure.html#SafeSqrt" class="code">SafeSqrt</a>(1 - <a href="../Utilities/Mathematical_Infrastructure.html#Sqr" class="code">Sqr</a>(cosTheta_w));</div></div>
       &lt;&lt;<span class="fragmentname"><a href="#fragment-Computecostheta_romanbforreferencepoint-0">Compute <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="6.509ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 2802.5 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">cosine theta Subscript normal b</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-63" d="M415 119c0 -10 -32 -130 -166 -130c-116 0 -215 99 -215 227c0 124 92 232 217 232c77 0 153 -39 153 -107c0 -30 -20 -47 -46 -47c-28 0 -46 20 -46 46c0 13 6 43 47 46c-35 36 -98 37 -107 37c-53 0 -135 -42 -135 -205c0 -161 88 -204 141 -204c37 0 102 12 131 105 c2 6 4 10 13 10c3 0 13 0 13 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6F" d="M471 214c0 -127 -101 -225 -222 -225c-117 0 -221 96 -221 225c0 125 97 234 222 234c121 0 221 -106 221 -234zM388 222c0 38 0 96 -26 139s-69 65 -113 65c-40 0 -87 -21 -114 -67c-24 -44 -24 -98 -24 -137c0 -36 0 -97 25 -141c27 -46 71 -67 114 -67 c50 0 94 29 116 74c22 44 22 98 22 134Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-73" d="M360 128c0 -72 -46 -139 -161 -139c-21 0 -66 1 -110 43c-18 -19 -18 -21 -20 -23c-19 -19 -20 -20 -25 -20c-11 0 -11 7 -11 24v132c0 18 0 25 13 25c10 0 11 -4 14 -17c19 -85 55 -142 139 -142c78 0 113 40 113 91c0 72 -82 88 -104 92c-72 14 -100 20 -132 46 c-27 22 -43 50 -43 85c0 56 38 123 160 123c15 0 56 0 94 -28c4 3 14 12 17 16c13 12 15 12 20 12c11 0 11 -7 11 -24v-101c0 -19 0 -24 -13 -24c0 0 -11 0 -12 9c-2 31 -7 121 -117 121c-86 0 -112 -41 -112 -76c0 -58 67 -71 123 -82c42 -8 81 -16 114 -48 c12 -12 42 -42 42 -95Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D703" d="M455 500c0 -224 -152 -511 -293 -511c-91 0 -120 111 -120 205c0 229 154 511 293 511c102 0 120 -139 120 -205zM389 562c0 57 -6 121 -55 121c-45 0 -82 -56 -109 -105c-40 -71 -60 -151 -77 -215h209c24 99 32 150 32 199zM348 331h-208c-26 -98 -32 -156 -32 -198 c0 -93 21 -122 54 -122c43 0 81 49 116 117c38 72 59 157 70 203Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-62" d="M521 216c0 -129 -104 -227 -223 -227c-74 0 -116 50 -131 73l-36 -62h-25v596c0 49 -8 56 -78 56v31l144 11v-317c16 18 59 65 137 65c114 0 212 -99 212 -226zM438 217c0 41 -3 98 -29 139c-24 38 -60 64 -105 64c-24 0 -79 -8 -118 -64c-11 -16 -11 -17 -11 -36v-206 c0 -18 0 -21 14 -42c24 -37 60 -61 105 -61c54 0 92 33 113 64c29 45 31 105 31 142Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-63"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-6F" x="444" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-73" x="945" y="0"></use>
<g transform="translate(1672,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D703" x="0" y="0"></use>
<g transform="translate(469,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-62" x="235" y="0"></use>
</g>
</g>
</g>
</svg> for reference point</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1757" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1757"><i></i></a><div id="fragbit-1757" class="collapse show"><div class="fragmentcode">          Float cosTheta_b = <a href="../Geometry_and_Transformations/Spherical_Geometry.html#DirectionCone::BoundSubtendedDirections" class="code">BoundSubtendedDirections</a>(<a href="#LightBounds::bounds" class="code">bounds</a>, p).<a href="../Geometry_and_Transformations/Spherical_Geometry.html#DirectionCone::cosTheta" class="code">cosTheta</a>;
          Float sinTheta_b = <a href="../Utilities/Mathematical_Infrastructure.html#SafeSqrt" class="code">SafeSqrt</a>(1 - <a href="../Utilities/Mathematical_Infrastructure.html#Sqr" class="code">Sqr</a>(cosTheta_b));</div></div>
       &lt;&lt;<span class="fragmentname"><a href="#fragment-Computecosthetaandtestagainstcostheta_romane-0">Compute <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.877ex" height="2.343ex" style="vertical-align: -0.338ex;" viewBox="0 -863.1 2530.5 1008.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">cosine theta prime</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-63" d="M415 119c0 -10 -32 -130 -166 -130c-116 0 -215 99 -215 227c0 124 92 232 217 232c77 0 153 -39 153 -107c0 -30 -20 -47 -46 -47c-28 0 -46 20 -46 46c0 13 6 43 47 46c-35 36 -98 37 -107 37c-53 0 -135 -42 -135 -205c0 -161 88 -204 141 -204c37 0 102 12 131 105 c2 6 4 10 13 10c3 0 13 0 13 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6F" d="M471 214c0 -127 -101 -225 -222 -225c-117 0 -221 96 -221 225c0 125 97 234 222 234c121 0 221 -106 221 -234zM388 222c0 38 0 96 -26 139s-69 65 -113 65c-40 0 -87 -21 -114 -67c-24 -44 -24 -98 -24 -137c0 -36 0 -97 25 -141c27 -46 71 -67 114 -67 c50 0 94 29 116 74c22 44 22 98 22 134Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-73" d="M360 128c0 -72 -46 -139 -161 -139c-21 0 -66 1 -110 43c-18 -19 -18 -21 -20 -23c-19 -19 -20 -20 -25 -20c-11 0 -11 7 -11 24v132c0 18 0 25 13 25c10 0 11 -4 14 -17c19 -85 55 -142 139 -142c78 0 113 40 113 91c0 72 -82 88 -104 92c-72 14 -100 20 -132 46 c-27 22 -43 50 -43 85c0 56 38 123 160 123c15 0 56 0 94 -28c4 3 14 12 17 16c13 12 15 12 20 12c11 0 11 -7 11 -24v-101c0 -19 0 -24 -13 -24c0 0 -11 0 -12 9c-2 31 -7 121 -117 121c-86 0 -112 -41 -112 -76c0 -58 67 -71 123 -82c42 -8 81 -16 114 -48 c12 -12 42 -42 42 -95Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D703" d="M455 500c0 -224 -152 -511 -293 -511c-91 0 -120 111 -120 205c0 229 154 511 293 511c102 0 120 -139 120 -205zM389 562c0 57 -6 121 -55 121c-45 0 -82 -56 -109 -105c-40 -71 -60 -151 -77 -215h209c24 99 32 150 32 199zM348 331h-208c-26 -98 -32 -156 -32 -198 c0 -93 21 -122 54 -122c43 0 81 49 116 117c38 72 59 157 70 203Z"></path>
<path stroke-width="1" id="E1-LATINMODERNVARIANTS-2032" d="M340 496c0 -10 -3 -20 -8 -28l-227 -372h-38l171 424c6 15 26 29 48 29c30 0 54 -24 54 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-63"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-6F" x="444" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-73" x="945" y="0"></use>
<g transform="translate(1672,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D703" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNVARIANTS-2032" x="663" y="513"></use>
</g>
</g>
</svg> and test against <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.938ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 2556.6 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">cosine theta Subscript normal e</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-63" d="M415 119c0 -10 -32 -130 -166 -130c-116 0 -215 99 -215 227c0 124 92 232 217 232c77 0 153 -39 153 -107c0 -30 -20 -47 -46 -47c-28 0 -46 20 -46 46c0 13 6 43 47 46c-35 36 -98 37 -107 37c-53 0 -135 -42 -135 -205c0 -161 88 -204 141 -204c37 0 102 12 131 105 c2 6 4 10 13 10c3 0 13 0 13 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6F" d="M471 214c0 -127 -101 -225 -222 -225c-117 0 -221 96 -221 225c0 125 97 234 222 234c121 0 221 -106 221 -234zM388 222c0 38 0 96 -26 139s-69 65 -113 65c-40 0 -87 -21 -114 -67c-24 -44 -24 -98 -24 -137c0 -36 0 -97 25 -141c27 -46 71 -67 114 -67 c50 0 94 29 116 74c22 44 22 98 22 134Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-73" d="M360 128c0 -72 -46 -139 -161 -139c-21 0 -66 1 -110 43c-18 -19 -18 -21 -20 -23c-19 -19 -20 -20 -25 -20c-11 0 -11 7 -11 24v132c0 18 0 25 13 25c10 0 11 -4 14 -17c19 -85 55 -142 139 -142c78 0 113 40 113 91c0 72 -82 88 -104 92c-72 14 -100 20 -132 46 c-27 22 -43 50 -43 85c0 56 38 123 160 123c15 0 56 0 94 -28c4 3 14 12 17 16c13 12 15 12 20 12c11 0 11 -7 11 -24v-101c0 -19 0 -24 -13 -24c0 0 -11 0 -12 9c-2 31 -7 121 -117 121c-86 0 -112 -41 -112 -76c0 -58 67 -71 123 -82c42 -8 81 -16 114 -48 c12 -12 42 -42 42 -95Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D703" d="M455 500c0 -224 -152 -511 -293 -511c-91 0 -120 111 -120 205c0 229 154 511 293 511c102 0 120 -139 120 -205zM389 562c0 57 -6 121 -55 121c-45 0 -82 -56 -109 -105c-40 -71 -60 -151 -77 -215h209c24 99 32 150 32 199zM348 331h-208c-26 -98 -32 -156 -32 -198 c0 -93 21 -122 54 -122c43 0 81 49 116 117c38 72 59 157 70 203Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-65" d="M415 119c0 -19 -45 -130 -167 -130c-115 0 -220 97 -220 231c0 125 92 228 208 228c125 0 179 -97 179 -196c0 -21 -3 -21 -25 -21h-279c0 -36 0 -102 30 -150c23 -37 63 -67 113 -67c10 0 100 0 135 103c2 8 4 14 13 14c5 0 13 -2 13 -12zM349 252 c0 39 -10 174 -113 174c-34 0 -118 -25 -124 -174h237Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-63"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-6F" x="444" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-73" x="945" y="0"></use>
<g transform="translate(1672,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D703" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-65" x="663" y="-213"></use>
</g>
</g>
</svg></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1758" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1758"><i></i></a><div id="fragbit-1758" class="collapse show"><div class="fragmentcode">          Float sinTheta_o = <a href="../Utilities/Mathematical_Infrastructure.html#SafeSqrt" class="code">SafeSqrt</a>(1 - <a href="../Utilities/Mathematical_Infrastructure.html#Sqr" class="code">Sqr</a>(cosTheta_o));
          Float cosTheta_x =
              cosSubClamped(sinTheta_w, cosTheta_w, sinTheta_o, cosTheta_o);
          Float sinTheta_x =
              sinSubClamped(sinTheta_w, cosTheta_w, sinTheta_o, cosTheta_o);
          Float cosThetap =
              cosSubClamped(sinTheta_x, cosTheta_x, sinTheta_b, cosTheta_b);
          if (cosThetap &lt;= cosTheta_e)
              return 0;</div></div>
       &lt;&lt;<span class="fragmentname"><a href="#fragment-Returnfinalimportanceatreferencepoint-0">Return final importance at reference point</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1759" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1759"><i></i></a><div id="fragbit-1759" class="collapse show"><div class="fragmentcode">          Float importance = phi * cosThetap / d2;
          &lt;&lt;<span class="fragmentname"><a href="#fragment-Accountforcostheta_romaniinimportanceatsurfaces-0">Account for <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.278ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 2272.6 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">cosine theta Subscript normal i</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-63" d="M415 119c0 -10 -32 -130 -166 -130c-116 0 -215 99 -215 227c0 124 92 232 217 232c77 0 153 -39 153 -107c0 -30 -20 -47 -46 -47c-28 0 -46 20 -46 46c0 13 6 43 47 46c-35 36 -98 37 -107 37c-53 0 -135 -42 -135 -205c0 -161 88 -204 141 -204c37 0 102 12 131 105 c2 6 4 10 13 10c3 0 13 0 13 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6F" d="M471 214c0 -127 -101 -225 -222 -225c-117 0 -221 96 -221 225c0 125 97 234 222 234c121 0 221 -106 221 -234zM388 222c0 38 0 96 -26 139s-69 65 -113 65c-40 0 -87 -21 -114 -67c-24 -44 -24 -98 -24 -137c0 -36 0 -97 25 -141c27 -46 71 -67 114 -67 c50 0 94 29 116 74c22 44 22 98 22 134Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-73" d="M360 128c0 -72 -46 -139 -161 -139c-21 0 -66 1 -110 43c-18 -19 -18 -21 -20 -23c-19 -19 -20 -20 -25 -20c-11 0 -11 7 -11 24v132c0 18 0 25 13 25c10 0 11 -4 14 -17c19 -85 55 -142 139 -142c78 0 113 40 113 91c0 72 -82 88 -104 92c-72 14 -100 20 -132 46 c-27 22 -43 50 -43 85c0 56 38 123 160 123c15 0 56 0 94 -28c4 3 14 12 17 16c13 12 15 12 20 12c11 0 11 -7 11 -24v-101c0 -19 0 -24 -13 -24c0 0 -11 0 -12 9c-2 31 -7 121 -117 121c-86 0 -112 -41 -112 -76c0 -58 67 -71 123 -82c42 -8 81 -16 114 -48 c12 -12 42 -42 42 -95Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D703" d="M455 500c0 -224 -152 -511 -293 -511c-91 0 -120 111 -120 205c0 229 154 511 293 511c102 0 120 -139 120 -205zM389 562c0 57 -6 121 -55 121c-45 0 -82 -56 -109 -105c-40 -71 -60 -151 -77 -215h209c24 99 32 150 32 199zM348 331h-208c-26 -98 -32 -156 -32 -198 c0 -93 21 -122 54 -122c43 0 81 49 116 117c38 72 59 157 70 203Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-69" d="M247 0c-34 1 -69 3 -104 3l-110 -3v31c67 0 78 0 78 45v269c0 49 -9 55 -74 55v31l140 11v-367c0 -39 4 -44 70 -44v-31zM192 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-63"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-6F" x="444" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-73" x="945" y="0"></use>
<g transform="translate(1506,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D703" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="663" y="-213"></use>
</g>
</g>
</svg> in importance at surfaces</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1760" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1760"><i></i></a><div id="fragbit-1760" class="collapse show"><div class="fragmentcode">             if (n != <a href="../Geometry_and_Transformations/Normals.html#Normal3f" class="code">Normal3f</a>(0, 0, 0)) {
                 Float cosTheta_i = <a href="../Geometry_and_Transformations/Vectors.html#AbsDot" class="code">AbsDot</a>(wi, n);
                 Float sinTheta_i = <a href="../Utilities/Mathematical_Infrastructure.html#SafeSqrt" class="code">SafeSqrt</a>(1 - <a href="../Utilities/Mathematical_Infrastructure.html#Sqr" class="code">Sqr</a>(cosTheta_i));
                 Float cosThetap_i = cosSubClamped(sinTheta_i, cosTheta_i,
                                                   sinTheta_b, cosTheta_b);
                 importance *= cosThetap_i;
             }</div></div> 
          return importance;</div></div></div></div>
}</div><p>


</p>
<p>

</p>
<p></p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">
<a href="#x3-LightBoundingVolumeHierarchies"><i class="fas fa-link h3h4marginlink"></i></a>
</div>
<div class="col-md-10 col-lg-8">
<span id="x3-LightBoundingVolumeHierarchies"></span><h4>Light Bounding Volume Hierarchies</h4><p>


</p>
<p>Given a way of bounding lights as well as a compact representation of these
bounds, we can turn to the implementation of the <a href="#BVHLightSampler"><tt>BVHLightSampler</tt></a>.
This light sampler is the default for most of the integrators in <tt>pbrt</tt>.
Not only is it effective at efficiently sampling among large collections of
lights, it even reduces error in simple scenes with just a few lights.
Figures&nbsp;<a href="#fig:power-vs-light-bvh-simple">12.30</a>
and&nbsp;<a href="#fig:power-vs-light-bvh-complex">12.31</a> show two examples.

</p>
<p></p>
<span class="anchor" id="fig:power-vs-light-bvh-simple"></span><div class="card outerfigure"><div class="card-body figure"><p>


</p>

<div class="card-img-top" style="display:block; width: 100%; padding-top: 67.436%;  position:relative;">
<div id="xa_PowerLightSampler53" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0;"></div></div>
<script>
Jeri.renderViewer(document.getElementById('xa_PowerLightSampler53'), {
  title: '(a)_PowerLightSampler53', children: [
 { title: '(a) PowerLightSampler', image: 'dragon-two-blps-power.exr' },  { title: '(b) BVHLightSampler', image: 'dragon-two-blps-bvh.exr' }]});
</script>
<button data-toggle="tooltip" data-placement="left" class="btn yojeri" title="This image is interactive. Click and drag to pan and use the mouse-wheel to zoom. After clicking on the image to select it, type '?' to see a summary of keyboard controls."><i class="fa fa-snowflake fa-border"></i></button><p>

</p>
<figcaption class="caption">Figure 12.30: A Simple Scene with Two Light Sources. <span class="legend">
(a)&nbsp;Rendered with 1 sample per pixel using the <a href="#PowerLightSampler"><tt>PowerLightSampler</tt></a>.
(b)&nbsp;Rendered with 1 sample per pixel using the <a href="#BVHLightSampler"><tt>BVHLightSampler</tt></a>.
Even with a small number of lights, error is visibly lower with a sampler
that uses spatially varying sampling probabilities due to being able to
choose nearby bright lights with higher probability.  In this case, MSE is
improved by a factor of 2.72.</span>
</figcaption>
</div></div><p>


</p>
<p></p>
<span class="anchor" id="fig:power-vs-light-bvh-complex"></span><div class="card outerfigure"><div class="card-body figure"><p>


</p>

<div class="card-img-top" style="display:block; width: 100%; padding-top: 45.417%;  position:relative;">
<div id="xa_PowerLightSampler54" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0;"></div></div>
<script>
Jeri.renderViewer(document.getElementById('xa_PowerLightSampler54'), {
  title: '(a)_PowerLightSampler54', children: [
 { title: '(a) PowerLightSampler', image: 'zero-day-power.exr' },  { title: '(b) BVHLightSampler', image: 'zero-day-bvh.exr' }]});
</script>
<button data-toggle="tooltip" data-placement="left" class="btn yojeri" title="This image is interactive. Click and drag to pan and use the mouse-wheel to zoom. After clicking on the image to select it, type '?' to see a summary of keyboard controls."><i class="fa fa-snowflake fa-border"></i></button><p>

</p>
<figcaption class="caption">Figure 12.31: <em>Zero Day</em> Scene, with 8,878 Area Lights. <span class="legend">
(a)&nbsp;Rendered with the <a href="#PowerLightSampler"><tt>PowerLightSampler</tt></a>.
(b)&nbsp;Rendered with the <a href="#BVHLightSampler"><tt>BVHLightSampler</tt></a>.
Both images are rendered with 16 samples per pixel.
For a scene of this complexity, an effective light sampling algorithm is crucial.
The <tt>BVHLightSampler</tt> gives an MSE improvement of 2.37<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.808ex" height="1.509ex" style="vertical-align: 0.019ex; margin-bottom: -0.19ex;" viewBox="0 -576.1 778.5 649.8" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">times</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-D7" d="M624 15c-7 -8 -20 -8 -28 0l-207 207l-207 -207c-8 -8 -21 -8 -28 0c-8 7 -8 20 0 28l207 207l-207 207c-8 8 -8 21 0 28c7 8 20 8 28 0l207 -207l207 207c8 8 21 8 28 0c8 -7 8 -20 0 -28l-207 -207l207 -207c8 -8 8 -21 0 -28Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-D7" x="0" y="0"></use>
</g>
</svg> with only a
5.8% increase in rendering time.  Monte Carlo efficiency is improved by a
factor of 2.25.
<em>(Scene courtesy of Beeple.)</em>
</span>
</figcaption>
</div></div><p>


</p>
<p></p>
<span class="anchor" id="fragment-BVHLightSamplerDefinition-0"></span><div class="fragmentname">&lt;&lt;BVHLightSampler Definition&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">class <span class="anchor" id="BVHLightSampler"></span>BVHLightSampler {
  public:
    &lt;&lt;<span class="fragmentname"><a href="#fragment-BVHLightSamplerPublicMethods-0">BVHLightSampler Public Methods</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1761" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1761"><i></i></a><div id="fragbit-1761" class="collapse show"><div class="fragmentcode">       BVHLightSampler(pstd::span&lt;const <a href="../Light_Sources/Light_Interface.html#Light" class="code">Light</a>&gt; <a href="#BVHLightSampler::lights" class="code">lights</a>, Allocator alloc);
       pstd::optional&lt;<a href="#SampledLight" class="code">SampledLight</a>&gt;
       Sample(const <a href="../Light_Sources/Light_Interface.html#LightSampleContext" class="code">LightSampleContext</a> &amp;ctx, Float u) const {
           &lt;&lt;<span class="fragmentname"><a href="#fragment-ComputeinfinitelightsamplingprobabilitymonopInfinite-0">Compute infinite light sampling probability <tt>pInfinite</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1762" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1762"><i></i></a><div id="fragbit-1762" class="collapse show"><div class="fragmentcode">              Float pInfinite = Float(<a href="#BVHLightSampler::infiniteLights" class="code">infiniteLights</a>.size()) /
                  Float(<a href="#BVHLightSampler::infiniteLights" class="code">infiniteLights</a>.size() + (<a href="#BVHLightSampler::nodes" class="code">nodes</a>.empty() ? 0 : 1));</div></div>
           if (u &lt; pInfinite) {
               &lt;&lt;<span class="fragmentname"><a href="#fragment-Sampleinfinitelightswithuniformprobability-0">Sample infinite lights with uniform probability</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1763" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1763"><i></i></a><div id="fragbit-1763" class="collapse show"><div class="fragmentcode">                  u /= pInfinite;
                  int index = std::min&lt;int&gt;(u * <a href="#BVHLightSampler::infiniteLights" class="code">infiniteLights</a>.size(),
                                            <a href="#BVHLightSampler::infiniteLights" class="code">infiniteLights</a>.size() - 1);
                  Float pmf = pInfinite / <a href="#BVHLightSampler::infiniteLights" class="code">infiniteLights</a>.size();
                  return <a href="#SampledLight" class="code">SampledLight</a>{<a href="#BVHLightSampler::infiniteLights" class="code">infiniteLights</a>[index], pmf};</div></div>
           } else {
               &lt;&lt;<span class="fragmentname"><a href="#fragment-TraverselightBVHtosamplelight-0">Traverse light BVH to sample light</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1764" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1764"><i></i></a><div id="fragbit-1764" class="collapse show"><div class="fragmentcode">                  if (<a href="#BVHLightSampler::nodes" class="code">nodes</a>.empty())
                      return {};
                  &lt;&lt;<span class="fragmentname"><a href="#fragment-DeclarecommonvariablesforlightBVHtraversal-0">Declare common variables for light BVH traversal</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1765" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1765"><i></i></a><div id="fragbit-1765" class="collapse show"><div class="fragmentcode">                     <a href="../Geometry_and_Transformations/Points.html#Point3f" class="code">Point3f</a> <a href="../Light_Sources/Light_Interface.html#LightSampleContext::p" class="code">p</a> = ctx.<a href="../Light_Sources/Light_Interface.html#LightSampleContext::p" class="code">p</a>();
                     <a href="../Geometry_and_Transformations/Normals.html#Normal3f" class="code">Normal3f</a> n = ctx.<a href="../Light_Sources/Light_Interface.html#LightSampleContext::ns" class="code">ns</a>;
                     u = std::min&lt;Float&gt;((u - pInfinite) / (1 - pInfinite), <a href="../Sampling_and_Reconstruction/Sampling_Interface.html#OneMinusEpsilon" class="code">OneMinusEpsilon</a>);
                     int nodeIndex = 0;
                     Float pmf = 1 - pInfinite;</div></div>
                  while (true) {
                      &lt;&lt;<span class="fragmentname"><a href="#fragment-ProcesslightBVHnodeforlightsampling-0">Process light BVH node for light sampling</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1766" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1766"><i></i></a><div id="fragbit-1766" class="collapse show"><div class="fragmentcode">                         <a href="#LightBVHNode" class="code">LightBVHNode</a> node = <a href="#BVHLightSampler::nodes" class="code">nodes</a>[nodeIndex];
                         if (!node.<a href="#LightBVHNode::isLeaf" class="code">isLeaf</a>) {
                             &lt;&lt;<span class="fragmentname"><a href="#fragment-ComputelightBVHchildnodeimportances-0">Compute light BVH child node importances</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1767" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1767"><i></i></a><div id="fragbit-1767" class="collapse show"><div class="fragmentcode">                                const <a href="#LightBVHNode" class="code">LightBVHNode</a> *children[2] = {&amp;nodes[nodeIndex + 1],
                                                                   &amp;nodes[node.<a href="#LightBVHNode::childOrLightIndex" class="code">childOrLightIndex</a>] };
                                Float ci[2] = { children[0]-&gt;<a href="#LightBVHNode::lightBounds" class="code">lightBounds</a>.<a href="#CompactLightBounds::Importance" class="code">Importance</a>(p, n, <a href="#BVHLightSampler::allLightBounds" class="code">allLightBounds</a>),
                                                children[1]-&gt;<a href="#LightBVHNode::lightBounds" class="code">lightBounds</a>.<a href="#CompactLightBounds::Importance" class="code">Importance</a>(p, n, <a href="#BVHLightSampler::allLightBounds" class="code">allLightBounds</a>)};
                                if (ci[0] == 0 &amp;&amp; ci[1] == 0)
                                    return {};</div></div>
                             &lt;&lt;<span class="fragmentname"><a href="#fragment-RandomlysamplelightBVHchildnode-0">Randomly sample light BVH child node</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1768" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1768"><i></i></a><div id="fragbit-1768" class="collapse show"><div class="fragmentcode">                                Float nodePMF;
                                int child = <a href="../Monte_Carlo_Integration/Sampling_Using_the_Inversion_Method.html#SampleDiscrete" class="code">SampleDiscrete</a>(ci, u, &amp;nodePMF, &amp;u);
                                pmf *= nodePMF;
                                nodeIndex = (child == 0) ? (nodeIndex + 1) : node.<a href="#LightBVHNode::childOrLightIndex" class="code">childOrLightIndex</a>;</div></div>
                         } else {
                             &lt;&lt;<span class="fragmentname"><a href="#fragment-Confirmlighthasnonzeroimportancebeforereturninglightsample-0">Confirm light has nonzero importance before returning light sample</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1769" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1769"><i></i></a><div id="fragbit-1769" class="collapse show"><div class="fragmentcode">                                if (nodeIndex &gt; 0 ||
                                    node.<a href="#LightBVHNode::lightBounds" class="code">lightBounds</a>.<a href="#CompactLightBounds::Importance" class="code">Importance</a>(p, n, <a href="#BVHLightSampler::allLightBounds" class="code">allLightBounds</a>) &gt; 0)
                                    return <a href="#SampledLight" class="code">SampledLight</a>{<a href="#BVHLightSampler::lights" class="code">lights</a>[node.<a href="#LightBVHNode::childOrLightIndex" class="code">childOrLightIndex</a>], pmf};
                                return {};</div></div>
                         }</div></div>
                  }</div></div>
           }
       }
       Float PMF(const <a href="../Light_Sources/Light_Interface.html#LightSampleContext" class="code">LightSampleContext</a> &amp;ctx, <a href="../Light_Sources/Light_Interface.html#Light" class="code">Light</a> light) const {
           &lt;&lt;<span class="fragmentname"><a href="#fragment-HandleinfinitemonolightPMFcomputation-0">Handle infinite <tt>light</tt> PMF computation</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1770" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1770"><i></i></a><div id="fragbit-1770" class="collapse show"><div class="fragmentcode">              if (!<a href="#BVHLightSampler::lightToBitTrail" class="code">lightToBitTrail</a>.<a href="../Utilities/Containers_and_Memory_Management.html#HashMap::HasKey" class="code">HasKey</a>(light))
                  return 1.f / (<a href="#BVHLightSampler::infiniteLights" class="code">infiniteLights</a>.size() + (<a href="#BVHLightSampler::nodes" class="code">nodes</a>.empty() ? 0 : 1));</div></div>
           &lt;&lt;<span class="fragmentname"><a href="#fragment-InitializelocalvariablesforBVHtraversalforPMFcomputation-0">Initialize local variables for BVH traversal for PMF computation</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1771" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1771"><i></i></a><div id="fragbit-1771" class="collapse show"><div class="fragmentcode">              uint32_t bitTrail = <a href="#BVHLightSampler::lightToBitTrail" class="code">lightToBitTrail</a>[light];
              <a href="../Geometry_and_Transformations/Points.html#Point3f" class="code">Point3f</a> <a href="../Light_Sources/Light_Interface.html#LightSampleContext::p" class="code">p</a> = ctx.<a href="../Light_Sources/Light_Interface.html#LightSampleContext::p" class="code">p</a>();
              <a href="../Geometry_and_Transformations/Normals.html#Normal3f" class="code">Normal3f</a> n = ctx.<a href="../Light_Sources/Light_Interface.html#LightSampleContext::ns" class="code">ns</a>;
              &lt;&lt;<span class="fragmentname"><a href="#fragment-ComputeinfinitelightsamplingprobabilitymonopInfinite-0">Compute infinite light sampling probability <tt>pInfinite</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1772" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1772"><i></i></a><div id="fragbit-1772" class="collapse show"><div class="fragmentcode">                 Float pInfinite = Float(<a href="#BVHLightSampler::infiniteLights" class="code">infiniteLights</a>.size()) /
                     Float(<a href="#BVHLightSampler::infiniteLights" class="code">infiniteLights</a>.size() + (<a href="#BVHLightSampler::nodes" class="code">nodes</a>.empty() ? 0 : 1));</div></div>
              Float pmf = 1 - pInfinite;
              int nodeIndex = 0;</div></div>
           &lt;&lt;<span class="fragmentname"><a href="#fragment-ComputelightsPMFbywalkingdowntreenodestothelight-0">Compute light&rsquo;s PMF by walking down tree nodes to the light</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1773" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1773"><i></i></a><div id="fragbit-1773" class="collapse show"><div class="fragmentcode">              while (true) {
                  const <a href="#LightBVHNode" class="code">LightBVHNode</a> *node = &amp;<a href="#BVHLightSampler::nodes" class="code">nodes</a>[nodeIndex];
                  if (node-&gt;isLeaf)
                      return pmf;
                  &lt;&lt;<span class="fragmentname"><a href="#fragment-ComputechildimportancesandupdatePMFforcurrentnode-0">Compute child importances and update PMF for current node</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1774" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1774"><i></i></a><div id="fragbit-1774" class="collapse show"><div class="fragmentcode">                     const <a href="#LightBVHNode" class="code">LightBVHNode</a> *child0 = &amp;<a href="#BVHLightSampler::nodes" class="code">nodes</a>[nodeIndex + 1];
                     const <a href="#LightBVHNode" class="code">LightBVHNode</a> *child1 = &amp;<a href="#BVHLightSampler::nodes" class="code">nodes</a>[node-&gt;<a href="#LightBVHNode::childOrLightIndex" class="code">childOrLightIndex</a>];
                     Float ci[2] = { child0-&gt;<a href="#LightBVHNode::lightBounds" class="code">lightBounds</a>.<a href="#CompactLightBounds::Importance" class="code">Importance</a>(p, n, allLightBounds),
                                     child1-&gt;<a href="#LightBVHNode::lightBounds" class="code">lightBounds</a>.<a href="#CompactLightBounds::Importance" class="code">Importance</a>(p, n, allLightBounds) };
                     pmf *= ci[bitTrail &amp; 1] / (ci[0] + ci[1]);</div></div>
                  &lt;&lt;<span class="fragmentname"><a href="#fragment-UsemonobitTrailtofindnextnodeindexandupdateitsvalue-0">Use <tt>bitTrail</tt> to find next node index and update its value</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1775" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1775"><i></i></a><div id="fragbit-1775" class="collapse show"><div class="fragmentcode">                     nodeIndex = (bitTrail &amp; 1) ? node-&gt;<a href="#LightBVHNode::childOrLightIndex" class="code">childOrLightIndex</a> : (nodeIndex + 1);
                     bitTrail &gt;&gt;= 1;</div></div> 
              }</div></div>
       }
       pstd::optional&lt;<a href="#SampledLight" class="code">SampledLight</a>&gt; Sample(Float u) const {
           if (<a href="#BVHLightSampler::lights" class="code">lights</a>.empty()) return {};
           int lightIndex = std::min&lt;int&gt;(u * <a href="#BVHLightSampler::lights" class="code">lights</a>.size(), <a href="#BVHLightSampler::lights" class="code">lights</a>.size() - 1);
           return <a href="#SampledLight" class="code">SampledLight</a>{<a href="#BVHLightSampler::lights" class="code">lights</a>[lightIndex], 1.f / <a href="#BVHLightSampler::lights" class="code">lights</a>.size()};
       }
       Float PMF(<a href="../Light_Sources/Light_Interface.html#Light" class="code">Light</a> light) const {
           if (<a href="#BVHLightSampler::lights" class="code">lights</a>.empty()) return 0;
           return 1.f / <a href="#BVHLightSampler::lights" class="code">lights</a>.size();
       }
       std::string ToString() const;</div></div>
  private:
    &lt;&lt;<span class="fragmentname"><a href="#fragment-BVHLightSamplerPrivateMethods-0">BVHLightSampler Private Methods</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1776" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1776"><i></i></a><div id="fragbit-1776" class="collapse show"><div class="fragmentcode">       std::pair&lt;int, <a href="#LightBounds" class="code">LightBounds</a>&gt; buildBVH(
           std::vector&lt;std::pair&lt;int, <a href="#LightBounds" class="code">LightBounds</a>&gt;&gt; &amp;bvhLights, int start, int end,
           uint32_t bitTrail, int depth);
       Float EvaluateCost(const <a href="#LightBounds" class="code">LightBounds</a> &amp;b, const <a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3f" class="code">Bounds3f</a> &amp;bounds,
                          int dim) const {
           &lt;&lt;<span class="fragmentname"><a href="#fragment-EvaluatedirectionboundsmeasureformonoLightBounds-0">Evaluate direction bounds measure for <tt>LightBounds</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1777" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1777"><i></i></a><div id="fragbit-1777" class="collapse show"><div class="fragmentcode">              Float theta_o = std::acos(b.<a href="#LightBounds::cosTheta_o" class="code">cosTheta_o</a>), theta_e = std::acos(b.<a href="#LightBounds::cosTheta_e" class="code">cosTheta_e</a>);
              Float theta_w = std::min(theta_o + theta_e, <a href="../Utilities/Mathematical_Infrastructure.html#Pi" class="code">Pi</a>);
              Float sinTheta_o = <a href="../Utilities/Mathematical_Infrastructure.html#SafeSqrt" class="code">SafeSqrt</a>(1 - <a href="../Utilities/Mathematical_Infrastructure.html#Sqr" class="code">Sqr</a>(b.<a href="#LightBounds::cosTheta_o" class="code">cosTheta_o</a>));
              Float M_omega = 2 * <a href="../Utilities/Mathematical_Infrastructure.html#Pi" class="code">Pi</a> * (1 - b.<a href="#LightBounds::cosTheta_o" class="code">cosTheta_o</a>) +
                  <a href="../Utilities/Mathematical_Infrastructure.html#Pi" class="code">Pi</a> / 2 * (2 * theta_w * sinTheta_o - std::cos(theta_o - 2 * theta_w) -
                            2 * theta_o * sinTheta_o + b.<a href="#LightBounds::cosTheta_o" class="code">cosTheta_o</a>);</div></div>
           &lt;&lt;<span class="fragmentname"><a href="#fragment-ReturncompletecostestimateformonoLightBounds-0">Return complete cost estimate for <tt>LightBounds</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1778" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1778"><i></i></a><div id="fragbit-1778" class="collapse show"><div class="fragmentcode">              Float Kr = <a href="../Geometry_and_Transformations/n-Tuple_Base_Classes.html#Tuple3::MaxComponentValue" class="code">MaxComponentValue</a>(<a href="#LightBounds::bounds" class="code">bounds</a>.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3::Diagonal" class="code">Diagonal</a>()) / <a href="#LightBounds::bounds" class="code">bounds</a>.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3::Diagonal" class="code">Diagonal</a>()[dim];
              return b.<a href="#LightBounds::phi" class="code">phi</a> * M_omega * Kr * b.<a href="#LightBounds::bounds" class="code">bounds</a>.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3::SurfaceArea" class="code">SurfaceArea</a>();</div></div>
       }</div></div>
    &lt;&lt;<span class="fragmentname"><a href="#fragment-BVHLightSamplerPrivateMembers-0">BVHLightSampler Private Members</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1779" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1779"><i></i></a><div id="fragbit-1779" class="collapse show"><div class="fragmentcode">       pstd::vector&lt;<a href="../Light_Sources/Light_Interface.html#Light" class="code">Light</a>&gt; lights;
       pstd::vector&lt;<a href="../Light_Sources/Light_Interface.html#Light" class="code">Light</a>&gt; infiniteLights;
       <a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3f" class="code">Bounds3f</a> allLightBounds;
       pstd::vector&lt;LightBVHNode&gt; nodes;
       <a href="../Utilities/Containers_and_Memory_Management.html#HashMap" class="code">HashMap</a>&lt;<a href="../Light_Sources/Light_Interface.html#Light" class="code">Light</a>, uint32_t&gt; lightToBitTrail;</div></div>
};</div><p>


</p>
<p>

</p>
<p>Its constructor starts by making a copy of the provided array of lights
before proceeding to initialize the BVH and additional data structures.

</p>
<p></p>
<span class="anchor" id="fragment-BVHLightSamplerMethodDefinitions-0"></span><div class="fragmentname">&lt;&lt;BVHLightSampler Method Definitions&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">BVHLightSampler::BVHLightSampler(pstd::span&lt;const <a href="../Light_Sources/Light_Interface.html#Light" class="code">Light</a>&gt; <a href="#BVHLightSampler::lights" class="code">lights</a>,
                                 Allocator alloc)
    : <a href="#BVHLightSampler::lights" class="code">lights</a>(<a href="#BVHLightSampler::lights" class="code">lights</a>.begin(), <a href="#BVHLightSampler::lights" class="code">lights</a>.end(), alloc), <a href="#BVHLightSampler::infiniteLights" class="code">infiniteLights</a>(alloc),
      <a href="#BVHLightSampler::nodes" class="code">nodes</a>(alloc), <a href="#BVHLightSampler::lightToBitTrail" class="code">lightToBitTrail</a>(alloc) {
    &lt;&lt;<span class="fragmentname"><a href="#fragment-InitializemonoinfiniteLightsarrayandlightBVH-0">Initialize <tt>infiniteLights</tt> array and light BVH</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1780" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1780"><i></i></a><div id="fragbit-1780" class="collapse show"><div class="fragmentcode">       std::vector&lt;std::pair&lt;int, <a href="#LightBounds" class="code">LightBounds</a>&gt;&gt; bvhLights;
       for (size_t i = 0; i &lt; <a href="#BVHLightSampler::lights" class="code">lights</a>.size(); ++i) {
          &lt;&lt;<span class="fragmentname"><a href="#fragment-StoreithlightineithermonoinfiniteLightsormonobvhLights-0">Store <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="0.802ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 345.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">i</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D456" d="M284 625c0 -30 -30 -53 -53 -53c-24 0 -38 17 -38 36c0 27 27 53 54 53c23 0 37 -16 37 -36zM293 143c0 -9 -37 -154 -131 -154c-48 0 -82 35 -82 82c0 21 13 54 23 80c16 43 61 159 69 185c4 10 11 31 11 52c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124 c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 38 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -13 -53c-10 -27 -10 -29 -22 -58l-39 -105c-23 -61 -29 -75 -29 -100c0 -23 7 -33 24 -33c51 0 84 61 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D456" x="0" y="0"></use>
</g>
</svg>th light in either <tt>infiniteLights</tt> or <tt>bvhLights</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1781" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1781"><i></i></a><div id="fragbit-1781" class="collapse show"><div class="fragmentcode">             <a href="../Light_Sources/Light_Interface.html#Light" class="code">Light</a> light = <a href="#BVHLightSampler::lights" class="code">lights</a>[i];
             pstd::optional&lt;<a href="#LightBounds" class="code">LightBounds</a>&gt; lightBounds = light.<a href="#Light::Bounds" class="code">Bounds</a>();
             if (!lightBounds)
                 <a href="#BVHLightSampler::infiniteLights" class="code">infiniteLights</a>.push_back(light);
             else if (lightBounds-&gt;<a href="#LightBounds::phi" class="code">phi</a> &gt; 0) {
                 bvhLights.push_back(std::make_pair(i, *lightBounds));
                 <a href="#BVHLightSampler::allLightBounds" class="code">allLightBounds</a> = Union(<a href="#BVHLightSampler::allLightBounds" class="code">allLightBounds</a>, lightBounds-&gt;<a href="#LightBounds::bounds" class="code">bounds</a>);
             }</div></div>
       }
       if (!bvhLights.empty())
           <a href="#BVHLightSampler::buildBVH" class="code">buildBVH</a>(bvhLights, 0, bvhLights.size(), 0, 0);
       </div></div>
}</div><p>


</p>
<p></p>
<span class="anchor" id="fragment-BVHLightSamplerPrivateMembers-0"></span><div class="fragmentname">&lt;&lt;BVHLightSampler Private Members&gt;&gt;=&nbsp;<a href="#fragment-BVHLightSamplerPrivateMembers-1"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode">pstd::vector&lt;<a href="../Light_Sources/Light_Interface.html#Light" class="code">Light</a>&gt; <span class="anchor" id="BVHLightSampler::lights"></span>lights;</div><p>


</p>
<p>Because the BVH cannot store lights at infinity, the first step is to
partition the lights into those that can be stored in the BVH and those
that cannot.  This is handled by a loop over all the provided lights
after which the BVH is constructed.

</p>
<p></p>
<span class="anchor" id="fragment-InitializemonoinfiniteLightsarrayandlightBVH-0"></span><div class="fragmentname">&lt;&lt;Initialize <tt>infiniteLights</tt> array and light BVH&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">std::vector&lt;std::pair&lt;int, <a href="#LightBounds" class="code">LightBounds</a>&gt;&gt; bvhLights;
for (size_t i = 0; i &lt; <a href="#BVHLightSampler::lights" class="code">lights</a>.size(); ++i) {
   &lt;&lt;<span class="fragmentname"><a href="#fragment-StoreithlightineithermonoinfiniteLightsormonobvhLights-0">Store <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="0.802ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 345.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">i</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D456" d="M284 625c0 -30 -30 -53 -53 -53c-24 0 -38 17 -38 36c0 27 27 53 54 53c23 0 37 -16 37 -36zM293 143c0 -9 -37 -154 -131 -154c-48 0 -82 35 -82 82c0 21 13 54 23 80c16 43 61 159 69 185c4 10 11 31 11 52c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124 c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 38 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -13 -53c-10 -27 -10 -29 -22 -58l-39 -105c-23 -61 -29 -75 -29 -100c0 -23 7 -33 24 -33c51 0 84 61 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D456" x="0" y="0"></use>
</g>
</svg>th light in either <tt>infiniteLights</tt> or <tt>bvhLights</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1782" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1782"><i></i></a><div id="fragbit-1782" class="collapse show"><div class="fragmentcode">      <a href="../Light_Sources/Light_Interface.html#Light" class="code">Light</a> light = <a href="#BVHLightSampler::lights" class="code">lights</a>[i];
      pstd::optional&lt;<a href="#LightBounds" class="code">LightBounds</a>&gt; lightBounds = light.<a href="#Light::Bounds" class="code">Bounds</a>();
      if (!lightBounds)
          <a href="#BVHLightSampler::infiniteLights" class="code">infiniteLights</a>.push_back(light);
      else if (lightBounds-&gt;<a href="#LightBounds::phi" class="code">phi</a> &gt; 0) {
          bvhLights.push_back(std::make_pair(i, *lightBounds));
          <a href="#BVHLightSampler::allLightBounds" class="code">allLightBounds</a> = Union(<a href="#BVHLightSampler::allLightBounds" class="code">allLightBounds</a>, lightBounds-&gt;<a href="#LightBounds::bounds" class="code">bounds</a>);
      }</div></div>
}
if (!bvhLights.empty())
    <a href="#BVHLightSampler::buildBVH" class="code">buildBVH</a>(bvhLights, 0, bvhLights.size(), 0, 0);
</div><p>


</p>
<p>Lights that are not able to provide a <a href="#LightBounds"><tt>LightBounds</tt></a> are added to the
<tt>infiniteLights</tt> array and are sampled independently of the lights
stored in the BVH.  As long as they have nonzero emitted power, the rest
are added to the <tt>bvhLights</tt> array, which is used during BVH
construction.  Along the way, a bounding box that encompasses all the
BVH lights&rsquo; bounding boxes is maintained in <tt>allLightBounds</tt>; this is
the bounding box that will be passed to the <a href="#CompactLightBounds"><tt>CompactLightBounds</tt></a> for
quantizing the spatial bounds of individual lights.
 
</p>
<span class="anchor" id="fragment-StoreithlightineithermonoinfiniteLightsormonobvhLights-0"></span><div class="fragmentname">&lt;&lt;Store <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="0.802ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 345.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">i</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D456" d="M284 625c0 -30 -30 -53 -53 -53c-24 0 -38 17 -38 36c0 27 27 53 54 53c23 0 37 -16 37 -36zM293 143c0 -9 -37 -154 -131 -154c-48 0 -82 35 -82 82c0 21 13 54 23 80c16 43 61 159 69 185c4 10 11 31 11 52c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124 c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 38 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -13 -53c-10 -27 -10 -29 -22 -58l-39 -105c-23 -61 -29 -75 -29 -100c0 -23 7 -33 24 -33c51 0 84 61 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D456" x="0" y="0"></use>
</g>
</svg>th light in either <tt>infiniteLights</tt> or <tt>bvhLights</tt>&gt;&gt;=&nbsp;</div>
<div class="fragmentcode"><a href="../Light_Sources/Light_Interface.html#Light" class="code">Light</a> light = <a href="#BVHLightSampler::lights" class="code">lights</a>[i];
pstd::optional&lt;<a href="#LightBounds" class="code">LightBounds</a>&gt; lightBounds = light.<a href="#Light::Bounds" class="code">Bounds</a>();
if (!lightBounds)
    <a href="#BVHLightSampler::infiniteLights" class="code">infiniteLights</a>.push_back(light);
else if (lightBounds-&gt;<a href="#LightBounds::phi" class="code">phi</a> &gt; 0) {
    bvhLights.push_back(std::make_pair(i, *lightBounds));
    <a href="#BVHLightSampler::allLightBounds" class="code">allLightBounds</a> = Union(<a href="#BVHLightSampler::allLightBounds" class="code">allLightBounds</a>, lightBounds-&gt;<a href="#LightBounds::bounds" class="code">bounds</a>);
}</div><p>


</p>
<p></p>
<span class="anchor" id="fragment-BVHLightSamplerPrivateMembers-1"></span><div class="fragmentname">&lt;&lt;BVHLightSampler Private Members&gt;&gt;+=&nbsp;<a href="#fragment-BVHLightSamplerPrivateMembers-0"><span class="fa fa-caret-up"></span></a>&nbsp;<a href="#fragment-BVHLightSamplerPrivateMembers-2"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode">pstd::vector&lt;<a href="../Light_Sources/Light_Interface.html#Light" class="code">Light</a>&gt; <span class="anchor" id="BVHLightSampler::infiniteLights"></span>infiniteLights;
<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3f" class="code">Bounds3f</a> <span class="anchor" id="BVHLightSampler::allLightBounds"></span>allLightBounds;</div><p>


</p>
<p>The light BVH is represented using an instance of the <a href="#LightBVHNode"><tt>LightBVHNode</tt></a>
structure for each tree node, both interior and leaf.  It uses a total of
28 bytes of storage, adding just 4 to the 24 used by
<a href="#CompactLightBounds"><tt>CompactLightBounds</tt></a>, though its declaration specifies 32-byte
alignment, ensuring that&nbsp;2 of them fit neatly into a typical 64-byte cache
line on a CPU, and&nbsp;4 of them fit into a 128-byte GPU cache line.

</p>
<p></p>
<span class="anchor" id="fragment-LightBVHNodeDefinition-0"></span><div class="fragmentname">&lt;&lt;LightBVHNode Definition&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">struct alignas (32) <span class="anchor" id="LightBVHNode"></span>LightBVHNode {
    &lt;&lt;<span class="fragmentname"><a href="#fragment-LightBVHNodePublicMethods-0">LightBVHNode Public Methods</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1783" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1783"><i></i></a><div id="fragbit-1783" class="collapse show"><div class="fragmentcode">       <a href="#LightBVHNode" class="code">LightBVHNode</a>() = default;
       static <a href="#LightBVHNode" class="code">LightBVHNode</a> MakeLeaf(unsigned int lightIndex,
                                    const <a href="#CompactLightBounds" class="code">CompactLightBounds</a> &amp;cb) {
           return <a href="#LightBVHNode" class="code">LightBVHNode</a>{cb, {lightIndex, 1}};
       }
       static <a href="#LightBVHNode" class="code">LightBVHNode</a> MakeInterior(unsigned int child1Index,
                                        const <a href="#CompactLightBounds" class="code">CompactLightBounds</a> &amp;cb) {
           return <a href="#LightBVHNode" class="code">LightBVHNode</a>{cb, {child1Index, 0}};
       }
       PBRT_CPU_GPU
       pstd::optional&lt;SampledLight&gt; Sample(const <a href="../Light_Sources/Light_Interface.html#LightSampleContext" class="code">LightSampleContext</a> &amp;ctx, Float u) const;
       
       std::string ToString() const;</div></div>
    &lt;&lt;<span class="fragmentname"><a href="#fragment-LightBVHNodePublicMembers-0">LightBVHNode Public Members</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1784" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1784"><i></i></a><div id="fragbit-1784" class="collapse show"><div class="fragmentcode">       CompactLightBounds lightBounds;
       struct {
           unsigned int childOrLightIndex:31;
           unsigned int isLeaf:1;
       };</div></div>
};</div><p>


</p>
<p>

</p>
<p>Naturally, each <tt>LightBVHNode</tt> stores the <a href="#CompactLightBounds"><tt>CompactLightBounds</tt></a> for
either a single light or a collection of them.  Like the
<a href="../Primitives_and_Intersection_Acceleration/Bounding_Volume_Hierarchies.html#BVHAggregate"><tt>BVHAggregate</tt></a>&rsquo;s BVH, the light BVH is laid out in memory so that the
first child of each interior node is immediately after it.  Therefore, it
is only necessary to store information about the second child&rsquo;s location in
the <tt>LightBVHNode</tt>.  The <a href="#BVHLightSampler"><tt>BVHLightSampler</tt></a> stores all nodes in a
contiguous array, so an index suffices; a full pointer is unnecessary.

</p>
<p></p>
<span class="anchor" id="fragment-LightBVHNodePublicMembers-0"></span><div class="fragmentname">&lt;&lt;LightBVHNode Public Members&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">CompactLightBounds <span class="anchor" id="LightBVHNode::lightBounds"></span>lightBounds;
struct {
    unsigned int <span class="anchor" id="LightBVHNode::childOrLightIndex"></span>childOrLightIndex:31;
    unsigned int <span class="anchor" id="LightBVHNode::isLeaf"></span>isLeaf:1;
};</div><p>


</p>
<p></p>
<span class="anchor" id="fragment-BVHLightSamplerPrivateMembers-2"></span><div class="fragmentname">&lt;&lt;BVHLightSampler Private Members&gt;&gt;+=&nbsp;<a href="#fragment-BVHLightSamplerPrivateMembers-1"><span class="fa fa-caret-up"></span></a>&nbsp;<a href="#fragment-BVHLightSamplerPrivateMembers-3"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode">pstd::vector&lt;LightBVHNode&gt; <span class="anchor" id="BVHLightSampler::nodes"></span>nodes;</div><p>


</p>
<p>Two object-creation methods return a <a href="#LightBVHNode"><tt>LightBVHNode</tt></a> of the specified
type.

</p>
<p></p>
<span class="anchor" id="fragment-LightBVHNodePublicMethods-0"></span><div class="fragmentname">&lt;&lt;LightBVHNode Public Methods&gt;&gt;=&nbsp;<a href="#fragment-LightBVHNodePublicMethods-1"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode">static <a href="#LightBVHNode" class="code">LightBVHNode</a> <span class="anchor" id="LightBVHNode::MakeLeaf"></span>MakeLeaf(unsigned int lightIndex,
                             const <a href="#CompactLightBounds" class="code">CompactLightBounds</a> &amp;cb) {
    return <a href="#LightBVHNode" class="code">LightBVHNode</a>{cb, {lightIndex, 1}};
}</div><p>


</p>
<p></p>
<span class="anchor" id="fragment-LightBVHNodePublicMethods-1"></span><div class="fragmentname">&lt;&lt;LightBVHNode Public Methods&gt;&gt;+=&nbsp;<a href="#fragment-LightBVHNodePublicMethods-0"><span class="fa fa-caret-up"></span></a></div>
<div class="fragmentcode">static <a href="#LightBVHNode" class="code">LightBVHNode</a> <span class="anchor" id="LightBVHNode::MakeInterior"></span>MakeInterior(unsigned int child1Index,
                                 const <a href="#CompactLightBounds" class="code">CompactLightBounds</a> &amp;cb) {
    return <a href="#LightBVHNode" class="code">LightBVHNode</a>{cb, {child1Index, 0}};
}</div><p>


</p>
<p>

</p>
<p>The <tt>buildBVH()</tt> method constructs the BVH by recursively partitioning
the lights until it reaches a single light, at which point a leaf node is
constructed.  Its implementation closely follows the approach implemented
in the <a href="../Primitives_and_Intersection_Acceleration/Bounding_Volume_Hierarchies.html#BVHAggregate::buildRecursive"><tt>BVHAggregate::buildRecursive()</tt></a> method: along each dimension,
the light bounds are assigned to a fixed number of buckets according to
their centroids.  Next, a cost model is evaluated for splitting the
lights at each bucket boundary.  The minimum cost split is chosen and
the lights are partitioned into two sets, each one passed to a recursive
invocation of <tt>buildBVH()</tt>.

</p>
<p>Because these two methods are so similar, here we will only include the
fragments where the <a href="#BVHLightSampler"><tt>BVHLightSampler</tt></a> substantially diverges&mdash;in how
nodes are initialized and in the cost model used to evaluate candidate splits.

</p>
<p></p>
<span class="anchor" id="fragment-BVHLightSamplerPrivateMethods-0"></span><div class="fragmentname">&lt;&lt;BVHLightSampler Private Methods&gt;&gt;=&nbsp;<a href="#fragment-BVHLightSamplerPrivateMethods-1"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode">std::pair&lt;int, <a href="#LightBounds" class="code">LightBounds</a>&gt; <span class="anchor" id="BVHLightSampler::buildBVH"></span>buildBVH(
    std::vector&lt;std::pair&lt;int, <a href="#LightBounds" class="code">LightBounds</a>&gt;&gt; &amp;bvhLights, int start, int end,
    uint32_t bitTrail, int depth);</div><p>


</p>
<p>

</p>
<p>When this method is called with a range corresponding to a single light, a
leaf node is initialized and the recursion terminates.  A
<a href="#CompactLightBounds"><tt>CompactLightBounds</tt></a> is created using the bounding box of all lights&rsquo;
bounds to initialize its quantized bounding box coordinates and the BVH
tree node can be added to the <tt>nodes</tt> array.

</p>
<p></p>
<span class="anchor" id="fragment-Initializeleafnodeifonlyasinglelightremains-0"></span><div class="fragmentname">&lt;&lt;Initialize leaf node if only a single light remains&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">if (end - start == 1) {
    int nodeIndex = <a href="#BVHLightSampler::nodes" class="code">nodes</a>.size();
    <a href="#CompactLightBounds" class="code">CompactLightBounds</a> cb(bvhLights[start].second, <a href="#BVHLightSampler::allLightBounds" class="code">allLightBounds</a>);
    int lightIndex = bvhLights[start].first;
    <a href="#BVHLightSampler::nodes" class="code">nodes</a>.push_back(<a href="#LightBVHNode::MakeLeaf" class="code">LightBVHNode</a>::MakeLeaf(lightIndex, cb));
    <a href="#BVHLightSampler::lightToBitTrail" class="code">lightToBitTrail</a>.<a href="../Utilities/Containers_and_Memory_Management.html#HashMap::Insert" class="code">Insert</a>(<a href="#BVHLightSampler::lights" class="code">lights</a>[lightIndex], bitTrail);
    return {nodeIndex, bvhLights[start].second};
}</div><p>


</p>
<p>In order to implement the <tt>PMF()</tt> method, it is necessary to
follow a path through the BVH from the root down to the leaf node for the
given light.  We encode these paths using <em>bit trails</em>, integers
where each bit encodes which of the two child nodes should be visited at
each level of the tree in order to reach the light&rsquo;s leaf node.
The lowest bit indicates
which child should be visited after the root node, and so forth.  These
values are computed while the BVH is built and stored in a hash table that
uses <a href="../Light_Sources/Light_Interface.html#Light"><tt>Light</tt></a>s as keys.

</p>
<p></p>
<span class="anchor" id="fragment-BVHLightSamplerPrivateMembers-3"></span><div class="fragmentname">&lt;&lt;BVHLightSampler Private Members&gt;&gt;+=&nbsp;<a href="#fragment-BVHLightSamplerPrivateMembers-2"><span class="fa fa-caret-up"></span></a></div>
<div class="fragmentcode"><a href="../Utilities/Containers_and_Memory_Management.html#HashMap" class="code">HashMap</a>&lt;<a href="../Light_Sources/Light_Interface.html#Light" class="code">Light</a>, uint32_t&gt; <span class="anchor" id="BVHLightSampler::lightToBitTrail"></span>lightToBitTrail;</div><p>


</p>
<p>

</p>
<p>When there are multiple lights to consider, the <tt>EvaluateCost()</tt>
method is called to evaluate the cost model for the two <a href="#LightBounds"><tt>LightBounds</tt></a>
for each split candidate.  In addition to the <tt>LightBounds</tt> for which to
compute the cost, it takes the bounding box of all the lights passed to
the current invocation of <tt>buildBVH()</tt> as well as the dimension in
which the split is being performed.

</p>
<p></p>
<span class="anchor" id="fragment-BVHLightSamplerPrivateMethods-1"></span><div class="fragmentname">&lt;&lt;BVHLightSampler Private Methods&gt;&gt;+=&nbsp;<a href="#fragment-BVHLightSamplerPrivateMethods-0"><span class="fa fa-caret-up"></span></a></div>
<div class="fragmentcode">Float <span class="anchor" id="BVHLightSampler::EvaluateCost"></span>EvaluateCost(const <a href="#LightBounds" class="code">LightBounds</a> &amp;b, const <a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3f" class="code">Bounds3f</a> &amp;bounds,
                   int dim) const {
    &lt;&lt;<span class="fragmentname"><a href="#fragment-EvaluatedirectionboundsmeasureformonoLightBounds-0">Evaluate direction bounds measure for <tt>LightBounds</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1785" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1785"><i></i></a><div id="fragbit-1785" class="collapse show"><div class="fragmentcode">       Float theta_o = std::acos(b.<a href="#LightBounds::cosTheta_o" class="code">cosTheta_o</a>), theta_e = std::acos(b.<a href="#LightBounds::cosTheta_e" class="code">cosTheta_e</a>);
       Float theta_w = std::min(theta_o + theta_e, <a href="../Utilities/Mathematical_Infrastructure.html#Pi" class="code">Pi</a>);
       Float sinTheta_o = <a href="../Utilities/Mathematical_Infrastructure.html#SafeSqrt" class="code">SafeSqrt</a>(1 - <a href="../Utilities/Mathematical_Infrastructure.html#Sqr" class="code">Sqr</a>(b.<a href="#LightBounds::cosTheta_o" class="code">cosTheta_o</a>));
       Float M_omega = 2 * <a href="../Utilities/Mathematical_Infrastructure.html#Pi" class="code">Pi</a> * (1 - b.<a href="#LightBounds::cosTheta_o" class="code">cosTheta_o</a>) +
           <a href="../Utilities/Mathematical_Infrastructure.html#Pi" class="code">Pi</a> / 2 * (2 * theta_w * sinTheta_o - std::cos(theta_o - 2 * theta_w) -
                     2 * theta_o * sinTheta_o + b.<a href="#LightBounds::cosTheta_o" class="code">cosTheta_o</a>);</div></div>
    &lt;&lt;<span class="fragmentname"><a href="#fragment-ReturncompletecostestimateformonoLightBounds-0">Return complete cost estimate for <tt>LightBounds</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1786" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1786"><i></i></a><div id="fragbit-1786" class="collapse show"><div class="fragmentcode">       Float Kr = <a href="../Geometry_and_Transformations/n-Tuple_Base_Classes.html#Tuple3::MaxComponentValue" class="code">MaxComponentValue</a>(<a href="#LightBounds::bounds" class="code">bounds</a>.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3::Diagonal" class="code">Diagonal</a>()) / <a href="#LightBounds::bounds" class="code">bounds</a>.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3::Diagonal" class="code">Diagonal</a>()[dim];
       return b.<a href="#LightBounds::phi" class="code">phi</a> * M_omega * Kr * b.<a href="#LightBounds::bounds" class="code">bounds</a>.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3::SurfaceArea" class="code">SurfaceArea</a>();</div></div>
}</div><p>


</p>
<p></p>
<span class="anchor" id="fig:light-bvh-direction-bounds-integrate"></span><div class="card outerfigure"><div class="card-body figure"><p>



</p>
<div class="figure-row">
  <a href="pha12f32.svg" title=""><img src="pha12f32.svg" width=253 height=232 style="max-width: 100%;"></a>
</div>
<p>


</p>
<figcaption class="caption">Figure 12.32: <span class="legend">
The direction bounds measure is found by integrating to find the
solid angle of the center cone up to <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.145ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 923.4 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">theta Subscript normal o</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D703" d="M455 500c0 -224 -152 -511 -293 -511c-91 0 -120 111 -120 205c0 229 154 511 293 511c102 0 120 -139 120 -205zM389 562c0 57 -6 121 -55 121c-45 0 -82 -56 -109 -105c-40 -71 -60 -151 -77 -215h209c24 99 32 150 32 199zM348 331h-208c-26 -98 -32 -156 -32 -198 c0 -93 21 -122 54 -122c43 0 81 49 116 117c38 72 59 157 70 203Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6F" d="M471 214c0 -127 -101 -225 -222 -225c-117 0 -221 96 -221 225c0 125 97 234 222 234c121 0 221 -106 221 -234zM388 222c0 38 0 96 -26 139s-69 65 -113 65c-40 0 -87 -21 -114 -67c-24 -44 -24 -98 -24 -137c0 -36 0 -97 25 -141c27 -46 71 -67 114 -67 c50 0 94 29 116 74c22 44 22 98 22 134Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D703" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6F" x="663" y="-213"></use>
</g>
</svg> and then applying a
cosine weighting over the additional angle of <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.053ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 883.8 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">theta Subscript normal e</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D703" d="M455 500c0 -224 -152 -511 -293 -511c-91 0 -120 111 -120 205c0 229 154 511 293 511c102 0 120 -139 120 -205zM389 562c0 57 -6 121 -55 121c-45 0 -82 -56 -109 -105c-40 -71 -60 -151 -77 -215h209c24 99 32 150 32 199zM348 331h-208c-26 -98 -32 -156 -32 -198 c0 -93 21 -122 54 -122c43 0 81 49 116 117c38 72 59 157 70 203Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-65" d="M415 119c0 -19 -45 -130 -167 -130c-115 0 -220 97 -220 231c0 125 92 228 208 228c125 0 179 -97 179 -196c0 -21 -3 -21 -25 -21h-279c0 -36 0 -102 30 -150c23 -37 63 -67 113 -67c10 0 100 0 135 103c2 8 4 14 13 14c5 0 13 -2 13 -12zM349 252 c0 39 -10 174 -113 174c-34 0 -118 -25 -124 -174h237Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D703" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-65" x="663" y="-213"></use>
</g>
</svg>.
</span>
</figcaption>
</div></div><p>


</p>
<p>The principal surface normal direction and the angles <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.145ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 923.4 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">theta Subscript normal o</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D703" d="M455 500c0 -224 -152 -511 -293 -511c-91 0 -120 111 -120 205c0 229 154 511 293 511c102 0 120 -139 120 -205zM389 562c0 57 -6 121 -55 121c-45 0 -82 -56 -109 -105c-40 -71 -60 -151 -77 -215h209c24 99 32 150 32 199zM348 331h-208c-26 -98 -32 -156 -32 -198 c0 -93 21 -122 54 -122c43 0 81 49 116 117c38 72 59 157 70 203Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6F" d="M471 214c0 -127 -101 -225 -222 -225c-117 0 -221 96 -221 225c0 125 97 234 222 234c121 0 221 -106 221 -234zM388 222c0 38 0 96 -26 139s-69 65 -113 65c-40 0 -87 -21 -114 -67c-24 -44 -24 -98 -24 -137c0 -36 0 -97 25 -141c27 -46 71 -67 114 -67 c50 0 94 29 116 74c22 44 22 98 22 134Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D703" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6F" x="663" y="-213"></use>
</g>
</svg>
and <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.053ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 883.8 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">theta Subscript normal e</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D703" d="M455 500c0 -224 -152 -511 -293 -511c-91 0 -120 111 -120 205c0 229 154 511 293 511c102 0 120 -139 120 -205zM389 562c0 57 -6 121 -55 121c-45 0 -82 -56 -109 -105c-40 -71 -60 -151 -77 -215h209c24 99 32 150 32 199zM348 331h-208c-26 -98 -32 -156 -32 -198 c0 -93 21 -122 54 -122c43 0 81 49 116 117c38 72 59 157 70 203Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-65" d="M415 119c0 -19 -45 -130 -167 -130c-115 0 -220 97 -220 231c0 125 92 228 208 228c125 0 179 -97 179 -196c0 -21 -3 -21 -25 -21h-279c0 -36 0 -102 30 -150c23 -37 63 -67 113 -67c10 0 100 0 135 103c2 8 4 14 13 14c5 0 13 -2 13 -12zM349 252 c0 39 -10 174 -113 174c-34 0 -118 -25 -124 -174h237Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D703" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-65" x="663" y="-213"></use>
</g>
</svg> that are stored in <a href="#LightBounds"><tt>LightBounds</tt></a> are
worthwhile to include in the light BVH cost function.  Doing so can
encourage partitions of primitives into groups that emit light in different
directions, which can be helpful for culling groups of lights
that do not illuminate a given receiving point.
To compute these costs, <tt>pbrt</tt> uses a weighted measure of the solid angle of directions
that the direction bounds subtend.  A weight of&nbsp;1 is used for all
directions inside the center cone up to <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.145ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 923.4 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">theta Subscript normal o</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D703" d="M455 500c0 -224 -152 -511 -293 -511c-91 0 -120 111 -120 205c0 229 154 511 293 511c102 0 120 -139 120 -205zM389 562c0 57 -6 121 -55 121c-45 0 -82 -56 -109 -105c-40 -71 -60 -151 -77 -215h209c24 99 32 150 32 199zM348 331h-208c-26 -98 -32 -156 -32 -198 c0 -93 21 -122 54 -122c43 0 81 49 116 117c38 72 59 157 70 203Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6F" d="M471 214c0 -127 -101 -225 -222 -225c-117 0 -221 96 -221 225c0 125 97 234 222 234c121 0 221 -106 221 -234zM388 222c0 38 0 96 -26 139s-69 65 -113 65c-40 0 -87 -21 -114 -67c-24 -44 -24 -98 -24 -137c0 -36 0 -97 25 -141c27 -46 71 -67 114 -67 c50 0 94 29 116 74c22 44 22 98 22 134Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D703" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6F" x="663" y="-213"></use>
</g>
</svg> and then the
remainder of directions up to <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.053ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 883.8 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">theta Subscript normal e</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D703" d="M455 500c0 -224 -152 -511 -293 -511c-91 0 -120 111 -120 205c0 229 154 511 293 511c102 0 120 -139 120 -205zM389 562c0 57 -6 121 -55 121c-45 0 -82 -56 -109 -105c-40 -71 -60 -151 -77 -215h209c24 99 32 150 32 199zM348 331h-208c-26 -98 -32 -156 -32 -198 c0 -93 21 -122 54 -122c43 0 81 49 116 117c38 72 59 157 70 203Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-65" d="M415 119c0 -19 -45 -130 -167 -130c-115 0 -220 97 -220 231c0 125 92 228 208 228c125 0 179 -97 179 -196c0 -21 -3 -21 -25 -21h-279c0 -36 0 -102 30 -150c23 -37 63 -67 113 -67c10 0 100 0 135 103c2 8 4 14 13 14c5 0 13 -2 13 -12zM349 252 c0 39 -10 174 -113 174c-34 0 -118 -25 -124 -174h237Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D703" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-65" x="663" y="-213"></use>
</g>
</svg> are cosine-weighted,
following the importance computation earlier.  (See
Figure&nbsp;<a href="#fig:light-bvh-direction-bounds-integrate">12.32</a>.)
Integrating over the relevant directions gives us the direction bounds
measure,
</p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">
<div class="displaymath"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="65.633ex" height="7.509ex" style="vertical-align: -3.171ex;" viewBox="0 -1867.7 28258.5 3233.2" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">upper M Subscript normal upper Omega Baseline equals 2 pi left-parenthesis integral Subscript 0 Superscript theta Subscript normal o Baseline Baseline sine theta prime normal d theta Superscript prime Baseline plus integral Subscript theta Subscript normal o Baseline Superscript min left-parenthesis theta Subscript normal o Baseline plus theta Subscript normal e Baseline comma pi right-parenthesis Baseline cosine left-parenthesis theta prime minus theta Subscript normal o Baseline right-parenthesis sine theta prime normal d theta Superscript prime Baseline right-parenthesis period</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E2-LATINMODERNNORMAL-1D440" d="M1044 672c0 -20 -9 -20 -32 -20c-75 0 -77 -10 -86 -46l-133 -533c-5 -18 -5 -20 -5 -24c0 -18 28 -18 65 -18c19 0 28 0 28 -11c0 -20 -13 -20 -19 -20c-41 0 -84 3 -125 3l-124 -3c-3 0 -15 0 -15 12c0 19 11 19 28 19c79 0 81 8 91 47l143 573h-1l-404 -633 c-5 -7 -11 -18 -22 -18c-12 0 -13 11 -15 23l-86 620h-1l-136 -545c-3 -11 -4 -16 -4 -23c0 -23 11 -43 68 -44c7 0 18 0 18 -11c0 -20 -13 -20 -18 -20c-33 0 -69 3 -103 3c-33 0 -68 -3 -100 -3c-8 0 -14 3 -14 12c0 18 13 19 18 19c81 3 98 35 108 75l127 509 c3 12 4 15 4 19c0 11 -6 14 -22 16c-12 1 -30 2 -43 2c-20 0 -29 0 -29 12c0 19 11 19 30 19h137c26 0 28 0 31 -23l78 -566l365 570c12 19 13 19 39 19h132c17 0 27 0 27 -11Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-3A9" d="M677 162l-33 -162h-159c-23 0 -26 0 -26 21c0 69 32 159 47 201c29 82 56 158 56 233c0 156 -106 228 -202 228c-91 0 -201 -68 -201 -228c0 -75 28 -154 49 -212c23 -64 54 -152 54 -222c0 -21 -3 -21 -25 -21h-160l-33 162h25c5 -25 10 -51 18 -74c5 -15 8 -23 66 -23 h80c-13 56 -45 104 -89 170c-47 71 -88 140 -88 219c0 137 133 251 305 251c169 0 304 -112 304 -251c0 -79 -41 -148 -88 -219c-45 -66 -76 -114 -89 -170h80c58 0 61 8 66 24c9 24 13 47 18 73h25Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-3D" d="M722 347c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20zM722 153c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-32" d="M449 174l-28 -174h-371c0 24 0 26 11 37l192 214c55 62 105 141 105 221c0 82 -43 163 -134 163c-58 0 -112 -37 -135 -102c3 1 5 1 13 1c35 0 53 -26 53 -52c0 -41 -35 -53 -52 -53c-3 0 -53 0 -53 56c0 89 74 181 187 181c122 0 212 -80 212 -194 c0 -100 -60 -154 -216 -292l-106 -103h180c22 0 88 0 95 8c10 15 17 59 22 89h25Z"></path>
<path stroke-width="1" id="E2-LATINMODERNNORMAL-1D70B" d="M567 407c0 -34 -36 -34 -49 -34h-114c-11 -52 -18 -106 -18 -159c0 -28 0 -93 29 -165c6 -14 6 -16 6 -22c0 -20 -21 -38 -41 -38c-15 0 -26 6 -36 50c-8 34 -8 61 -8 76c0 67 9 110 42 258h-113l-56 -221c-13 -50 -13 -52 -27 -98c-12 -37 -20 -65 -50 -65 c-13 0 -29 8 -29 27c0 7 0 9 8 24c42 91 96 212 128 333h-57c-20 0 -78 0 -127 -77c-6 -8 -8 -12 -16 -12c-12 0 -12 10 -12 10c0 5 26 51 61 90c44 47 82 47 104 47h335c19 0 40 0 40 -24Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E2-LATINMODERNSIZE1-222B" d="M943 1268c0 -35 -25 -50 -49 -50c-23 0 -48 16 -48 49c0 25 17 47 50 49c-4 4 -29 23 -60 23c-39 0 -73 -129 -85 -178c-34 -129 -71 -329 -108 -542c-54 -321 -119 -640 -196 -956c-71 -290 -128 -524 -280 -524c-61 0 -111 42 -111 93c0 35 25 50 49 50 c23 0 48 -16 48 -49c0 -25 -17 -47 -49 -49c0 0 25 -23 61 -23c81 0 127 188 145 261c33 139 62 306 88 459c110 654 246 1156 249 1167c55 204 111 313 187 313c55 0 109 -39 109 -93Z"></path>
<path stroke-width="1" id="E2-LATINMODERNNORMAL-1D703" d="M455 500c0 -224 -152 -511 -293 -511c-91 0 -120 111 -120 205c0 229 154 511 293 511c102 0 120 -139 120 -205zM389 562c0 57 -6 121 -55 121c-45 0 -82 -56 -109 -105c-40 -71 -60 -151 -77 -215h209c24 99 32 150 32 199zM348 331h-208c-26 -98 -32 -156 -32 -198 c0 -93 21 -122 54 -122c43 0 81 49 116 117c38 72 59 157 70 203Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-6F" d="M471 214c0 -127 -101 -225 -222 -225c-117 0 -221 96 -221 225c0 125 97 234 222 234c121 0 221 -106 221 -234zM388 222c0 38 0 96 -26 139s-69 65 -113 65c-40 0 -87 -21 -114 -67c-24 -44 -24 -98 -24 -137c0 -36 0 -97 25 -141c27 -46 71 -67 114 -67 c50 0 94 29 116 74c22 44 22 98 22 134Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-30" d="M460 320c0 -79 -5 -157 -37 -226c-44 -95 -120 -116 -174 -116c-49 0 -122 20 -165 101c-41 76 -45 166 -45 241c0 80 5 158 37 227c41 93 114 119 174 119c42 0 124 -16 170 -112c35 -74 40 -154 40 -234zM377 332c0 63 0 139 -10 195c-19 99 -85 117 -118 117 c-25 0 -100 -9 -119 -128c-8 -54 -8 -120 -8 -184c0 -59 0 -151 11 -211c18 -96 77 -121 116 -121c45 0 102 30 117 125c11 64 11 132 11 207Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-73" d="M360 128c0 -72 -46 -139 -161 -139c-21 0 -66 1 -110 43c-18 -19 -18 -21 -20 -23c-19 -19 -20 -20 -25 -20c-11 0 -11 7 -11 24v132c0 18 0 25 13 25c10 0 11 -4 14 -17c19 -85 55 -142 139 -142c78 0 113 40 113 91c0 72 -82 88 -104 92c-72 14 -100 20 -132 46 c-27 22 -43 50 -43 85c0 56 38 123 160 123c15 0 56 0 94 -28c4 3 14 12 17 16c13 12 15 12 20 12c11 0 11 -7 11 -24v-101c0 -19 0 -24 -13 -24c0 0 -11 0 -12 9c-2 31 -7 121 -117 121c-86 0 -112 -41 -112 -76c0 -58 67 -71 123 -82c42 -8 81 -16 114 -48 c12 -12 42 -42 42 -95Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-69" d="M247 0c-34 1 -69 3 -104 3l-110 -3v31c67 0 78 0 78 45v269c0 49 -9 55 -74 55v31l140 11v-367c0 -39 4 -44 70 -44v-31zM192 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-6E" d="M535 0l-112 3l-113 -3v31c67 0 78 0 78 45v233c0 57 -11 111 -74 111c-64 0 -135 -56 -135 -160v-184c0 -45 11 -45 78 -45v-31l-112 3l-113 -3v31c67 0 78 0 78 45v268c0 49 -8 56 -78 56v31l141 11v-105c28 62 75 105 148 105c58 0 91 -20 105 -37 c31 -36 31 -67 31 -153v-191c1 -30 26 -30 78 -30v-31Z"></path>
<path stroke-width="1" id="E2-LATINMODERNVARIANTS-2032" d="M340 496c0 -10 -3 -20 -8 -28l-227 -372h-38l171 424c6 15 26 29 48 29c30 0 54 -24 54 -53Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-64" d="M527 0l-147 -11v66c-25 -32 -70 -66 -134 -66c-114 0 -212 99 -212 226c0 129 105 227 223 227c54 0 97 -26 126 -62v216c0 49 -8 56 -78 56v31l144 11v-607c0 -49 8 -56 78 -56v-31zM380 118v205c0 18 0 20 -11 37c-31 45 -73 60 -108 60c-54 0 -92 -33 -113 -64 c-29 -45 -31 -105 -31 -142c0 -41 3 -98 29 -139c24 -38 60 -64 105 -64c43 0 88 22 118 70c11 17 11 19 11 37Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-2B" d="M722 250c0 -11 -9 -20 -20 -20h-293v-293c0 -11 -9 -20 -20 -20s-20 9 -20 20v293h-293c-11 0 -20 9 -20 20s9 20 20 20h293v293c0 11 9 20 20 20s20 -9 20 -20v-293h293c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-6D" d="M813 0l-112 3l-113 -3v31c67 0 78 0 78 45v233c0 57 -11 111 -74 111c-64 0 -135 -56 -135 -160v-184c0 -45 11 -45 78 -45v-31l-112 3l-113 -3v31c67 0 78 0 78 45v233c0 57 -11 111 -74 111c-64 0 -135 -56 -135 -160v-184c0 -45 11 -45 78 -45v-31l-112 3l-113 -3v31 c67 0 78 0 78 45v268c0 49 -8 56 -78 56v31l141 11v-105c28 62 75 105 148 105c45 0 119 -11 133 -98c17 38 61 98 145 98c58 0 91 -20 105 -37c31 -36 31 -67 31 -153v-191c1 -30 26 -30 78 -30v-31Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-65" d="M415 119c0 -19 -45 -130 -167 -130c-115 0 -220 97 -220 231c0 125 92 228 208 228c125 0 179 -97 179 -196c0 -21 -3 -21 -25 -21h-279c0 -36 0 -102 30 -150c23 -37 63 -67 113 -67c10 0 100 0 135 103c2 8 4 14 13 14c5 0 13 -2 13 -12zM349 252 c0 39 -10 174 -113 174c-34 0 -118 -25 -124 -174h237Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-63" d="M415 119c0 -10 -32 -130 -166 -130c-116 0 -215 99 -215 227c0 124 92 232 217 232c77 0 153 -39 153 -107c0 -30 -20 -47 -46 -47c-28 0 -46 20 -46 46c0 13 6 43 47 46c-35 36 -98 37 -107 37c-53 0 -135 -42 -135 -205c0 -161 88 -204 141 -204c37 0 102 12 131 105 c2 6 4 10 13 10c3 0 13 0 13 -10Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-2212" d="M722 250c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E2-LATINMODERNSIZE7-28" d="M823 -1224c0 -11 -10 -21 -21 -21c-5 0 -9 2 -12 4c-268 202 -513 751 -513 1241v500c0 490 245 1039 513 1241c3 2 7 4 12 4c11 0 21 -10 21 -21c0 -7 -3 -13 -9 -17c-255 -192 -435 -739 -435 -1207v-500c0 -468 180 -1015 435 -1207c6 -4 9 -10 9 -17Z"></path>
<path stroke-width="1" id="E2-LATINMODERNSIZE7-29" d="M598 0c0 -490 -245 -1039 -513 -1241c-3 -2 -7 -4 -12 -4c-11 0 -21 10 -21 21c0 7 3 13 9 17c255 192 435 739 435 1207v500c0 468 -180 1015 -435 1207c-6 4 -9 10 -9 17c0 11 10 21 21 21c5 0 9 -2 12 -4c268 -202 513 -751 513 -1241v-500Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-2E" d="M192 53c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E2-LATINMODERNNORMAL-1D440" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E2-LATINMODERNMAIN-3A9" x="1372" y="-219"></use>
 <use xlink:href="#E2-LATINMODERNMAIN-3D" x="1859" y="0"></use>
 <use xlink:href="#E2-LATINMODERNMAIN-32" x="2915" y="0"></use>
 <use xlink:href="#E2-LATINMODERNNORMAL-1D70B" x="3415" y="0"></use>
<g transform="translate(4153,0)">
 <use xlink:href="#E2-LATINMODERNSIZE7-28"></use>
<g transform="translate(875,0)">
 <use xlink:href="#E2-LATINMODERNSIZE1-222B" x="0" y="0"></use>
<g transform="translate(1054,1088)">
 <use transform="scale(0.707)" xlink:href="#E2-LATINMODERNNORMAL-1D703" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E2-LATINMODERNMAIN-6F" x="578" y="-185"></use>
</g>
 <use transform="scale(0.707)" xlink:href="#E2-LATINMODERNMAIN-30" x="812" y="-1270"></use>
</g>
<g transform="translate(2886,0)">
 <use xlink:href="#E2-LATINMODERNMAIN-73"></use>
 <use xlink:href="#E2-LATINMODERNMAIN-69" x="394" y="0"></use>
 <use xlink:href="#E2-LATINMODERNMAIN-6E" x="673" y="0"></use>
</g>
<g transform="translate(4282,0)">
 <use xlink:href="#E2-LATINMODERNNORMAL-1D703" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E2-LATINMODERNVARIANTS-2032" x="663" y="583"></use>
</g>
 <use xlink:href="#E2-LATINMODERNMAIN-64" x="5306" y="0"></use>
<g transform="translate(5863,0)">
 <use xlink:href="#E2-LATINMODERNNORMAL-1D703" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E2-LATINMODERNVARIANTS-2032" x="663" y="583"></use>
</g>
 <use xlink:href="#E2-LATINMODERNMAIN-2B" x="6943" y="0"></use>
<g transform="translate(7944,0)">
 <use xlink:href="#E2-LATINMODERNSIZE1-222B" x="0" y="0"></use>
<g transform="translate(1054,1088)">
 <use transform="scale(0.707)" xlink:href="#E2-LATINMODERNMAIN-6D"></use>
 <use transform="scale(0.707)" xlink:href="#E2-LATINMODERNMAIN-69" x="833" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E2-LATINMODERNMAIN-6E" x="1112" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E2-LATINMODERNMAIN-28" x="1668" y="0"></use>
<g transform="translate(1455,0)">
 <use transform="scale(0.707)" xlink:href="#E2-LATINMODERNNORMAL-1D703" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E2-LATINMODERNMAIN-6F" x="578" y="-185"></use>
</g>
 <use transform="scale(0.707)" xlink:href="#E2-LATINMODERNMAIN-2B" x="3033" y="0"></use>
<g transform="translate(2695,0)">
 <use transform="scale(0.707)" xlink:href="#E2-LATINMODERNNORMAL-1D703" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E2-LATINMODERNMAIN-65" x="578" y="-185"></use>
</g>
 <use transform="scale(0.707)" xlink:href="#E2-LATINMODERNMAIN-2C" x="4742" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E2-LATINMODERNNORMAL-1D70B" x="5021" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E2-LATINMODERNMAIN-29" x="5591" y="0"></use>
</g>
<g transform="translate(574,-898)">
 <use transform="scale(0.707)" xlink:href="#E2-LATINMODERNNORMAL-1D703" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E2-LATINMODERNMAIN-6F" x="578" y="-185"></use>
</g>
</g>
<g transform="translate(13494,0)">
 <use xlink:href="#E2-LATINMODERNMAIN-63"></use>
 <use xlink:href="#E2-LATINMODERNMAIN-6F" x="444" y="0"></use>
 <use xlink:href="#E2-LATINMODERNMAIN-73" x="945" y="0"></use>
</g>
 <use xlink:href="#E2-LATINMODERNMAIN-28" x="14833" y="0"></use>
<g transform="translate(15223,0)">
 <use xlink:href="#E2-LATINMODERNNORMAL-1D703" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E2-LATINMODERNVARIANTS-2032" x="663" y="583"></use>
</g>
 <use xlink:href="#E2-LATINMODERNMAIN-2212" x="16303" y="0"></use>
<g transform="translate(17303,0)">
 <use xlink:href="#E2-LATINMODERNNORMAL-1D703" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E2-LATINMODERNMAIN-6F" x="663" y="-213"></use>
</g>
 <use xlink:href="#E2-LATINMODERNMAIN-29" x="18227" y="0"></use>
<g transform="translate(18950,0)">
 <use xlink:href="#E2-LATINMODERNMAIN-73"></use>
 <use xlink:href="#E2-LATINMODERNMAIN-69" x="394" y="0"></use>
 <use xlink:href="#E2-LATINMODERNMAIN-6E" x="673" y="0"></use>
</g>
<g transform="translate(20346,0)">
 <use xlink:href="#E2-LATINMODERNNORMAL-1D703" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E2-LATINMODERNVARIANTS-2032" x="663" y="583"></use>
</g>
 <use xlink:href="#E2-LATINMODERNMAIN-64" x="21370" y="0"></use>
<g transform="translate(21927,0)">
 <use xlink:href="#E2-LATINMODERNNORMAL-1D703" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E2-LATINMODERNVARIANTS-2032" x="663" y="583"></use>
</g>
 <use xlink:href="#E2-LATINMODERNSIZE7-29" x="22784" y="0"></use>
</g>
 <use xlink:href="#E2-LATINMODERNMAIN-2E" x="27980" y="0"></use>
</g>
</svg>
</div>
<p>

The first term integrates to <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="9.646ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 4153 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">1 minus cosine theta Subscript normal o</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2212" d="M722 250c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-63" d="M415 119c0 -10 -32 -130 -166 -130c-116 0 -215 99 -215 227c0 124 92 232 217 232c77 0 153 -39 153 -107c0 -30 -20 -47 -46 -47c-28 0 -46 20 -46 46c0 13 6 43 47 46c-35 36 -98 37 -107 37c-53 0 -135 -42 -135 -205c0 -161 88 -204 141 -204c37 0 102 12 131 105 c2 6 4 10 13 10c3 0 13 0 13 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6F" d="M471 214c0 -127 -101 -225 -222 -225c-117 0 -221 96 -221 225c0 125 97 234 222 234c121 0 221 -106 221 -234zM388 222c0 38 0 96 -26 139s-69 65 -113 65c-40 0 -87 -21 -114 -67c-24 -44 -24 -98 -24 -137c0 -36 0 -97 25 -141c27 -46 71 -67 114 -67 c50 0 94 29 116 74c22 44 22 98 22 134Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-73" d="M360 128c0 -72 -46 -139 -161 -139c-21 0 -66 1 -110 43c-18 -19 -18 -21 -20 -23c-19 -19 -20 -20 -25 -20c-11 0 -11 7 -11 24v132c0 18 0 25 13 25c10 0 11 -4 14 -17c19 -85 55 -142 139 -142c78 0 113 40 113 91c0 72 -82 88 -104 92c-72 14 -100 20 -132 46 c-27 22 -43 50 -43 85c0 56 38 123 160 123c15 0 56 0 94 -28c4 3 14 12 17 16c13 12 15 12 20 12c11 0 11 -7 11 -24v-101c0 -19 0 -24 -13 -24c0 0 -11 0 -12 9c-2 31 -7 121 -117 121c-86 0 -112 -41 -112 -76c0 -58 67 -71 123 -82c42 -8 81 -16 114 -48 c12 -12 42 -42 42 -95Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D703" d="M455 500c0 -224 -152 -511 -293 -511c-91 0 -120 111 -120 205c0 229 154 511 293 511c102 0 120 -139 120 -205zM389 562c0 57 -6 121 -55 121c-45 0 -82 -56 -109 -105c-40 -71 -60 -151 -77 -215h209c24 99 32 150 32 199zM348 331h-208c-26 -98 -32 -156 -32 -198 c0 -93 21 -122 54 -122c43 0 81 49 116 117c38 72 59 157 70 203Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-31" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2212" x="722" y="0"></use>
<g transform="translate(1723,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-63"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-6F" x="444" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-73" x="945" y="0"></use>
</g>
<g transform="translate(3229,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D703" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6F" x="663" y="-213"></use>
</g>
</g>
</svg> and the second has
a simple analytic form that is evaluated in the second term of
<tt>M_omega</tt>&rsquo;s initializer below.

</p>
<p></p>
<span class="anchor" id="fragment-EvaluatedirectionboundsmeasureformonoLightBounds-0"></span><div class="fragmentname">&lt;&lt;Evaluate direction bounds measure for <tt>LightBounds</tt>&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">Float theta_o = std::acos(b.<a href="#LightBounds::cosTheta_o" class="code">cosTheta_o</a>), theta_e = std::acos(b.<a href="#LightBounds::cosTheta_e" class="code">cosTheta_e</a>);
Float theta_w = std::min(theta_o + theta_e, <a href="../Utilities/Mathematical_Infrastructure.html#Pi" class="code">Pi</a>);
Float sinTheta_o = <a href="../Utilities/Mathematical_Infrastructure.html#SafeSqrt" class="code">SafeSqrt</a>(1 - <a href="../Utilities/Mathematical_Infrastructure.html#Sqr" class="code">Sqr</a>(b.<a href="#LightBounds::cosTheta_o" class="code">cosTheta_o</a>));
Float M_omega = 2 * <a href="../Utilities/Mathematical_Infrastructure.html#Pi" class="code">Pi</a> * (1 - b.<a href="#LightBounds::cosTheta_o" class="code">cosTheta_o</a>) +
    <a href="../Utilities/Mathematical_Infrastructure.html#Pi" class="code">Pi</a> / 2 * (2 * theta_w * sinTheta_o - std::cos(theta_o - 2 * theta_w) -
              2 * theta_o * sinTheta_o + b.<a href="#LightBounds::cosTheta_o" class="code">cosTheta_o</a>);</div><p>


</p>
<p>Three other factors go into the full cost estimate:
</p>
<ul>
<li> The power estimate <tt>phi</tt>: in general, the higher the power of
the lights in a <a href="#LightBounds"><tt>LightBounds</tt></a>, the more important it is to minimize
factors like the spatial and direction bounds.
<li> A regularization factor <tt>Kr</tt> that discourages long and thin
bounding boxes.
<li> The surface area of the <a href="#LightBounds"><tt>LightBounds</tt></a>&rsquo;s bounding box.
</ul><p>


</p>
<p>The use of surface area in the cost metric deserves note: with the
<a href="../Primitives_and_Intersection_Acceleration/Bounding_Volume_Hierarchies.html#BVHAggregate"><tt>BVHAggregate</tt></a>, the surface area heuristic was grounded in geometric
probability, as the surface area of a convex object is proportional to the
probability of a random ray intersecting it.  In this case, no rays are
being traced.  Arguably, minimizing the volume of the bounds would be a
more appropriate approach in this case.  In practice, the surface area
seems to be more effective&mdash;one reason is that it penalizes bounding boxes
that span a large extent in two dimensions but little or none in the third.
Such bounding boxes are undesirable as they may subtend large solid angles,
adding more uncertainty to importance estimates.

</p>
<p></p>
<span class="anchor" id="fragment-ReturncompletecostestimateformonoLightBounds-0"></span><div class="fragmentname">&lt;&lt;Return complete cost estimate for <tt>LightBounds</tt>&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">Float Kr = <a href="../Geometry_and_Transformations/n-Tuple_Base_Classes.html#Tuple3::MaxComponentValue" class="code">MaxComponentValue</a>(<a href="#LightBounds::bounds" class="code">bounds</a>.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3::Diagonal" class="code">Diagonal</a>()) / <a href="#LightBounds::bounds" class="code">bounds</a>.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3::Diagonal" class="code">Diagonal</a>()[dim];
return b.<a href="#LightBounds::phi" class="code">phi</a> * M_omega * Kr * b.<a href="#LightBounds::bounds" class="code">bounds</a>.<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3::SurfaceArea" class="code">SurfaceArea</a>();</div><p>


</p>
<p>

</p>
<p>Once the lights have been partitioned, two fragments take care of recursively
initializing the child nodes and then initializing the interior node.  The
first step is to take a spot in the <tt>nodes</tt> array for the interior
node; this spot must be claimed before the children are initialized in
order to ensure that the first child is the successor of the interior node
in the array.
Two recursive calls to <tt>buildBVH()</tt> then initialize the children.  The main
thing to note in them is the maintenance of the <tt>bitTrail</tt> value
passed down into each one.  For the first child, the corresponding bit
should be set to zero. <tt>bitTrail</tt> is zero-initialized in the initial
call to <tt>buildBVH()</tt>, so it has
this value already and there is nothing to do.  For the second call, the
bit for the current tree depth is set to&nbsp;1.

</p>
<p></p>
<span class="anchor" id="fragment-AllocateinteriormonoLightBVHNodeandrecursivelyinitializechildren-0"></span><div class="fragmentname">&lt;&lt;Allocate interior <tt>LightBVHNode</tt> and recursively initialize children&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">int nodeIndex = <a href="#BVHLightSampler::nodes" class="code">nodes</a>.size();
<a href="#BVHLightSampler::nodes" class="code">nodes</a>.push_back(<a href="#LightBVHNode" class="code">LightBVHNode</a>());
std::pair&lt;int, <a href="#LightBounds" class="code">LightBounds</a>&gt; child0 =
    <a href="#BVHLightSampler::buildBVH" class="code">buildBVH</a>(bvhLights, start, mid, bitTrail, depth + 1);
std::pair&lt;int, <a href="#LightBounds" class="code">LightBounds</a>&gt; child1 =
    <a href="#BVHLightSampler::buildBVH" class="code">buildBVH</a>(bvhLights, mid, end, bitTrail | (1u &lt;&lt; depth), depth + 1);</div><p>


</p>
<p>The interior node can be initialized after the children have been.  Its
light bounds are given by the union of its children&rsquo;s, which allows
initializing a <a href="#CompactLightBounds"><tt>CompactLightBounds</tt></a> and then the <a href="#LightBVHNode"><tt>LightBVHNode</tt></a>
itself.
 
</p>
<span class="anchor" id="fragment-Initializeinteriornodeandreturnnodeindexandbounds-0"></span><div class="fragmentname">&lt;&lt;Initialize interior node and return node index and bounds&gt;&gt;=&nbsp;</div>
<div class="fragmentcode"><a href="#LightBounds" class="code">LightBounds</a> lb = <a href="#LightBounds::Union" class="code">Union</a>(child0.second, child1.second);
<a href="#CompactLightBounds" class="code">CompactLightBounds</a> cb(lb, <a href="#BVHLightSampler::allLightBounds" class="code">allLightBounds</a>);
nodes[nodeIndex] = <a href="#LightBVHNode::MakeInterior" class="code">LightBVHNode</a>::MakeInterior(child1.first, cb);
return {nodeIndex, lb};</div><p>


</p>
<p>Given the BVH, we can now implement the <tt>Sample()</tt> method, which samples a
light given a reference point in a <a href="../Light_Sources/Light_Interface.html#LightSampleContext"><tt>LightSampleContext</tt></a>.

</p>
<p></p>
<span class="anchor" id="fragment-BVHLightSamplerPublicMethods-0"></span><div class="fragmentname">&lt;&lt;BVHLightSampler Public Methods&gt;&gt;=&nbsp;<a href="#fragment-BVHLightSamplerPublicMethods-1"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode">pstd::optional&lt;<a href="#SampledLight" class="code">SampledLight</a>&gt;
<span class="anchor" id="BVHLightSampler::Sample"></span>Sample(const <a href="../Light_Sources/Light_Interface.html#LightSampleContext" class="code">LightSampleContext</a> &amp;ctx, Float u) const {
    &lt;&lt;<span class="fragmentname"><a href="#fragment-ComputeinfinitelightsamplingprobabilitymonopInfinite-0">Compute infinite light sampling probability <tt>pInfinite</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1787" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1787"><i></i></a><div id="fragbit-1787" class="collapse show"><div class="fragmentcode">       Float pInfinite = Float(<a href="#BVHLightSampler::infiniteLights" class="code">infiniteLights</a>.size()) /
           Float(<a href="#BVHLightSampler::infiniteLights" class="code">infiniteLights</a>.size() + (<a href="#BVHLightSampler::nodes" class="code">nodes</a>.empty() ? 0 : 1));</div></div>
    if (u &lt; pInfinite) {
        &lt;&lt;<span class="fragmentname"><a href="#fragment-Sampleinfinitelightswithuniformprobability-0">Sample infinite lights with uniform probability</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1788" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1788"><i></i></a><div id="fragbit-1788" class="collapse show"><div class="fragmentcode">           u /= pInfinite;
           int index = std::min&lt;int&gt;(u * <a href="#BVHLightSampler::infiniteLights" class="code">infiniteLights</a>.size(),
                                     <a href="#BVHLightSampler::infiniteLights" class="code">infiniteLights</a>.size() - 1);
           Float pmf = pInfinite / <a href="#BVHLightSampler::infiniteLights" class="code">infiniteLights</a>.size();
           return <a href="#SampledLight" class="code">SampledLight</a>{<a href="#BVHLightSampler::infiniteLights" class="code">infiniteLights</a>[index], pmf};</div></div>
    } else {
        &lt;&lt;<span class="fragmentname"><a href="#fragment-TraverselightBVHtosamplelight-0">Traverse light BVH to sample light</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1789" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1789"><i></i></a><div id="fragbit-1789" class="collapse show"><div class="fragmentcode">           if (<a href="#BVHLightSampler::nodes" class="code">nodes</a>.empty())
               return {};
           &lt;&lt;<span class="fragmentname"><a href="#fragment-DeclarecommonvariablesforlightBVHtraversal-0">Declare common variables for light BVH traversal</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1790" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1790"><i></i></a><div id="fragbit-1790" class="collapse show"><div class="fragmentcode">              <a href="../Geometry_and_Transformations/Points.html#Point3f" class="code">Point3f</a> <a href="../Light_Sources/Light_Interface.html#LightSampleContext::p" class="code">p</a> = ctx.<a href="../Light_Sources/Light_Interface.html#LightSampleContext::p" class="code">p</a>();
              <a href="../Geometry_and_Transformations/Normals.html#Normal3f" class="code">Normal3f</a> n = ctx.<a href="../Light_Sources/Light_Interface.html#LightSampleContext::ns" class="code">ns</a>;
              u = std::min&lt;Float&gt;((u - pInfinite) / (1 - pInfinite), <a href="../Sampling_and_Reconstruction/Sampling_Interface.html#OneMinusEpsilon" class="code">OneMinusEpsilon</a>);
              int nodeIndex = 0;
              Float pmf = 1 - pInfinite;</div></div>
           while (true) {
               &lt;&lt;<span class="fragmentname"><a href="#fragment-ProcesslightBVHnodeforlightsampling-0">Process light BVH node for light sampling</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1791" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1791"><i></i></a><div id="fragbit-1791" class="collapse show"><div class="fragmentcode">                  <a href="#LightBVHNode" class="code">LightBVHNode</a> node = <a href="#BVHLightSampler::nodes" class="code">nodes</a>[nodeIndex];
                  if (!node.<a href="#LightBVHNode::isLeaf" class="code">isLeaf</a>) {
                      &lt;&lt;<span class="fragmentname"><a href="#fragment-ComputelightBVHchildnodeimportances-0">Compute light BVH child node importances</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1792" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1792"><i></i></a><div id="fragbit-1792" class="collapse show"><div class="fragmentcode">                         const <a href="#LightBVHNode" class="code">LightBVHNode</a> *children[2] = {&amp;nodes[nodeIndex + 1],
                                                            &amp;nodes[node.<a href="#LightBVHNode::childOrLightIndex" class="code">childOrLightIndex</a>] };
                         Float ci[2] = { children[0]-&gt;<a href="#LightBVHNode::lightBounds" class="code">lightBounds</a>.<a href="#CompactLightBounds::Importance" class="code">Importance</a>(p, n, <a href="#BVHLightSampler::allLightBounds" class="code">allLightBounds</a>),
                                         children[1]-&gt;<a href="#LightBVHNode::lightBounds" class="code">lightBounds</a>.<a href="#CompactLightBounds::Importance" class="code">Importance</a>(p, n, <a href="#BVHLightSampler::allLightBounds" class="code">allLightBounds</a>)};
                         if (ci[0] == 0 &amp;&amp; ci[1] == 0)
                             return {};</div></div>
                      &lt;&lt;<span class="fragmentname"><a href="#fragment-RandomlysamplelightBVHchildnode-0">Randomly sample light BVH child node</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1793" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1793"><i></i></a><div id="fragbit-1793" class="collapse show"><div class="fragmentcode">                         Float nodePMF;
                         int child = <a href="../Monte_Carlo_Integration/Sampling_Using_the_Inversion_Method.html#SampleDiscrete" class="code">SampleDiscrete</a>(ci, u, &amp;nodePMF, &amp;u);
                         pmf *= nodePMF;
                         nodeIndex = (child == 0) ? (nodeIndex + 1) : node.<a href="#LightBVHNode::childOrLightIndex" class="code">childOrLightIndex</a>;</div></div>
                  } else {
                      &lt;&lt;<span class="fragmentname"><a href="#fragment-Confirmlighthasnonzeroimportancebeforereturninglightsample-0">Confirm light has nonzero importance before returning light sample</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1794" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1794"><i></i></a><div id="fragbit-1794" class="collapse show"><div class="fragmentcode">                         if (nodeIndex &gt; 0 ||
                             node.<a href="#LightBVHNode::lightBounds" class="code">lightBounds</a>.<a href="#CompactLightBounds::Importance" class="code">Importance</a>(p, n, <a href="#BVHLightSampler::allLightBounds" class="code">allLightBounds</a>) &gt; 0)
                             return <a href="#SampledLight" class="code">SampledLight</a>{<a href="#BVHLightSampler::lights" class="code">lights</a>[node.<a href="#LightBVHNode::childOrLightIndex" class="code">childOrLightIndex</a>], pmf};
                         return {};</div></div>
                  }</div></div>
           }</div></div>
    }
}</div><p>


</p>
<p>The first choice to make is whether an infinite light should be sampled or
whether the light BVH should be used to choose a noninfinite light.
The <a href="#BVHLightSampler"><tt>BVHLightSampler</tt></a> gives equal probability to sampling each infinite
light and to sampling the BVH, from which the probability of sampling an
infinite light follows directly.

</p>
<p></p>
<span class="anchor" id="fragment-ComputeinfinitelightsamplingprobabilitymonopInfinite-0"></span><div class="fragmentname">&lt;&lt;Compute infinite light sampling probability <tt>pInfinite</tt>&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">Float pInfinite = Float(<a href="#BVHLightSampler::infiniteLights" class="code">infiniteLights</a>.size()) /
    Float(<a href="#BVHLightSampler::infiniteLights" class="code">infiniteLights</a>.size() + (<a href="#BVHLightSampler::nodes" class="code">nodes</a>.empty() ? 0 : 1));</div><p>


</p>
<p>If an infinite light is to be sampled, then the random sample <tt>u</tt> is
rescaled to provide a new uniform random sample that is used to index
into the <tt>infiniteLights</tt> array.

</p>
<p></p>
<span class="anchor" id="fragment-Sampleinfinitelightswithuniformprobability-0"></span><div class="fragmentname">&lt;&lt;Sample infinite lights with uniform probability&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">u /= pInfinite;
int index = std::min&lt;int&gt;(u * <a href="#BVHLightSampler::infiniteLights" class="code">infiniteLights</a>.size(),
                          <a href="#BVHLightSampler::infiniteLights" class="code">infiniteLights</a>.size() - 1);
Float pmf = pInfinite / <a href="#BVHLightSampler::infiniteLights" class="code">infiniteLights</a>.size();
return <a href="#SampledLight" class="code">SampledLight</a>{<a href="#BVHLightSampler::infiniteLights" class="code">infiniteLights</a>[index], pmf};</div><p>


</p>
<p>Otherwise a light is sampled by traversing the BVH.  At each interior node,
probabilities are found for sampling each of the two children using 
importance values returned by the <tt>LightBounds</tt> for the reference point.
A child node is then randomly chosen according to these probabilities.  In
the end, the probability of choosing a leaf node is equal to the product of
probabilities along the path from the root to the leaf (see
Figure&nbsp;<a href="#fig:sampling-light-bvh">12.33</a>).
With this traversal scheme, there is no need to maintain a stack of
nodes to be processed as the <a href="../Primitives_and_Intersection_Acceleration/Bounding_Volume_Hierarchies.html#BVHAggregate"><tt>BVHAggregate</tt></a> does&mdash;a single path is
taken down the tree from the root to a leaf.

</p>
<p> </p>
<span class="anchor" id="fig:sampling-light-bvh"></span><div class="card outerfigure"><div class="card-body figure"><p>



</p>
<div class="figure-row">
<img src="pha12f33.png" style="max-width: 100%; height: auto;" width=1172 height=615>
</div>
<p>


</p>
<figcaption class="caption">Figure 12.33: Sampling a Light BVH. <span class="legend">
At each non-leaf node of the tree, we compute discrete probabilities
<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.042ex" height="2.009ex" style="vertical-align: -0.671ex; margin-left: -0.073ex;" viewBox="-31.5 -576.1 879.3 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">p Subscript i</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45D" d="M490 282c0 -147 -125 -293 -241 -293c-51 0 -79 35 -92 64c-7 -25 -49 -188 -49 -200c0 -9 0 -16 50 -16c14 0 24 0 24 -11c0 -20 -13 -20 -18 -20c-32 0 -66 3 -99 3c-28 0 -57 -3 -84 -3c-8 0 -13 4 -13 12c0 19 11 19 23 19c44 0 46 7 54 41l112 445c4 17 7 28 7 51 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c37 0 80 -21 90 -75c33 39 81 75 131 75c76 0 133 -66 133 -160zM418 326c0 59 -24 94 -64 94c-17 0 -46 -7 -81 -38c-18 -15 -45 -43 -52 -70 l-49 -196c-3 -12 -3 -16 -3 -16c0 -6 13 -89 79 -89c37 0 85 33 119 103c18 38 51 153 51 212Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D456" d="M284 625c0 -30 -30 -53 -53 -53c-24 0 -38 17 -38 36c0 27 27 53 54 53c23 0 37 -16 37 -36zM293 143c0 -9 -37 -154 -131 -154c-48 0 -82 35 -82 82c0 21 13 54 23 80c16 43 61 159 69 185c4 10 11 31 11 52c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124 c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 38 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -13 -53c-10 -27 -10 -29 -22 -58l-39 -105c-23 -61 -29 -75 -29 -100c0 -23 7 -33 24 -33c51 0 84 61 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="712" y="-213"></use>
</g>
</svg> and <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.972ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 2571.2 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">1 minus p Subscript i</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2212" d="M722 250c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45D" d="M490 282c0 -147 -125 -293 -241 -293c-51 0 -79 35 -92 64c-7 -25 -49 -188 -49 -200c0 -9 0 -16 50 -16c14 0 24 0 24 -11c0 -20 -13 -20 -18 -20c-32 0 -66 3 -99 3c-28 0 -57 -3 -84 -3c-8 0 -13 4 -13 12c0 19 11 19 23 19c44 0 46 7 54 41l112 445c4 17 7 28 7 51 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c37 0 80 -21 90 -75c33 39 81 75 131 75c76 0 133 -66 133 -160zM418 326c0 59 -24 94 -64 94c-17 0 -46 -7 -81 -38c-18 -15 -45 -43 -52 -70 l-49 -196c-3 -12 -3 -16 -3 -16c0 -6 13 -89 79 -89c37 0 85 33 119 103c18 38 51 153 51 212Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D456" d="M284 625c0 -30 -30 -53 -53 -53c-24 0 -38 17 -38 36c0 27 27 53 54 53c23 0 37 -16 37 -36zM293 143c0 -9 -37 -154 -131 -154c-48 0 -82 35 -82 82c0 21 13 54 23 80c16 43 61 159 69 185c4 10 11 31 11 52c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124 c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 38 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -13 -53c-10 -27 -10 -29 -22 -58l-39 -105c-23 -61 -29 -75 -29 -100c0 -23 7 -33 24 -33c51 0 84 61 102 124c5 15 5 18 15 18c3 0 12 0 12 -10Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-31" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2212" x="722" y="0"></use>
<g transform="translate(1723,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D456" x="712" y="-213"></use>
</g>
</g>
</svg> for sampling each child node and then randomly choose a
child accordingly.  The probability of sampling each leaf node is the
product of probabilities along the path from the root of the tree down to
it.  Here, the nodes that are visited and the associated probabilities for
sampling the triangular light source are highlighted.</span>
</figcaption>
</div></div><p>


</p>
<p></p>
<span class="anchor" id="fragment-TraverselightBVHtosamplelight-0"></span><div class="fragmentname">&lt;&lt;Traverse light BVH to sample light&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">if (<a href="#BVHLightSampler::nodes" class="code">nodes</a>.empty())
    return {};
&lt;&lt;<span class="fragmentname"><a href="#fragment-DeclarecommonvariablesforlightBVHtraversal-0">Declare common variables for light BVH traversal</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1795" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1795"><i></i></a><div id="fragbit-1795" class="collapse show"><div class="fragmentcode">   <a href="../Geometry_and_Transformations/Points.html#Point3f" class="code">Point3f</a> <a href="../Light_Sources/Light_Interface.html#LightSampleContext::p" class="code">p</a> = ctx.<a href="../Light_Sources/Light_Interface.html#LightSampleContext::p" class="code">p</a>();
   <a href="../Geometry_and_Transformations/Normals.html#Normal3f" class="code">Normal3f</a> n = ctx.<a href="../Light_Sources/Light_Interface.html#LightSampleContext::ns" class="code">ns</a>;
   u = std::min&lt;Float&gt;((u - pInfinite) / (1 - pInfinite), <a href="../Sampling_and_Reconstruction/Sampling_Interface.html#OneMinusEpsilon" class="code">OneMinusEpsilon</a>);
   int nodeIndex = 0;
   Float pmf = 1 - pInfinite;</div></div>
while (true) {
    &lt;&lt;<span class="fragmentname"><a href="#fragment-ProcesslightBVHnodeforlightsampling-0">Process light BVH node for light sampling</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1796" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1796"><i></i></a><div id="fragbit-1796" class="collapse show"><div class="fragmentcode">       <a href="#LightBVHNode" class="code">LightBVHNode</a> node = <a href="#BVHLightSampler::nodes" class="code">nodes</a>[nodeIndex];
       if (!node.<a href="#LightBVHNode::isLeaf" class="code">isLeaf</a>) {
           &lt;&lt;<span class="fragmentname"><a href="#fragment-ComputelightBVHchildnodeimportances-0">Compute light BVH child node importances</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1797" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1797"><i></i></a><div id="fragbit-1797" class="collapse show"><div class="fragmentcode">              const <a href="#LightBVHNode" class="code">LightBVHNode</a> *children[2] = {&amp;nodes[nodeIndex + 1],
                                                 &amp;nodes[node.<a href="#LightBVHNode::childOrLightIndex" class="code">childOrLightIndex</a>] };
              Float ci[2] = { children[0]-&gt;<a href="#LightBVHNode::lightBounds" class="code">lightBounds</a>.<a href="#CompactLightBounds::Importance" class="code">Importance</a>(p, n, <a href="#BVHLightSampler::allLightBounds" class="code">allLightBounds</a>),
                              children[1]-&gt;<a href="#LightBVHNode::lightBounds" class="code">lightBounds</a>.<a href="#CompactLightBounds::Importance" class="code">Importance</a>(p, n, <a href="#BVHLightSampler::allLightBounds" class="code">allLightBounds</a>)};
              if (ci[0] == 0 &amp;&amp; ci[1] == 0)
                  return {};</div></div>
           &lt;&lt;<span class="fragmentname"><a href="#fragment-RandomlysamplelightBVHchildnode-0">Randomly sample light BVH child node</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1798" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1798"><i></i></a><div id="fragbit-1798" class="collapse show"><div class="fragmentcode">              Float nodePMF;
              int child = <a href="../Monte_Carlo_Integration/Sampling_Using_the_Inversion_Method.html#SampleDiscrete" class="code">SampleDiscrete</a>(ci, u, &amp;nodePMF, &amp;u);
              pmf *= nodePMF;
              nodeIndex = (child == 0) ? (nodeIndex + 1) : node.<a href="#LightBVHNode::childOrLightIndex" class="code">childOrLightIndex</a>;</div></div>
       } else {
           &lt;&lt;<span class="fragmentname"><a href="#fragment-Confirmlighthasnonzeroimportancebeforereturninglightsample-0">Confirm light has nonzero importance before returning light sample</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1799" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1799"><i></i></a><div id="fragbit-1799" class="collapse show"><div class="fragmentcode">              if (nodeIndex &gt; 0 ||
                  node.<a href="#LightBVHNode::lightBounds" class="code">lightBounds</a>.<a href="#CompactLightBounds::Importance" class="code">Importance</a>(p, n, <a href="#BVHLightSampler::allLightBounds" class="code">allLightBounds</a>) &gt; 0)
                  return <a href="#SampledLight" class="code">SampledLight</a>{<a href="#BVHLightSampler::lights" class="code">lights</a>[node.<a href="#LightBVHNode::childOrLightIndex" class="code">childOrLightIndex</a>], pmf};
              return {};</div></div>
       }</div></div>
}</div><p>


</p>
<p>A few values will be handy in the following traversal of the BVH.  Among
them are the uniform sample <tt>u</tt>, which is remapped to a new uniform
random sample in <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.91ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 2114.2 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">left-bracket 0 comma 1 right-parenthesis</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-5B" d="M256 -230c0 -11 -9 -20 -20 -20h-122v1000h122c11 0 20 -9 20 -20s-9 -20 -20 -20h-82v-920h82c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-30" d="M460 320c0 -79 -5 -157 -37 -226c-44 -95 -120 -116 -174 -116c-49 0 -122 20 -165 101c-41 76 -45 166 -45 241c0 80 5 158 37 227c41 93 114 119 174 119c42 0 124 -16 170 -112c35 -74 40 -154 40 -234zM377 332c0 63 0 139 -10 195c-19 99 -85 117 -118 117 c-25 0 -100 -9 -119 -128c-8 -54 -8 -120 -8 -184c0 -59 0 -151 11 -211c18 -96 77 -121 116 -121c45 0 102 30 117 125c11 64 11 132 11 207Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-5B" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-30" x="278" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="779" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-31" x="1224" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="1724" y="0"></use>
</g>
</svg>.  <tt>pmf</tt> starts out with the probability of
sampling the BVH in the first place; each time a child node of the tree is
randomly sampled, it will be multiplied by the discrete probability of that
sampling choice so that in the end it stores the complete probability for
sampling the light.

</p>
<p></p>
<span class="anchor" id="fragment-DeclarecommonvariablesforlightBVHtraversal-0"></span><div class="fragmentname">&lt;&lt;Declare common variables for light BVH traversal&gt;&gt;=&nbsp;</div>
<div class="fragmentcode"><a href="../Geometry_and_Transformations/Points.html#Point3f" class="code">Point3f</a> <a href="../Light_Sources/Light_Interface.html#LightSampleContext::p" class="code">p</a> = ctx.<a href="../Light_Sources/Light_Interface.html#LightSampleContext::p" class="code">p</a>();
<a href="../Geometry_and_Transformations/Normals.html#Normal3f" class="code">Normal3f</a> n = ctx.<a href="../Light_Sources/Light_Interface.html#LightSampleContext::ns" class="code">ns</a>;
u = std::min&lt;Float&gt;((u - pInfinite) / (1 - pInfinite), <a href="../Sampling_and_Reconstruction/Sampling_Interface.html#OneMinusEpsilon" class="code">OneMinusEpsilon</a>);
int nodeIndex = 0;
Float pmf = 1 - pInfinite;</div><p>


</p>
<p>At each interior node, a child node is randomly sampled.  Given a leaf
node, we have reached the sampled light.

</p>
<p></p>
<span class="anchor" id="fragment-ProcesslightBVHnodeforlightsampling-0"></span><div class="fragmentname">&lt;&lt;Process light BVH node for light sampling&gt;&gt;=&nbsp;</div>
<div class="fragmentcode"><a href="#LightBVHNode" class="code">LightBVHNode</a> node = <a href="#BVHLightSampler::nodes" class="code">nodes</a>[nodeIndex];
if (!node.<a href="#LightBVHNode::isLeaf" class="code">isLeaf</a>) {
    &lt;&lt;<span class="fragmentname"><a href="#fragment-ComputelightBVHchildnodeimportances-0">Compute light BVH child node importances</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1800" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1800"><i></i></a><div id="fragbit-1800" class="collapse show"><div class="fragmentcode">       const <a href="#LightBVHNode" class="code">LightBVHNode</a> *children[2] = {&amp;nodes[nodeIndex + 1],
                                          &amp;nodes[node.<a href="#LightBVHNode::childOrLightIndex" class="code">childOrLightIndex</a>] };
       Float ci[2] = { children[0]-&gt;<a href="#LightBVHNode::lightBounds" class="code">lightBounds</a>.<a href="#CompactLightBounds::Importance" class="code">Importance</a>(p, n, <a href="#BVHLightSampler::allLightBounds" class="code">allLightBounds</a>),
                       children[1]-&gt;<a href="#LightBVHNode::lightBounds" class="code">lightBounds</a>.<a href="#CompactLightBounds::Importance" class="code">Importance</a>(p, n, <a href="#BVHLightSampler::allLightBounds" class="code">allLightBounds</a>)};
       if (ci[0] == 0 &amp;&amp; ci[1] == 0)
           return {};</div></div>
    &lt;&lt;<span class="fragmentname"><a href="#fragment-RandomlysamplelightBVHchildnode-0">Randomly sample light BVH child node</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1801" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1801"><i></i></a><div id="fragbit-1801" class="collapse show"><div class="fragmentcode">       Float nodePMF;
       int child = <a href="../Monte_Carlo_Integration/Sampling_Using_the_Inversion_Method.html#SampleDiscrete" class="code">SampleDiscrete</a>(ci, u, &amp;nodePMF, &amp;u);
       pmf *= nodePMF;
       nodeIndex = (child == 0) ? (nodeIndex + 1) : node.<a href="#LightBVHNode::childOrLightIndex" class="code">childOrLightIndex</a>;</div></div>
} else {
    &lt;&lt;<span class="fragmentname"><a href="#fragment-Confirmlighthasnonzeroimportancebeforereturninglightsample-0">Confirm light has nonzero importance before returning light sample</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1802" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1802"><i></i></a><div id="fragbit-1802" class="collapse show"><div class="fragmentcode">       if (nodeIndex &gt; 0 ||
           node.<a href="#LightBVHNode::lightBounds" class="code">lightBounds</a>.<a href="#CompactLightBounds::Importance" class="code">Importance</a>(p, n, <a href="#BVHLightSampler::allLightBounds" class="code">allLightBounds</a>) &gt; 0)
           return <a href="#SampledLight" class="code">SampledLight</a>{<a href="#BVHLightSampler::lights" class="code">lights</a>[node.<a href="#LightBVHNode::childOrLightIndex" class="code">childOrLightIndex</a>], pmf};
       return {};</div></div>
}</div><p>


</p>
<p>The first step at an interior node is to compute the importance values for
the two child nodes.  It may be the case that both of them are&nbsp;0,
indicating that neither child illuminates the reference point.  That we may
end up in this situation may be surprising: in that case, why would we have
chosen to visit this node in the first place?  This state of affairs is a
natural consequence of the accuracy of light bounds improving on the way
down the tree, which makes it possible for them to better differentiate
regions that their respective subtrees do and do not illuminate.

</p>
<p></p>
<span class="anchor" id="fragment-ComputelightBVHchildnodeimportances-0"></span><div class="fragmentname">&lt;&lt;Compute light BVH child node importances&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">const <a href="#LightBVHNode" class="code">LightBVHNode</a> *children[2] = {&amp;nodes[nodeIndex + 1],
                                   &amp;nodes[node.<a href="#LightBVHNode::childOrLightIndex" class="code">childOrLightIndex</a>] };
Float ci[2] = { children[0]-&gt;<a href="#LightBVHNode::lightBounds" class="code">lightBounds</a>.<a href="#CompactLightBounds::Importance" class="code">Importance</a>(p, n, <a href="#BVHLightSampler::allLightBounds" class="code">allLightBounds</a>),
                children[1]-&gt;<a href="#LightBVHNode::lightBounds" class="code">lightBounds</a>.<a href="#CompactLightBounds::Importance" class="code">Importance</a>(p, n, <a href="#BVHLightSampler::allLightBounds" class="code">allLightBounds</a>)};
if (ci[0] == 0 &amp;&amp; ci[1] == 0)
    return {};</div><p>


</p>
<p>Given at least one nonzero importance value, <a href="../Monte_Carlo_Integration/Sampling_Using_the_Inversion_Method.html#SampleDiscrete"><tt>SampleDiscrete()</tt></a> takes care
of choosing a child node.  The sampling PMF it returns is
incorporated into the running <tt>pmf</tt> product.  We further use its
capability for remapping the sample <tt>u</tt> to a new uniform sample in <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.91ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 2114.2 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">left-bracket 0 comma 1 right-parenthesis</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-5B" d="M256 -230c0 -11 -9 -20 -20 -20h-122v1000h122c11 0 20 -9 20 -20s-9 -20 -20 -20h-82v-920h82c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-30" d="M460 320c0 -79 -5 -157 -37 -226c-44 -95 -120 -116 -174 -116c-49 0 -122 20 -165 101c-41 76 -45 166 -45 241c0 80 5 158 37 227c41 93 114 119 174 119c42 0 124 -16 170 -112c35 -74 40 -154 40 -234zM377 332c0 63 0 139 -10 195c-19 99 -85 117 -118 117 c-25 0 -100 -9 -119 -128c-8 -54 -8 -120 -8 -184c0 -59 0 -151 11 -211c18 -96 77 -121 116 -121c45 0 102 30 117 125c11 64 11 132 11 207Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-5B" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-30" x="278" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="779" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-31" x="1224" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="1724" y="0"></use>
</g>
</svg>,
which allows the reuse of the <tt>u</tt> variable in subsequent loop
iterations.

</p>
<p></p>
<span class="anchor" id="fragment-RandomlysamplelightBVHchildnode-0"></span><div class="fragmentname">&lt;&lt;Randomly sample light BVH child node&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">Float nodePMF;
int child = <a href="../Monte_Carlo_Integration/Sampling_Using_the_Inversion_Method.html#SampleDiscrete" class="code">SampleDiscrete</a>(ci, u, &amp;nodePMF, &amp;u);
pmf *= nodePMF;
nodeIndex = (child == 0) ? (nodeIndex + 1) : node.<a href="#LightBVHNode::childOrLightIndex" class="code">childOrLightIndex</a>;</div><p>


</p>
<p>When a leaf node is reached, we have found a light.  The light should only
be returned if it has a nonzero importance value,
however: if the importance is zero, then it is better to return no light
than to return one and cause the caller to go through some additional work
to sample it before finding that it has no contribution.  Most of
the time, we have already determined that the node&rsquo;s light
bounds have a nonzero importance value by dint of sampling the node while
traversing the BVH in the
first place.  It is thus only in the case of a single-node BVH with a
single light stored in it that this test must be performed here.

</p>
<p></p>
<span class="anchor" id="fragment-Confirmlighthasnonzeroimportancebeforereturninglightsample-0"></span><div class="fragmentname">&lt;&lt;Confirm light has nonzero importance before returning light sample&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">if (nodeIndex &gt; 0 ||
    node.<a href="#LightBVHNode::lightBounds" class="code">lightBounds</a>.<a href="#CompactLightBounds::Importance" class="code">Importance</a>(p, n, <a href="#BVHLightSampler::allLightBounds" class="code">allLightBounds</a>) &gt; 0)
    return <a href="#SampledLight" class="code">SampledLight</a>{<a href="#BVHLightSampler::lights" class="code">lights</a>[node.<a href="#LightBVHNode::childOrLightIndex" class="code">childOrLightIndex</a>], pmf};
return {};</div><p>


</p>
<p>Computing the PMF for sampling a specified light follows a set of
computations similar to those of the sampling method: if the light is an infinite light, the
infinite light sampling probability is returned and otherwise the BVH is
traversed to compute the light&rsquo;s sampling probability.  In this case, BVH
traversal is not stochastic, but is specified by the bit trail for the
given light, which encodes the path to the leaf node that stores it.

</p>
<p></p>
<span class="anchor" id="fragment-BVHLightSamplerPublicMethods-1"></span><div class="fragmentname">&lt;&lt;BVHLightSampler Public Methods&gt;&gt;+=&nbsp;<a href="#fragment-BVHLightSamplerPublicMethods-0"><span class="fa fa-caret-up"></span></a></div>
<div class="fragmentcode">Float <span class="anchor" id="BVHLightSampler::PMF"></span>PMF(const <a href="../Light_Sources/Light_Interface.html#LightSampleContext" class="code">LightSampleContext</a> &amp;ctx, <a href="../Light_Sources/Light_Interface.html#Light" class="code">Light</a> light) const {
    &lt;&lt;<span class="fragmentname"><a href="#fragment-HandleinfinitemonolightPMFcomputation-0">Handle infinite <tt>light</tt> PMF computation</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1803" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1803"><i></i></a><div id="fragbit-1803" class="collapse show"><div class="fragmentcode">       if (!<a href="#BVHLightSampler::lightToBitTrail" class="code">lightToBitTrail</a>.<a href="../Utilities/Containers_and_Memory_Management.html#HashMap::HasKey" class="code">HasKey</a>(light))
           return 1.f / (<a href="#BVHLightSampler::infiniteLights" class="code">infiniteLights</a>.size() + (<a href="#BVHLightSampler::nodes" class="code">nodes</a>.empty() ? 0 : 1));</div></div>
    &lt;&lt;<span class="fragmentname"><a href="#fragment-InitializelocalvariablesforBVHtraversalforPMFcomputation-0">Initialize local variables for BVH traversal for PMF computation</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1804" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1804"><i></i></a><div id="fragbit-1804" class="collapse show"><div class="fragmentcode">       uint32_t bitTrail = <a href="#BVHLightSampler::lightToBitTrail" class="code">lightToBitTrail</a>[light];
       <a href="../Geometry_and_Transformations/Points.html#Point3f" class="code">Point3f</a> <a href="../Light_Sources/Light_Interface.html#LightSampleContext::p" class="code">p</a> = ctx.<a href="../Light_Sources/Light_Interface.html#LightSampleContext::p" class="code">p</a>();
       <a href="../Geometry_and_Transformations/Normals.html#Normal3f" class="code">Normal3f</a> n = ctx.<a href="../Light_Sources/Light_Interface.html#LightSampleContext::ns" class="code">ns</a>;
       &lt;&lt;<span class="fragmentname"><a href="#fragment-ComputeinfinitelightsamplingprobabilitymonopInfinite-0">Compute infinite light sampling probability <tt>pInfinite</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1805" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1805"><i></i></a><div id="fragbit-1805" class="collapse show"><div class="fragmentcode">          Float pInfinite = Float(<a href="#BVHLightSampler::infiniteLights" class="code">infiniteLights</a>.size()) /
              Float(<a href="#BVHLightSampler::infiniteLights" class="code">infiniteLights</a>.size() + (<a href="#BVHLightSampler::nodes" class="code">nodes</a>.empty() ? 0 : 1));</div></div>
       Float pmf = 1 - pInfinite;
       int nodeIndex = 0;</div></div>
    &lt;&lt;<span class="fragmentname"><a href="#fragment-ComputelightsPMFbywalkingdowntreenodestothelight-0">Compute light&rsquo;s PMF by walking down tree nodes to the light</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1806" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1806"><i></i></a><div id="fragbit-1806" class="collapse show"><div class="fragmentcode">       while (true) {
           const <a href="#LightBVHNode" class="code">LightBVHNode</a> *node = &amp;<a href="#BVHLightSampler::nodes" class="code">nodes</a>[nodeIndex];
           if (node-&gt;isLeaf)
               return pmf;
           &lt;&lt;<span class="fragmentname"><a href="#fragment-ComputechildimportancesandupdatePMFforcurrentnode-0">Compute child importances and update PMF for current node</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1807" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1807"><i></i></a><div id="fragbit-1807" class="collapse show"><div class="fragmentcode">              const <a href="#LightBVHNode" class="code">LightBVHNode</a> *child0 = &amp;<a href="#BVHLightSampler::nodes" class="code">nodes</a>[nodeIndex + 1];
              const <a href="#LightBVHNode" class="code">LightBVHNode</a> *child1 = &amp;<a href="#BVHLightSampler::nodes" class="code">nodes</a>[node-&gt;<a href="#LightBVHNode::childOrLightIndex" class="code">childOrLightIndex</a>];
              Float ci[2] = { child0-&gt;<a href="#LightBVHNode::lightBounds" class="code">lightBounds</a>.<a href="#CompactLightBounds::Importance" class="code">Importance</a>(p, n, allLightBounds),
                              child1-&gt;<a href="#LightBVHNode::lightBounds" class="code">lightBounds</a>.<a href="#CompactLightBounds::Importance" class="code">Importance</a>(p, n, allLightBounds) };
              pmf *= ci[bitTrail &amp; 1] / (ci[0] + ci[1]);</div></div>
           &lt;&lt;<span class="fragmentname"><a href="#fragment-UsemonobitTrailtofindnextnodeindexandupdateitsvalue-0">Use <tt>bitTrail</tt> to find next node index and update its value</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1808" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1808"><i></i></a><div id="fragbit-1808" class="collapse show"><div class="fragmentcode">              nodeIndex = (bitTrail &amp; 1) ? node-&gt;<a href="#LightBVHNode::childOrLightIndex" class="code">childOrLightIndex</a> : (nodeIndex + 1);
              bitTrail &gt;&gt;= 1;</div></div> 
       }</div></div>
}</div><p>


</p>
<p>If the given light is not in the bit trail hash table, then it is not
stored in the BVH and therefore must be an infinite light.  The probability
of sampling it is one over the total number of infinite lights plus one if
there is a light BVH.

</p>
<p></p>
<span class="anchor" id="fragment-HandleinfinitemonolightPMFcomputation-0"></span><div class="fragmentname">&lt;&lt;Handle infinite <tt>light</tt> PMF computation&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">if (!<a href="#BVHLightSampler::lightToBitTrail" class="code">lightToBitTrail</a>.<a href="../Utilities/Containers_and_Memory_Management.html#HashMap::HasKey" class="code">HasKey</a>(light))
    return 1.f / (<a href="#BVHLightSampler::infiniteLights" class="code">infiniteLights</a>.size() + (<a href="#BVHLightSampler::nodes" class="code">nodes</a>.empty() ? 0 : 1));</div><p>


</p>
<p>A number of values will be useful as the tree is traversed, including the
bit trail that points the way to the correct leaf, the PMF of the path
taken so far, and the index of the current node being visited, starting
here at the root.

</p>
<p></p>
<span class="anchor" id="fragment-InitializelocalvariablesforBVHtraversalforPMFcomputation-0"></span><div class="fragmentname">&lt;&lt;Initialize local variables for BVH traversal for PMF computation&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">uint32_t bitTrail = <a href="#BVHLightSampler::lightToBitTrail" class="code">lightToBitTrail</a>[light];
<a href="../Geometry_and_Transformations/Points.html#Point3f" class="code">Point3f</a> <a href="../Light_Sources/Light_Interface.html#LightSampleContext::p" class="code">p</a> = ctx.<a href="../Light_Sources/Light_Interface.html#LightSampleContext::p" class="code">p</a>();
<a href="../Geometry_and_Transformations/Normals.html#Normal3f" class="code">Normal3f</a> n = ctx.<a href="../Light_Sources/Light_Interface.html#LightSampleContext::ns" class="code">ns</a>;
&lt;&lt;<span class="fragmentname"><a href="#fragment-ComputeinfinitelightsamplingprobabilitymonopInfinite-0">Compute infinite light sampling probability <tt>pInfinite</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1809" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1809"><i></i></a><div id="fragbit-1809" class="collapse show"><div class="fragmentcode">   Float pInfinite = Float(<a href="#BVHLightSampler::infiniteLights" class="code">infiniteLights</a>.size()) /
       Float(<a href="#BVHLightSampler::infiniteLights" class="code">infiniteLights</a>.size() + (<a href="#BVHLightSampler::nodes" class="code">nodes</a>.empty() ? 0 : 1));</div></div>
Float pmf = 1 - pInfinite;
int nodeIndex = 0;</div><p>


</p>
<p>For a light that is stored in the BVH, the probability of sampling it is
again computed as the product of each discrete probability of sampling the
child node that leads to its leaf node. 

</p>
<p></p>
<span class="anchor" id="fragment-ComputelightsPMFbywalkingdowntreenodestothelight-0"></span><div class="fragmentname">&lt;&lt;Compute light&rsquo;s PMF by walking down tree nodes to the light&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">while (true) {
    const <a href="#LightBVHNode" class="code">LightBVHNode</a> *node = &amp;<a href="#BVHLightSampler::nodes" class="code">nodes</a>[nodeIndex];
    if (node-&gt;isLeaf)
        return pmf;
    &lt;&lt;<span class="fragmentname"><a href="#fragment-ComputechildimportancesandupdatePMFforcurrentnode-0">Compute child importances and update PMF for current node</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1810" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1810"><i></i></a><div id="fragbit-1810" class="collapse show"><div class="fragmentcode">       const <a href="#LightBVHNode" class="code">LightBVHNode</a> *child0 = &amp;<a href="#BVHLightSampler::nodes" class="code">nodes</a>[nodeIndex + 1];
       const <a href="#LightBVHNode" class="code">LightBVHNode</a> *child1 = &amp;<a href="#BVHLightSampler::nodes" class="code">nodes</a>[node-&gt;<a href="#LightBVHNode::childOrLightIndex" class="code">childOrLightIndex</a>];
       Float ci[2] = { child0-&gt;<a href="#LightBVHNode::lightBounds" class="code">lightBounds</a>.<a href="#CompactLightBounds::Importance" class="code">Importance</a>(p, n, allLightBounds),
                       child1-&gt;<a href="#LightBVHNode::lightBounds" class="code">lightBounds</a>.<a href="#CompactLightBounds::Importance" class="code">Importance</a>(p, n, allLightBounds) };
       pmf *= ci[bitTrail &amp; 1] / (ci[0] + ci[1]);</div></div>
    &lt;&lt;<span class="fragmentname"><a href="#fragment-UsemonobitTrailtofindnextnodeindexandupdateitsvalue-0">Use <tt>bitTrail</tt> to find next node index and update its value</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1811" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1811"><i></i></a><div id="fragbit-1811" class="collapse show"><div class="fragmentcode">       nodeIndex = (bitTrail &amp; 1) ? node-&gt;<a href="#LightBVHNode::childOrLightIndex" class="code">childOrLightIndex</a> : (nodeIndex + 1);
       bitTrail &gt;&gt;= 1;</div></div> 
}</div><p>


</p>
<p>The lowest bit of <tt>bitTrail</tt> encodes which of the two children of the
node is visited on a path down to the light&rsquo;s leaf node.  In turn,
it is possible to compute the probability of sampling that node given
the two child nodes&rsquo; importance values.

</p>
<p></p>
<span class="anchor" id="fragment-ComputechildimportancesandupdatePMFforcurrentnode-0"></span><div class="fragmentname">&lt;&lt;Compute child importances and update PMF for current node&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">const <a href="#LightBVHNode" class="code">LightBVHNode</a> *child0 = &amp;<a href="#BVHLightSampler::nodes" class="code">nodes</a>[nodeIndex + 1];
const <a href="#LightBVHNode" class="code">LightBVHNode</a> *child1 = &amp;<a href="#BVHLightSampler::nodes" class="code">nodes</a>[node-&gt;<a href="#LightBVHNode::childOrLightIndex" class="code">childOrLightIndex</a>];
Float ci[2] = { child0-&gt;<a href="#LightBVHNode::lightBounds" class="code">lightBounds</a>.<a href="#CompactLightBounds::Importance" class="code">Importance</a>(p, n, allLightBounds),
                child1-&gt;<a href="#LightBVHNode::lightBounds" class="code">lightBounds</a>.<a href="#CompactLightBounds::Importance" class="code">Importance</a>(p, n, allLightBounds) };
pmf *= ci[bitTrail &amp; 1] / (ci[0] + ci[1]);</div><p>


</p>
<p>The low-order bit of <tt>bitTrail</tt> also points us to which node to visit
next on the way down the tree.  After <tt>nodeIndex</tt> is updated, 
<tt>bitTrail</tt> is shifted right by one bit so that the low-order bit encodes the
choice to make at the next level of the tree. 

</p>
<p></p>
<span class="anchor" id="fragment-UsemonobitTrailtofindnextnodeindexandupdateitsvalue-0"></span><div class="fragmentname">&lt;&lt;Use <tt>bitTrail</tt> to find next node index and update its value&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">nodeIndex = (bitTrail &amp; 1) ? node-&gt;<a href="#LightBVHNode::childOrLightIndex" class="code">childOrLightIndex</a> : (nodeIndex + 1);
bitTrail &gt;&gt;= 1;</div><p>


</p>
<p>The basic <tt>Sample()</tt> and <tt>PMF()</tt> methods for when a reference
point is not specified sample all the lights uniformly and so are not
included here, as they parallel the implementations in the
<a href="#UniformLightSampler"><tt>UniformLightSampler</tt></a>.

</p>
<p>

</p>
<p>

</p>
<p>

</p>
<p>

</p>
<p>

</p>
<p></p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

</div>  <!-- container-fluid -->
</div>  <!-- maincontainer -->

<nav class="navbar navbar-expand-md bg-light navbar-light">
<div class="container-fluid">
  <span class="navbar-text"><i>Physically Based Rendering: From Theory To Implementation</i>,<br>
<a href="https://creativecommons.org/licenses/by-nc-nd/4.0/">&copy; 2004-2023</a> Matt Pharr, Wenzel Jakob, and Greg Humphreys.
<a href="https://github.com/mmp/pbr-book-website/"><span class="fab fa-github"></span></a><br>
Purchase a printed copy: <a href="https://www.amazon.com/Physically-Based-Rendering-fourth-Implementation/dp/0262048027?keywords=physically+based+rendering+4th+edition&qid=1671730412&sprefix=physically+based%!C(MISSING)aps%!C(MISSING)145&sr=8-1&linkCode=ll1&tag=pharr-20&linkId=81a816d90f0c7e872617f1f930a51fd6&language=en_US&ref_=as_li_ss_tl"><span class="fab fa-amazon"></span></a>
<a href="https://mitpress.mit.edu/9780262048026/physically-based-rendering/"><img src="/mitpress.png" width=10 height=16></a>
</span>
</div>
  <div class="container">
    <ul class="nav navbar-nav ml-auto">
      <li class="nav-item">Next: <a href="../Light_Sources/Further_Reading.html">Light Sources / Further Reading</a></li>
    </ul>
  </div>

</nav>

<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
<script>
  $(function () {
    $('[data-toggle="popover"]').popover()
    $('[data-toggle="tooltip"]').tooltip()
   })
</script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>

<script>
// https://stackoverflow.com/a/17535094
// The function actually applying the offset
function offsetAnchor() {
  if (location.hash.length !== 0) {
    window.scrollTo(window.scrollX, window.scrollY - window.innerHeight / 8);
  }
}

// Captures click events of all <a> elements with href starting with #
$(document).on('click', 'a[href^="#"]', function(event) {
  // Click events are captured before hashchanges. Timeout
  // causes offsetAnchor to be called after the page jump.
  window.setTimeout(function() {
    offsetAnchor();
  }, 500);
});

// Set the offset when entering page with hash present in the url
window.setTimeout(offsetAnchor, 1500);
</script>

</body>
</html>
