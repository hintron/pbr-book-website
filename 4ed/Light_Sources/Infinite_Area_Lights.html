
<!doctype html>
<html lang="en">
<head>

<!-- all praise to https://realfavicongenerator.net -->
<link rel="icon" href="/favicon.ico?v=2" /> <!-- force refresh -->
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">

  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="/fonts.css">
  <link rel="stylesheet" href="../pbrstyle.css">
  <link rel="stylesheet" href="/fontawesome-free-5.15.3-web/css/all.css">

<script async src="https://cse.google.com/cse.js?cx=22a43cef261a245ea"></script>  <script src="/react.min.js"></script>
  <script src="/react-dom.min.js"></script>
  <script src="/jeri.min.js"></script>
  <link rel="preload" href="/exr.worker.js" as="script" crossorigin="anonymous">
  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="/bootstrap.min.css">

  <title>Infinite Area Lights</title>
</head>
        
<body>

<nav class="fixed-top-lg-navbar navbar navbar-expand bg-light navbar-light">
  <ul class="nav navbar-nav">
    <a class="navbar-brand" href="../contents.html"><img src="../pbr.jpg" width=25 height=25></a>
    <li class="nav-item"><a class="nav-link" href="../Light_Sources.html">Light Sources</a></li>
    <span class="navbar-text">/</span>
    <li class="nav-item"><a class="nav-link" href="#">Infinite Area Lights</a></li>
    <span class="navbar-text">&nbsp;&nbsp;</span>
    <li class="nav-item"><a class="nav-link" href="../Light_Sources/Area_Lights.html">(Previous: Area Lights)</a></li>
  </ul>

  <ul class="nav navbar-nav ml-auto d-none d-md-block">
        <li class="nav-item"><div class="gcse-search"></div></li>
    </ul>
  <ul class="nav navbar-nav d-block d-md-none">
        <li class="nav-item"><div class="gcse-search"></div></li>
    </ul>
</nav>

<div class="maincontainer">
<div class="container-fluid">

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">
<a href="#"><i class="fas fa-link "></i></a>
</div>
<div class="col-md-10 col-lg-8">
<span class="anchor" id="sec:infinite-area-lights"></span><h2>12.5 Infinite Area Lights</h2><p>



</p>
<p>Another useful kind of light is an infinitely far-away area
light source that surrounds the entire scene. One way to
visualize this type of light is as an enormous sphere that casts light into the
scene from every direction.  One important use of infinite area lights is
for <em>environment lighting</em>, where an image of the 
illumination in an environment is used to illuminate synthetic objects as
if they were in that environment.  Figure&nbsp;<a href="#fig:tt-area-vs-morning">12.16</a>
compares illuminating a car model with standard area lights to
illuminating it with two environment maps that simulate illumination from
the sky at different times of day. The increase in realism is
striking.

</p>
<p>

</p>
<p></p>
<span class="anchor" id="fig:tt-area-vs-morning"></span><div class="card outerfigure"><div class="card-body figure"><p>


</p>

<div class="card-img-top" style="display:block; width: 100%; padding-top: 34.062%;  position:relative;"><div id="xa_Area_lights47" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0;"></div></div>
<script>
Jeri.renderViewer(document.getElementById('xa_Area_lights47'), {
  title: '(a)_Area_lights47', children: [
 { title: '(a) Area lights', image: 'sportscar-light-comparisons-area.png' },  { title: '(b) Midday skylight', image: 'sportscar-light-comparisons-env-sunflowers.png' },  { title: '(c) Sunset', image: 'sportscar-light-comparisons-env-fire.png' }]});
</script>
<figcaption class="caption">Figure 12.16: <span class="legend"> Car model (a)&nbsp;illuminated with a few area
lights, (b)&nbsp;illuminated with midday skylight
from an environment map, (c)&nbsp;using a sunset environment map.
<em>(Model courtesy of Yasutoshi Mori.)</em></span>
</figcaption>
</div></div><p>


</p>
<p><tt>pbrt</tt> provides three implementations of infinite area lights of
progressive complexity.  The first describes an infinite light with uniform
emitted radiance; the second instead takes an image that represents the
directional distribution of emitted radiance, and the third adds
capabilities for culling parts of such images that are occluded at
the reference point, which can substantially improve sampling efficiency.

</p>
<p>

</p>
<p></p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">
<a href="#UniformInfiniteLights"><i class="fas fa-link h3h4marginlink"></i></a>
</div>
<div class="col-md-10 col-lg-8">
<span id="UniformInfiniteLights"></span><h3>12.5.1  Uniform Infinite Lights</h3><p>


</p>
<p>A uniform infinite light source is fairly easy to implement; some of the
details will be helpful for understanding the infinite light variants to follow.

</p>
<p></p>
<span class="anchor" id="fragment-UniformInfiniteLightDefinition-0"></span><div class="fragmentname">&lt;&lt;UniformInfiniteLight Definition&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">class <span class="anchor" id="UniformInfiniteLight"></span>UniformInfiniteLight : public <a href="../Light_Sources/Light_Interface.html#LightBase" class="code">LightBase</a> {
  public:
    &lt;&lt;<span class="fragmentname">UniformInfiniteLight Public Methods</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1673" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1673"><i></i></a><div id="fragbit-1673" class="collapse show"><div class="fragmentcode">       UniformInfiniteLight(const <a href="../Geometry_and_Transformations/Transformations.html#Transform" class="code">Transform</a> &amp;renderFromLight, <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#Spectrum" class="code">Spectrum</a> Lemit,
                            Float scale);
       
       void Preprocess(const <a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3f" class="code">Bounds3f</a> &amp;sceneBounds) {
           sceneBounds.BoundingSphere(&amp;sceneCenter, &amp;sceneRadius);
       }
       
       <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> Phi(<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledWavelengths" class="code">SampledWavelengths</a> lambda) const;
       
       PBRT_CPU_GPU
       <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> Le(const <a href="../Geometry_and_Transformations/Rays.html#Ray" class="code">Ray</a> &amp;ray, const <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledWavelengths" class="code">SampledWavelengths</a> &amp;lambda) const;
       PBRT_CPU_GPU
       pstd::optional&lt;<a href="../Light_Sources/Light_Interface.html#LightLiSample" class="code">LightLiSample</a>&gt; SampleLi(<a href="../Light_Sources/Light_Interface.html#LightSampleContext" class="code">LightSampleContext</a> ctx, <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a> u,
                              <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledWavelengths" class="code">SampledWavelengths</a> lambda, bool allowIncompletePDF) const;
       PBRT_CPU_GPU
       Float PDF_Li(<a href="../Light_Sources/Light_Interface.html#LightSampleContext" class="code">LightSampleContext</a>, <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a>, bool allowIncompletePDF) const;
       
       PBRT_CPU_GPU
       pstd::optional&lt;LightLeSample&gt; SampleLe(<a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a> u1, <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a> u2,
                                              <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledWavelengths" class="code">SampledWavelengths</a> &amp;lambda,
                                              Float time) const;
       PBRT_CPU_GPU
       void PDF_Le(const <a href="../Geometry_and_Transformations/Rays.html#Ray" class="code">Ray</a> &amp;, Float *pdfPos, Float *pdfDir) const;
       
       PBRT_CPU_GPU
       void PDF_Le(const <a href="../Geometry_and_Transformations/Interactions.html#Interaction" class="code">Interaction</a> &amp;, <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> w, Float *pdfPos, Float *pdfDir) const {
           LOG_FATAL("Shouldn't be called for non-area lights");
       }
       
       pstd::optional&lt;<a href="../Light_Sources/Light_Sampling.html#LightBounds" class="code">LightBounds</a>&gt; Bounds() const { return {}; }
       
       std::string ToString() const;</div></div>
  private:
    &lt;&lt;<span class="fragmentname"><a href="#fragment-UniformInfiniteLightPrivateMembers-0">UniformInfiniteLight Private Members</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1674" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1674"><i></i></a><div id="fragbit-1674" class="collapse show"><div class="fragmentcode">       const <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#DenselySampledSpectrum" class="code">DenselySampledSpectrum</a> *Lemit;
       Float scale;
       <a href="../Geometry_and_Transformations/Points.html#Point3f" class="code">Point3f</a> sceneCenter;
       Float sceneRadius;</div></div>
};</div><p>


</p>
<p>

</p>
<p>Emitted radiance is specified as usual by both a spectrum and a separate
scale. (The straightforward constructor that initializes these is not
included in the text.)

</p>
<p></p>
<span class="anchor" id="fragment-UniformInfiniteLightPrivateMembers-0"></span><div class="fragmentname">&lt;&lt;UniformInfiniteLight Private Members&gt;&gt;=&nbsp;<a href="#fragment-UniformInfiniteLightPrivateMembers-1"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode">const <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#DenselySampledSpectrum" class="code">DenselySampledSpectrum</a> *<span class="anchor" id="UniformInfiniteLight::Lemit"></span>Lemit;
Float <span class="anchor" id="UniformInfiniteLight::scale"></span>scale;</div><p>


</p>
<p>All the infinite light sources, including <a href="#UniformInfiniteLight"><tt>UniformInfiniteLight</tt></a>,
store a bounding sphere of the scene that they use when computing their total
power and for sampling rays leaving the light.

</p>
<p></p>
<span class="anchor" id="fragment-UniformInfiniteLightPrivateMembers-1"></span><div class="fragmentname">&lt;&lt;UniformInfiniteLight Private Members&gt;&gt;+=&nbsp;<a href="#fragment-UniformInfiniteLightPrivateMembers-0"><span class="fa fa-caret-up"></span></a></div>
<div class="fragmentcode"><a href="../Geometry_and_Transformations/Points.html#Point3f" class="code">Point3f</a> <span class="anchor" id="UniformInfiniteLight::sceneCenter"></span>sceneCenter;
Float <span class="anchor" id="UniformInfiniteLight::sceneRadius"></span>sceneRadius;</div><p>


</p>
<p>Infinite lights must implement the following <tt>Le()</tt> method to return
their emitted radiance for a given ray.  Since the
<a href="#UniformInfiniteLight"><tt>UniformInfiniteLight</tt></a> emits the same amount for all rays, the
implementation is trivial.

</p>
<p></p>
<span class="anchor" id="fragment-UniformInfiniteLightMethodDefinitions-0"></span><div class="fragmentname">&lt;&lt;UniformInfiniteLight Method Definitions&gt;&gt;=&nbsp;<a href="#fragment-UniformInfiniteLightMethodDefinitions-1"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode"><a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a>
<span class="anchor" id="UniformInfiniteLight::Le"></span>UniformInfiniteLight::Le(const <a href="../Geometry_and_Transformations/Rays.html#Ray" class="code">Ray</a> &amp;ray,
                         const <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledWavelengths" class="code">SampledWavelengths</a> &amp;lambda) const {
    return <a href="#UniformInfiniteLight::scale" class="code">scale</a> * <a href="#UniformInfiniteLight::Lemit" class="code">Lemit</a>-&gt;<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#DenselySampledSpectrum::Sample" class="code">Sample</a>(lambda);
}</div><p>


</p>
<p>We can see the use of the <tt>allowIncompletePDF</tt> parameter for the first
time in the <tt>SampleLi()</tt> method.  If it is <tt>true</tt>, then
<a href="#UniformInfiniteLight"><tt>UniformInfiniteLight</tt></a> immediately returns an unset sample.  (And its
<tt>PDF_Li()</tt> method, described a bit later, will return a PDF of zero for all
directions.)  To understand why it is implemented in this way,
consider the direct lighting integral
</p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">
<div class="displaymath"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="35.615ex" height="5.676ex" style="vertical-align: -2.338ex;" viewBox="0 -1437.2 15334.1 2443.8" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">integral Underscript script upper S squared Endscripts f Subscript Baseline left-parenthesis normal p Subscript Baseline comma omega Subscript normal o Baseline comma omega Subscript normal i Baseline right-parenthesis upper L Subscript normal i Baseline left-parenthesis normal p Subscript Baseline comma omega Subscript normal i Baseline right-parenthesis StartAbsoluteValue cosine theta Subscript normal i Baseline EndAbsoluteValue normal d omega Subscript normal i Baseline period</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNSIZE1-222B" d="M943 1268c0 -35 -25 -50 -49 -50c-23 0 -48 16 -48 49c0 25 17 47 50 49c-4 4 -29 23 -60 23c-39 0 -73 -129 -85 -178c-34 -129 -71 -329 -108 -542c-54 -321 -119 -640 -196 -956c-71 -290 -128 -524 -280 -524c-61 0 -111 42 -111 93c0 35 25 50 49 50 c23 0 48 -16 48 -49c0 -25 -17 -47 -49 -49c0 0 25 -23 61 -23c81 0 127 188 145 261c33 139 62 306 88 459c110 654 246 1156 249 1167c55 204 111 313 187 313c55 0 109 -39 109 -93Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-53" d="M499 186c0 -110 -80 -208 -197 -208c-89 0 -153 36 -184 70c-33 -53 -36 -57 -36 -57c-7 -11 -8 -13 -15 -13c-11 0 -11 7 -11 24v200c0 18 0 25 13 25c3 0 11 0 12 -10c1 -36 4 -100 62 -154c53 -49 129 -54 158 -54c84 0 134 72 134 143c0 33 -10 66 -31 92 c-28 37 -58 44 -85 51c-70 17 -121 29 -132 33c-78 27 -131 100 -131 183c0 106 84 194 195 194c89 0 130 -41 160 -70l35 57c7 12 8 13 15 13c11 0 11 -7 11 -24v-201c0 -19 0 -24 -13 -24c-11 0 -11 6 -12 12c-6 45 -28 209 -195 209c-78 0 -132 -61 -132 -131 c0 -58 39 -112 101 -127l128 -31c84 -20 150 -102 150 -202Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-32" d="M449 174l-28 -174h-371c0 24 0 26 11 37l192 214c55 62 105 141 105 221c0 82 -43 163 -134 163c-58 0 -112 -37 -135 -102c3 1 5 1 13 1c35 0 53 -26 53 -52c0 -41 -35 -53 -52 -53c-3 0 -53 0 -53 56c0 89 74 181 187 181c122 0 212 -80 212 -194 c0 -100 -60 -154 -216 -292l-106 -103h180c22 0 88 0 95 8c10 15 17 59 22 89h25Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D453" d="M552 636c0 -38 -29 -60 -55 -60c-19 0 -37 12 -37 35c0 15 10 50 54 54c-19 18 -45 18 -49 18c-21 0 -38 -15 -47 -34c-6 -12 -20 -83 -24 -104c-11 -58 -10 -56 -21 -114h83c17 0 27 0 27 -11c0 -20 -10 -20 -30 -20h-86l-60 -317c-1 -7 -24 -128 -56 -191 c-18 -38 -58 -97 -113 -97c-41 0 -85 24 -85 69c0 38 29 60 55 60c19 0 37 -12 37 -35c0 -15 -9 -51 -55 -54c19 -18 44 -18 48 -18c52 0 69 91 87 188l75 395h-66c-19 0 -28 0 -28 12c0 19 11 19 30 19h69c24 126 27 136 33 157c30 99 93 117 127 117c41 0 87 -23 87 -69Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6F" d="M471 214c0 -127 -101 -225 -222 -225c-117 0 -221 96 -221 225c0 125 97 234 222 234c121 0 221 -106 221 -234zM388 222c0 38 0 96 -26 139s-69 65 -113 65c-40 0 -87 -21 -114 -67c-24 -44 -24 -98 -24 -137c0 -36 0 -97 25 -141c27 -46 71 -67 114 -67 c50 0 94 29 116 74c22 44 22 98 22 134Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-69" d="M247 0c-34 1 -69 3 -104 3l-110 -3v31c67 0 78 0 78 45v269c0 49 -9 55 -74 55v31l140 11v-367c0 -39 4 -44 70 -44v-31zM192 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D43F" d="M643 247c0 0 0 -3 -4 -14l-79 -216c-6 -17 -7 -17 -31 -17h-463c-18 0 -27 0 -27 11c0 20 10 20 27 20c79 0 81 8 91 47l134 537c3 12 4 15 4 19c0 13 -9 14 -27 16c-17 2 -38 2 -38 2c-19 0 -28 0 -28 11c0 20 12 20 19 20l133 -3l148 3c5 0 16 0 16 -12 c0 -19 -8 -19 -38 -19c-94 0 -97 -11 -106 -47l-135 -540c-5 -18 -5 -20 -5 -23c0 -8 3 -9 13 -10c6 -1 8 -1 22 -1h94c173 0 217 114 251 206c7 16 8 21 17 21s12 -7 12 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-7C" d="M159 -230c0 -11 -9 -20 -20 -20s-20 9 -20 20v960c0 11 9 20 20 20s20 -9 20 -20v-960Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-63" d="M415 119c0 -10 -32 -130 -166 -130c-116 0 -215 99 -215 227c0 124 92 232 217 232c77 0 153 -39 153 -107c0 -30 -20 -47 -46 -47c-28 0 -46 20 -46 46c0 13 6 43 47 46c-35 36 -98 37 -107 37c-53 0 -135 -42 -135 -205c0 -161 88 -204 141 -204c37 0 102 12 131 105 c2 6 4 10 13 10c3 0 13 0 13 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-73" d="M360 128c0 -72 -46 -139 -161 -139c-21 0 -66 1 -110 43c-18 -19 -18 -21 -20 -23c-19 -19 -20 -20 -25 -20c-11 0 -11 7 -11 24v132c0 18 0 25 13 25c10 0 11 -4 14 -17c19 -85 55 -142 139 -142c78 0 113 40 113 91c0 72 -82 88 -104 92c-72 14 -100 20 -132 46 c-27 22 -43 50 -43 85c0 56 38 123 160 123c15 0 56 0 94 -28c4 3 14 12 17 16c13 12 15 12 20 12c11 0 11 -7 11 -24v-101c0 -19 0 -24 -13 -24c0 0 -11 0 -12 9c-2 31 -7 121 -117 121c-86 0 -112 -41 -112 -76c0 -58 67 -71 123 -82c42 -8 81 -16 114 -48 c12 -12 42 -42 42 -95Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D703" d="M455 500c0 -224 -152 -511 -293 -511c-91 0 -120 111 -120 205c0 229 154 511 293 511c102 0 120 -139 120 -205zM389 562c0 57 -6 121 -55 121c-45 0 -82 -56 -109 -105c-40 -71 -60 -151 -77 -215h209c24 99 32 150 32 199zM348 331h-208c-26 -98 -32 -156 -32 -198 c0 -93 21 -122 54 -122c43 0 81 49 116 117c38 72 59 157 70 203Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-64" d="M527 0l-147 -11v66c-25 -32 -70 -66 -134 -66c-114 0 -212 99 -212 226c0 129 105 227 223 227c54 0 97 -26 126 -62v216c0 49 -8 56 -78 56v31l144 11v-607c0 -49 8 -56 78 -56v-31zM380 118v205c0 18 0 20 -11 37c-31 45 -73 60 -108 60c-54 0 -92 -33 -113 -64 c-29 -45 -31 -105 -31 -142c0 -41 3 -98 29 -139c24 -38 60 -64 105 -64c43 0 88 22 118 70c11 17 11 19 11 37Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2E" d="M192 53c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNSIZE1-222B" x="0" y="0"></use>
<g transform="translate(574,-898)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-53" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNMAIN-32" x="685" y="483"></use>
</g>
<g transform="translate(1592,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D453" x="0" y="0"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="2349" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="2739" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="3295" y="0"></use>
<g transform="translate(3741,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6F" x="880" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="4817" y="0"></use>
<g transform="translate(5262,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="880" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="6182" y="0"></use>
<g transform="translate(6738,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D43F" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="963" y="-213"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="978" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="1367" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="1924" y="0"></use>
<g transform="translate(2369,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="880" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="3289" y="0"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-7C" x="10583" y="0"></use>
<g transform="translate(10861,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-63"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-6F" x="444" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-73" x="945" y="0"></use>
</g>
<g transform="translate(12368,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D703" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="663" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-7C" x="13134" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-64" x="13579" y="0"></use>
<g transform="translate(14136,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="880" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2E" x="15055" y="0"></use>
</g>
</svg>
</div>
<p>

For a uniform infinite light, the incident radiance function is a
constant times the visibility term; the constant can be pulled out of the
integral, leaving 
</p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">
<div class="displaymath"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="28.078ex" height="5.676ex" style="vertical-align: -2.338ex;" viewBox="0 -1437.2 12089.1 2443.8" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">c integral Underscript script upper S squared Endscripts f Subscript Baseline left-parenthesis normal p Subscript Baseline comma omega Subscript normal o Baseline comma omega Subscript normal i Baseline right-parenthesis StartAbsoluteValue cosine theta Subscript normal i Baseline EndAbsoluteValue normal d omega Subscript normal i Baseline period</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D450" d="M430 107c0 -12 -84 -118 -227 -118c-104 0 -162 79 -162 169c0 141 133 284 268 284c71 0 118 -37 118 -86c0 -40 -27 -64 -56 -64c-19 0 -37 11 -37 35c0 7 2 24 18 39c14 14 28 14 44 14c-14 27 -52 40 -86 40c-55 0 -110 -43 -141 -100c-34 -62 -54 -159 -54 -200 c0 -60 27 -109 90 -109c12 0 121 0 200 99c6 8 8 10 13 10c6 0 12 -7 12 -13Z"></path>
<path stroke-width="1" id="E1-LATINMODERNSIZE1-222B" d="M943 1268c0 -35 -25 -50 -49 -50c-23 0 -48 16 -48 49c0 25 17 47 50 49c-4 4 -29 23 -60 23c-39 0 -73 -129 -85 -178c-34 -129 -71 -329 -108 -542c-54 -321 -119 -640 -196 -956c-71 -290 -128 -524 -280 -524c-61 0 -111 42 -111 93c0 35 25 50 49 50 c23 0 48 -16 48 -49c0 -25 -17 -47 -49 -49c0 0 25 -23 61 -23c81 0 127 188 145 261c33 139 62 306 88 459c110 654 246 1156 249 1167c55 204 111 313 187 313c55 0 109 -39 109 -93Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-53" d="M499 186c0 -110 -80 -208 -197 -208c-89 0 -153 36 -184 70c-33 -53 -36 -57 -36 -57c-7 -11 -8 -13 -15 -13c-11 0 -11 7 -11 24v200c0 18 0 25 13 25c3 0 11 0 12 -10c1 -36 4 -100 62 -154c53 -49 129 -54 158 -54c84 0 134 72 134 143c0 33 -10 66 -31 92 c-28 37 -58 44 -85 51c-70 17 -121 29 -132 33c-78 27 -131 100 -131 183c0 106 84 194 195 194c89 0 130 -41 160 -70l35 57c7 12 8 13 15 13c11 0 11 -7 11 -24v-201c0 -19 0 -24 -13 -24c-11 0 -11 6 -12 12c-6 45 -28 209 -195 209c-78 0 -132 -61 -132 -131 c0 -58 39 -112 101 -127l128 -31c84 -20 150 -102 150 -202Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-32" d="M449 174l-28 -174h-371c0 24 0 26 11 37l192 214c55 62 105 141 105 221c0 82 -43 163 -134 163c-58 0 -112 -37 -135 -102c3 1 5 1 13 1c35 0 53 -26 53 -52c0 -41 -35 -53 -52 -53c-3 0 -53 0 -53 56c0 89 74 181 187 181c122 0 212 -80 212 -194 c0 -100 -60 -154 -216 -292l-106 -103h180c22 0 88 0 95 8c10 15 17 59 22 89h25Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D453" d="M552 636c0 -38 -29 -60 -55 -60c-19 0 -37 12 -37 35c0 15 10 50 54 54c-19 18 -45 18 -49 18c-21 0 -38 -15 -47 -34c-6 -12 -20 -83 -24 -104c-11 -58 -10 -56 -21 -114h83c17 0 27 0 27 -11c0 -20 -10 -20 -30 -20h-86l-60 -317c-1 -7 -24 -128 -56 -191 c-18 -38 -58 -97 -113 -97c-41 0 -85 24 -85 69c0 38 29 60 55 60c19 0 37 -12 37 -35c0 -15 -9 -51 -55 -54c19 -18 44 -18 48 -18c52 0 69 91 87 188l75 395h-66c-19 0 -28 0 -28 12c0 19 11 19 30 19h69c24 126 27 136 33 157c30 99 93 117 127 117c41 0 87 -23 87 -69Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-70" d="M521 216c0 -129 -104 -227 -223 -227c-76 0 -118 54 -123 70v-9v-168c0 -45 11 -45 78 -45v-31l-113 3l-112 -3v31c67 0 78 0 78 45v468c0 44 -7 50 -78 50v31l144 11v-66c20 22 62 66 140 66c112 0 209 -99 209 -226zM438 216c0 113 -61 201 -134 201 c-51 0 -100 -29 -129 -80v-223c0 -20 0 -21 14 -42c27 -41 65 -61 105 -61c74 0 144 84 144 205Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6F" d="M471 214c0 -127 -101 -225 -222 -225c-117 0 -221 96 -221 225c0 125 97 234 222 234c121 0 221 -106 221 -234zM388 222c0 38 0 96 -26 139s-69 65 -113 65c-40 0 -87 -21 -114 -67c-24 -44 -24 -98 -24 -137c0 -36 0 -97 25 -141c27 -46 71 -67 114 -67 c50 0 94 29 116 74c22 44 22 98 22 134Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-69" d="M247 0c-34 1 -69 3 -104 3l-110 -3v31c67 0 78 0 78 45v269c0 49 -9 55 -74 55v31l140 11v-367c0 -39 4 -44 70 -44v-31zM192 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-7C" d="M159 -230c0 -11 -9 -20 -20 -20s-20 9 -20 20v960c0 11 9 20 20 20s20 -9 20 -20v-960Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-63" d="M415 119c0 -10 -32 -130 -166 -130c-116 0 -215 99 -215 227c0 124 92 232 217 232c77 0 153 -39 153 -107c0 -30 -20 -47 -46 -47c-28 0 -46 20 -46 46c0 13 6 43 47 46c-35 36 -98 37 -107 37c-53 0 -135 -42 -135 -205c0 -161 88 -204 141 -204c37 0 102 12 131 105 c2 6 4 10 13 10c3 0 13 0 13 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-73" d="M360 128c0 -72 -46 -139 -161 -139c-21 0 -66 1 -110 43c-18 -19 -18 -21 -20 -23c-19 -19 -20 -20 -25 -20c-11 0 -11 7 -11 24v132c0 18 0 25 13 25c10 0 11 -4 14 -17c19 -85 55 -142 139 -142c78 0 113 40 113 91c0 72 -82 88 -104 92c-72 14 -100 20 -132 46 c-27 22 -43 50 -43 85c0 56 38 123 160 123c15 0 56 0 94 -28c4 3 14 12 17 16c13 12 15 12 20 12c11 0 11 -7 11 -24v-101c0 -19 0 -24 -13 -24c0 0 -11 0 -12 9c-2 31 -7 121 -117 121c-86 0 -112 -41 -112 -76c0 -58 67 -71 123 -82c42 -8 81 -16 114 -48 c12 -12 42 -42 42 -95Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D703" d="M455 500c0 -224 -152 -511 -293 -511c-91 0 -120 111 -120 205c0 229 154 511 293 511c102 0 120 -139 120 -205zM389 562c0 57 -6 121 -55 121c-45 0 -82 -56 -109 -105c-40 -71 -60 -151 -77 -215h209c24 99 32 150 32 199zM348 331h-208c-26 -98 -32 -156 -32 -198 c0 -93 21 -122 54 -122c43 0 81 49 116 117c38 72 59 157 70 203Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-64" d="M527 0l-147 -11v66c-25 -32 -70 -66 -134 -66c-114 0 -212 99 -212 226c0 129 105 227 223 227c54 0 97 -26 126 -62v216c0 49 -8 56 -78 56v31l144 11v-607c0 -49 8 -56 78 -56v-31zM380 118v205c0 18 0 20 -11 37c-31 45 -73 60 -108 60c-54 0 -92 -33 -113 -64 c-29 -45 -31 -105 -31 -142c0 -41 3 -98 29 -139c24 -38 60 -64 105 -64c43 0 88 22 118 70c11 17 11 19 11 37Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2E" d="M192 53c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D450" x="0" y="0"></use>
<g transform="translate(600,0)">
 <use xlink:href="#E1-LATINMODERNSIZE1-222B" x="0" y="0"></use>
<g transform="translate(574,-898)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-53" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNMAIN-32" x="685" y="483"></use>
</g>
</g>
<g transform="translate(2192,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D453" x="0" y="0"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="2950" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-70" x="3339" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="3896" y="0"></use>
<g transform="translate(4341,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6F" x="880" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="5417" y="0"></use>
<g transform="translate(5862,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="880" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="6782" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-7C" x="7338" y="0"></use>
<g transform="translate(7616,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-63"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-6F" x="444" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-73" x="945" y="0"></use>
</g>
<g transform="translate(9123,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D703" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="663" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-7C" x="9889" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-64" x="10334" y="0"></use>
<g transform="translate(10891,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="880" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2E" x="11810" y="0"></use>
</g>
</svg>
</div>
<p>

There is no reason for the light to participate in sampling this integral,
since BSDF sampling accounts for the remaining factors well.  Furthermore,
recall from Section&nbsp;<a href="../Monte_Carlo_Integration/Improving_Efficiency.html#sec:multiple-importance-sampling">2.2.3</a> that multiple
importance sampling (MIS) can increase variance when one of the sampling
techniques is much more effective than the others.  This is such a case, so
as long as calling code is sampling the BSDF and using
MIS, samples should not be generated here.  
(This is an application of MIS compensation,
which was introduced in Section&nbsp;<a href="../Monte_Carlo_Integration/Improving_Efficiency.html#sec:multiple-importance-sampling">2.2.3</a>.)

</p>
<p></p>
<span class="anchor" id="fragment-UniformInfiniteLightMethodDefinitions-1"></span><div class="fragmentname">&lt;&lt;UniformInfiniteLight Method Definitions&gt;&gt;+=&nbsp;<a href="#fragment-UniformInfiniteLightMethodDefinitions-0"><span class="fa fa-caret-up"></span></a>&nbsp;<a href="#fragment-UniformInfiniteLightMethodDefinitions-2"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode">pstd::optional&lt;<a href="../Light_Sources/Light_Interface.html#LightLiSample" class="code">LightLiSample</a>&gt;
<span class="anchor" id="UniformInfiniteLight::SampleLi"></span>UniformInfiniteLight::SampleLi(<a href="../Light_Sources/Light_Interface.html#LightSampleContext" class="code">LightSampleContext</a> ctx, <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a> u,
        <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledWavelengths" class="code">SampledWavelengths</a> lambda, bool allowIncompletePDF) const {
    if (allowIncompletePDF) return {};
    &lt;&lt;<span class="fragmentname"><a href="#fragment-Returnuniformsphericalsampleforuniforminfinitelight-0">Return uniform spherical sample for uniform infinite light</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1675" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1675"><i></i></a><div id="fragbit-1675" class="collapse show"><div class="fragmentcode">       <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> wi = <a href="../Sampling_Algorithms/Sampling_Multidimensional_Functions.html#SampleUniformSphere" class="code">SampleUniformSphere</a>(u);
       Float pdf = <a href="../Sampling_Algorithms/Sampling_Multidimensional_Functions.html#UniformSpherePDF" class="code">UniformSpherePDF</a>();
       return <a href="../Light_Sources/Light_Interface.html#LightLiSample" class="code">LightLiSample</a>(<a href="#UniformInfiniteLight::scale" class="code">scale</a> * <a href="#UniformInfiniteLight::Lemit" class="code">Lemit</a>-&gt;<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#DenselySampledSpectrum::Sample" class="code">Sample</a>(lambda), wi, pdf,
           <a href="../Geometry_and_Transformations/Interactions.html#Interaction" class="code">Interaction</a>(ctx.<a href="../Light_Sources/Light_Interface.html#LightSampleContext::p" class="code">p</a>() + wi * (2 * sceneRadius), &amp;<a href="../Light_Sources/Light_Interface.html#LightBase::mediumInterface" class="code">mediumInterface</a>));</div></div>
}</div><p>


</p>
<p>If sampling is to be performed, the light generates a sample so that valid
Monte Carlo estimates can still be computed.  This task is easy&mdash;all
directions are sampled with uniform probability.  Note that the endpoint of
the shadow ray is set in the same way as it was by the <a href="../Light_Sources/Distant_Lights.html#DistantLight"><tt>DistantLight</tt></a>:
by computing a point that is certainly outside of the scene&rsquo;s bounds.

</p>
<p></p>
<span class="anchor" id="fragment-Returnuniformsphericalsampleforuniforminfinitelight-0"></span><div class="fragmentname">&lt;&lt;Return uniform spherical sample for uniform infinite light&gt;&gt;=&nbsp;</div>
<div class="fragmentcode"><a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> wi = <a href="../Sampling_Algorithms/Sampling_Multidimensional_Functions.html#SampleUniformSphere" class="code">SampleUniformSphere</a>(u);
Float pdf = <a href="../Sampling_Algorithms/Sampling_Multidimensional_Functions.html#UniformSpherePDF" class="code">UniformSpherePDF</a>();
return <a href="../Light_Sources/Light_Interface.html#LightLiSample" class="code">LightLiSample</a>(<a href="#UniformInfiniteLight::scale" class="code">scale</a> * <a href="#UniformInfiniteLight::Lemit" class="code">Lemit</a>-&gt;<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#DenselySampledSpectrum::Sample" class="code">Sample</a>(lambda), wi, pdf,
    <a href="../Geometry_and_Transformations/Interactions.html#Interaction" class="code">Interaction</a>(ctx.<a href="../Light_Sources/Light_Interface.html#LightSampleContext::p" class="code">p</a>() + wi * (2 * sceneRadius), &amp;<a href="../Light_Sources/Light_Interface.html#LightBase::mediumInterface" class="code">mediumInterface</a>));</div><p>


</p>
<p>The <tt>PDF_Li()</tt> method must account for the value of
<tt>allowIncompletePDF</tt> so that the PDF values it returns are consistent
with its sampling method.

</p>
<p></p>
<span class="anchor" id="fragment-UniformInfiniteLightMethodDefinitions-2"></span><div class="fragmentname">&lt;&lt;UniformInfiniteLight Method Definitions&gt;&gt;+=&nbsp;<a href="#fragment-UniformInfiniteLightMethodDefinitions-1"><span class="fa fa-caret-up"></span></a>&nbsp;<a href="#fragment-UniformInfiniteLightMethodDefinitions-3"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode">Float <span class="anchor" id="UniformInfiniteLight::PDF_Li"></span>UniformInfiniteLight::PDF_Li(<a href="../Light_Sources/Light_Interface.html#LightSampleContext" class="code">LightSampleContext</a> ctx, <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> w,
                                   bool allowIncompletePDF) const {
    if (allowIncompletePDF) return 0;
    return UniformSpherePDF();
}</div><p>


</p>
<p>The total power from an infinite light can be found by taking the product
of the integral of the incident radiance over all directions times an
integral over the area of the disk, along the lines of
<a href="../Light_Sources/Distant_Lights.html#DistantLight::Phi"><tt>DistantLight::Phi()</tt></a>.

</p>
<p></p>
<span class="anchor" id="fragment-UniformInfiniteLightMethodDefinitions-3"></span><div class="fragmentname">&lt;&lt;UniformInfiniteLight Method Definitions&gt;&gt;+=&nbsp;<a href="#fragment-UniformInfiniteLightMethodDefinitions-2"><span class="fa fa-caret-up"></span></a></div>
<div class="fragmentcode"><a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a>
<span class="anchor" id="UniformInfiniteLight::Phi"></span>UniformInfiniteLight::Phi(<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledWavelengths" class="code">SampledWavelengths</a> lambda) const {
    return 4 * Pi * Pi * Sqr(<a href="#UniformInfiniteLight::sceneRadius" class="code">sceneRadius</a>) * <a href="#UniformInfiniteLight::scale" class="code">scale</a> * <a href="#UniformInfiniteLight::Lemit" class="code">Lemit</a>-&gt;<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#DenselySampledSpectrum::Sample" class="code">Sample</a>(lambda);
}</div><p>


</p>
<p>

</p>
<p></p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">
<a href="#ImageInfiniteLights"><i class="fas fa-link h3h4marginlink"></i></a>
</div>
<div class="col-md-10 col-lg-8">
<span class="anchor" id="sec:image-infinite-light"></span><span id="ImageInfiniteLights"></span><h3>12.5.2  Image Infinite Lights</h3><p>



</p>
<p><tt>ImageInfiniteLight</tt> is a useful infinite light variation that uses an
<a href="../Utilities/Images.html#Image"><tt>Image</tt></a> to define the directional distribution of emitted radiance.
Given an image that represents the distribution of incident radiance in a
real-world environment (sometimes called an <em>environment map</em>), this
light can be used to render objects under the same illumination, which is
particularly useful for applications like visual effects for movies, where
it is often necessary to composite rendered objects with film footage.
(See the &ldquo;Further Reading&rdquo; section for information about techniques for
capturing this lighting data from real-world environments.)
Figure&nbsp;<a href="#fig:tt-skylights">12.17</a> shows the image radiance maps used in
Figure&nbsp;<a href="#fig:tt-area-vs-morning">12.16</a>.

</p>
<p></p>
<span class="anchor" id="fig:tt-skylights"></span><div class="card outerfigure"><div class="card-body figure"><p>


</p>

<div class="card-img-top" style="display:block; width: 100%; padding-top: 102.344%;  position:relative;"><div id="xa_Midday48" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0;"></div></div>
<script>
Jeri.renderViewer(document.getElementById('xa_Midday48'), {
  title: '(a)_Midday48', children: [
 { title: '(a) Midday', image: 'env-midday-sunflowers.png' },  { title: '(b) Sunset', image: 'env-sunset-fire.png' }]});
</script>
<figcaption class="caption">Figure 12.17: Environment Maps Used for Illumination in
Figure&nbsp;<a href="#fig:tt-area-vs-morning">12.16</a>.
<span class="legend">
All use the octahedral mapping and equal-area parameterization of the sphere from
Section&nbsp;<a href="../Geometry_and_Transformations/Spherical_Geometry.html#sec:equi-area-sphere">3.8.3</a>.
(a)&nbsp;Midday and (b)&nbsp;sunset sky.
<em>(Midday environment map courtesy of Sergej Majboroda, sunset environment
map courtesy of Greg Zaal, both via Poly Haven.)</em>
</span>
</figcaption>
</div></div><p>


</p>
<p></p>
<span class="anchor" id="fragment-ImageInfiniteLightDefinition-0"></span><div class="fragmentname">&lt;&lt;ImageInfiniteLight Definition&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">class <span class="anchor" id="ImageInfiniteLight"></span>ImageInfiniteLight : public <a href="../Light_Sources/Light_Interface.html#LightBase" class="code">LightBase</a> {
  public:
    &lt;&lt;<span class="fragmentname"><a href="#fragment-ImageInfiniteLightPublicMethods-0">ImageInfiniteLight Public Methods</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1676" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1676"><i></i></a><div id="fragbit-1676" class="collapse show"><div class="fragmentcode">       ImageInfiniteLight(<a href="../Geometry_and_Transformations/Transformations.html#Transform" class="code">Transform</a> <a href="../Light_Sources/Light_Interface.html#LightBase::renderFromLight" class="code">renderFromLight</a>, <a href="../Utilities/Images.html#Image" class="code">Image</a> image,
                          const <a href="../Radiometry,_Spectra,_and_Color/Color.html#RGBColorSpace" class="code">RGBColorSpace</a> *imageColorSpace, Float scale,
                          std::string filename, Allocator alloc);
       
       void Preprocess(const <a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3f" class="code">Bounds3f</a> &amp;sceneBounds) {
           sceneBounds.BoundingSphere(&amp;sceneCenter, &amp;sceneRadius);
       }
       
       <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> Phi(<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledWavelengths" class="code">SampledWavelengths</a> lambda) const;
       
       PBRT_CPU_GPU
       Float PDF_Li(<a href="../Light_Sources/Light_Interface.html#LightSampleContext" class="code">LightSampleContext</a>, <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a>, bool allowIncompletePDF) const;
       
       PBRT_CPU_GPU
       pstd::optional&lt;LightLeSample&gt; SampleLe(<a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a> u1, <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a> u2,
                                              <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledWavelengths" class="code">SampledWavelengths</a> &amp;lambda,
                                              Float time) const;
       PBRT_CPU_GPU
       void PDF_Le(const <a href="../Geometry_and_Transformations/Rays.html#Ray" class="code">Ray</a> &amp;, Float *pdfPos, Float *pdfDir) const;
       
       PBRT_CPU_GPU
       void PDF_Le(const <a href="../Geometry_and_Transformations/Interactions.html#Interaction" class="code">Interaction</a> &amp;, <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> w, Float *pdfPos, Float *pdfDir) const {
           LOG_FATAL("Shouldn't be called for non-area lights");
       }
       
       std::string ToString() const;
       <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> Le(const <a href="../Geometry_and_Transformations/Rays.html#Ray" class="code">Ray</a> &amp;ray, const <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledWavelengths" class="code">SampledWavelengths</a> &amp;lambda) const {
           <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> wLight = Normalize(<a href="../Light_Sources/Light_Interface.html#LightBase::renderFromLight" class="code">renderFromLight</a>.ApplyInverse(ray.d));
           <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a> uv = <a href="../Geometry_and_Transformations/Spherical_Geometry.html#EqualAreaSphereToSquare" class="code">EqualAreaSphereToSquare</a>(wLight);
           return <a href="#ImageInfiniteLight::ImageLe" class="code">ImageLe</a>(uv, lambda);
       }
       pstd::optional&lt;<a href="../Light_Sources/Light_Interface.html#LightLiSample" class="code">LightLiSample</a>&gt;
       SampleLi(<a href="../Light_Sources/Light_Interface.html#LightSampleContext" class="code">LightSampleContext</a> ctx, <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a> u, <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledWavelengths" class="code">SampledWavelengths</a> lambda,
                bool allowIncompletePDF) const {
           &lt;&lt;<span class="fragmentname"><a href="#fragment-Finduvsamplecoordinatesininfinitelighttexture-0">Find <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.301ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 2282.2 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">left-parenthesis u comma v right-parenthesis</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D462" d="M543 143c0 0 -13 -63 -30 -99c-16 -32 -39 -55 -74 -55c-43 0 -78 26 -89 67c-17 -22 -53 -67 -119 -67c-54 0 -123 25 -123 120c0 49 21 111 58 210c6 15 17 44 17 68c0 32 -16 33 -25 33c-38 0 -76 -37 -101 -124c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10 c0 9 37 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -17 -63c-26 -69 -54 -148 -54 -204c0 -37 10 -82 62 -82c73 0 113 80 114 84l75 301c8 34 34 35 39 35c15 0 29 -9 29 -27c0 -6 -10 -44 -15 -67c-4 -15 -14 -53 -17 -68l-28 -108c-8 -35 -20 -82 -20 -104 c0 -33 10 -46 31 -46c42 0 61 68 75 124c3 14 4 18 14 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D463" d="M468 372c0 -52 -57 -383 -225 -383c-46 0 -134 16 -134 124c0 43 13 89 57 205c7 18 17 45 17 70c0 32 -17 32 -25 32c-29 0 -72 -23 -101 -124c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 38 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -12 -50 c-31 -83 -58 -156 -58 -212c0 -52 23 -87 74 -87c117 0 178 229 178 271c0 36 -13 62 -34 82c-11 11 -16 17 -16 30c0 22 24 48 49 48c18 0 44 -16 44 -70Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D462" x="389" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="962" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D463" x="1407" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="1892" y="0"></use>
</g>
</svg> sample coordinates in infinite light texture</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1677" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1677"><i></i></a><div id="fragbit-1677" class="collapse show"><div class="fragmentcode">              Float mapPDF = 0;
              <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a> uv;
              if (allowIncompletePDF)
                  uv = <a href="#ImageInfiniteLight::compensatedDistribution" class="code">compensatedDistribution</a>.<a href="../Sampling_Algorithms/Sampling_Multidimensional_Functions.html#PiecewiseConstant2D::Sample" class="code">Sample</a>(u, &amp;mapPDF);
              else
                  uv = <a href="#ImageInfiniteLight::distribution" class="code">distribution</a>.<a href="../Sampling_Algorithms/Sampling_Multidimensional_Functions.html#PiecewiseConstant2D::Sample" class="code">Sample</a>(u, &amp;mapPDF);
              if (mapPDF == 0)
                  return {};</div></div>
           &lt;&lt;<span class="fragmentname"><a href="#fragment-Convertinfinitelightsamplepointtodirection-0">Convert infinite light sample point to direction</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1678" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1678"><i></i></a><div id="fragbit-1678" class="collapse show"><div class="fragmentcode">              <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> wLight = <a href="../Geometry_and_Transformations/Spherical_Geometry.html#EqualAreaSquareToSphere" class="code">EqualAreaSquareToSphere</a>(uv);
              <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> wi = <a href="../Light_Sources/Light_Interface.html#LightBase::renderFromLight" class="code">renderFromLight</a>(wLight);</div></div>
           &lt;&lt;<span class="fragmentname"><a href="#fragment-ComputePDFforsampledinfinitelightdirection-0">Compute PDF for sampled infinite light direction</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1679" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1679"><i></i></a><div id="fragbit-1679" class="collapse show"><div class="fragmentcode">              Float pdf = mapPDF / (4 * <a href="../Utilities/Mathematical_Infrastructure.html#Pi" class="code">Pi</a>);</div></div>
           &lt;&lt;<span class="fragmentname"><a href="#fragment-Returnradiancevalueforinfinitelightdirection-0">Return radiance value for infinite light direction</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1680" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1680"><i></i></a><div id="fragbit-1680" class="collapse show"><div class="fragmentcode">              return <a href="../Light_Sources/Light_Interface.html#LightLiSample" class="code">LightLiSample</a>(<a href="#ImageInfiniteLight::ImageLe" class="code">ImageLe</a>(uv, lambda), wi, pdf,
                  <a href="../Geometry_and_Transformations/Interactions.html#Interaction" class="code">Interaction</a>(ctx.<a href="../Light_Sources/Light_Interface.html#LightSampleContext::p" class="code">p</a>() + wi * (2 * <a href="#ImageInfiniteLight::sceneRadius" class="code">sceneRadius</a>), &amp;<a href="../Light_Sources/Light_Interface.html#LightBase::mediumInterface" class="code">mediumInterface</a>));</div></div>
       }
       pstd::optional&lt;<a href="../Light_Sources/Light_Sampling.html#LightBounds" class="code">LightBounds</a>&gt; Bounds() const { return {}; }</div></div>
  private:
    &lt;&lt;<span class="fragmentname"><a href="#fragment-ImageInfiniteLightPrivateMethods-0">ImageInfiniteLight Private Methods</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1681" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1681"><i></i></a><div id="fragbit-1681" class="collapse show"><div class="fragmentcode">       <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> ImageLe(<a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a> uv,
                               const <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledWavelengths" class="code">SampledWavelengths</a> &amp;lambda) const {
           <a href="../Radiometry,_Spectra,_and_Color/Color.html#RGB" class="code">RGB</a> rgb;
           for (int c = 0; c &lt; 3; ++c)
               rgb[c] = <a href="#ImageInfiniteLight::image" class="code">image</a>.<a href="../Utilities/Images.html#Image::LookupNearestChannel" class="code">LookupNearestChannel</a>(uv, c,
                                                   <a href="../Utilities/Images.html#WrapMode::OctahedralSphere" class="code">WrapMode</a>::OctahedralSphere);
           <a href="../Radiometry,_Spectra,_and_Color/Color.html#RGBIlluminantSpectrum" class="code">RGBIlluminantSpectrum</a> spec(*<a href="#ImageInfiniteLight::imageColorSpace" class="code">imageColorSpace</a>, ClampZero(rgb));
           return <a href="#ImageInfiniteLight::scale" class="code">scale</a> * spec.<a href="../Radiometry,_Spectra,_and_Color/Color.html#RGBIlluminantSpectrum::Sample" class="code">Sample</a>(lambda);
       }</div></div>
    &lt;&lt;<span class="fragmentname"><a href="#fragment-ImageInfiniteLightPrivateMembers-0">ImageInfiniteLight Private Members</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1682" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1682"><i></i></a><div id="fragbit-1682" class="collapse show"><div class="fragmentcode">       <a href="../Utilities/Images.html#Image" class="code">Image</a> image;
       const <a href="../Radiometry,_Spectra,_and_Color/Color.html#RGBColorSpace" class="code">RGBColorSpace</a> *imageColorSpace;
       Float scale;
       <a href="../Geometry_and_Transformations/Points.html#Point3f" class="code">Point3f</a> sceneCenter;
       Float sceneRadius;
       <a href="../Sampling_Algorithms/Sampling_Multidimensional_Functions.html#PiecewiseConstant2D" class="code">PiecewiseConstant2D</a> distribution;
       <a href="../Sampling_Algorithms/Sampling_Multidimensional_Functions.html#PiecewiseConstant2D" class="code">PiecewiseConstant2D</a> compensatedDistribution;</div></div>
};</div><p>


</p>
<p>

</p>
<p>


</p>
<p>The image that specifies the emission distribution should use the
equal-area octahedral parameterization of directions that was defined in
Section&nbsp;<a href="../Geometry_and_Transformations/Spherical_Geometry.html#sec:equi-area-sphere">3.8.3</a>.  The <a href="../Light_Sources/Light_Interface.html#LightBase::renderFromLight"><tt>LightBase::renderFromLight</tt></a>
transformation can be used to orient the environment map.

</p>
<p></p>
<span class="anchor" id="fragment-ImageInfiniteLightPrivateMembers-0"></span><div class="fragmentname">&lt;&lt;ImageInfiniteLight Private Members&gt;&gt;=&nbsp;<a href="#fragment-ImageInfiniteLightPrivateMembers-1"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode"><a href="../Utilities/Images.html#Image" class="code">Image</a> <span class="anchor" id="ImageInfiniteLight::image"></span>image;
const <a href="../Radiometry,_Spectra,_and_Color/Color.html#RGBColorSpace" class="code">RGBColorSpace</a> *<span class="anchor" id="ImageInfiniteLight::imageColorSpace"></span>imageColorSpace;
Float <span class="anchor" id="ImageInfiniteLight::scale"></span>scale;</div><p>


</p>
<p>Like <a href="#UniformInfiniteLight"><tt>UniformInfiniteLight</tt></a>s, <tt>ImageInfiniteLight</tt>s also need the
scene bounds; here again, the <tt>Preprocess()</tt> method (this one not included in
the text) stores the scene&rsquo;s bounding sphere after all the scene geometry has been
created.

</p>
<p></p>
<span class="anchor" id="fragment-ImageInfiniteLightPrivateMembers-1"></span><div class="fragmentname">&lt;&lt;ImageInfiniteLight Private Members&gt;&gt;+=&nbsp;<a href="#fragment-ImageInfiniteLightPrivateMembers-0"><span class="fa fa-caret-up"></span></a>&nbsp;<a href="#fragment-ImageInfiniteLightPrivateMembers-2"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode"><a href="../Geometry_and_Transformations/Points.html#Point3f" class="code">Point3f</a> <span class="anchor" id="ImageInfiniteLight::sceneCenter"></span>sceneCenter;
Float <span class="anchor" id="ImageInfiniteLight::sceneRadius"></span>sceneRadius;</div><p>


</p>
<p>The <tt>ImageInfiniteLight</tt> constructor contains a fair amount of
boilerplate code that we will skip past.  (For example, it verifies that
the provided image has channels named &ldquo;R,&rdquo; &ldquo;G,&rdquo; and &ldquo;B&rdquo; and issues an
error if it does not.)  The interesting parts of it are gathered in the following
fragment.

</p>
<p></p>
<span class="anchor" id="fragment-ImageInfiniteLightconstructorimplementation-0"></span><div class="fragmentname">&lt;&lt;ImageInfiniteLight constructor implementation&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">&lt;&lt;<span class="fragmentname"><a href="#fragment-InitializesamplingPDFsforimageinfinitearealight-0">Initialize sampling PDFs for image infinite area light</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1683" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1683"><i></i></a><div id="fragbit-1683" class="collapse show"><div class="fragmentcode">   <a href="../Utilities/Containers_and_Memory_Management.html#Array2D" class="code">Array2D</a>&lt;Float&gt; d = <a href="#ImageInfiniteLight::image" class="code">image</a>.<a href="../Utilities/Images.html#Image::GetSamplingDistribution" class="code">GetSamplingDistribution</a>();
   <a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds2f" class="code">Bounds2f</a> domain = <a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds2f" class="code">Bounds2f</a>(<a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0, 0), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(1, 1));
   <a href="#ImageInfiniteLight::distribution" class="code">distribution</a> = PiecewiseConstant2D(d, domain, alloc);</div></div>
&lt;&lt;<span class="fragmentname"><a href="#fragment-InitializecompensatedPDFforimageinfinitearealight-0">Initialize compensated PDF for image infinite area light</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1684" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1684"><i></i></a><div id="fragbit-1684" class="collapse show"><div class="fragmentcode">   Float average = std::accumulate(d.begin(), d.end(), 0.) / d.size();
   for (Float &amp;v : d)
       v = std::max&lt;Float&gt;(v - average, 0);
   <a href="#ImageInfiniteLight::compensatedDistribution" class="code">compensatedDistribution</a> = PiecewiseConstant2D(d, domain, alloc);</div></div></div><p>


</p>
<p>The image maps used with <tt>ImageInfiniteLight</tt>s often have substantial
variation along different directions: consider, for example, an environment
map of the sky during daytime, where the relatively small number of
directions that the sun subtends are thousands of times brighter than the
rest of the directions.  Therefore, implementing a
sampling method for <a href="#ImageInfiniteLight"><tt>ImageInfiniteLight</tt></a>s that matches the illumination
distribution can significantly reduce variance in rendered images compared
to sampling directions uniformly.  To this end, the constructor initializes
a <a href="../Sampling_Algorithms/Sampling_Multidimensional_Functions.html#PiecewiseConstant2D"><tt>PiecewiseConstant2D</tt></a> distribution that is proportional to the image pixel
values.

</p>
<p></p>
<span class="anchor" id="fragment-InitializesamplingPDFsforimageinfinitearealight-0"></span><div class="fragmentname">&lt;&lt;Initialize sampling PDFs for image infinite area light&gt;&gt;=&nbsp;</div>
<div class="fragmentcode"><a href="../Utilities/Containers_and_Memory_Management.html#Array2D" class="code">Array2D</a>&lt;Float&gt; d = <a href="#ImageInfiniteLight::image" class="code">image</a>.<a href="../Utilities/Images.html#Image::GetSamplingDistribution" class="code">GetSamplingDistribution</a>();
<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds2f" class="code">Bounds2f</a> domain = <a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds2f" class="code">Bounds2f</a>(<a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(0, 0), <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(1, 1));
<a href="#ImageInfiniteLight::distribution" class="code">distribution</a> = PiecewiseConstant2D(d, domain, alloc);</div><p>


</p>
<p></p>
<span class="anchor" id="fragment-ImageInfiniteLightPrivateMembers-2"></span><div class="fragmentname">&lt;&lt;ImageInfiniteLight Private Members&gt;&gt;+=&nbsp;<a href="#fragment-ImageInfiniteLightPrivateMembers-1"><span class="fa fa-caret-up"></span></a>&nbsp;<a href="#fragment-ImageInfiniteLightPrivateMembers-3"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode"><a href="../Sampling_Algorithms/Sampling_Multidimensional_Functions.html#PiecewiseConstant2D" class="code">PiecewiseConstant2D</a> <span class="anchor" id="ImageInfiniteLight::distribution"></span>distribution;</div><p>


</p>
<p>

</p>
<p>A second sampling distribution is computed based on a thresholded version
of the image where the average pixel value is subtracted from each pixel&rsquo;s
sampling weight.  The use of both of these sampling distributions will be
discussed in more detail shortly, with the implementation of the
<tt>SampleLi()</tt> method.

</p>
<p></p>
<span class="anchor" id="fragment-InitializecompensatedPDFforimageinfinitearealight-0"></span><div class="fragmentname">&lt;&lt;Initialize compensated PDF for image infinite area light&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">Float average = std::accumulate(d.begin(), d.end(), 0.) / d.size();
for (Float &amp;v : d)
    v = std::max&lt;Float&gt;(v - average, 0);
<a href="#ImageInfiniteLight::compensatedDistribution" class="code">compensatedDistribution</a> = PiecewiseConstant2D(d, domain, alloc);</div><p>


</p>
<p></p>
<span class="anchor" id="fragment-ImageInfiniteLightPrivateMembers-3"></span><div class="fragmentname">&lt;&lt;ImageInfiniteLight Private Members&gt;&gt;+=&nbsp;<a href="#fragment-ImageInfiniteLightPrivateMembers-2"><span class="fa fa-caret-up"></span></a></div>
<div class="fragmentcode"><a href="../Sampling_Algorithms/Sampling_Multidimensional_Functions.html#PiecewiseConstant2D" class="code">PiecewiseConstant2D</a> <span class="anchor" id="ImageInfiniteLight::compensatedDistribution"></span>compensatedDistribution;</div><p>


</p>
<p>Before we get to the sampling methods, we will provide an implementation of
the <tt>Le()</tt> method that is required by the <a href="../Light_Sources/Light_Interface.html#Light"><tt>Light</tt></a> interface for
infinite lights.  After computing the 2D coordinates of the provided ray&rsquo;s
direction in image coordinates, it defers to the
<tt>ImageLe()</tt> method.

</p>
<p></p>
<span class="anchor" id="fragment-ImageInfiniteLightPublicMethods-0"></span><div class="fragmentname">&lt;&lt;ImageInfiniteLight Public Methods&gt;&gt;=&nbsp;<a href="#fragment-ImageInfiniteLightPublicMethods-1"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode"><a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> <span class="anchor" id="ImageInfiniteLight::Le"></span>Le(const <a href="../Geometry_and_Transformations/Rays.html#Ray" class="code">Ray</a> &amp;ray, const <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledWavelengths" class="code">SampledWavelengths</a> &amp;lambda) const {
    <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> wLight = Normalize(<a href="../Light_Sources/Light_Interface.html#LightBase::renderFromLight" class="code">renderFromLight</a>.ApplyInverse(ray.d));
    <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a> uv = <a href="../Geometry_and_Transformations/Spherical_Geometry.html#EqualAreaSphereToSquare" class="code">EqualAreaSphereToSquare</a>(wLight);
    return <a href="#ImageInfiniteLight::ImageLe" class="code">ImageLe</a>(uv, lambda);
}</div><p>


</p>
<p><tt>ImageLe()</tt> returns the emitted radiance for a given point in the
image.

</p>
<p></p>
<span class="anchor" id="fragment-ImageInfiniteLightPrivateMethods-0"></span><div class="fragmentname">&lt;&lt;ImageInfiniteLight Private Methods&gt;&gt;=&nbsp;</div>
<div class="fragmentcode"><a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> <span class="anchor" id="ImageInfiniteLight::ImageLe"></span>ImageLe(<a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a> uv,
                        const <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledWavelengths" class="code">SampledWavelengths</a> &amp;lambda) const {
    <a href="../Radiometry,_Spectra,_and_Color/Color.html#RGB" class="code">RGB</a> rgb;
    for (int c = 0; c &lt; 3; ++c)
        rgb[c] = <a href="#ImageInfiniteLight::image" class="code">image</a>.<a href="../Utilities/Images.html#Image::LookupNearestChannel" class="code">LookupNearestChannel</a>(uv, c,
                                            <a href="../Utilities/Images.html#WrapMode::OctahedralSphere" class="code">WrapMode</a>::OctahedralSphere);
    <a href="../Radiometry,_Spectra,_and_Color/Color.html#RGBIlluminantSpectrum" class="code">RGBIlluminantSpectrum</a> spec(*<a href="#ImageInfiniteLight::imageColorSpace" class="code">imageColorSpace</a>, ClampZero(rgb));
    return <a href="#ImageInfiniteLight::scale" class="code">scale</a> * spec.<a href="../Radiometry,_Spectra,_and_Color/Color.html#RGBIlluminantSpectrum::Sample" class="code">Sample</a>(lambda);
}</div><p>


</p>
<p>There is a bit more work to do for sampling an incident direction at a
reference point according to the light&rsquo;s emitted radiance.

</p>
<p></p>
<span class="anchor" id="fragment-ImageInfiniteLightPublicMethods-1"></span><div class="fragmentname">&lt;&lt;ImageInfiniteLight Public Methods&gt;&gt;+=&nbsp;<a href="#fragment-ImageInfiniteLightPublicMethods-0"><span class="fa fa-caret-up"></span></a>&nbsp;<a href="Light_Sampling.html#fragment-ImageInfiniteLightPublicMethods-2"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode">pstd::optional&lt;<a href="../Light_Sources/Light_Interface.html#LightLiSample" class="code">LightLiSample</a>&gt;
<span class="anchor" id="ImageInfiniteLight::SampleLi"></span>SampleLi(<a href="../Light_Sources/Light_Interface.html#LightSampleContext" class="code">LightSampleContext</a> ctx, <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a> u, <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledWavelengths" class="code">SampledWavelengths</a> lambda,
         bool allowIncompletePDF) const {
    &lt;&lt;<span class="fragmentname"><a href="#fragment-Finduvsamplecoordinatesininfinitelighttexture-0">Find <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.301ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 2282.2 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">left-parenthesis u comma v right-parenthesis</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D462" d="M543 143c0 0 -13 -63 -30 -99c-16 -32 -39 -55 -74 -55c-43 0 -78 26 -89 67c-17 -22 -53 -67 -119 -67c-54 0 -123 25 -123 120c0 49 21 111 58 210c6 15 17 44 17 68c0 32 -16 33 -25 33c-38 0 -76 -37 -101 -124c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10 c0 9 37 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -17 -63c-26 -69 -54 -148 -54 -204c0 -37 10 -82 62 -82c73 0 113 80 114 84l75 301c8 34 34 35 39 35c15 0 29 -9 29 -27c0 -6 -10 -44 -15 -67c-4 -15 -14 -53 -17 -68l-28 -108c-8 -35 -20 -82 -20 -104 c0 -33 10 -46 31 -46c42 0 61 68 75 124c3 14 4 18 14 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D463" d="M468 372c0 -52 -57 -383 -225 -383c-46 0 -134 16 -134 124c0 43 13 89 57 205c7 18 17 45 17 70c0 32 -17 32 -25 32c-29 0 -72 -23 -101 -124c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 38 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -12 -50 c-31 -83 -58 -156 -58 -212c0 -52 23 -87 74 -87c117 0 178 229 178 271c0 36 -13 62 -34 82c-11 11 -16 17 -16 30c0 22 24 48 49 48c18 0 44 -16 44 -70Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D462" x="389" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="962" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D463" x="1407" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="1892" y="0"></use>
</g>
</svg> sample coordinates in infinite light texture</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1685" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1685"><i></i></a><div id="fragbit-1685" class="collapse show"><div class="fragmentcode">       Float mapPDF = 0;
       <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a> uv;
       if (allowIncompletePDF)
           uv = <a href="#ImageInfiniteLight::compensatedDistribution" class="code">compensatedDistribution</a>.<a href="../Sampling_Algorithms/Sampling_Multidimensional_Functions.html#PiecewiseConstant2D::Sample" class="code">Sample</a>(u, &amp;mapPDF);
       else
           uv = <a href="#ImageInfiniteLight::distribution" class="code">distribution</a>.<a href="../Sampling_Algorithms/Sampling_Multidimensional_Functions.html#PiecewiseConstant2D::Sample" class="code">Sample</a>(u, &amp;mapPDF);
       if (mapPDF == 0)
           return {};</div></div>
    &lt;&lt;<span class="fragmentname"><a href="#fragment-Convertinfinitelightsamplepointtodirection-0">Convert infinite light sample point to direction</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1686" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1686"><i></i></a><div id="fragbit-1686" class="collapse show"><div class="fragmentcode">       <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> wLight = <a href="../Geometry_and_Transformations/Spherical_Geometry.html#EqualAreaSquareToSphere" class="code">EqualAreaSquareToSphere</a>(uv);
       <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> wi = <a href="../Light_Sources/Light_Interface.html#LightBase::renderFromLight" class="code">renderFromLight</a>(wLight);</div></div>
    &lt;&lt;<span class="fragmentname"><a href="#fragment-ComputePDFforsampledinfinitelightdirection-0">Compute PDF for sampled infinite light direction</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1687" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1687"><i></i></a><div id="fragbit-1687" class="collapse show"><div class="fragmentcode">       Float pdf = mapPDF / (4 * <a href="../Utilities/Mathematical_Infrastructure.html#Pi" class="code">Pi</a>);</div></div>
    &lt;&lt;<span class="fragmentname"><a href="#fragment-Returnradiancevalueforinfinitelightdirection-0">Return radiance value for infinite light direction</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1688" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1688"><i></i></a><div id="fragbit-1688" class="collapse show"><div class="fragmentcode">       return <a href="../Light_Sources/Light_Interface.html#LightLiSample" class="code">LightLiSample</a>(<a href="#ImageInfiniteLight::ImageLe" class="code">ImageLe</a>(uv, lambda), wi, pdf,
           <a href="../Geometry_and_Transformations/Interactions.html#Interaction" class="code">Interaction</a>(ctx.<a href="../Light_Sources/Light_Interface.html#LightSampleContext::p" class="code">p</a>() + wi * (2 * <a href="#ImageInfiniteLight::sceneRadius" class="code">sceneRadius</a>), &amp;<a href="../Light_Sources/Light_Interface.html#LightBase::mediumInterface" class="code">mediumInterface</a>));</div></div>
}</div><p>


</p>
<p>The first step is to generate an image sample with probability proportional
to the image pixel values, which is a task that is handled by the
<a href="../Sampling_Algorithms/Sampling_Multidimensional_Functions.html#PiecewiseConstant2D"><tt>PiecewiseConstant2D</tt></a> <tt>Sample()</tt> method.  If <tt>SampleLi()</tt> is
called with <tt>allowIncompletePDF</tt> being <tt>true</tt>, then the second sampling
distribution that was based on the thresholded image is used.  The
motivation for doing so is the same
as when <a href="#UniformInfiniteLight::SampleLi"><tt>UniformInfiniteLight::SampleLi()</tt></a> does not
generate samples at all in that case: here, there is no reason to spend
samples in parts of the image that have a relatively low contribution.  It
is better to let other sampling techniques (e.g., BSDF sampling) generate
samples in those directions when they are actually important for the full
function being integrated.
Light samples are then allocated to the bright parts of the image, where
they are more useful.

</p>
<p></p>
<span class="anchor" id="fragment-Finduvsamplecoordinatesininfinitelighttexture-0"></span><div class="fragmentname">&lt;&lt;Find <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.301ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 2282.2 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">left-parenthesis u comma v right-parenthesis</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D462" d="M543 143c0 0 -13 -63 -30 -99c-16 -32 -39 -55 -74 -55c-43 0 -78 26 -89 67c-17 -22 -53 -67 -119 -67c-54 0 -123 25 -123 120c0 49 21 111 58 210c6 15 17 44 17 68c0 32 -16 33 -25 33c-38 0 -76 -37 -101 -124c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10 c0 9 37 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -17 -63c-26 -69 -54 -148 -54 -204c0 -37 10 -82 62 -82c73 0 113 80 114 84l75 301c8 34 34 35 39 35c15 0 29 -9 29 -27c0 -6 -10 -44 -15 -67c-4 -15 -14 -53 -17 -68l-28 -108c-8 -35 -20 -82 -20 -104 c0 -33 10 -46 31 -46c42 0 61 68 75 124c3 14 4 18 14 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D463" d="M468 372c0 -52 -57 -383 -225 -383c-46 0 -134 16 -134 124c0 43 13 89 57 205c7 18 17 45 17 70c0 32 -17 32 -25 32c-29 0 -72 -23 -101 -124c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 38 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -12 -50 c-31 -83 -58 -156 -58 -212c0 -52 23 -87 74 -87c117 0 178 229 178 271c0 36 -13 62 -34 82c-11 11 -16 17 -16 30c0 22 24 48 49 48c18 0 44 -16 44 -70Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D462" x="389" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="962" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D463" x="1407" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="1892" y="0"></use>
</g>
</svg> sample coordinates in infinite light texture&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">Float mapPDF = 0;
<a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a> uv;
if (allowIncompletePDF)
    uv = <a href="#ImageInfiniteLight::compensatedDistribution" class="code">compensatedDistribution</a>.<a href="../Sampling_Algorithms/Sampling_Multidimensional_Functions.html#PiecewiseConstant2D::Sample" class="code">Sample</a>(u, &amp;mapPDF);
else
    uv = <a href="#ImageInfiniteLight::distribution" class="code">distribution</a>.<a href="../Sampling_Algorithms/Sampling_Multidimensional_Functions.html#PiecewiseConstant2D::Sample" class="code">Sample</a>(u, &amp;mapPDF);
if (mapPDF == 0)
    return {};</div><p>


</p>
<p>It is a simple matter to convert from image coordinates to a rendering space
direction <tt>wi</tt>.

</p>
<p></p>
<span class="anchor" id="fragment-Convertinfinitelightsamplepointtodirection-0"></span><div class="fragmentname">&lt;&lt;Convert infinite light sample point to direction&gt;&gt;=&nbsp;</div>
<div class="fragmentcode"><a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> wLight = <a href="../Geometry_and_Transformations/Spherical_Geometry.html#EqualAreaSquareToSphere" class="code">EqualAreaSquareToSphere</a>(uv);
<a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> wi = <a href="../Light_Sources/Light_Interface.html#LightBase::renderFromLight" class="code">renderFromLight</a>(wLight);</div><p>


</p>
<p>The PDF returned by <a href="../Sampling_Algorithms/Sampling_Multidimensional_Functions.html#PiecewiseConstant2D::Sample"><tt>PiecewiseConstant2D::Sample()</tt></a> is with respect to
the image&rsquo;s <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.707ex" height="3.009ex" style="vertical-align: -0.838ex;" viewBox="0 -934.9 2457.1 1295.7" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">left-bracket 0 comma 1 right-bracket squared</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-5B" d="M256 -230c0 -11 -9 -20 -20 -20h-122v1000h122c11 0 20 -9 20 -20s-9 -20 -20 -20h-82v-920h82c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-30" d="M460 320c0 -79 -5 -157 -37 -226c-44 -95 -120 -116 -174 -116c-49 0 -122 20 -165 101c-41 76 -45 166 -45 241c0 80 5 158 37 227c41 93 114 119 174 119c42 0 124 -16 170 -112c35 -74 40 -154 40 -234zM377 332c0 63 0 139 -10 195c-19 99 -85 117 -118 117 c-25 0 -100 -9 -119 -128c-8 -54 -8 -120 -8 -184c0 -59 0 -151 11 -211c18 -96 77 -121 116 -121c45 0 102 30 117 125c11 64 11 132 11 207Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-5D" d="M164 -250h-122c-11 0 -20 9 -20 20s9 20 20 20h82v920h-82c-11 0 -20 9 -20 20s9 20 20 20h122v-1000Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-32" d="M449 174l-28 -174h-371c0 24 0 26 11 37l192 214c55 62 105 141 105 221c0 82 -43 163 -134 163c-58 0 -112 -37 -135 -102c3 1 5 1 13 1c35 0 53 -26 53 -52c0 -41 -35 -53 -52 -53c-3 0 -53 0 -53 56c0 89 74 181 187 181c122 0 212 -80 212 -194 c0 -100 -60 -154 -216 -292l-106 -103h180c22 0 88 0 95 8c10 15 17 59 22 89h25Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-5B" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-30" x="278" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="779" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-31" x="1224" y="0"></use>
<g transform="translate(1724,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-5D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-32" x="393" y="513"></use>
</g>
</g>
</svg> domain.  To find the corresponding PDF with respect
to direction, the change of variables factor for going from the unit square
to the unit sphere <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="6.622ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 2851 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">1 slash left-parenthesis 4 pi right-parenthesis</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2F" d="M445 730c0 -2 0 -5 -1 -7l-349 -960c-3 -8 -10 -13 -19 -13c-11 0 -20 9 -20 20c0 2 0 5 1 7l349 960c3 8 10 13 19 13c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-34" d="M471 165h-100v-87c0 -36 2 -47 76 -47h21v-31c-41 3 -94 3 -136 3s-94 0 -135 -3v31h21c74 0 76 11 76 47v87h-266v31l307 469c8 12 11 12 20 12c16 0 16 -6 16 -26v-455h100v-31zM300 196v373l-244 -373h244Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D70B" d="M567 407c0 -34 -36 -34 -49 -34h-114c-11 -52 -18 -106 -18 -159c0 -28 0 -93 29 -165c6 -14 6 -16 6 -22c0 -20 -21 -38 -41 -38c-15 0 -26 6 -36 50c-8 34 -8 61 -8 76c0 67 9 110 42 258h-113l-56 -221c-13 -50 -13 -52 -27 -98c-12 -37 -20 -65 -50 -65 c-13 0 -29 8 -29 27c0 7 0 9 8 24c42 91 96 212 128 333h-57c-20 0 -78 0 -127 -77c-6 -8 -8 -12 -16 -12c-12 0 -12 10 -12 10c0 5 26 51 61 90c44 47 82 47 104 47h335c19 0 40 0 40 -24Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-31" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2F" x="500" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="1001" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-34" x="1390" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D70B" x="1891" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="2461" y="0"></use>
</g>
</svg> must be applied.

</p>
<p></p>
<span class="anchor" id="fragment-ComputePDFforsampledinfinitelightdirection-0"></span><div class="fragmentname">&lt;&lt;Compute PDF for sampled infinite light direction&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">Float pdf = mapPDF / (4 * <a href="../Utilities/Mathematical_Infrastructure.html#Pi" class="code">Pi</a>);</div><p>


</p>
<p>Finally, as with the <a href="../Light_Sources/Distant_Lights.html#DistantLight"><tt>DistantLight</tt></a> and <a href="#UniformInfiniteLight"><tt>UniformInfiniteLight</tt></a>, the
second point for the shadow ray is found by offsetting along the <tt>wi</tt>
direction far enough until that resulting point is certainly outside of
the scene&rsquo;s bounds.

</p>
<p></p>
<span class="anchor" id="fragment-Returnradiancevalueforinfinitelightdirection-0"></span><div class="fragmentname">&lt;&lt;Return radiance value for infinite light direction&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">return <a href="../Light_Sources/Light_Interface.html#LightLiSample" class="code">LightLiSample</a>(<a href="#ImageInfiniteLight::ImageLe" class="code">ImageLe</a>(uv, lambda), wi, pdf,
    <a href="../Geometry_and_Transformations/Interactions.html#Interaction" class="code">Interaction</a>(ctx.<a href="../Light_Sources/Light_Interface.html#LightSampleContext::p" class="code">p</a>() + wi * (2 * <a href="#ImageInfiniteLight::sceneRadius" class="code">sceneRadius</a>), &amp;<a href="../Light_Sources/Light_Interface.html#LightBase::mediumInterface" class="code">mediumInterface</a>));</div><p>


</p>
<p>Figure&nbsp;<a href="#fig:tt-env-light-comparison">12.18</a> illustrates how much error is
reduced by sampling image infinite lights well.  It compares three images
of a dragon model illuminated by the morning skylight environment map from
Figure&nbsp;<a href="#fig:tt-skylights">12.17</a>.  The first image was rendered using a simple
uniform spherical sampling distribution for selecting incident illumination
directions, the second used the full image-based sampling distribution, and
the third used the compensated distribution&mdash;all rendered with 32 samples
per pixel.  For the same number of samples taken and with negligible
additional computational cost, both importance sampling methods give a much
better result with much lower variance.

</p>
<p></p>
<span class="anchor" id="fig:tt-env-light-comparison"></span><div class="card outerfigure"><div class="card-body figure"><p>


</p>

<div class="card-img-top" style="display:block; width: 100%; padding-top: 48.667%;  position:relative;"><div id="xa_Uniform_sampling49" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0;"></div></div>
<script>
Jeri.renderViewer(document.getElementById('xa_Uniform_sampling49'), {
  title: '(a)_Uniform_sampling49', children: [
 { title: '(a) Uniform sampling', image: 'dragon-env-sample-uniform.exr' },  { title: '(b) Importance sampling', image: 'dragon-env-sample-non-compensated.exr' },  { title: '(c) Compensated importance sampling', image: 'dragon-env-sample-compensated.exr' }]});
</script>
<figcaption class="caption">Figure 12.18: Dragon Model Illuminated by the Morning Skylight
Environment Map. <span class="legend">
All images were rendered with 32 samples per pixel.
(a)&nbsp;Rendered using a uniform sampling distribution.
(b)&nbsp;Rendered with samples distributed according to environment map image pixels.
(c)&nbsp;Rendered using the compensated distribution that skips sampling
unimportant parts of the image.
All images took essentially the same amount of time to render, though (b)
has over 38,000 times lower MSE than (a), and (c) further improves MSE by a factor
of 1.52.
<em>(Dragon model courtesy of the Stanford Computer Graphics Laboratory.)</em>
</span>
</figcaption><p>
 

</p>
</div></div><p>


</p>
<p>Most of the work to compute the PDF for a provided direction is handled by the
<a href="../Sampling_Algorithms/Sampling_Multidimensional_Functions.html#PiecewiseConstant2D"><tt>PiecewiseConstant2D</tt></a> distribution.  Here as well, the PDF value it
returns is divided by <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.487ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 1071 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">4 pi</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-34" d="M471 165h-100v-87c0 -36 2 -47 76 -47h21v-31c-41 3 -94 3 -136 3s-94 0 -135 -3v31h21c74 0 76 11 76 47v87h-266v31l307 469c8 12 11 12 20 12c16 0 16 -6 16 -26v-455h100v-31zM300 196v373l-244 -373h244Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D70B" d="M567 407c0 -34 -36 -34 -49 -34h-114c-11 -52 -18 -106 -18 -159c0 -28 0 -93 29 -165c6 -14 6 -16 6 -22c0 -20 -21 -38 -41 -38c-15 0 -26 6 -36 50c-8 34 -8 61 -8 76c0 67 9 110 42 258h-113l-56 -221c-13 -50 -13 -52 -27 -98c-12 -37 -20 -65 -50 -65 c-13 0 -29 8 -29 27c0 7 0 9 8 24c42 91 96 212 128 333h-57c-20 0 -78 0 -127 -77c-6 -8 -8 -12 -16 -12c-12 0 -12 10 -12 10c0 5 26 51 61 90c44 47 82 47 104 47h335c19 0 40 0 40 -24Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-34" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D70B" x="500" y="0"></use>
</g>
</svg> to account for the area of the unit sphere.

</p>
<p></p>
<span class="anchor" id="fragment-ImageInfiniteLightMethodDefinitions-0"></span><div class="fragmentname">&lt;&lt;ImageInfiniteLight Method Definitions&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">Float <span class="anchor" id="ImageInfiniteLight::PDF_Li"></span>ImageInfiniteLight::PDF_Li(<a href="../Light_Sources/Light_Interface.html#LightSampleContext" class="code">LightSampleContext</a> ctx, <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> w,
                                 bool allowIncompletePDF) const {
    <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> wLight = <a href="../Light_Sources/Light_Interface.html#LightBase::renderFromLight" class="code">renderFromLight</a>.<a href="../Geometry_and_Transformations/Applying_Transformations.html#Transform::ApplyInverse" class="code">ApplyInverse</a>(w);
    <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a> uv = <a href="../Geometry_and_Transformations/Spherical_Geometry.html#EqualAreaSphereToSquare" class="code">EqualAreaSphereToSquare</a>(wLight);
    Float pdf = 0;
    if (allowIncompletePDF)
        pdf = <a href="#ImageInfiniteLight::compensatedDistribution" class="code">compensatedDistribution</a>.<a href="../Sampling_Algorithms/Sampling_Multidimensional_Functions.html#PiecewiseConstant2D::PDF" class="code">PDF</a>(uv);
    else
        pdf = <a href="#ImageInfiniteLight::distribution" class="code">distribution</a>.<a href="../Sampling_Algorithms/Sampling_Multidimensional_Functions.html#PiecewiseConstant2D::PDF" class="code">PDF</a>(uv);
    return pdf / (4 * <a href="../Utilities/Mathematical_Infrastructure.html#Pi" class="code">Pi</a>);
}</div><p>


</p>
<p>The <tt>ImageInfiniteLight::Phi()</tt><span class="anchor" id="ImageInfiniteLight::Phi"></span>
method, not included here, integrates incident radiance over the sphere by
looping over all the image pixels and summing them before multiplying by
a factor of <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.487ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 1071 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">4 pi</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-34" d="M471 165h-100v-87c0 -36 2 -47 76 -47h21v-31c-41 3 -94 3 -136 3s-94 0 -135 -3v31h21c74 0 76 11 76 47v87h-266v31l307 469c8 12 11 12 20 12c16 0 16 -6 16 -26v-455h100v-31zM300 196v373l-244 -373h244Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D70B" d="M567 407c0 -34 -36 -34 -49 -34h-114c-11 -52 -18 -106 -18 -159c0 -28 0 -93 29 -165c6 -14 6 -16 6 -22c0 -20 -21 -38 -41 -38c-15 0 -26 6 -36 50c-8 34 -8 61 -8 76c0 67 9 110 42 258h-113l-56 -221c-13 -50 -13 -52 -27 -98c-12 -37 -20 -65 -50 -65 c-13 0 -29 8 -29 27c0 7 0 9 8 24c42 91 96 212 128 333h-57c-20 0 -78 0 -127 -77c-6 -8 -8 -12 -16 -12c-12 0 -12 10 -12 10c0 5 26 51 61 90c44 47 82 47 104 47h335c19 0 40 0 40 -24Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-34" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D70B" x="500" y="0"></use>
</g>
</svg> to account for the area of the unit sphere as well as by
the area of a disk of radius
<tt>sceneRadius</tt>.

</p>
<p>

</p>
<p>

</p>
<p>
</p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">
<a href="#PortalImageInfiniteLights"><i class="fas fa-link h3h4marginlink"></i></a>
</div>
<div class="col-md-10 col-lg-8">
<span class="anchor" id="sec:portal-image-infinite-light"></span><span id="PortalImageInfiniteLights"></span><h3>12.5.3  Portal Image Infinite Lights<button data-toggle="tooltip" data-placement="right" class="btn difficult-button"
title="This section contains advanced content and may be skipped on a first reading.">
<i class="fas fa-exclamation-triangle midredtext"></i></button>
</h3><p>



</p>
<p><a href="#ImageInfiniteLight"><tt>ImageInfiniteLight</tt></a>s provide a handy sort of light source, though one
shortcoming of that class&rsquo;s implementation is that it does not account for
visibility in its sampling routines.  Samples that it generates that turn
out to be occluded are much less useful than those that do carry
illumination to the reference point.  While the expense of ray tracing is
necessary to fully account for visibility, accounting for even some
visibility effects in light sampling can significantly reduce error.

</p>
<p> </p>
<span class="anchor" id="fig:watercolor-sky-env-map"></span><div class="card outerfigure"><div class="card-body figure"><p>


</p>

<div class="card-img-top" style="display:block; width: 100%; padding-top: 77.500%;  position:relative;"><div id="xa_No_portal_sampling50" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0;"></div></div>
<script>
Jeri.renderViewer(document.getElementById('xa_No_portal_sampling50'), {
  title: '(a)_No_portal_sampling50', children: [
 { title: '(a) No portal sampling', image: 'watercolor-noportal.exr' },  { title: '(b) Portal sampling', image: 'watercolor-portal.exr' }]});
</script>
<figcaption class="caption">Figure 12.19: <em>Watercolor</em> Scene Illuminated by a Daytime Sky Environment Map. <span class="legend">
This is a challenging scene to render since the direct lighting calculation
only finds illumination when it samples a ray that passes through the
window.
(a)&nbsp;When rendered with the <a href="#ImageInfiniteLight"><tt>ImageInfiniteLight</tt></a> and 16 samples per
pixel, error is high because the environment map includes a bright sun,
though it does not illuminate all parts of the room.  For such points, none
of the many samples taken toward the sun has any contribution.  
(b)&nbsp;When rendered using the <a href="#PortalImageInfiniteLight"><tt>PortalImageInfiniteLight</tt></a>, results are
much better with the same number of samples
because the light is able to sample just the part of the environment map
that is visible through the window. In this case, MSE is reduced by a
factor of 2.82.
<em>(Scene courtesy of Angelo Ferretti.)</em>
</span>
</figcaption>
</div></div><p>


</p>
<p>Consider the scene shown in Figure&nbsp;<a href="#fig:watercolor-sky-env-map">12.19</a>, where
all the illumination is
coming from a skylight environment map that is visible only through the
windows.  
Part of the scene is directly illuminated by the sun, but much of it is
not.  Those other parts are still illuminated, but by much less bright
regions of blue sky.  Yet because the sun is so bright, the
<a href="#ImageInfiniteLight"><tt>ImageInfiniteLight</tt></a> ends up taking many samples in its direction,
though all the ones where the sun is not visible
through the window will be wasted.  In those regions of the scene, light
sampling will occasionally choose a part of the sky that is visible
through the window and occasionally BSDF sampling will find a path to the
light through the window, so that the result is still correct in
expectation, but many samples may be necessary to achieve a high-quality
result.

</p>
<p>The <a href="#PortalImageInfiniteLight"><tt>PortalImageInfiniteLight</tt></a> is designed to handle this situation
more effectively.  Given a user-specified <em>portal</em>, a quadrilateral
region through which the environment map is potentially
visible, it generates a custom sampling distribution at each point being
shaded so that it can draw samples according to the region of the
environment map that is visible through the portal.  For an equal number of
samples, this can be much more effective than the
<a href="#ImageInfiniteLight"><tt>ImageInfiniteLight</tt></a>&rsquo;s approach, as shown in Figure&nbsp;<a href="#fig:watercolor-sky-env-map">12.19</a>(b).

</p>
<p></p>
<span class="anchor" id="fragment-PortalImageInfiniteLightDefinition-0"></span><div class="fragmentname">&lt;&lt;PortalImageInfiniteLight Definition&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">class <span class="anchor" id="PortalImageInfiniteLight"></span>PortalImageInfiniteLight : public <a href="../Light_Sources/Light_Interface.html#LightBase" class="code">LightBase</a> {
  public:
    &lt;&lt;<span class="fragmentname">PortalImageInfiniteLight Public Methods</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1689" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1689"><i></i></a><div id="fragbit-1689" class="collapse show"><div class="fragmentcode">       PortalImageInfiniteLight(const <a href="../Geometry_and_Transformations/Transformations.html#Transform" class="code">Transform</a> &amp;renderFromLight, <a href="../Utilities/Images.html#Image" class="code">Image</a> image,
                                const <a href="../Radiometry,_Spectra,_and_Color/Color.html#RGBColorSpace" class="code">RGBColorSpace</a> *imageColorSpace, Float scale,
                                const std::string &amp;filename, std::vector&lt;<a href="../Geometry_and_Transformations/Points.html#Point3f" class="code">Point3f</a>&gt; portal,
                                Allocator alloc);
       
       void Preprocess(const <a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds3f" class="code">Bounds3f</a> &amp;sceneBounds) {
           sceneBounds.BoundingSphere(&amp;sceneCenter, &amp;sceneRadius);
       }
       
       <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> Phi(<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledWavelengths" class="code">SampledWavelengths</a> lambda) const;
       
       PBRT_CPU_GPU
       <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> Le(const <a href="../Geometry_and_Transformations/Rays.html#Ray" class="code">Ray</a> &amp;ray, const <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledWavelengths" class="code">SampledWavelengths</a> &amp;lambda) const;
       
       PBRT_CPU_GPU
       pstd::optional&lt;<a href="../Light_Sources/Light_Interface.html#LightLiSample" class="code">LightLiSample</a>&gt; SampleLi(<a href="../Light_Sources/Light_Interface.html#LightSampleContext" class="code">LightSampleContext</a> ctx, <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a> u,
                                              <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledWavelengths" class="code">SampledWavelengths</a> lambda,
                                              bool allowIncompletePDF) const;
       
       PBRT_CPU_GPU
       Float PDF_Li(<a href="../Light_Sources/Light_Interface.html#LightSampleContext" class="code">LightSampleContext</a>, <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a>, bool allowIncompletePDF) const;
       
       PBRT_CPU_GPU
       pstd::optional&lt;LightLeSample&gt; SampleLe(<a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a> u1, <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a> u2,
                                              <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledWavelengths" class="code">SampledWavelengths</a> &amp;lambda,
                                              Float time) const;
       PBRT_CPU_GPU
       void PDF_Le(const <a href="../Geometry_and_Transformations/Rays.html#Ray" class="code">Ray</a> &amp;, Float *pdfPos, Float *pdfDir) const;
       
       PBRT_CPU_GPU
       void PDF_Le(const <a href="../Geometry_and_Transformations/Interactions.html#Interaction" class="code">Interaction</a> &amp;, <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> w, Float *pdfPos, Float *pdfDir) const {
           LOG_FATAL("Shouldn't be called for non-area lights");
       }
       
       pstd::optional&lt;<a href="../Light_Sources/Light_Sampling.html#LightBounds" class="code">LightBounds</a>&gt; Bounds() const { return {}; }
       
       std::string ToString() const;</div></div>
  private:
    &lt;&lt;<span class="fragmentname"><a href="#fragment-PortalImageInfiniteLightPrivateMethods-0">PortalImageInfiniteLight Private Methods</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1690" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1690"><i></i></a><div id="fragbit-1690" class="collapse show"><div class="fragmentcode">       PBRT_CPU_GPU
       <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> ImageLookup(<a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a> uv,
                                   const <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledWavelengths" class="code">SampledWavelengths</a> &amp;lambda) const;
       pstd::optional&lt;<a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>&gt; <a href="#PortalImageInfiniteLight::ImageFromRender" class="code">ImageFromRender</a>(<a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> wRender,
                                               Float *duv_dw = nullptr) const {
           <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> w = <a href="#PortalImageInfiniteLight::portalFrame" class="code">portalFrame</a>.<a href="../Geometry_and_Transformations/Applying_Transformations.html#Frame::ToLocal" class="code">ToLocal</a>(wRender);
           if (w.z &lt;= 0) return {};
           &lt;&lt;<span class="fragmentname"><a href="#fragment-ComputeJacobiandeterminantofmappingromanduvromandomegaifneeded-0">Compute Jacobian determinant of mapping <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="10.494ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 4518.2 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">normal d left-parenthesis u comma v right-parenthesis slash normal d omega</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-64" d="M527 0l-147 -11v66c-25 -32 -70 -66 -134 -66c-114 0 -212 99 -212 226c0 129 105 227 223 227c54 0 97 -26 126 -62v216c0 49 -8 56 -78 56v31l144 11v-607c0 -49 8 -56 78 -56v-31zM380 118v205c0 18 0 20 -11 37c-31 45 -73 60 -108 60c-54 0 -92 -33 -113 -64 c-29 -45 -31 -105 -31 -142c0 -41 3 -98 29 -139c24 -38 60 -64 105 -64c43 0 88 22 118 70c11 17 11 19 11 37Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D462" d="M543 143c0 0 -13 -63 -30 -99c-16 -32 -39 -55 -74 -55c-43 0 -78 26 -89 67c-17 -22 -53 -67 -119 -67c-54 0 -123 25 -123 120c0 49 21 111 58 210c6 15 17 44 17 68c0 32 -16 33 -25 33c-38 0 -76 -37 -101 -124c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10 c0 9 37 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -17 -63c-26 -69 -54 -148 -54 -204c0 -37 10 -82 62 -82c73 0 113 80 114 84l75 301c8 34 34 35 39 35c15 0 29 -9 29 -27c0 -6 -10 -44 -15 -67c-4 -15 -14 -53 -17 -68l-28 -108c-8 -35 -20 -82 -20 -104 c0 -33 10 -46 31 -46c42 0 61 68 75 124c3 14 4 18 14 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D463" d="M468 372c0 -52 -57 -383 -225 -383c-46 0 -134 16 -134 124c0 43 13 89 57 205c7 18 17 45 17 70c0 32 -17 32 -25 32c-29 0 -72 -23 -101 -124c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 38 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -12 -50 c-31 -83 -58 -156 -58 -212c0 -52 23 -87 74 -87c117 0 178 229 178 271c0 36 -13 62 -34 82c-11 11 -16 17 -16 30c0 22 24 48 49 48c18 0 44 -16 44 -70Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2F" d="M445 730c0 -2 0 -5 -1 -7l-349 -960c-3 -8 -10 -13 -19 -13c-11 0 -20 9 -20 20c0 2 0 5 1 7l349 960c3 8 10 13 19 13c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-64" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="556" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D462" x="946" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="1518" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D463" x="1963" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="2449" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2F" x="2838" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-64" x="3339" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="3895" y="0"></use>
</g>
</svg> if needed</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1691" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1691"><i></i></a><div id="fragbit-1691" class="collapse show"><div class="fragmentcode">              if (duv_dw)
                  *duv_dw = <a href="../Utilities/Mathematical_Infrastructure.html#Sqr" class="code">Sqr</a>(<a href="../Utilities/Mathematical_Infrastructure.html#Pi" class="code">Pi</a>) * (1 - <a href="../Utilities/Mathematical_Infrastructure.html#Sqr" class="code">Sqr</a>(w.x)) * (1 - <a href="../Utilities/Mathematical_Infrastructure.html#Sqr" class="code">Sqr</a>(w.y)) / w.z;</div></div>
           Float alpha = std::atan2(w.x, w.z), beta = std::atan2(w.y, w.z);
           return <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(<a href="../Utilities/Mathematical_Infrastructure.html#Clamp" class="code">Clamp</a>((alpha + <a href="../Utilities/Mathematical_Infrastructure.html#Pi" class="code">Pi</a> / 2) / <a href="../Utilities/Mathematical_Infrastructure.html#Pi" class="code">Pi</a>, 0, 1),
                          <a href="../Utilities/Mathematical_Infrastructure.html#Clamp" class="code">Clamp</a>((beta + <a href="../Utilities/Mathematical_Infrastructure.html#Pi" class="code">Pi</a> / 2) / <a href="../Utilities/Mathematical_Infrastructure.html#Pi" class="code">Pi</a>, 0, 1));
       }
       <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> RenderFromImage(<a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a> uv, Float *duv_dw = nullptr) const {
           Float alpha = -<a href="../Utilities/Mathematical_Infrastructure.html#Pi" class="code">Pi</a> / 2 + uv[0] * <a href="../Utilities/Mathematical_Infrastructure.html#Pi" class="code">Pi</a>, beta = -<a href="../Utilities/Mathematical_Infrastructure.html#Pi" class="code">Pi</a> / 2 + uv[1] * <a href="../Utilities/Mathematical_Infrastructure.html#Pi" class="code">Pi</a>;
           Float x = std::tan(alpha), y = std::tan(beta);
           <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> w = <a href="../Geometry_and_Transformations/Vectors.html#Normalize" class="code">Normalize</a>(<a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a>(x, y, 1));
           &lt;&lt;<span class="fragmentname"><a href="#fragment-ComputeJacobiandeterminantofmappingromanduvromandomegaifneeded-0">Compute Jacobian determinant of mapping <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="10.494ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 4518.2 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">normal d left-parenthesis u comma v right-parenthesis slash normal d omega</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-64" d="M527 0l-147 -11v66c-25 -32 -70 -66 -134 -66c-114 0 -212 99 -212 226c0 129 105 227 223 227c54 0 97 -26 126 -62v216c0 49 -8 56 -78 56v31l144 11v-607c0 -49 8 -56 78 -56v-31zM380 118v205c0 18 0 20 -11 37c-31 45 -73 60 -108 60c-54 0 -92 -33 -113 -64 c-29 -45 -31 -105 -31 -142c0 -41 3 -98 29 -139c24 -38 60 -64 105 -64c43 0 88 22 118 70c11 17 11 19 11 37Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D462" d="M543 143c0 0 -13 -63 -30 -99c-16 -32 -39 -55 -74 -55c-43 0 -78 26 -89 67c-17 -22 -53 -67 -119 -67c-54 0 -123 25 -123 120c0 49 21 111 58 210c6 15 17 44 17 68c0 32 -16 33 -25 33c-38 0 -76 -37 -101 -124c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10 c0 9 37 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -17 -63c-26 -69 -54 -148 -54 -204c0 -37 10 -82 62 -82c73 0 113 80 114 84l75 301c8 34 34 35 39 35c15 0 29 -9 29 -27c0 -6 -10 -44 -15 -67c-4 -15 -14 -53 -17 -68l-28 -108c-8 -35 -20 -82 -20 -104 c0 -33 10 -46 31 -46c42 0 61 68 75 124c3 14 4 18 14 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D463" d="M468 372c0 -52 -57 -383 -225 -383c-46 0 -134 16 -134 124c0 43 13 89 57 205c7 18 17 45 17 70c0 32 -17 32 -25 32c-29 0 -72 -23 -101 -124c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 38 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -12 -50 c-31 -83 -58 -156 -58 -212c0 -52 23 -87 74 -87c117 0 178 229 178 271c0 36 -13 62 -34 82c-11 11 -16 17 -16 30c0 22 24 48 49 48c18 0 44 -16 44 -70Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2F" d="M445 730c0 -2 0 -5 -1 -7l-349 -960c-3 -8 -10 -13 -19 -13c-11 0 -20 9 -20 20c0 2 0 5 1 7l349 960c3 8 10 13 19 13c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-64" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="556" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D462" x="946" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="1518" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D463" x="1963" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="2449" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2F" x="2838" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-64" x="3339" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="3895" y="0"></use>
</g>
</svg> if needed</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1692" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1692"><i></i></a><div id="fragbit-1692" class="collapse show"><div class="fragmentcode">              if (duv_dw)
                  *duv_dw = <a href="../Utilities/Mathematical_Infrastructure.html#Sqr" class="code">Sqr</a>(<a href="../Utilities/Mathematical_Infrastructure.html#Pi" class="code">Pi</a>) * (1 - <a href="../Utilities/Mathematical_Infrastructure.html#Sqr" class="code">Sqr</a>(w.x)) * (1 - <a href="../Utilities/Mathematical_Infrastructure.html#Sqr" class="code">Sqr</a>(w.y)) / w.z;</div></div>
           return <a href="#PortalImageInfiniteLight::portalFrame" class="code">portalFrame</a>.<a href="../Geometry_and_Transformations/Applying_Transformations.html#Frame::FromLocal" class="code">FromLocal</a>(w);
       }
       pstd::optional&lt;<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds2f" class="code">Bounds2f</a>&gt; ImageBounds(<a href="../Geometry_and_Transformations/Points.html#Point3f" class="code">Point3f</a> p) const {
           pstd::optional&lt;<a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>&gt; p0 = <a href="#PortalImageInfiniteLight::ImageFromRender" class="code">ImageFromRender</a>(<a href="../Geometry_and_Transformations/Vectors.html#Normalize" class="code">Normalize</a>(<a href="#PortalImageInfiniteLight::portal" class="code">portal</a>[0] - p));
           pstd::optional&lt;<a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>&gt; p1 = <a href="#PortalImageInfiniteLight::ImageFromRender" class="code">ImageFromRender</a>(<a href="../Geometry_and_Transformations/Vectors.html#Normalize" class="code">Normalize</a>(<a href="#PortalImageInfiniteLight::portal" class="code">portal</a>[2] - p));
           if (!p0 || !p1) return {};
           return <a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds2f" class="code">Bounds2f</a>(*p0, *p1);
       }
       Float Area() const {
           return Length(<a href="#PortalImageInfiniteLight::portal" class="code">portal</a>[1] - <a href="#PortalImageInfiniteLight::portal" class="code">portal</a>[0]) * Length(<a href="#PortalImageInfiniteLight::portal" class="code">portal</a>[3] - <a href="#PortalImageInfiniteLight::portal" class="code">portal</a>[0]);
       }</div></div>
    &lt;&lt;<span class="fragmentname"><a href="#fragment-PortalImageInfiniteLightPrivateMembers-0">PortalImageInfiniteLight Private Members</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1693" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1693"><i></i></a><div id="fragbit-1693" class="collapse show"><div class="fragmentcode">       pstd::array&lt;<a href="../Geometry_and_Transformations/Points.html#Point3f" class="code">Point3f</a>, 4&gt; portal;
       <a href="../Geometry_and_Transformations/Applying_Transformations.html#Frame" class="code">Frame</a> portalFrame;
       <a href="../Utilities/Images.html#Image" class="code">Image</a> image;
       WindowedPiecewiseConstant2D distribution;
       const <a href="../Radiometry,_Spectra,_and_Color/Color.html#RGBColorSpace" class="code">RGBColorSpace</a> *imageColorSpace;
       Float scale;
       Float sceneRadius;
       std::string filename;
       <a href="../Geometry_and_Transformations/Points.html#Point3f" class="code">Point3f</a> sceneCenter;</div></div>
};</div><p>


</p>
<p>

</p>
<p>

</p>
<p> </p>
<span class="anchor" id="fig:portal-directions-to-map"></span><div class="card outerfigure"><div class="card-body figure"><p>



</p>
<div class="figure-row">
  <a href="pha12f20.svg" title=""><img src="pha12f20.svg" width=336 height=215 style="max-width: 100%;"></a>
</div>
<p>


</p>
<figcaption class="caption">Figure 12.20: <span class="legend"> Given a scene with a portal (opening in the box), for
each point in the scene we can find the set of directions that pass through
the portal.  To sample illumination efficiently, we would like to only
sample from the corresponding visible region of the environment map
(thick segment on the sphere).
</span>
</figcaption>
</div></div><p>


</p>
<p>Given a portal and a point in the scene, there is a set of directions from
that point that pass through the portal.  If we can find the corresponding
region of the environment map, then our task is to sample from it according
to the environment map&rsquo;s emission.  This idea is illustrated in
Figure&nbsp;<a href="#fig:portal-directions-to-map">12.20</a>.
With the equal-area mapping, the shape of the visible region
of the environment map seen from a given point can be complex.  The
problem is illustrated in
Figure&nbsp;<a href="#fig:portal-visible-env-map-regions">12.21</a>(a), which visualizes the
visible regions from two points in the scene from
Figure&nbsp;<a href="#fig:watercolor-sky-env-map">12.19</a>.

</p>
<p></p>
<span class="anchor" id="fig:portal-visible-env-map-regions"></span><div class="card outerfigure"><div class="card-body figure"><p>


</p>
<div class="figure-row">
  <a href="pha12f21.svg" title=""><img src="pha12f21.svg" width=754 height=406 style="max-width: 100%;"></a>
</div>
<p>

</p>
<figcaption class="caption">Figure 12.21: Shapes of Visible Regions of an Environment Map as Seen through a
Portal. <span class="legend">
These images illustrate the visible regions of the environment map
as seen through the window for a point on
the floor and a point on one of the paintings on the wall
for the scene in Figure&nbsp;<a href="#fig:watercolor-sky-env-map">12.19</a>.
(a)&nbsp;The equal-area mapping used by the <a href="#ImageInfiniteLight"><tt>ImageInfiniteLight</tt></a> is
convenient for sampling the entire environment map, but it leads to the
portal-visible regions having complex shapes.
(b)&nbsp;With the directional parameterization used by the
<a href="#PortalImageInfiniteLight"><tt>PortalImageInfiniteLight</tt></a>, the visible region is always rectangular,
which makes it feasible to sample from just that part of it.
<em>(Environment map courtesy of Sergej Majboroda, via Poly Haven.)</em>
</span>
</figcaption>
</div></div><p>


</p>
<p>The <a href="#PortalImageInfiniteLight"><tt>PortalImageInfiniteLight</tt></a> therefore uses a different
parameterization of directions that causes the visible region seen
through a portal to always be rectangular. Later in this section, we will see how
this property makes efficient sampling possible.

</p>
<p>The directional parameterization used by the <a href="#PortalImageInfiniteLight"><tt>PortalImageInfiniteLight</tt></a>
is based on a coordinate system where the <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.33ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 572.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">x</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D465" d="M527 376c0 -40 -32 -58 -54 -58c-27 0 -38 19 -38 35c0 24 20 49 48 54c-21 13 -45 13 -50 13c-70 0 -93 -92 -99 -118l-34 -137c-11 -44 -17 -66 -17 -88c0 -34 16 -66 55 -66c32 0 100 24 133 131c2 7 4 11 13 11c3 0 12 0 12 -10c0 -25 -57 -154 -160 -154 c-60 0 -96 39 -108 76c-3 -6 -39 -76 -105 -76c-44 0 -94 20 -94 66c0 32 25 58 55 58c15 0 37 -8 37 -35c0 -28 -22 -49 -47 -54c21 -13 44 -13 50 -13c44 0 79 42 95 104c37 140 54 207 54 238c0 58 -35 67 -54 67c-34 0 -100 -25 -134 -131c-2 -9 -5 -11 -13 -11 c0 0 -12 0 -12 10c0 25 57 154 161 154c29 0 83 -10 108 -76c12 23 47 76 105 76c34 0 93 -14 93 -66Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D465" x="0" y="0"></use>
</g>
</svg> and <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.139ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 490.5 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">y</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D466" d="M490 404c0 -7 0 -9 -4 -23l-96 -382c-28 -113 -131 -204 -234 -204c-62 0 -106 37 -106 87c0 49 33 65 56 65c10 0 37 -4 37 -35c0 -19 -10 -32 -20 -41c-14 -12 -27 -12 -43 -12c17 -39 62 -42 76 -42c46 0 84 29 110 63c40 53 52 102 65 154c-28 -28 -62 -45 -101 -45 c-59 0 -122 30 -122 119c0 47 18 104 58 210c7 19 17 45 17 70c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 37 154 132 154c50 0 82 -37 82 -82c0 -20 -4 -31 -20 -72c-34 -88 -51 -150 -51 -196c0 -37 11 -81 62 -81 c66 0 109 70 113 85l45 180l20 80c4 18 12 49 14 54c9 15 25 21 35 21c15 0 29 -9 29 -27Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D466" x="0" y="0"></use>
</g>
</svg> axes are aligned with the
edges of the portal.  Note that the position of the portal is not used in
defining this coordinate system&mdash;only the directions of its edges.
As a first indication that this idea is getting us somewhere,
consider the vectors from a point in the scene to the four corners of the
portal, transformed into this coordinate system.  It should be evident that
in this coordinate system, vectors to adjacent vertices
of the portal only differ in one of their <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.33ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 572.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">x</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D465" d="M527 376c0 -40 -32 -58 -54 -58c-27 0 -38 19 -38 35c0 24 20 49 48 54c-21 13 -45 13 -50 13c-70 0 -93 -92 -99 -118l-34 -137c-11 -44 -17 -66 -17 -88c0 -34 16 -66 55 -66c32 0 100 24 133 131c2 7 4 11 13 11c3 0 12 0 12 -10c0 -25 -57 -154 -160 -154 c-60 0 -96 39 -108 76c-3 -6 -39 -76 -105 -76c-44 0 -94 20 -94 66c0 32 25 58 55 58c15 0 37 -8 37 -35c0 -28 -22 -49 -47 -54c21 -13 44 -13 50 -13c44 0 79 42 95 104c37 140 54 207 54 238c0 58 -35 67 -54 67c-34 0 -100 -25 -134 -131c-2 -9 -5 -11 -13 -11 c0 0 -12 0 -12 10c0 25 57 154 161 154c29 0 83 -10 108 -76c12 23 47 76 105 76c34 0 93 -14 93 -66Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D465" x="0" y="0"></use>
</g>
</svg>
or <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.139ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 490.5 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">y</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D466" d="M490 404c0 -7 0 -9 -4 -23l-96 -382c-28 -113 -131 -204 -234 -204c-62 0 -106 37 -106 87c0 49 33 65 56 65c10 0 37 -4 37 -35c0 -19 -10 -32 -20 -41c-14 -12 -27 -12 -43 -12c17 -39 62 -42 76 -42c46 0 84 29 110 63c40 53 52 102 65 154c-28 -28 -62 -45 -101 -45 c-59 0 -122 30 -122 119c0 47 18 104 58 210c7 19 17 45 17 70c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 37 154 132 154c50 0 82 -37 82 -82c0 -20 -4 -31 -20 -72c-34 -88 -51 -150 -51 -196c0 -37 11 -81 62 -81 c66 0 109 70 113 85l45 180l20 80c4 18 12 49 14 54c9 15 25 21 35 21c15 0 29 -9 29 -27Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D466" x="0" y="0"></use>
</g>
</svg> coordinate values and that the four
directions thus span a rectangular region in <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.469ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 1063 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">x y</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D465" d="M527 376c0 -40 -32 -58 -54 -58c-27 0 -38 19 -38 35c0 24 20 49 48 54c-21 13 -45 13 -50 13c-70 0 -93 -92 -99 -118l-34 -137c-11 -44 -17 -66 -17 -88c0 -34 16 -66 55 -66c32 0 100 24 133 131c2 7 4 11 13 11c3 0 12 0 12 -10c0 -25 -57 -154 -160 -154 c-60 0 -96 39 -108 76c-3 -6 -39 -76 -105 -76c-44 0 -94 20 -94 66c0 32 25 58 55 58c15 0 37 -8 37 -35c0 -28 -22 -49 -47 -54c21 -13 44 -13 50 -13c44 0 79 42 95 104c37 140 54 207 54 238c0 58 -35 67 -54 67c-34 0 -100 -25 -134 -131c-2 -9 -5 -11 -13 -11 c0 0 -12 0 -12 10c0 25 57 154 161 154c29 0 83 -10 108 -76c12 23 47 76 105 76c34 0 93 -14 93 -66Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D466" d="M490 404c0 -7 0 -9 -4 -23l-96 -382c-28 -113 -131 -204 -234 -204c-62 0 -106 37 -106 87c0 49 33 65 56 65c10 0 37 -4 37 -35c0 -19 -10 -32 -20 -41c-14 -12 -27 -12 -43 -12c17 -39 62 -42 76 -42c46 0 84 29 110 63c40 53 52 102 65 154c-28 -28 -62 -45 -101 -45 c-59 0 -122 30 -122 119c0 47 18 104 58 210c7 19 17 45 17 70c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 37 154 132 154c50 0 82 -37 82 -82c0 -20 -4 -31 -20 -72c-34 -88 -51 -150 -51 -196c0 -37 11 -81 62 -81 c66 0 109 70 113 85l45 180l20 80c4 18 12 49 14 54c9 15 25 21 35 21c15 0 29 -9 29 -27Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D465" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D466" x="572" y="0"></use>
</g>
</svg>.  (If this is not
clear, it is a detail worth pausing to work through.)  We will term
directional representations that have this property as <em>rectified</em>.

</p>
<p>The <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.469ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 1063 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">x y</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D465" d="M527 376c0 -40 -32 -58 -54 -58c-27 0 -38 19 -38 35c0 24 20 49 48 54c-21 13 -45 13 -50 13c-70 0 -93 -92 -99 -118l-34 -137c-11 -44 -17 -66 -17 -88c0 -34 16 -66 55 -66c32 0 100 24 133 131c2 7 4 11 13 11c3 0 12 0 12 -10c0 -25 -57 -154 -160 -154 c-60 0 -96 39 -108 76c-3 -6 -39 -76 -105 -76c-44 0 -94 20 -94 66c0 32 25 58 55 58c15 0 37 -8 37 -35c0 -28 -22 -49 -47 -54c21 -13 44 -13 50 -13c44 0 79 42 95 104c37 140 54 207 54 238c0 58 -35 67 -54 67c-34 0 -100 -25 -134 -131c-2 -9 -5 -11 -13 -11 c0 0 -12 0 -12 10c0 25 57 154 161 154c29 0 83 -10 108 -76c12 23 47 76 105 76c34 0 93 -14 93 -66Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D466" d="M490 404c0 -7 0 -9 -4 -23l-96 -382c-28 -113 -131 -204 -234 -204c-62 0 -106 37 -106 87c0 49 33 65 56 65c10 0 37 -4 37 -35c0 -19 -10 -32 -20 -41c-14 -12 -27 -12 -43 -12c17 -39 62 -42 76 -42c46 0 84 29 110 63c40 53 52 102 65 154c-28 -28 -62 -45 -101 -45 c-59 0 -122 30 -122 119c0 47 18 104 58 210c7 19 17 45 17 70c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 37 154 132 154c50 0 82 -37 82 -82c0 -20 -4 -31 -20 -72c-34 -88 -51 -150 -51 -196c0 -37 11 -81 62 -81 c66 0 109 70 113 85l45 180l20 80c4 18 12 49 14 54c9 15 25 21 35 21c15 0 29 -9 29 -27Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D465" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D466" x="572" y="0"></use>
</g>
</svg> components of vectors in this coordinate system still span
<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="9.299ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 4003.7 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">left-parenthesis negative normal infinity comma normal infinity right-parenthesis</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2212" d="M722 250c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-221E" d="M943 216c0 -118 -76 -227 -192 -227c-79 0 -138 42 -170 69c-22 19 -23 20 -90 101c-13 -22 -102 -170 -246 -170c-119 0 -189 115 -189 226c0 118 76 227 192 227c79 0 138 -42 170 -69c22 -19 23 -20 90 -101c13 22 102 170 246 170c119 0 189 -115 189 -226zM921 216 c0 90 -54 194 -160 194c-113 0 -189 -105 -227 -173c28 -34 73 -97 101 -128c45 -49 86 -72 132 -72c84 0 154 79 154 179zM465 194c-28 34 -73 97 -101 128c-45 49 -86 72 -132 72c-84 0 -154 -79 -154 -179c0 -90 54 -194 160 -194c113 0 189 105 227 173Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2212" x="389" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-221E" x="1168" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="2168" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-221E" x="2613" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="3614" y="0"></use>
</g>
</svg>, so it is necessary to map them to a finite 2D domain if
the environment map is to be represented using an image.
It is important that this mapping does not interfere with the
axis-alignment of the portal edges and that rectification is preserved.  This
requirement rules out a number of possibilities, including both the
equirectangular and equal-area mappings.  Even normalizing a vector and
taking the <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.33ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 572.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">x</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D465" d="M527 376c0 -40 -32 -58 -54 -58c-27 0 -38 19 -38 35c0 24 20 49 48 54c-21 13 -45 13 -50 13c-70 0 -93 -92 -99 -118l-34 -137c-11 -44 -17 -66 -17 -88c0 -34 16 -66 55 -66c32 0 100 24 133 131c2 7 4 11 13 11c3 0 12 0 12 -10c0 -25 -57 -154 -160 -154 c-60 0 -96 39 -108 76c-3 -6 -39 -76 -105 -76c-44 0 -94 20 -94 66c0 32 25 58 55 58c15 0 37 -8 37 -35c0 -28 -22 -49 -47 -54c21 -13 44 -13 50 -13c44 0 79 42 95 104c37 140 54 207 54 238c0 58 -35 67 -54 67c-34 0 -100 -25 -134 -131c-2 -9 -5 -11 -13 -11 c0 0 -12 0 -12 10c0 25 57 154 161 154c29 0 83 -10 108 -76c12 23 47 76 105 76c34 0 93 -14 93 -66Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D465" x="0" y="0"></use>
</g>
</svg> and <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.139ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 490.5 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">y</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D466" d="M490 404c0 -7 0 -9 -4 -23l-96 -382c-28 -113 -131 -204 -234 -204c-62 0 -106 37 -106 87c0 49 33 65 56 65c10 0 37 -4 37 -35c0 -19 -10 -32 -20 -41c-14 -12 -27 -12 -43 -12c17 -39 62 -42 76 -42c46 0 84 29 110 63c40 53 52 102 65 154c-28 -28 -62 -45 -101 -45 c-59 0 -122 30 -122 119c0 47 18 104 58 210c7 19 17 45 17 70c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 37 154 132 154c50 0 82 -37 82 -82c0 -20 -4 -31 -20 -72c-34 -88 -51 -150 -51 -196c0 -37 11 -81 62 -81 c66 0 109 70 113 85l45 180l20 80c4 18 12 49 14 54c9 15 25 21 35 21c15 0 29 -9 29 -27Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D466" x="0" y="0"></use>
</g>
</svg> coordinates of the resulting unit vector is
unsuitable given this requirement.

</p>
<p>A mapping that does work is based on the angles <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.488ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 640.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">alpha</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D6FC" d="M602 383c0 0 -21 -117 -115 -235c-10 -12 -10 -14 -10 -35c0 -24 0 -102 31 -102c0 0 38 0 56 49c3 7 6 10 13 10c6 0 12 -3 12 -10c0 -16 -31 -71 -84 -71c-45 0 -78 31 -91 84c-76 -61 -148 -84 -211 -84c-102 0 -162 76 -162 169c0 141 132 284 269 284 c74 0 167 -49 167 -206v-62c47 59 80 135 98 198c5 18 5 21 15 21c11 0 12 -10 12 -10zM410 99c-2 17 -2 75 -2 112c0 78 0 209 -99 209c-35 0 -89 -19 -136 -92c-32 -51 -58 -159 -58 -208c0 -64 30 -109 90 -109c40 0 117 11 205 88Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D6FC" x="0" y="0"></use>
</g>
</svg> and
<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.334ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 574.5 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">beta</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D6FD" d="M574 574c0 -12 -2 -24 -5 -37c-11 -45 -41 -86 -81 -116c-10 -8 -20 -14 -30 -20c17 -11 31 -26 43 -43c20 -31 30 -68 30 -108c0 -20 -3 -42 -8 -64c-14 -53 -51 -104 -99 -140c-52 -38 -113 -57 -170 -57c-68 0 -114 40 -131 98l-68 -274c-1 -4 -5 -7 -10 -7h-5 c-6 0 -10 4 -10 12l154 615c34 136 125 273 245 273c47 0 89 -18 116 -50c18 -22 29 -51 29 -82zM518 592c0 19 -3 36 -12 51c-16 26 -44 40 -78 40c-110 0 -188 -129 -220 -255l-60 -242c-4 -17 -6 -33 -6 -49c0 -71 41 -126 113 -126c44 0 91 19 129 52 c39 35 61 82 73 128c7 29 12 59 12 87c0 25 -4 48 -14 69c-7 16 -17 29 -30 39c-25 -9 -50 -13 -75 -13c-35 0 -76 0 -76 24c0 0 0 5 1 7c7 27 49 27 85 27c24 0 47 -5 67 -13c9 5 18 12 26 19c31 29 49 67 58 105c5 17 7 34 7 50zM395 403c-11 3 -23 5 -36 5 c-24 0 -57 0 -60 -9c-1 -4 30 -4 52 -4c14 0 29 3 44 8Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D6FD" x="0" y="0"></use>
</g>
</svg> that the <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.33ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 572.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">x</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D465" d="M527 376c0 -40 -32 -58 -54 -58c-27 0 -38 19 -38 35c0 24 20 49 48 54c-21 13 -45 13 -50 13c-70 0 -93 -92 -99 -118l-34 -137c-11 -44 -17 -66 -17 -88c0 -34 16 -66 55 -66c32 0 100 24 133 131c2 7 4 11 13 11c3 0 12 0 12 -10c0 -25 -57 -154 -160 -154 c-60 0 -96 39 -108 76c-3 -6 -39 -76 -105 -76c-44 0 -94 20 -94 66c0 32 25 58 55 58c15 0 37 -8 37 -35c0 -28 -22 -49 -47 -54c21 -13 44 -13 50 -13c44 0 79 42 95 104c37 140 54 207 54 238c0 58 -35 67 -54 67c-34 0 -100 -25 -134 -131c-2 -9 -5 -11 -13 -11 c0 0 -12 0 -12 10c0 25 57 154 161 154c29 0 83 -10 108 -76c12 23 47 76 105 76c34 0 93 -14 93 -66Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D465" x="0" y="0"></use>
</g>
</svg> and <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.139ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 490.5 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">y</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D466" d="M490 404c0 -7 0 -9 -4 -23l-96 -382c-28 -113 -131 -204 -234 -204c-62 0 -106 37 -106 87c0 49 33 65 56 65c10 0 37 -4 37 -35c0 -19 -10 -32 -20 -41c-14 -12 -27 -12 -43 -12c17 -39 62 -42 76 -42c46 0 84 29 110 63c40 53 52 102 65 154c-28 -28 -62 -45 -101 -45 c-59 0 -122 30 -122 119c0 47 18 104 58 210c7 19 17 45 17 70c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 37 154 132 154c50 0 82 -37 82 -82c0 -20 -4 -31 -20 -72c-34 -88 -51 -150 -51 -196c0 -37 11 -81 62 -81 c66 0 109 70 113 85l45 180l20 80c4 18 12 49 14 54c9 15 25 21 35 21c15 0 29 -9 29 -27Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D466" x="0" y="0"></use>
</g>
</svg> coordinates of the vector respectively
make with the <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.086ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 467.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">z</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D467" d="M467 432c0 -4 -22 -52 -117 -145c-36 -36 -98 -90 -98 -90c-36 -31 -65 -56 -119 -114c9 3 27 3 27 3c21 0 36 -4 70 -17c21 -7 39 -13 59 -13c33 0 97 19 120 84c3 7 5 13 14 13c8 0 12 -5 12 -10c0 -27 -58 -154 -157 -154c-29 0 -47 16 -64 37c-25 29 -35 38 -58 38 c-32 0 -62 -27 -85 -62c-6 -11 -8 -13 -16 -13c0 0 -12 0 -12 10c0 7 35 64 103 131l90 84c19 16 103 88 139 131c-26 0 -37 0 -77 15c-23 8 -42 15 -63 15c-8 0 -66 -1 -85 -47c-2 -6 -4 -11 -13 -11s-12 6 -12 11c0 21 46 114 121 114c33 0 50 -20 69 -43 c15 -17 27 -32 51 -32s45 16 75 64c5 9 8 11 15 11c0 0 11 0 11 -10Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D467" x="0" y="0"></use>
</g>
</svg> axis, as illustrated in
Figure&nbsp;<a href="#fig:portal-vector-angles">12.22</a>.  These
angles are given&nbsp;by
</p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">
<span class="anchor" id="eq:portal-alpha-beta"></span><div class="displaymath"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="31.455ex" height="4.843ex" style="vertical-align: -1.838ex;" viewBox="0 -1293.7 13542.9 2085" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">left-parenthesis alpha comma beta right-parenthesis equals left-parenthesis arc tangent StartFraction x Over z EndFraction comma arc tangent StartFraction y Over z EndFraction right-parenthesis period</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D6FC" d="M602 383c0 0 -21 -117 -115 -235c-10 -12 -10 -14 -10 -35c0 -24 0 -102 31 -102c0 0 38 0 56 49c3 7 6 10 13 10c6 0 12 -3 12 -10c0 -16 -31 -71 -84 -71c-45 0 -78 31 -91 84c-76 -61 -148 -84 -211 -84c-102 0 -162 76 -162 169c0 141 132 284 269 284 c74 0 167 -49 167 -206v-62c47 59 80 135 98 198c5 18 5 21 15 21c11 0 12 -10 12 -10zM410 99c-2 17 -2 75 -2 112c0 78 0 209 -99 209c-35 0 -89 -19 -136 -92c-32 -51 -58 -159 -58 -208c0 -64 30 -109 90 -109c40 0 117 11 205 88Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D6FD" d="M574 574c0 -12 -2 -24 -5 -37c-11 -45 -41 -86 -81 -116c-10 -8 -20 -14 -30 -20c17 -11 31 -26 43 -43c20 -31 30 -68 30 -108c0 -20 -3 -42 -8 -64c-14 -53 -51 -104 -99 -140c-52 -38 -113 -57 -170 -57c-68 0 -114 40 -131 98l-68 -274c-1 -4 -5 -7 -10 -7h-5 c-6 0 -10 4 -10 12l154 615c34 136 125 273 245 273c47 0 89 -18 116 -50c18 -22 29 -51 29 -82zM518 592c0 19 -3 36 -12 51c-16 26 -44 40 -78 40c-110 0 -188 -129 -220 -255l-60 -242c-4 -17 -6 -33 -6 -49c0 -71 41 -126 113 -126c44 0 91 19 129 52 c39 35 61 82 73 128c7 29 12 59 12 87c0 25 -4 48 -14 69c-7 16 -17 29 -30 39c-25 -9 -50 -13 -75 -13c-35 0 -76 0 -76 24c0 0 0 5 1 7c7 27 49 27 85 27c24 0 47 -5 67 -13c9 5 18 12 26 19c31 29 49 67 58 105c5 17 7 34 7 50zM395 403c-11 3 -23 5 -36 5 c-24 0 -57 0 -60 -9c-1 -4 30 -4 52 -4c14 0 29 3 44 8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3D" d="M722 347c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20zM722 153c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-61" d="M483 89c0 -81 -61 -95 -82 -95c-47 0 -74 42 -78 82c-19 -47 -65 -87 -131 -87c-63 0 -160 25 -160 106c0 44 25 96 100 130c63 30 133 33 184 36v37c0 89 -57 128 -106 128c-32 0 -81 -11 -108 -46c46 -1 51 -34 51 -46c0 -26 -18 -46 -46 -46c-26 0 -46 17 -46 47 c0 66 69 113 151 113c48 0 98 -16 137 -55c36 -37 36 -76 36 -118v-200c0 -5 4 -50 37 -50c11 0 36 6 36 64v56h25v-56zM316 140v100c-165 -6 -207 -89 -207 -144c0 -50 41 -85 90 -85c45 0 117 34 117 129Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-72" d="M364 381c0 -32 -25 -44 -43 -44c-22 0 -43 15 -43 43c0 26 20 38 23 39c-2 1 -4 1 -11 1c-76 0 -118 -89 -118 -188v-154c0 -36 2 -47 76 -47h21v-31c-40 3 -87 3 -127 3l-114 -3v31c67 0 78 0 78 45v268c0 49 -8 56 -78 56v31l139 11v-110c14 43 50 110 123 110 c43 0 74 -29 74 -61Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-63" d="M415 119c0 -10 -32 -130 -166 -130c-116 0 -215 99 -215 227c0 124 92 232 217 232c77 0 153 -39 153 -107c0 -30 -20 -47 -46 -47c-28 0 -46 20 -46 46c0 13 6 43 47 46c-35 36 -98 37 -107 37c-53 0 -135 -42 -135 -205c0 -161 88 -204 141 -204c37 0 102 12 131 105 c2 6 4 10 13 10c3 0 13 0 13 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-74" d="M332 124c0 -64 -28 -135 -99 -135c-36 0 -129 12 -129 135v276h-85v22c98 4 128 111 129 193h25v-184h143v-31h-143v-278c0 -17 0 -108 67 -108c37 0 67 38 67 112v55h25v-57Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6E" d="M535 0l-112 3l-113 -3v31c67 0 78 0 78 45v233c0 57 -11 111 -74 111c-64 0 -135 -56 -135 -160v-184c0 -45 11 -45 78 -45v-31l-112 3l-113 -3v31c67 0 78 0 78 45v268c0 49 -8 56 -78 56v31l141 11v-105c28 62 75 105 148 105c58 0 91 -20 105 -37 c31 -36 31 -67 31 -153v-191c1 -30 26 -30 78 -30v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D465" d="M527 376c0 -40 -32 -58 -54 -58c-27 0 -38 19 -38 35c0 24 20 49 48 54c-21 13 -45 13 -50 13c-70 0 -93 -92 -99 -118l-34 -137c-11 -44 -17 -66 -17 -88c0 -34 16 -66 55 -66c32 0 100 24 133 131c2 7 4 11 13 11c3 0 12 0 12 -10c0 -25 -57 -154 -160 -154 c-60 0 -96 39 -108 76c-3 -6 -39 -76 -105 -76c-44 0 -94 20 -94 66c0 32 25 58 55 58c15 0 37 -8 37 -35c0 -28 -22 -49 -47 -54c21 -13 44 -13 50 -13c44 0 79 42 95 104c37 140 54 207 54 238c0 58 -35 67 -54 67c-34 0 -100 -25 -134 -131c-2 -9 -5 -11 -13 -11 c0 0 -12 0 -12 10c0 25 57 154 161 154c29 0 83 -10 108 -76c12 23 47 76 105 76c34 0 93 -14 93 -66Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D467" d="M467 432c0 -4 -22 -52 -117 -145c-36 -36 -98 -90 -98 -90c-36 -31 -65 -56 -119 -114c9 3 27 3 27 3c21 0 36 -4 70 -17c21 -7 39 -13 59 -13c33 0 97 19 120 84c3 7 5 13 14 13c8 0 12 -5 12 -10c0 -27 -58 -154 -157 -154c-29 0 -47 16 -64 37c-25 29 -35 38 -58 38 c-32 0 -62 -27 -85 -62c-6 -11 -8 -13 -16 -13c0 0 -12 0 -12 10c0 7 35 64 103 131l90 84c19 16 103 88 139 131c-26 0 -37 0 -77 15c-23 8 -42 15 -63 15c-8 0 -66 -1 -85 -47c-2 -6 -4 -11 -13 -11s-12 6 -12 11c0 21 46 114 121 114c33 0 50 -20 69 -43 c15 -17 27 -32 51 -32s45 16 75 64c5 9 8 11 15 11c0 0 11 0 11 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D466" d="M490 404c0 -7 0 -9 -4 -23l-96 -382c-28 -113 -131 -204 -234 -204c-62 0 -106 37 -106 87c0 49 33 65 56 65c10 0 37 -4 37 -35c0 -19 -10 -32 -20 -41c-14 -12 -27 -12 -43 -12c17 -39 62 -42 76 -42c46 0 84 29 110 63c40 53 52 102 65 154c-28 -28 -62 -45 -101 -45 c-59 0 -122 30 -122 119c0 47 18 104 58 210c7 19 17 45 17 70c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 37 154 132 154c50 0 82 -37 82 -82c0 -20 -4 -31 -20 -72c-34 -88 -51 -150 -51 -196c0 -37 11 -81 62 -81 c66 0 109 70 113 85l45 180l20 80c4 18 12 49 14 54c9 15 25 21 35 21c15 0 29 -9 29 -27Z"></path>
<path stroke-width="1" id="E1-LATINMODERNSIZE4-28" d="M539 -632c0 -8 -6 -14 -14 -14c-3 0 -6 1 -9 2c-175 132 -337 475 -337 776v236c0 301 162 644 337 776c3 1 6 2 9 2c8 0 14 -6 14 -14c0 -5 -2 -9 -5 -12c-167 -125 -283 -466 -283 -752v-236c0 -286 116 -627 283 -752c3 -3 5 -7 5 -12Z"></path>
<path stroke-width="1" id="E1-LATINMODERNSIZE4-29" d="M418 132c0 -301 -162 -644 -337 -776c-3 -1 -6 -2 -9 -2c-8 0 -14 6 -14 14c0 5 2 9 5 12c167 125 283 466 283 752v236c0 286 -116 627 -283 752c-3 3 -5 7 -5 12c0 8 6 14 14 14c3 0 6 -1 9 -2c175 -132 337 -475 337 -776v-236Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2E" d="M192 53c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D6FC" x="389" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="1030" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D6FD" x="1475" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="2049" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="2716" y="0"></use>
<g transform="translate(3773,0)">
 <use xlink:href="#E1-LATINMODERNSIZE4-28"></use>
<g transform="translate(597,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-61"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-72" x="500" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-63" x="893" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-74" x="1337" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-61" x="1727" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-6E" x="2227" y="0"></use>
</g>
<g transform="translate(3548,0)">
<g transform="translate(120,0)">
<rect stroke="none" width="692" height="60" x="0" y="220"></rect>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D465" x="60" y="676"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D467" x="112" y="-686"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="4480" y="0"></use>
<g transform="translate(4925,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-61"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-72" x="500" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-63" x="893" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-74" x="1337" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-61" x="1727" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-6E" x="2227" y="0"></use>
</g>
<g transform="translate(7876,0)">
<g transform="translate(120,0)">
<rect stroke="none" width="610" height="60" x="0" y="220"></rect>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D466" x="60" y="725"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D467" x="71" y="-686"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNSIZE4-29" x="8727" y="0"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2E" x="13264" y="0"></use>
</g>
</svg>
</div>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">
<div class="eqno">(<a href="#eq:portal-alpha-beta">12.1</a>)</div>
</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">
<p>

We can ignore vectors with negative <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.086ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 467.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">z</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D467" d="M467 432c0 -4 -22 -52 -117 -145c-36 -36 -98 -90 -98 -90c-36 -31 -65 -56 -119 -114c9 3 27 3 27 3c21 0 36 -4 70 -17c21 -7 39 -13 59 -13c33 0 97 19 120 84c3 7 5 13 14 13c8 0 12 -5 12 -10c0 -27 -58 -154 -157 -154c-29 0 -47 16 -64 37c-25 29 -35 38 -58 38 c-32 0 -62 -27 -85 -62c-6 -11 -8 -13 -16 -13c0 0 -12 0 -12 10c0 7 35 64 103 131l90 84c19 16 103 88 139 131c-26 0 -37 0 -77 15c-23 8 -42 15 -63 15c-8 0 -66 -1 -85 -47c-2 -6 -4 -11 -13 -11s-12 6 -12 11c0 21 46 114 121 114c33 0 50 -20 69 -43 c15 -17 27 -32 51 -32s45 16 75 64c5 9 8 11 15 11c0 0 11 0 11 -10Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D467" x="0" y="0"></use>
</g>
</svg> components in the rectified
coordinate system: they face away from the
portal and thus do not receive any illumination.  Each of <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.488ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 640.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">alpha</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D6FC" d="M602 383c0 0 -21 -117 -115 -235c-10 -12 -10 -14 -10 -35c0 -24 0 -102 31 -102c0 0 38 0 56 49c3 7 6 10 13 10c6 0 12 -3 12 -10c0 -16 -31 -71 -84 -71c-45 0 -78 31 -91 84c-76 -61 -148 -84 -211 -84c-102 0 -162 76 -162 169c0 141 132 284 269 284 c74 0 167 -49 167 -206v-62c47 59 80 135 98 198c5 18 5 21 15 21c11 0 12 -10 12 -10zM410 99c-2 17 -2 75 -2 112c0 78 0 209 -99 209c-35 0 -89 -19 -136 -92c-32 -51 -58 -159 -58 -208c0 -64 30 -109 90 -109c40 0 117 11 205 88Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D6FC" x="0" y="0"></use>
</g>
</svg> and
<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.334ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 574.5 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">beta</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D6FD" d="M574 574c0 -12 -2 -24 -5 -37c-11 -45 -41 -86 -81 -116c-10 -8 -20 -14 -30 -20c17 -11 31 -26 43 -43c20 -31 30 -68 30 -108c0 -20 -3 -42 -8 -64c-14 -53 -51 -104 -99 -140c-52 -38 -113 -57 -170 -57c-68 0 -114 40 -131 98l-68 -274c-1 -4 -5 -7 -10 -7h-5 c-6 0 -10 4 -10 12l154 615c34 136 125 273 245 273c47 0 89 -18 116 -50c18 -22 29 -51 29 -82zM518 592c0 19 -3 36 -12 51c-16 26 -44 40 -78 40c-110 0 -188 -129 -220 -255l-60 -242c-4 -17 -6 -33 -6 -49c0 -71 41 -126 113 -126c44 0 91 19 129 52 c39 35 61 82 73 128c7 29 12 59 12 87c0 25 -4 48 -14 69c-7 16 -17 29 -30 39c-25 -9 -50 -13 -75 -13c-35 0 -76 0 -76 24c0 0 0 5 1 7c7 27 49 27 85 27c24 0 47 -5 67 -13c9 5 18 12 26 19c31 29 49 67 58 105c5 17 7 34 7 50zM395 403c-11 3 -23 5 -36 5 c-24 0 -57 0 -60 -9c-1 -4 30 -4 52 -4c14 0 29 3 44 8Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D6FD" x="0" y="0"></use>
</g>
</svg> then spans the range <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="11.436ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 4923.7 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">left-bracket negative pi slash 2 comma pi slash 2 right-bracket</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-5B" d="M256 -230c0 -11 -9 -20 -20 -20h-122v1000h122c11 0 20 -9 20 -20s-9 -20 -20 -20h-82v-920h82c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2212" d="M722 250c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D70B" d="M567 407c0 -34 -36 -34 -49 -34h-114c-11 -52 -18 -106 -18 -159c0 -28 0 -93 29 -165c6 -14 6 -16 6 -22c0 -20 -21 -38 -41 -38c-15 0 -26 6 -36 50c-8 34 -8 61 -8 76c0 67 9 110 42 258h-113l-56 -221c-13 -50 -13 -52 -27 -98c-12 -37 -20 -65 -50 -65 c-13 0 -29 8 -29 27c0 7 0 9 8 24c42 91 96 212 128 333h-57c-20 0 -78 0 -127 -77c-6 -8 -8 -12 -16 -12c-12 0 -12 10 -12 10c0 5 26 51 61 90c44 47 82 47 104 47h335c19 0 40 0 40 -24Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2F" d="M445 730c0 -2 0 -5 -1 -7l-349 -960c-3 -8 -10 -13 -19 -13c-11 0 -20 9 -20 20c0 2 0 5 1 7l349 960c3 8 10 13 19 13c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-32" d="M449 174l-28 -174h-371c0 24 0 26 11 37l192 214c55 62 105 141 105 221c0 82 -43 163 -134 163c-58 0 -112 -37 -135 -102c3 1 5 1 13 1c35 0 53 -26 53 -52c0 -41 -35 -53 -52 -53c-3 0 -53 0 -53 56c0 89 74 181 187 181c122 0 212 -80 212 -194 c0 -100 -60 -154 -216 -292l-106 -103h180c22 0 88 0 95 8c10 15 17 59 22 89h25Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-5D" d="M164 -250h-122c-11 0 -20 9 -20 20s9 20 20 20h82v920h-82c-11 0 -20 9 -20 20s9 20 20 20h122v-1000Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-5B" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2212" x="278" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D70B" x="1057" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2F" x="1627" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-32" x="2128" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="2628" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D70B" x="3073" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2F" x="3644" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-32" x="4144" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-5D" x="4645" y="0"></use>
</g>
</svg> and the pair of them can be
easily mapped to <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.707ex" height="3.009ex" style="vertical-align: -0.838ex;" viewBox="0 -934.9 2457.1 1295.7" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">left-bracket 0 comma 1 right-bracket squared</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-5B" d="M256 -230c0 -11 -9 -20 -20 -20h-122v1000h122c11 0 20 -9 20 -20s-9 -20 -20 -20h-82v-920h82c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-30" d="M460 320c0 -79 -5 -157 -37 -226c-44 -95 -120 -116 -174 -116c-49 0 -122 20 -165 101c-41 76 -45 166 -45 241c0 80 5 158 37 227c41 93 114 119 174 119c42 0 124 -16 170 -112c35 -74 40 -154 40 -234zM377 332c0 63 0 139 -10 195c-19 99 -85 117 -118 117 c-25 0 -100 -9 -119 -128c-8 -54 -8 -120 -8 -184c0 -59 0 -151 11 -211c18 -96 77 -121 116 -121c45 0 102 30 117 125c11 64 11 132 11 207Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-5D" d="M164 -250h-122c-11 0 -20 9 -20 20s9 20 20 20h82v920h-82c-11 0 -20 9 -20 20s9 20 20 20h122v-1000Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-32" d="M449 174l-28 -174h-371c0 24 0 26 11 37l192 214c55 62 105 141 105 221c0 82 -43 163 -134 163c-58 0 -112 -37 -135 -102c3 1 5 1 13 1c35 0 53 -26 53 -52c0 -41 -35 -53 -52 -53c-3 0 -53 0 -53 56c0 89 74 181 187 181c122 0 212 -80 212 -194 c0 -100 -60 -154 -216 -292l-106 -103h180c22 0 88 0 95 8c10 15 17 59 22 89h25Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-5B" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-30" x="278" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="779" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-31" x="1224" y="0"></use>
<g transform="translate(1724,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-5D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-32" x="393" y="513"></use>
</g>
</g>
</svg> <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.301ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 2282.2 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">left-parenthesis u comma v right-parenthesis</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D462" d="M543 143c0 0 -13 -63 -30 -99c-16 -32 -39 -55 -74 -55c-43 0 -78 26 -89 67c-17 -22 -53 -67 -119 -67c-54 0 -123 25 -123 120c0 49 21 111 58 210c6 15 17 44 17 68c0 32 -16 33 -25 33c-38 0 -76 -37 -101 -124c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10 c0 9 37 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -17 -63c-26 -69 -54 -148 -54 -204c0 -37 10 -82 62 -82c73 0 113 80 114 84l75 301c8 34 34 35 39 35c15 0 29 -9 29 -27c0 -6 -10 -44 -15 -67c-4 -15 -14 -53 -17 -68l-28 -108c-8 -35 -20 -82 -20 -104 c0 -33 10 -46 31 -46c42 0 61 68 75 124c3 14 4 18 14 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D463" d="M468 372c0 -52 -57 -383 -225 -383c-46 0 -134 16 -134 124c0 43 13 89 57 205c7 18 17 45 17 70c0 32 -17 32 -25 32c-29 0 -72 -23 -101 -124c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 38 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -12 -50 c-31 -83 -58 -156 -58 -212c0 -52 23 -87 74 -87c117 0 178 229 178 271c0 36 -13 62 -34 82c-11 11 -16 17 -16 30c0 22 24 48 49 48c18 0 44 -16 44 -70Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D462" x="389" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="962" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D463" x="1407" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="1892" y="0"></use>
</g>
</svg> image coordinates.
The environment map resampled into
this parameterization is shown in
Figure&nbsp;<a href="#fig:portal-visible-env-map-regions">12.21</a>(b), with the visible
regions for the same two points in the scene indicated.

</p>
<p></p>
<span class="anchor" id="fig:portal-vector-angles"></span><div class="card outerfigure"><div class="card-body figure"><p>



</p>
<div class="figure-row">
  <a href="pha12f22.svg" title=""><img src="pha12f22.svg" width=581 height=236 style="max-width: 100%;"></a>
</div>
<p>


</p>
<figcaption class="caption">Figure 12.22: <span class="legend">
Vectors in the portal&rsquo;s coordinate system can be represented by
a pair of angles <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.665ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 2439.2 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">left-parenthesis alpha comma beta right-parenthesis</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D6FC" d="M602 383c0 0 -21 -117 -115 -235c-10 -12 -10 -14 -10 -35c0 -24 0 -102 31 -102c0 0 38 0 56 49c3 7 6 10 13 10c6 0 12 -3 12 -10c0 -16 -31 -71 -84 -71c-45 0 -78 31 -91 84c-76 -61 -148 -84 -211 -84c-102 0 -162 76 -162 169c0 141 132 284 269 284 c74 0 167 -49 167 -206v-62c47 59 80 135 98 198c5 18 5 21 15 21c11 0 12 -10 12 -10zM410 99c-2 17 -2 75 -2 112c0 78 0 209 -99 209c-35 0 -89 -19 -136 -92c-32 -51 -58 -159 -58 -208c0 -64 30 -109 90 -109c40 0 117 11 205 88Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D6FD" d="M574 574c0 -12 -2 -24 -5 -37c-11 -45 -41 -86 -81 -116c-10 -8 -20 -14 -30 -20c17 -11 31 -26 43 -43c20 -31 30 -68 30 -108c0 -20 -3 -42 -8 -64c-14 -53 -51 -104 -99 -140c-52 -38 -113 -57 -170 -57c-68 0 -114 40 -131 98l-68 -274c-1 -4 -5 -7 -10 -7h-5 c-6 0 -10 4 -10 12l154 615c34 136 125 273 245 273c47 0 89 -18 116 -50c18 -22 29 -51 29 -82zM518 592c0 19 -3 36 -12 51c-16 26 -44 40 -78 40c-110 0 -188 -129 -220 -255l-60 -242c-4 -17 -6 -33 -6 -49c0 -71 41 -126 113 -126c44 0 91 19 129 52 c39 35 61 82 73 128c7 29 12 59 12 87c0 25 -4 48 -14 69c-7 16 -17 29 -30 39c-25 -9 -50 -13 -75 -13c-35 0 -76 0 -76 24c0 0 0 5 1 7c7 27 49 27 85 27c24 0 47 -5 67 -13c9 5 18 12 26 19c31 29 49 67 58 105c5 17 7 34 7 50zM395 403c-11 3 -23 5 -36 5 c-24 0 -57 0 -60 -9c-1 -4 30 -4 52 -4c14 0 29 3 44 8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D6FC" x="389" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="1030" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D6FD" x="1475" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="2049" y="0"></use>
</g>
</svg> that measure the angle made by the <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.33ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 572.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">x</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D465" d="M527 376c0 -40 -32 -58 -54 -58c-27 0 -38 19 -38 35c0 24 20 49 48 54c-21 13 -45 13 -50 13c-70 0 -93 -92 -99 -118l-34 -137c-11 -44 -17 -66 -17 -88c0 -34 16 -66 55 -66c32 0 100 24 133 131c2 7 4 11 13 11c3 0 12 0 12 -10c0 -25 -57 -154 -160 -154 c-60 0 -96 39 -108 76c-3 -6 -39 -76 -105 -76c-44 0 -94 20 -94 66c0 32 25 58 55 58c15 0 37 -8 37 -35c0 -28 -22 -49 -47 -54c21 -13 44 -13 50 -13c44 0 79 42 95 104c37 140 54 207 54 238c0 58 -35 67 -54 67c-34 0 -100 -25 -134 -131c-2 -9 -5 -11 -13 -11 c0 0 -12 0 -12 10c0 25 57 154 161 154c29 0 83 -10 108 -76c12 23 47 76 105 76c34 0 93 -14 93 -66Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D465" x="0" y="0"></use>
</g>
</svg> or
<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.139ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 490.5 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">y</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D466" d="M490 404c0 -7 0 -9 -4 -23l-96 -382c-28 -113 -131 -204 -234 -204c-62 0 -106 37 -106 87c0 49 33 65 56 65c10 0 37 -4 37 -35c0 -19 -10 -32 -20 -41c-14 -12 -27 -12 -43 -12c17 -39 62 -42 76 -42c46 0 84 29 110 63c40 53 52 102 65 154c-28 -28 -62 -45 -101 -45 c-59 0 -122 30 -122 119c0 47 18 104 58 210c7 19 17 45 17 70c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 37 154 132 154c50 0 82 -37 82 -82c0 -20 -4 -31 -20 -72c-34 -88 -51 -150 -51 -196c0 -37 11 -81 62 -81 c66 0 109 70 113 85l45 180l20 80c4 18 12 49 14 54c9 15 25 21 35 21c15 0 29 -9 29 -27Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D466" x="0" y="0"></use>
</g>
</svg> component, respectively, with the <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.086ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 467.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">z</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D467" d="M467 432c0 -4 -22 -52 -117 -145c-36 -36 -98 -90 -98 -90c-36 -31 -65 -56 -119 -114c9 3 27 3 27 3c21 0 36 -4 70 -17c21 -7 39 -13 59 -13c33 0 97 19 120 84c3 7 5 13 14 13c8 0 12 -5 12 -10c0 -27 -58 -154 -157 -154c-29 0 -47 16 -64 37c-25 29 -35 38 -58 38 c-32 0 -62 -27 -85 -62c-6 -11 -8 -13 -16 -13c0 0 -12 0 -12 10c0 7 35 64 103 131l90 84c19 16 103 88 139 131c-26 0 -37 0 -77 15c-23 8 -42 15 -63 15c-8 0 -66 -1 -85 -47c-2 -6 -4 -11 -13 -11s-12 6 -12 11c0 21 46 114 121 114c33 0 50 -20 69 -43 c15 -17 27 -32 51 -32s45 16 75 64c5 9 8 11 15 11c0 0 11 0 11 -10Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D467" x="0" y="0"></use>
</g>
</svg> axis.
</span>
</figcaption>
</div></div><p>


</p>
<p>We will start the implementation of the <a href="#PortalImageInfiniteLight"><tt>PortalImageInfiniteLight</tt></a> with
its <tt>ImageFromRender()</tt> method, which applies this mapping
to a vector in the rendering coordinate system <tt>wRender</tt>.  (We will
come to the initialization of the <tt>portalFrame</tt> member variable in the
<tt>PortalImageInfiniteLight</tt> constructor later in this section.)  It uses
<tt>pstd::optional</tt> for the return value in order to be able to return an
invalid result in the case that the vector is coplanar with the portal or
facing away from it.

</p>
<p></p>
<span class="anchor" id="fragment-PortalImageInfiniteLightPrivateMethods-0"></span><div class="fragmentname">&lt;&lt;PortalImageInfiniteLight Private Methods&gt;&gt;=&nbsp;<a href="#fragment-PortalImageInfiniteLightPrivateMethods-1"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode">pstd::optional&lt;<a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>&gt; <span class="anchor" id="PortalImageInfiniteLight::ImageFromRender"></span>ImageFromRender(<a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> wRender,
                                        Float *duv_dw = nullptr) const {
    <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> w = <a href="#PortalImageInfiniteLight::portalFrame" class="code">portalFrame</a>.<a href="../Geometry_and_Transformations/Applying_Transformations.html#Frame::ToLocal" class="code">ToLocal</a>(wRender);
    if (w.z &lt;= 0) return {};
    &lt;&lt;<span class="fragmentname"><a href="#fragment-ComputeJacobiandeterminantofmappingromanduvromandomegaifneeded-0">Compute Jacobian determinant of mapping <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="10.494ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 4518.2 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">normal d left-parenthesis u comma v right-parenthesis slash normal d omega</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-64" d="M527 0l-147 -11v66c-25 -32 -70 -66 -134 -66c-114 0 -212 99 -212 226c0 129 105 227 223 227c54 0 97 -26 126 -62v216c0 49 -8 56 -78 56v31l144 11v-607c0 -49 8 -56 78 -56v-31zM380 118v205c0 18 0 20 -11 37c-31 45 -73 60 -108 60c-54 0 -92 -33 -113 -64 c-29 -45 -31 -105 -31 -142c0 -41 3 -98 29 -139c24 -38 60 -64 105 -64c43 0 88 22 118 70c11 17 11 19 11 37Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D462" d="M543 143c0 0 -13 -63 -30 -99c-16 -32 -39 -55 -74 -55c-43 0 -78 26 -89 67c-17 -22 -53 -67 -119 -67c-54 0 -123 25 -123 120c0 49 21 111 58 210c6 15 17 44 17 68c0 32 -16 33 -25 33c-38 0 -76 -37 -101 -124c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10 c0 9 37 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -17 -63c-26 -69 -54 -148 -54 -204c0 -37 10 -82 62 -82c73 0 113 80 114 84l75 301c8 34 34 35 39 35c15 0 29 -9 29 -27c0 -6 -10 -44 -15 -67c-4 -15 -14 -53 -17 -68l-28 -108c-8 -35 -20 -82 -20 -104 c0 -33 10 -46 31 -46c42 0 61 68 75 124c3 14 4 18 14 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D463" d="M468 372c0 -52 -57 -383 -225 -383c-46 0 -134 16 -134 124c0 43 13 89 57 205c7 18 17 45 17 70c0 32 -17 32 -25 32c-29 0 -72 -23 -101 -124c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 38 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -12 -50 c-31 -83 -58 -156 -58 -212c0 -52 23 -87 74 -87c117 0 178 229 178 271c0 36 -13 62 -34 82c-11 11 -16 17 -16 30c0 22 24 48 49 48c18 0 44 -16 44 -70Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2F" d="M445 730c0 -2 0 -5 -1 -7l-349 -960c-3 -8 -10 -13 -19 -13c-11 0 -20 9 -20 20c0 2 0 5 1 7l349 960c3 8 10 13 19 13c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-64" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="556" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D462" x="946" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="1518" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D463" x="1963" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="2449" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2F" x="2838" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-64" x="3339" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="3895" y="0"></use>
</g>
</svg> if needed</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1694" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1694"><i></i></a><div id="fragbit-1694" class="collapse show"><div class="fragmentcode">       if (duv_dw)
           *duv_dw = <a href="../Utilities/Mathematical_Infrastructure.html#Sqr" class="code">Sqr</a>(<a href="../Utilities/Mathematical_Infrastructure.html#Pi" class="code">Pi</a>) * (1 - <a href="../Utilities/Mathematical_Infrastructure.html#Sqr" class="code">Sqr</a>(w.x)) * (1 - <a href="../Utilities/Mathematical_Infrastructure.html#Sqr" class="code">Sqr</a>(w.y)) / w.z;</div></div>
    Float alpha = std::atan2(w.x, w.z), beta = std::atan2(w.y, w.z);
    return <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(<a href="../Utilities/Mathematical_Infrastructure.html#Clamp" class="code">Clamp</a>((alpha + <a href="../Utilities/Mathematical_Infrastructure.html#Pi" class="code">Pi</a> / 2) / <a href="../Utilities/Mathematical_Infrastructure.html#Pi" class="code">Pi</a>, 0, 1),
                   <a href="../Utilities/Mathematical_Infrastructure.html#Clamp" class="code">Clamp</a>((beta + <a href="../Utilities/Mathematical_Infrastructure.html#Pi" class="code">Pi</a> / 2) / <a href="../Utilities/Mathematical_Infrastructure.html#Pi" class="code">Pi</a>, 0, 1));
}</div><p>


</p>
<p>We will find it useful to be able to convert sampling densities from
the <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.301ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 2282.2 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">left-parenthesis u comma v right-parenthesis</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D462" d="M543 143c0 0 -13 -63 -30 -99c-16 -32 -39 -55 -74 -55c-43 0 -78 26 -89 67c-17 -22 -53 -67 -119 -67c-54 0 -123 25 -123 120c0 49 21 111 58 210c6 15 17 44 17 68c0 32 -16 33 -25 33c-38 0 -76 -37 -101 -124c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10 c0 9 37 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -17 -63c-26 -69 -54 -148 -54 -204c0 -37 10 -82 62 -82c73 0 113 80 114 84l75 301c8 34 34 35 39 35c15 0 29 -9 29 -27c0 -6 -10 -44 -15 -67c-4 -15 -14 -53 -17 -68l-28 -108c-8 -35 -20 -82 -20 -104 c0 -33 10 -46 31 -46c42 0 61 68 75 124c3 14 4 18 14 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D463" d="M468 372c0 -52 -57 -383 -225 -383c-46 0 -134 16 -134 124c0 43 13 89 57 205c7 18 17 45 17 70c0 32 -17 32 -25 32c-29 0 -72 -23 -101 -124c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 38 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -12 -50 c-31 -83 -58 -156 -58 -212c0 -52 23 -87 74 -87c117 0 178 229 178 271c0 36 -13 62 -34 82c-11 11 -16 17 -16 30c0 22 24 48 49 48c18 0 44 -16 44 -70Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D462" x="389" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="962" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D463" x="1407" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="1892" y="0"></use>
</g>
</svg> parameterization of the image to be with
respect to solid angle on the unit sphere.
The appropriate factor can be found following the usual approach of
computing the determinant of the Jacobian of the mapping function, which is
based on Equation&nbsp;(<a href="#eq:portal-alpha-beta">12.1</a>), and then rescaling the
coordinates to image coordinates in <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.707ex" height="3.009ex" style="vertical-align: -0.838ex;" viewBox="0 -934.9 2457.1 1295.7" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">left-bracket 0 comma 1 right-bracket squared</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-5B" d="M256 -230c0 -11 -9 -20 -20 -20h-122v1000h122c11 0 20 -9 20 -20s-9 -20 -20 -20h-82v-920h82c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-30" d="M460 320c0 -79 -5 -157 -37 -226c-44 -95 -120 -116 -174 -116c-49 0 -122 20 -165 101c-41 76 -45 166 -45 241c0 80 5 158 37 227c41 93 114 119 174 119c42 0 124 -16 170 -112c35 -74 40 -154 40 -234zM377 332c0 63 0 139 -10 195c-19 99 -85 117 -118 117 c-25 0 -100 -9 -119 -128c-8 -54 -8 -120 -8 -184c0 -59 0 -151 11 -211c18 -96 77 -121 116 -121c45 0 102 30 117 125c11 64 11 132 11 207Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-5D" d="M164 -250h-122c-11 0 -20 9 -20 20s9 20 20 20h82v920h-82c-11 0 -20 9 -20 20s9 20 20 20h122v-1000Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-32" d="M449 174l-28 -174h-371c0 24 0 26 11 37l192 214c55 62 105 141 105 221c0 82 -43 163 -134 163c-58 0 -112 -37 -135 -102c3 1 5 1 13 1c35 0 53 -26 53 -52c0 -41 -35 -53 -52 -53c-3 0 -53 0 -53 56c0 89 74 181 187 181c122 0 212 -80 212 -194 c0 -100 -60 -154 -216 -292l-106 -103h180c22 0 88 0 95 8c10 15 17 59 22 89h25Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-5B" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-30" x="278" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="779" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-31" x="1224" y="0"></use>
<g transform="translate(1724,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-5D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-32" x="393" y="513"></use>
</g>
</g>
</svg>.  The result is
a simple expression when expressed in terms of&nbsp;<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.446ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 622.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">omega Subscript</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
</g>
</svg>:
</p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">
<div class="displaymath"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="31.133ex" height="6.176ex" style="vertical-align: -2.171ex;" viewBox="0 -1724.2 13404.2 2659.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">StartFraction normal d left-parenthesis u comma v right-parenthesis Over normal d omega Subscript Baseline EndFraction equals pi squared StartFraction left-parenthesis 1 minus omega Subscript Baseline Subscript x Superscript 2 Baseline right-parenthesis left-parenthesis 1 minus omega Subscript Baseline Subscript y Superscript 2 Baseline right-parenthesis Over omega Subscript Baseline Subscript z Baseline EndFraction period</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-64" d="M527 0l-147 -11v66c-25 -32 -70 -66 -134 -66c-114 0 -212 99 -212 226c0 129 105 227 223 227c54 0 97 -26 126 -62v216c0 49 -8 56 -78 56v31l144 11v-607c0 -49 8 -56 78 -56v-31zM380 118v205c0 18 0 20 -11 37c-31 45 -73 60 -108 60c-54 0 -92 -33 -113 -64 c-29 -45 -31 -105 -31 -142c0 -41 3 -98 29 -139c24 -38 60 -64 105 -64c43 0 88 22 118 70c11 17 11 19 11 37Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D462" d="M543 143c0 0 -13 -63 -30 -99c-16 -32 -39 -55 -74 -55c-43 0 -78 26 -89 67c-17 -22 -53 -67 -119 -67c-54 0 -123 25 -123 120c0 49 21 111 58 210c6 15 17 44 17 68c0 32 -16 33 -25 33c-38 0 -76 -37 -101 -124c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10 c0 9 37 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -17 -63c-26 -69 -54 -148 -54 -204c0 -37 10 -82 62 -82c73 0 113 80 114 84l75 301c8 34 34 35 39 35c15 0 29 -9 29 -27c0 -6 -10 -44 -15 -67c-4 -15 -14 -53 -17 -68l-28 -108c-8 -35 -20 -82 -20 -104 c0 -33 10 -46 31 -46c42 0 61 68 75 124c3 14 4 18 14 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D463" d="M468 372c0 -52 -57 -383 -225 -383c-46 0 -134 16 -134 124c0 43 13 89 57 205c7 18 17 45 17 70c0 32 -17 32 -25 32c-29 0 -72 -23 -101 -124c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 38 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -12 -50 c-31 -83 -58 -156 -58 -212c0 -52 23 -87 74 -87c117 0 178 229 178 271c0 36 -13 62 -34 82c-11 11 -16 17 -16 30c0 22 24 48 49 48c18 0 44 -16 44 -70Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3D" d="M722 347c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20zM722 153c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D70B" d="M567 407c0 -34 -36 -34 -49 -34h-114c-11 -52 -18 -106 -18 -159c0 -28 0 -93 29 -165c6 -14 6 -16 6 -22c0 -20 -21 -38 -41 -38c-15 0 -26 6 -36 50c-8 34 -8 61 -8 76c0 67 9 110 42 258h-113l-56 -221c-13 -50 -13 -52 -27 -98c-12 -37 -20 -65 -50 -65 c-13 0 -29 8 -29 27c0 7 0 9 8 24c42 91 96 212 128 333h-57c-20 0 -78 0 -127 -77c-6 -8 -8 -12 -16 -12c-12 0 -12 10 -12 10c0 5 26 51 61 90c44 47 82 47 104 47h335c19 0 40 0 40 -24Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-32" d="M449 174l-28 -174h-371c0 24 0 26 11 37l192 214c55 62 105 141 105 221c0 82 -43 163 -134 163c-58 0 -112 -37 -135 -102c3 1 5 1 13 1c35 0 53 -26 53 -52c0 -41 -35 -53 -52 -53c-3 0 -53 0 -53 56c0 89 74 181 187 181c122 0 212 -80 212 -194 c0 -100 -60 -154 -216 -292l-106 -103h180c22 0 88 0 95 8c10 15 17 59 22 89h25Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2212" d="M722 250c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D465" d="M527 376c0 -40 -32 -58 -54 -58c-27 0 -38 19 -38 35c0 24 20 49 48 54c-21 13 -45 13 -50 13c-70 0 -93 -92 -99 -118l-34 -137c-11 -44 -17 -66 -17 -88c0 -34 16 -66 55 -66c32 0 100 24 133 131c2 7 4 11 13 11c3 0 12 0 12 -10c0 -25 -57 -154 -160 -154 c-60 0 -96 39 -108 76c-3 -6 -39 -76 -105 -76c-44 0 -94 20 -94 66c0 32 25 58 55 58c15 0 37 -8 37 -35c0 -28 -22 -49 -47 -54c21 -13 44 -13 50 -13c44 0 79 42 95 104c37 140 54 207 54 238c0 58 -35 67 -54 67c-34 0 -100 -25 -134 -131c-2 -9 -5 -11 -13 -11 c0 0 -12 0 -12 10c0 25 57 154 161 154c29 0 83 -10 108 -76c12 23 47 76 105 76c34 0 93 -14 93 -66Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D466" d="M490 404c0 -7 0 -9 -4 -23l-96 -382c-28 -113 -131 -204 -234 -204c-62 0 -106 37 -106 87c0 49 33 65 56 65c10 0 37 -4 37 -35c0 -19 -10 -32 -20 -41c-14 -12 -27 -12 -43 -12c17 -39 62 -42 76 -42c46 0 84 29 110 63c40 53 52 102 65 154c-28 -28 -62 -45 -101 -45 c-59 0 -122 30 -122 119c0 47 18 104 58 210c7 19 17 45 17 70c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 37 154 132 154c50 0 82 -37 82 -82c0 -20 -4 -31 -20 -72c-34 -88 -51 -150 -51 -196c0 -37 11 -81 62 -81 c66 0 109 70 113 85l45 180l20 80c4 18 12 49 14 54c9 15 25 21 35 21c15 0 29 -9 29 -27Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D467" d="M467 432c0 -4 -22 -52 -117 -145c-36 -36 -98 -90 -98 -90c-36 -31 -65 -56 -119 -114c9 3 27 3 27 3c21 0 36 -4 70 -17c21 -7 39 -13 59 -13c33 0 97 19 120 84c3 7 5 13 14 13c8 0 12 -5 12 -10c0 -27 -58 -154 -157 -154c-29 0 -47 16 -64 37c-25 29 -35 38 -58 38 c-32 0 -62 -27 -85 -62c-6 -11 -8 -13 -16 -13c0 0 -12 0 -12 10c0 7 35 64 103 131l90 84c19 16 103 88 139 131c-26 0 -37 0 -77 15c-23 8 -42 15 -63 15c-8 0 -66 -1 -85 -47c-2 -6 -4 -11 -13 -11s-12 6 -12 11c0 21 46 114 121 114c33 0 50 -20 69 -43 c15 -17 27 -32 51 -32s45 16 75 64c5 9 8 11 15 11c0 0 11 0 11 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2E" d="M192 53c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
<g transform="translate(120,0)">
<rect stroke="none" width="2958" height="60" x="0" y="220"></rect>
<g transform="translate(60,768)">
 <use xlink:href="#E1-LATINMODERNMAIN-64" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="556" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D462" x="946" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="1518" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D463" x="1963" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="2449" y="0"></use>
</g>
<g transform="translate(889,-715)">
 <use xlink:href="#E1-LATINMODERNMAIN-64" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="556" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="3476" y="0"></use>
<g transform="translate(4532,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D70B" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-32" x="806" y="583"></use>
</g>
<g transform="translate(5557,0)">
<g transform="translate(120,0)">
<rect stroke="none" width="7328" height="60" x="0" y="220"></rect>
<g transform="translate(60,813)">
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-31" x="389" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2212" x="1112" y="0"></use>
<g transform="translate(2112,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-32" x="880" y="488"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D465" x="880" y="-211"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="3240" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="3629" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-31" x="4019" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2212" x="4741" y="0"></use>
<g transform="translate(5742,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-32" x="880" y="488"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D466" x="880" y="-211"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="6819" y="0"></use>
</g>
<g transform="translate(3137,-686)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D467" x="880" y="-213"></use>
</g>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2E" x="13125" y="0"></use>
</g>
</svg>
</div>
<p>


</p>
<p>If a non-<tt>nullptr</tt> <tt>duv_dw</tt> parameter is passed to this method,
this factor is returned.

</p>
<p></p>
<span class="anchor" id="fragment-ComputeJacobiandeterminantofmappingromanduvromandomegaifneeded-0"></span><div class="fragmentname">&lt;&lt;Compute Jacobian determinant of mapping <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="10.494ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 4518.2 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">normal d left-parenthesis u comma v right-parenthesis slash normal d omega</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-64" d="M527 0l-147 -11v66c-25 -32 -70 -66 -134 -66c-114 0 -212 99 -212 226c0 129 105 227 223 227c54 0 97 -26 126 -62v216c0 49 -8 56 -78 56v31l144 11v-607c0 -49 8 -56 78 -56v-31zM380 118v205c0 18 0 20 -11 37c-31 45 -73 60 -108 60c-54 0 -92 -33 -113 -64 c-29 -45 -31 -105 -31 -142c0 -41 3 -98 29 -139c24 -38 60 -64 105 -64c43 0 88 22 118 70c11 17 11 19 11 37Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D462" d="M543 143c0 0 -13 -63 -30 -99c-16 -32 -39 -55 -74 -55c-43 0 -78 26 -89 67c-17 -22 -53 -67 -119 -67c-54 0 -123 25 -123 120c0 49 21 111 58 210c6 15 17 44 17 68c0 32 -16 33 -25 33c-38 0 -76 -37 -101 -124c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10 c0 9 37 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -17 -63c-26 -69 -54 -148 -54 -204c0 -37 10 -82 62 -82c73 0 113 80 114 84l75 301c8 34 34 35 39 35c15 0 29 -9 29 -27c0 -6 -10 -44 -15 -67c-4 -15 -14 -53 -17 -68l-28 -108c-8 -35 -20 -82 -20 -104 c0 -33 10 -46 31 -46c42 0 61 68 75 124c3 14 4 18 14 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D463" d="M468 372c0 -52 -57 -383 -225 -383c-46 0 -134 16 -134 124c0 43 13 89 57 205c7 18 17 45 17 70c0 32 -17 32 -25 32c-29 0 -72 -23 -101 -124c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 38 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -12 -50 c-31 -83 -58 -156 -58 -212c0 -52 23 -87 74 -87c117 0 178 229 178 271c0 36 -13 62 -34 82c-11 11 -16 17 -16 30c0 22 24 48 49 48c18 0 44 -16 44 -70Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2F" d="M445 730c0 -2 0 -5 -1 -7l-349 -960c-3 -8 -10 -13 -19 -13c-11 0 -20 9 -20 20c0 2 0 5 1 7l349 960c3 8 10 13 19 13c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-64" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="556" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D462" x="946" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="1518" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D463" x="1963" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="2449" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2F" x="2838" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-64" x="3339" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="3895" y="0"></use>
</g>
</svg> if needed&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">if (duv_dw)
    *duv_dw = <a href="../Utilities/Mathematical_Infrastructure.html#Sqr" class="code">Sqr</a>(<a href="../Utilities/Mathematical_Infrastructure.html#Pi" class="code">Pi</a>) * (1 - <a href="../Utilities/Mathematical_Infrastructure.html#Sqr" class="code">Sqr</a>(w.x)) * (1 - <a href="../Utilities/Mathematical_Infrastructure.html#Sqr" class="code">Sqr</a>(w.y)) / w.z;</div><p>


</p>
<p>The inverse transformation can be found by working in reverse.  It is
implemented in <tt>RenderFromImage()</tt>, which also optionally returns the
same change of variables factor.

</p>
<p></p>
<span class="anchor" id="fragment-PortalImageInfiniteLightPrivateMethods-1"></span><div class="fragmentname">&lt;&lt;PortalImageInfiniteLight Private Methods&gt;&gt;+=&nbsp;<a href="#fragment-PortalImageInfiniteLightPrivateMethods-0"><span class="fa fa-caret-up"></span></a>&nbsp;<a href="#fragment-PortalImageInfiniteLightPrivateMethods-2"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode"><a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> <span class="anchor" id="PortalImageInfiniteLight::RenderFromImage"></span>RenderFromImage(<a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a> uv, Float *duv_dw = nullptr) const {
    Float alpha = -<a href="../Utilities/Mathematical_Infrastructure.html#Pi" class="code">Pi</a> / 2 + uv[0] * <a href="../Utilities/Mathematical_Infrastructure.html#Pi" class="code">Pi</a>, beta = -<a href="../Utilities/Mathematical_Infrastructure.html#Pi" class="code">Pi</a> / 2 + uv[1] * <a href="../Utilities/Mathematical_Infrastructure.html#Pi" class="code">Pi</a>;
    Float x = std::tan(alpha), y = std::tan(beta);
    <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> w = <a href="../Geometry_and_Transformations/Vectors.html#Normalize" class="code">Normalize</a>(<a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a>(x, y, 1));
    &lt;&lt;<span class="fragmentname"><a href="#fragment-ComputeJacobiandeterminantofmappingromanduvromandomegaifneeded-0">Compute Jacobian determinant of mapping <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="10.494ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 4518.2 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">normal d left-parenthesis u comma v right-parenthesis slash normal d omega</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-64" d="M527 0l-147 -11v66c-25 -32 -70 -66 -134 -66c-114 0 -212 99 -212 226c0 129 105 227 223 227c54 0 97 -26 126 -62v216c0 49 -8 56 -78 56v31l144 11v-607c0 -49 8 -56 78 -56v-31zM380 118v205c0 18 0 20 -11 37c-31 45 -73 60 -108 60c-54 0 -92 -33 -113 -64 c-29 -45 -31 -105 -31 -142c0 -41 3 -98 29 -139c24 -38 60 -64 105 -64c43 0 88 22 118 70c11 17 11 19 11 37Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D462" d="M543 143c0 0 -13 -63 -30 -99c-16 -32 -39 -55 -74 -55c-43 0 -78 26 -89 67c-17 -22 -53 -67 -119 -67c-54 0 -123 25 -123 120c0 49 21 111 58 210c6 15 17 44 17 68c0 32 -16 33 -25 33c-38 0 -76 -37 -101 -124c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10 c0 9 37 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -17 -63c-26 -69 -54 -148 -54 -204c0 -37 10 -82 62 -82c73 0 113 80 114 84l75 301c8 34 34 35 39 35c15 0 29 -9 29 -27c0 -6 -10 -44 -15 -67c-4 -15 -14 -53 -17 -68l-28 -108c-8 -35 -20 -82 -20 -104 c0 -33 10 -46 31 -46c42 0 61 68 75 124c3 14 4 18 14 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D463" d="M468 372c0 -52 -57 -383 -225 -383c-46 0 -134 16 -134 124c0 43 13 89 57 205c7 18 17 45 17 70c0 32 -17 32 -25 32c-29 0 -72 -23 -101 -124c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 38 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -12 -50 c-31 -83 -58 -156 -58 -212c0 -52 23 -87 74 -87c117 0 178 229 178 271c0 36 -13 62 -34 82c-11 11 -16 17 -16 30c0 22 24 48 49 48c18 0 44 -16 44 -70Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2F" d="M445 730c0 -2 0 -5 -1 -7l-349 -960c-3 -8 -10 -13 -19 -13c-11 0 -20 9 -20 20c0 2 0 5 1 7l349 960c3 8 10 13 19 13c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-64" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="556" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D462" x="946" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="1518" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D463" x="1963" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="2449" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2F" x="2838" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-64" x="3339" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="3895" y="0"></use>
</g>
</svg> if needed</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1695" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1695"><i></i></a><div id="fragbit-1695" class="collapse show"><div class="fragmentcode">       if (duv_dw)
           *duv_dw = <a href="../Utilities/Mathematical_Infrastructure.html#Sqr" class="code">Sqr</a>(<a href="../Utilities/Mathematical_Infrastructure.html#Pi" class="code">Pi</a>) * (1 - <a href="../Utilities/Mathematical_Infrastructure.html#Sqr" class="code">Sqr</a>(w.x)) * (1 - <a href="../Utilities/Mathematical_Infrastructure.html#Sqr" class="code">Sqr</a>(w.y)) / w.z;</div></div>
    return <a href="#PortalImageInfiniteLight::portalFrame" class="code">portalFrame</a>.<a href="../Geometry_and_Transformations/Applying_Transformations.html#Frame::FromLocal" class="code">FromLocal</a>(w);
}</div><p>


</p>
<p>Because the mapping is rectified, we can find the image-space bounding box
of the visible region of the environment map from a given point using the coordinates
of two opposite portal corners.  This method also returns an optional
value, for the same reasons as for <tt>ImageFromRender()</tt>.

</p>
<p></p>
<span class="anchor" id="fragment-PortalImageInfiniteLightPrivateMethods-2"></span><div class="fragmentname">&lt;&lt;PortalImageInfiniteLight Private Methods&gt;&gt;+=&nbsp;<a href="#fragment-PortalImageInfiniteLightPrivateMethods-1"><span class="fa fa-caret-up"></span></a></div>
<div class="fragmentcode">pstd::optional&lt;<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds2f" class="code">Bounds2f</a>&gt; <span class="anchor" id="PortalImageInfiniteLight::ImageBounds"></span>ImageBounds(<a href="../Geometry_and_Transformations/Points.html#Point3f" class="code">Point3f</a> p) const {
    pstd::optional&lt;<a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>&gt; p0 = <a href="#PortalImageInfiniteLight::ImageFromRender" class="code">ImageFromRender</a>(<a href="../Geometry_and_Transformations/Vectors.html#Normalize" class="code">Normalize</a>(<a href="#PortalImageInfiniteLight::portal" class="code">portal</a>[0] - p));
    pstd::optional&lt;<a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>&gt; p1 = <a href="#PortalImageInfiniteLight::ImageFromRender" class="code">ImageFromRender</a>(<a href="../Geometry_and_Transformations/Vectors.html#Normalize" class="code">Normalize</a>(<a href="#PortalImageInfiniteLight::portal" class="code">portal</a>[2] - p));
    if (!p0 || !p1) return {};
    return <a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds2f" class="code">Bounds2f</a>(*p0, *p1);
}</div><p>


</p>
<p>

</p>
<p>Most of the <tt>PortalImageInfiniteLight</tt> constructor consists of
straightforward initialization of member variables from provided parameter
values, checking that the provided image has RGB channels, and so forth.
All of that has not been included in this text.
We will, however, discuss the following three fragments, which run at the
end of the constructor.

</p>
<p></p>
<span class="anchor" id="fragment-PortalImageInfiniteLightconstructorconclusion-0"></span><div class="fragmentname">&lt;&lt;PortalImageInfiniteLight constructor conclusion&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">&lt;&lt;<span class="fragmentname"><a href="#fragment-Computeframeforportalcoordinatesystem-0">Compute frame for portal coordinate system</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1696" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1696"><i></i></a><div id="fragbit-1696" class="collapse show"><div class="fragmentcode">   <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> p01 = <a href="../Geometry_and_Transformations/Vectors.html#Normalize" class="code">Normalize</a>(portal[1] - portal[0]);
   <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> p03 = <a href="../Geometry_and_Transformations/Vectors.html#Normalize" class="code">Normalize</a>(portal[3] - portal[0]);
   <a href="#PortalImageInfiniteLight::portalFrame" class="code">portalFrame</a> = <a href="../Geometry_and_Transformations/Applying_Transformations.html#Frame" class="code">Frame</a>::<a href="../Geometry_and_Transformations/Applying_Transformations.html#Frame::FromXY" class="code">FromXY</a>(p03, p01);</div></div> 
&lt;&lt;<span class="fragmentname"><a href="#fragment-Resampleenvironmentmapintorectifiedimage-0">Resample environment map into rectified image</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1697" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1697"><i></i></a><div id="fragbit-1697" class="collapse show"><div class="fragmentcode">   image = <a href="../Utilities/Images.html#Image" class="code">Image</a>(<a href="../Utilities/Images.html#PixelFormat::Float" class="code">PixelFormat</a>::Float, equalAreaImage.<a href="../Utilities/Images.html#Image::Resolution" class="code">Resolution</a>(),
                 {"R", "G", "B"}, equalAreaImage.<a href="../Utilities/Images.html#Image::Encoding" class="code">Encoding</a>(), alloc);
   <a href="../Utilities/Parallelism.html#ParallelFor" class="code">ParallelFor</a>(0, image.<a href="../Utilities/Images.html#Image::Resolution" class="code">Resolution</a>().y, [&amp;](int y) {
       for (int x = 0; x &lt; image.<a href="../Utilities/Images.html#Image::Resolution" class="code">Resolution</a>().x; ++x) {
           &lt;&lt;<span class="fragmentname"><a href="#fragment-ResamplemonoequalAreaImagetocomputerectifiedimagepixelxy-0">Resample <tt>equalAreaImage</tt> to compute rectified image pixel <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.312ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 2287.2 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">left-parenthesis x comma y right-parenthesis</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D465" d="M527 376c0 -40 -32 -58 -54 -58c-27 0 -38 19 -38 35c0 24 20 49 48 54c-21 13 -45 13 -50 13c-70 0 -93 -92 -99 -118l-34 -137c-11 -44 -17 -66 -17 -88c0 -34 16 -66 55 -66c32 0 100 24 133 131c2 7 4 11 13 11c3 0 12 0 12 -10c0 -25 -57 -154 -160 -154 c-60 0 -96 39 -108 76c-3 -6 -39 -76 -105 -76c-44 0 -94 20 -94 66c0 32 25 58 55 58c15 0 37 -8 37 -35c0 -28 -22 -49 -47 -54c21 -13 44 -13 50 -13c44 0 79 42 95 104c37 140 54 207 54 238c0 58 -35 67 -54 67c-34 0 -100 -25 -134 -131c-2 -9 -5 -11 -13 -11 c0 0 -12 0 -12 10c0 25 57 154 161 154c29 0 83 -10 108 -76c12 23 47 76 105 76c34 0 93 -14 93 -66Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D466" d="M490 404c0 -7 0 -9 -4 -23l-96 -382c-28 -113 -131 -204 -234 -204c-62 0 -106 37 -106 87c0 49 33 65 56 65c10 0 37 -4 37 -35c0 -19 -10 -32 -20 -41c-14 -12 -27 -12 -43 -12c17 -39 62 -42 76 -42c46 0 84 29 110 63c40 53 52 102 65 154c-28 -28 -62 -45 -101 -45 c-59 0 -122 30 -122 119c0 47 18 104 58 210c7 19 17 45 17 70c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 37 154 132 154c50 0 82 -37 82 -82c0 -20 -4 -31 -20 -72c-34 -88 -51 -150 -51 -196c0 -37 11 -81 62 -81 c66 0 109 70 113 85l45 180l20 80c4 18 12 49 14 54c9 15 25 21 35 21c15 0 29 -9 29 -27Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D465" x="389" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="962" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D466" x="1407" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="1897" y="0"></use>
</g>
</svg></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1698" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1698"><i></i></a><div id="fragbit-1698" class="collapse show"><div class="fragmentcode">              &lt;&lt;<span class="fragmentname"><a href="#fragment-Finduvcoordinatesinequal-areaimageforpixel-0">Find <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.301ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 2282.2 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">left-parenthesis u comma v right-parenthesis</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D462" d="M543 143c0 0 -13 -63 -30 -99c-16 -32 -39 -55 -74 -55c-43 0 -78 26 -89 67c-17 -22 -53 -67 -119 -67c-54 0 -123 25 -123 120c0 49 21 111 58 210c6 15 17 44 17 68c0 32 -16 33 -25 33c-38 0 -76 -37 -101 -124c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10 c0 9 37 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -17 -63c-26 -69 -54 -148 -54 -204c0 -37 10 -82 62 -82c73 0 113 80 114 84l75 301c8 34 34 35 39 35c15 0 29 -9 29 -27c0 -6 -10 -44 -15 -67c-4 -15 -14 -53 -17 -68l-28 -108c-8 -35 -20 -82 -20 -104 c0 -33 10 -46 31 -46c42 0 61 68 75 124c3 14 4 18 14 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D463" d="M468 372c0 -52 -57 -383 -225 -383c-46 0 -134 16 -134 124c0 43 13 89 57 205c7 18 17 45 17 70c0 32 -17 32 -25 32c-29 0 -72 -23 -101 -124c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 38 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -12 -50 c-31 -83 -58 -156 -58 -212c0 -52 23 -87 74 -87c117 0 178 229 178 271c0 36 -13 62 -34 82c-11 11 -16 17 -16 30c0 22 24 48 49 48c18 0 44 -16 44 -70Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D462" x="389" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="962" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D463" x="1407" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="1892" y="0"></use>
</g>
</svg> coordinates in equal-area image for pixel</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1699" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1699"><i></i></a><div id="fragbit-1699" class="collapse show"><div class="fragmentcode">                 <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a> uv((x + 0.5f) / image.<a href="../Utilities/Images.html#Image::Resolution" class="code">Resolution</a>().x,
                            (y + 0.5f) / image.<a href="../Utilities/Images.html#Image::Resolution" class="code">Resolution</a>().y);
                 <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> w = <a href="#PortalImageInfiniteLight::RenderFromImage" class="code">RenderFromImage</a>(uv);
                 w = <a href="../Geometry_and_Transformations/Vectors.html#Normalize" class="code">Normalize</a>(<a href="../Light_Sources/Light_Interface.html#LightBase::renderFromLight" class="code">renderFromLight</a>.<a href="../Geometry_and_Transformations/Applying_Transformations.html#Transform::ApplyInverse" class="code">ApplyInverse</a>(w));
                 <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a> uvEqui = <a href="../Geometry_and_Transformations/Spherical_Geometry.html#EqualAreaSphereToSquare" class="code">EqualAreaSphereToSquare</a>(w);</div></div>
              for (int c = 0; c &lt; 3; ++c) {
                  Float v = equalAreaImage.<a href="../Utilities/Images.html#Image::BilerpChannel" class="code">BilerpChannel</a>(uvEqui, c,
                                                         <a href="../Utilities/Images.html#WrapMode::OctahedralSphere" class="code">WrapMode</a>::OctahedralSphere);
                  image.<a href="../Utilities/Images.html#Image::SetChannel" class="code">SetChannel</a>({x, y}, c, v);
              }</div></div>
       }
   });</div></div>
&lt;&lt;<span class="fragmentname"><a href="#fragment-Initializesamplingdistributionforportalimageinfinitelight-0">Initialize sampling distribution for portal image infinite light</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1700" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1700"><i></i></a><div id="fragbit-1700" class="collapse show"><div class="fragmentcode">   auto duv_dw = [&amp;](<a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a> p) {
       Float duv_dw;
       (void)<a href="#PortalImageInfiniteLight::RenderFromImage" class="code">RenderFromImage</a>(p, &amp;duv_dw);
       return duv_dw;
   };
   Array2D&lt;Float&gt; d = image.<a href="../Utilities/Images.html#Image::GetSamplingDistribution" class="code">GetSamplingDistribution</a>(duv_dw);
   <a href="#PortalImageInfiniteLight::distribution" class="code">distribution</a> = WindowedPiecewiseConstant2D(d, alloc);</div></div></div><p>


</p>
<p>

</p>
<p>The portal itself is specified by four vertices, given in the rendering
coordinate system.  Additional code, not shown here, checks to ensure that
they describe a planar quadrilateral.
A <a href="../Geometry_and_Transformations/Applying_Transformations.html#Frame"><tt>Frame</tt></a> for the portal&rsquo;s coordinate system can be found from
two normalized adjacent edge vectors of the portal using the <a href="../Geometry_and_Transformations/Applying_Transformations.html#Frame::FromXY"><tt>Frame::FromXY()</tt></a> method.  

</p>
<p></p>
<span class="anchor" id="fragment-Computeframeforportalcoordinatesystem-0"></span><div class="fragmentname">&lt;&lt;Compute frame for portal coordinate system&gt;&gt;=&nbsp;</div>
<div class="fragmentcode"><a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> p01 = <a href="../Geometry_and_Transformations/Vectors.html#Normalize" class="code">Normalize</a>(portal[1] - portal[0]);
<a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> p03 = <a href="../Geometry_and_Transformations/Vectors.html#Normalize" class="code">Normalize</a>(portal[3] - portal[0]);
<a href="#PortalImageInfiniteLight::portalFrame" class="code">portalFrame</a> = <a href="../Geometry_and_Transformations/Applying_Transformations.html#Frame" class="code">Frame</a>::<a href="../Geometry_and_Transformations/Applying_Transformations.html#Frame::FromXY" class="code">FromXY</a>(p03, p01);</div><p>


</p>
<p></p>
<span class="anchor" id="fragment-PortalImageInfiniteLightPrivateMembers-0"></span><div class="fragmentname">&lt;&lt;PortalImageInfiniteLight Private Members&gt;&gt;=&nbsp;<a href="#fragment-PortalImageInfiniteLightPrivateMembers-1"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode">pstd::array&lt;<a href="../Geometry_and_Transformations/Points.html#Point3f" class="code">Point3f</a>, 4&gt; <span class="anchor" id="PortalImageInfiniteLight::portal"></span>portal;
<a href="../Geometry_and_Transformations/Applying_Transformations.html#Frame" class="code">Frame</a> <span class="anchor" id="PortalImageInfiniteLight::portalFrame"></span>portalFrame;</div><p>


</p>
<p>
The constructor also resamples a provided equal-area image into the
rectified representation at the same resolution.  Because the rectified
image depends on the geometry of the portal, it is better to take an
equal-area image and resample it in the constructor than to require the
user to provide an already-rectified image.

In this way, it is easy for
the user to change the portal specification just by changing the portal&rsquo;s
coordinates in the scene description file.

</p>
<p></p>
<span class="anchor" id="fragment-Resampleenvironmentmapintorectifiedimage-0"></span><div class="fragmentname">&lt;&lt;Resample environment map into rectified image&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">image = <a href="../Utilities/Images.html#Image" class="code">Image</a>(<a href="../Utilities/Images.html#PixelFormat::Float" class="code">PixelFormat</a>::Float, equalAreaImage.<a href="../Utilities/Images.html#Image::Resolution" class="code">Resolution</a>(),
              {"R", "G", "B"}, equalAreaImage.<a href="../Utilities/Images.html#Image::Encoding" class="code">Encoding</a>(), alloc);
<a href="../Utilities/Parallelism.html#ParallelFor" class="code">ParallelFor</a>(0, image.<a href="../Utilities/Images.html#Image::Resolution" class="code">Resolution</a>().y, [&amp;](int y) {
    for (int x = 0; x &lt; image.<a href="../Utilities/Images.html#Image::Resolution" class="code">Resolution</a>().x; ++x) {
        &lt;&lt;<span class="fragmentname"><a href="#fragment-ResamplemonoequalAreaImagetocomputerectifiedimagepixelxy-0">Resample <tt>equalAreaImage</tt> to compute rectified image pixel <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.312ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 2287.2 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">left-parenthesis x comma y right-parenthesis</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D465" d="M527 376c0 -40 -32 -58 -54 -58c-27 0 -38 19 -38 35c0 24 20 49 48 54c-21 13 -45 13 -50 13c-70 0 -93 -92 -99 -118l-34 -137c-11 -44 -17 -66 -17 -88c0 -34 16 -66 55 -66c32 0 100 24 133 131c2 7 4 11 13 11c3 0 12 0 12 -10c0 -25 -57 -154 -160 -154 c-60 0 -96 39 -108 76c-3 -6 -39 -76 -105 -76c-44 0 -94 20 -94 66c0 32 25 58 55 58c15 0 37 -8 37 -35c0 -28 -22 -49 -47 -54c21 -13 44 -13 50 -13c44 0 79 42 95 104c37 140 54 207 54 238c0 58 -35 67 -54 67c-34 0 -100 -25 -134 -131c-2 -9 -5 -11 -13 -11 c0 0 -12 0 -12 10c0 25 57 154 161 154c29 0 83 -10 108 -76c12 23 47 76 105 76c34 0 93 -14 93 -66Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D466" d="M490 404c0 -7 0 -9 -4 -23l-96 -382c-28 -113 -131 -204 -234 -204c-62 0 -106 37 -106 87c0 49 33 65 56 65c10 0 37 -4 37 -35c0 -19 -10 -32 -20 -41c-14 -12 -27 -12 -43 -12c17 -39 62 -42 76 -42c46 0 84 29 110 63c40 53 52 102 65 154c-28 -28 -62 -45 -101 -45 c-59 0 -122 30 -122 119c0 47 18 104 58 210c7 19 17 45 17 70c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 37 154 132 154c50 0 82 -37 82 -82c0 -20 -4 -31 -20 -72c-34 -88 -51 -150 -51 -196c0 -37 11 -81 62 -81 c66 0 109 70 113 85l45 180l20 80c4 18 12 49 14 54c9 15 25 21 35 21c15 0 29 -9 29 -27Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D465" x="389" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="962" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D466" x="1407" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="1897" y="0"></use>
</g>
</svg></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1701" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1701"><i></i></a><div id="fragbit-1701" class="collapse show"><div class="fragmentcode">           &lt;&lt;<span class="fragmentname"><a href="#fragment-Finduvcoordinatesinequal-areaimageforpixel-0">Find <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.301ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 2282.2 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">left-parenthesis u comma v right-parenthesis</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D462" d="M543 143c0 0 -13 -63 -30 -99c-16 -32 -39 -55 -74 -55c-43 0 -78 26 -89 67c-17 -22 -53 -67 -119 -67c-54 0 -123 25 -123 120c0 49 21 111 58 210c6 15 17 44 17 68c0 32 -16 33 -25 33c-38 0 -76 -37 -101 -124c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10 c0 9 37 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -17 -63c-26 -69 -54 -148 -54 -204c0 -37 10 -82 62 -82c73 0 113 80 114 84l75 301c8 34 34 35 39 35c15 0 29 -9 29 -27c0 -6 -10 -44 -15 -67c-4 -15 -14 -53 -17 -68l-28 -108c-8 -35 -20 -82 -20 -104 c0 -33 10 -46 31 -46c42 0 61 68 75 124c3 14 4 18 14 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D463" d="M468 372c0 -52 -57 -383 -225 -383c-46 0 -134 16 -134 124c0 43 13 89 57 205c7 18 17 45 17 70c0 32 -17 32 -25 32c-29 0 -72 -23 -101 -124c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 38 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -12 -50 c-31 -83 -58 -156 -58 -212c0 -52 23 -87 74 -87c117 0 178 229 178 271c0 36 -13 62 -34 82c-11 11 -16 17 -16 30c0 22 24 48 49 48c18 0 44 -16 44 -70Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D462" x="389" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="962" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D463" x="1407" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="1892" y="0"></use>
</g>
</svg> coordinates in equal-area image for pixel</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1702" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1702"><i></i></a><div id="fragbit-1702" class="collapse show"><div class="fragmentcode">              <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a> uv((x + 0.5f) / image.<a href="../Utilities/Images.html#Image::Resolution" class="code">Resolution</a>().x,
                         (y + 0.5f) / image.<a href="../Utilities/Images.html#Image::Resolution" class="code">Resolution</a>().y);
              <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> w = <a href="#PortalImageInfiniteLight::RenderFromImage" class="code">RenderFromImage</a>(uv);
              w = <a href="../Geometry_and_Transformations/Vectors.html#Normalize" class="code">Normalize</a>(<a href="../Light_Sources/Light_Interface.html#LightBase::renderFromLight" class="code">renderFromLight</a>.<a href="../Geometry_and_Transformations/Applying_Transformations.html#Transform::ApplyInverse" class="code">ApplyInverse</a>(w));
              <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a> uvEqui = <a href="../Geometry_and_Transformations/Spherical_Geometry.html#EqualAreaSphereToSquare" class="code">EqualAreaSphereToSquare</a>(w);</div></div>
           for (int c = 0; c &lt; 3; ++c) {
               Float v = equalAreaImage.<a href="../Utilities/Images.html#Image::BilerpChannel" class="code">BilerpChannel</a>(uvEqui, c,
                                                      <a href="../Utilities/Images.html#WrapMode::OctahedralSphere" class="code">WrapMode</a>::OctahedralSphere);
               image.<a href="../Utilities/Images.html#Image::SetChannel" class="code">SetChannel</a>({x, y}, c, v);
           }</div></div>
    }
});</div><p>


</p>
<p></p>
<span class="anchor" id="fragment-PortalImageInfiniteLightPrivateMembers-1"></span><div class="fragmentname">&lt;&lt;PortalImageInfiniteLight Private Members&gt;&gt;+=&nbsp;<a href="#fragment-PortalImageInfiniteLightPrivateMembers-0"><span class="fa fa-caret-up"></span></a>&nbsp;<a href="#fragment-PortalImageInfiniteLightPrivateMembers-2"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode"><a href="../Utilities/Images.html#Image" class="code">Image</a> <span class="anchor" id="PortalImageInfiniteLight::image"></span>image;</div><p>


</p>
<p>At each rectified image pixel, the implementation first computes the
corresponding light-space direction and looks up a bilinearly interpolated
value from the equal-area image.  No further filtering is performed.  A
better implementation would use a spatially varying filter here in order to
ensure that there was no risk of introducing aliasing due to undersampling
the source image.

</p>
<p></p>
<span class="anchor" id="fragment-ResamplemonoequalAreaImagetocomputerectifiedimagepixelxy-0"></span><div class="fragmentname">&lt;&lt;Resample <tt>equalAreaImage</tt> to compute rectified image pixel <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.312ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 2287.2 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">left-parenthesis x comma y right-parenthesis</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D465" d="M527 376c0 -40 -32 -58 -54 -58c-27 0 -38 19 -38 35c0 24 20 49 48 54c-21 13 -45 13 -50 13c-70 0 -93 -92 -99 -118l-34 -137c-11 -44 -17 -66 -17 -88c0 -34 16 -66 55 -66c32 0 100 24 133 131c2 7 4 11 13 11c3 0 12 0 12 -10c0 -25 -57 -154 -160 -154 c-60 0 -96 39 -108 76c-3 -6 -39 -76 -105 -76c-44 0 -94 20 -94 66c0 32 25 58 55 58c15 0 37 -8 37 -35c0 -28 -22 -49 -47 -54c21 -13 44 -13 50 -13c44 0 79 42 95 104c37 140 54 207 54 238c0 58 -35 67 -54 67c-34 0 -100 -25 -134 -131c-2 -9 -5 -11 -13 -11 c0 0 -12 0 -12 10c0 25 57 154 161 154c29 0 83 -10 108 -76c12 23 47 76 105 76c34 0 93 -14 93 -66Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D466" d="M490 404c0 -7 0 -9 -4 -23l-96 -382c-28 -113 -131 -204 -234 -204c-62 0 -106 37 -106 87c0 49 33 65 56 65c10 0 37 -4 37 -35c0 -19 -10 -32 -20 -41c-14 -12 -27 -12 -43 -12c17 -39 62 -42 76 -42c46 0 84 29 110 63c40 53 52 102 65 154c-28 -28 -62 -45 -101 -45 c-59 0 -122 30 -122 119c0 47 18 104 58 210c7 19 17 45 17 70c0 32 -17 32 -25 32c-34 0 -74 -30 -101 -124c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 37 154 132 154c50 0 82 -37 82 -82c0 -20 -4 -31 -20 -72c-34 -88 -51 -150 -51 -196c0 -37 11 -81 62 -81 c66 0 109 70 113 85l45 180l20 80c4 18 12 49 14 54c9 15 25 21 35 21c15 0 29 -9 29 -27Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D465" x="389" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="962" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D466" x="1407" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="1897" y="0"></use>
</g>
</svg>&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">&lt;&lt;<span class="fragmentname"><a href="#fragment-Finduvcoordinatesinequal-areaimageforpixel-0">Find <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.301ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 2282.2 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">left-parenthesis u comma v right-parenthesis</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D462" d="M543 143c0 0 -13 -63 -30 -99c-16 -32 -39 -55 -74 -55c-43 0 -78 26 -89 67c-17 -22 -53 -67 -119 -67c-54 0 -123 25 -123 120c0 49 21 111 58 210c6 15 17 44 17 68c0 32 -16 33 -25 33c-38 0 -76 -37 -101 -124c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10 c0 9 37 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -17 -63c-26 -69 -54 -148 -54 -204c0 -37 10 -82 62 -82c73 0 113 80 114 84l75 301c8 34 34 35 39 35c15 0 29 -9 29 -27c0 -6 -10 -44 -15 -67c-4 -15 -14 -53 -17 -68l-28 -108c-8 -35 -20 -82 -20 -104 c0 -33 10 -46 31 -46c42 0 61 68 75 124c3 14 4 18 14 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D463" d="M468 372c0 -52 -57 -383 -225 -383c-46 0 -134 16 -134 124c0 43 13 89 57 205c7 18 17 45 17 70c0 32 -17 32 -25 32c-29 0 -72 -23 -101 -124c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 38 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -12 -50 c-31 -83 -58 -156 -58 -212c0 -52 23 -87 74 -87c117 0 178 229 178 271c0 36 -13 62 -34 82c-11 11 -16 17 -16 30c0 22 24 48 49 48c18 0 44 -16 44 -70Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D462" x="389" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="962" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D463" x="1407" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="1892" y="0"></use>
</g>
</svg> coordinates in equal-area image for pixel</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1703" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1703"><i></i></a><div id="fragbit-1703" class="collapse show"><div class="fragmentcode">   <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a> uv((x + 0.5f) / image.<a href="../Utilities/Images.html#Image::Resolution" class="code">Resolution</a>().x,
              (y + 0.5f) / image.<a href="../Utilities/Images.html#Image::Resolution" class="code">Resolution</a>().y);
   <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> w = <a href="#PortalImageInfiniteLight::RenderFromImage" class="code">RenderFromImage</a>(uv);
   w = <a href="../Geometry_and_Transformations/Vectors.html#Normalize" class="code">Normalize</a>(<a href="../Light_Sources/Light_Interface.html#LightBase::renderFromLight" class="code">renderFromLight</a>.<a href="../Geometry_and_Transformations/Applying_Transformations.html#Transform::ApplyInverse" class="code">ApplyInverse</a>(w));
   <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a> uvEqui = <a href="../Geometry_and_Transformations/Spherical_Geometry.html#EqualAreaSphereToSquare" class="code">EqualAreaSphereToSquare</a>(w);</div></div>
for (int c = 0; c &lt; 3; ++c) {
    Float v = equalAreaImage.<a href="../Utilities/Images.html#Image::BilerpChannel" class="code">BilerpChannel</a>(uvEqui, c,
                                           <a href="../Utilities/Images.html#WrapMode::OctahedralSphere" class="code">WrapMode</a>::OctahedralSphere);
    image.<a href="../Utilities/Images.html#Image::SetChannel" class="code">SetChannel</a>({x, y}, c, v);
}</div><p>


</p>
<p>The image coordinates in the equal-area image can be found by
determining the direction vector corresponding to the current pixel in the
rectified image and then finding the equal-area image coordinates that this
direction maps to.

</p>
<p></p>
<span class="anchor" id="fragment-Finduvcoordinatesinequal-areaimageforpixel-0"></span><div class="fragmentname">&lt;&lt;Find <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.301ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 2282.2 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">left-parenthesis u comma v right-parenthesis</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D462" d="M543 143c0 0 -13 -63 -30 -99c-16 -32 -39 -55 -74 -55c-43 0 -78 26 -89 67c-17 -22 -53 -67 -119 -67c-54 0 -123 25 -123 120c0 49 21 111 58 210c6 15 17 44 17 68c0 32 -16 33 -25 33c-38 0 -76 -37 -101 -124c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10 c0 9 37 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -17 -63c-26 -69 -54 -148 -54 -204c0 -37 10 -82 62 -82c73 0 113 80 114 84l75 301c8 34 34 35 39 35c15 0 29 -9 29 -27c0 -6 -10 -44 -15 -67c-4 -15 -14 -53 -17 -68l-28 -108c-8 -35 -20 -82 -20 -104 c0 -33 10 -46 31 -46c42 0 61 68 75 124c3 14 4 18 14 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D463" d="M468 372c0 -52 -57 -383 -225 -383c-46 0 -134 16 -134 124c0 43 13 89 57 205c7 18 17 45 17 70c0 32 -17 32 -25 32c-29 0 -72 -23 -101 -124c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 38 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -12 -50 c-31 -83 -58 -156 -58 -212c0 -52 23 -87 74 -87c117 0 178 229 178 271c0 36 -13 62 -34 82c-11 11 -16 17 -16 30c0 22 24 48 49 48c18 0 44 -16 44 -70Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D462" x="389" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="962" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D463" x="1407" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="1892" y="0"></use>
</g>
</svg> coordinates in equal-area image for pixel&gt;&gt;=&nbsp;</div>
<div class="fragmentcode"><a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a> uv((x + 0.5f) / image.<a href="../Utilities/Images.html#Image::Resolution" class="code">Resolution</a>().x,
           (y + 0.5f) / image.<a href="../Utilities/Images.html#Image::Resolution" class="code">Resolution</a>().y);
<a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> w = <a href="#PortalImageInfiniteLight::RenderFromImage" class="code">RenderFromImage</a>(uv);
w = <a href="../Geometry_and_Transformations/Vectors.html#Normalize" class="code">Normalize</a>(<a href="../Light_Sources/Light_Interface.html#LightBase::renderFromLight" class="code">renderFromLight</a>.<a href="../Geometry_and_Transformations/Applying_Transformations.html#Transform::ApplyInverse" class="code">ApplyInverse</a>(w));
<a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a> uvEqui = <a href="../Geometry_and_Transformations/Spherical_Geometry.html#EqualAreaSphereToSquare" class="code">EqualAreaSphereToSquare</a>(w);</div><p>


</p>
<p>Given the rectified image, the next step is to initialize an instance of
the <a href="../Sampling_Algorithms/Sampling_Multidimensional_Functions.html#WindowedPiecewiseConstant2D"><tt>WindowedPiecewiseConstant2D</tt></a> data structure, which performs the
sampling operation.  (It is defined in
Section&nbsp;<a href="../Sampling_Algorithms/Sampling_Multidimensional_Functions.html#sec:windowed-piecewise-constant">A.5.6</a>.)  As its name suggests, it
generalizes the functionality of the <a href="../Sampling_Algorithms/Sampling_Multidimensional_Functions.html#PiecewiseConstant2D"><tt>PiecewiseConstant2D</tt></a> class to
allow a caller-specified window that limits the sampling region.

</p>
<p>It is worthwhile to include the change of variables factor
<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="10.881ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 4684.8 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">normal d left-parenthesis u comma v right-parenthesis slash normal d omega Subscript</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-64" d="M527 0l-147 -11v66c-25 -32 -70 -66 -134 -66c-114 0 -212 99 -212 226c0 129 105 227 223 227c54 0 97 -26 126 -62v216c0 49 -8 56 -78 56v31l144 11v-607c0 -49 8 -56 78 -56v-31zM380 118v205c0 18 0 20 -11 37c-31 45 -73 60 -108 60c-54 0 -92 -33 -113 -64 c-29 -45 -31 -105 -31 -142c0 -41 3 -98 29 -139c24 -38 60 -64 105 -64c43 0 88 22 118 70c11 17 11 19 11 37Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D462" d="M543 143c0 0 -13 -63 -30 -99c-16 -32 -39 -55 -74 -55c-43 0 -78 26 -89 67c-17 -22 -53 -67 -119 -67c-54 0 -123 25 -123 120c0 49 21 111 58 210c6 15 17 44 17 68c0 32 -16 33 -25 33c-38 0 -76 -37 -101 -124c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10 c0 9 37 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -17 -63c-26 -69 -54 -148 -54 -204c0 -37 10 -82 62 -82c73 0 113 80 114 84l75 301c8 34 34 35 39 35c15 0 29 -9 29 -27c0 -6 -10 -44 -15 -67c-4 -15 -14 -53 -17 -68l-28 -108c-8 -35 -20 -82 -20 -104 c0 -33 10 -46 31 -46c42 0 61 68 75 124c3 14 4 18 14 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D463" d="M468 372c0 -52 -57 -383 -225 -383c-46 0 -134 16 -134 124c0 43 13 89 57 205c7 18 17 45 17 70c0 32 -17 32 -25 32c-29 0 -72 -23 -101 -124c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 38 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -12 -50 c-31 -83 -58 -156 -58 -212c0 -52 23 -87 74 -87c117 0 178 229 178 271c0 36 -13 62 -34 82c-11 11 -16 17 -16 30c0 22 24 48 49 48c18 0 44 -16 44 -70Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2F" d="M445 730c0 -2 0 -5 -1 -7l-349 -960c-3 -8 -10 -13 -19 -13c-11 0 -20 9 -20 20c0 2 0 5 1 7l349 960c3 8 10 13 19 13c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-64" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="556" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D462" x="946" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="1518" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D463" x="1963" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="2449" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2F" x="2838" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-64" x="3339" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="4062" y="0"></use>
</g>
</svg> at each pixel in the image
sampling distribution.  Doing so causes the weights associated with image
samples to be more uniform, as this factor will nearly cancel the same
factor when a sample&rsquo;s PDF is computed.
(The cancellation is not exact, as the factor here is computed at the
center of each pixel while in the PDF it is computed at the exact
sample location.)

</p>
<p></p>
<span class="anchor" id="fragment-Initializesamplingdistributionforportalimageinfinitelight-0"></span><div class="fragmentname">&lt;&lt;Initialize sampling distribution for portal image infinite light&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">auto duv_dw = [&amp;](<a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a> p) {
    Float duv_dw;
    (void)<a href="#PortalImageInfiniteLight::RenderFromImage" class="code">RenderFromImage</a>(p, &amp;duv_dw);
    return duv_dw;
};
Array2D&lt;Float&gt; d = image.<a href="../Utilities/Images.html#Image::GetSamplingDistribution" class="code">GetSamplingDistribution</a>(duv_dw);
<a href="#PortalImageInfiniteLight::distribution" class="code">distribution</a> = WindowedPiecewiseConstant2D(d, alloc);</div><p>


</p>
<p></p>
<span class="anchor" id="fragment-PortalImageInfiniteLightPrivateMembers-2"></span><div class="fragmentname">&lt;&lt;PortalImageInfiniteLight Private Members&gt;&gt;+=&nbsp;<a href="#fragment-PortalImageInfiniteLightPrivateMembers-1"><span class="fa fa-caret-up"></span></a>&nbsp;<a href="#fragment-PortalImageInfiniteLightPrivateMembers-3"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode">WindowedPiecewiseConstant2D <span class="anchor" id="PortalImageInfiniteLight::distribution"></span>distribution;</div><p>


</p>
<p>The light&rsquo;s total power can be found by integrating radiance over the
hemisphere of directions that can be seen through the portal and then
multiplying by the portal&rsquo;s area, since all light that reaches the scene
passes through it.  The corresponding
<tt>PortalImageInfiniteLight::Phi()</tt><span class="anchor" id="PortalImageInfiniteLight::Phi"></span>
method is not included here, as it boils down to being a matter of looping
over the pixels, applying the change of variables factor to account for
integration over the unit sphere, and then multiplying the integrated
radiance by the portal&rsquo;s area.

</p>
<p>

</p>
<p>In order to compute the radiance for a ray that has left the scene, 
the <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.301ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 2282.2 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">left-parenthesis u comma v right-parenthesis</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D462" d="M543 143c0 0 -13 -63 -30 -99c-16 -32 -39 -55 -74 -55c-43 0 -78 26 -89 67c-17 -22 -53 -67 -119 -67c-54 0 -123 25 -123 120c0 49 21 111 58 210c6 15 17 44 17 68c0 32 -16 33 -25 33c-38 0 -76 -37 -101 -124c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10 c0 9 37 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -17 -63c-26 -69 -54 -148 -54 -204c0 -37 10 -82 62 -82c73 0 113 80 114 84l75 301c8 34 34 35 39 35c15 0 29 -9 29 -27c0 -6 -10 -44 -15 -67c-4 -15 -14 -53 -17 -68l-28 -108c-8 -35 -20 -82 -20 -104 c0 -33 10 -46 31 -46c42 0 61 68 75 124c3 14 4 18 14 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D463" d="M468 372c0 -52 -57 -383 -225 -383c-46 0 -134 16 -134 124c0 43 13 89 57 205c7 18 17 45 17 70c0 32 -17 32 -25 32c-29 0 -72 -23 -101 -124c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 38 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -12 -50 c-31 -83 -58 -156 -58 -212c0 -52 23 -87 74 -87c117 0 178 229 178 271c0 36 -13 62 -34 82c-11 11 -16 17 -16 30c0 22 24 48 49 48c18 0 44 -16 44 -70Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D462" x="389" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="962" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D463" x="1407" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="1892" y="0"></use>
</g>
</svg> coordinates in the image corresponding to the ray&rsquo;s direction are computed
first.  The radiance
corresponding to those coordinates is returned if they are inside the portal
bounds for the ray origin, and a zero-valued spectrum is returned otherwise.
(In principle, the <tt>Le()</tt> method should only be called for rays that
have left the scene, so that the portal check should always pass, but it is
worth including for the occasional ray that escapes the scene due to a
geometric error in the scene model.  This way, those end up carrying no
radiance rather than causing a light leak.)

</p>
<p></p>
<span class="anchor" id="fragment-PortalImageInfiniteLightMethodDefinitions-0"></span><div class="fragmentname">&lt;&lt;PortalImageInfiniteLight Method Definitions&gt;&gt;=&nbsp;<a href="#fragment-PortalImageInfiniteLightMethodDefinitions-1"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode"><a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a>
<span class="anchor" id="PortalImageInfiniteLight::Le"></span>PortalImageInfiniteLight::Le(const <a href="../Geometry_and_Transformations/Rays.html#Ray" class="code">Ray</a> &amp;ray,
                             const <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledWavelengths" class="code">SampledWavelengths</a> &amp;lambda) const {
    pstd::optional&lt;<a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>&gt; uv = <a href="#PortalImageInfiniteLight::ImageFromRender" class="code">ImageFromRender</a>(<a href="../Geometry_and_Transformations/Vectors.html#Normalize" class="code">Normalize</a>(ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::d" class="code">d</a>));
    pstd::optional&lt;<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds2f" class="code">Bounds2f</a>&gt; b = <a href="#PortalImageInfiniteLight::ImageBounds" class="code">ImageBounds</a>(ray.<a href="../Geometry_and_Transformations/Rays.html#Ray::o" class="code">o</a>);
    if (!uv || !b || !<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds2::Inside" class="code">Inside</a>(*uv, *b))
        return <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a>(0.f);
    return <a href="#PortalImageInfiniteLight::ImageLookup" class="code">ImageLookup</a>(*uv, lambda);
}</div><p>


</p>
<p>The <tt>ImageLookup()</tt> method returns the radiance at the given image
<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.301ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 2282.2 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">left-parenthesis u comma v right-parenthesis</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D462" d="M543 143c0 0 -13 -63 -30 -99c-16 -32 -39 -55 -74 -55c-43 0 -78 26 -89 67c-17 -22 -53 -67 -119 -67c-54 0 -123 25 -123 120c0 49 21 111 58 210c6 15 17 44 17 68c0 32 -16 33 -25 33c-38 0 -76 -37 -101 -124c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10 c0 9 37 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -17 -63c-26 -69 -54 -148 -54 -204c0 -37 10 -82 62 -82c73 0 113 80 114 84l75 301c8 34 34 35 39 35c15 0 29 -9 29 -27c0 -6 -10 -44 -15 -67c-4 -15 -14 -53 -17 -68l-28 -108c-8 -35 -20 -82 -20 -104 c0 -33 10 -46 31 -46c42 0 61 68 75 124c3 14 4 18 14 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D463" d="M468 372c0 -52 -57 -383 -225 -383c-46 0 -134 16 -134 124c0 43 13 89 57 205c7 18 17 45 17 70c0 32 -17 32 -25 32c-29 0 -72 -23 -101 -124c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 38 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -12 -50 c-31 -83 -58 -156 -58 -212c0 -52 23 -87 74 -87c117 0 178 229 178 271c0 36 -13 62 -34 82c-11 11 -16 17 -16 30c0 22 24 48 49 48c18 0 44 -16 44 -70Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D462" x="389" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="962" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D463" x="1407" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="1892" y="0"></use>
</g>
</svg> and wavelengths.  We encapsulate this functionality in its own
method, as it will be useful repeatedly in the remainder of the light&rsquo;s
implementation.

</p>
<p></p>
<span class="anchor" id="fragment-PortalImageInfiniteLightMethodDefinitions-1"></span><div class="fragmentname">&lt;&lt;PortalImageInfiniteLight Method Definitions&gt;&gt;+=&nbsp;<a href="#fragment-PortalImageInfiniteLightMethodDefinitions-0"><span class="fa fa-caret-up"></span></a>&nbsp;<a href="#fragment-PortalImageInfiniteLightMethodDefinitions-2"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode"><a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> <span class="anchor" id="PortalImageInfiniteLight::ImageLookup"></span>PortalImageInfiniteLight::ImageLookup(
        <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a> uv, const <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledWavelengths" class="code">SampledWavelengths</a> &amp;lambda) const {
    <a href="../Radiometry,_Spectra,_and_Color/Color.html#RGB" class="code">RGB</a> rgb;
    for (int c = 0; c &lt; 3; ++c)
        rgb[c] = image.<a href="../Utilities/Images.html#Image::LookupNearestChannel" class="code">LookupNearestChannel</a>(uv, c);
    <a href="../Radiometry,_Spectra,_and_Color/Color.html#RGBIlluminantSpectrum" class="code">RGBIlluminantSpectrum</a> spec(*<a href="#PortalImageInfiniteLight::imageColorSpace" class="code">imageColorSpace</a>, ClampZero(rgb));
    return <a href="#PortalImageInfiniteLight::scale" class="code">scale</a> * spec.<a href="../Radiometry,_Spectra,_and_Color/Color.html#RGBIlluminantSpectrum::Sample" class="code">Sample</a>(lambda);
}</div><p>


</p>
<p>As before, the image&rsquo;s color space must be known in order to convert its
RGB values to spectra.

</p>
<p></p>
<span class="anchor" id="fragment-PortalImageInfiniteLightPrivateMembers-3"></span><div class="fragmentname">&lt;&lt;PortalImageInfiniteLight Private Members&gt;&gt;+=&nbsp;<a href="#fragment-PortalImageInfiniteLightPrivateMembers-2"><span class="fa fa-caret-up"></span></a>&nbsp;<a href="#fragment-PortalImageInfiniteLightPrivateMembers-4"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode">const <a href="../Radiometry,_Spectra,_and_Color/Color.html#RGBColorSpace" class="code">RGBColorSpace</a> *<span class="anchor" id="PortalImageInfiniteLight::imageColorSpace"></span>imageColorSpace;
Float <span class="anchor" id="PortalImageInfiniteLight::scale"></span>scale;</div><p>


</p>
<p><tt>SampleLi()</tt> is able to take advantage of the combination of the
rectified image representation and the ability of
<a href="../Sampling_Algorithms/Sampling_Multidimensional_Functions.html#WindowedPiecewiseConstant2D"><tt>WindowedPiecewiseConstant2D</tt></a> to sample a direction from the specified
point that passes through the portal, according to the directional
distribution of radiance over the portal.

</p>
<p></p>
<span class="anchor" id="fragment-PortalImageInfiniteLightMethodDefinitions-2"></span><div class="fragmentname">&lt;&lt;PortalImageInfiniteLight Method Definitions&gt;&gt;+=&nbsp;<a href="#fragment-PortalImageInfiniteLightMethodDefinitions-1"><span class="fa fa-caret-up"></span></a>&nbsp;<a href="#fragment-PortalImageInfiniteLightMethodDefinitions-3"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode">pstd::optional&lt;<a href="../Light_Sources/Light_Interface.html#LightLiSample" class="code">LightLiSample</a>&gt;
<span class="anchor" id="PortalImageInfiniteLight::SampleLi"></span>PortalImageInfiniteLight::SampleLi(<a href="../Light_Sources/Light_Interface.html#LightSampleContext" class="code">LightSampleContext</a> ctx, <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a> u,
        <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledWavelengths" class="code">SampledWavelengths</a> lambda, bool allowIncompletePDF) const {
    &lt;&lt;<span class="fragmentname"><a href="#fragment-Sampleuvinpotentiallyvisibleregionoflightimage-0">Sample <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.301ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 2282.2 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">left-parenthesis u comma v right-parenthesis</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D462" d="M543 143c0 0 -13 -63 -30 -99c-16 -32 -39 -55 -74 -55c-43 0 -78 26 -89 67c-17 -22 -53 -67 -119 -67c-54 0 -123 25 -123 120c0 49 21 111 58 210c6 15 17 44 17 68c0 32 -16 33 -25 33c-38 0 -76 -37 -101 -124c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10 c0 9 37 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -17 -63c-26 -69 -54 -148 -54 -204c0 -37 10 -82 62 -82c73 0 113 80 114 84l75 301c8 34 34 35 39 35c15 0 29 -9 29 -27c0 -6 -10 -44 -15 -67c-4 -15 -14 -53 -17 -68l-28 -108c-8 -35 -20 -82 -20 -104 c0 -33 10 -46 31 -46c42 0 61 68 75 124c3 14 4 18 14 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D463" d="M468 372c0 -52 -57 -383 -225 -383c-46 0 -134 16 -134 124c0 43 13 89 57 205c7 18 17 45 17 70c0 32 -17 32 -25 32c-29 0 -72 -23 -101 -124c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 38 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -12 -50 c-31 -83 -58 -156 -58 -212c0 -52 23 -87 74 -87c117 0 178 229 178 271c0 36 -13 62 -34 82c-11 11 -16 17 -16 30c0 22 24 48 49 48c18 0 44 -16 44 -70Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D462" x="389" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="962" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D463" x="1407" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="1892" y="0"></use>
</g>
</svg> in potentially visible region of light image</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1704" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1704"><i></i></a><div id="fragbit-1704" class="collapse show"><div class="fragmentcode">       pstd::optional&lt;<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds2f" class="code">Bounds2f</a>&gt; b = <a href="#PortalImageInfiniteLight::ImageBounds" class="code">ImageBounds</a>(ctx.<a href="../Light_Sources/Light_Interface.html#LightSampleContext::p" class="code">p</a>());
       if (!b) return {};
       Float mapPDF;
       pstd::optional&lt;<a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>&gt; uv = <a href="#PortalImageInfiniteLight::distribution" class="code">distribution</a>.<a href="../Sampling_Algorithms/Sampling_Multidimensional_Functions.html#WindowedPiecewiseConstant2D::Sample" class="code">Sample</a>(u, *b, &amp;mapPDF);
       if (!uv) return {};</div></div>
    &lt;&lt;<span class="fragmentname"><a href="#fragment-ConvertportalimagesamplepointtodirectionandcomputePDF-0">Convert portal image sample point to direction and compute PDF</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1705" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1705"><i></i></a><div id="fragbit-1705" class="collapse show"><div class="fragmentcode">       Float duv_dw;
       <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> wi = <a href="#PortalImageInfiniteLight::RenderFromImage" class="code">RenderFromImage</a>(*uv, &amp;duv_dw);
       if (duv_dw == 0) return {};
       Float pdf = mapPDF / duv_dw;
       </div></div>
    &lt;&lt;<span class="fragmentname"><a href="#fragment-ComputeradianceforportallightsampleandreturnmonoLightLiSample-0">Compute radiance for portal light sample and return <tt>LightLiSample</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1706" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1706"><i></i></a><div id="fragbit-1706" class="collapse show"><div class="fragmentcode">       <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> L = <a href="#PortalImageInfiniteLight::ImageLookup" class="code">ImageLookup</a>(*uv, lambda);
       <a href="../Geometry_and_Transformations/Points.html#Point3f" class="code">Point3f</a> pl = ctx.<a href="../Light_Sources/Light_Interface.html#LightSampleContext::p" class="code">p</a>() + 2 * <a href="#PortalImageInfiniteLight::sceneRadius" class="code">sceneRadius</a> * wi; 
       return <a href="../Light_Sources/Light_Interface.html#LightLiSample" class="code">LightLiSample</a>(L, wi, pdf, <a href="../Geometry_and_Transformations/Interactions.html#Interaction" class="code">Interaction</a>(pl, &amp;<a href="../Light_Sources/Light_Interface.html#LightBase::mediumInterface" class="code">mediumInterface</a>));</div></div>
}</div><p>


</p>
<p><tt>WindowedPiecewiseConstant2D</tt>&rsquo;s <tt>Sample()</tt> method takes a
<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds2f"><tt>Bounds2f</tt></a> to specify the sampling region.  This is easily provided
using the <tt>ImageBounds()</tt> method.  It may not be able to generate a
valid sample&mdash;for example, if the point is on the outside of the portal or
lies on its plane.  In this case, an unset sample is returned.

</p>
<p></p>
<span class="anchor" id="fragment-Sampleuvinpotentiallyvisibleregionoflightimage-0"></span><div class="fragmentname">&lt;&lt;Sample <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.301ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 2282.2 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">left-parenthesis u comma v right-parenthesis</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D462" d="M543 143c0 0 -13 -63 -30 -99c-16 -32 -39 -55 -74 -55c-43 0 -78 26 -89 67c-17 -22 -53 -67 -119 -67c-54 0 -123 25 -123 120c0 49 21 111 58 210c6 15 17 44 17 68c0 32 -16 33 -25 33c-38 0 -76 -37 -101 -124c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10 c0 9 37 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -17 -63c-26 -69 -54 -148 -54 -204c0 -37 10 -82 62 -82c73 0 113 80 114 84l75 301c8 34 34 35 39 35c15 0 29 -9 29 -27c0 -6 -10 -44 -15 -67c-4 -15 -14 -53 -17 -68l-28 -108c-8 -35 -20 -82 -20 -104 c0 -33 10 -46 31 -46c42 0 61 68 75 124c3 14 4 18 14 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D463" d="M468 372c0 -52 -57 -383 -225 -383c-46 0 -134 16 -134 124c0 43 13 89 57 205c7 18 17 45 17 70c0 32 -17 32 -25 32c-29 0 -72 -23 -101 -124c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 38 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -12 -50 c-31 -83 -58 -156 -58 -212c0 -52 23 -87 74 -87c117 0 178 229 178 271c0 36 -13 62 -34 82c-11 11 -16 17 -16 30c0 22 24 48 49 48c18 0 44 -16 44 -70Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D462" x="389" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="962" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D463" x="1407" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="1892" y="0"></use>
</g>
</svg> in potentially visible region of light image&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">pstd::optional&lt;<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds2f" class="code">Bounds2f</a>&gt; b = <a href="#PortalImageInfiniteLight::ImageBounds" class="code">ImageBounds</a>(ctx.<a href="../Light_Sources/Light_Interface.html#LightSampleContext::p" class="code">p</a>());
if (!b) return {};
Float mapPDF;
pstd::optional&lt;<a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>&gt; uv = <a href="#PortalImageInfiniteLight::distribution" class="code">distribution</a>.<a href="../Sampling_Algorithms/Sampling_Multidimensional_Functions.html#WindowedPiecewiseConstant2D::Sample" class="code">Sample</a>(u, *b, &amp;mapPDF);
if (!uv) return {};</div><p>


</p>
<p>After image <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.301ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 2282.2 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">left-parenthesis u comma v right-parenthesis</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D462" d="M543 143c0 0 -13 -63 -30 -99c-16 -32 -39 -55 -74 -55c-43 0 -78 26 -89 67c-17 -22 -53 -67 -119 -67c-54 0 -123 25 -123 120c0 49 21 111 58 210c6 15 17 44 17 68c0 32 -16 33 -25 33c-38 0 -76 -37 -101 -124c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10 c0 9 37 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -17 -63c-26 -69 -54 -148 -54 -204c0 -37 10 -82 62 -82c73 0 113 80 114 84l75 301c8 34 34 35 39 35c15 0 29 -9 29 -27c0 -6 -10 -44 -15 -67c-4 -15 -14 -53 -17 -68l-28 -108c-8 -35 -20 -82 -20 -104 c0 -33 10 -46 31 -46c42 0 61 68 75 124c3 14 4 18 14 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D463" d="M468 372c0 -52 -57 -383 -225 -383c-46 0 -134 16 -134 124c0 43 13 89 57 205c7 18 17 45 17 70c0 32 -17 32 -25 32c-29 0 -72 -23 -101 -124c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 38 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -12 -50 c-31 -83 -58 -156 -58 -212c0 -52 23 -87 74 -87c117 0 178 229 178 271c0 36 -13 62 -34 82c-11 11 -16 17 -16 30c0 22 24 48 49 48c18 0 44 -16 44 -70Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D462" x="389" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="962" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D463" x="1407" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="1892" y="0"></use>
</g>
</svg> coordinates are converted to a direction, the method 
computes the sampling PDF with respect to solid angle at the reference point
represented by <tt>ctx</tt>.  Doing so just requires the application of the
change of variables factor returned by <tt>RenderFromImage()</tt>.

</p>
<p></p>
<span class="anchor" id="fragment-ConvertportalimagesamplepointtodirectionandcomputePDF-0"></span><div class="fragmentname">&lt;&lt;Convert portal image sample point to direction and compute PDF&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">Float duv_dw;
<a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> wi = <a href="#PortalImageInfiniteLight::RenderFromImage" class="code">RenderFromImage</a>(*uv, &amp;duv_dw);
if (duv_dw == 0) return {};
Float pdf = mapPDF / duv_dw;
</div><p>


</p>
<p>The remaining pieces are easy at this point: <tt>ImageLookup()</tt> provides
the radiance for the sampled direction and the endpoint of the shadow ray
is found in the same way that is done for the other infinite lights.

</p>
<p></p>
<span class="anchor" id="fragment-ComputeradianceforportallightsampleandreturnmonoLightLiSample-0"></span><div class="fragmentname">&lt;&lt;Compute radiance for portal light sample and return <tt>LightLiSample</tt>&gt;&gt;=&nbsp;</div>
<div class="fragmentcode"><a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> L = <a href="#PortalImageInfiniteLight::ImageLookup" class="code">ImageLookup</a>(*uv, lambda);
<a href="../Geometry_and_Transformations/Points.html#Point3f" class="code">Point3f</a> pl = ctx.<a href="../Light_Sources/Light_Interface.html#LightSampleContext::p" class="code">p</a>() + 2 * <a href="#PortalImageInfiniteLight::sceneRadius" class="code">sceneRadius</a> * wi; 
return <a href="../Light_Sources/Light_Interface.html#LightLiSample" class="code">LightLiSample</a>(L, wi, pdf, <a href="../Geometry_and_Transformations/Interactions.html#Interaction" class="code">Interaction</a>(pl, &amp;<a href="../Light_Sources/Light_Interface.html#LightBase::mediumInterface" class="code">mediumInterface</a>));</div><p>


</p>
<p>Also as with the other infinite lights, the radius of the scene&rsquo;s bounding
sphere is stored when the <tt>Preprocess()</tt> method, not included here, is
called.

</p>
<p></p>
<span class="anchor" id="fragment-PortalImageInfiniteLightPrivateMembers-4"></span><div class="fragmentname">&lt;&lt;PortalImageInfiniteLight Private Members&gt;&gt;+=&nbsp;<a href="#fragment-PortalImageInfiniteLightPrivateMembers-3"><span class="fa fa-caret-up"></span></a></div>
<div class="fragmentcode">Float <span class="anchor" id="PortalImageInfiniteLight::sceneRadius"></span>sceneRadius;</div><p>


</p>
<p>Finding the PDF for a specified direction follows the way in which the PDF
was calculated in the sampling method.

</p>
<p></p>
<span class="anchor" id="fragment-PortalImageInfiniteLightMethodDefinitions-3"></span><div class="fragmentname">&lt;&lt;PortalImageInfiniteLight Method Definitions&gt;&gt;+=&nbsp;<a href="#fragment-PortalImageInfiniteLightMethodDefinitions-2"><span class="fa fa-caret-up"></span></a></div>
<div class="fragmentcode">Float <span class="anchor" id="PortalImageInfiniteLight::PDF_Li"></span>PortalImageInfiniteLight::PDF_Li(<a href="../Light_Sources/Light_Interface.html#LightSampleContext" class="code">LightSampleContext</a> ctx, <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> w,
                                       bool allowIncompletePDF) const {
    &lt;&lt;<span class="fragmentname"><a href="#fragment-Findimageuvcoordinatescorrespondingtodirectionmonow-0">Find image <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.301ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 2282.2 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">left-parenthesis u comma v right-parenthesis</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D462" d="M543 143c0 0 -13 -63 -30 -99c-16 -32 -39 -55 -74 -55c-43 0 -78 26 -89 67c-17 -22 -53 -67 -119 -67c-54 0 -123 25 -123 120c0 49 21 111 58 210c6 15 17 44 17 68c0 32 -16 33 -25 33c-38 0 -76 -37 -101 -124c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10 c0 9 37 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -17 -63c-26 -69 -54 -148 -54 -204c0 -37 10 -82 62 -82c73 0 113 80 114 84l75 301c8 34 34 35 39 35c15 0 29 -9 29 -27c0 -6 -10 -44 -15 -67c-4 -15 -14 -53 -17 -68l-28 -108c-8 -35 -20 -82 -20 -104 c0 -33 10 -46 31 -46c42 0 61 68 75 124c3 14 4 18 14 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D463" d="M468 372c0 -52 -57 -383 -225 -383c-46 0 -134 16 -134 124c0 43 13 89 57 205c7 18 17 45 17 70c0 32 -17 32 -25 32c-29 0 -72 -23 -101 -124c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 38 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -12 -50 c-31 -83 -58 -156 -58 -212c0 -52 23 -87 74 -87c117 0 178 229 178 271c0 36 -13 62 -34 82c-11 11 -16 17 -16 30c0 22 24 48 49 48c18 0 44 -16 44 -70Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D462" x="389" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="962" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D463" x="1407" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="1892" y="0"></use>
</g>
</svg> coordinates corresponding to direction <tt>w</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1707" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1707"><i></i></a><div id="fragbit-1707" class="collapse show"><div class="fragmentcode">       Float duv_dw;
       pstd::optional&lt;<a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>&gt; uv = <a href="#PortalImageInfiniteLight::ImageFromRender" class="code">ImageFromRender</a>(w, &amp;duv_dw);
       if (!uv || duv_dw == 0) return 0;</div></div>
    &lt;&lt;<span class="fragmentname"><a href="#fragment-ReturnPDFforsamplinguvfromreferencepoint-0">Return PDF for sampling <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.301ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 2282.2 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">left-parenthesis u comma v right-parenthesis</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D462" d="M543 143c0 0 -13 -63 -30 -99c-16 -32 -39 -55 -74 -55c-43 0 -78 26 -89 67c-17 -22 -53 -67 -119 -67c-54 0 -123 25 -123 120c0 49 21 111 58 210c6 15 17 44 17 68c0 32 -16 33 -25 33c-38 0 -76 -37 -101 -124c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10 c0 9 37 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -17 -63c-26 -69 -54 -148 -54 -204c0 -37 10 -82 62 -82c73 0 113 80 114 84l75 301c8 34 34 35 39 35c15 0 29 -9 29 -27c0 -6 -10 -44 -15 -67c-4 -15 -14 -53 -17 -68l-28 -108c-8 -35 -20 -82 -20 -104 c0 -33 10 -46 31 -46c42 0 61 68 75 124c3 14 4 18 14 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D463" d="M468 372c0 -52 -57 -383 -225 -383c-46 0 -134 16 -134 124c0 43 13 89 57 205c7 18 17 45 17 70c0 32 -17 32 -25 32c-29 0 -72 -23 -101 -124c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 38 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -12 -50 c-31 -83 -58 -156 -58 -212c0 -52 23 -87 74 -87c117 0 178 229 178 271c0 36 -13 62 -34 82c-11 11 -16 17 -16 30c0 22 24 48 49 48c18 0 44 -16 44 -70Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D462" x="389" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="962" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D463" x="1407" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="1892" y="0"></use>
</g>
</svg> from reference point</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-1708" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-1708"><i></i></a><div id="fragbit-1708" class="collapse show"><div class="fragmentcode">       pstd::optional&lt;<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds2f" class="code">Bounds2f</a>&gt; b = <a href="#PortalImageInfiniteLight::ImageBounds" class="code">ImageBounds</a>(ctx.<a href="../Light_Sources/Light_Interface.html#LightSampleContext::p" class="code">p</a>());
       if (!b) return 0;
       Float pdf = distribution.<a href="../Sampling_Algorithms/Sampling_Multidimensional_Functions.html#WindowedPiecewiseConstant2D::PDF" class="code">PDF</a>(*uv, *b);
       return pdf / duv_dw;</div></div>
}</div><p>


</p>
<p>First, <tt>ImageFromRender()</tt> gives the <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.301ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 2282.2 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">left-parenthesis u comma v right-parenthesis</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D462" d="M543 143c0 0 -13 -63 -30 -99c-16 -32 -39 -55 -74 -55c-43 0 -78 26 -89 67c-17 -22 -53 -67 -119 -67c-54 0 -123 25 -123 120c0 49 21 111 58 210c6 15 17 44 17 68c0 32 -16 33 -25 33c-38 0 -76 -37 -101 -124c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10 c0 9 37 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -17 -63c-26 -69 -54 -148 -54 -204c0 -37 10 -82 62 -82c73 0 113 80 114 84l75 301c8 34 34 35 39 35c15 0 29 -9 29 -27c0 -6 -10 -44 -15 -67c-4 -15 -14 -53 -17 -68l-28 -108c-8 -35 -20 -82 -20 -104 c0 -33 10 -46 31 -46c42 0 61 68 75 124c3 14 4 18 14 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D463" d="M468 372c0 -52 -57 -383 -225 -383c-46 0 -134 16 -134 124c0 43 13 89 57 205c7 18 17 45 17 70c0 32 -17 32 -25 32c-29 0 -72 -23 -101 -124c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 38 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -12 -50 c-31 -83 -58 -156 -58 -212c0 -52 23 -87 74 -87c117 0 178 229 178 271c0 36 -13 62 -34 82c-11 11 -16 17 -16 30c0 22 24 48 49 48c18 0 44 -16 44 -70Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D462" x="389" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="962" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D463" x="1407" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="1892" y="0"></use>
</g>
</svg> coordinates in the portal
image for the specified direction.

</p>
<p></p>
<span class="anchor" id="fragment-Findimageuvcoordinatescorrespondingtodirectionmonow-0"></span><div class="fragmentname">&lt;&lt;Find image <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.301ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 2282.2 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">left-parenthesis u comma v right-parenthesis</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D462" d="M543 143c0 0 -13 -63 -30 -99c-16 -32 -39 -55 -74 -55c-43 0 -78 26 -89 67c-17 -22 -53 -67 -119 -67c-54 0 -123 25 -123 120c0 49 21 111 58 210c6 15 17 44 17 68c0 32 -16 33 -25 33c-38 0 -76 -37 -101 -124c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10 c0 9 37 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -17 -63c-26 -69 -54 -148 -54 -204c0 -37 10 -82 62 -82c73 0 113 80 114 84l75 301c8 34 34 35 39 35c15 0 29 -9 29 -27c0 -6 -10 -44 -15 -67c-4 -15 -14 -53 -17 -68l-28 -108c-8 -35 -20 -82 -20 -104 c0 -33 10 -46 31 -46c42 0 61 68 75 124c3 14 4 18 14 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D463" d="M468 372c0 -52 -57 -383 -225 -383c-46 0 -134 16 -134 124c0 43 13 89 57 205c7 18 17 45 17 70c0 32 -17 32 -25 32c-29 0 -72 -23 -101 -124c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 38 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -12 -50 c-31 -83 -58 -156 -58 -212c0 -52 23 -87 74 -87c117 0 178 229 178 271c0 36 -13 62 -34 82c-11 11 -16 17 -16 30c0 22 24 48 49 48c18 0 44 -16 44 -70Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D462" x="389" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="962" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D463" x="1407" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="1892" y="0"></use>
</g>
</svg> coordinates corresponding to direction <tt>w</tt>&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">Float duv_dw;
pstd::optional&lt;<a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>&gt; uv = <a href="#PortalImageInfiniteLight::ImageFromRender" class="code">ImageFromRender</a>(w, &amp;duv_dw);
if (!uv || duv_dw == 0) return 0;</div><p>


</p>
<p>Following its <tt>Sample()</tt> method, the
<a href="../Sampling_Algorithms/Sampling_Multidimensional_Functions.html#WindowedPiecewiseConstant2D::PDF"><tt>WindowedPiecewiseConstant2D::PDF()</tt></a> method also takes a 2D bounding
box to window the function.  The PDF value it returns is normalized with
respect to those bounds and a value of zero is returned if the given point
is outside of them.  Application of the change of variables factor gives
the final PDF with respect to solid angle.

</p>
<p></p>
<span class="anchor" id="fragment-ReturnPDFforsamplinguvfromreferencepoint-0"></span><div class="fragmentname">&lt;&lt;Return PDF for sampling <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.301ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 2282.2 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">left-parenthesis u comma v right-parenthesis</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D462" d="M543 143c0 0 -13 -63 -30 -99c-16 -32 -39 -55 -74 -55c-43 0 -78 26 -89 67c-17 -22 -53 -67 -119 -67c-54 0 -123 25 -123 120c0 49 21 111 58 210c6 15 17 44 17 68c0 32 -16 33 -25 33c-38 0 -76 -37 -101 -124c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10 c0 9 37 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -17 -63c-26 -69 -54 -148 -54 -204c0 -37 10 -82 62 -82c73 0 113 80 114 84l75 301c8 34 34 35 39 35c15 0 29 -9 29 -27c0 -6 -10 -44 -15 -67c-4 -15 -14 -53 -17 -68l-28 -108c-8 -35 -20 -82 -20 -104 c0 -33 10 -46 31 -46c42 0 61 68 75 124c3 14 4 18 14 18c3 0 12 0 12 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D463" d="M468 372c0 -52 -57 -383 -225 -383c-46 0 -134 16 -134 124c0 43 13 89 57 205c7 18 17 45 17 70c0 32 -17 32 -25 32c-29 0 -72 -23 -101 -124c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10c0 9 38 154 132 154c50 0 82 -37 82 -82c0 -19 -5 -33 -12 -50 c-31 -83 -58 -156 -58 -212c0 -52 23 -87 74 -87c117 0 178 229 178 271c0 36 -13 62 -34 82c-11 11 -16 17 -16 30c0 22 24 48 49 48c18 0 44 -16 44 -70Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D462" x="389" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="962" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D463" x="1407" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="1892" y="0"></use>
</g>
</svg> from reference point&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">pstd::optional&lt;<a href="../Geometry_and_Transformations/Bounding_Boxes.html#Bounds2f" class="code">Bounds2f</a>&gt; b = <a href="#PortalImageInfiniteLight::ImageBounds" class="code">ImageBounds</a>(ctx.<a href="../Light_Sources/Light_Interface.html#LightSampleContext::p" class="code">p</a>());
if (!b) return 0;
Float pdf = distribution.<a href="../Sampling_Algorithms/Sampling_Multidimensional_Functions.html#WindowedPiecewiseConstant2D::PDF" class="code">PDF</a>(*uv, *b);
return pdf / duv_dw;</div><p>


</p>
<p>

</p>
<p>

</p>
<p></p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

</div>  <!-- container-fluid -->
</div>  <!-- maincontainer -->

<nav class="navbar navbar-expand-md bg-light navbar-light">
<div class="container-fluid">
  <span class="navbar-text"><i>Physically Based Rendering: From Theory To Implementation</i>,<br>
<a href="https://creativecommons.org/licenses/by-nc-nd/4.0/">&copy; 2004-2023</a> Matt Pharr, Wenzel Jakob, and Greg Humphreys.
<a href="https://github.com/mmp/pbr-book-website/"><span class="fab fa-github"></span></a><br>
Purchase a printed copy: <a href="https://www.amazon.com/Physically-Based-Rendering-fourth-Implementation/dp/0262048027?keywords=physically+based+rendering+4th+edition&qid=1671730412&sprefix=physically+based%!C(MISSING)aps%!C(MISSING)145&sr=8-1&linkCode=ll1&tag=pharr-20&linkId=81a816d90f0c7e872617f1f930a51fd6&language=en_US&ref_=as_li_ss_tl"><span class="fab fa-amazon"></span></a>
<a href="https://mitpress.mit.edu/9780262048026/physically-based-rendering/"><img src="/mitpress.png" width=10 height=16></a>
</span>
</div>
  <div class="container">
    <ul class="nav navbar-nav ml-auto">
      <li class="nav-item">Next: <a href="../Light_Sources/Light_Sampling.html">Light Sources / Light Sampling</a></li>
    </ul>
  </div>

</nav>

<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
<script>
  $(function () {
    $('[data-toggle="popover"]').popover()
    $('[data-toggle="tooltip"]').tooltip()
   })
</script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>

<script>
// https://stackoverflow.com/a/17535094
// The function actually applying the offset
function offsetAnchor() {
  if (location.hash.length !== 0) {
    window.scrollTo(window.scrollX, window.scrollY - window.innerHeight / 8);
  }
}

// Captures click events of all <a> elements with href starting with #
$(document).on('click', 'a[href^="#"]', function(event) {
  // Click events are captured before hashchanges. Timeout
  // causes offsetAnchor to be called after the page jump.
  window.setTimeout(function() {
    offsetAnchor();
  }, 500);
});

// Set the offset when entering page with hash present in the url
window.setTimeout(offsetAnchor, 1500);
</script>

</body>
</html>
