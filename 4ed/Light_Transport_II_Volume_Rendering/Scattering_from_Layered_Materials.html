
<!doctype html>
<html lang="en">
<head>

<!-- all praise to https://realfavicongenerator.net -->
<link rel="icon" href="/favicon.ico?v=2" /> <!-- force refresh -->
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">

  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="/fonts.css">
  <link rel="stylesheet" href="../pbrstyle.css">
  <link rel="stylesheet" href="/fontawesome-free-5.15.3-web/css/all.css">

<script async src="https://cse.google.com/cse.js?cx=22a43cef261a245ea"></script>  <script src="/react.min.js"></script>
  <script src="/react-dom.min.js"></script>
  <script src="/jeri.min.js"></script>
  <link rel="preload" href="/exr.worker.js" as="script" crossorigin="anonymous">
  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="/bootstrap.min.css">

  <title>Scattering from Layered Materials</title>
</head>
        
<body>

<nav class="fixed-top-lg-navbar navbar navbar-expand bg-light navbar-light">
  <ul class="nav navbar-nav">
    <a class="navbar-brand" href="../contents.html"><img src="../pbr.jpg" width=25 height=25></a>
    <li class="nav-item"><a class="nav-link" href="../Light_Transport_II_Volume_Rendering.html">Light Transport II: Volume Rendering</a></li>
    <span class="navbar-text">/</span>
    <li class="nav-item"><a class="nav-link" href="#">Scattering from Layered Materials</a></li>
    <span class="navbar-text">&nbsp;&nbsp;</span>
    <li class="nav-item"><a class="nav-link" href="../Light_Transport_II_Volume_Rendering/Volume_Scattering_Integrators.html">(Previous: Volume Scattering Integrators)</a></li>
  </ul>

  <ul class="nav navbar-nav ml-auto d-none d-md-block">
        <li class="nav-item"><div class="gcse-search"></div></li>
    </ul>
  <ul class="nav navbar-nav d-block d-md-none">
        <li class="nav-item"><div class="gcse-search"></div></li>
    </ul>
</nav>

<div class="maincontainer">
<div class="container-fluid">

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">
<a href="#"><i class="fas fa-link "></i></a>
</div>
<div class="col-md-10 col-lg-8">
<span class="anchor" id="sec:scattering-layered"></span><h2>14.3 Scattering from Layered Materials</h2><p>



</p>
<p>In addition to describing scattering from larger-scale volumetric media
like clouds or smoke, the equation of transfer can be used to model
scattering at much smaller scales.  The <tt>LayeredBxDF</tt> applies it to
this task, implementing a reflection model that accounts for scattering from two
interfaces that are represented by surfaces with independent BSDFs and with a medium
between them.  Monte Carlo can be applied to estimating the integrals that
describe the aggregate scattering behavior,
in a way similar to what is done in light transport algorithms. This approach
is effectively the generalization of the technique used to sum up
aggregate scattering from a pair of perfectly smooth dielectric interfaces in
the <a href="../Reflection_Models/Dielectric_BSDF.html#ThinDielectricBxDF"><tt>ThinDielectricBxDF</tt></a> in Section&nbsp;<a href="../Reflection_Models/Dielectric_BSDF.html#sec:thin-dielectric-bxdf">9.5.1</a>.

</p>
<p>Modeling surface reflectance as a composition of layers makes it possible
to describe a variety of surfaces that are not well modeled by the BSDFs
presented in Chapter&nbsp;<a href="../Reflection_Models.html#chap:reflection-models">9</a>.  For example, automobile paint generally
has a smooth reflective &ldquo;clear coat&rdquo; layer applied on top of it; the overall
appearance of the paint is determined by the combination of light
scattering from the layer&rsquo;s interface as well as light scattering from the
paint.  (See Figure&nbsp;<a href="#fig:scattering-layered-surfaces">14.11</a>.)  Tarnished metal can be modeled by an underlying
metal BRDF with a thin scattering medium on top of it; it is again the
aggregate result of a variety of light scattering paths that determines the
overall appearance of the surface.

</p>
<p> </p>
<span class="anchor" id="fig:scattering-layered-surfaces"></span><div class="card outerfigure"><div class="card-body figure"><p>



</p>
<div class="figure-row">
  <a href="pha14f11.svg" title=""><img src="pha14f11.svg" width=462 height=267 style="max-width: 100%;"></a>
</div>
<p>


</p>
<figcaption class="caption">Figure 14.11: Scattering from Layered Surfaces. <span class="legend">
Surface reflection can be modeled with a series of layers, where each
interface between media is represented with a BSDF and where the media
between layers may itself both absorb and scatter light.  The aggregate
scattering from such a configuration can be determined by finding solutions
to the equation of transfer.</span>
</figcaption><p>


</p>
</div></div><p>


</p>
<p>With general layered media, light may exit the surface at a
different point than that at which it entered it. The <tt>LayeredBxDF</tt> does
not model this effect but instead assumes that light enters 
and exits at the same
point on the surface.  (As a <a href="../Reflection_Models/BSDF_Representation.html#BxDF"><tt>BxDF</tt></a>, it is unable to
express any other sort of scattering, anyway.)  This is a reasonable
approximation if the distance between the two interfaces is relatively small.
This approximation makes it possible to use a simplified 1D version of the equation of
transfer.  After deriving this variant, we will show its
application to evaluating and sampling such BSDFs.

</p>
<p>

</p>
<p></p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">
<a href="#TheOne-DimensionalEquationofTransfer"><i class="fas fa-link h3h4marginlink"></i></a>
</div>
<div class="col-md-10 col-lg-8">
<span id="TheOne-DimensionalEquationofTransfer"></span><h3>14.3.1  The One-Dimensional Equation of Transfer</h3><p>


</p>
<p>Given <em>plane-parallel</em> 3D scattering media where the scattering
properties are homogeneous across planes and only vary in depth, and where
the incident illumination does not vary as a function of
position over the medium&rsquo;s planar boundary, the equations that describe
scattering can be written in terms of 1D functions over depth (see
Figure&nbsp;<a href="#fig:1d-eot-setting">14.12</a>).

</p>
<p></p>
<span class="anchor" id="fig:1d-eot-setting"></span><div class="card outerfigure"><div class="card-body figure"><p>



</p>
<div class="figure-row">
  <a href="pha14f12.svg" title=""><img src="pha14f12.svg" width=323 height=259 style="max-width: 100%;"></a>
</div>
<p>


</p>
<figcaption class="caption">Figure 14.12: Setting for the One-Dimensional Equation of Transfer. <span class="legend">
If the properties of the medium only vary in one dimension and if the
incident illumination is uniform over its boundary, then the equilibrium
radiance distribution varies only with depth <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.086ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 467.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">z</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D467" d="M467 432c0 -4 -22 -52 -117 -145c-36 -36 -98 -90 -98 -90c-36 -31 -65 -56 -119 -114c9 3 27 3 27 3c21 0 36 -4 70 -17c21 -7 39 -13 59 -13c33 0 97 19 120 84c3 7 5 13 14 13c8 0 12 -5 12 -10c0 -27 -58 -154 -157 -154c-29 0 -47 16 -64 37c-25 29 -35 38 -58 38 c-32 0 -62 -27 -85 -62c-6 -11 -8 -13 -16 -13c0 0 -12 0 -12 10c0 7 35 64 103 131l90 84c19 16 103 88 139 131c-26 0 -37 0 -77 15c-23 8 -42 15 -63 15c-8 0 -66 -1 -85 -47c-2 -6 -4 -11 -13 -11s-12 6 -12 11c0 21 46 114 121 114c33 0 50 -20 69 -43 c15 -17 27 -32 51 -32s45 16 75 64c5 9 8 11 15 11c0 0 11 0 11 -10Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D467" x="0" y="0"></use>
</g>
</svg> and direction <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.446ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 622.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">omega Subscript</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
</g>
</svg> and
a 1D specialization of the equation of transfer can be used.</span>
</figcaption><p>


</p>
</div></div><p>


</p>
<p>In this
setting, the various quantities are more conveniently expressed as
functions of depth <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.086ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 467.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">z</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D467" d="M467 432c0 -4 -22 -52 -117 -145c-36 -36 -98 -90 -98 -90c-36 -31 -65 -56 -119 -114c9 3 27 3 27 3c21 0 36 -4 70 -17c21 -7 39 -13 59 -13c33 0 97 19 120 84c3 7 5 13 14 13c8 0 12 -5 12 -10c0 -27 -58 -154 -157 -154c-29 0 -47 16 -64 37c-25 29 -35 38 -58 38 c-32 0 -62 -27 -85 -62c-6 -11 -8 -13 -16 -13c0 0 -12 0 -12 10c0 7 35 64 103 131l90 84c19 16 103 88 139 131c-26 0 -37 0 -77 15c-23 8 -42 15 -63 15c-8 0 -66 -1 -85 -47c-2 -6 -4 -11 -13 -11s-12 6 -12 11c0 21 46 114 121 114c33 0 50 -20 69 -43 c15 -17 27 -32 51 -32s45 16 75 64c5 9 8 11 15 11c0 0 11 0 11 -10Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D467" x="0" y="0"></use>
</g>
</svg> rather than of distance <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="0.84ex" height="2.009ex" style="vertical-align: -0.338ex;" viewBox="0 -719.6 361.5 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">t</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D461" d="M330 420c0 -20 -10 -20 -30 -20h-94l-74 -295c-4 -17 -6 -24 -6 -48c0 -33 10 -46 31 -46c34 0 87 24 130 128c5 11 6 14 15 14c4 0 12 0 12 -10c0 -8 -57 -154 -159 -154c-54 0 -92 38 -92 92c0 18 4 35 76 319h-88c-20 0 -28 0 -28 12c0 19 10 19 30 19h94l39 159 c9 35 37 36 40 36c17 0 29 -10 29 -27c0 -6 -5 -26 -41 -168h88c18 0 28 0 28 -11Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D461" x="0" y="0"></use>
</g>
</svg> along a ray.  For example,
if the extinction coefficient is given by <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.094ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 2193.4 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">sigma Subscript normal t Baseline left-parenthesis z right-parenthesis</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D70E" d="M567 407c0 -34 -36 -34 -49 -34h-110c31 -44 31 -92 31 -109c0 -154 -133 -275 -251 -275c-91 0 -150 70 -150 158c0 119 111 284 262 284h228c18 0 39 0 39 -24zM375 276c0 31 -8 97 -92 97c-34 0 -94 -14 -136 -83c-35 -59 -47 -141 -47 -171c0 -72 40 -108 89 -108 c39 0 93 26 132 85c34 51 54 133 54 180Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-74" d="M332 124c0 -64 -28 -135 -99 -135c-36 0 -129 12 -129 135v276h-85v22c98 4 128 111 129 193h25v-184h143v-31h-143v-278c0 -17 0 -108 67 -108c37 0 67 38 67 112v55h25v-57Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D467" d="M467 432c0 -4 -22 -52 -117 -145c-36 -36 -98 -90 -98 -90c-36 -31 -65 -56 -119 -114c9 3 27 3 27 3c21 0 36 -4 70 -17c21 -7 39 -13 59 -13c33 0 97 19 120 84c3 7 5 13 14 13c8 0 12 -5 12 -10c0 -27 -58 -154 -157 -154c-29 0 -47 16 -64 37c-25 29 -35 38 -58 38 c-32 0 -62 -27 -85 -62c-6 -11 -8 -13 -16 -13c0 0 -12 0 -12 10c0 7 35 64 103 131l90 84c19 16 103 88 139 131c-26 0 -37 0 -77 15c-23 8 -42 15 -63 15c-8 0 -66 -1 -85 -47c-2 -6 -4 -11 -13 -11s-12 6 -12 11c0 21 46 114 121 114c33 0 50 -20 69 -43 c15 -17 27 -32 51 -32s45 16 75 64c5 9 8 11 15 11c0 0 11 0 11 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D70E" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-74" x="808" y="-213"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="946" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D467" x="1336" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="1803" y="0"></use>
</g>
</svg>, then the
transmittance between two depths <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.135ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 919.4 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">z 0</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D467" d="M467 432c0 -4 -22 -52 -117 -145c-36 -36 -98 -90 -98 -90c-36 -31 -65 -56 -119 -114c9 3 27 3 27 3c21 0 36 -4 70 -17c21 -7 39 -13 59 -13c33 0 97 19 120 84c3 7 5 13 14 13c8 0 12 -5 12 -10c0 -27 -58 -154 -157 -154c-29 0 -47 16 -64 37c-25 29 -35 38 -58 38 c-32 0 -62 -27 -85 -62c-6 -11 -8 -13 -16 -13c0 0 -12 0 -12 10c0 7 35 64 103 131l90 84c19 16 103 88 139 131c-26 0 -37 0 -77 15c-23 8 -42 15 -63 15c-8 0 -66 -1 -85 -47c-2 -6 -4 -11 -13 -11s-12 6 -12 11c0 21 46 114 121 114c33 0 50 -20 69 -43 c15 -17 27 -32 51 -32s45 16 75 64c5 9 8 11 15 11c0 0 11 0 11 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-30" d="M460 320c0 -79 -5 -157 -37 -226c-44 -95 -120 -116 -174 -116c-49 0 -122 20 -165 101c-41 76 -45 166 -45 241c0 80 5 158 37 227c41 93 114 119 174 119c42 0 124 -16 170 -112c35 -74 40 -154 40 -234zM377 332c0 63 0 139 -10 195c-19 99 -85 117 -118 117 c-25 0 -100 -9 -119 -128c-8 -54 -8 -120 -8 -184c0 -59 0 -151 11 -211c18 -96 77 -121 116 -121c45 0 102 30 117 125c11 64 11 132 11 207Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D467" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-30" x="658" y="-213"></use>
</g>
</svg> and <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.135ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 919.4 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">z 1</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D467" d="M467 432c0 -4 -22 -52 -117 -145c-36 -36 -98 -90 -98 -90c-36 -31 -65 -56 -119 -114c9 3 27 3 27 3c21 0 36 -4 70 -17c21 -7 39 -13 59 -13c33 0 97 19 120 84c3 7 5 13 14 13c8 0 12 -5 12 -10c0 -27 -58 -154 -157 -154c-29 0 -47 16 -64 37c-25 29 -35 38 -58 38 c-32 0 -62 -27 -85 -62c-6 -11 -8 -13 -16 -13c0 0 -12 0 -12 10c0 7 35 64 103 131l90 84c19 16 103 88 139 131c-26 0 -37 0 -77 15c-23 8 -42 15 -63 15c-8 0 -66 -1 -85 -47c-2 -6 -4 -11 -13 -11s-12 6 -12 11c0 21 46 114 121 114c33 0 50 -20 69 -43 c15 -17 27 -32 51 -32s45 16 75 64c5 9 8 11 15 11c0 0 11 0 11 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D467" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="658" y="-213"></use>
</g>
</svg> for a ray with direction
<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.446ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 622.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">omega Subscript</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
</g>
</svg> is
</p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">
<div class="displaymath"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="56.196ex" height="3.843ex" style="vertical-align: -0.838ex;" viewBox="0 -1293.7 24195.6 1654.5" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">upper T Subscript normal r Baseline left-parenthesis z 0 right-arrow z 1 comma omega Subscript Baseline right-parenthesis equals normal e Superscript minus integral Subscript z 0 Superscript z 1 Baseline sigma Super Subscript normal t Superscript left-parenthesis z Super Superscript prime Superscript right-parenthesis slash StartAbsoluteValue cosine theta EndAbsoluteValue normal d z Super Superscript prime Superscript Baseline equals normal e Superscript minus integral Subscript z 0 Superscript z 1 Baseline sigma Super Subscript normal t Superscript left-parenthesis z Super Superscript prime Superscript right-parenthesis slash StartAbsoluteValue omega Super Subscript Superscript Super Subscript z Superscript EndAbsoluteValue normal d z Super Superscript prime Superscript Baseline period</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D447" d="M704 666c0 -3 -1 -13 -2 -17l-27 -174c-2 -15 -4 -23 -15 -23c-9 0 -12 7 -12 13c0 3 2 15 3 19c4 26 8 65 8 80c0 78 -45 82 -146 82c-21 0 -54 0 -63 -2c-12 -3 -16 -9 -23 -37l-133 -531c-4 -15 -4 -21 -4 -21c0 -16 8 -19 37 -22c26 -2 39 -2 64 -2c26 0 34 0 34 -11 c0 -20 -12 -20 -22 -20c-28 0 -58 2 -87 2l-83 1l-85 -1c-27 0 -55 -2 -82 -2c-6 0 -17 0 -17 12c0 19 6 19 42 19c107 0 110 11 119 48l134 534c1 3 4 15 4 21c0 8 0 12 -28 12h-39c-148 0 -174 -18 -228 -173c-6 -16 -7 -21 -17 -21c-7 0 -12 5 -12 11c0 0 5 16 6 18 l60 176c7 19 8 20 32 20h555c17 0 27 0 27 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-72" d="M364 381c0 -32 -25 -44 -43 -44c-22 0 -43 15 -43 43c0 26 20 38 23 39c-2 1 -4 1 -11 1c-76 0 -118 -89 -118 -188v-154c0 -36 2 -47 76 -47h21v-31c-40 3 -87 3 -127 3l-114 -3v31c67 0 78 0 78 45v268c0 49 -8 56 -78 56v31l139 11v-110c14 43 50 110 123 110 c43 0 74 -29 74 -61Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D467" d="M467 432c0 -4 -22 -52 -117 -145c-36 -36 -98 -90 -98 -90c-36 -31 -65 -56 -119 -114c9 3 27 3 27 3c21 0 36 -4 70 -17c21 -7 39 -13 59 -13c33 0 97 19 120 84c3 7 5 13 14 13c8 0 12 -5 12 -10c0 -27 -58 -154 -157 -154c-29 0 -47 16 -64 37c-25 29 -35 38 -58 38 c-32 0 -62 -27 -85 -62c-6 -11 -8 -13 -16 -13c0 0 -12 0 -12 10c0 7 35 64 103 131l90 84c19 16 103 88 139 131c-26 0 -37 0 -77 15c-23 8 -42 15 -63 15c-8 0 -66 -1 -85 -47c-2 -6 -4 -11 -13 -11s-12 6 -12 11c0 21 46 114 121 114c33 0 50 -20 69 -43 c15 -17 27 -32 51 -32s45 16 75 64c5 9 8 11 15 11c0 0 11 0 11 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-30" d="M460 320c0 -79 -5 -157 -37 -226c-44 -95 -120 -116 -174 -116c-49 0 -122 20 -165 101c-41 76 -45 166 -45 241c0 80 5 158 37 227c41 93 114 119 174 119c42 0 124 -16 170 -112c35 -74 40 -154 40 -234zM377 332c0 63 0 139 -10 195c-19 99 -85 117 -118 117 c-25 0 -100 -9 -119 -128c-8 -54 -8 -120 -8 -184c0 -59 0 -151 11 -211c18 -96 77 -121 116 -121c45 0 102 30 117 125c11 64 11 132 11 207Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2192" d="M943 250c0 -6 -4 -11 -9 -13c-57 -19 -101 -59 -137 -104c-28 -36 -49 -80 -58 -127c-2 -9 -10 -16 -20 -16c-11 0 -20 9 -20 20c0 1 1 3 1 4c10 53 33 102 66 144c22 28 48 52 78 72h-766c-11 0 -20 9 -20 20s9 20 20 20h766c-30 20 -56 44 -78 72 c-33 42 -56 91 -66 144c0 1 -1 3 -1 4c0 11 9 20 20 20c10 0 18 -7 20 -16c9 -47 30 -91 58 -127c36 -45 80 -85 137 -104c5 -2 9 -7 9 -13Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3D" d="M722 347c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20zM722 153c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-65" d="M415 119c0 -19 -45 -130 -167 -130c-115 0 -220 97 -220 231c0 125 92 228 208 228c125 0 179 -97 179 -196c0 -21 -3 -21 -25 -21h-279c0 -36 0 -102 30 -150c23 -37 63 -67 113 -67c10 0 100 0 135 103c2 8 4 14 13 14c5 0 13 -2 13 -12zM349 252 c0 39 -10 174 -113 174c-34 0 -118 -25 -124 -174h237Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2212" d="M722 250c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-222B" d="M609 722c0 -30 -22 -43 -42 -43c-19 0 -41 13 -41 42c0 14 8 37 37 41c-22 19 -53 21 -63 21c-45 0 -79 -25 -93 -209l-19 -249c-8 -111 -44 -402 -57 -454c-22 -90 -70 -177 -165 -177c-60 0 -110 35 -110 83c0 30 22 43 42 43c19 0 41 -13 41 -42c0 -14 -8 -37 -37 -41 c21 -18 51 -21 64 -21c57 0 93 45 106 209l19 249c9 121 45 403 57 458c17 76 56 173 151 173c60 0 110 -35 110 -83Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D70E" d="M567 407c0 -34 -36 -34 -49 -34h-110c31 -44 31 -92 31 -109c0 -154 -133 -275 -251 -275c-91 0 -150 70 -150 158c0 119 111 284 262 284h228c18 0 39 0 39 -24zM375 276c0 31 -8 97 -92 97c-34 0 -94 -14 -136 -83c-35 -59 -47 -141 -47 -171c0 -72 40 -108 89 -108 c39 0 93 26 132 85c34 51 54 133 54 180Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-74" d="M332 124c0 -64 -28 -135 -99 -135c-36 0 -129 12 -129 135v276h-85v22c98 4 128 111 129 193h25v-184h143v-31h-143v-278c0 -17 0 -108 67 -108c37 0 67 38 67 112v55h25v-57Z"></path>
<path stroke-width="1" id="E1-LATINMODERNVARIANTS-2032" d="M340 496c0 -10 -3 -20 -8 -28l-227 -372h-38l171 424c6 15 26 29 48 29c30 0 54 -24 54 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2F" d="M445 730c0 -2 0 -5 -1 -7l-349 -960c-3 -8 -10 -13 -19 -13c-11 0 -20 9 -20 20c0 2 0 5 1 7l349 960c3 8 10 13 19 13c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-7C" d="M159 -230c0 -11 -9 -20 -20 -20s-20 9 -20 20v960c0 11 9 20 20 20s20 -9 20 -20v-960Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-63" d="M415 119c0 -10 -32 -130 -166 -130c-116 0 -215 99 -215 227c0 124 92 232 217 232c77 0 153 -39 153 -107c0 -30 -20 -47 -46 -47c-28 0 -46 20 -46 46c0 13 6 43 47 46c-35 36 -98 37 -107 37c-53 0 -135 -42 -135 -205c0 -161 88 -204 141 -204c37 0 102 12 131 105 c2 6 4 10 13 10c3 0 13 0 13 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6F" d="M471 214c0 -127 -101 -225 -222 -225c-117 0 -221 96 -221 225c0 125 97 234 222 234c121 0 221 -106 221 -234zM388 222c0 38 0 96 -26 139s-69 65 -113 65c-40 0 -87 -21 -114 -67c-24 -44 -24 -98 -24 -137c0 -36 0 -97 25 -141c27 -46 71 -67 114 -67 c50 0 94 29 116 74c22 44 22 98 22 134Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-73" d="M360 128c0 -72 -46 -139 -161 -139c-21 0 -66 1 -110 43c-18 -19 -18 -21 -20 -23c-19 -19 -20 -20 -25 -20c-11 0 -11 7 -11 24v132c0 18 0 25 13 25c10 0 11 -4 14 -17c19 -85 55 -142 139 -142c78 0 113 40 113 91c0 72 -82 88 -104 92c-72 14 -100 20 -132 46 c-27 22 -43 50 -43 85c0 56 38 123 160 123c15 0 56 0 94 -28c4 3 14 12 17 16c13 12 15 12 20 12c11 0 11 -7 11 -24v-101c0 -19 0 -24 -13 -24c0 0 -11 0 -12 9c-2 31 -7 121 -117 121c-86 0 -112 -41 -112 -76c0 -58 67 -71 123 -82c42 -8 81 -16 114 -48 c12 -12 42 -42 42 -95Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D703" d="M455 500c0 -224 -152 -511 -293 -511c-91 0 -120 111 -120 205c0 229 154 511 293 511c102 0 120 -139 120 -205zM389 562c0 57 -6 121 -55 121c-45 0 -82 -56 -109 -105c-40 -71 -60 -151 -77 -215h209c24 99 32 150 32 199zM348 331h-208c-26 -98 -32 -156 -32 -198 c0 -93 21 -122 54 -122c43 0 81 49 116 117c38 72 59 157 70 203Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-64" d="M527 0l-147 -11v66c-25 -32 -70 -66 -134 -66c-114 0 -212 99 -212 226c0 129 105 227 223 227c54 0 97 -26 126 -62v216c0 49 -8 56 -78 56v31l144 11v-607c0 -49 8 -56 78 -56v-31zM380 118v205c0 18 0 20 -11 37c-31 45 -73 60 -108 60c-54 0 -92 -33 -113 -64 c-29 -45 -31 -105 -31 -142c0 -41 3 -98 29 -139c24 -38 60 -64 105 -64c43 0 88 22 118 70c11 17 11 19 11 37Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2E" d="M192 53c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D447" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-72" x="826" y="-213"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="962" y="0"></use>
<g transform="translate(1351,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D467" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-30" x="658" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2192" x="2548" y="0"></use>
<g transform="translate(3827,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D467" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="658" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="4746" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="5191" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="5814" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="6481" y="0"></use>
<g transform="translate(7537,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-65" x="0" y="0"></use>
<g transform="translate(444,551)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="0" y="0"></use>
<g transform="translate(717,0)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-222B" x="0" y="0"></use>
<g transform="translate(470,348)">
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNNORMAL-1D467" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNMAIN-31" x="465" y="-323"></use>
</g>
<g transform="translate(470,-246)">
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNNORMAL-1D467" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNMAIN-30" x="465" y="-323"></use>
</g>
</g>
<g transform="translate(2037,0)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D70E" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNMAIN-74" x="703" y="-192"></use>
</g>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-28" x="3868" y="0"></use>
<g transform="translate(3010,0)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D467" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNVARIANTS-2032" x="576" y="446"></use>
</g>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-29" x="5157" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2F" x="5546" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-7C" x="6047" y="0"></use>
<g transform="translate(4472,0)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-63"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6F" x="444" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-73" x="945" y="0"></use>
</g>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D703" x="7900" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-7C" x="8370" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-64" x="8884" y="0"></use>
<g transform="translate(6675,0)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D467" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNVARIANTS-2032" x="576" y="446"></use>
</g>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="15671" y="0"></use>
<g transform="translate(16727,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-65" x="0" y="0"></use>
<g transform="translate(444,551)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="0" y="0"></use>
<g transform="translate(717,0)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-222B" x="0" y="0"></use>
<g transform="translate(470,348)">
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNNORMAL-1D467" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNMAIN-31" x="465" y="-323"></use>
</g>
<g transform="translate(470,-246)">
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNNORMAL-1D467" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNMAIN-30" x="465" y="-323"></use>
</g>
</g>
<g transform="translate(2037,0)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D70E" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNMAIN-74" x="703" y="-192"></use>
</g>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-28" x="3868" y="0"></use>
<g transform="translate(3010,0)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D467" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNVARIANTS-2032" x="576" y="446"></use>
</g>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-29" x="5157" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2F" x="5546" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-7C" x="6047" y="0"></use>
<g transform="translate(4472,0)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNNORMAL-1D467" x="766" y="-185"></use>
</g>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-7C" x="7427" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-64" x="7941" y="0"></use>
<g transform="translate(6009,0)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D467" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNVARIANTS-2032" x="576" y="446"></use>
</g>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2E" x="23917" y="0"></use>
</g>
</svg>
</div>
<p>

See Figure&nbsp;<a href="#fig:transmittance-1d">14.13</a>.  This definition uses the fact that if a ray with
direction <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.446ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 622.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">omega Subscript</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
</g>
</svg> travels a distance <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="0.84ex" height="2.009ex" style="vertical-align: -0.338ex;" viewBox="0 -719.6 361.5 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">t</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D461" d="M330 420c0 -20 -10 -20 -30 -20h-94l-74 -295c-4 -17 -6 -24 -6 -48c0 -33 10 -46 31 -46c34 0 87 24 130 128c5 11 6 14 15 14c4 0 12 0 12 -10c0 -8 -57 -154 -159 -154c-54 0 -92 38 -92 92c0 18 4 35 76 319h-88c-20 0 -28 0 -28 12c0 19 10 19 30 19h94l39 159 c9 35 37 36 40 36c17 0 29 -10 29 -27c0 -6 -5 -26 -41 -168h88c18 0 28 0 28 -11Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D461" x="0" y="0"></use>
</g>
</svg>, then the change in <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.086ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 467.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">z</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D467" d="M467 432c0 -4 -22 -52 -117 -145c-36 -36 -98 -90 -98 -90c-36 -31 -65 -56 -119 -114c9 3 27 3 27 3c21 0 36 -4 70 -17c21 -7 39 -13 59 -13c33 0 97 19 120 84c3 7 5 13 14 13c8 0 12 -5 12 -10c0 -27 -58 -154 -157 -154c-29 0 -47 16 -64 37c-25 29 -35 38 -58 38 c-32 0 -62 -27 -85 -62c-6 -11 -8 -13 -16 -13c0 0 -12 0 -12 10c0 7 35 64 103 131l90 84c19 16 103 88 139 131c-26 0 -37 0 -77 15c-23 8 -42 15 -63 15c-8 0 -66 -1 -85 -47c-2 -6 -4 -11 -13 -11s-12 6 -12 11c0 21 46 114 121 114c33 0 50 -20 69 -43 c15 -17 27 -32 51 -32s45 16 75 64c5 9 8 11 15 11c0 0 11 0 11 -10Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D467" x="0" y="0"></use>
</g>
</svg> is <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="3.285ex" height="2.343ex" style="vertical-align: -0.671ex;" viewBox="0 -719.6 1414.6 1008.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">t omega Subscript Baseline Subscript z</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D461" d="M330 420c0 -20 -10 -20 -30 -20h-94l-74 -295c-4 -17 -6 -24 -6 -48c0 -33 10 -46 31 -46c34 0 87 24 130 128c5 11 6 14 15 14c4 0 12 0 12 -10c0 -8 -57 -154 -159 -154c-54 0 -92 38 -92 92c0 18 4 35 76 319h-88c-20 0 -28 0 -28 12c0 19 10 19 30 19h94l39 159 c9 35 37 36 40 36c17 0 29 -10 29 -27c0 -6 -5 -26 -41 -168h88c18 0 28 0 28 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D467" d="M467 432c0 -4 -22 -52 -117 -145c-36 -36 -98 -90 -98 -90c-36 -31 -65 -56 -119 -114c9 3 27 3 27 3c21 0 36 -4 70 -17c21 -7 39 -13 59 -13c33 0 97 19 120 84c3 7 5 13 14 13c8 0 12 -5 12 -10c0 -27 -58 -154 -157 -154c-29 0 -47 16 -64 37c-25 29 -35 38 -58 38 c-32 0 -62 -27 -85 -62c-6 -11 -8 -13 -16 -13c0 0 -12 0 -12 10c0 7 35 64 103 131l90 84c19 16 103 88 139 131c-26 0 -37 0 -77 15c-23 8 -42 15 -63 15c-8 0 -66 -1 -85 -47c-2 -6 -4 -11 -13 -11s-12 6 -12 11c0 21 46 114 121 114c33 0 50 -20 69 -43 c15 -17 27 -32 51 -32s45 16 75 64c5 9 8 11 15 11c0 0 11 0 11 -10Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D461" x="0" y="0"></use>
<g transform="translate(361,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D467" x="880" y="-213"></use>
</g>
</g>
</svg>.

</p>
<p></p>
<span class="anchor" id="fig:transmittance-1d"></span><div class="card outerfigure"><div class="card-body figure"><p>



</p>
<div class="figure-row">
  <a href="pha14f13.svg" title=""><img src="pha14f13.svg" width=302 height=134 style="max-width: 100%;"></a>
</div>
<p>


</p>
<figcaption class="caption">Figure 14.13: Transmittance in 1D. <span class="legend">
The distance between two depths <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.209ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 520.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">d</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D451" d="M516 683l-144 -578c-4 -17 -6 -24 -6 -48c0 -20 3 -46 30 -46c41 0 59 59 76 124c3 14 4 18 14 18c3 0 12 0 12 -10c0 0 -13 -63 -30 -99c-16 -32 -39 -55 -74 -55c-48 0 -83 33 -91 75c-60 -71 -110 -75 -130 -75c-78 0 -133 66 -133 160c0 146 124 293 241 293 c45 0 74 -27 92 -64l60 237l3 20c0 10 -2 17 -50 17c-15 0 -24 0 -24 12c0 13 6 18 14 19c17 2 112 11 127 11c13 0 13 -11 13 -11zM361 332c0 6 -14 88 -79 88c-40 0 -85 -37 -116 -96c-23 -46 -55 -169 -55 -219c0 -39 14 -94 64 -94c28 0 69 16 113 71c15 17 15 19 20 37 l50 196c1 5 3 11 3 17Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D451" x="0" y="0"></use>
</g>
</svg> is given by the <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.086ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 467.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">z</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D467" d="M467 432c0 -4 -22 -52 -117 -145c-36 -36 -98 -90 -98 -90c-36 -31 -65 -56 -119 -114c9 3 27 3 27 3c21 0 36 -4 70 -17c21 -7 39 -13 59 -13c33 0 97 19 120 84c3 7 5 13 14 13c8 0 12 -5 12 -10c0 -27 -58 -154 -157 -154c-29 0 -47 16 -64 37c-25 29 -35 38 -58 38 c-32 0 -62 -27 -85 -62c-6 -11 -8 -13 -16 -13c0 0 -12 0 -12 10c0 7 35 64 103 131l90 84c19 16 103 88 139 131c-26 0 -37 0 -77 15c-23 8 -42 15 -63 15c-8 0 -66 -1 -85 -47c-2 -6 -4 -11 -13 -11s-12 6 -12 11c0 21 46 114 121 114c33 0 50 -20 69 -43 c15 -17 27 -32 51 -32s45 16 75 64c5 9 8 11 15 11c0 0 11 0 11 -10Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D467" x="0" y="0"></use>
</g>
</svg> distance between
them divided by the cosine of the ray&rsquo;s angle with respect to the <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.086ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 467.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">z</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D467" d="M467 432c0 -4 -22 -52 -117 -145c-36 -36 -98 -90 -98 -90c-36 -31 -65 -56 -119 -114c9 3 27 3 27 3c21 0 36 -4 70 -17c21 -7 39 -13 59 -13c33 0 97 19 120 84c3 7 5 13 14 13c8 0 12 -5 12 -10c0 -27 -58 -154 -157 -154c-29 0 -47 16 -64 37c-25 29 -35 38 -58 38 c-32 0 -62 -27 -85 -62c-6 -11 -8 -13 -16 -13c0 0 -12 0 -12 10c0 7 35 64 103 131l90 84c19 16 103 88 139 131c-26 0 -37 0 -77 15c-23 8 -42 15 -63 15c-8 0 -66 -1 -85 -47c-2 -6 -4 -11 -13 -11s-12 6 -12 11c0 21 46 114 121 114c33 0 50 -20 69 -43 c15 -17 27 -32 51 -32s45 16 75 64c5 9 8 11 15 11c0 0 11 0 11 -10Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D467" x="0" y="0"></use>
</g>
</svg> axis,
<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.09ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 469.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">theta</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D703" d="M455 500c0 -224 -152 -511 -293 -511c-91 0 -120 111 -120 205c0 229 154 511 293 511c102 0 120 -139 120 -205zM389 562c0 57 -6 121 -55 121c-45 0 -82 -56 -109 -105c-40 -71 -60 -151 -77 -215h209c24 99 32 150 32 199zM348 331h-208c-26 -98 -32 -156 -32 -198 c0 -93 21 -122 54 -122c43 0 81 49 116 117c38 72 59 157 70 203Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D703" x="0" y="0"></use>
</g>
</svg>.  The transmittance follows.</span>
</figcaption><p>


</p>
</div></div><p>


</p>
<p>In the case of a homogeneous medium,
</p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">
<span class="anchor" id="eq:beamtrans-1d-homogeneous"></span><div class="displaymath"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="27.951ex" height="4.843ex" style="vertical-align: -0.838ex;" viewBox="0 -1724.2 12034.2 2085" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">upper T Subscript normal r Baseline left-parenthesis z 0 right-arrow z 1 comma omega Subscript Baseline right-parenthesis equals normal e Superscript minus sigma Super Subscript normal t Superscript StartAbsoluteValue StartFraction z 0 minus z 1 Over omega Super Subscript Superscript Super Subscript z Superscript EndFraction EndAbsoluteValue Baseline period</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D447" d="M704 666c0 -3 -1 -13 -2 -17l-27 -174c-2 -15 -4 -23 -15 -23c-9 0 -12 7 -12 13c0 3 2 15 3 19c4 26 8 65 8 80c0 78 -45 82 -146 82c-21 0 -54 0 -63 -2c-12 -3 -16 -9 -23 -37l-133 -531c-4 -15 -4 -21 -4 -21c0 -16 8 -19 37 -22c26 -2 39 -2 64 -2c26 0 34 0 34 -11 c0 -20 -12 -20 -22 -20c-28 0 -58 2 -87 2l-83 1l-85 -1c-27 0 -55 -2 -82 -2c-6 0 -17 0 -17 12c0 19 6 19 42 19c107 0 110 11 119 48l134 534c1 3 4 15 4 21c0 8 0 12 -28 12h-39c-148 0 -174 -18 -228 -173c-6 -16 -7 -21 -17 -21c-7 0 -12 5 -12 11c0 0 5 16 6 18 l60 176c7 19 8 20 32 20h555c17 0 27 0 27 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-72" d="M364 381c0 -32 -25 -44 -43 -44c-22 0 -43 15 -43 43c0 26 20 38 23 39c-2 1 -4 1 -11 1c-76 0 -118 -89 -118 -188v-154c0 -36 2 -47 76 -47h21v-31c-40 3 -87 3 -127 3l-114 -3v31c67 0 78 0 78 45v268c0 49 -8 56 -78 56v31l139 11v-110c14 43 50 110 123 110 c43 0 74 -29 74 -61Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D467" d="M467 432c0 -4 -22 -52 -117 -145c-36 -36 -98 -90 -98 -90c-36 -31 -65 -56 -119 -114c9 3 27 3 27 3c21 0 36 -4 70 -17c21 -7 39 -13 59 -13c33 0 97 19 120 84c3 7 5 13 14 13c8 0 12 -5 12 -10c0 -27 -58 -154 -157 -154c-29 0 -47 16 -64 37c-25 29 -35 38 -58 38 c-32 0 -62 -27 -85 -62c-6 -11 -8 -13 -16 -13c0 0 -12 0 -12 10c0 7 35 64 103 131l90 84c19 16 103 88 139 131c-26 0 -37 0 -77 15c-23 8 -42 15 -63 15c-8 0 -66 -1 -85 -47c-2 -6 -4 -11 -13 -11s-12 6 -12 11c0 21 46 114 121 114c33 0 50 -20 69 -43 c15 -17 27 -32 51 -32s45 16 75 64c5 9 8 11 15 11c0 0 11 0 11 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-30" d="M460 320c0 -79 -5 -157 -37 -226c-44 -95 -120 -116 -174 -116c-49 0 -122 20 -165 101c-41 76 -45 166 -45 241c0 80 5 158 37 227c41 93 114 119 174 119c42 0 124 -16 170 -112c35 -74 40 -154 40 -234zM377 332c0 63 0 139 -10 195c-19 99 -85 117 -118 117 c-25 0 -100 -9 -119 -128c-8 -54 -8 -120 -8 -184c0 -59 0 -151 11 -211c18 -96 77 -121 116 -121c45 0 102 30 117 125c11 64 11 132 11 207Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2192" d="M943 250c0 -6 -4 -11 -9 -13c-57 -19 -101 -59 -137 -104c-28 -36 -49 -80 -58 -127c-2 -9 -10 -16 -20 -16c-11 0 -20 9 -20 20c0 1 1 3 1 4c10 53 33 102 66 144c22 28 48 52 78 72h-766c-11 0 -20 9 -20 20s9 20 20 20h766c-30 20 -56 44 -78 72 c-33 42 -56 91 -66 144c0 1 -1 3 -1 4c0 11 9 20 20 20c10 0 18 -7 20 -16c9 -47 30 -91 58 -127c36 -45 80 -85 137 -104c5 -2 9 -7 9 -13Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3D" d="M722 347c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20zM722 153c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-65" d="M415 119c0 -19 -45 -130 -167 -130c-115 0 -220 97 -220 231c0 125 92 228 208 228c125 0 179 -97 179 -196c0 -21 -3 -21 -25 -21h-279c0 -36 0 -102 30 -150c23 -37 63 -67 113 -67c10 0 100 0 135 103c2 8 4 14 13 14c5 0 13 -2 13 -12zM349 252 c0 39 -10 174 -113 174c-34 0 -118 -25 -124 -174h237Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2212" d="M722 250c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D70E" d="M567 407c0 -34 -36 -34 -49 -34h-110c31 -44 31 -92 31 -109c0 -154 -133 -275 -251 -275c-91 0 -150 70 -150 158c0 119 111 284 262 284h228c18 0 39 0 39 -24zM375 276c0 31 -8 97 -92 97c-34 0 -94 -14 -136 -83c-35 -59 -47 -141 -47 -171c0 -72 40 -108 89 -108 c39 0 93 26 132 85c34 51 54 133 54 180Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-74" d="M332 124c0 -64 -28 -135 -99 -135c-36 0 -129 12 -129 135v276h-85v22c98 4 128 111 129 193h25v-184h143v-31h-143v-278c0 -17 0 -108 67 -108c37 0 67 38 67 112v55h25v-57Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-7C" d="M159 -230c0 -11 -9 -20 -20 -20s-20 9 -20 20v960c0 11 9 20 20 20s20 -9 20 -20v-960Z"></path>
<path stroke-width="1" id="E1-LATINMODERNSIZE4-7C" d="M169 -762c0 -17 -13 -30 -30 -30s-30 13 -30 30v2024c0 17 13 30 30 30s30 -13 30 -30v-2024Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2E" d="M192 53c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D447" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-72" x="826" y="-213"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="962" y="0"></use>
<g transform="translate(1351,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D467" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-30" x="658" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2192" x="2548" y="0"></use>
<g transform="translate(3827,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D467" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="658" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="4746" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="5191" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="5814" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="6481" y="0"></use>
<g transform="translate(7537,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-65" x="0" y="0"></use>
<g transform="translate(444,668)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="0" y="0"></use>
<g transform="translate(550,0)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D70E" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNMAIN-74" x="703" y="-192"></use>
</g>
<g transform="translate(1248,0)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNSIZE4-7C"></use>
<g transform="translate(196,0)">
<g transform="translate(120,0)">
<rect stroke="none" width="1790" height="60" x="0" y="146"></rect>
<g transform="translate(60,569)">
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNNORMAL-1D467" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNMAIN-30" x="465" y="-323"></use>
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNMAIN-2212" x="1066" y="0"></use>
<g transform="translate(1058,0)">
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNNORMAL-1D467" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNMAIN-31" x="465" y="-323"></use>
</g>
</g>
<g transform="translate(553,-273)">
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNNORMAL-1D467" x="622" y="-150"></use>
</g>
</g>
</g>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNSIZE4-7C" x="3150" y="0"></use>
</g>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2E" x="11755" y="0"></use>
</g>
</svg>
</div>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">
<div class="eqno">(<a href="#eq:beamtrans-1d-homogeneous">14.30</a>)</div>
</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">
<p>


</p>
<p>The 1D equation of transfer can be found in a similar fashion.  It says
that at points inside the medium the incident radiance
at a depth <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.086ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 467.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">z</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D467" d="M467 432c0 -4 -22 -52 -117 -145c-36 -36 -98 -90 -98 -90c-36 -31 -65 -56 -119 -114c9 3 27 3 27 3c21 0 36 -4 70 -17c21 -7 39 -13 59 -13c33 0 97 19 120 84c3 7 5 13 14 13c8 0 12 -5 12 -10c0 -27 -58 -154 -157 -154c-29 0 -47 16 -64 37c-25 29 -35 38 -58 38 c-32 0 -62 -27 -85 -62c-6 -11 -8 -13 -16 -13c0 0 -12 0 -12 10c0 7 35 64 103 131l90 84c19 16 103 88 139 131c-26 0 -37 0 -77 15c-23 8 -42 15 -63 15c-8 0 -66 -1 -85 -47c-2 -6 -4 -11 -13 -11s-12 6 -12 11c0 21 46 114 121 114c33 0 50 -20 69 -43 c15 -17 27 -32 51 -32s45 16 75 64c5 9 8 11 15 11c0 0 11 0 11 -10Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D467" x="0" y="0"></use>
</g>
</svg> in direction <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.446ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 622.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">omega Subscript</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
</g>
</svg> is given&nbsp;by
</p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">
<span class="anchor" id="eq:eot-1d"></span><div class="displaymath"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="75.011ex" height="6.509ex" style="vertical-align: -2.671ex;" viewBox="0 -1652.5 32296.4 2802.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">upper L Subscript normal i Baseline left-parenthesis z comma omega Subscript Baseline right-parenthesis equals upper T Subscript normal r Baseline left-parenthesis z right-arrow z Subscript normal i Baseline comma omega Subscript Baseline right-parenthesis upper L Subscript normal o Baseline left-parenthesis z Subscript normal i Baseline comma minus omega Subscript Baseline right-parenthesis plus integral Subscript z Superscript z Subscript normal i Baseline Baseline StartFraction upper T Subscript normal r Baseline left-parenthesis z right-arrow z Superscript prime Baseline comma omega Subscript Baseline right-parenthesis upper L Subscript normal s Superscript Baseline left-parenthesis z prime comma minus omega Subscript Baseline right-parenthesis Over StartAbsoluteValue omega Subscript Baseline Subscript z Baseline EndAbsoluteValue EndFraction normal d z Superscript prime Baseline comma</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D43F" d="M643 247c0 0 0 -3 -4 -14l-79 -216c-6 -17 -7 -17 -31 -17h-463c-18 0 -27 0 -27 11c0 20 10 20 27 20c79 0 81 8 91 47l134 537c3 12 4 15 4 19c0 13 -9 14 -27 16c-17 2 -38 2 -38 2c-19 0 -28 0 -28 11c0 20 12 20 19 20l133 -3l148 3c5 0 16 0 16 -12 c0 -19 -8 -19 -38 -19c-94 0 -97 -11 -106 -47l-135 -540c-5 -18 -5 -20 -5 -23c0 -8 3 -9 13 -10c6 -1 8 -1 22 -1h94c173 0 217 114 251 206c7 16 8 21 17 21s12 -7 12 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-69" d="M247 0c-34 1 -69 3 -104 3l-110 -3v31c67 0 78 0 78 45v269c0 49 -9 55 -74 55v31l140 11v-367c0 -39 4 -44 70 -44v-31zM192 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D467" d="M467 432c0 -4 -22 -52 -117 -145c-36 -36 -98 -90 -98 -90c-36 -31 -65 -56 -119 -114c9 3 27 3 27 3c21 0 36 -4 70 -17c21 -7 39 -13 59 -13c33 0 97 19 120 84c3 7 5 13 14 13c8 0 12 -5 12 -10c0 -27 -58 -154 -157 -154c-29 0 -47 16 -64 37c-25 29 -35 38 -58 38 c-32 0 -62 -27 -85 -62c-6 -11 -8 -13 -16 -13c0 0 -12 0 -12 10c0 7 35 64 103 131l90 84c19 16 103 88 139 131c-26 0 -37 0 -77 15c-23 8 -42 15 -63 15c-8 0 -66 -1 -85 -47c-2 -6 -4 -11 -13 -11s-12 6 -12 11c0 21 46 114 121 114c33 0 50 -20 69 -43 c15 -17 27 -32 51 -32s45 16 75 64c5 9 8 11 15 11c0 0 11 0 11 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3D" d="M722 347c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20zM722 153c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D447" d="M704 666c0 -3 -1 -13 -2 -17l-27 -174c-2 -15 -4 -23 -15 -23c-9 0 -12 7 -12 13c0 3 2 15 3 19c4 26 8 65 8 80c0 78 -45 82 -146 82c-21 0 -54 0 -63 -2c-12 -3 -16 -9 -23 -37l-133 -531c-4 -15 -4 -21 -4 -21c0 -16 8 -19 37 -22c26 -2 39 -2 64 -2c26 0 34 0 34 -11 c0 -20 -12 -20 -22 -20c-28 0 -58 2 -87 2l-83 1l-85 -1c-27 0 -55 -2 -82 -2c-6 0 -17 0 -17 12c0 19 6 19 42 19c107 0 110 11 119 48l134 534c1 3 4 15 4 21c0 8 0 12 -28 12h-39c-148 0 -174 -18 -228 -173c-6 -16 -7 -21 -17 -21c-7 0 -12 5 -12 11c0 0 5 16 6 18 l60 176c7 19 8 20 32 20h555c17 0 27 0 27 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-72" d="M364 381c0 -32 -25 -44 -43 -44c-22 0 -43 15 -43 43c0 26 20 38 23 39c-2 1 -4 1 -11 1c-76 0 -118 -89 -118 -188v-154c0 -36 2 -47 76 -47h21v-31c-40 3 -87 3 -127 3l-114 -3v31c67 0 78 0 78 45v268c0 49 -8 56 -78 56v31l139 11v-110c14 43 50 110 123 110 c43 0 74 -29 74 -61Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2192" d="M943 250c0 -6 -4 -11 -9 -13c-57 -19 -101 -59 -137 -104c-28 -36 -49 -80 -58 -127c-2 -9 -10 -16 -20 -16c-11 0 -20 9 -20 20c0 1 1 3 1 4c10 53 33 102 66 144c22 28 48 52 78 72h-766c-11 0 -20 9 -20 20s9 20 20 20h766c-30 20 -56 44 -78 72 c-33 42 -56 91 -66 144c0 1 -1 3 -1 4c0 11 9 20 20 20c10 0 18 -7 20 -16c9 -47 30 -91 58 -127c36 -45 80 -85 137 -104c5 -2 9 -7 9 -13Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6F" d="M471 214c0 -127 -101 -225 -222 -225c-117 0 -221 96 -221 225c0 125 97 234 222 234c121 0 221 -106 221 -234zM388 222c0 38 0 96 -26 139s-69 65 -113 65c-40 0 -87 -21 -114 -67c-24 -44 -24 -98 -24 -137c0 -36 0 -97 25 -141c27 -46 71 -67 114 -67 c50 0 94 29 116 74c22 44 22 98 22 134Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2212" d="M722 250c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2B" d="M722 250c0 -11 -9 -20 -20 -20h-293v-293c0 -11 -9 -20 -20 -20s-20 9 -20 20v293h-293c-11 0 -20 9 -20 20s9 20 20 20h293v293c0 11 9 20 20 20s20 -9 20 -20v-293h293c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNSIZE1-222B" d="M943 1268c0 -35 -25 -50 -49 -50c-23 0 -48 16 -48 49c0 25 17 47 50 49c-4 4 -29 23 -60 23c-39 0 -73 -129 -85 -178c-34 -129 -71 -329 -108 -542c-54 -321 -119 -640 -196 -956c-71 -290 -128 -524 -280 -524c-61 0 -111 42 -111 93c0 35 25 50 49 50 c23 0 48 -16 48 -49c0 -25 -17 -47 -49 -49c0 0 25 -23 61 -23c81 0 127 188 145 261c33 139 62 306 88 459c110 654 246 1156 249 1167c55 204 111 313 187 313c55 0 109 -39 109 -93Z"></path>
<path stroke-width="1" id="E1-LATINMODERNVARIANTS-2032" d="M340 496c0 -10 -3 -20 -8 -28l-227 -372h-38l171 424c6 15 26 29 48 29c30 0 54 -24 54 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-73" d="M360 128c0 -72 -46 -139 -161 -139c-21 0 -66 1 -110 43c-18 -19 -18 -21 -20 -23c-19 -19 -20 -20 -25 -20c-11 0 -11 7 -11 24v132c0 18 0 25 13 25c10 0 11 -4 14 -17c19 -85 55 -142 139 -142c78 0 113 40 113 91c0 72 -82 88 -104 92c-72 14 -100 20 -132 46 c-27 22 -43 50 -43 85c0 56 38 123 160 123c15 0 56 0 94 -28c4 3 14 12 17 16c13 12 15 12 20 12c11 0 11 -7 11 -24v-101c0 -19 0 -24 -13 -24c0 0 -11 0 -12 9c-2 31 -7 121 -117 121c-86 0 -112 -41 -112 -76c0 -58 67 -71 123 -82c42 -8 81 -16 114 -48 c12 -12 42 -42 42 -95Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-7C" d="M159 -230c0 -11 -9 -20 -20 -20s-20 9 -20 20v960c0 11 9 20 20 20s20 -9 20 -20v-960Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-64" d="M527 0l-147 -11v66c-25 -32 -70 -66 -134 -66c-114 0 -212 99 -212 226c0 129 105 227 223 227c54 0 97 -26 126 -62v216c0 49 -8 56 -78 56v31l144 11v-607c0 -49 8 -56 78 -56v-31zM380 118v205c0 18 0 20 -11 37c-31 45 -73 60 -108 60c-54 0 -92 -33 -113 -64 c-29 -45 -31 -105 -31 -142c0 -41 3 -98 29 -139c24 -38 60 -64 105 -64c43 0 88 22 118 70c11 17 11 19 11 37Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D43F" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="963" y="-213"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="978" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D467" x="1367" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="1835" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="2280" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="2903" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="3570" y="0"></use>
<g transform="translate(4626,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D447" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-72" x="826" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="5588" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D467" x="5978" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2192" x="6723" y="0"></use>
<g transform="translate(8001,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D467" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="658" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="8764" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="9209" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="9831" y="0"></use>
<g transform="translate(10221,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D43F" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6F" x="963" y="-213"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="1135" y="0"></use>
<g transform="translate(1524,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D467" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="658" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="2287" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2212" x="2732" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="3511" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="4133" y="0"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2B" x="14966" y="0"></use>
<g transform="translate(15967,0)">
 <use xlink:href="#E1-LATINMODERNSIZE1-222B" x="0" y="0"></use>
<g transform="translate(1054,1088)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D467" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNMAIN-69" x="573" y="-234"></use>
</g>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D467" x="812" y="-1270"></use>
</g>
<g transform="translate(17681,0)">
<g transform="translate(286,0)">
<rect stroke="none" width="10350" height="60" x="0" y="220"></rect>
<g transform="translate(60,768)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D447" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-72" x="826" y="-213"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="962" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D467" x="1351" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2192" x="2096" y="0"></use>
<g transform="translate(3375,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D467" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNVARIANTS-2032" x="662" y="513"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="4231" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="4676" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="5299" y="0"></use>
<g transform="translate(5688,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D43F" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-73" x="963" y="-213"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="1060" y="0"></use>
<g transform="translate(1449,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D467" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNVARIANTS-2032" x="662" y="513"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="2306" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2212" x="2751" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="3529" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="4152" y="0"></use>
</g>
</g>
<g transform="translate(4370,-771)">
 <use xlink:href="#E1-LATINMODERNMAIN-7C" x="0" y="0"></use>
<g transform="translate(278,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D467" x="880" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-7C" x="1331" y="0"></use>
</g>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-64" x="28605" y="0"></use>
<g transform="translate(29161,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D467" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNVARIANTS-2032" x="662" y="583"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="30017" y="0"></use>
</g>
</svg>
</div>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">
<div class="eqno">(<a href="#eq:eot-1d">14.31</a>)</div>
</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">
<p>

where <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.771ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 762.4 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">z Subscript normal i</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D467" d="M467 432c0 -4 -22 -52 -117 -145c-36 -36 -98 -90 -98 -90c-36 -31 -65 -56 -119 -114c9 3 27 3 27 3c21 0 36 -4 70 -17c21 -7 39 -13 59 -13c33 0 97 19 120 84c3 7 5 13 14 13c8 0 12 -5 12 -10c0 -27 -58 -154 -157 -154c-29 0 -47 16 -64 37c-25 29 -35 38 -58 38 c-32 0 -62 -27 -85 -62c-6 -11 -8 -13 -16 -13c0 0 -12 0 -12 10c0 7 35 64 103 131l90 84c19 16 103 88 139 131c-26 0 -37 0 -77 15c-23 8 -42 15 -63 15c-8 0 -66 -1 -85 -47c-2 -6 -4 -11 -13 -11s-12 6 -12 11c0 21 46 114 121 114c33 0 50 -20 69 -43 c15 -17 27 -32 51 -32s45 16 75 64c5 9 8 11 15 11c0 0 11 0 11 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-69" d="M247 0c-34 1 -69 3 -104 3l-110 -3v31c67 0 78 0 78 45v269c0 49 -9 55 -74 55v31l140 11v-367c0 -39 4 -44 70 -44v-31zM192 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D467" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="658" y="-213"></use>
</g>
</svg> is the depth of the medium interface that the ray from
<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.086ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 467.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">z</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D467" d="M467 432c0 -4 -22 -52 -117 -145c-36 -36 -98 -90 -98 -90c-36 -31 -65 -56 -119 -114c9 3 27 3 27 3c21 0 36 -4 70 -17c21 -7 39 -13 59 -13c33 0 97 19 120 84c3 7 5 13 14 13c8 0 12 -5 12 -10c0 -27 -58 -154 -157 -154c-29 0 -47 16 -64 37c-25 29 -35 38 -58 38 c-32 0 -62 -27 -85 -62c-6 -11 -8 -13 -16 -13c0 0 -12 0 -12 10c0 7 35 64 103 131l90 84c19 16 103 88 139 131c-26 0 -37 0 -77 15c-23 8 -42 15 -63 15c-8 0 -66 -1 -85 -47c-2 -6 -4 -11 -13 -11s-12 6 -12 11c0 21 46 114 121 114c33 0 50 -20 69 -43 c15 -17 27 -32 51 -32s45 16 75 64c5 9 8 11 15 11c0 0 11 0 11 -10Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D467" x="0" y="0"></use>
</g>
</svg> in direction <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.446ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 622.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">omega Subscript</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
</g>
</svg> intersects. (See
Figure&nbsp;<a href="#fig:1d-eot-specialization">14.14</a>.)
At boundaries, the incident radiance function is given by
Equation&nbsp;(<a href="#eq:eot-1d">14.31</a>) for directions <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.446ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 622.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">omega Subscript</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
</g>
</svg> that point into the
medium.  For directions that point outside it, incident radiance is found
by integrating illumination from the scene.

</p>
<p></p>
<span class="anchor" id="fig:1d-eot-specialization"></span><div class="card outerfigure"><div class="card-body figure"><p>



</p>
<div class="figure-row">
<img src="pha14f14.png" style="max-width: 100%; height: auto;" width=1162 height=520>
</div>
<p>


</p>
<figcaption class="caption">Figure 14.14: <span class="legend"> The 1D specialization of the equation of transfer from
Equation&nbsp;(<a href="#eq:eot-1d">14.31</a>) expresses the incident radiance <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.272ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 978.4 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">upper L Subscript normal i</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D43F" d="M643 247c0 0 0 -3 -4 -14l-79 -216c-6 -17 -7 -17 -31 -17h-463c-18 0 -27 0 -27 11c0 20 10 20 27 20c79 0 81 8 91 47l134 537c3 12 4 15 4 19c0 13 -9 14 -27 16c-17 2 -38 2 -38 2c-19 0 -28 0 -28 11c0 20 12 20 19 20l133 -3l148 3c5 0 16 0 16 -12 c0 -19 -8 -19 -38 -19c-94 0 -97 -11 -106 -47l-135 -540c-5 -18 -5 -20 -5 -23c0 -8 3 -9 13 -10c6 -1 8 -1 22 -1h94c173 0 217 114 251 206c7 16 8 21 17 21s12 -7 12 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-69" d="M247 0c-34 1 -69 3 -104 3l-110 -3v31c67 0 78 0 78 45v269c0 49 -9 55 -74 55v31l140 11v-367c0 -39 4 -44 70 -44v-31zM192 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D43F" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="963" y="-213"></use>
</g>
</svg> at
a depth <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.086ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 467.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">z</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D467" d="M467 432c0 -4 -22 -52 -117 -145c-36 -36 -98 -90 -98 -90c-36 -31 -65 -56 -119 -114c9 3 27 3 27 3c21 0 36 -4 70 -17c21 -7 39 -13 59 -13c33 0 97 19 120 84c3 7 5 13 14 13c8 0 12 -5 12 -10c0 -27 -58 -154 -157 -154c-29 0 -47 16 -64 37c-25 29 -35 38 -58 38 c-32 0 -62 -27 -85 -62c-6 -11 -8 -13 -16 -13c0 0 -12 0 -12 10c0 7 35 64 103 131l90 84c19 16 103 88 139 131c-26 0 -37 0 -77 15c-23 8 -42 15 -63 15c-8 0 -66 -1 -85 -47c-2 -6 -4 -11 -13 -11s-12 6 -12 11c0 21 46 114 121 114c33 0 50 -20 69 -43 c15 -17 27 -32 51 -32s45 16 75 64c5 9 8 11 15 11c0 0 11 0 11 -10Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D467" x="0" y="0"></use>
</g>
</svg> as the sum of attenuated radiance <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.637ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 1135.4 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">upper L Subscript normal o</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D43F" d="M643 247c0 0 0 -3 -4 -14l-79 -216c-6 -17 -7 -17 -31 -17h-463c-18 0 -27 0 -27 11c0 20 10 20 27 20c79 0 81 8 91 47l134 537c3 12 4 15 4 19c0 13 -9 14 -27 16c-17 2 -38 2 -38 2c-19 0 -28 0 -28 11c0 20 12 20 19 20l133 -3l148 3c5 0 16 0 16 -12 c0 -19 -8 -19 -38 -19c-94 0 -97 -11 -106 -47l-135 -540c-5 -18 -5 -20 -5 -23c0 -8 3 -9 13 -10c6 -1 8 -1 22 -1h94c173 0 217 114 251 206c7 16 8 21 17 21s12 -7 12 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6F" d="M471 214c0 -127 -101 -225 -222 -225c-117 0 -221 96 -221 225c0 125 97 234 222 234c121 0 221 -106 221 -234zM388 222c0 38 0 96 -26 139s-69 65 -113 65c-40 0 -87 -21 -114 -67c-24 -44 -24 -98 -24 -137c0 -36 0 -97 25 -141c27 -46 71 -67 114 -67 c50 0 94 29 116 74c22 44 22 98 22 134Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D43F" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6F" x="963" y="-213"></use>
</g>
</svg> from the
interface that is visible along the ray and the transmission-modulated
source function <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.463ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 1060.5 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">upper L Subscript normal s</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D43F" d="M643 247c0 0 0 -3 -4 -14l-79 -216c-6 -17 -7 -17 -31 -17h-463c-18 0 -27 0 -27 11c0 20 10 20 27 20c79 0 81 8 91 47l134 537c3 12 4 15 4 19c0 13 -9 14 -27 16c-17 2 -38 2 -38 2c-19 0 -28 0 -28 11c0 20 12 20 19 20l133 -3l148 3c5 0 16 0 16 -12 c0 -19 -8 -19 -38 -19c-94 0 -97 -11 -106 -47l-135 -540c-5 -18 -5 -20 -5 -23c0 -8 3 -9 13 -10c6 -1 8 -1 22 -1h94c173 0 217 114 251 206c7 16 8 21 17 21s12 -7 12 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-73" d="M360 128c0 -72 -46 -139 -161 -139c-21 0 -66 1 -110 43c-18 -19 -18 -21 -20 -23c-19 -19 -20 -20 -25 -20c-11 0 -11 7 -11 24v132c0 18 0 25 13 25c10 0 11 -4 14 -17c19 -85 55 -142 139 -142c78 0 113 40 113 91c0 72 -82 88 -104 92c-72 14 -100 20 -132 46 c-27 22 -43 50 -43 85c0 56 38 123 160 123c15 0 56 0 94 -28c4 3 14 12 17 16c13 12 15 12 20 12c11 0 11 -7 11 -24v-101c0 -19 0 -24 -13 -24c0 0 -11 0 -12 9c-2 31 -7 121 -117 121c-86 0 -112 -41 -112 -76c0 -58 67 -71 123 -82c42 -8 81 -16 114 -48 c12 -12 42 -42 42 -95Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D43F" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-73" x="963" y="-213"></use>
</g>
</svg> integrated over <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.086ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 467.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">z</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D467" d="M467 432c0 -4 -22 -52 -117 -145c-36 -36 -98 -90 -98 -90c-36 -31 -65 -56 -119 -114c9 3 27 3 27 3c21 0 36 -4 70 -17c21 -7 39 -13 59 -13c33 0 97 19 120 84c3 7 5 13 14 13c8 0 12 -5 12 -10c0 -27 -58 -154 -157 -154c-29 0 -47 16 -64 37c-25 29 -35 38 -58 38 c-32 0 -62 -27 -85 -62c-6 -11 -8 -13 -16 -13c0 0 -12 0 -12 10c0 7 35 64 103 131l90 84c19 16 103 88 139 131c-26 0 -37 0 -77 15c-23 8 -42 15 -63 15c-8 0 -66 -1 -85 -47c-2 -6 -4 -11 -13 -11s-12 6 -12 11c0 21 46 114 121 114c33 0 50 -20 69 -43 c15 -17 27 -32 51 -32s45 16 75 64c5 9 8 11 15 11c0 0 11 0 11 -10Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D467" x="0" y="0"></use>
</g>
</svg>.</span>
</figcaption><p>


</p>
</div></div><p>


</p>
<p>The scattering from an interface at a boundary of the medium is given by
the incident radiance modulated by the boundary&rsquo;s BSDF,
</p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">
<span class="anchor" id="eq:boundary-scattering-1d"></span><div class="displaymath"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="46.474ex" height="5.676ex" style="vertical-align: -2.338ex;" viewBox="0 -1437.2 20009.7 2443.8" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">upper L Subscript normal o Baseline left-parenthesis z comma omega Subscript normal o Baseline right-parenthesis equals integral Underscript script upper S squared Endscripts f Subscript z Baseline left-parenthesis omega Subscript normal o Baseline comma omega prime Subscript Baseline right-parenthesis upper L Subscript normal i Baseline left-parenthesis z comma omega prime Subscript Baseline right-parenthesis StartAbsoluteValue cosine theta Superscript prime Baseline EndAbsoluteValue normal d omega Subscript Baseline Superscript prime Baseline period</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D43F" d="M643 247c0 0 0 -3 -4 -14l-79 -216c-6 -17 -7 -17 -31 -17h-463c-18 0 -27 0 -27 11c0 20 10 20 27 20c79 0 81 8 91 47l134 537c3 12 4 15 4 19c0 13 -9 14 -27 16c-17 2 -38 2 -38 2c-19 0 -28 0 -28 11c0 20 12 20 19 20l133 -3l148 3c5 0 16 0 16 -12 c0 -19 -8 -19 -38 -19c-94 0 -97 -11 -106 -47l-135 -540c-5 -18 -5 -20 -5 -23c0 -8 3 -9 13 -10c6 -1 8 -1 22 -1h94c173 0 217 114 251 206c7 16 8 21 17 21s12 -7 12 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6F" d="M471 214c0 -127 -101 -225 -222 -225c-117 0 -221 96 -221 225c0 125 97 234 222 234c121 0 221 -106 221 -234zM388 222c0 38 0 96 -26 139s-69 65 -113 65c-40 0 -87 -21 -114 -67c-24 -44 -24 -98 -24 -137c0 -36 0 -97 25 -141c27 -46 71 -67 114 -67 c50 0 94 29 116 74c22 44 22 98 22 134Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D467" d="M467 432c0 -4 -22 -52 -117 -145c-36 -36 -98 -90 -98 -90c-36 -31 -65 -56 -119 -114c9 3 27 3 27 3c21 0 36 -4 70 -17c21 -7 39 -13 59 -13c33 0 97 19 120 84c3 7 5 13 14 13c8 0 12 -5 12 -10c0 -27 -58 -154 -157 -154c-29 0 -47 16 -64 37c-25 29 -35 38 -58 38 c-32 0 -62 -27 -85 -62c-6 -11 -8 -13 -16 -13c0 0 -12 0 -12 10c0 7 35 64 103 131l90 84c19 16 103 88 139 131c-26 0 -37 0 -77 15c-23 8 -42 15 -63 15c-8 0 -66 -1 -85 -47c-2 -6 -4 -11 -13 -11s-12 6 -12 11c0 21 46 114 121 114c33 0 50 -20 69 -43 c15 -17 27 -32 51 -32s45 16 75 64c5 9 8 11 15 11c0 0 11 0 11 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3D" d="M722 347c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20zM722 153c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNSIZE1-222B" d="M943 1268c0 -35 -25 -50 -49 -50c-23 0 -48 16 -48 49c0 25 17 47 50 49c-4 4 -29 23 -60 23c-39 0 -73 -129 -85 -178c-34 -129 -71 -329 -108 -542c-54 -321 -119 -640 -196 -956c-71 -290 -128 -524 -280 -524c-61 0 -111 42 -111 93c0 35 25 50 49 50 c23 0 48 -16 48 -49c0 -25 -17 -47 -49 -49c0 0 25 -23 61 -23c81 0 127 188 145 261c33 139 62 306 88 459c110 654 246 1156 249 1167c55 204 111 313 187 313c55 0 109 -39 109 -93Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-53" d="M499 186c0 -110 -80 -208 -197 -208c-89 0 -153 36 -184 70c-33 -53 -36 -57 -36 -57c-7 -11 -8 -13 -15 -13c-11 0 -11 7 -11 24v200c0 18 0 25 13 25c3 0 11 0 12 -10c1 -36 4 -100 62 -154c53 -49 129 -54 158 -54c84 0 134 72 134 143c0 33 -10 66 -31 92 c-28 37 -58 44 -85 51c-70 17 -121 29 -132 33c-78 27 -131 100 -131 183c0 106 84 194 195 194c89 0 130 -41 160 -70l35 57c7 12 8 13 15 13c11 0 11 -7 11 -24v-201c0 -19 0 -24 -13 -24c-11 0 -11 6 -12 12c-6 45 -28 209 -195 209c-78 0 -132 -61 -132 -131 c0 -58 39 -112 101 -127l128 -31c84 -20 150 -102 150 -202Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-32" d="M449 174l-28 -174h-371c0 24 0 26 11 37l192 214c55 62 105 141 105 221c0 82 -43 163 -134 163c-58 0 -112 -37 -135 -102c3 1 5 1 13 1c35 0 53 -26 53 -52c0 -41 -35 -53 -52 -53c-3 0 -53 0 -53 56c0 89 74 181 187 181c122 0 212 -80 212 -194 c0 -100 -60 -154 -216 -292l-106 -103h180c22 0 88 0 95 8c10 15 17 59 22 89h25Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D453" d="M552 636c0 -38 -29 -60 -55 -60c-19 0 -37 12 -37 35c0 15 10 50 54 54c-19 18 -45 18 -49 18c-21 0 -38 -15 -47 -34c-6 -12 -20 -83 -24 -104c-11 -58 -10 -56 -21 -114h83c17 0 27 0 27 -11c0 -20 -10 -20 -30 -20h-86l-60 -317c-1 -7 -24 -128 -56 -191 c-18 -38 -58 -97 -113 -97c-41 0 -85 24 -85 69c0 38 29 60 55 60c19 0 37 -12 37 -35c0 -15 -9 -51 -55 -54c19 -18 44 -18 48 -18c52 0 69 91 87 188l75 395h-66c-19 0 -28 0 -28 12c0 19 11 19 30 19h69c24 126 27 136 33 157c30 99 93 117 127 117c41 0 87 -23 87 -69Z"></path>
<path stroke-width="1" id="E1-LATINMODERNVARIANTS-2032" d="M340 496c0 -10 -3 -20 -8 -28l-227 -372h-38l171 424c6 15 26 29 48 29c30 0 54 -24 54 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-69" d="M247 0c-34 1 -69 3 -104 3l-110 -3v31c67 0 78 0 78 45v269c0 49 -9 55 -74 55v31l140 11v-367c0 -39 4 -44 70 -44v-31zM192 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-7C" d="M159 -230c0 -11 -9 -20 -20 -20s-20 9 -20 20v960c0 11 9 20 20 20s20 -9 20 -20v-960Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-63" d="M415 119c0 -10 -32 -130 -166 -130c-116 0 -215 99 -215 227c0 124 92 232 217 232c77 0 153 -39 153 -107c0 -30 -20 -47 -46 -47c-28 0 -46 20 -46 46c0 13 6 43 47 46c-35 36 -98 37 -107 37c-53 0 -135 -42 -135 -205c0 -161 88 -204 141 -204c37 0 102 12 131 105 c2 6 4 10 13 10c3 0 13 0 13 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-73" d="M360 128c0 -72 -46 -139 -161 -139c-21 0 -66 1 -110 43c-18 -19 -18 -21 -20 -23c-19 -19 -20 -20 -25 -20c-11 0 -11 7 -11 24v132c0 18 0 25 13 25c10 0 11 -4 14 -17c19 -85 55 -142 139 -142c78 0 113 40 113 91c0 72 -82 88 -104 92c-72 14 -100 20 -132 46 c-27 22 -43 50 -43 85c0 56 38 123 160 123c15 0 56 0 94 -28c4 3 14 12 17 16c13 12 15 12 20 12c11 0 11 -7 11 -24v-101c0 -19 0 -24 -13 -24c0 0 -11 0 -12 9c-2 31 -7 121 -117 121c-86 0 -112 -41 -112 -76c0 -58 67 -71 123 -82c42 -8 81 -16 114 -48 c12 -12 42 -42 42 -95Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D703" d="M455 500c0 -224 -152 -511 -293 -511c-91 0 -120 111 -120 205c0 229 154 511 293 511c102 0 120 -139 120 -205zM389 562c0 57 -6 121 -55 121c-45 0 -82 -56 -109 -105c-40 -71 -60 -151 -77 -215h209c24 99 32 150 32 199zM348 331h-208c-26 -98 -32 -156 -32 -198 c0 -93 21 -122 54 -122c43 0 81 49 116 117c38 72 59 157 70 203Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-64" d="M527 0l-147 -11v66c-25 -32 -70 -66 -134 -66c-114 0 -212 99 -212 226c0 129 105 227 223 227c54 0 97 -26 126 -62v216c0 49 -8 56 -78 56v31l144 11v-607c0 -49 8 -56 78 -56v-31zM380 118v205c0 18 0 20 -11 37c-31 45 -73 60 -108 60c-54 0 -92 -33 -113 -64 c-29 -45 -31 -105 -31 -142c0 -41 3 -98 29 -139c24 -38 60 -64 105 -64c43 0 88 22 118 70c11 17 11 19 11 37Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2E" d="M192 53c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D43F" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6F" x="963" y="-213"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="1135" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D467" x="1524" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="1992" y="0"></use>
<g transform="translate(2437,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6F" x="880" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="3513" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="4181" y="0"></use>
<g transform="translate(5237,0)">
 <use xlink:href="#E1-LATINMODERNSIZE1-222B" x="0" y="0"></use>
<g transform="translate(574,-898)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-53" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNMAIN-32" x="685" y="483"></use>
</g>
</g>
<g transform="translate(6830,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D453" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D467" x="693" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="7751" y="0"></use>
<g transform="translate(8140,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6F" x="880" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="9217" y="0"></use>
<g transform="translate(9662,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNVARIANTS-2032" x="880" y="583"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="10673" y="0"></use>
<g transform="translate(11229,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D43F" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="963" y="-213"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="978" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D467" x="1367" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="1835" y="0"></use>
<g transform="translate(2280,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNVARIANTS-2032" x="880" y="583"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="3291" y="0"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-7C" x="15076" y="0"></use>
<g transform="translate(15355,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-63"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-6F" x="444" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-73" x="945" y="0"></use>
</g>
<g transform="translate(16861,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D703" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNVARIANTS-2032" x="663" y="583"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-7C" x="17718" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-64" x="18164" y="0"></use>
<g transform="translate(18720,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNVARIANTS-2032" x="880" y="583"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2E" x="19731" y="0"></use>
</g>
</svg>
</div>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">
<div class="eqno">(<a href="#eq:boundary-scattering-1d">14.32</a>)</div>
</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">
<p>

If we also assume there is no volumetric emission (as we will do in the
<a href="#LayeredBxDF"><tt>LayeredBxDF</tt></a>), the source function in Equation&nbsp;(<a href="#eq:eot-1d">14.31</a>) simplifies to
</p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">
<span class="anchor" id="eq:source-term-1d"></span><div class="displaymath"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="39.482ex" height="5.676ex" style="vertical-align: -2.338ex;" viewBox="0 -1437.2 16999 2443.8" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">upper L Subscript normal s Superscript Baseline left-parenthesis z comma omega Subscript Baseline right-parenthesis equals StartFraction sigma Subscript normal s Baseline Over sigma Subscript normal t Baseline EndFraction integral Underscript script upper S squared Endscripts p left-parenthesis omega prime Subscript Baseline comma omega Subscript Baseline right-parenthesis upper L Subscript normal i Baseline left-parenthesis z comma omega prime Subscript Baseline right-parenthesis normal d omega Subscript Baseline Superscript prime Baseline period</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D43F" d="M643 247c0 0 0 -3 -4 -14l-79 -216c-6 -17 -7 -17 -31 -17h-463c-18 0 -27 0 -27 11c0 20 10 20 27 20c79 0 81 8 91 47l134 537c3 12 4 15 4 19c0 13 -9 14 -27 16c-17 2 -38 2 -38 2c-19 0 -28 0 -28 11c0 20 12 20 19 20l133 -3l148 3c5 0 16 0 16 -12 c0 -19 -8 -19 -38 -19c-94 0 -97 -11 -106 -47l-135 -540c-5 -18 -5 -20 -5 -23c0 -8 3 -9 13 -10c6 -1 8 -1 22 -1h94c173 0 217 114 251 206c7 16 8 21 17 21s12 -7 12 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-73" d="M360 128c0 -72 -46 -139 -161 -139c-21 0 -66 1 -110 43c-18 -19 -18 -21 -20 -23c-19 -19 -20 -20 -25 -20c-11 0 -11 7 -11 24v132c0 18 0 25 13 25c10 0 11 -4 14 -17c19 -85 55 -142 139 -142c78 0 113 40 113 91c0 72 -82 88 -104 92c-72 14 -100 20 -132 46 c-27 22 -43 50 -43 85c0 56 38 123 160 123c15 0 56 0 94 -28c4 3 14 12 17 16c13 12 15 12 20 12c11 0 11 -7 11 -24v-101c0 -19 0 -24 -13 -24c0 0 -11 0 -12 9c-2 31 -7 121 -117 121c-86 0 -112 -41 -112 -76c0 -58 67 -71 123 -82c42 -8 81 -16 114 -48 c12 -12 42 -42 42 -95Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D467" d="M467 432c0 -4 -22 -52 -117 -145c-36 -36 -98 -90 -98 -90c-36 -31 -65 -56 -119 -114c9 3 27 3 27 3c21 0 36 -4 70 -17c21 -7 39 -13 59 -13c33 0 97 19 120 84c3 7 5 13 14 13c8 0 12 -5 12 -10c0 -27 -58 -154 -157 -154c-29 0 -47 16 -64 37c-25 29 -35 38 -58 38 c-32 0 -62 -27 -85 -62c-6 -11 -8 -13 -16 -13c0 0 -12 0 -12 10c0 7 35 64 103 131l90 84c19 16 103 88 139 131c-26 0 -37 0 -77 15c-23 8 -42 15 -63 15c-8 0 -66 -1 -85 -47c-2 -6 -4 -11 -13 -11s-12 6 -12 11c0 21 46 114 121 114c33 0 50 -20 69 -43 c15 -17 27 -32 51 -32s45 16 75 64c5 9 8 11 15 11c0 0 11 0 11 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3D" d="M722 347c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20zM722 153c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D70E" d="M567 407c0 -34 -36 -34 -49 -34h-110c31 -44 31 -92 31 -109c0 -154 -133 -275 -251 -275c-91 0 -150 70 -150 158c0 119 111 284 262 284h228c18 0 39 0 39 -24zM375 276c0 31 -8 97 -92 97c-34 0 -94 -14 -136 -83c-35 -59 -47 -141 -47 -171c0 -72 40 -108 89 -108 c39 0 93 26 132 85c34 51 54 133 54 180Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-74" d="M332 124c0 -64 -28 -135 -99 -135c-36 0 -129 12 -129 135v276h-85v22c98 4 128 111 129 193h25v-184h143v-31h-143v-278c0 -17 0 -108 67 -108c37 0 67 38 67 112v55h25v-57Z"></path>
<path stroke-width="1" id="E1-LATINMODERNSIZE1-222B" d="M943 1268c0 -35 -25 -50 -49 -50c-23 0 -48 16 -48 49c0 25 17 47 50 49c-4 4 -29 23 -60 23c-39 0 -73 -129 -85 -178c-34 -129 -71 -329 -108 -542c-54 -321 -119 -640 -196 -956c-71 -290 -128 -524 -280 -524c-61 0 -111 42 -111 93c0 35 25 50 49 50 c23 0 48 -16 48 -49c0 -25 -17 -47 -49 -49c0 0 25 -23 61 -23c81 0 127 188 145 261c33 139 62 306 88 459c110 654 246 1156 249 1167c55 204 111 313 187 313c55 0 109 -39 109 -93Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-53" d="M499 186c0 -110 -80 -208 -197 -208c-89 0 -153 36 -184 70c-33 -53 -36 -57 -36 -57c-7 -11 -8 -13 -15 -13c-11 0 -11 7 -11 24v200c0 18 0 25 13 25c3 0 11 0 12 -10c1 -36 4 -100 62 -154c53 -49 129 -54 158 -54c84 0 134 72 134 143c0 33 -10 66 -31 92 c-28 37 -58 44 -85 51c-70 17 -121 29 -132 33c-78 27 -131 100 -131 183c0 106 84 194 195 194c89 0 130 -41 160 -70l35 57c7 12 8 13 15 13c11 0 11 -7 11 -24v-201c0 -19 0 -24 -13 -24c-11 0 -11 6 -12 12c-6 45 -28 209 -195 209c-78 0 -132 -61 -132 -131 c0 -58 39 -112 101 -127l128 -31c84 -20 150 -102 150 -202Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-32" d="M449 174l-28 -174h-371c0 24 0 26 11 37l192 214c55 62 105 141 105 221c0 82 -43 163 -134 163c-58 0 -112 -37 -135 -102c3 1 5 1 13 1c35 0 53 -26 53 -52c0 -41 -35 -53 -52 -53c-3 0 -53 0 -53 56c0 89 74 181 187 181c122 0 212 -80 212 -194 c0 -100 -60 -154 -216 -292l-106 -103h180c22 0 88 0 95 8c10 15 17 59 22 89h25Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45D" d="M490 282c0 -147 -125 -293 -241 -293c-51 0 -79 35 -92 64c-7 -25 -49 -188 -49 -200c0 -9 0 -16 50 -16c14 0 24 0 24 -11c0 -20 -13 -20 -18 -20c-32 0 -66 3 -99 3c-28 0 -57 -3 -84 -3c-8 0 -13 4 -13 12c0 19 11 19 23 19c44 0 46 7 54 41l112 445c4 17 7 28 7 51 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c37 0 80 -21 90 -75c33 39 81 75 131 75c76 0 133 -66 133 -160zM418 326c0 59 -24 94 -64 94c-17 0 -46 -7 -81 -38c-18 -15 -45 -43 -52 -70 l-49 -196c-3 -12 -3 -16 -3 -16c0 -6 13 -89 79 -89c37 0 85 33 119 103c18 38 51 153 51 212Z"></path>
<path stroke-width="1" id="E1-LATINMODERNVARIANTS-2032" d="M340 496c0 -10 -3 -20 -8 -28l-227 -372h-38l171 424c6 15 26 29 48 29c30 0 54 -24 54 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-69" d="M247 0c-34 1 -69 3 -104 3l-110 -3v31c67 0 78 0 78 45v269c0 49 -9 55 -74 55v31l140 11v-367c0 -39 4 -44 70 -44v-31zM192 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-64" d="M527 0l-147 -11v66c-25 -32 -70 -66 -134 -66c-114 0 -212 99 -212 226c0 129 105 227 223 227c54 0 97 -26 126 -62v216c0 49 -8 56 -78 56v31l144 11v-607c0 -49 8 -56 78 -56v-31zM380 118v205c0 18 0 20 -11 37c-31 45 -73 60 -108 60c-54 0 -92 -33 -113 -64 c-29 -45 -31 -105 -31 -142c0 -41 3 -98 29 -139c24 -38 60 -64 105 -64c43 0 88 22 118 70c11 17 11 19 11 37Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2E" d="M192 53c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D43F" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-73" x="963" y="-213"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="1060" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D467" x="1449" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="1917" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="2362" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="2985" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="3652" y="0"></use>
<g transform="translate(4430,0)">
<g transform="translate(397,0)">
<rect stroke="none" width="1070" height="60" x="0" y="220"></rect>
<g transform="translate(60,677)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D70E" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-73" x="808" y="-213"></use>
</g>
<g transform="translate(61,-686)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D70E" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-74" x="808" y="-213"></use>
</g>
</g>
</g>
<g transform="translate(6185,0)">
 <use xlink:href="#E1-LATINMODERNSIZE1-222B" x="0" y="0"></use>
<g transform="translate(574,-898)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-53" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNMAIN-32" x="685" y="483"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="7778" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="8282" y="0"></use>
<g transform="translate(8671,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNVARIANTS-2032" x="880" y="583"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="9682" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="10127" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="10749" y="0"></use>
<g transform="translate(11305,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D43F" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="963" y="-213"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="978" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D467" x="1367" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="1835" y="0"></use>
<g transform="translate(2280,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNVARIANTS-2032" x="880" y="583"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="3291" y="0"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-64" x="15153" y="0"></use>
<g transform="translate(15709,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNVARIANTS-2032" x="880" y="583"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2E" x="16720" y="0"></use>
</g>
</svg>
</div>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">
<div class="eqno">(<a href="#eq:source-term-1d">14.33</a>)</div>
</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">
<p>


</p>
<p>The <a href="#LayeredBxDF"><tt>LayeredBxDF</tt></a> further assumes that <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.199ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 946.9 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">sigma Subscript normal t</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D70E" d="M567 407c0 -34 -36 -34 -49 -34h-110c31 -44 31 -92 31 -109c0 -154 -133 -275 -251 -275c-91 0 -150 70 -150 158c0 119 111 284 262 284h228c18 0 39 0 39 -24zM375 276c0 31 -8 97 -92 97c-34 0 -94 -14 -136 -83c-35 -59 -47 -141 -47 -171c0 -72 40 -108 89 -108 c39 0 93 26 132 85c34 51 54 133 54 180Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-74" d="M332 124c0 -64 -28 -135 -99 -135c-36 0 -129 12 -129 135v276h-85v22c98 4 128 111 129 193h25v-184h143v-31h-143v-278c0 -17 0 -108 67 -108c37 0 67 38 67 112v55h25v-57Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D70E" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-74" x="808" y="-213"></use>
</g>
</svg> is constant over all
wavelengths in the medium, which means that null scattering is not
necessary for sampling distances in the medium.  Null scattering is easily
included in the 1D simplification of the equation of transfer if necessary,
though we will not do so here.  For similar reasons, we will also not
derive its path integral form in 1D, though it too can be found with
suitable simplifications to the approach that was used in
Section&nbsp;<a href="../Light_Transport_II_Volume_Rendering/The_Equation_of_Transfer.html#sec:pathspace-generalized">14.1.4</a>.  The &ldquo;Further Reading&rdquo; section
has pointers to more details.

</p>
<p>

</p>
<p></p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">
<a href="#LayeredBxDF"><i class="fas fa-link h3h4marginlink"></i></a>
</div>
<div class="col-md-10 col-lg-8">
<span class="anchor" id="sec:layered-bxdf-implementation"></span><span id="LayeredBxDF"></span><h3>14.3.2  Layered BxDF</h3><p>



</p>
<p>The equation of transfer describes the equilibrium distribution of radiance,
though our interest here is in evaluating and sampling the BSDF that represents
all the scattering from the layered medium.  Fortunately, these two
things can be connected.  If we would like to evaluate the BSDF for a pair
of directions <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.5ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 1076.4 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">omega Subscript normal o</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6F" d="M471 214c0 -127 -101 -225 -222 -225c-117 0 -221 96 -221 225c0 125 97 234 222 234c121 0 221 -106 221 -234zM388 222c0 38 0 96 -26 139s-69 65 -113 65c-40 0 -87 -21 -114 -67c-24 -44 -24 -98 -24 -137c0 -36 0 -97 25 -141c27 -46 71 -67 114 -67 c50 0 94 29 116 74c22 44 22 98 22 134Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6F" x="880" y="-213"></use>
</g>
</svg> and <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.135ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 919.4 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">omega Subscript normal i</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-69" d="M247 0c-34 1 -69 3 -104 3l-110 -3v31c67 0 78 0 78 45v269c0 49 -9 55 -74 55v31l140 11v-367c0 -39 4 -44 70 -44v-31zM192 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="880" y="-213"></use>
</g>
</svg>, then we can define an incident radiance
function from a virtual light source from <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.135ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 919.4 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">omega Subscript normal i</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-69" d="M247 0c-34 1 -69 3 -104 3l-110 -3v31c67 0 78 0 78 45v269c0 49 -9 55 -74 55v31l140 11v-367c0 -39 4 -44 70 -44v-31zM192 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="880" y="-213"></use>
</g>
</svg> as
</p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">
<span class="anchor" id="eq:virtual-directional-light"></span><div class="displaymath"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="19.391ex" height="6.509ex" style="vertical-align: -2.671ex;" viewBox="0 -1652.5 8348.9 2802.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">upper L Subscript normal i Baseline left-parenthesis omega Subscript Baseline right-parenthesis equals StartFraction delta left-parenthesis omega Subscript Baseline minus omega Subscript normal i Baseline right-parenthesis Over StartAbsoluteValue cosine theta Subscript normal i Baseline EndAbsoluteValue EndFraction period</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D43F" d="M643 247c0 0 0 -3 -4 -14l-79 -216c-6 -17 -7 -17 -31 -17h-463c-18 0 -27 0 -27 11c0 20 10 20 27 20c79 0 81 8 91 47l134 537c3 12 4 15 4 19c0 13 -9 14 -27 16c-17 2 -38 2 -38 2c-19 0 -28 0 -28 11c0 20 12 20 19 20l133 -3l148 3c5 0 16 0 16 -12 c0 -19 -8 -19 -38 -19c-94 0 -97 -11 -106 -47l-135 -540c-5 -18 -5 -20 -5 -23c0 -8 3 -9 13 -10c6 -1 8 -1 22 -1h94c173 0 217 114 251 206c7 16 8 21 17 21s12 -7 12 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-69" d="M247 0c-34 1 -69 3 -104 3l-110 -3v31c67 0 78 0 78 45v269c0 49 -9 55 -74 55v31l140 11v-367c0 -39 4 -44 70 -44v-31zM192 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3D" d="M722 347c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20zM722 153c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D6FF" d="M452 667c0 -6 -2 -12 -5 -18c-7 -13 -22 -22 -36 -22c-3 0 -7 1 -11 2c-38 16 -66 48 -111 50c-11 0 -21 -1 -32 -6c-9 -5 -17 -14 -22 -23c-3 -5 -4 -11 -4 -17c0 -45 63 -124 107 -181c28 -35 49 -75 58 -122c2 -15 3 -30 3 -46c0 -33 -5 -68 -14 -102 c-24 -98 -96 -193 -184 -193c-56 0 -103 26 -130 68c-19 29 -28 63 -28 100c0 20 2 40 8 61c14 58 48 115 98 158c35 30 75 51 116 60c-30 56 -61 120 -61 173c0 19 3 36 12 51c7 14 18 26 31 34c14 9 29 13 43 16c8 1 17 2 26 2c36 0 78 -10 115 -19c13 -3 21 -13 21 -26z M330 244c0 17 -1 34 -5 50c-8 42 -26 80 -46 116l-3 5c-31 -9 -62 -29 -86 -55c-40 -42 -60 -95 -73 -147c-7 -28 -13 -57 -13 -84c0 -22 4 -43 12 -61c15 -34 45 -57 86 -57c63 0 99 79 118 152c7 27 10 55 10 81Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2212" d="M722 250c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-7C" d="M159 -230c0 -11 -9 -20 -20 -20s-20 9 -20 20v960c0 11 9 20 20 20s20 -9 20 -20v-960Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-63" d="M415 119c0 -10 -32 -130 -166 -130c-116 0 -215 99 -215 227c0 124 92 232 217 232c77 0 153 -39 153 -107c0 -30 -20 -47 -46 -47c-28 0 -46 20 -46 46c0 13 6 43 47 46c-35 36 -98 37 -107 37c-53 0 -135 -42 -135 -205c0 -161 88 -204 141 -204c37 0 102 12 131 105 c2 6 4 10 13 10c3 0 13 0 13 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6F" d="M471 214c0 -127 -101 -225 -222 -225c-117 0 -221 96 -221 225c0 125 97 234 222 234c121 0 221 -106 221 -234zM388 222c0 38 0 96 -26 139s-69 65 -113 65c-40 0 -87 -21 -114 -67c-24 -44 -24 -98 -24 -137c0 -36 0 -97 25 -141c27 -46 71 -67 114 -67 c50 0 94 29 116 74c22 44 22 98 22 134Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-73" d="M360 128c0 -72 -46 -139 -161 -139c-21 0 -66 1 -110 43c-18 -19 -18 -21 -20 -23c-19 -19 -20 -20 -25 -20c-11 0 -11 7 -11 24v132c0 18 0 25 13 25c10 0 11 -4 14 -17c19 -85 55 -142 139 -142c78 0 113 40 113 91c0 72 -82 88 -104 92c-72 14 -100 20 -132 46 c-27 22 -43 50 -43 85c0 56 38 123 160 123c15 0 56 0 94 -28c4 3 14 12 17 16c13 12 15 12 20 12c11 0 11 -7 11 -24v-101c0 -19 0 -24 -13 -24c0 0 -11 0 -12 9c-2 31 -7 121 -117 121c-86 0 -112 -41 -112 -76c0 -58 67 -71 123 -82c42 -8 81 -16 114 -48 c12 -12 42 -42 42 -95Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D703" d="M455 500c0 -224 -152 -511 -293 -511c-91 0 -120 111 -120 205c0 229 154 511 293 511c102 0 120 -139 120 -205zM389 562c0 57 -6 121 -55 121c-45 0 -82 -56 -109 -105c-40 -71 -60 -151 -77 -215h209c24 99 32 150 32 199zM348 331h-208c-26 -98 -32 -156 -32 -198 c0 -93 21 -122 54 -122c43 0 81 49 116 117c38 72 59 157 70 203Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2E" d="M192 53c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D43F" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="963" y="-213"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="978" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="1367" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="1990" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="2657" y="0"></use>
<g transform="translate(3436,0)">
<g transform="translate(397,0)">
<rect stroke="none" width="4116" height="60" x="0" y="220"></rect>
<g transform="translate(60,768)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D6FF" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="452" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="842" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2212" x="1686" y="0"></use>
<g transform="translate(2687,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="880" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="3606" y="0"></use>
</g>
<g transform="translate(643,-771)">
 <use xlink:href="#E1-LATINMODERNMAIN-7C" x="0" y="0"></use>
<g transform="translate(278,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-63"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-6F" x="444" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-73" x="945" y="0"></use>
</g>
<g transform="translate(1784,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D703" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="663" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-7C" x="2551" y="0"></use>
</g>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2E" x="8070" y="0"></use>
</g>
</svg>
</div>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">
<div class="eqno">(<a href="#eq:virtual-directional-light">14.34</a>)</div>
</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">
<p>

If a 1D medium is illuminated by such a light, then the outgoing
radiance <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="6.946ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 2990.8 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">upper L Subscript normal o Baseline left-parenthesis omega Subscript normal o Baseline right-parenthesis</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D43F" d="M643 247c0 0 0 -3 -4 -14l-79 -216c-6 -17 -7 -17 -31 -17h-463c-18 0 -27 0 -27 11c0 20 10 20 27 20c79 0 81 8 91 47l134 537c3 12 4 15 4 19c0 13 -9 14 -27 16c-17 2 -38 2 -38 2c-19 0 -28 0 -28 11c0 20 12 20 19 20l133 -3l148 3c5 0 16 0 16 -12 c0 -19 -8 -19 -38 -19c-94 0 -97 -11 -106 -47l-135 -540c-5 -18 -5 -20 -5 -23c0 -8 3 -9 13 -10c6 -1 8 -1 22 -1h94c173 0 217 114 251 206c7 16 8 21 17 21s12 -7 12 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6F" d="M471 214c0 -127 -101 -225 -222 -225c-117 0 -221 96 -221 225c0 125 97 234 222 234c121 0 221 -106 221 -234zM388 222c0 38 0 96 -26 139s-69 65 -113 65c-40 0 -87 -21 -114 -67c-24 -44 -24 -98 -24 -137c0 -36 0 -97 25 -141c27 -46 71 -67 114 -67 c50 0 94 29 116 74c22 44 22 98 22 134Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D43F" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6F" x="963" y="-213"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="1135" y="0"></use>
<g transform="translate(1524,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6F" x="880" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="2601" y="0"></use>
</g>
</svg> at the medium&rsquo;s interface is equivalent to
the value of the BSDF, <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="8.762ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 3772.5 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">f left-parenthesis omega Subscript normal o Baseline comma omega Subscript normal i Baseline right-parenthesis</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D453" d="M552 636c0 -38 -29 -60 -55 -60c-19 0 -37 12 -37 35c0 15 10 50 54 54c-19 18 -45 18 -49 18c-21 0 -38 -15 -47 -34c-6 -12 -20 -83 -24 -104c-11 -58 -10 -56 -21 -114h83c17 0 27 0 27 -11c0 -20 -10 -20 -30 -20h-86l-60 -317c-1 -7 -24 -128 -56 -191 c-18 -38 -58 -97 -113 -97c-41 0 -85 24 -85 69c0 38 29 60 55 60c19 0 37 -12 37 -35c0 -15 -9 -51 -55 -54c19 -18 44 -18 48 -18c52 0 69 91 87 188l75 395h-66c-19 0 -28 0 -28 12c0 19 11 19 30 19h69c24 126 27 136 33 157c30 99 93 117 127 117c41 0 87 -23 87 -69Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6F" d="M471 214c0 -127 -101 -225 -222 -225c-117 0 -221 96 -221 225c0 125 97 234 222 234c121 0 221 -106 221 -234zM388 222c0 38 0 96 -26 139s-69 65 -113 65c-40 0 -87 -21 -114 -67c-24 -44 -24 -98 -24 -137c0 -36 0 -97 25 -141c27 -46 71 -67 114 -67 c50 0 94 29 116 74c22 44 22 98 22 134Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-69" d="M247 0c-34 1 -69 3 -104 3l-110 -3v31c67 0 78 0 78 45v269c0 49 -9 55 -74 55v31l140 11v-367c0 -39 4 -44 70 -44v-31zM192 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D453" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="552" y="0"></use>
<g transform="translate(942,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6F" x="880" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="2018" y="0"></use>
<g transform="translate(2463,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="880" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="3383" y="0"></use>
</g>
</svg> (see Figure&nbsp;<a href="#fig:layers-virtual-directional-light">14.15</a>).
One way to understand why this is so is to consider using such a light with
the surface reflection equation:
</p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">
<div class="displaymath"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="77.298ex" height="5.676ex" style="vertical-align: -2.338ex;" viewBox="0 -1437.2 33280.8 2443.8" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">upper L Subscript normal o Baseline left-parenthesis omega Subscript normal o Baseline right-parenthesis equals integral Underscript script upper S squared Endscripts f left-parenthesis omega Subscript normal o Baseline comma omega Subscript Baseline right-parenthesis upper L Subscript normal i Baseline left-parenthesis omega Subscript Baseline right-parenthesis StartAbsoluteValue cosine theta EndAbsoluteValue normal d omega Subscript Baseline equals integral Underscript script upper S squared Endscripts f left-parenthesis omega Subscript normal o Baseline comma omega Subscript Baseline right-parenthesis delta left-parenthesis omega Subscript Baseline minus omega Subscript normal i Baseline right-parenthesis normal d omega Subscript Baseline equals f left-parenthesis omega Subscript normal o Baseline comma omega Subscript normal i Baseline right-parenthesis period</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D43F" d="M643 247c0 0 0 -3 -4 -14l-79 -216c-6 -17 -7 -17 -31 -17h-463c-18 0 -27 0 -27 11c0 20 10 20 27 20c79 0 81 8 91 47l134 537c3 12 4 15 4 19c0 13 -9 14 -27 16c-17 2 -38 2 -38 2c-19 0 -28 0 -28 11c0 20 12 20 19 20l133 -3l148 3c5 0 16 0 16 -12 c0 -19 -8 -19 -38 -19c-94 0 -97 -11 -106 -47l-135 -540c-5 -18 -5 -20 -5 -23c0 -8 3 -9 13 -10c6 -1 8 -1 22 -1h94c173 0 217 114 251 206c7 16 8 21 17 21s12 -7 12 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6F" d="M471 214c0 -127 -101 -225 -222 -225c-117 0 -221 96 -221 225c0 125 97 234 222 234c121 0 221 -106 221 -234zM388 222c0 38 0 96 -26 139s-69 65 -113 65c-40 0 -87 -21 -114 -67c-24 -44 -24 -98 -24 -137c0 -36 0 -97 25 -141c27 -46 71 -67 114 -67 c50 0 94 29 116 74c22 44 22 98 22 134Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3D" d="M722 347c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20zM722 153c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNSIZE1-222B" d="M943 1268c0 -35 -25 -50 -49 -50c-23 0 -48 16 -48 49c0 25 17 47 50 49c-4 4 -29 23 -60 23c-39 0 -73 -129 -85 -178c-34 -129 -71 -329 -108 -542c-54 -321 -119 -640 -196 -956c-71 -290 -128 -524 -280 -524c-61 0 -111 42 -111 93c0 35 25 50 49 50 c23 0 48 -16 48 -49c0 -25 -17 -47 -49 -49c0 0 25 -23 61 -23c81 0 127 188 145 261c33 139 62 306 88 459c110 654 246 1156 249 1167c55 204 111 313 187 313c55 0 109 -39 109 -93Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-53" d="M499 186c0 -110 -80 -208 -197 -208c-89 0 -153 36 -184 70c-33 -53 -36 -57 -36 -57c-7 -11 -8 -13 -15 -13c-11 0 -11 7 -11 24v200c0 18 0 25 13 25c3 0 11 0 12 -10c1 -36 4 -100 62 -154c53 -49 129 -54 158 -54c84 0 134 72 134 143c0 33 -10 66 -31 92 c-28 37 -58 44 -85 51c-70 17 -121 29 -132 33c-78 27 -131 100 -131 183c0 106 84 194 195 194c89 0 130 -41 160 -70l35 57c7 12 8 13 15 13c11 0 11 -7 11 -24v-201c0 -19 0 -24 -13 -24c-11 0 -11 6 -12 12c-6 45 -28 209 -195 209c-78 0 -132 -61 -132 -131 c0 -58 39 -112 101 -127l128 -31c84 -20 150 -102 150 -202Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-32" d="M449 174l-28 -174h-371c0 24 0 26 11 37l192 214c55 62 105 141 105 221c0 82 -43 163 -134 163c-58 0 -112 -37 -135 -102c3 1 5 1 13 1c35 0 53 -26 53 -52c0 -41 -35 -53 -52 -53c-3 0 -53 0 -53 56c0 89 74 181 187 181c122 0 212 -80 212 -194 c0 -100 -60 -154 -216 -292l-106 -103h180c22 0 88 0 95 8c10 15 17 59 22 89h25Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D453" d="M552 636c0 -38 -29 -60 -55 -60c-19 0 -37 12 -37 35c0 15 10 50 54 54c-19 18 -45 18 -49 18c-21 0 -38 -15 -47 -34c-6 -12 -20 -83 -24 -104c-11 -58 -10 -56 -21 -114h83c17 0 27 0 27 -11c0 -20 -10 -20 -30 -20h-86l-60 -317c-1 -7 -24 -128 -56 -191 c-18 -38 -58 -97 -113 -97c-41 0 -85 24 -85 69c0 38 29 60 55 60c19 0 37 -12 37 -35c0 -15 -9 -51 -55 -54c19 -18 44 -18 48 -18c52 0 69 91 87 188l75 395h-66c-19 0 -28 0 -28 12c0 19 11 19 30 19h69c24 126 27 136 33 157c30 99 93 117 127 117c41 0 87 -23 87 -69Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-69" d="M247 0c-34 1 -69 3 -104 3l-110 -3v31c67 0 78 0 78 45v269c0 49 -9 55 -74 55v31l140 11v-367c0 -39 4 -44 70 -44v-31zM192 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-7C" d="M159 -230c0 -11 -9 -20 -20 -20s-20 9 -20 20v960c0 11 9 20 20 20s20 -9 20 -20v-960Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-63" d="M415 119c0 -10 -32 -130 -166 -130c-116 0 -215 99 -215 227c0 124 92 232 217 232c77 0 153 -39 153 -107c0 -30 -20 -47 -46 -47c-28 0 -46 20 -46 46c0 13 6 43 47 46c-35 36 -98 37 -107 37c-53 0 -135 -42 -135 -205c0 -161 88 -204 141 -204c37 0 102 12 131 105 c2 6 4 10 13 10c3 0 13 0 13 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-73" d="M360 128c0 -72 -46 -139 -161 -139c-21 0 -66 1 -110 43c-18 -19 -18 -21 -20 -23c-19 -19 -20 -20 -25 -20c-11 0 -11 7 -11 24v132c0 18 0 25 13 25c10 0 11 -4 14 -17c19 -85 55 -142 139 -142c78 0 113 40 113 91c0 72 -82 88 -104 92c-72 14 -100 20 -132 46 c-27 22 -43 50 -43 85c0 56 38 123 160 123c15 0 56 0 94 -28c4 3 14 12 17 16c13 12 15 12 20 12c11 0 11 -7 11 -24v-101c0 -19 0 -24 -13 -24c0 0 -11 0 -12 9c-2 31 -7 121 -117 121c-86 0 -112 -41 -112 -76c0 -58 67 -71 123 -82c42 -8 81 -16 114 -48 c12 -12 42 -42 42 -95Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D703" d="M455 500c0 -224 -152 -511 -293 -511c-91 0 -120 111 -120 205c0 229 154 511 293 511c102 0 120 -139 120 -205zM389 562c0 57 -6 121 -55 121c-45 0 -82 -56 -109 -105c-40 -71 -60 -151 -77 -215h209c24 99 32 150 32 199zM348 331h-208c-26 -98 -32 -156 -32 -198 c0 -93 21 -122 54 -122c43 0 81 49 116 117c38 72 59 157 70 203Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-64" d="M527 0l-147 -11v66c-25 -32 -70 -66 -134 -66c-114 0 -212 99 -212 226c0 129 105 227 223 227c54 0 97 -26 126 -62v216c0 49 -8 56 -78 56v31l144 11v-607c0 -49 8 -56 78 -56v-31zM380 118v205c0 18 0 20 -11 37c-31 45 -73 60 -108 60c-54 0 -92 -33 -113 -64 c-29 -45 -31 -105 -31 -142c0 -41 3 -98 29 -139c24 -38 60 -64 105 -64c43 0 88 22 118 70c11 17 11 19 11 37Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D6FF" d="M452 667c0 -6 -2 -12 -5 -18c-7 -13 -22 -22 -36 -22c-3 0 -7 1 -11 2c-38 16 -66 48 -111 50c-11 0 -21 -1 -32 -6c-9 -5 -17 -14 -22 -23c-3 -5 -4 -11 -4 -17c0 -45 63 -124 107 -181c28 -35 49 -75 58 -122c2 -15 3 -30 3 -46c0 -33 -5 -68 -14 -102 c-24 -98 -96 -193 -184 -193c-56 0 -103 26 -130 68c-19 29 -28 63 -28 100c0 20 2 40 8 61c14 58 48 115 98 158c35 30 75 51 116 60c-30 56 -61 120 -61 173c0 19 3 36 12 51c7 14 18 26 31 34c14 9 29 13 43 16c8 1 17 2 26 2c36 0 78 -10 115 -19c13 -3 21 -13 21 -26z M330 244c0 17 -1 34 -5 50c-8 42 -26 80 -46 116l-3 5c-31 -9 -62 -29 -86 -55c-40 -42 -60 -95 -73 -147c-7 -28 -13 -57 -13 -84c0 -22 4 -43 12 -61c15 -34 45 -57 86 -57c63 0 99 79 118 152c7 27 10 55 10 81Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2212" d="M722 250c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2E" d="M192 53c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D43F" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6F" x="963" y="-213"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="1135" y="0"></use>
<g transform="translate(1524,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6F" x="880" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="2601" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="3268" y="0"></use>
<g transform="translate(4324,0)">
 <use xlink:href="#E1-LATINMODERNSIZE1-222B" x="0" y="0"></use>
<g transform="translate(574,-898)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-53" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNMAIN-32" x="685" y="483"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D453" x="5917" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="6470" y="0"></use>
<g transform="translate(6859,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6F" x="880" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="7935" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="8381" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="9003" y="0"></use>
<g transform="translate(9559,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D43F" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="963" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="10538" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="10927" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="11550" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-7C" x="12106" y="0"></use>
<g transform="translate(12384,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-63"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-6F" x="444" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-73" x="945" y="0"></use>
</g>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D703" x="13891" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-7C" x="14360" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-64" x="14805" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="15362" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="16262" y="0"></use>
<g transform="translate(17318,0)">
 <use xlink:href="#E1-LATINMODERNSIZE1-222B" x="0" y="0"></use>
<g transform="translate(574,-898)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-53" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNMAIN-32" x="685" y="483"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D453" x="18911" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="19464" y="0"></use>
<g transform="translate(19853,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6F" x="880" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="20929" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="21375" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="21997" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D6FF" x="22553" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="23006" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="23395" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2212" x="24240" y="0"></use>
<g transform="translate(25241,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="880" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="26160" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-64" x="26716" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="27273" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="28173" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D453" x="29229" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="29782" y="0"></use>
<g transform="translate(30171,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6F" x="880" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="31248" y="0"></use>
<g transform="translate(31693,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="880" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="32612" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2E" x="33002" y="0"></use>
</g>
</svg>
</div>
<p>


</p>
<p></p>
<span class="anchor" id="fig:layers-virtual-directional-light"></span><div class="card outerfigure"><div class="card-body figure"><p>



</p>
<div class="figure-row">
<img src="pha14f15.png" style="max-width: 100%; height: auto;" width=1104 height=468>
</div>
<p>


</p>
<figcaption class="caption">Figure 14.15: <span class="legend"> If a medium is illuminated with a virtual light source of the
form of Equation&nbsp;(<a href="#eq:virtual-directional-light">14.34</a>), then the radiance
leaving the surface in the direction <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.5ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 1076.4 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">omega Subscript normal o</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6F" d="M471 214c0 -127 -101 -225 -222 -225c-117 0 -221 96 -221 225c0 125 97 234 222 234c121 0 221 -106 221 -234zM388 222c0 38 0 96 -26 139s-69 65 -113 65c-40 0 -87 -21 -114 -67c-24 -44 -24 -98 -24 -137c0 -36 0 -97 25 -141c27 -46 71 -67 114 -67 c50 0 94 29 116 74c22 44 22 98 22 134Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6F" x="880" y="-213"></use>
</g>
</svg> is equivalent to the layered
surface&rsquo;s BSDF, <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="8.762ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 3772.5 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">f left-parenthesis omega Subscript normal o Baseline comma omega Subscript normal i Baseline right-parenthesis</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D453" d="M552 636c0 -38 -29 -60 -55 -60c-19 0 -37 12 -37 35c0 15 10 50 54 54c-19 18 -45 18 -49 18c-21 0 -38 -15 -47 -34c-6 -12 -20 -83 -24 -104c-11 -58 -10 -56 -21 -114h83c17 0 27 0 27 -11c0 -20 -10 -20 -30 -20h-86l-60 -317c-1 -7 -24 -128 -56 -191 c-18 -38 -58 -97 -113 -97c-41 0 -85 24 -85 69c0 38 29 60 55 60c19 0 37 -12 37 -35c0 -15 -9 -51 -55 -54c19 -18 44 -18 48 -18c52 0 69 91 87 188l75 395h-66c-19 0 -28 0 -28 12c0 19 11 19 30 19h69c24 126 27 136 33 157c30 99 93 117 127 117c41 0 87 -23 87 -69Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6F" d="M471 214c0 -127 -101 -225 -222 -225c-117 0 -221 96 -221 225c0 125 97 234 222 234c121 0 221 -106 221 -234zM388 222c0 38 0 96 -26 139s-69 65 -113 65c-40 0 -87 -21 -114 -67c-24 -44 -24 -98 -24 -137c0 -36 0 -97 25 -141c27 -46 71 -67 114 -67 c50 0 94 29 116 74c22 44 22 98 22 134Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-69" d="M247 0c-34 1 -69 3 -104 3l-110 -3v31c67 0 78 0 78 45v269c0 49 -9 55 -74 55v31l140 11v-367c0 -39 4 -44 70 -44v-31zM192 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D453" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="552" y="0"></use>
<g transform="translate(942,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6F" x="880" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="2018" y="0"></use>
<g transform="translate(2463,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="880" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="3383" y="0"></use>
</g>
</svg>.</span>
</figcaption><p>


</p>
</div></div><p>


</p>
<p>Thus, integrating the equation of transfer with such a light allows
us to evaluate and sample the corresponding BSDF.  However, this means that
unlike all
the <a href="../Reflection_Models/BSDF_Representation.html#BxDF"><tt>BxDF</tt></a> implementations from Chapter&nbsp;<a href="../Reflection_Models.html#chap:reflection-models">9</a>,
the values that <tt>LayeredBxDF</tt> returns from methods like <tt>f()</tt> and
<tt>PDF()</tt> are stochastic.  This is perfectly fine in the context of all
of <tt>pbrt</tt>&rsquo;s Monte Carlo&ndash;based techniques and does not affect the correctness
of other estimators that use these values; it is purely one more source of error that
can be controlled in a predictable way by increasing the number of samples.

</p>
<p>The <tt>LayeredBxDF</tt> allows the specification of only two interfaces and
a homogeneous participating medium between them.  Figure&nbsp;<a href="#fig:layered-bxdf-geometric-setting">14.16</a>
illustrates the geometric setting.  Surfaces with more layers can be
modeled using a <tt>LayeredBxDF</tt> where one or both of its layers are
themselves <tt>LayeredBxDF</tt>s.  (An exercise at the end of the chapter
discusses a more efficient approach for supporting additional layers.)

</p>
<p></p>
<span class="anchor" id="fig:layered-bxdf-geometric-setting"></span><div class="card outerfigure"><div class="card-body figure"><p>



</p>
<div class="figure-row">
<img src="pha14f16.png" style="max-width: 100%; height: auto;" width=1211 height=364>
</div>
<p>


</p>
<figcaption class="caption">Figure 14.16: Geometric Setting for the <tt>LayeredBxDF</tt>. <span class="legend">
Scattering is specified by two interfaces with associated BSDFs where the
bottom one is at <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.347ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 2302.1 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">z equals 0</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D467" d="M467 432c0 -4 -22 -52 -117 -145c-36 -36 -98 -90 -98 -90c-36 -31 -65 -56 -119 -114c9 3 27 3 27 3c21 0 36 -4 70 -17c21 -7 39 -13 59 -13c33 0 97 19 120 84c3 7 5 13 14 13c8 0 12 -5 12 -10c0 -27 -58 -154 -157 -154c-29 0 -47 16 -64 37c-25 29 -35 38 -58 38 c-32 0 -62 -27 -85 -62c-6 -11 -8 -13 -16 -13c0 0 -12 0 -12 10c0 7 35 64 103 131l90 84c19 16 103 88 139 131c-26 0 -37 0 -77 15c-23 8 -42 15 -63 15c-8 0 -66 -1 -85 -47c-2 -6 -4 -11 -13 -11s-12 6 -12 11c0 21 46 114 121 114c33 0 50 -20 69 -43 c15 -17 27 -32 51 -32s45 16 75 64c5 9 8 11 15 11c0 0 11 0 11 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3D" d="M722 347c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20zM722 153c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-30" d="M460 320c0 -79 -5 -157 -37 -226c-44 -95 -120 -116 -174 -116c-49 0 -122 20 -165 101c-41 76 -45 166 -45 241c0 80 5 158 37 227c41 93 114 119 174 119c42 0 124 -16 170 -112c35 -74 40 -154 40 -234zM377 332c0 63 0 139 -10 195c-19 99 -85 117 -118 117 c-25 0 -100 -9 -119 -128c-8 -54 -8 -120 -8 -184c0 -59 0 -151 11 -211c18 -96 77 -121 116 -121c45 0 102 30 117 125c11 64 11 132 11 207Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D467" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="745" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-30" x="1801" y="0"></use>
</g>
</svg> and there is a medium of user-specified thickness
between the two interfaces.</span>
</figcaption><p>


</p>
</div></div><p>


</p>
<p>The types of <tt>BxDF</tt>s at both interfaces can be provided as template
parameters.  While the user of a <tt>LayeredBxDF</tt> is free to provide
a <a href="../Reflection_Models/BSDF_Representation.html#BxDF"><tt>BxDF</tt></a> for both of these types (in which case <tt>pbrt</tt>&rsquo;s regular dynamic
dispatch mechanism will be used), performance is better if they are
specific <a href="../Reflection_Models/BSDF_Representation.html#BxDF"><tt>BxDF</tt></a>s and the compiler can generate a specialized
implementation.  This approach is used for the <a href="#CoatedDiffuseBxDF"><tt>CoatedDiffuseBxDF</tt></a> and
the <a href="#CoatedConductorBxDF"><tt>CoatedConductorBxDF</tt></a> that are defined in
Section&nbsp;<a href="#sec:coated-bxdf-specializations">14.3.3</a>.  (The meaning of the
<tt>twoSided</tt> template parameter will be explained in a few pages, where
it is used.)

</p>
<p></p>
<span class="anchor" id="fragment-LayeredBxDFDefinition-0"></span><div class="fragmentname">&lt;&lt;LayeredBxDF Definition&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">template &lt;typename <span class="anchor" id="TopBxDF"></span>TopBxDF, typename <span class="anchor" id="BottomBxDF"></span>BottomBxDF, bool <span class="anchor" id="LayeredBxDF::twoSided"></span>twoSided&gt;
class <span class="anchor" id="LayeredBxDF"></span>LayeredBxDF {
  public:
    &lt;&lt;<span class="fragmentname"><a href="#fragment-LayeredBxDFPublicMethods-0">LayeredBxDF Public Methods</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2225" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2225"><i></i></a><div id="fragbit-2225" class="collapse show"><div class="fragmentcode">       LayeredBxDF() = default;
       PBRT_CPU_GPU
       LayeredBxDF(TopBxDF top, BottomBxDF bottom, Float thickness,
                   const <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> &amp;albedo, Float g, int maxDepth, int <a href="#LayeredBxDF::nSamples" class="code">nSamples</a>)
           : top(top),
             bottom(bottom),
             thickness(std::max(thickness, std::numeric_limits&lt;Float&gt;::min())),
             g(g),
             albedo(albedo),
             maxDepth(maxDepth), <a href="#LayeredBxDF::nSamples" class="code">nSamples</a>(<a href="#LayeredBxDF::nSamples" class="code">nSamples</a>) {}
       
       std::string ToString() const;
       
       PBRT_CPU_GPU
       void Regularize() {
           top.Regularize();
           bottom.Regularize();
       }
       
       PBRT_CPU_GPU
       <a href="../Reflection_Models/BSDF_Representation.html#BxDFFlags" class="code">BxDFFlags</a> Flags() const {
           <a href="../Reflection_Models/BSDF_Representation.html#BxDFFlags" class="code">BxDFFlags</a> topFlags = top.Flags(), bottomFlags = bottom.Flags();
           CHECK(IsTransmissive(topFlags) ||
                 IsTransmissive(bottomFlags));  // otherwise, why bother?
       
           <a href="../Reflection_Models/BSDF_Representation.html#BxDFFlags" class="code">BxDFFlags</a> flags = <a href="../Reflection_Models/BSDF_Representation.html#BxDFFlags" class="code">BxDFFlags</a>::Reflection;
           if (IsSpecular(topFlags))
               flags = flags | <a href="../Reflection_Models/BSDF_Representation.html#BxDFFlags" class="code">BxDFFlags</a>::Specular;
       
           if (IsDiffuse(topFlags) || IsDiffuse(bottomFlags) || albedo)
               flags = flags | <a href="../Reflection_Models/BSDF_Representation.html#BxDFFlags" class="code">BxDFFlags</a>::Diffuse;
           else if (IsGlossy(topFlags) || IsGlossy(bottomFlags))
               flags = flags | <a href="../Reflection_Models/BSDF_Representation.html#BxDFFlags" class="code">BxDFFlags</a>::Glossy;
       
           if (IsTransmissive(topFlags) &amp;&amp; IsTransmissive(bottomFlags))
               flags = flags | <a href="../Reflection_Models/BSDF_Representation.html#BxDFFlags" class="code">BxDFFlags</a>::Transmission;
       
           return flags;
       }
       <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> f(<a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> wo, <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> wi, <a href="../Reflection_Models/Dielectric_BSDF.html#TransportMode" class="code">TransportMode</a> mode) const {
           <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> f(0.);
           &lt;&lt;<span class="fragmentname"><a href="#fragment-EstimatemonoLayeredBxDFvaluemonofusingrandomsampling-0">Estimate <tt>LayeredBxDF</tt> value <tt>f</tt> using random sampling</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2226" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2226"><i></i></a><div id="fragbit-2226" class="collapse show"><div class="fragmentcode">              &lt;&lt;<span class="fragmentname"><a href="#fragment-SetmonowoandmonowiforlayeredBSDFevaluation-0">Set <tt>wo</tt> and <tt>wi</tt> for layered BSDF evaluation</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2227" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2227"><i></i></a><div id="fragbit-2227" class="collapse show"><div class="fragmentcode">                 if (<a href="#LayeredBxDF::twoSided" class="code">twoSided</a> &amp;&amp; wo.z &lt; 0) {
                     wo = -wo;
                     wi = -wi;
                 }</div></div>
              &lt;&lt;<span class="fragmentname"><a href="#fragment-DetermineentranceinterfaceforlayeredBSDF-0">Determine entrance interface for layered BSDF</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2228" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2228"><i></i></a><div id="fragbit-2228" class="collapse show"><div class="fragmentcode">                 TopOrBottomBxDF&lt;TopBxDF, BottomBxDF&gt; enterInterface;
                 bool enteredTop = twoSided || wo.z &gt; 0;
                 if (enteredTop) enterInterface = &amp;<a href="#LayeredBxDF::top" class="code">top</a>;
                 else            enterInterface = &amp;<a href="#LayeredBxDF::bottom" class="code">bottom</a>;</div></div>
              &lt;&lt;<span class="fragmentname"><a href="#fragment-DetermineexitinterfaceandexitzforlayeredBSDF-0">Determine exit interface and exit <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.086ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 467.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">z</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D467" d="M467 432c0 -4 -22 -52 -117 -145c-36 -36 -98 -90 -98 -90c-36 -31 -65 -56 -119 -114c9 3 27 3 27 3c21 0 36 -4 70 -17c21 -7 39 -13 59 -13c33 0 97 19 120 84c3 7 5 13 14 13c8 0 12 -5 12 -10c0 -27 -58 -154 -157 -154c-29 0 -47 16 -64 37c-25 29 -35 38 -58 38 c-32 0 -62 -27 -85 -62c-6 -11 -8 -13 -16 -13c0 0 -12 0 -12 10c0 7 35 64 103 131l90 84c19 16 103 88 139 131c-26 0 -37 0 -77 15c-23 8 -42 15 -63 15c-8 0 -66 -1 -85 -47c-2 -6 -4 -11 -13 -11s-12 6 -12 11c0 21 46 114 121 114c33 0 50 -20 69 -43 c15 -17 27 -32 51 -32s45 16 75 64c5 9 8 11 15 11c0 0 11 0 11 -10Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D467" x="0" y="0"></use>
</g>
</svg> for layered BSDF</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2229" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2229"><i></i></a><div id="fragbit-2229" class="collapse show"><div class="fragmentcode">                 TopOrBottomBxDF&lt;TopBxDF, BottomBxDF&gt; exitInterface, nonExitInterface;
                 if (<a href="../Reflection_Models/BSDF_Representation.html#SameHemisphere" class="code">SameHemisphere</a>(wo, wi) ^ enteredTop) {
                     exitInterface = &amp;bottom;
                     nonExitInterface = &amp;top;
                 } else {
                     exitInterface = &amp;top;
                     nonExitInterface = &amp;bottom;
                 }
                 Float exitZ = (<a href="../Reflection_Models/BSDF_Representation.html#SameHemisphere" class="code">SameHemisphere</a>(wo, wi) ^ enteredTop) ? 0 : <a href="#LayeredBxDF::thickness" class="code">thickness</a>;</div></div>
              &lt;&lt;<span class="fragmentname"><a href="#fragment-Accountforreflectionattheentranceinterface-0">Account for reflection at the entrance interface</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2230" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2230"><i></i></a><div id="fragbit-2230" class="collapse show"><div class="fragmentcode">                 if (<a href="../Reflection_Models/BSDF_Representation.html#SameHemisphere" class="code">SameHemisphere</a>(wo, wi))
                     <a href="../Reflection_Models/BSDF_Representation.html#BxDF::f" class="code">f</a> = <a href="#LayeredBxDF::nSamples" class="code">nSamples</a> * enterInterface.<a href="../Reflection_Models/BSDF_Representation.html#BxDF::f" class="code">f</a>(wo, wi, mode);</div></div>
              &lt;&lt;<span class="fragmentname"><a href="#fragment-DeclaremonoRNGforlayeredBSDFevaluation-0">Declare <tt>RNG</tt> for layered BSDF evaluation</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2231" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2231"><i></i></a><div id="fragbit-2231" class="collapse show"><div class="fragmentcode">                 <a href="../Utilities/Mathematical_Infrastructure.html#RNG" class="code">RNG</a> rng(<a href="../Utilities/Mathematical_Infrastructure.html#Hash" class="code">Hash</a>(<a href="../Utilities/System_Startup,_Cleanup,_and_Options.html#GetOptions" class="code">GetOptions</a>().<a href="../Utilities/System_Startup,_Cleanup,_and_Options.html#BasicPBRTOptions::seed" class="code">seed</a>, wo), <a href="../Utilities/Mathematical_Infrastructure.html#Hash" class="code">Hash</a>(wi));
                 auto r = [&amp;rng]() { return std::min&lt;Float&gt;(rng.<a href="../Utilities/Mathematical_Infrastructure.html#RNG::UniformFloat" class="code">Uniform</a>&lt;Float&gt;(),
                                                            <a href="../Sampling_and_Reconstruction/Sampling_Interface.html#OneMinusEpsilon" class="code">OneMinusEpsilon</a>); };</div></div>
              for (int s = 0; s &lt; <a href="#LayeredBxDF::nSamples" class="code">nSamples</a>; ++s) {
                  &lt;&lt;<span class="fragmentname"><a href="#fragment-SamplerandomwalkthroughlayerstoestimateBSDFvalue-0">Sample random walk through layers to estimate BSDF value</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2232" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2232"><i></i></a><div id="fragbit-2232" class="collapse show"><div class="fragmentcode">                     &lt;&lt;<span class="fragmentname"><a href="#fragment-Sampletransmissiondirectionthroughentranceinterface-0">Sample transmission direction through entrance interface</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2233" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2233"><i></i></a><div id="fragbit-2233" class="collapse show"><div class="fragmentcode">                        Float uc = r();
                        pstd::optional&lt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample" class="code">BSDFSample</a>&gt; wos =
                            enterInterface.<a href="../Reflection_Models/BSDF_Representation.html#BxDF::Sample_f" class="code">Sample_f</a>(wo, uc, <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(r(), r()), mode,
                                                    <a href="../Reflection_Models/BSDF_Representation.html#BxDFReflTransFlags::Transmission" class="code">BxDFReflTransFlags</a>::Transmission);
                        if (!wos || !wos-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::f" class="code">f</a> || wos-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::pdf" class="code">pdf</a> == 0 || wos-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>.z == 0)
                            continue;</div></div>
                     &lt;&lt;<span class="fragmentname"><a href="#fragment-SampleBSDFforvirtuallightfrommonowi-0">Sample BSDF for virtual light from <tt>wi</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2234" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2234"><i></i></a><div id="fragbit-2234" class="collapse show"><div class="fragmentcode">                        uc = r();
                        pstd::optional&lt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample" class="code">BSDFSample</a>&gt; wis =
                            exitInterface.<a href="../Reflection_Models/BSDF_Representation.html#BxDF::Sample_f" class="code">Sample_f</a>(<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>, uc, <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(r(), r()), !mode,
                                                   <a href="../Reflection_Models/BSDF_Representation.html#BxDFReflTransFlags::Transmission" class="code">BxDFReflTransFlags</a>::Transmission);
                        if (!wis || !wis-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::f" class="code">f</a> || wis-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::pdf" class="code">pdf</a> == 0 || wis-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>.z == 0)
                            continue;</div></div>
                     &lt;&lt;<span class="fragmentname"><a href="#fragment-DeclarestateforrandomwalkthroughBSDFlayers-0">Declare state for random walk through BSDF layers</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2235" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2235"><i></i></a><div id="fragbit-2235" class="collapse show"><div class="fragmentcode">                        <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> beta = wos-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::f" class="code">f</a> * <a href="../Geometry_and_Transformations/Spherical_Geometry.html#AbsCosTheta" class="code">AbsCosTheta</a>(wos-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>) / wos-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::pdf" class="code">pdf</a>;
                        Float z = enteredTop ? <a href="#LayeredBxDF::thickness" class="code">thickness</a> : 0;
                        <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> w = wos-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>;
                        <a href="../Volume_Scattering/Phase_Functions.html#HGPhaseFunction" class="code">HGPhaseFunction</a> phase(g);</div></div>
                     for (int depth = 0; depth &lt; <a href="#LayeredBxDF::maxDepth" class="code">maxDepth</a>; ++depth) {
                         &lt;&lt;<span class="fragmentname"><a href="#fragment-SamplenexteventforlayeredBSDFevaluationrandomwalk-0">Sample next event for layered BSDF evaluation random walk</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2236" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2236"><i></i></a><div id="fragbit-2236" class="collapse show"><div class="fragmentcode">                            &lt;&lt;<span class="fragmentname"><a href="#fragment-PossiblyterminatelayeredBSDFrandomwalkwithRussianroulette-0">Possibly terminate layered BSDF random walk with Russian roulette</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2237" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2237"><i></i></a><div id="fragbit-2237" class="collapse show"><div class="fragmentcode">                               if (depth &gt; 3 &amp;&amp; beta.<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum::MaxComponentValue" class="code">MaxComponentValue</a>() &lt; 0.25f) {
                                   Float q = std::max&lt;Float&gt;(0, 1 - beta.<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum::MaxComponentValue" class="code">MaxComponentValue</a>());
                                   if (r() &lt; q) break;
                                   beta /= 1 - q;
                               }</div></div>
                            &lt;&lt;<span class="fragmentname"><a href="#fragment-Accountformediabetweenlayersandpossiblyscatter-0">Account for media between layers and possibly scatter</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2238" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2238"><i></i></a><div id="fragbit-2238" class="collapse show"><div class="fragmentcode">                               if (!<a href="#LayeredBxDF::albedo" class="code">albedo</a>) {
                                   &lt;&lt;<span class="fragmentname"><a href="#fragment-Advancetonextlayerboundaryandupdatemonobetafortransmittance-0">Advance to next layer boundary and update <tt>beta</tt> for transmittance</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2239" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2239"><i></i></a><div id="fragbit-2239" class="collapse show"><div class="fragmentcode">                                      z = (z == <a href="#LayeredBxDF::thickness" class="code">thickness</a>) ? 0 : <a href="#LayeredBxDF::thickness" class="code">thickness</a>;
                                      beta *= <a href="#LayeredBxDF::Tr" class="code">Tr</a>(<a href="#LayeredBxDF::thickness" class="code">thickness</a>, w);</div></div>
                               } else {
                                   &lt;&lt;<span class="fragmentname"><a href="#fragment-SamplemediumscatteringforlayeredBSDFevaluation-0">Sample medium scattering for layered BSDF evaluation</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2240" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2240"><i></i></a><div id="fragbit-2240" class="collapse show"><div class="fragmentcode">                                      Float sigma_t = 1;
                                      Float dz = <a href="../Sampling_Algorithms/Sampling_1D_Functions.html#SampleExponential" class="code">SampleExponential</a>(r(), sigma_t / std::abs(w.z));
                                      Float zp = w.z &gt; 0 ? (z + dz) : (z - dz);
                                      if (0 &lt; zp &amp;&amp; zp &lt; <a href="#LayeredBxDF::thickness" class="code">thickness</a>) {
                                          &lt;&lt;<span class="fragmentname"><a href="#fragment-HandlescatteringeventinlayeredBSDFmedium-0">Handle scattering event in layered BSDF medium</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2241" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2241"><i></i></a><div id="fragbit-2241" class="collapse show"><div class="fragmentcode">                                             &lt;&lt;<span class="fragmentname"><a href="#fragment-AccountforscatteringthroughmonoexitInterfaceusingmonowis-0">Account for scattering through <tt>exitInterface</tt> using <tt>wis</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2242" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2242"><i></i></a><div id="fragbit-2242" class="collapse show"><div class="fragmentcode">                                                Float wt = 1;
                                                if (!<a href="../Reflection_Models/BSDF_Representation.html#BxDFFlags::IsSpecular" class="code">IsSpecular</a>(exitInterface.<a href="../Reflection_Models/BSDF_Representation.html#BxDF::Flags" class="code">Flags</a>()))
                                                    wt = <a href="../Monte_Carlo_Integration/Improving_Efficiency.html#PowerHeuristic" class="code">PowerHeuristic</a>(1, wis-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::pdf" class="code">pdf</a>, 1, phase.<a href="../Volume_Scattering/Phase_Functions.html#HGPhaseFunction::PDF" class="code">PDF</a>(-w, -wis-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>));
                                                <a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::f" class="code">f</a> += beta * <a href="#LayeredBxDF::albedo" class="code">albedo</a> * phase.<a href="../Volume_Scattering/Phase_Functions.html#HGPhaseFunction::p" class="code">p</a>(-w, -wis-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>) * wt * <a href="#LayeredBxDF::Tr" class="code">Tr</a>(zp - exitZ, wis-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>) *
                                                     wis-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::f" class="code">f</a> / wis-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::pdf" class="code">pdf</a>;</div></div>
                                             &lt;&lt;<span class="fragmentname"><a href="#fragment-Samplephasefunctionandupdatelayeredpathstate-0">Sample phase function and update layered path state</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2243" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2243"><i></i></a><div id="fragbit-2243" class="collapse show"><div class="fragmentcode">                                                <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a> u{r(), r()};
                                                pstd::optional&lt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample" class="code">PhaseFunctionSample</a>&gt; ps = phase.<a href="../Volume_Scattering/Phase_Functions.html#HGPhaseFunction::Sample_p" class="code">Sample_p</a>(-w, u);
                                                if (!ps || ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::pdf" class="code">pdf</a> == 0 || ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::wi" class="code">wi</a>.z == 0)
                                                    continue;
                                                beta *= <a href="#LayeredBxDF::albedo" class="code">albedo</a> * ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::p" class="code">p</a> / ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::pdf" class="code">pdf</a>;
                                                w = ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::wi" class="code">wi</a>;
                                                z = zp;</div></div>
                                             &lt;&lt;<span class="fragmentname"><a href="#fragment-PossiblyaccountforscatteringthroughmonoexitInterface-0">Possibly account for scattering through <tt>exitInterface</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2244" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2244"><i></i></a><div id="fragbit-2244" class="collapse show"><div class="fragmentcode">                                                if (((z &lt; exitZ &amp;&amp; w.z &gt; 0) || (z &gt; exitZ &amp;&amp; w.z &lt; 0)) &amp;&amp; 
                                                     !<a href="../Reflection_Models/BSDF_Representation.html#BxDFFlags::IsSpecular" class="code">IsSpecular</a>(exitInterface.<a href="../Reflection_Models/BSDF_Representation.html#BxDF::Flags" class="code">Flags</a>())) {
                                                    &lt;&lt;<span class="fragmentname"><a href="#fragment-AccountforscatteringthroughmonoexitInterface-0">Account for scattering through <tt>exitInterface</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2245" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2245"><i></i></a><div id="fragbit-2245" class="collapse show"><div class="fragmentcode">                                                       <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> fExit = exitInterface.<a href="../Reflection_Models/BSDF_Representation.html#BxDF::f" class="code">f</a>(-w, <a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::wi" class="code">wi</a>, mode);
                                                       if (fExit) {
                                                           Float exitPDF =
                                                               exitInterface.<a href="../Reflection_Models/BSDF_Representation.html#BxDF::PDF" class="code">PDF</a>(-w, <a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::wi" class="code">wi</a>, mode, BxDFReflTransFlags::Transmission);
                                                           Float wt = <a href="../Monte_Carlo_Integration/Improving_Efficiency.html#PowerHeuristic" class="code">PowerHeuristic</a>(1, ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::pdf" class="code">pdf</a>, 1, exitPDF);
                                                           <a href="../Reflection_Models/BSDF_Representation.html#BxDF::f" class="code">f</a> += beta * <a href="#LayeredBxDF::Tr" class="code">Tr</a>(zp - exitZ, ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::wi" class="code">wi</a>) * fExit * wt;
                                                       }</div></div>
                                                }</div></div></div></div>
                                          continue;
                                      }
                                      z = <a href="../Utilities/Mathematical_Infrastructure.html#Clamp" class="code">Clamp</a>(zp, 0, <a href="#LayeredBxDF::thickness" class="code">thickness</a>);</div></div> 
                               }</div></div>
                            &lt;&lt;<span class="fragmentname"><a href="#fragment-Accountforscatteringatappropriateinterface-0">Account for scattering at appropriate interface</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2246" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2246"><i></i></a><div id="fragbit-2246" class="collapse show"><div class="fragmentcode">                               if (z == exitZ) {
                                   &lt;&lt;<span class="fragmentname"><a href="#fragment-AccountforreflectionatmonoexitInterface-0">Account for reflection at <tt>exitInterface</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2247" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2247"><i></i></a><div id="fragbit-2247" class="collapse show"><div class="fragmentcode">                                      Float uc = r();
                                      pstd::optional&lt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample" class="code">BSDFSample</a>&gt; bs = exitInterface.<a href="../Reflection_Models/BSDF_Representation.html#BxDF::Sample_f" class="code">Sample_f</a>(
                                          -w, uc, <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(r(), r()), mode, <a href="../Reflection_Models/BSDF_Representation.html#BxDFReflTransFlags::Reflection" class="code">BxDFReflTransFlags</a>::Reflection);
                                      if (!bs || !bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::f" class="code">f</a> || bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::pdf" class="code">pdf</a> == 0 || bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>.z == 0)
                                          break;
                                      beta *= bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::f" class="code">f</a> * <a href="../Geometry_and_Transformations/Spherical_Geometry.html#AbsCosTheta" class="code">AbsCosTheta</a>(bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>) / bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::pdf" class="code">pdf</a>;
                                      w = bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>;</div></div>
                               } else {
                                   &lt;&lt;<span class="fragmentname">Account for scattering at <tt>nonExitInterface</tt></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2248" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2248"><i></i></a><div id="fragbit-2248" class="collapse show"><div class="fragmentcode">                                      if (!IsSpecular(nonExitInterface.Flags())) {
                                          &lt;&lt;<span class="fragmentname">Add NEE contribution along presampled <tt>wis</tt> direction</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2249" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2249"><i></i></a><div id="fragbit-2249" class="collapse show"><div class="fragmentcode">                                             Float wt = 1;
                                             if (!IsSpecular(exitInterface.Flags()))
                                                 wt = PowerHeuristic(1, wis-&gt;pdf,
                                                                     1, nonExitInterface.PDF(-w, -wis-&gt;wi, mode));
                                             f += beta * nonExitInterface.f(-w, -wis-&gt;wi, mode) *
                                                  AbsCosTheta(wis-&gt;wi) * wt * Tr(thickness, wis-&gt;wi) * wis-&gt;f / wis-&gt;pdf;</div></div>
                                      }
                                      &lt;&lt;<span class="fragmentname">Sample new direction using BSDF at <tt>nonExitInterface</tt></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2250" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2250"><i></i></a><div id="fragbit-2250" class="collapse show"><div class="fragmentcode">                                         Float uc = r();
                                         <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a> u(r(), r());
                                         pstd::optional&lt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample" class="code">BSDFSample</a>&gt; bs = nonExitInterface.Sample_f(
                                             -w, uc, u, mode, BxDFReflTransFlags::Reflection);
                                         if (!bs || !bs-&gt;f || bs-&gt;pdf == 0 || bs-&gt;wi.z == 0)
                                             break;
                                         beta *= bs-&gt;f * AbsCosTheta(bs-&gt;wi) / bs-&gt;pdf;
                                         w = bs-&gt;wi;</div></div>
                                      if (!IsSpecular(exitInterface.Flags())) {
                                          &lt;&lt;<span class="fragmentname">Add NEE contribution along direction from BSDF sample</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2251" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2251"><i></i></a><div id="fragbit-2251" class="collapse show"><div class="fragmentcode">                                             <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> fExit = exitInterface.f(-w, wi, mode);
                                             if (fExit) {
                                                 Float wt = 1;
                                                 if (!IsSpecular(nonExitInterface.Flags())) {
                                                     Float exitPDF = exitInterface.PDF(
                                                         -w, wi, mode, BxDFReflTransFlags::Transmission);
                                                     wt = PowerHeuristic(1, bs-&gt;pdf, 1, exitPDF);
                                                 }
                                                 f += beta * Tr(thickness, bs-&gt;wi) * fExit * wt;
                                             }</div></div>
                                      }</div></div>
                               }</div></div></div></div> 
                     }</div></div>
              }</div></div>
           return f / <a href="#LayeredBxDF::nSamples" class="code">nSamples</a>;
       }
       PBRT_CPU_GPU
       pstd::optional&lt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample" class="code">BSDFSample</a>&gt; Sample_f(<a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> wo, Float uc, <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a> u, <a href="../Reflection_Models/Dielectric_BSDF.html#TransportMode" class="code">TransportMode</a> mode,
           <a href="../Reflection_Models/BSDF_Representation.html#BxDFReflTransFlags" class="code">BxDFReflTransFlags</a> sampleFlags = <a href="../Reflection_Models/BSDF_Representation.html#BxDFReflTransFlags" class="code">BxDFReflTransFlags</a>::All) const {
           &lt;&lt;<span class="fragmentname">Set <tt>wo</tt> for layered BSDF sampling</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2252" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2252"><i></i></a><div id="fragbit-2252" class="collapse show"><div class="fragmentcode">              bool flipWi = false;
              if (twoSided &amp;&amp; wo.z &lt; 0) {
                  wo = -wo;
                  flipWi = true;
              }</div></div>
           &lt;&lt;<span class="fragmentname">Sample BSDF at entrance interface to get initial direction <tt>w</tt></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2253" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2253"><i></i></a><div id="fragbit-2253" class="collapse show"><div class="fragmentcode">              bool enteredTop = twoSided || wo.z &gt; 0;
              pstd::optional&lt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample" class="code">BSDFSample</a>&gt; bs =
                  enteredTop ? top.Sample_f(wo, uc, u, mode) : bottom.Sample_f(wo, uc, u, mode);
              if (!bs || !bs-&gt;f || bs-&gt;pdf == 0 || bs-&gt;wi.z == 0) return {};
              if (bs-&gt;IsReflection()) {
                  if (flipWi)
                      bs-&gt;wi = -bs-&gt;wi;
                  bs-&gt;pdfIsProportional = true;
                  return bs;
              }
              <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> w = bs-&gt;wi;
              bool specularPath = bs-&gt;IsSpecular();</div></div>
           &lt;&lt;<span class="fragmentname">Declare <tt>RNG</tt> for layered BSDF sampling</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2254" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2254"><i></i></a><div id="fragbit-2254" class="collapse show"><div class="fragmentcode">              <a href="../Utilities/Mathematical_Infrastructure.html#RNG" class="code">RNG</a> rng(Hash(GetOptions().seed, wo), Hash(uc, u));
              auto r = [&amp;rng]() { return std::min&lt;Float&gt;(rng.Uniform&lt;Float&gt;(),
                                                         OneMinusEpsilon); };</div></div>
           &lt;&lt;<span class="fragmentname">Declare common variables for layered BSDF sampling</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2255" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2255"><i></i></a><div id="fragbit-2255" class="collapse show"><div class="fragmentcode">              <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> f = bs-&gt;f * AbsCosTheta(bs-&gt;wi);
              Float pdf = bs-&gt;pdf;
              Float z = enteredTop ? thickness : 0;
              HGPhaseFunction phase(g);</div></div>
           for (int depth = 0; depth &lt; maxDepth; ++depth) {
               &lt;&lt;<span class="fragmentname">Follow random walk through layers to sample layered BSDF</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2256" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2256"><i></i></a><div id="fragbit-2256" class="collapse show"><div class="fragmentcode">                  &lt;&lt;<span class="fragmentname">Possibly terminate layered BSDF sampling with Russian Roulette</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2257" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2257"><i></i></a><div id="fragbit-2257" class="collapse show"><div class="fragmentcode">                     Float rrBeta = f.MaxComponentValue() / pdf;
                     if (depth &gt; 3 &amp;&amp; rrBeta &lt; 0.25f) {
                         Float q = std::max&lt;Float&gt;(0, 1 - rrBeta);
                         if (r() &lt; q)
                             return {};
                         pdf *= 1 - q;
                     }
                     if (w.z == 0)
                         return {};</div></div>
                  if (albedo) {
                      &lt;&lt;<span class="fragmentname">Sample potential scattering event in layered medium</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2258" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2258"><i></i></a><div id="fragbit-2258" class="collapse show"><div class="fragmentcode">                         Float sigma_t = 1;
                         Float dz = SampleExponential(r(), sigma_t / AbsCosTheta(w));
                         Float zp = w.z &gt; 0 ? (z + dz) : (z - dz);
                         if (zp == z) return {};
                         if (0 &lt; zp &amp;&amp; zp &lt; thickness) {
                             &lt;&lt;<span class="fragmentname">Update path state for valid scattering event between interfaces</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2259" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2259"><i></i></a><div id="fragbit-2259" class="collapse show"><div class="fragmentcode">                                pstd::optional&lt;PhaseFunctionSample&gt; ps = phase.Sample_p(-w, <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(r(), r()));
                                if (!ps || ps-&gt;pdf == 0 || ps-&gt;wi.z == 0)
                                    return {};
                                f *= albedo * ps-&gt;p;
                                pdf *= ps-&gt;pdf;
                                specularPath = false;
                                w = ps-&gt;wi;
                                z = zp;</div></div>
                             continue;
                         }
                         z = <a href="../Utilities/Mathematical_Infrastructure.html#Clamp" class="code">Clamp</a>(zp, 0, thickness);
                         </div></div>
                  } else {
                      &lt;&lt;<span class="fragmentname">Advance to the other layer interface</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2260" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2260"><i></i></a><div id="fragbit-2260" class="collapse show"><div class="fragmentcode">                         z = (z == thickness) ? 0 : thickness;
                         f *= Tr(thickness, w);</div></div>
                  }
                  &lt;&lt;<span class="fragmentname">Initialize <tt>interface</tt> for current interface surface</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2261" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2261"><i></i></a><div id="fragbit-2261" class="collapse show"><div class="fragmentcode">                     TopOrBottomBxDF&lt;TopBxDF, BottomBxDF&gt; interface;
                     if (z == 0) interface = &amp;bottom;
                     else        interface = &amp;top;</div></div>
                  &lt;&lt;<span class="fragmentname">Sample interface BSDF to determine new path direction</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2262" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2262"><i></i></a><div id="fragbit-2262" class="collapse show"><div class="fragmentcode">                     Float uc = r();
                     <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a> u(r(), r());
                     pstd::optional&lt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample" class="code">BSDFSample</a>&gt; bs = interface.Sample_f(-w, uc, u, mode);
                     if (!bs || !bs-&gt;f || bs-&gt;pdf == 0 || bs-&gt;wi.z == 0)
                         return {};
                     f *= bs-&gt;f;
                     pdf *= bs-&gt;pdf;
                     specularPath &amp;= bs-&gt;IsSpecular();
                     w = bs-&gt;wi;</div></div>
                  &lt;&lt;<span class="fragmentname">Return <tt>BSDFSample</tt> if path has left the layers</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2263" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2263"><i></i></a><div id="fragbit-2263" class="collapse show"><div class="fragmentcode">                     if (bs-&gt;IsTransmission()) {
                         <a href="../Reflection_Models/BSDF_Representation.html#BxDFFlags" class="code">BxDFFlags</a> flags = SameHemisphere(wo, w) ? <a href="../Reflection_Models/BSDF_Representation.html#BxDFFlags" class="code">BxDFFlags</a>::Reflection
                                                                 : <a href="../Reflection_Models/BSDF_Representation.html#BxDFFlags" class="code">BxDFFlags</a>::Transmission;
                         flags |= specularPath ? <a href="../Reflection_Models/BSDF_Representation.html#BxDFFlags" class="code">BxDFFlags</a>::Specular : <a href="../Reflection_Models/BSDF_Representation.html#BxDFFlags" class="code">BxDFFlags</a>::Glossy;
                         if (flipWi) w = -w;
                         return <a href="../Reflection_Models/BSDF_Representation.html#BSDFSample" class="code">BSDFSample</a>(f, w, pdf, flags, 1.f, true);
                     }</div></div>
                  &lt;&lt;<span class="fragmentname">Scale <tt>f</tt> by cosine term after scattering at the interface</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2264" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2264"><i></i></a><div id="fragbit-2264" class="collapse show"><div class="fragmentcode">                     f *= AbsCosTheta(bs-&gt;wi);</div></div></div></div>
           }
           return {};
       }
       Float PDF(<a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> wo, <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> wi, <a href="../Reflection_Models/Dielectric_BSDF.html#TransportMode" class="code">TransportMode</a> mode,
                 <a href="../Reflection_Models/BSDF_Representation.html#BxDFReflTransFlags" class="code">BxDFReflTransFlags</a> sampleFlags = <a href="../Reflection_Models/BSDF_Representation.html#BxDFReflTransFlags" class="code">BxDFReflTransFlags</a>::All) const {
           &lt;&lt;<span class="fragmentname"><a href="#fragment-SetmonowoandmonowiforlayeredBSDFevaluation-0">Set <tt>wo</tt> and <tt>wi</tt> for layered BSDF evaluation</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2265" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2265"><i></i></a><div id="fragbit-2265" class="collapse show"><div class="fragmentcode">              if (<a href="#LayeredBxDF::twoSided" class="code">twoSided</a> &amp;&amp; wo.z &lt; 0) {
                  wo = -wo;
                  wi = -wi;
              }</div></div>
           &lt;&lt;<span class="fragmentname"><a href="#fragment-DeclaremonoRNGforlayeredPDFevaluation-0">Declare <tt>RNG</tt> for layered PDF evaluation</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2266" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2266"><i></i></a><div id="fragbit-2266" class="collapse show"><div class="fragmentcode">              <a href="../Utilities/Mathematical_Infrastructure.html#RNG" class="code">RNG</a> rng(<a href="../Utilities/Mathematical_Infrastructure.html#Hash" class="code">Hash</a>(<a href="../Utilities/System_Startup,_Cleanup,_and_Options.html#GetOptions" class="code">GetOptions</a>().<a href="../Utilities/System_Startup,_Cleanup,_and_Options.html#BasicPBRTOptions::seed" class="code">seed</a>, wi), <a href="../Utilities/Mathematical_Infrastructure.html#Hash" class="code">Hash</a>(wo));
              auto r = [&amp;rng]() { return std::min&lt;Float&gt;(rng.<a href="../Utilities/Mathematical_Infrastructure.html#RNG::UniformFloat" class="code">Uniform</a>&lt;Float&gt;(),
                                                         <a href="../Sampling_and_Reconstruction/Sampling_Interface.html#OneMinusEpsilon" class="code">OneMinusEpsilon</a>); };</div></div>
           &lt;&lt;<span class="fragmentname"><a href="#fragment-UpdatemonopdfSumforreflectionattheentrancelayer-0">Update <tt>pdfSum</tt> for reflection at the entrance layer</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2267" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2267"><i></i></a><div id="fragbit-2267" class="collapse show"><div class="fragmentcode">              bool enteredTop = twoSided || wo.z &gt; 0;
              Float pdfSum = 0;
              if (<a href="../Reflection_Models/BSDF_Representation.html#SameHemisphere" class="code">SameHemisphere</a>(wo, wi)) {
                  auto reflFlag = <a href="../Reflection_Models/BSDF_Representation.html#BxDFReflTransFlags::Reflection" class="code">BxDFReflTransFlags</a>::Reflection;
                  pdfSum += enteredTop ?
                            <a href="#LayeredBxDF::nSamples" class="code">nSamples</a> * <a href="#LayeredBxDF::top" class="code">top</a>.<a href="../Reflection_Models/BSDF_Representation.html#BxDF::PDF" class="code">PDF</a>(wo, wi, mode, reflFlag) :
                            <a href="#LayeredBxDF::nSamples" class="code">nSamples</a> * <a href="#LayeredBxDF::bottom" class="code">bottom</a>.<a href="../Reflection_Models/BSDF_Representation.html#BxDF::PDF" class="code">PDF</a>(wo, wi, mode, reflFlag);
              }</div></div>
           for (int s = 0; s &lt; <a href="#LayeredBxDF::nSamples" class="code">nSamples</a>; ++s) {
               &lt;&lt;<span class="fragmentname"><a href="#fragment-EvaluatelayeredBSDFPDFsample-0">Evaluate layered BSDF PDF sample</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2268" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2268"><i></i></a><div id="fragbit-2268" class="collapse show"><div class="fragmentcode">                  if (<a href="../Reflection_Models/BSDF_Representation.html#SameHemisphere" class="code">SameHemisphere</a>(wo, wi)) {
                      &lt;&lt;<span class="fragmentname"><a href="#fragment-EvaluateTRTtermforPDFestimate-0">Evaluate TRT term for PDF estimate</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2269" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2269"><i></i></a><div id="fragbit-2269" class="collapse show"><div class="fragmentcode">                         TopOrBottomBxDF&lt;TopBxDF, BottomBxDF&gt; rInterface, tInterface;
                         if (enteredTop) {
                             rInterface = &amp;bottom;  tInterface = &amp;top;
                         } else {
                             rInterface = &amp;top;     tInterface = &amp;bottom;
                         }
                         &lt;&lt;<span class="fragmentname"><a href="#fragment-SamplemonotInterfacetogetdirectionintothelayers-0">Sample <tt>tInterface</tt> to get direction into the layers</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2270" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2270"><i></i></a><div id="fragbit-2270" class="collapse show"><div class="fragmentcode">                            auto trans = BxDFReflTransFlags::Transmission;
                            pstd::optional&lt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample" class="code">BSDFSample</a>&gt; wos, wis;
                            wos = tInterface.Sample_f(wo, r(), {r(), r()},  mode, trans);
                            wis = tInterface.Sample_f(wi, r(), {r(), r()}, !mode, trans);</div></div>
                         &lt;&lt;<span class="fragmentname"><a href="#fragment-UpdatemonopdfSumaccountingforTRTscatteringevents-0">Update <tt>pdfSum</tt> accounting for TRT scattering events</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2271" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2271"><i></i></a><div id="fragbit-2271" class="collapse show"><div class="fragmentcode">                            if (wos &amp;&amp; wos-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::f" class="code">f</a> &amp;&amp; wos-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::pdf" class="code">pdf</a> &gt; 0 &amp;&amp; wis &amp;&amp; wis-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::f" class="code">f</a> &amp;&amp; wis-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::pdf" class="code">pdf</a> &gt; 0) {
                                if (!<a href="../Reflection_Models/BSDF_Representation.html#BxDFFlags::IsNonSpecular" class="code">IsNonSpecular</a>(tInterface.<a href="../Reflection_Models/BSDF_Representation.html#BxDF::Flags" class="code">Flags</a>()))
                                    pdfSum += rInterface.<a href="../Reflection_Models/BSDF_Representation.html#BxDF::PDF" class="code">PDF</a>(-wos-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>, -wis-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>, mode);
                                else {
                                    &lt;&lt;<span class="fragmentname"><a href="#fragment-UsemultipleimportancesamplingtoestimatePDFproduct-0">Use multiple importance sampling to estimate PDF product</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2272" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2272"><i></i></a><div id="fragbit-2272" class="collapse show"><div class="fragmentcode">                                       pstd::optional&lt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample" class="code">BSDFSample</a>&gt; rs =
                                           rInterface.<a href="../Reflection_Models/BSDF_Representation.html#BSDF::Sample_f" class="code">Sample_f</a>(-wos-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>, r(), {r(), r()}, mode);
                                       if (rs &amp;&amp; rs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::f" class="code">f</a> &amp;&amp; rs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::pdf" class="code">pdf</a> &gt; 0) {
                                           if (!<a href="../Reflection_Models/BSDF_Representation.html#BxDFFlags::IsNonSpecular" class="code">IsNonSpecular</a>(rInterface.<a href="../Reflection_Models/BSDF_Representation.html#BxDF::Flags" class="code">Flags</a>()))
                                               pdfSum += tInterface.<a href="../Reflection_Models/BSDF_Representation.html#BxDF::PDF" class="code">PDF</a>(-rs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>, <a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>, mode);
                                           else {
                                               &lt;&lt;<span class="fragmentname"><a href="#fragment-ComputeMIS-weightedestimateofEquationrefeq:pdf-triple-canceled-one-0">Compute MIS-weighted estimate of Equation (<a href="#eq:pdf-triple-canceled-one">14.38</a>)</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2273" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2273"><i></i></a><div id="fragbit-2273" class="collapse show"><div class="fragmentcode">                                                  Float rPDF = rInterface.<a href="../Reflection_Models/BSDF_Representation.html#BxDF::PDF" class="code">PDF</a>(-wos-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>, -wis-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>, mode);
                                                  Float wt = <a href="../Monte_Carlo_Integration/Improving_Efficiency.html#PowerHeuristic" class="code">PowerHeuristic</a>(1, wis-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::pdf" class="code">pdf</a>, 1, rPDF);
                                                  pdfSum += wt * rPDF;
                                                  Float tPDF = tInterface.<a href="../Reflection_Models/BSDF_Representation.html#BxDF::PDF" class="code">PDF</a>(-rs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>, <a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>, mode);
                                                  wt = <a href="../Monte_Carlo_Integration/Improving_Efficiency.html#PowerHeuristic" class="code">PowerHeuristic</a>(1, rs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::pdf" class="code">pdf</a>, 1, tPDF);
                                                  pdfSum += wt * tPDF;</div></div>
                                           }
                                       }</div></div>
                                }
                            }</div></div></div></div>
                  } else {
                      &lt;&lt;<span class="fragmentname">Evaluate TT term for PDF estimate</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2274" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2274"><i></i></a><div id="fragbit-2274" class="collapse show"><div class="fragmentcode">                         TopOrBottomBxDF&lt;TopBxDF, BottomBxDF&gt; toInterface, tiInterface;
                         if (enteredTop) {
                             toInterface = &amp;top;
                             tiInterface = &amp;bottom;
                         } else {
                             toInterface = &amp;bottom;
                             tiInterface = &amp;top;
                         }
                         
                         Float uc = r();
                         <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a> u(r(), r());
                         pstd::optional&lt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample" class="code">BSDFSample</a>&gt; wos = toInterface.Sample_f(wo, uc, u, mode);
                         if (!wos || !wos-&gt;f || wos-&gt;pdf == 0 || wos-&gt;wi.z == 0 || wos-&gt;IsReflection())
                             continue;
                         
                         uc = r();
                         u = <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(r(), r());
                         pstd::optional&lt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample" class="code">BSDFSample</a>&gt; wis = tiInterface.Sample_f(wi, uc, u, !mode);
                         if (!wis || !wis-&gt;f || wis-&gt;pdf == 0 || wis-&gt;wi.z == 0 || wis-&gt;IsReflection())
                             continue;
                         
                         if (IsSpecular(toInterface.Flags()))
                             pdfSum += tiInterface.PDF(-wos-&gt;wi, wi, mode);
                         else if (IsSpecular(tiInterface.Flags()))
                             pdfSum += toInterface.PDF(wo, -wis-&gt;wi, mode);
                         else
                             pdfSum += (toInterface.PDF(wo, -wis-&gt;wi, mode) +
                                        tiInterface.PDF(-wos-&gt;wi, wi, mode)) /
                                       2;</div></div>
                  }</div></div>
           }
           &lt;&lt;<span class="fragmentname"><a href="#fragment-ReturnmixtureofPDFestimateandconstantPDF-0">Return mixture of PDF estimate and constant PDF</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2275" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2275"><i></i></a><div id="fragbit-2275" class="collapse show"><div class="fragmentcode">              return <a href="../Monte_Carlo_Integration/Sampling_Using_the_Inversion_Method.html#Lerp" class="code">Lerp</a>(0.9f, 1 / (4 * <a href="../Utilities/Mathematical_Infrastructure.html#Pi" class="code">Pi</a>), pdfSum / <a href="#LayeredBxDF::nSamples" class="code">nSamples</a>);</div></div>
       }</div></div>
  private:
    &lt;&lt;<span class="fragmentname"><a href="#fragment-LayeredBxDFPrivateMethods-0">LayeredBxDF Private Methods</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2276" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2276"><i></i></a><div id="fragbit-2276" class="collapse show"><div class="fragmentcode">       static Float Tr(Float dz, <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> w) {
           return <a href="../Utilities/Mathematical_Infrastructure.html#FastExp" class="code">FastExp</a>(-std::abs(dz / w.z));
       }</div></div>
    &lt;&lt;<span class="fragmentname"><a href="#fragment-LayeredBxDFPrivateMembers-0">LayeredBxDF Private Members</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2277" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2277"><i></i></a><div id="fragbit-2277" class="collapse show"><div class="fragmentcode">       TopBxDF top;
       BottomBxDF bottom;
       Float thickness, g;
       <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> albedo;
       int maxDepth, nSamples;</div></div>
};</div><p>


</p>
<p> </p>
<span class="anchor" id="fig:layered-bxdf-thickness"></span><div class="card outerfigure"><div class="card-body figure"><p>


</p>
<div class="figure-row">
<img src="dragon-layered-thick0.png" style="max-width: 100%; height: auto;" width=1500 height=900>
</div>
<p>

</p>
<div class="figure-row">
<img src="dragon-layered-thick0.15.png" style="max-width: 100%; height: auto;" width=1500 height=900>
</div>
<p>

</p>
<div class="figure-row">
<img src="dragon-layered-thick0.5.png" style="max-width: 100%; height: auto;" width=1500 height=900>
</div>
<p>

</p>
<figcaption class="caption">Figure 14.17: Effect of Varying Medium Thickness with the <tt>LayeredBxDF</tt>. <span class="legend">
(a)&nbsp;Dragon with surface reflectance modeled by a smooth conductor base
layer and a dielectric interface above it.
(b)&nbsp;With a scattering layer with albedo <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.972ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 1279.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">0.7</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-30" d="M460 320c0 -79 -5 -157 -37 -226c-44 -95 -120 -116 -174 -116c-49 0 -122 20 -165 101c-41 76 -45 166 -45 241c0 80 5 158 37 227c41 93 114 119 174 119c42 0 124 -16 170 -112c35 -74 40 -154 40 -234zM377 332c0 63 0 139 -10 195c-19 99 -85 117 -118 117 c-25 0 -100 -9 -119 -128c-8 -54 -8 -120 -8 -184c0 -59 0 -151 11 -211c18 -96 77 -121 116 -121c45 0 102 30 117 125c11 64 11 132 11 207Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2E" d="M192 53c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-37" d="M485 644c0 -21 0 -23 -9 -35l-135 -190c-44 -62 -58 -148 -62 -171c-8 -54 -11 -109 -11 -164v-51c0 -10 0 -55 -46 -55s-46 45 -46 55c0 102 33 241 123 376l112 158h-207c-13 0 -91 0 -98 -6c-13 -12 -22 -75 -25 -91h-25l33 206h25c4 -19 6 -32 128 -32h243Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-30"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2E" x="500" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-37" x="779" y="0"></use>
</g>
</svg> and thickness <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.134ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 1780 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">0.15</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-30" d="M460 320c0 -79 -5 -157 -37 -226c-44 -95 -120 -116 -174 -116c-49 0 -122 20 -165 101c-41 76 -45 166 -45 241c0 80 5 158 37 227c41 93 114 119 174 119c42 0 124 -16 170 -112c35 -74 40 -154 40 -234zM377 332c0 63 0 139 -10 195c-19 99 -85 117 -118 117 c-25 0 -100 -9 -119 -128c-8 -54 -8 -120 -8 -184c0 -59 0 -151 11 -211c18 -96 77 -121 116 -121c45 0 102 30 117 125c11 64 11 132 11 207Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2E" d="M192 53c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-35" d="M449 201c0 -127 -102 -223 -218 -223c-112 0 -181 97 -181 183c0 46 35 53 49 53c33 0 50 -25 50 -49s-17 -49 -50 -49c-11 0 -14 1 -17 2c17 -59 74 -112 147 -112c46 0 83 26 107 65c24 42 24 102 24 137c0 50 -2 89 -18 126c-8 18 -33 64 -85 64 c-81 0 -118 -54 -129 -70c-4 -6 -6 -9 -13 -9c-14 0 -14 8 -14 26v296c0 16 0 24 10 24c0 0 4 0 12 -3c47 -21 93 -28 133 -28c67 0 116 20 136 29c5 3 8 3 8 3c7 0 10 -5 10 -11c0 -13 -70 -104 -193 -104c-32 0 -65 7 -85 13v-195c36 35 79 51 127 51 c108 0 190 -100 190 -219Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-30"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2E" x="500" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-31" x="779" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-35" x="1279" y="0"></use>
</g>
</svg> between
the interface and the conductor, the reflection of the conductor is
slightly dimmed.
(c)&nbsp;With a thicker scattering layer of thickness <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.972ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 1279.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">0.5</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-30" d="M460 320c0 -79 -5 -157 -37 -226c-44 -95 -120 -116 -174 -116c-49 0 -122 20 -165 101c-41 76 -45 166 -45 241c0 80 5 158 37 227c41 93 114 119 174 119c42 0 124 -16 170 -112c35 -74 40 -154 40 -234zM377 332c0 63 0 139 -10 195c-19 99 -85 117 -118 117 c-25 0 -100 -9 -119 -128c-8 -54 -8 -120 -8 -184c0 -59 0 -151 11 -211c18 -96 77 -121 116 -121c45 0 102 30 117 125c11 64 11 132 11 207Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2E" d="M192 53c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-35" d="M449 201c0 -127 -102 -223 -218 -223c-112 0 -181 97 -181 183c0 46 35 53 49 53c33 0 50 -25 50 -49s-17 -49 -50 -49c-11 0 -14 1 -17 2c17 -59 74 -112 147 -112c46 0 83 26 107 65c24 42 24 102 24 137c0 50 -2 89 -18 126c-8 18 -33 64 -85 64 c-81 0 -118 -54 -129 -70c-4 -6 -6 -9 -13 -9c-14 0 -14 8 -14 26v296c0 16 0 24 10 24c0 0 4 0 12 -3c47 -21 93 -28 133 -28c67 0 116 20 136 29c5 3 8 3 8 3c7 0 10 -5 10 -11c0 -13 -70 -104 -193 -104c-32 0 -65 7 -85 13v-195c36 35 79 51 127 51 c108 0 190 -100 190 -219Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-30"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2E" x="500" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-35" x="779" y="0"></use>
</g>
</svg>, the conductor is
much more attenuated and the overall reflection is more diffuse.
<em>(Dragon model courtesy of the Stanford Computer Graphics Laboratory.)</em></span>
</figcaption><p>


</p>
</div></div><p>


</p>
<p>In addition to <a href="../Reflection_Models/BSDF_Representation.html#BxDF"><tt>BxDF</tt></a>s for the two interfaces, the <tt>LayeredBxDF</tt>
maintains member variables that describe the medium between them.
Rather than have the user specify scattering coefficients, which can be
unintuitive to set manually, it assumes a medium with <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="6.46ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 2781.5 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">sigma Subscript normal t Baseline equals 1</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D70E" d="M567 407c0 -34 -36 -34 -49 -34h-110c31 -44 31 -92 31 -109c0 -154 -133 -275 -251 -275c-91 0 -150 70 -150 158c0 119 111 284 262 284h228c18 0 39 0 39 -24zM375 276c0 31 -8 97 -92 97c-34 0 -94 -14 -136 -83c-35 -59 -47 -141 -47 -171c0 -72 40 -108 89 -108 c39 0 93 26 132 85c34 51 54 133 54 180Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-74" d="M332 124c0 -64 -28 -135 -99 -135c-36 0 -129 12 -129 135v276h-85v22c98 4 128 111 129 193h25v-184h143v-31h-143v-278c0 -17 0 -108 67 -108c37 0 67 38 67 112v55h25v-57Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3D" d="M722 347c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20zM722 153c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D70E" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-74" x="808" y="-213"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="1224" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-31" x="2280" y="0"></use>
</g>
</svg> and
leaves it to the user to specify both the thickness of the medium and its
scattering albedo.  Figure&nbsp;<a href="#fig:layered-bxdf-thickness">14.17</a> shows the
effect of varying the thickness of the medium between a conductor base
layer and a dielectric interface.

</p>
<p></p>
<span class="anchor" id="fragment-LayeredBxDFPrivateMembers-0"></span><div class="fragmentname">&lt;&lt;LayeredBxDF Private Members&gt;&gt;=&nbsp;<a href="#fragment-LayeredBxDFPrivateMembers-1"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode">TopBxDF <span class="anchor" id="LayeredBxDF::top"></span>top;
BottomBxDF <span class="anchor" id="LayeredBxDF::bottom"></span>bottom;
Float <span class="anchor" id="LayeredBxDF::thickness"></span>thickness, <span class="anchor" id="LayeredBxDF::g"></span>g;
<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> <span class="anchor" id="LayeredBxDF::albedo"></span>albedo;</div><p>


</p>
<p>Two parameters control the Monte Carlo estimates.  <tt>maxDepth</tt> has its
usual role in setting a maximum number of scattering events along a path
and <tt>nSamples</tt> controls the number of independent samples of the
estimators that are averaged.  Because additional samples in this context
do not require tracing more rays or evaluating textures, it is more
efficient to reduce any noise due to the stochastic BSDF by increasing this
sampling rate rather than increasing the pixel sampling rate if a higher
pixel sampling rate is not otherwise useful.

</p>
<p></p>
<span class="anchor" id="fragment-LayeredBxDFPrivateMembers-1"></span><div class="fragmentname">&lt;&lt;LayeredBxDF Private Members&gt;&gt;+=&nbsp;<a href="#fragment-LayeredBxDFPrivateMembers-0"><span class="fa fa-caret-up"></span></a></div>
<div class="fragmentcode">int <span class="anchor" id="LayeredBxDF::maxDepth"></span>maxDepth, <span class="anchor" id="LayeredBxDF::nSamples"></span>nSamples;</div><p>


</p>
<p>We will find it useful to have a helper function <tt>Tr()</tt> that returns
the transmittance for a ray segment in the medium with given direction
<tt>w</tt> that passes through a distance <tt>dz</tt> in <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.086ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 467.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">z</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D467" d="M467 432c0 -4 -22 -52 -117 -145c-36 -36 -98 -90 -98 -90c-36 -31 -65 -56 -119 -114c9 3 27 3 27 3c21 0 36 -4 70 -17c21 -7 39 -13 59 -13c33 0 97 19 120 84c3 7 5 13 14 13c8 0 12 -5 12 -10c0 -27 -58 -154 -157 -154c-29 0 -47 16 -64 37c-25 29 -35 38 -58 38 c-32 0 -62 -27 -85 -62c-6 -11 -8 -13 -16 -13c0 0 -12 0 -12 10c0 7 35 64 103 131l90 84c19 16 103 88 139 131c-26 0 -37 0 -77 15c-23 8 -42 15 -63 15c-8 0 -66 -1 -85 -47c-2 -6 -4 -11 -13 -11s-12 6 -12 11c0 21 46 114 121 114c33 0 50 -20 69 -43 c15 -17 27 -32 51 -32s45 16 75 64c5 9 8 11 15 11c0 0 11 0 11 -10Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D467" x="0" y="0"></use>
</g>
</svg>, following
Equation&nbsp;(<a href="#eq:beamtrans-1d-homogeneous">14.30</a>) with <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="6.46ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 2781.5 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">sigma Subscript normal t Baseline equals 1</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D70E" d="M567 407c0 -34 -36 -34 -49 -34h-110c31 -44 31 -92 31 -109c0 -154 -133 -275 -251 -275c-91 0 -150 70 -150 158c0 119 111 284 262 284h228c18 0 39 0 39 -24zM375 276c0 31 -8 97 -92 97c-34 0 -94 -14 -136 -83c-35 -59 -47 -141 -47 -171c0 -72 40 -108 89 -108 c39 0 93 26 132 85c34 51 54 133 54 180Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-74" d="M332 124c0 -64 -28 -135 -99 -135c-36 0 -129 12 -129 135v276h-85v22c98 4 128 111 129 193h25v-184h143v-31h-143v-278c0 -17 0 -108 67 -108c37 0 67 38 67 112v55h25v-57Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3D" d="M722 347c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20zM722 153c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D70E" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-74" x="808" y="-213"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="1224" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-31" x="2280" y="0"></use>
</g>
</svg>.

</p>
<p></p>
<span class="anchor" id="fragment-LayeredBxDFPrivateMethods-0"></span><div class="fragmentname">&lt;&lt;LayeredBxDF Private Methods&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">static Float <span class="anchor" id="LayeredBxDF::Tr"></span>Tr(Float dz, <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> w) {
    return <a href="../Utilities/Mathematical_Infrastructure.html#FastExp" class="code">FastExp</a>(-std::abs(dz / w.z));
}</div><p>


</p>
<p>

</p>
<p>Although the <tt>LayeredBxDF</tt> is specified in terms of top and bottom
interfaces, we will find it useful to exchange the &ldquo;top&rdquo; and &ldquo;bottom&rdquo;
as necessary to have the convention that the interface that the incident
ray intersects is defined to be the top one. (See
Figure&nbsp;<a href="#fig:layeredbxdf-top-or-bottom">14.18</a>.)  A
helper class, <tt>TopOrBottomBxDF</tt>, manages the logic related to
these possibilities.  As its name suggests, it stores a pointer to one (and
only one) of two <tt>BxDF</tt> types that are provided as template
parameters.

</p>
<p></p>
<span class="anchor" id="fig:layeredbxdf-top-or-bottom"></span><div class="card outerfigure"><div class="card-body figure"><p>



</p>
<div class="figure-row">
<img src="pha14f18.png" style="max-width: 100%; height: auto;" width=1235 height=396>
</div>
<p>


</p>
<figcaption class="caption">Figure 14.18: <span class="legend">
If the incident ray intersects the layer at <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="13.446ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 5789.1 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">z equals normal t normal h normal i normal c normal k normal n normal e normal s normal s</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D467" d="M467 432c0 -4 -22 -52 -117 -145c-36 -36 -98 -90 -98 -90c-36 -31 -65 -56 -119 -114c9 3 27 3 27 3c21 0 36 -4 70 -17c21 -7 39 -13 59 -13c33 0 97 19 120 84c3 7 5 13 14 13c8 0 12 -5 12 -10c0 -27 -58 -154 -157 -154c-29 0 -47 16 -64 37c-25 29 -35 38 -58 38 c-32 0 -62 -27 -85 -62c-6 -11 -8 -13 -16 -13c0 0 -12 0 -12 10c0 7 35 64 103 131l90 84c19 16 103 88 139 131c-26 0 -37 0 -77 15c-23 8 -42 15 -63 15c-8 0 -66 -1 -85 -47c-2 -6 -4 -11 -13 -11s-12 6 -12 11c0 21 46 114 121 114c33 0 50 -20 69 -43 c15 -17 27 -32 51 -32s45 16 75 64c5 9 8 11 15 11c0 0 11 0 11 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3D" d="M722 347c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20zM722 153c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-74" d="M332 124c0 -64 -28 -135 -99 -135c-36 0 -129 12 -129 135v276h-85v22c98 4 128 111 129 193h25v-184h143v-31h-143v-278c0 -17 0 -108 67 -108c37 0 67 38 67 112v55h25v-57Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-68" d="M535 0l-112 3l-113 -3v31c67 0 78 0 78 45v233c0 57 -11 111 -74 111c-64 0 -135 -56 -135 -160v-184c0 -45 11 -45 78 -45v-31l-112 3l-113 -3v31c67 0 78 0 78 45v520c0 49 -8 56 -78 56v31l144 11v-348h1c16 36 60 96 144 96c58 0 91 -20 105 -37 c31 -36 31 -67 31 -153v-191c1 -30 26 -30 78 -30v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-69" d="M247 0c-34 1 -69 3 -104 3l-110 -3v31c67 0 78 0 78 45v269c0 49 -9 55 -74 55v31l140 11v-367c0 -39 4 -44 70 -44v-31zM192 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-63" d="M415 119c0 -10 -32 -130 -166 -130c-116 0 -215 99 -215 227c0 124 92 232 217 232c77 0 153 -39 153 -107c0 -30 -20 -47 -46 -47c-28 0 -46 20 -46 46c0 13 6 43 47 46c-35 36 -98 37 -107 37c-53 0 -135 -42 -135 -205c0 -161 88 -204 141 -204c37 0 102 12 131 105 c2 6 4 10 13 10c3 0 13 0 13 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6B" d="M511 0c-29 2 -58 3 -87 3l-108 -3v31c19 0 36 4 36 23c0 18 -42 74 -119 180l-64 -55v-103c0 -45 11 -45 78 -45v-31l-110 3l-109 -3v31c67 0 78 0 78 45v520c0 49 -8 56 -78 56v31l144 11v-480l141 122c8 7 22 19 22 39c0 13 -10 24 -29 25v31c14 -1 76 -3 112 -3 c28 0 41 0 70 3v-31c-21 -1 -63 -3 -126 -54c-10 -8 -81 -68 -81 -72c0 -3 5 -9 6 -11l127 -179c38 -53 60 -53 97 -53v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6E" d="M535 0l-112 3l-113 -3v31c67 0 78 0 78 45v233c0 57 -11 111 -74 111c-64 0 -135 -56 -135 -160v-184c0 -45 11 -45 78 -45v-31l-112 3l-113 -3v31c67 0 78 0 78 45v268c0 49 -8 56 -78 56v31l141 11v-105c28 62 75 105 148 105c58 0 91 -20 105 -37 c31 -36 31 -67 31 -153v-191c1 -30 26 -30 78 -30v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-65" d="M415 119c0 -19 -45 -130 -167 -130c-115 0 -220 97 -220 231c0 125 92 228 208 228c125 0 179 -97 179 -196c0 -21 -3 -21 -25 -21h-279c0 -36 0 -102 30 -150c23 -37 63 -67 113 -67c10 0 100 0 135 103c2 8 4 14 13 14c5 0 13 -2 13 -12zM349 252 c0 39 -10 174 -113 174c-34 0 -118 -25 -124 -174h237Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-73" d="M360 128c0 -72 -46 -139 -161 -139c-21 0 -66 1 -110 43c-18 -19 -18 -21 -20 -23c-19 -19 -20 -20 -25 -20c-11 0 -11 7 -11 24v132c0 18 0 25 13 25c10 0 11 -4 14 -17c19 -85 55 -142 139 -142c78 0 113 40 113 91c0 72 -82 88 -104 92c-72 14 -100 20 -132 46 c-27 22 -43 50 -43 85c0 56 38 123 160 123c15 0 56 0 94 -28c4 3 14 12 17 16c13 12 15 12 20 12c11 0 11 -7 11 -24v-101c0 -19 0 -24 -13 -24c0 0 -11 0 -12 9c-2 31 -7 121 -117 121c-86 0 -112 -41 -112 -76c0 -58 67 -71 123 -82c42 -8 81 -16 114 -48 c12 -12 42 -42 42 -95Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D467" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="745" y="0"></use>
<g transform="translate(1801,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-74" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-68" x="389" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-69" x="946" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-63" x="1224" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-6B" x="1669" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-6E" x="2197" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-65" x="2754" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-73" x="3198" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-73" x="3593" y="0"></use>
</g>
</g>
</svg>, then the
top layer is the same as is specified in the <a href="#LayeredBxDF::top"><tt>LayeredBxDF::top</tt></a> member
variable.
However, if it intersects the surface from the other direction at
<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.347ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 2302.1 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">z equals 0</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D467" d="M467 432c0 -4 -22 -52 -117 -145c-36 -36 -98 -90 -98 -90c-36 -31 -65 -56 -119 -114c9 3 27 3 27 3c21 0 36 -4 70 -17c21 -7 39 -13 59 -13c33 0 97 19 120 84c3 7 5 13 14 13c8 0 12 -5 12 -10c0 -27 -58 -154 -157 -154c-29 0 -47 16 -64 37c-25 29 -35 38 -58 38 c-32 0 -62 -27 -85 -62c-6 -11 -8 -13 -16 -13c0 0 -12 0 -12 10c0 7 35 64 103 131l90 84c19 16 103 88 139 131c-26 0 -37 0 -77 15c-23 8 -42 15 -63 15c-8 0 -66 -1 -85 -47c-2 -6 -4 -11 -13 -11s-12 6 -12 11c0 21 46 114 121 114c33 0 50 -20 69 -43 c15 -17 27 -32 51 -32s45 16 75 64c5 9 8 11 15 11c0 0 11 0 11 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3D" d="M722 347c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20zM722 153c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-30" d="M460 320c0 -79 -5 -157 -37 -226c-44 -95 -120 -116 -174 -116c-49 0 -122 20 -165 101c-41 76 -45 166 -45 241c0 80 5 158 37 227c41 93 114 119 174 119c42 0 124 -16 170 -112c35 -74 40 -154 40 -234zM377 332c0 63 0 139 -10 195c-19 99 -85 117 -118 117 c-25 0 -100 -9 -119 -128c-8 -54 -8 -120 -8 -184c0 -59 0 -151 11 -211c18 -96 77 -121 116 -121c45 0 102 30 117 125c11 64 11 132 11 207Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D467" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="745" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-30" x="1801" y="0"></use>
</g>
</svg>, we will find it useful to treat the <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.347ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 2302.1 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">z equals 0</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D467" d="M467 432c0 -4 -22 -52 -117 -145c-36 -36 -98 -90 -98 -90c-36 -31 -65 -56 -119 -114c9 3 27 3 27 3c21 0 36 -4 70 -17c21 -7 39 -13 59 -13c33 0 97 19 120 84c3 7 5 13 14 13c8 0 12 -5 12 -10c0 -27 -58 -154 -157 -154c-29 0 -47 16 -64 37c-25 29 -35 38 -58 38 c-32 0 -62 -27 -85 -62c-6 -11 -8 -13 -16 -13c0 0 -12 0 -12 10c0 7 35 64 103 131l90 84c19 16 103 88 139 131c-26 0 -37 0 -77 15c-23 8 -42 15 -63 15c-8 0 -66 -1 -85 -47c-2 -6 -4 -11 -13 -11s-12 6 -12 11c0 21 46 114 121 114c33 0 50 -20 69 -43 c15 -17 27 -32 51 -32s45 16 75 64c5 9 8 11 15 11c0 0 11 0 11 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3D" d="M722 347c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20zM722 153c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-30" d="M460 320c0 -79 -5 -157 -37 -226c-44 -95 -120 -116 -174 -116c-49 0 -122 20 -165 101c-41 76 -45 166 -45 241c0 80 5 158 37 227c41 93 114 119 174 119c42 0 124 -16 170 -112c35 -74 40 -154 40 -234zM377 332c0 63 0 139 -10 195c-19 99 -85 117 -118 117 c-25 0 -100 -9 -119 -128c-8 -54 -8 -120 -8 -184c0 -59 0 -151 11 -211c18 -96 77 -121 116 -121c45 0 102 30 117 125c11 64 11 132 11 207Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D467" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="745" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-30" x="1801" y="0"></use>
</g>
</svg> layer as the top one and
the other as the bottom.  The <a href="#TopOrBottomBxDF"><tt>TopOrBottomBxDF</tt></a> class helps with
related bookkeeping.</span>
</figcaption><p>


</p>
</div></div><p>


</p>
<p></p>
<span class="anchor" id="fragment-TopOrBottomBxDFDefinition-0"></span><div class="fragmentname">&lt;&lt;TopOrBottomBxDF Definition&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">template &lt;typename TopBxDF, typename BottomBxDF&gt;
class <span class="anchor" id="TopOrBottomBxDF"></span>TopOrBottomBxDF {
  public:
    &lt;&lt;<span class="fragmentname"><a href="#fragment-TopOrBottomBxDFPublicMethods-0">TopOrBottomBxDF Public Methods</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2278" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2278"><i></i></a><div id="fragbit-2278" class="collapse show"><div class="fragmentcode">       TopOrBottomBxDF() = default;
       PBRT_CPU_GPU
       TopOrBottomBxDF &amp;operator=(const TopBxDF *t) {
           <a href="#TopOrBottomBxDF::top" class="code">top</a> = t;
           <a href="#TopOrBottomBxDF::bottom" class="code">bottom</a> = nullptr;
           return *this;
       }
       PBRT_CPU_GPU
       TopOrBottomBxDF &amp;operator=(const BottomBxDF *b) {
           <a href="#TopOrBottomBxDF::bottom" class="code">bottom</a> = b;
           <a href="#TopOrBottomBxDF::top" class="code">top</a> = nullptr;
           return *this;
       }
       <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> <a href="../Reflection_Models/BSDF_Representation.html#BxDF::f" class="code">f</a>(<a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> wo, <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> wi, <a href="../Reflection_Models/Dielectric_BSDF.html#TransportMode" class="code">TransportMode</a> mode) const {
           return <a href="#TopOrBottomBxDF::top" class="code">top</a> ? <a href="#TopOrBottomBxDF::top" class="code">top</a>-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BxDF::f" class="code">f</a>(wo, wi, mode) : <a href="#TopOrBottomBxDF::bottom" class="code">bottom</a>-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BxDF::f" class="code">f</a>(wo, wi, mode);
       }
       PBRT_CPU_GPU
       pstd::optional&lt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample" class="code">BSDFSample</a>&gt; Sample_f(
           <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> wo, Float uc, <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a> u, <a href="../Reflection_Models/Dielectric_BSDF.html#TransportMode" class="code">TransportMode</a> mode,
           BxDFReflTransFlags sampleFlags = BxDFReflTransFlags::All) const {
           return <a href="#TopOrBottomBxDF::top" class="code">top</a> ? <a href="#TopOrBottomBxDF::top" class="code">top</a>-&gt;Sample_f(wo, uc, u, mode, sampleFlags)
                      : <a href="#TopOrBottomBxDF::bottom" class="code">bottom</a>-&gt;Sample_f(wo, uc, u, mode, sampleFlags);
       }
       
       PBRT_CPU_GPU
       Float PDF(<a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> wo, <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> wi, <a href="../Reflection_Models/Dielectric_BSDF.html#TransportMode" class="code">TransportMode</a> mode,
                 BxDFReflTransFlags sampleFlags = BxDFReflTransFlags::All) const {
           return <a href="#TopOrBottomBxDF::top" class="code">top</a> ? <a href="#TopOrBottomBxDF::top" class="code">top</a>-&gt;PDF(wo, wi, mode, sampleFlags)
                      : <a href="#TopOrBottomBxDF::bottom" class="code">bottom</a>-&gt;PDF(wo, wi, mode, sampleFlags);
       }
       
       PBRT_CPU_GPU
       <a href="../Reflection_Models/BSDF_Representation.html#BxDFFlags" class="code">BxDFFlags</a> Flags() const { return <a href="#TopOrBottomBxDF::top" class="code">top</a> ? <a href="#TopOrBottomBxDF::top" class="code">top</a>-&gt;Flags() : <a href="#TopOrBottomBxDF::bottom" class="code">bottom</a>-&gt;Flags(); }</div></div>
  private:
    const TopBxDF *<span class="anchor" id="TopOrBottomBxDF::top"></span>top = nullptr;
    const BottomBxDF *<span class="anchor" id="TopOrBottomBxDF::bottom"></span>bottom = nullptr;
};</div><p>


</p>
<p>

</p>
<p><tt>TopOrBottomBxDF</tt> provides the implementation of a number of
<tt>BxDF</tt> methods like <tt>f()</tt>, where it calls the corresponding
method of whichever of the two <tt>BxDF</tt> types has been provided.  In
addition to <tt>f()</tt>, it has similar straightforward
<tt>Sample_f()</tt><span class="anchor" id="TopOrBottomBxDF::Sample_f"></span>,
<tt>PDF()</tt><span class="anchor" id="TopOrBottomBxDF::PDF"></span>, and
<tt>Flags()</tt><span class="anchor" id="TopOrBottomBxDF::Flags"></span> methods, which we will not
include here.

</p>
<p></p>
<span class="anchor" id="fragment-TopOrBottomBxDFPublicMethods-0"></span><div class="fragmentname">&lt;&lt;TopOrBottomBxDF Public Methods&gt;&gt;=&nbsp;</div>
<div class="fragmentcode"><a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> <span class="anchor" id="TopOrBottomBxDF::f"></span><a href="../Reflection_Models/BSDF_Representation.html#BxDF::f" class="code">f</a>(<a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> wo, <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> wi, <a href="../Reflection_Models/Dielectric_BSDF.html#TransportMode" class="code">TransportMode</a> mode) const {
    return <a href="#TopOrBottomBxDF::top" class="code">top</a> ? <a href="#TopOrBottomBxDF::top" class="code">top</a>-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BxDF::f" class="code">f</a>(wo, wi, mode) : <a href="#TopOrBottomBxDF::bottom" class="code">bottom</a>-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BxDF::f" class="code">f</a>(wo, wi, mode);
}</div><p>


</p>
<p>

</p>
<p>

</p>
<p></p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">
<a href="#x2-BSDFEvaluation"><i class="fas fa-link h3h4marginlink"></i></a>
</div>
<div class="col-md-10 col-lg-8">
<span id="x2-BSDFEvaluation"></span><h4>BSDF Evaluation</h4><p>


</p>
<p>The BSDF evaluation method <tt>f()</tt> can now be implemented; it returns an
average of the specified number of independent samples.

</p>
<p></p>
<span class="anchor" id="fragment-LayeredBxDFPublicMethods-0"></span><div class="fragmentname">&lt;&lt;LayeredBxDF Public Methods&gt;&gt;=&nbsp;<a href="#fragment-LayeredBxDFPublicMethods-1"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode"><a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> <span class="anchor" id="LayeredBxDF::f"></span>f(<a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> wo, <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> wi, <a href="../Reflection_Models/Dielectric_BSDF.html#TransportMode" class="code">TransportMode</a> mode) const {
    <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> f(0.);
    &lt;&lt;<span class="fragmentname"><a href="#fragment-EstimatemonoLayeredBxDFvaluemonofusingrandomsampling-0">Estimate <tt>LayeredBxDF</tt> value <tt>f</tt> using random sampling</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2279" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2279"><i></i></a><div id="fragbit-2279" class="collapse show"><div class="fragmentcode">       &lt;&lt;<span class="fragmentname"><a href="#fragment-SetmonowoandmonowiforlayeredBSDFevaluation-0">Set <tt>wo</tt> and <tt>wi</tt> for layered BSDF evaluation</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2280" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2280"><i></i></a><div id="fragbit-2280" class="collapse show"><div class="fragmentcode">          if (<a href="#LayeredBxDF::twoSided" class="code">twoSided</a> &amp;&amp; wo.z &lt; 0) {
              wo = -wo;
              wi = -wi;
          }</div></div>
       &lt;&lt;<span class="fragmentname"><a href="#fragment-DetermineentranceinterfaceforlayeredBSDF-0">Determine entrance interface for layered BSDF</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2281" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2281"><i></i></a><div id="fragbit-2281" class="collapse show"><div class="fragmentcode">          TopOrBottomBxDF&lt;TopBxDF, BottomBxDF&gt; enterInterface;
          bool enteredTop = twoSided || wo.z &gt; 0;
          if (enteredTop) enterInterface = &amp;<a href="#LayeredBxDF::top" class="code">top</a>;
          else            enterInterface = &amp;<a href="#LayeredBxDF::bottom" class="code">bottom</a>;</div></div>
       &lt;&lt;<span class="fragmentname"><a href="#fragment-DetermineexitinterfaceandexitzforlayeredBSDF-0">Determine exit interface and exit <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.086ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 467.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">z</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D467" d="M467 432c0 -4 -22 -52 -117 -145c-36 -36 -98 -90 -98 -90c-36 -31 -65 -56 -119 -114c9 3 27 3 27 3c21 0 36 -4 70 -17c21 -7 39 -13 59 -13c33 0 97 19 120 84c3 7 5 13 14 13c8 0 12 -5 12 -10c0 -27 -58 -154 -157 -154c-29 0 -47 16 -64 37c-25 29 -35 38 -58 38 c-32 0 -62 -27 -85 -62c-6 -11 -8 -13 -16 -13c0 0 -12 0 -12 10c0 7 35 64 103 131l90 84c19 16 103 88 139 131c-26 0 -37 0 -77 15c-23 8 -42 15 -63 15c-8 0 -66 -1 -85 -47c-2 -6 -4 -11 -13 -11s-12 6 -12 11c0 21 46 114 121 114c33 0 50 -20 69 -43 c15 -17 27 -32 51 -32s45 16 75 64c5 9 8 11 15 11c0 0 11 0 11 -10Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D467" x="0" y="0"></use>
</g>
</svg> for layered BSDF</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2282" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2282"><i></i></a><div id="fragbit-2282" class="collapse show"><div class="fragmentcode">          TopOrBottomBxDF&lt;TopBxDF, BottomBxDF&gt; exitInterface, nonExitInterface;
          if (<a href="../Reflection_Models/BSDF_Representation.html#SameHemisphere" class="code">SameHemisphere</a>(wo, wi) ^ enteredTop) {
              exitInterface = &amp;bottom;
              nonExitInterface = &amp;top;
          } else {
              exitInterface = &amp;top;
              nonExitInterface = &amp;bottom;
          }
          Float exitZ = (<a href="../Reflection_Models/BSDF_Representation.html#SameHemisphere" class="code">SameHemisphere</a>(wo, wi) ^ enteredTop) ? 0 : <a href="#LayeredBxDF::thickness" class="code">thickness</a>;</div></div>
       &lt;&lt;<span class="fragmentname"><a href="#fragment-Accountforreflectionattheentranceinterface-0">Account for reflection at the entrance interface</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2283" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2283"><i></i></a><div id="fragbit-2283" class="collapse show"><div class="fragmentcode">          if (<a href="../Reflection_Models/BSDF_Representation.html#SameHemisphere" class="code">SameHemisphere</a>(wo, wi))
              <a href="../Reflection_Models/BSDF_Representation.html#BxDF::f" class="code">f</a> = <a href="#LayeredBxDF::nSamples" class="code">nSamples</a> * enterInterface.<a href="../Reflection_Models/BSDF_Representation.html#BxDF::f" class="code">f</a>(wo, wi, mode);</div></div>
       &lt;&lt;<span class="fragmentname"><a href="#fragment-DeclaremonoRNGforlayeredBSDFevaluation-0">Declare <tt>RNG</tt> for layered BSDF evaluation</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2284" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2284"><i></i></a><div id="fragbit-2284" class="collapse show"><div class="fragmentcode">          <a href="../Utilities/Mathematical_Infrastructure.html#RNG" class="code">RNG</a> rng(<a href="../Utilities/Mathematical_Infrastructure.html#Hash" class="code">Hash</a>(<a href="../Utilities/System_Startup,_Cleanup,_and_Options.html#GetOptions" class="code">GetOptions</a>().<a href="../Utilities/System_Startup,_Cleanup,_and_Options.html#BasicPBRTOptions::seed" class="code">seed</a>, wo), <a href="../Utilities/Mathematical_Infrastructure.html#Hash" class="code">Hash</a>(wi));
          auto r = [&amp;rng]() { return std::min&lt;Float&gt;(rng.<a href="../Utilities/Mathematical_Infrastructure.html#RNG::UniformFloat" class="code">Uniform</a>&lt;Float&gt;(),
                                                     <a href="../Sampling_and_Reconstruction/Sampling_Interface.html#OneMinusEpsilon" class="code">OneMinusEpsilon</a>); };</div></div>
       for (int s = 0; s &lt; <a href="#LayeredBxDF::nSamples" class="code">nSamples</a>; ++s) {
           &lt;&lt;<span class="fragmentname"><a href="#fragment-SamplerandomwalkthroughlayerstoestimateBSDFvalue-0">Sample random walk through layers to estimate BSDF value</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2285" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2285"><i></i></a><div id="fragbit-2285" class="collapse show"><div class="fragmentcode">              &lt;&lt;<span class="fragmentname"><a href="#fragment-Sampletransmissiondirectionthroughentranceinterface-0">Sample transmission direction through entrance interface</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2286" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2286"><i></i></a><div id="fragbit-2286" class="collapse show"><div class="fragmentcode">                 Float uc = r();
                 pstd::optional&lt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample" class="code">BSDFSample</a>&gt; wos =
                     enterInterface.<a href="../Reflection_Models/BSDF_Representation.html#BxDF::Sample_f" class="code">Sample_f</a>(wo, uc, <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(r(), r()), mode,
                                             <a href="../Reflection_Models/BSDF_Representation.html#BxDFReflTransFlags::Transmission" class="code">BxDFReflTransFlags</a>::Transmission);
                 if (!wos || !wos-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::f" class="code">f</a> || wos-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::pdf" class="code">pdf</a> == 0 || wos-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>.z == 0)
                     continue;</div></div>
              &lt;&lt;<span class="fragmentname"><a href="#fragment-SampleBSDFforvirtuallightfrommonowi-0">Sample BSDF for virtual light from <tt>wi</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2287" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2287"><i></i></a><div id="fragbit-2287" class="collapse show"><div class="fragmentcode">                 uc = r();
                 pstd::optional&lt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample" class="code">BSDFSample</a>&gt; wis =
                     exitInterface.<a href="../Reflection_Models/BSDF_Representation.html#BxDF::Sample_f" class="code">Sample_f</a>(<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>, uc, <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(r(), r()), !mode,
                                            <a href="../Reflection_Models/BSDF_Representation.html#BxDFReflTransFlags::Transmission" class="code">BxDFReflTransFlags</a>::Transmission);
                 if (!wis || !wis-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::f" class="code">f</a> || wis-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::pdf" class="code">pdf</a> == 0 || wis-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>.z == 0)
                     continue;</div></div>
              &lt;&lt;<span class="fragmentname"><a href="#fragment-DeclarestateforrandomwalkthroughBSDFlayers-0">Declare state for random walk through BSDF layers</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2288" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2288"><i></i></a><div id="fragbit-2288" class="collapse show"><div class="fragmentcode">                 <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> beta = wos-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::f" class="code">f</a> * <a href="../Geometry_and_Transformations/Spherical_Geometry.html#AbsCosTheta" class="code">AbsCosTheta</a>(wos-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>) / wos-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::pdf" class="code">pdf</a>;
                 Float z = enteredTop ? <a href="#LayeredBxDF::thickness" class="code">thickness</a> : 0;
                 <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> w = wos-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>;
                 <a href="../Volume_Scattering/Phase_Functions.html#HGPhaseFunction" class="code">HGPhaseFunction</a> phase(g);</div></div>
              for (int depth = 0; depth &lt; <a href="#LayeredBxDF::maxDepth" class="code">maxDepth</a>; ++depth) {
                  &lt;&lt;<span class="fragmentname"><a href="#fragment-SamplenexteventforlayeredBSDFevaluationrandomwalk-0">Sample next event for layered BSDF evaluation random walk</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2289" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2289"><i></i></a><div id="fragbit-2289" class="collapse show"><div class="fragmentcode">                     &lt;&lt;<span class="fragmentname"><a href="#fragment-PossiblyterminatelayeredBSDFrandomwalkwithRussianroulette-0">Possibly terminate layered BSDF random walk with Russian roulette</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2290" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2290"><i></i></a><div id="fragbit-2290" class="collapse show"><div class="fragmentcode">                        if (depth &gt; 3 &amp;&amp; beta.<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum::MaxComponentValue" class="code">MaxComponentValue</a>() &lt; 0.25f) {
                            Float q = std::max&lt;Float&gt;(0, 1 - beta.<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum::MaxComponentValue" class="code">MaxComponentValue</a>());
                            if (r() &lt; q) break;
                            beta /= 1 - q;
                        }</div></div>
                     &lt;&lt;<span class="fragmentname"><a href="#fragment-Accountformediabetweenlayersandpossiblyscatter-0">Account for media between layers and possibly scatter</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2291" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2291"><i></i></a><div id="fragbit-2291" class="collapse show"><div class="fragmentcode">                        if (!<a href="#LayeredBxDF::albedo" class="code">albedo</a>) {
                            &lt;&lt;<span class="fragmentname"><a href="#fragment-Advancetonextlayerboundaryandupdatemonobetafortransmittance-0">Advance to next layer boundary and update <tt>beta</tt> for transmittance</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2292" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2292"><i></i></a><div id="fragbit-2292" class="collapse show"><div class="fragmentcode">                               z = (z == <a href="#LayeredBxDF::thickness" class="code">thickness</a>) ? 0 : <a href="#LayeredBxDF::thickness" class="code">thickness</a>;
                               beta *= <a href="#LayeredBxDF::Tr" class="code">Tr</a>(<a href="#LayeredBxDF::thickness" class="code">thickness</a>, w);</div></div>
                        } else {
                            &lt;&lt;<span class="fragmentname"><a href="#fragment-SamplemediumscatteringforlayeredBSDFevaluation-0">Sample medium scattering for layered BSDF evaluation</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2293" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2293"><i></i></a><div id="fragbit-2293" class="collapse show"><div class="fragmentcode">                               Float sigma_t = 1;
                               Float dz = <a href="../Sampling_Algorithms/Sampling_1D_Functions.html#SampleExponential" class="code">SampleExponential</a>(r(), sigma_t / std::abs(w.z));
                               Float zp = w.z &gt; 0 ? (z + dz) : (z - dz);
                               if (0 &lt; zp &amp;&amp; zp &lt; <a href="#LayeredBxDF::thickness" class="code">thickness</a>) {
                                   &lt;&lt;<span class="fragmentname"><a href="#fragment-HandlescatteringeventinlayeredBSDFmedium-0">Handle scattering event in layered BSDF medium</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2294" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2294"><i></i></a><div id="fragbit-2294" class="collapse show"><div class="fragmentcode">                                      &lt;&lt;<span class="fragmentname"><a href="#fragment-AccountforscatteringthroughmonoexitInterfaceusingmonowis-0">Account for scattering through <tt>exitInterface</tt> using <tt>wis</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2295" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2295"><i></i></a><div id="fragbit-2295" class="collapse show"><div class="fragmentcode">                                         Float wt = 1;
                                         if (!<a href="../Reflection_Models/BSDF_Representation.html#BxDFFlags::IsSpecular" class="code">IsSpecular</a>(exitInterface.<a href="../Reflection_Models/BSDF_Representation.html#BxDF::Flags" class="code">Flags</a>()))
                                             wt = <a href="../Monte_Carlo_Integration/Improving_Efficiency.html#PowerHeuristic" class="code">PowerHeuristic</a>(1, wis-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::pdf" class="code">pdf</a>, 1, phase.<a href="../Volume_Scattering/Phase_Functions.html#HGPhaseFunction::PDF" class="code">PDF</a>(-w, -wis-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>));
                                         <a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::f" class="code">f</a> += beta * <a href="#LayeredBxDF::albedo" class="code">albedo</a> * phase.<a href="../Volume_Scattering/Phase_Functions.html#HGPhaseFunction::p" class="code">p</a>(-w, -wis-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>) * wt * <a href="#LayeredBxDF::Tr" class="code">Tr</a>(zp - exitZ, wis-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>) *
                                              wis-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::f" class="code">f</a> / wis-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::pdf" class="code">pdf</a>;</div></div>
                                      &lt;&lt;<span class="fragmentname"><a href="#fragment-Samplephasefunctionandupdatelayeredpathstate-0">Sample phase function and update layered path state</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2296" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2296"><i></i></a><div id="fragbit-2296" class="collapse show"><div class="fragmentcode">                                         <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a> u{r(), r()};
                                         pstd::optional&lt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample" class="code">PhaseFunctionSample</a>&gt; ps = phase.<a href="../Volume_Scattering/Phase_Functions.html#HGPhaseFunction::Sample_p" class="code">Sample_p</a>(-w, u);
                                         if (!ps || ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::pdf" class="code">pdf</a> == 0 || ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::wi" class="code">wi</a>.z == 0)
                                             continue;
                                         beta *= <a href="#LayeredBxDF::albedo" class="code">albedo</a> * ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::p" class="code">p</a> / ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::pdf" class="code">pdf</a>;
                                         w = ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::wi" class="code">wi</a>;
                                         z = zp;</div></div>
                                      &lt;&lt;<span class="fragmentname"><a href="#fragment-PossiblyaccountforscatteringthroughmonoexitInterface-0">Possibly account for scattering through <tt>exitInterface</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2297" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2297"><i></i></a><div id="fragbit-2297" class="collapse show"><div class="fragmentcode">                                         if (((z &lt; exitZ &amp;&amp; w.z &gt; 0) || (z &gt; exitZ &amp;&amp; w.z &lt; 0)) &amp;&amp; 
                                              !<a href="../Reflection_Models/BSDF_Representation.html#BxDFFlags::IsSpecular" class="code">IsSpecular</a>(exitInterface.<a href="../Reflection_Models/BSDF_Representation.html#BxDF::Flags" class="code">Flags</a>())) {
                                             &lt;&lt;<span class="fragmentname"><a href="#fragment-AccountforscatteringthroughmonoexitInterface-0">Account for scattering through <tt>exitInterface</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2298" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2298"><i></i></a><div id="fragbit-2298" class="collapse show"><div class="fragmentcode">                                                <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> fExit = exitInterface.<a href="../Reflection_Models/BSDF_Representation.html#BxDF::f" class="code">f</a>(-w, <a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::wi" class="code">wi</a>, mode);
                                                if (fExit) {
                                                    Float exitPDF =
                                                        exitInterface.<a href="../Reflection_Models/BSDF_Representation.html#BxDF::PDF" class="code">PDF</a>(-w, <a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::wi" class="code">wi</a>, mode, BxDFReflTransFlags::Transmission);
                                                    Float wt = <a href="../Monte_Carlo_Integration/Improving_Efficiency.html#PowerHeuristic" class="code">PowerHeuristic</a>(1, ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::pdf" class="code">pdf</a>, 1, exitPDF);
                                                    <a href="../Reflection_Models/BSDF_Representation.html#BxDF::f" class="code">f</a> += beta * <a href="#LayeredBxDF::Tr" class="code">Tr</a>(zp - exitZ, ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::wi" class="code">wi</a>) * fExit * wt;
                                                }</div></div>
                                         }</div></div></div></div>
                                   continue;
                               }
                               z = <a href="../Utilities/Mathematical_Infrastructure.html#Clamp" class="code">Clamp</a>(zp, 0, <a href="#LayeredBxDF::thickness" class="code">thickness</a>);</div></div> 
                        }</div></div>
                     &lt;&lt;<span class="fragmentname"><a href="#fragment-Accountforscatteringatappropriateinterface-0">Account for scattering at appropriate interface</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2299" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2299"><i></i></a><div id="fragbit-2299" class="collapse show"><div class="fragmentcode">                        if (z == exitZ) {
                            &lt;&lt;<span class="fragmentname"><a href="#fragment-AccountforreflectionatmonoexitInterface-0">Account for reflection at <tt>exitInterface</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2300" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2300"><i></i></a><div id="fragbit-2300" class="collapse show"><div class="fragmentcode">                               Float uc = r();
                               pstd::optional&lt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample" class="code">BSDFSample</a>&gt; bs = exitInterface.<a href="../Reflection_Models/BSDF_Representation.html#BxDF::Sample_f" class="code">Sample_f</a>(
                                   -w, uc, <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(r(), r()), mode, <a href="../Reflection_Models/BSDF_Representation.html#BxDFReflTransFlags::Reflection" class="code">BxDFReflTransFlags</a>::Reflection);
                               if (!bs || !bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::f" class="code">f</a> || bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::pdf" class="code">pdf</a> == 0 || bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>.z == 0)
                                   break;
                               beta *= bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::f" class="code">f</a> * <a href="../Geometry_and_Transformations/Spherical_Geometry.html#AbsCosTheta" class="code">AbsCosTheta</a>(bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>) / bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::pdf" class="code">pdf</a>;
                               w = bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>;</div></div>
                        } else {
                            &lt;&lt;<span class="fragmentname">Account for scattering at <tt>nonExitInterface</tt></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2301" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2301"><i></i></a><div id="fragbit-2301" class="collapse show"><div class="fragmentcode">                               if (!IsSpecular(nonExitInterface.Flags())) {
                                   &lt;&lt;<span class="fragmentname">Add NEE contribution along presampled <tt>wis</tt> direction</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2302" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2302"><i></i></a><div id="fragbit-2302" class="collapse show"><div class="fragmentcode">                                      Float wt = 1;
                                      if (!IsSpecular(exitInterface.Flags()))
                                          wt = PowerHeuristic(1, wis-&gt;pdf,
                                                              1, nonExitInterface.PDF(-w, -wis-&gt;wi, mode));
                                      f += beta * nonExitInterface.f(-w, -wis-&gt;wi, mode) *
                                           AbsCosTheta(wis-&gt;wi) * wt * Tr(thickness, wis-&gt;wi) * wis-&gt;f / wis-&gt;pdf;</div></div>
                               }
                               &lt;&lt;<span class="fragmentname">Sample new direction using BSDF at <tt>nonExitInterface</tt></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2303" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2303"><i></i></a><div id="fragbit-2303" class="collapse show"><div class="fragmentcode">                                  Float uc = r();
                                  <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a> u(r(), r());
                                  pstd::optional&lt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample" class="code">BSDFSample</a>&gt; bs = nonExitInterface.Sample_f(
                                      -w, uc, u, mode, BxDFReflTransFlags::Reflection);
                                  if (!bs || !bs-&gt;f || bs-&gt;pdf == 0 || bs-&gt;wi.z == 0)
                                      break;
                                  beta *= bs-&gt;f * AbsCosTheta(bs-&gt;wi) / bs-&gt;pdf;
                                  w = bs-&gt;wi;</div></div>
                               if (!IsSpecular(exitInterface.Flags())) {
                                   &lt;&lt;<span class="fragmentname">Add NEE contribution along direction from BSDF sample</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2304" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2304"><i></i></a><div id="fragbit-2304" class="collapse show"><div class="fragmentcode">                                      <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> fExit = exitInterface.f(-w, wi, mode);
                                      if (fExit) {
                                          Float wt = 1;
                                          if (!IsSpecular(nonExitInterface.Flags())) {
                                              Float exitPDF = exitInterface.PDF(
                                                  -w, wi, mode, BxDFReflTransFlags::Transmission);
                                              wt = PowerHeuristic(1, bs-&gt;pdf, 1, exitPDF);
                                          }
                                          f += beta * Tr(thickness, bs-&gt;wi) * fExit * wt;
                                      }</div></div>
                               }</div></div>
                        }</div></div></div></div> 
              }</div></div>
       }</div></div>
    return f / <a href="#LayeredBxDF::nSamples" class="code">nSamples</a>;
}</div><p>


</p>
<p>There is some preliminary computation that is independent of each sample
taken to estimate the BSDF&rsquo;s value.  A few fragments take care of it before the
random estimation begins.

</p>
<p></p>
<span class="anchor" id="fragment-EstimatemonoLayeredBxDFvaluemonofusingrandomsampling-0"></span><div class="fragmentname">&lt;&lt;Estimate <tt>LayeredBxDF</tt> value <tt>f</tt> using random sampling&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">&lt;&lt;<span class="fragmentname"><a href="#fragment-SetmonowoandmonowiforlayeredBSDFevaluation-0">Set <tt>wo</tt> and <tt>wi</tt> for layered BSDF evaluation</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2305" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2305"><i></i></a><div id="fragbit-2305" class="collapse show"><div class="fragmentcode">   if (<a href="#LayeredBxDF::twoSided" class="code">twoSided</a> &amp;&amp; wo.z &lt; 0) {
       wo = -wo;
       wi = -wi;
   }</div></div>
&lt;&lt;<span class="fragmentname"><a href="#fragment-DetermineentranceinterfaceforlayeredBSDF-0">Determine entrance interface for layered BSDF</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2306" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2306"><i></i></a><div id="fragbit-2306" class="collapse show"><div class="fragmentcode">   TopOrBottomBxDF&lt;TopBxDF, BottomBxDF&gt; enterInterface;
   bool enteredTop = twoSided || wo.z &gt; 0;
   if (enteredTop) enterInterface = &amp;<a href="#LayeredBxDF::top" class="code">top</a>;
   else            enterInterface = &amp;<a href="#LayeredBxDF::bottom" class="code">bottom</a>;</div></div>
&lt;&lt;<span class="fragmentname"><a href="#fragment-DetermineexitinterfaceandexitzforlayeredBSDF-0">Determine exit interface and exit <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.086ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 467.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">z</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D467" d="M467 432c0 -4 -22 -52 -117 -145c-36 -36 -98 -90 -98 -90c-36 -31 -65 -56 -119 -114c9 3 27 3 27 3c21 0 36 -4 70 -17c21 -7 39 -13 59 -13c33 0 97 19 120 84c3 7 5 13 14 13c8 0 12 -5 12 -10c0 -27 -58 -154 -157 -154c-29 0 -47 16 -64 37c-25 29 -35 38 -58 38 c-32 0 -62 -27 -85 -62c-6 -11 -8 -13 -16 -13c0 0 -12 0 -12 10c0 7 35 64 103 131l90 84c19 16 103 88 139 131c-26 0 -37 0 -77 15c-23 8 -42 15 -63 15c-8 0 -66 -1 -85 -47c-2 -6 -4 -11 -13 -11s-12 6 -12 11c0 21 46 114 121 114c33 0 50 -20 69 -43 c15 -17 27 -32 51 -32s45 16 75 64c5 9 8 11 15 11c0 0 11 0 11 -10Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D467" x="0" y="0"></use>
</g>
</svg> for layered BSDF</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2307" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2307"><i></i></a><div id="fragbit-2307" class="collapse show"><div class="fragmentcode">   TopOrBottomBxDF&lt;TopBxDF, BottomBxDF&gt; exitInterface, nonExitInterface;
   if (<a href="../Reflection_Models/BSDF_Representation.html#SameHemisphere" class="code">SameHemisphere</a>(wo, wi) ^ enteredTop) {
       exitInterface = &amp;bottom;
       nonExitInterface = &amp;top;
   } else {
       exitInterface = &amp;top;
       nonExitInterface = &amp;bottom;
   }
   Float exitZ = (<a href="../Reflection_Models/BSDF_Representation.html#SameHemisphere" class="code">SameHemisphere</a>(wo, wi) ^ enteredTop) ? 0 : <a href="#LayeredBxDF::thickness" class="code">thickness</a>;</div></div>
&lt;&lt;<span class="fragmentname"><a href="#fragment-Accountforreflectionattheentranceinterface-0">Account for reflection at the entrance interface</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2308" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2308"><i></i></a><div id="fragbit-2308" class="collapse show"><div class="fragmentcode">   if (<a href="../Reflection_Models/BSDF_Representation.html#SameHemisphere" class="code">SameHemisphere</a>(wo, wi))
       <a href="../Reflection_Models/BSDF_Representation.html#BxDF::f" class="code">f</a> = <a href="#LayeredBxDF::nSamples" class="code">nSamples</a> * enterInterface.<a href="../Reflection_Models/BSDF_Representation.html#BxDF::f" class="code">f</a>(wo, wi, mode);</div></div>
&lt;&lt;<span class="fragmentname"><a href="#fragment-DeclaremonoRNGforlayeredBSDFevaluation-0">Declare <tt>RNG</tt> for layered BSDF evaluation</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2309" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2309"><i></i></a><div id="fragbit-2309" class="collapse show"><div class="fragmentcode">   <a href="../Utilities/Mathematical_Infrastructure.html#RNG" class="code">RNG</a> rng(<a href="../Utilities/Mathematical_Infrastructure.html#Hash" class="code">Hash</a>(<a href="../Utilities/System_Startup,_Cleanup,_and_Options.html#GetOptions" class="code">GetOptions</a>().<a href="../Utilities/System_Startup,_Cleanup,_and_Options.html#BasicPBRTOptions::seed" class="code">seed</a>, wo), <a href="../Utilities/Mathematical_Infrastructure.html#Hash" class="code">Hash</a>(wi));
   auto r = [&amp;rng]() { return std::min&lt;Float&gt;(rng.<a href="../Utilities/Mathematical_Infrastructure.html#RNG::UniformFloat" class="code">Uniform</a>&lt;Float&gt;(),
                                              <a href="../Sampling_and_Reconstruction/Sampling_Interface.html#OneMinusEpsilon" class="code">OneMinusEpsilon</a>); };</div></div>
for (int s = 0; s &lt; <a href="#LayeredBxDF::nSamples" class="code">nSamples</a>; ++s) {
    &lt;&lt;<span class="fragmentname"><a href="#fragment-SamplerandomwalkthroughlayerstoestimateBSDFvalue-0">Sample random walk through layers to estimate BSDF value</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2310" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2310"><i></i></a><div id="fragbit-2310" class="collapse show"><div class="fragmentcode">       &lt;&lt;<span class="fragmentname"><a href="#fragment-Sampletransmissiondirectionthroughentranceinterface-0">Sample transmission direction through entrance interface</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2311" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2311"><i></i></a><div id="fragbit-2311" class="collapse show"><div class="fragmentcode">          Float uc = r();
          pstd::optional&lt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample" class="code">BSDFSample</a>&gt; wos =
              enterInterface.<a href="../Reflection_Models/BSDF_Representation.html#BxDF::Sample_f" class="code">Sample_f</a>(wo, uc, <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(r(), r()), mode,
                                      <a href="../Reflection_Models/BSDF_Representation.html#BxDFReflTransFlags::Transmission" class="code">BxDFReflTransFlags</a>::Transmission);
          if (!wos || !wos-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::f" class="code">f</a> || wos-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::pdf" class="code">pdf</a> == 0 || wos-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>.z == 0)
              continue;</div></div>
       &lt;&lt;<span class="fragmentname"><a href="#fragment-SampleBSDFforvirtuallightfrommonowi-0">Sample BSDF for virtual light from <tt>wi</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2312" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2312"><i></i></a><div id="fragbit-2312" class="collapse show"><div class="fragmentcode">          uc = r();
          pstd::optional&lt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample" class="code">BSDFSample</a>&gt; wis =
              exitInterface.<a href="../Reflection_Models/BSDF_Representation.html#BxDF::Sample_f" class="code">Sample_f</a>(<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>, uc, <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(r(), r()), !mode,
                                     <a href="../Reflection_Models/BSDF_Representation.html#BxDFReflTransFlags::Transmission" class="code">BxDFReflTransFlags</a>::Transmission);
          if (!wis || !wis-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::f" class="code">f</a> || wis-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::pdf" class="code">pdf</a> == 0 || wis-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>.z == 0)
              continue;</div></div>
       &lt;&lt;<span class="fragmentname"><a href="#fragment-DeclarestateforrandomwalkthroughBSDFlayers-0">Declare state for random walk through BSDF layers</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2313" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2313"><i></i></a><div id="fragbit-2313" class="collapse show"><div class="fragmentcode">          <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> beta = wos-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::f" class="code">f</a> * <a href="../Geometry_and_Transformations/Spherical_Geometry.html#AbsCosTheta" class="code">AbsCosTheta</a>(wos-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>) / wos-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::pdf" class="code">pdf</a>;
          Float z = enteredTop ? <a href="#LayeredBxDF::thickness" class="code">thickness</a> : 0;
          <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> w = wos-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>;
          <a href="../Volume_Scattering/Phase_Functions.html#HGPhaseFunction" class="code">HGPhaseFunction</a> phase(g);</div></div>
       for (int depth = 0; depth &lt; <a href="#LayeredBxDF::maxDepth" class="code">maxDepth</a>; ++depth) {
           &lt;&lt;<span class="fragmentname"><a href="#fragment-SamplenexteventforlayeredBSDFevaluationrandomwalk-0">Sample next event for layered BSDF evaluation random walk</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2314" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2314"><i></i></a><div id="fragbit-2314" class="collapse show"><div class="fragmentcode">              &lt;&lt;<span class="fragmentname"><a href="#fragment-PossiblyterminatelayeredBSDFrandomwalkwithRussianroulette-0">Possibly terminate layered BSDF random walk with Russian roulette</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2315" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2315"><i></i></a><div id="fragbit-2315" class="collapse show"><div class="fragmentcode">                 if (depth &gt; 3 &amp;&amp; beta.<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum::MaxComponentValue" class="code">MaxComponentValue</a>() &lt; 0.25f) {
                     Float q = std::max&lt;Float&gt;(0, 1 - beta.<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum::MaxComponentValue" class="code">MaxComponentValue</a>());
                     if (r() &lt; q) break;
                     beta /= 1 - q;
                 }</div></div>
              &lt;&lt;<span class="fragmentname"><a href="#fragment-Accountformediabetweenlayersandpossiblyscatter-0">Account for media between layers and possibly scatter</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2316" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2316"><i></i></a><div id="fragbit-2316" class="collapse show"><div class="fragmentcode">                 if (!<a href="#LayeredBxDF::albedo" class="code">albedo</a>) {
                     &lt;&lt;<span class="fragmentname"><a href="#fragment-Advancetonextlayerboundaryandupdatemonobetafortransmittance-0">Advance to next layer boundary and update <tt>beta</tt> for transmittance</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2317" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2317"><i></i></a><div id="fragbit-2317" class="collapse show"><div class="fragmentcode">                        z = (z == <a href="#LayeredBxDF::thickness" class="code">thickness</a>) ? 0 : <a href="#LayeredBxDF::thickness" class="code">thickness</a>;
                        beta *= <a href="#LayeredBxDF::Tr" class="code">Tr</a>(<a href="#LayeredBxDF::thickness" class="code">thickness</a>, w);</div></div>
                 } else {
                     &lt;&lt;<span class="fragmentname"><a href="#fragment-SamplemediumscatteringforlayeredBSDFevaluation-0">Sample medium scattering for layered BSDF evaluation</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2318" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2318"><i></i></a><div id="fragbit-2318" class="collapse show"><div class="fragmentcode">                        Float sigma_t = 1;
                        Float dz = <a href="../Sampling_Algorithms/Sampling_1D_Functions.html#SampleExponential" class="code">SampleExponential</a>(r(), sigma_t / std::abs(w.z));
                        Float zp = w.z &gt; 0 ? (z + dz) : (z - dz);
                        if (0 &lt; zp &amp;&amp; zp &lt; <a href="#LayeredBxDF::thickness" class="code">thickness</a>) {
                            &lt;&lt;<span class="fragmentname"><a href="#fragment-HandlescatteringeventinlayeredBSDFmedium-0">Handle scattering event in layered BSDF medium</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2319" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2319"><i></i></a><div id="fragbit-2319" class="collapse show"><div class="fragmentcode">                               &lt;&lt;<span class="fragmentname"><a href="#fragment-AccountforscatteringthroughmonoexitInterfaceusingmonowis-0">Account for scattering through <tt>exitInterface</tt> using <tt>wis</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2320" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2320"><i></i></a><div id="fragbit-2320" class="collapse show"><div class="fragmentcode">                                  Float wt = 1;
                                  if (!<a href="../Reflection_Models/BSDF_Representation.html#BxDFFlags::IsSpecular" class="code">IsSpecular</a>(exitInterface.<a href="../Reflection_Models/BSDF_Representation.html#BxDF::Flags" class="code">Flags</a>()))
                                      wt = <a href="../Monte_Carlo_Integration/Improving_Efficiency.html#PowerHeuristic" class="code">PowerHeuristic</a>(1, wis-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::pdf" class="code">pdf</a>, 1, phase.<a href="../Volume_Scattering/Phase_Functions.html#HGPhaseFunction::PDF" class="code">PDF</a>(-w, -wis-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>));
                                  <a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::f" class="code">f</a> += beta * <a href="#LayeredBxDF::albedo" class="code">albedo</a> * phase.<a href="../Volume_Scattering/Phase_Functions.html#HGPhaseFunction::p" class="code">p</a>(-w, -wis-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>) * wt * <a href="#LayeredBxDF::Tr" class="code">Tr</a>(zp - exitZ, wis-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>) *
                                       wis-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::f" class="code">f</a> / wis-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::pdf" class="code">pdf</a>;</div></div>
                               &lt;&lt;<span class="fragmentname"><a href="#fragment-Samplephasefunctionandupdatelayeredpathstate-0">Sample phase function and update layered path state</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2321" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2321"><i></i></a><div id="fragbit-2321" class="collapse show"><div class="fragmentcode">                                  <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a> u{r(), r()};
                                  pstd::optional&lt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample" class="code">PhaseFunctionSample</a>&gt; ps = phase.<a href="../Volume_Scattering/Phase_Functions.html#HGPhaseFunction::Sample_p" class="code">Sample_p</a>(-w, u);
                                  if (!ps || ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::pdf" class="code">pdf</a> == 0 || ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::wi" class="code">wi</a>.z == 0)
                                      continue;
                                  beta *= <a href="#LayeredBxDF::albedo" class="code">albedo</a> * ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::p" class="code">p</a> / ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::pdf" class="code">pdf</a>;
                                  w = ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::wi" class="code">wi</a>;
                                  z = zp;</div></div>
                               &lt;&lt;<span class="fragmentname"><a href="#fragment-PossiblyaccountforscatteringthroughmonoexitInterface-0">Possibly account for scattering through <tt>exitInterface</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2322" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2322"><i></i></a><div id="fragbit-2322" class="collapse show"><div class="fragmentcode">                                  if (((z &lt; exitZ &amp;&amp; w.z &gt; 0) || (z &gt; exitZ &amp;&amp; w.z &lt; 0)) &amp;&amp; 
                                       !<a href="../Reflection_Models/BSDF_Representation.html#BxDFFlags::IsSpecular" class="code">IsSpecular</a>(exitInterface.<a href="../Reflection_Models/BSDF_Representation.html#BxDF::Flags" class="code">Flags</a>())) {
                                      &lt;&lt;<span class="fragmentname"><a href="#fragment-AccountforscatteringthroughmonoexitInterface-0">Account for scattering through <tt>exitInterface</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2323" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2323"><i></i></a><div id="fragbit-2323" class="collapse show"><div class="fragmentcode">                                         <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> fExit = exitInterface.<a href="../Reflection_Models/BSDF_Representation.html#BxDF::f" class="code">f</a>(-w, <a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::wi" class="code">wi</a>, mode);
                                         if (fExit) {
                                             Float exitPDF =
                                                 exitInterface.<a href="../Reflection_Models/BSDF_Representation.html#BxDF::PDF" class="code">PDF</a>(-w, <a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::wi" class="code">wi</a>, mode, BxDFReflTransFlags::Transmission);
                                             Float wt = <a href="../Monte_Carlo_Integration/Improving_Efficiency.html#PowerHeuristic" class="code">PowerHeuristic</a>(1, ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::pdf" class="code">pdf</a>, 1, exitPDF);
                                             <a href="../Reflection_Models/BSDF_Representation.html#BxDF::f" class="code">f</a> += beta * <a href="#LayeredBxDF::Tr" class="code">Tr</a>(zp - exitZ, ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::wi" class="code">wi</a>) * fExit * wt;
                                         }</div></div>
                                  }</div></div></div></div>
                            continue;
                        }
                        z = <a href="../Utilities/Mathematical_Infrastructure.html#Clamp" class="code">Clamp</a>(zp, 0, <a href="#LayeredBxDF::thickness" class="code">thickness</a>);</div></div> 
                 }</div></div>
              &lt;&lt;<span class="fragmentname"><a href="#fragment-Accountforscatteringatappropriateinterface-0">Account for scattering at appropriate interface</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2324" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2324"><i></i></a><div id="fragbit-2324" class="collapse show"><div class="fragmentcode">                 if (z == exitZ) {
                     &lt;&lt;<span class="fragmentname"><a href="#fragment-AccountforreflectionatmonoexitInterface-0">Account for reflection at <tt>exitInterface</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2325" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2325"><i></i></a><div id="fragbit-2325" class="collapse show"><div class="fragmentcode">                        Float uc = r();
                        pstd::optional&lt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample" class="code">BSDFSample</a>&gt; bs = exitInterface.<a href="../Reflection_Models/BSDF_Representation.html#BxDF::Sample_f" class="code">Sample_f</a>(
                            -w, uc, <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(r(), r()), mode, <a href="../Reflection_Models/BSDF_Representation.html#BxDFReflTransFlags::Reflection" class="code">BxDFReflTransFlags</a>::Reflection);
                        if (!bs || !bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::f" class="code">f</a> || bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::pdf" class="code">pdf</a> == 0 || bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>.z == 0)
                            break;
                        beta *= bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::f" class="code">f</a> * <a href="../Geometry_and_Transformations/Spherical_Geometry.html#AbsCosTheta" class="code">AbsCosTheta</a>(bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>) / bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::pdf" class="code">pdf</a>;
                        w = bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>;</div></div>
                 } else {
                     &lt;&lt;<span class="fragmentname">Account for scattering at <tt>nonExitInterface</tt></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2326" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2326"><i></i></a><div id="fragbit-2326" class="collapse show"><div class="fragmentcode">                        if (!IsSpecular(nonExitInterface.Flags())) {
                            &lt;&lt;<span class="fragmentname">Add NEE contribution along presampled <tt>wis</tt> direction</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2327" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2327"><i></i></a><div id="fragbit-2327" class="collapse show"><div class="fragmentcode">                               Float wt = 1;
                               if (!IsSpecular(exitInterface.Flags()))
                                   wt = PowerHeuristic(1, wis-&gt;pdf,
                                                       1, nonExitInterface.PDF(-w, -wis-&gt;wi, mode));
                               f += beta * nonExitInterface.f(-w, -wis-&gt;wi, mode) *
                                    AbsCosTheta(wis-&gt;wi) * wt * Tr(thickness, wis-&gt;wi) * wis-&gt;f / wis-&gt;pdf;</div></div>
                        }
                        &lt;&lt;<span class="fragmentname">Sample new direction using BSDF at <tt>nonExitInterface</tt></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2328" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2328"><i></i></a><div id="fragbit-2328" class="collapse show"><div class="fragmentcode">                           Float uc = r();
                           <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a> u(r(), r());
                           pstd::optional&lt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample" class="code">BSDFSample</a>&gt; bs = nonExitInterface.Sample_f(
                               -w, uc, u, mode, BxDFReflTransFlags::Reflection);
                           if (!bs || !bs-&gt;f || bs-&gt;pdf == 0 || bs-&gt;wi.z == 0)
                               break;
                           beta *= bs-&gt;f * AbsCosTheta(bs-&gt;wi) / bs-&gt;pdf;
                           w = bs-&gt;wi;</div></div>
                        if (!IsSpecular(exitInterface.Flags())) {
                            &lt;&lt;<span class="fragmentname">Add NEE contribution along direction from BSDF sample</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2329" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2329"><i></i></a><div id="fragbit-2329" class="collapse show"><div class="fragmentcode">                               <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> fExit = exitInterface.f(-w, wi, mode);
                               if (fExit) {
                                   Float wt = 1;
                                   if (!IsSpecular(nonExitInterface.Flags())) {
                                       Float exitPDF = exitInterface.PDF(
                                           -w, wi, mode, BxDFReflTransFlags::Transmission);
                                       wt = PowerHeuristic(1, bs-&gt;pdf, 1, exitPDF);
                                   }
                                   f += beta * Tr(thickness, bs-&gt;wi) * fExit * wt;
                               }</div></div>
                        }</div></div>
                 }</div></div></div></div> 
       }</div></div>
}</div><p>


</p>
<p>With this BSDF, layered materials can be specified as either one- or
two-sided via the <tt>twoSided</tt> template parameter.  If a material is
one-sided, then the shape&rsquo;s surface normal is used to determine which interface
an incident ray enters.  If it is in the same hemisphere as the surface
normal, it enters the top interface and otherwise it enters the bottom.  This
configuration is especially useful when both interfaces are transmissive
and have different BSDFs.

</p>
<p>For two-sided materials, the ray always enters the top interface.  This
option is useful when the bottom interface is opaque as is the case with
the <a href="#CoatedDiffuseBxDF"><tt>CoatedDiffuseBxDF</tt></a>, for example.  In this case, it is usually
desirable for scattering from both layers to be included, no matter which
side the ray intersects.

</p>
<p>One way to handle these options in the <tt>f()</tt> method would be to negate
both directions and make a recursive call to <tt>f()</tt> if <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.5ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 1076.4 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">omega Subscript normal o</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6F" d="M471 214c0 -127 -101 -225 -222 -225c-117 0 -221 96 -221 225c0 125 97 234 222 234c121 0 221 -106 221 -234zM388 222c0 38 0 96 -26 139s-69 65 -113 65c-40 0 -87 -21 -114 -67c-24 -44 -24 -98 -24 -137c0 -36 0 -97 25 -141c27 -46 71 -67 114 -67 c50 0 94 29 116 74c22 44 22 98 22 134Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6F" x="880" y="-213"></use>
</g>
</svg> points
below the surface and the material is two-sided.  However, that solution is
not a good one for the GPU, where it is likely to introduce thread
divergence. (This topic is discussed in more detail in
Section&nbsp;<a href="../Wavefront_Rendering_on_GPUs/Mapping_Path_Tracing_to_the_GPU.html#sec:basic-gpu-model">15.1.1</a>.)  Therefore, both directions are negated
at the start of the method and no recursive call is made in this case,
which gives an equivalent result.

</p>
<p></p>
<span class="anchor" id="fragment-SetmonowoandmonowiforlayeredBSDFevaluation-0"></span><div class="fragmentname">&lt;&lt;Set <tt>wo</tt> and <tt>wi</tt> for layered BSDF evaluation&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">if (<a href="#LayeredBxDF::twoSided" class="code">twoSided</a> &amp;&amp; wo.z &lt; 0) {
    wo = -wo;
    wi = -wi;
}</div><p>


</p>
<p>The next step is to determine which of the two <tt>BxDF</tt>s is the one that is
encountered first by the incident ray.  The sign of <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.5ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 1076.4 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">omega Subscript normal o</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6F" d="M471 214c0 -127 -101 -225 -222 -225c-117 0 -221 96 -221 225c0 125 97 234 222 234c121 0 221 -106 221 -234zM388 222c0 38 0 96 -26 139s-69 65 -113 65c-40 0 -87 -21 -114 -67c-24 -44 -24 -98 -24 -137c0 -36 0 -97 25 -141c27 -46 71 -67 114 -67 c50 0 94 29 116 74c22 44 22 98 22 134Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6F" x="880" y="-213"></use>
</g>
</svg>&rsquo;s <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.086ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 467.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">z</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D467" d="M467 432c0 -4 -22 -52 -117 -145c-36 -36 -98 -90 -98 -90c-36 -31 -65 -56 -119 -114c9 3 27 3 27 3c21 0 36 -4 70 -17c21 -7 39 -13 59 -13c33 0 97 19 120 84c3 7 5 13 14 13c8 0 12 -5 12 -10c0 -27 -58 -154 -157 -154c-29 0 -47 16 -64 37c-25 29 -35 38 -58 38 c-32 0 -62 -27 -85 -62c-6 -11 -8 -13 -16 -13c0 0 -12 0 -12 10c0 7 35 64 103 131l90 84c19 16 103 88 139 131c-26 0 -37 0 -77 15c-23 8 -42 15 -63 15c-8 0 -66 -1 -85 -47c-2 -6 -4 -11 -13 -11s-12 6 -12 11c0 21 46 114 121 114c33 0 50 -20 69 -43 c15 -17 27 -32 51 -32s45 16 75 64c5 9 8 11 15 11c0 0 11 0 11 -10Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D467" x="0" y="0"></use>
</g>
</svg> component
in the reflection coordinate system gives the answer.

</p>
<p></p>
<span class="anchor" id="fragment-DetermineentranceinterfaceforlayeredBSDF-0"></span><div class="fragmentname">&lt;&lt;Determine entrance interface for layered BSDF&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">TopOrBottomBxDF&lt;TopBxDF, BottomBxDF&gt; enterInterface;
bool enteredTop = twoSided || wo.z &gt; 0;
if (enteredTop) enterInterface = &amp;<a href="#LayeredBxDF::top" class="code">top</a>;
else            enterInterface = &amp;<a href="#LayeredBxDF::bottom" class="code">bottom</a>;</div><p>


</p>
<p>It is also necessary to determine which interface <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.135ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 919.4 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">omega Subscript normal i</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-69" d="M247 0c-34 1 -69 3 -104 3l-110 -3v31c67 0 78 0 78 45v269c0 49 -9 55 -74 55v31l140 11v-367c0 -39 4 -44 70 -44v-31zM192 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="880" y="-213"></use>
</g>
</svg> exits.  This is
determined both by which interface <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.5ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 1076.4 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">omega Subscript normal o</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6F" d="M471 214c0 -127 -101 -225 -222 -225c-117 0 -221 96 -221 225c0 125 97 234 222 234c121 0 221 -106 221 -234zM388 222c0 38 0 96 -26 139s-69 65 -113 65c-40 0 -87 -21 -114 -67c-24 -44 -24 -98 -24 -137c0 -36 0 -97 25 -141c27 -46 71 -67 114 -67 c50 0 94 29 116 74c22 44 22 98 22 134Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6F" x="880" y="-213"></use>
</g>
</svg> enters and by whether <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.5ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 1076.4 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">omega Subscript normal o</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6F" d="M471 214c0 -127 -101 -225 -222 -225c-117 0 -221 96 -221 225c0 125 97 234 222 234c121 0 221 -106 221 -234zM388 222c0 38 0 96 -26 139s-69 65 -113 65c-40 0 -87 -21 -114 -67c-24 -44 -24 -98 -24 -137c0 -36 0 -97 25 -141c27 -46 71 -67 114 -67 c50 0 94 29 116 74c22 44 22 98 22 134Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6F" x="880" y="-213"></use>
</g>
</svg> and
<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.135ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 919.4 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">omega Subscript normal i</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-69" d="M247 0c-34 1 -69 3 -104 3l-110 -3v31c67 0 78 0 78 45v269c0 49 -9 55 -74 55v31l140 11v-367c0 -39 4 -44 70 -44v-31zM192 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="880" y="-213"></use>
</g>
</svg> are in the same hemisphere.  We end up with an unusual case where the
<span style="font-variant: small-caps;">exclusive-or</span> operator comes in handy.  Along the way, the method also
stores which interface is the one that <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.135ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 919.4 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">omega Subscript normal i</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-69" d="M247 0c-34 1 -69 3 -104 3l-110 -3v31c67 0 78 0 78 45v269c0 49 -9 55 -74 55v31l140 11v-367c0 -39 4 -44 70 -44v-31zM192 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="880" y="-213"></use>
</g>
</svg> does not exit from.  As random
paths are sampled through the layers and medium, the implementation will
always choose reflection from this interface and not transmission, as
choosing the latter would end the path without being able to scatter out in the <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.135ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 919.4 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">omega Subscript normal i</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-69" d="M247 0c-34 1 -69 3 -104 3l-110 -3v31c67 0 78 0 78 45v269c0 49 -9 55 -74 55v31l140 11v-367c0 -39 4 -44 70 -44v-31zM192 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="880" y="-213"></use>
</g>
</svg>
direction.
The same logic then covers determining the <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.086ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 467.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">z</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D467" d="M467 432c0 -4 -22 -52 -117 -145c-36 -36 -98 -90 -98 -90c-36 -31 -65 -56 -119 -114c9 3 27 3 27 3c21 0 36 -4 70 -17c21 -7 39 -13 59 -13c33 0 97 19 120 84c3 7 5 13 14 13c8 0 12 -5 12 -10c0 -27 -58 -154 -157 -154c-29 0 -47 16 -64 37c-25 29 -35 38 -58 38 c-32 0 -62 -27 -85 -62c-6 -11 -8 -13 -16 -13c0 0 -12 0 -12 10c0 7 35 64 103 131l90 84c19 16 103 88 139 131c-26 0 -37 0 -77 15c-23 8 -42 15 -63 15c-8 0 -66 -1 -85 -47c-2 -6 -4 -11 -13 -11s-12 6 -12 11c0 21 46 114 121 114c33 0 50 -20 69 -43 c15 -17 27 -32 51 -32s45 16 75 64c5 9 8 11 15 11c0 0 11 0 11 -10Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D467" x="0" y="0"></use>
</g>
</svg> depth at which the ray path will
exit the surface.
 
</p>
<span class="anchor" id="fragment-DetermineexitinterfaceandexitzforlayeredBSDF-0"></span><div class="fragmentname">&lt;&lt;Determine exit interface and exit <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.086ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 467.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">z</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D467" d="M467 432c0 -4 -22 -52 -117 -145c-36 -36 -98 -90 -98 -90c-36 -31 -65 -56 -119 -114c9 3 27 3 27 3c21 0 36 -4 70 -17c21 -7 39 -13 59 -13c33 0 97 19 120 84c3 7 5 13 14 13c8 0 12 -5 12 -10c0 -27 -58 -154 -157 -154c-29 0 -47 16 -64 37c-25 29 -35 38 -58 38 c-32 0 -62 -27 -85 -62c-6 -11 -8 -13 -16 -13c0 0 -12 0 -12 10c0 7 35 64 103 131l90 84c19 16 103 88 139 131c-26 0 -37 0 -77 15c-23 8 -42 15 -63 15c-8 0 -66 -1 -85 -47c-2 -6 -4 -11 -13 -11s-12 6 -12 11c0 21 46 114 121 114c33 0 50 -20 69 -43 c15 -17 27 -32 51 -32s45 16 75 64c5 9 8 11 15 11c0 0 11 0 11 -10Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D467" x="0" y="0"></use>
</g>
</svg> for layered BSDF&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">TopOrBottomBxDF&lt;TopBxDF, BottomBxDF&gt; exitInterface, nonExitInterface;
if (<a href="../Reflection_Models/BSDF_Representation.html#SameHemisphere" class="code">SameHemisphere</a>(wo, wi) ^ enteredTop) {
    exitInterface = &amp;bottom;
    nonExitInterface = &amp;top;
} else {
    exitInterface = &amp;top;
    nonExitInterface = &amp;bottom;
}
Float exitZ = (<a href="../Reflection_Models/BSDF_Representation.html#SameHemisphere" class="code">SameHemisphere</a>(wo, wi) ^ enteredTop) ? 0 : <a href="#LayeredBxDF::thickness" class="code">thickness</a>;</div><p>


</p>
<p>If both directions are on the same side of the surface, then part of the
BSDF&rsquo;s value is given by reflection at the entrance interface.  This can be
evaluated directly by calling the interface&rsquo;s BSDF&rsquo;s <tt>f()</tt> method.
The resulting value must be scaled by the total number of samples taken to
estimate the BSDF in this method, since the final returned value is divided
by <tt>nSamples</tt>.

</p>
<p></p>
<span class="anchor" id="fragment-Accountforreflectionattheentranceinterface-0"></span><div class="fragmentname">&lt;&lt;Account for reflection at the entrance interface&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">if (<a href="../Reflection_Models/BSDF_Representation.html#SameHemisphere" class="code">SameHemisphere</a>(wo, wi))
    <a href="../Reflection_Models/BSDF_Representation.html#BxDF::f" class="code">f</a> = <a href="#LayeredBxDF::nSamples" class="code">nSamples</a> * enterInterface.<a href="../Reflection_Models/BSDF_Representation.html#BxDF::f" class="code">f</a>(wo, wi, mode);</div><p>


</p>
<p><tt>pbrt</tt>&rsquo;s <a href="../Reflection_Models/BSDF_Representation.html#BxDF"><tt>BxDF</tt></a> interface does not include any uniform sample values as
parameters to the <tt>f()</tt> method; there is no need for them for any of
the other <tt>BxDF</tt>s in the system.  In any case, an
unbounded number of uniform random numbers are required for sampling
operations when evaluating layered BSDFs.  Therefore, <tt>f()</tt>
initializes an <tt>RNG</tt> and defines a convenience lambda function that
returns uniform random sample values.  This does mean that the benefits of
sampling with well-distributed point sets are not present here; an exercise
at the end of the chapter returns to this issue.

</p>
<p>The <tt>RNG</tt> is seeded carefully: it is important that calls to
<tt>f()</tt> with different directions have different seeds so that there
is no risk of errors due to correlation between the <tt>RNG</tt>s used for
multiple samples in a pixel or across nearby pixels.  However, we would
also like the samples to be deterministic so that any call to <tt>f()</tt>
with the same two directions always has the same set of random samples.
This sort of reproducibility is important for debugging so that errors
appear consistently across multiple runs of the program.  Hashing the two provided directions
along with the system-wide seed addresses all of these concerns.

</p>
<p></p>
<span class="anchor" id="fragment-DeclaremonoRNGforlayeredBSDFevaluation-0"></span><div class="fragmentname">&lt;&lt;Declare <tt>RNG</tt> for layered BSDF evaluation&gt;&gt;=&nbsp;</div>
<div class="fragmentcode"><a href="../Utilities/Mathematical_Infrastructure.html#RNG" class="code">RNG</a> rng(<a href="../Utilities/Mathematical_Infrastructure.html#Hash" class="code">Hash</a>(<a href="../Utilities/System_Startup,_Cleanup,_and_Options.html#GetOptions" class="code">GetOptions</a>().<a href="../Utilities/System_Startup,_Cleanup,_and_Options.html#BasicPBRTOptions::seed" class="code">seed</a>, wo), <a href="../Utilities/Mathematical_Infrastructure.html#Hash" class="code">Hash</a>(wi));
auto r = [&amp;rng]() { return std::min&lt;Float&gt;(rng.<a href="../Utilities/Mathematical_Infrastructure.html#RNG::UniformFloat" class="code">Uniform</a>&lt;Float&gt;(),
                                           <a href="../Sampling_and_Reconstruction/Sampling_Interface.html#OneMinusEpsilon" class="code">OneMinusEpsilon</a>); };</div><p>


</p>
<p>In order to find the radiance leaving the interface in the direction <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.5ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 1076.4 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">omega Subscript normal o</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6F" d="M471 214c0 -127 -101 -225 -222 -225c-117 0 -221 96 -221 225c0 125 97 234 222 234c121 0 221 -106 221 -234zM388 222c0 38 0 96 -26 139s-69 65 -113 65c-40 0 -87 -21 -114 -67c-24 -44 -24 -98 -24 -137c0 -36 0 -97 25 -141c27 -46 71 -67 114 -67 c50 0 94 29 116 74c22 44 22 98 22 134Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6F" x="880" y="-213"></use>
</g>
</svg>,
we need to integrate the product of the cosine-weighted BTDF at the
interface with the
incident radiance from inside the medium,
</p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">
<span class="anchor" id="eq:layered-top-btdf-integrate"></span><div class="displaymath"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="34.5ex" height="6.176ex" style="vertical-align: -2.838ex;" viewBox="0 -1437.2 14854.2 2659.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">integral Underscript script upper H Subscript normal t Superscript 2 Baseline Endscripts f Subscript normal t Baseline left-parenthesis omega Subscript normal o Baseline comma omega prime Subscript Baseline right-parenthesis upper L Subscript normal i Baseline left-parenthesis z comma omega prime Subscript Baseline right-parenthesis StartAbsoluteValue cosine theta Superscript prime Baseline EndAbsoluteValue normal d omega prime Subscript Baseline comma</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNSIZE1-222B" d="M943 1268c0 -35 -25 -50 -49 -50c-23 0 -48 16 -48 49c0 25 17 47 50 49c-4 4 -29 23 -60 23c-39 0 -73 -129 -85 -178c-34 -129 -71 -329 -108 -542c-54 -321 -119 -640 -196 -956c-71 -290 -128 -524 -280 -524c-61 0 -111 42 -111 93c0 35 25 50 49 50 c23 0 48 -16 48 -49c0 -25 -17 -47 -49 -49c0 0 25 -23 61 -23c81 0 127 188 145 261c33 139 62 306 88 459c110 654 246 1156 249 1167c55 204 111 313 187 313c55 0 109 -39 109 -93Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-48" d="M716 0c-35 3 -110 3 -148 3s-112 0 -147 -3v31h24c77 0 79 11 79 47v262h-299v-262c0 -36 2 -47 79 -47h24v-31c-35 3 -110 3 -148 3s-112 0 -147 -3v31h24c77 0 79 11 79 47v527c0 36 -2 47 -79 47h-24v31c35 -3 110 -3 148 -3s112 0 147 3v-31h-24 c-77 0 -79 -11 -79 -47v-234h299v234c0 36 -2 47 -79 47h-24v31c35 -3 110 -3 148 -3s112 0 147 3v-31h-24c-77 0 -79 -11 -79 -47v-527c0 -36 2 -47 79 -47h24v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-32" d="M449 174l-28 -174h-371c0 24 0 26 11 37l192 214c55 62 105 141 105 221c0 82 -43 163 -134 163c-58 0 -112 -37 -135 -102c3 1 5 1 13 1c35 0 53 -26 53 -52c0 -41 -35 -53 -52 -53c-3 0 -53 0 -53 56c0 89 74 181 187 181c122 0 212 -80 212 -194 c0 -100 -60 -154 -216 -292l-106 -103h180c22 0 88 0 95 8c10 15 17 59 22 89h25Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-74" d="M332 124c0 -64 -28 -135 -99 -135c-36 0 -129 12 -129 135v276h-85v22c98 4 128 111 129 193h25v-184h143v-31h-143v-278c0 -17 0 -108 67 -108c37 0 67 38 67 112v55h25v-57Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D453" d="M552 636c0 -38 -29 -60 -55 -60c-19 0 -37 12 -37 35c0 15 10 50 54 54c-19 18 -45 18 -49 18c-21 0 -38 -15 -47 -34c-6 -12 -20 -83 -24 -104c-11 -58 -10 -56 -21 -114h83c17 0 27 0 27 -11c0 -20 -10 -20 -30 -20h-86l-60 -317c-1 -7 -24 -128 -56 -191 c-18 -38 -58 -97 -113 -97c-41 0 -85 24 -85 69c0 38 29 60 55 60c19 0 37 -12 37 -35c0 -15 -9 -51 -55 -54c19 -18 44 -18 48 -18c52 0 69 91 87 188l75 395h-66c-19 0 -28 0 -28 12c0 19 11 19 30 19h69c24 126 27 136 33 157c30 99 93 117 127 117c41 0 87 -23 87 -69Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6F" d="M471 214c0 -127 -101 -225 -222 -225c-117 0 -221 96 -221 225c0 125 97 234 222 234c121 0 221 -106 221 -234zM388 222c0 38 0 96 -26 139s-69 65 -113 65c-40 0 -87 -21 -114 -67c-24 -44 -24 -98 -24 -137c0 -36 0 -97 25 -141c27 -46 71 -67 114 -67 c50 0 94 29 116 74c22 44 22 98 22 134Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNVARIANTS-2032" d="M340 496c0 -10 -3 -20 -8 -28l-227 -372h-38l171 424c6 15 26 29 48 29c30 0 54 -24 54 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D43F" d="M643 247c0 0 0 -3 -4 -14l-79 -216c-6 -17 -7 -17 -31 -17h-463c-18 0 -27 0 -27 11c0 20 10 20 27 20c79 0 81 8 91 47l134 537c3 12 4 15 4 19c0 13 -9 14 -27 16c-17 2 -38 2 -38 2c-19 0 -28 0 -28 11c0 20 12 20 19 20l133 -3l148 3c5 0 16 0 16 -12 c0 -19 -8 -19 -38 -19c-94 0 -97 -11 -106 -47l-135 -540c-5 -18 -5 -20 -5 -23c0 -8 3 -9 13 -10c6 -1 8 -1 22 -1h94c173 0 217 114 251 206c7 16 8 21 17 21s12 -7 12 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-69" d="M247 0c-34 1 -69 3 -104 3l-110 -3v31c67 0 78 0 78 45v269c0 49 -9 55 -74 55v31l140 11v-367c0 -39 4 -44 70 -44v-31zM192 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D467" d="M467 432c0 -4 -22 -52 -117 -145c-36 -36 -98 -90 -98 -90c-36 -31 -65 -56 -119 -114c9 3 27 3 27 3c21 0 36 -4 70 -17c21 -7 39 -13 59 -13c33 0 97 19 120 84c3 7 5 13 14 13c8 0 12 -5 12 -10c0 -27 -58 -154 -157 -154c-29 0 -47 16 -64 37c-25 29 -35 38 -58 38 c-32 0 -62 -27 -85 -62c-6 -11 -8 -13 -16 -13c0 0 -12 0 -12 10c0 7 35 64 103 131l90 84c19 16 103 88 139 131c-26 0 -37 0 -77 15c-23 8 -42 15 -63 15c-8 0 -66 -1 -85 -47c-2 -6 -4 -11 -13 -11s-12 6 -12 11c0 21 46 114 121 114c33 0 50 -20 69 -43 c15 -17 27 -32 51 -32s45 16 75 64c5 9 8 11 15 11c0 0 11 0 11 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-7C" d="M159 -230c0 -11 -9 -20 -20 -20s-20 9 -20 20v960c0 11 9 20 20 20s20 -9 20 -20v-960Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-63" d="M415 119c0 -10 -32 -130 -166 -130c-116 0 -215 99 -215 227c0 124 92 232 217 232c77 0 153 -39 153 -107c0 -30 -20 -47 -46 -47c-28 0 -46 20 -46 46c0 13 6 43 47 46c-35 36 -98 37 -107 37c-53 0 -135 -42 -135 -205c0 -161 88 -204 141 -204c37 0 102 12 131 105 c2 6 4 10 13 10c3 0 13 0 13 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-73" d="M360 128c0 -72 -46 -139 -161 -139c-21 0 -66 1 -110 43c-18 -19 -18 -21 -20 -23c-19 -19 -20 -20 -25 -20c-11 0 -11 7 -11 24v132c0 18 0 25 13 25c10 0 11 -4 14 -17c19 -85 55 -142 139 -142c78 0 113 40 113 91c0 72 -82 88 -104 92c-72 14 -100 20 -132 46 c-27 22 -43 50 -43 85c0 56 38 123 160 123c15 0 56 0 94 -28c4 3 14 12 17 16c13 12 15 12 20 12c11 0 11 -7 11 -24v-101c0 -19 0 -24 -13 -24c0 0 -11 0 -12 9c-2 31 -7 121 -117 121c-86 0 -112 -41 -112 -76c0 -58 67 -71 123 -82c42 -8 81 -16 114 -48 c12 -12 42 -42 42 -95Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D703" d="M455 500c0 -224 -152 -511 -293 -511c-91 0 -120 111 -120 205c0 229 154 511 293 511c102 0 120 -139 120 -205zM389 562c0 57 -6 121 -55 121c-45 0 -82 -56 -109 -105c-40 -71 -60 -151 -77 -215h209c24 99 32 150 32 199zM348 331h-208c-26 -98 -32 -156 -32 -198 c0 -93 21 -122 54 -122c43 0 81 49 116 117c38 72 59 157 70 203Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-64" d="M527 0l-147 -11v66c-25 -32 -70 -66 -134 -66c-114 0 -212 99 -212 226c0 129 105 227 223 227c54 0 97 -26 126 -62v216c0 49 -8 56 -78 56v31l144 11v-607c0 -49 8 -56 78 -56v-31zM380 118v205c0 18 0 20 -11 37c-31 45 -73 60 -108 60c-54 0 -92 -33 -113 -64 c-29 -45 -31 -105 -31 -142c0 -41 3 -98 29 -139c24 -38 60 -64 105 -64c43 0 88 22 118 70c11 17 11 19 11 37Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNSIZE1-222B" x="0" y="0"></use>
<g transform="translate(574,-898)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-48" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNMAIN-32" x="924" y="456"></use>
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNMAIN-74" x="924" y="-383"></use>
</g>
<g transform="translate(1729,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D453" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-74" x="693" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="2595" y="0"></use>
<g transform="translate(2985,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6F" x="880" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="4061" y="0"></use>
<g transform="translate(4506,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNVARIANTS-2032" x="880" y="583"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="5517" y="0"></use>
<g transform="translate(6073,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D43F" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="963" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="7052" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D467" x="7441" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="7909" y="0"></use>
<g transform="translate(8354,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNVARIANTS-2032" x="880" y="583"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="9364" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-7C" x="9921" y="0"></use>
<g transform="translate(10199,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-63"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-6F" x="444" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-73" x="945" y="0"></use>
</g>
<g transform="translate(11705,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D703" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNVARIANTS-2032" x="663" y="583"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-7C" x="12563" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-64" x="13008" y="0"></use>
<g transform="translate(13565,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNVARIANTS-2032" x="880" y="583"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="14575" y="0"></use>
</g>
</svg>
</div>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">
<div class="eqno">(<a href="#eq:layered-top-btdf-integrate">14.35</a>)</div>
</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">
<p>

where <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.797ex" height="3.176ex" style="vertical-align: -0.838ex;" viewBox="0 -1006.6 1204.4 1367.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">script upper H Subscript normal t Superscript 2</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-48" d="M716 0c-35 3 -110 3 -148 3s-112 0 -147 -3v31h24c77 0 79 11 79 47v262h-299v-262c0 -36 2 -47 79 -47h24v-31c-35 3 -110 3 -148 3s-112 0 -147 -3v31h24c77 0 79 11 79 47v527c0 36 -2 47 -79 47h-24v31c35 -3 110 -3 148 -3s112 0 147 3v-31h-24 c-77 0 -79 -11 -79 -47v-234h299v234c0 36 -2 47 -79 47h-24v31c35 -3 110 -3 148 -3s112 0 147 3v-31h-24c-77 0 -79 -11 -79 -47v-527c0 -36 2 -47 79 -47h24v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-32" d="M449 174l-28 -174h-371c0 24 0 26 11 37l192 214c55 62 105 141 105 221c0 82 -43 163 -134 163c-58 0 -112 -37 -135 -102c3 1 5 1 13 1c35 0 53 -26 53 -52c0 -41 -35 -53 -52 -53c-3 0 -53 0 -53 56c0 89 74 181 187 181c122 0 212 -80 212 -194 c0 -100 -60 -154 -216 -292l-106 -103h180c22 0 88 0 95 8c10 15 17 59 22 89h25Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-74" d="M332 124c0 -64 -28 -135 -99 -135c-36 0 -129 12 -129 135v276h-85v22c98 4 128 111 129 193h25v-184h143v-31h-143v-278c0 -17 0 -108 67 -108c37 0 67 38 67 112v55h25v-57Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-48" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-32" x="1061" y="581"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-74" x="1061" y="-350"></use>
</g>
</svg> is the hemisphere inside the medium (see
Figure&nbsp;<a href="#fig:layered-layer-scatter-contrib">14.19</a>).  The implementation uses the standard Monte Carlo
estimator, taking a sample <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.347ex" height="2.343ex" style="vertical-align: -0.338ex;" viewBox="0 -863.1 1010.6 1008.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">omega prime Subscript</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
<path stroke-width="1" id="E1-LATINMODERNVARIANTS-2032" d="M340 496c0 -10 -3 -20 -8 -28l-227 -372h-38l171 424c6 15 26 29 48 29c30 0 54 -24 54 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNVARIANTS-2032" x="880" y="513"></use>
</g>
</svg> from the BTDF and then proceeding to estimate
<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.272ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 978.4 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">upper L Subscript normal i</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D43F" d="M643 247c0 0 0 -3 -4 -14l-79 -216c-6 -17 -7 -17 -31 -17h-463c-18 0 -27 0 -27 11c0 20 10 20 27 20c79 0 81 8 91 47l134 537c3 12 4 15 4 19c0 13 -9 14 -27 16c-17 2 -38 2 -38 2c-19 0 -28 0 -28 11c0 20 12 20 19 20l133 -3l148 3c5 0 16 0 16 -12 c0 -19 -8 -19 -38 -19c-94 0 -97 -11 -106 -47l-135 -540c-5 -18 -5 -20 -5 -23c0 -8 3 -9 13 -10c6 -1 8 -1 22 -1h94c173 0 217 114 251 206c7 16 8 21 17 21s12 -7 12 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-69" d="M247 0c-34 1 -69 3 -104 3l-110 -3v31c67 0 78 0 78 45v269c0 49 -9 55 -74 55v31l140 11v-367c0 -39 4 -44 70 -44v-31zM192 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D43F" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="963" y="-213"></use>
</g>
</svg>.

</p>
<p></p>
<span class="anchor" id="fig:layered-layer-scatter-contrib"></span><div class="card outerfigure"><div class="card-body figure"><p>



</p>
<div class="figure-row">
  <a href="pha14f19.svg" title=""><img src="pha14f19.svg" width=311 height=222 style="max-width: 100%;"></a>
</div>
<p>


</p>
<figcaption class="caption">Figure 14.19: <span class="legend"> The effect of light that scatters between the interface layers is
found by integrating the product of the cosine-weighted BTDF at the
entrance interface with the incident radiance from the medium,
Equation&nbsp;(<a href="#eq:layered-top-btdf-integrate">14.35</a>).</span>
</figcaption><p>


</p>
</div></div><p>


</p>
<p></p>
<span class="anchor" id="fragment-SamplerandomwalkthroughlayerstoestimateBSDFvalue-0"></span><div class="fragmentname">&lt;&lt;Sample random walk through layers to estimate BSDF value&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">&lt;&lt;<span class="fragmentname"><a href="#fragment-Sampletransmissiondirectionthroughentranceinterface-0">Sample transmission direction through entrance interface</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2330" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2330"><i></i></a><div id="fragbit-2330" class="collapse show"><div class="fragmentcode">   Float uc = r();
   pstd::optional&lt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample" class="code">BSDFSample</a>&gt; wos =
       enterInterface.<a href="../Reflection_Models/BSDF_Representation.html#BxDF::Sample_f" class="code">Sample_f</a>(wo, uc, <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(r(), r()), mode,
                               <a href="../Reflection_Models/BSDF_Representation.html#BxDFReflTransFlags::Transmission" class="code">BxDFReflTransFlags</a>::Transmission);
   if (!wos || !wos-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::f" class="code">f</a> || wos-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::pdf" class="code">pdf</a> == 0 || wos-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>.z == 0)
       continue;</div></div>
&lt;&lt;<span class="fragmentname"><a href="#fragment-SampleBSDFforvirtuallightfrommonowi-0">Sample BSDF for virtual light from <tt>wi</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2331" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2331"><i></i></a><div id="fragbit-2331" class="collapse show"><div class="fragmentcode">   uc = r();
   pstd::optional&lt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample" class="code">BSDFSample</a>&gt; wis =
       exitInterface.<a href="../Reflection_Models/BSDF_Representation.html#BxDF::Sample_f" class="code">Sample_f</a>(<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>, uc, <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(r(), r()), !mode,
                              <a href="../Reflection_Models/BSDF_Representation.html#BxDFReflTransFlags::Transmission" class="code">BxDFReflTransFlags</a>::Transmission);
   if (!wis || !wis-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::f" class="code">f</a> || wis-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::pdf" class="code">pdf</a> == 0 || wis-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>.z == 0)
       continue;</div></div>
&lt;&lt;<span class="fragmentname"><a href="#fragment-DeclarestateforrandomwalkthroughBSDFlayers-0">Declare state for random walk through BSDF layers</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2332" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2332"><i></i></a><div id="fragbit-2332" class="collapse show"><div class="fragmentcode">   <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> beta = wos-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::f" class="code">f</a> * <a href="../Geometry_and_Transformations/Spherical_Geometry.html#AbsCosTheta" class="code">AbsCosTheta</a>(wos-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>) / wos-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::pdf" class="code">pdf</a>;
   Float z = enteredTop ? <a href="#LayeredBxDF::thickness" class="code">thickness</a> : 0;
   <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> w = wos-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>;
   <a href="../Volume_Scattering/Phase_Functions.html#HGPhaseFunction" class="code">HGPhaseFunction</a> phase(g);</div></div>
for (int depth = 0; depth &lt; <a href="#LayeredBxDF::maxDepth" class="code">maxDepth</a>; ++depth) {
    &lt;&lt;<span class="fragmentname"><a href="#fragment-SamplenexteventforlayeredBSDFevaluationrandomwalk-0">Sample next event for layered BSDF evaluation random walk</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2333" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2333"><i></i></a><div id="fragbit-2333" class="collapse show"><div class="fragmentcode">       &lt;&lt;<span class="fragmentname"><a href="#fragment-PossiblyterminatelayeredBSDFrandomwalkwithRussianroulette-0">Possibly terminate layered BSDF random walk with Russian roulette</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2334" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2334"><i></i></a><div id="fragbit-2334" class="collapse show"><div class="fragmentcode">          if (depth &gt; 3 &amp;&amp; beta.<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum::MaxComponentValue" class="code">MaxComponentValue</a>() &lt; 0.25f) {
              Float q = std::max&lt;Float&gt;(0, 1 - beta.<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum::MaxComponentValue" class="code">MaxComponentValue</a>());
              if (r() &lt; q) break;
              beta /= 1 - q;
          }</div></div>
       &lt;&lt;<span class="fragmentname"><a href="#fragment-Accountformediabetweenlayersandpossiblyscatter-0">Account for media between layers and possibly scatter</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2335" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2335"><i></i></a><div id="fragbit-2335" class="collapse show"><div class="fragmentcode">          if (!<a href="#LayeredBxDF::albedo" class="code">albedo</a>) {
              &lt;&lt;<span class="fragmentname"><a href="#fragment-Advancetonextlayerboundaryandupdatemonobetafortransmittance-0">Advance to next layer boundary and update <tt>beta</tt> for transmittance</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2336" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2336"><i></i></a><div id="fragbit-2336" class="collapse show"><div class="fragmentcode">                 z = (z == <a href="#LayeredBxDF::thickness" class="code">thickness</a>) ? 0 : <a href="#LayeredBxDF::thickness" class="code">thickness</a>;
                 beta *= <a href="#LayeredBxDF::Tr" class="code">Tr</a>(<a href="#LayeredBxDF::thickness" class="code">thickness</a>, w);</div></div>
          } else {
              &lt;&lt;<span class="fragmentname"><a href="#fragment-SamplemediumscatteringforlayeredBSDFevaluation-0">Sample medium scattering for layered BSDF evaluation</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2337" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2337"><i></i></a><div id="fragbit-2337" class="collapse show"><div class="fragmentcode">                 Float sigma_t = 1;
                 Float dz = <a href="../Sampling_Algorithms/Sampling_1D_Functions.html#SampleExponential" class="code">SampleExponential</a>(r(), sigma_t / std::abs(w.z));
                 Float zp = w.z &gt; 0 ? (z + dz) : (z - dz);
                 if (0 &lt; zp &amp;&amp; zp &lt; <a href="#LayeredBxDF::thickness" class="code">thickness</a>) {
                     &lt;&lt;<span class="fragmentname"><a href="#fragment-HandlescatteringeventinlayeredBSDFmedium-0">Handle scattering event in layered BSDF medium</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2338" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2338"><i></i></a><div id="fragbit-2338" class="collapse show"><div class="fragmentcode">                        &lt;&lt;<span class="fragmentname"><a href="#fragment-AccountforscatteringthroughmonoexitInterfaceusingmonowis-0">Account for scattering through <tt>exitInterface</tt> using <tt>wis</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2339" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2339"><i></i></a><div id="fragbit-2339" class="collapse show"><div class="fragmentcode">                           Float wt = 1;
                           if (!<a href="../Reflection_Models/BSDF_Representation.html#BxDFFlags::IsSpecular" class="code">IsSpecular</a>(exitInterface.<a href="../Reflection_Models/BSDF_Representation.html#BxDF::Flags" class="code">Flags</a>()))
                               wt = <a href="../Monte_Carlo_Integration/Improving_Efficiency.html#PowerHeuristic" class="code">PowerHeuristic</a>(1, wis-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::pdf" class="code">pdf</a>, 1, phase.<a href="../Volume_Scattering/Phase_Functions.html#HGPhaseFunction::PDF" class="code">PDF</a>(-w, -wis-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>));
                           <a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::f" class="code">f</a> += beta * <a href="#LayeredBxDF::albedo" class="code">albedo</a> * phase.<a href="../Volume_Scattering/Phase_Functions.html#HGPhaseFunction::p" class="code">p</a>(-w, -wis-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>) * wt * <a href="#LayeredBxDF::Tr" class="code">Tr</a>(zp - exitZ, wis-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>) *
                                wis-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::f" class="code">f</a> / wis-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::pdf" class="code">pdf</a>;</div></div>
                        &lt;&lt;<span class="fragmentname"><a href="#fragment-Samplephasefunctionandupdatelayeredpathstate-0">Sample phase function and update layered path state</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2340" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2340"><i></i></a><div id="fragbit-2340" class="collapse show"><div class="fragmentcode">                           <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a> u{r(), r()};
                           pstd::optional&lt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample" class="code">PhaseFunctionSample</a>&gt; ps = phase.<a href="../Volume_Scattering/Phase_Functions.html#HGPhaseFunction::Sample_p" class="code">Sample_p</a>(-w, u);
                           if (!ps || ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::pdf" class="code">pdf</a> == 0 || ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::wi" class="code">wi</a>.z == 0)
                               continue;
                           beta *= <a href="#LayeredBxDF::albedo" class="code">albedo</a> * ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::p" class="code">p</a> / ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::pdf" class="code">pdf</a>;
                           w = ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::wi" class="code">wi</a>;
                           z = zp;</div></div>
                        &lt;&lt;<span class="fragmentname"><a href="#fragment-PossiblyaccountforscatteringthroughmonoexitInterface-0">Possibly account for scattering through <tt>exitInterface</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2341" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2341"><i></i></a><div id="fragbit-2341" class="collapse show"><div class="fragmentcode">                           if (((z &lt; exitZ &amp;&amp; w.z &gt; 0) || (z &gt; exitZ &amp;&amp; w.z &lt; 0)) &amp;&amp; 
                                !<a href="../Reflection_Models/BSDF_Representation.html#BxDFFlags::IsSpecular" class="code">IsSpecular</a>(exitInterface.<a href="../Reflection_Models/BSDF_Representation.html#BxDF::Flags" class="code">Flags</a>())) {
                               &lt;&lt;<span class="fragmentname"><a href="#fragment-AccountforscatteringthroughmonoexitInterface-0">Account for scattering through <tt>exitInterface</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2342" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2342"><i></i></a><div id="fragbit-2342" class="collapse show"><div class="fragmentcode">                                  <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> fExit = exitInterface.<a href="../Reflection_Models/BSDF_Representation.html#BxDF::f" class="code">f</a>(-w, <a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::wi" class="code">wi</a>, mode);
                                  if (fExit) {
                                      Float exitPDF =
                                          exitInterface.<a href="../Reflection_Models/BSDF_Representation.html#BxDF::PDF" class="code">PDF</a>(-w, <a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::wi" class="code">wi</a>, mode, BxDFReflTransFlags::Transmission);
                                      Float wt = <a href="../Monte_Carlo_Integration/Improving_Efficiency.html#PowerHeuristic" class="code">PowerHeuristic</a>(1, ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::pdf" class="code">pdf</a>, 1, exitPDF);
                                      <a href="../Reflection_Models/BSDF_Representation.html#BxDF::f" class="code">f</a> += beta * <a href="#LayeredBxDF::Tr" class="code">Tr</a>(zp - exitZ, ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::wi" class="code">wi</a>) * fExit * wt;
                                  }</div></div>
                           }</div></div></div></div>
                     continue;
                 }
                 z = <a href="../Utilities/Mathematical_Infrastructure.html#Clamp" class="code">Clamp</a>(zp, 0, <a href="#LayeredBxDF::thickness" class="code">thickness</a>);</div></div> 
          }</div></div>
       &lt;&lt;<span class="fragmentname"><a href="#fragment-Accountforscatteringatappropriateinterface-0">Account for scattering at appropriate interface</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2343" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2343"><i></i></a><div id="fragbit-2343" class="collapse show"><div class="fragmentcode">          if (z == exitZ) {
              &lt;&lt;<span class="fragmentname"><a href="#fragment-AccountforreflectionatmonoexitInterface-0">Account for reflection at <tt>exitInterface</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2344" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2344"><i></i></a><div id="fragbit-2344" class="collapse show"><div class="fragmentcode">                 Float uc = r();
                 pstd::optional&lt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample" class="code">BSDFSample</a>&gt; bs = exitInterface.<a href="../Reflection_Models/BSDF_Representation.html#BxDF::Sample_f" class="code">Sample_f</a>(
                     -w, uc, <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(r(), r()), mode, <a href="../Reflection_Models/BSDF_Representation.html#BxDFReflTransFlags::Reflection" class="code">BxDFReflTransFlags</a>::Reflection);
                 if (!bs || !bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::f" class="code">f</a> || bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::pdf" class="code">pdf</a> == 0 || bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>.z == 0)
                     break;
                 beta *= bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::f" class="code">f</a> * <a href="../Geometry_and_Transformations/Spherical_Geometry.html#AbsCosTheta" class="code">AbsCosTheta</a>(bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>) / bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::pdf" class="code">pdf</a>;
                 w = bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>;</div></div>
          } else {
              &lt;&lt;<span class="fragmentname">Account for scattering at <tt>nonExitInterface</tt></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2345" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2345"><i></i></a><div id="fragbit-2345" class="collapse show"><div class="fragmentcode">                 if (!IsSpecular(nonExitInterface.Flags())) {
                     &lt;&lt;<span class="fragmentname">Add NEE contribution along presampled <tt>wis</tt> direction</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2346" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2346"><i></i></a><div id="fragbit-2346" class="collapse show"><div class="fragmentcode">                        Float wt = 1;
                        if (!IsSpecular(exitInterface.Flags()))
                            wt = PowerHeuristic(1, wis-&gt;pdf,
                                                1, nonExitInterface.PDF(-w, -wis-&gt;wi, mode));
                        f += beta * nonExitInterface.f(-w, -wis-&gt;wi, mode) *
                             AbsCosTheta(wis-&gt;wi) * wt * Tr(thickness, wis-&gt;wi) * wis-&gt;f / wis-&gt;pdf;</div></div>
                 }
                 &lt;&lt;<span class="fragmentname">Sample new direction using BSDF at <tt>nonExitInterface</tt></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2347" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2347"><i></i></a><div id="fragbit-2347" class="collapse show"><div class="fragmentcode">                    Float uc = r();
                    <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a> u(r(), r());
                    pstd::optional&lt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample" class="code">BSDFSample</a>&gt; bs = nonExitInterface.Sample_f(
                        -w, uc, u, mode, BxDFReflTransFlags::Reflection);
                    if (!bs || !bs-&gt;f || bs-&gt;pdf == 0 || bs-&gt;wi.z == 0)
                        break;
                    beta *= bs-&gt;f * AbsCosTheta(bs-&gt;wi) / bs-&gt;pdf;
                    w = bs-&gt;wi;</div></div>
                 if (!IsSpecular(exitInterface.Flags())) {
                     &lt;&lt;<span class="fragmentname">Add NEE contribution along direction from BSDF sample</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2348" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2348"><i></i></a><div id="fragbit-2348" class="collapse show"><div class="fragmentcode">                        <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> fExit = exitInterface.f(-w, wi, mode);
                        if (fExit) {
                            Float wt = 1;
                            if (!IsSpecular(nonExitInterface.Flags())) {
                                Float exitPDF = exitInterface.PDF(
                                    -w, wi, mode, BxDFReflTransFlags::Transmission);
                                wt = PowerHeuristic(1, bs-&gt;pdf, 1, exitPDF);
                            }
                            f += beta * Tr(thickness, bs-&gt;wi) * fExit * wt;
                        }</div></div>
                 }</div></div>
          }</div></div></div></div> 
}</div><p>


</p>
<p>Sampling the direction <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.347ex" height="2.343ex" style="vertical-align: -0.338ex;" viewBox="0 -863.1 1010.6 1008.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">omega prime Subscript</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
<path stroke-width="1" id="E1-LATINMODERNVARIANTS-2032" d="M340 496c0 -10 -3 -20 -8 -28l-227 -372h-38l171 424c6 15 26 29 48 29c30 0 54 -24 54 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNVARIANTS-2032" x="880" y="513"></use>
</g>
</svg> is a case where it is useful to be able to
specify to <tt>Sample_f()</tt> that only transmission should be sampled.

</p>
<p></p>
<span class="anchor" id="fragment-Sampletransmissiondirectionthroughentranceinterface-0"></span><div class="fragmentname">&lt;&lt;Sample transmission direction through entrance interface&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">Float uc = r();
pstd::optional&lt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample" class="code">BSDFSample</a>&gt; wos =
    enterInterface.<a href="../Reflection_Models/BSDF_Representation.html#BxDF::Sample_f" class="code">Sample_f</a>(wo, uc, <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(r(), r()), mode,
                            <a href="../Reflection_Models/BSDF_Representation.html#BxDFReflTransFlags::Transmission" class="code">BxDFReflTransFlags</a>::Transmission);
if (!wos || !wos-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::f" class="code">f</a> || wos-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::pdf" class="code">pdf</a> == 0 || wos-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>.z == 0)
    continue;</div><p>


</p>
<p>The task now is to compute a Monte Carlo estimate of the 1D equation of
transfer, Equation&nbsp;(<a href="#eq:eot-1d">14.31</a>).  Before discussing how it is sampled,
however, we will first consider some details related to the lighting
calculation with the virtual light source.  At each vertex of the path, we
will want to compute the incident illumination due to the light.  As shown
in Figure&nbsp;<a href="#fig:layered-virtual-light-contribution">14.20</a>, there are three
factors in the light&rsquo;s contribution: the
value of the phase function or interface BSDF for a direction <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.446ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 622.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">omega Subscript</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
</g>
</svg>, the
transmittance between the vertex and the exit interface, and the value of
the interface&rsquo;s BTDF for the direction from <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="3.254ex" height="2.176ex" style="vertical-align: -0.505ex;" viewBox="0 -719.6 1401 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">minus omega Subscript</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-2212" d="M722 250c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-2212" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="778" y="0"></use>
</g>
</svg> to <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.135ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 919.4 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">omega Subscript normal i</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-69" d="M247 0c-34 1 -69 3 -104 3l-110 -3v31c67 0 78 0 78 45v269c0 49 -9 55 -74 55v31l140 11v-367c0 -39 4 -44 70 -44v-31zM192 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="880" y="-213"></use>
</g>
</svg>.

</p>
<p></p>
<span class="anchor" id="fig:layered-virtual-light-contribution"></span><div class="card outerfigure"><div class="card-body figure"><p>



</p>
<div class="figure-row">
  <a href="pha14f20.svg" title=""><img src="pha14f20.svg" width=463 height=269 style="max-width: 100%;"></a>
</div>
<p>


</p>
<figcaption class="caption">Figure 14.20: Illumination Contribution from the Virtual Light Source. <span class="legend">
At a path vertex, the contribution of the virtual light source is given by
the product of the path throughput weight <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.334ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 574.5 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">beta</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D6FD" d="M574 574c0 -12 -2 -24 -5 -37c-11 -45 -41 -86 -81 -116c-10 -8 -20 -14 -30 -20c17 -11 31 -26 43 -43c20 -31 30 -68 30 -108c0 -20 -3 -42 -8 -64c-14 -53 -51 -104 -99 -140c-52 -38 -113 -57 -170 -57c-68 0 -114 40 -131 98l-68 -274c-1 -4 -5 -7 -10 -7h-5 c-6 0 -10 4 -10 12l154 615c34 136 125 273 245 273c47 0 89 -18 116 -50c18 -22 29 -51 29 -82zM518 592c0 19 -3 36 -12 51c-16 26 -44 40 -78 40c-110 0 -188 -129 -220 -255l-60 -242c-4 -17 -6 -33 -6 -49c0 -71 41 -126 113 -126c44 0 91 19 129 52 c39 35 61 82 73 128c7 29 12 59 12 87c0 25 -4 48 -14 69c-7 16 -17 29 -30 39c-25 -9 -50 -13 -75 -13c-35 0 -76 0 -76 24c0 0 0 5 1 7c7 27 49 27 85 27c24 0 47 -5 67 -13c9 5 18 12 26 19c31 29 49 67 58 105c5 17 7 34 7 50zM395 403c-11 3 -23 5 -36 5 c-24 0 -57 0 -60 -9c-1 -4 30 -4 52 -4c14 0 29 3 44 8Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D6FD" x="0" y="0"></use>
</g>
</svg> that accounts for previous
scattering along the path, the scattering at the vertex, the transmittance
<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.234ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 962 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">upper T Subscript normal r</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D447" d="M704 666c0 -3 -1 -13 -2 -17l-27 -174c-2 -15 -4 -23 -15 -23c-9 0 -12 7 -12 13c0 3 2 15 3 19c4 26 8 65 8 80c0 78 -45 82 -146 82c-21 0 -54 0 -63 -2c-12 -3 -16 -9 -23 -37l-133 -531c-4 -15 -4 -21 -4 -21c0 -16 8 -19 37 -22c26 -2 39 -2 64 -2c26 0 34 0 34 -11 c0 -20 -12 -20 -22 -20c-28 0 -58 2 -87 2l-83 1l-85 -1c-27 0 -55 -2 -82 -2c-6 0 -17 0 -17 12c0 19 6 19 42 19c107 0 110 11 119 48l134 534c1 3 4 15 4 21c0 8 0 12 -28 12h-39c-148 0 -174 -18 -228 -173c-6 -16 -7 -21 -17 -21c-7 0 -12 5 -12 11c0 0 5 16 6 18 l60 176c7 19 8 20 32 20h555c17 0 27 0 27 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-72" d="M364 381c0 -32 -25 -44 -43 -44c-22 0 -43 15 -43 43c0 26 20 38 23 39c-2 1 -4 1 -11 1c-76 0 -118 -89 -118 -188v-154c0 -36 2 -47 76 -47h21v-31c-40 3 -87 3 -127 3l-114 -3v31c67 0 78 0 78 45v268c0 49 -8 56 -78 56v31l139 11v-110c14 43 50 110 123 110 c43 0 74 -29 74 -61Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D447" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-72" x="826" y="-213"></use>
</g>
</svg> to the exit interface, and the effect of the BTDF at the
interface.</span>
</figcaption><p>


</p>
</div></div><p>


</p>
<p>

</p>
<p>Each of these three factors could be used for sampling; as before, one may
sometimes be much more effective than the others.  The <tt>LayeredBxDF</tt>
implementation uses two of the three&mdash;sampling the phase function or BRDF
at the current path vertex (as appropriate) and sampling the BTDF at the
exit interface&mdash;and then weights the results using MIS.

</p>
<p>There is no reason to repeatedly sample the exit interface BTDF at each
path vertex since the direction <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.135ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 919.4 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">omega Subscript normal i</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-69" d="M247 0c-34 1 -69 3 -104 3l-110 -3v31c67 0 78 0 78 45v269c0 49 -9 55 -74 55v31l140 11v-367c0 -39 4 -44 70 -44v-31zM192 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="880" y="-213"></use>
</g>
</svg> is fixed.  Therefore, the following
fragment samples it once and holds on to the resulting <tt>BSDFSample</tt>.
Note that the negation of the <tt>TransportMode</tt> parameter value
<tt>mode</tt> is taken for the call to <tt>Sample_f()</tt>, which is important
to reflect the fact that this sampling operation is following the reverse
path with respect to sampling in terms of <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.5ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 1076.4 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">omega Subscript normal o</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6F" d="M471 214c0 -127 -101 -225 -222 -225c-117 0 -221 96 -221 225c0 125 97 234 222 234c121 0 221 -106 221 -234zM388 222c0 38 0 96 -26 139s-69 65 -113 65c-40 0 -87 -21 -114 -67c-24 -44 -24 -98 -24 -137c0 -36 0 -97 25 -141c27 -46 71 -67 114 -67 c50 0 94 29 116 74c22 44 22 98 22 134Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6F" x="880" y="-213"></use>
</g>
</svg>.  This is an important
detail so that the underlying <a href="../Reflection_Models/BSDF_Representation.html#BxDF"><tt>BxDF</tt></a> can correctly account for
non-symmetric scattering; see Section&nbsp;<a href="../Reflection_Models/Dielectric_BSDF.html#sec:non-symmetric">9.5.2</a>.

</p>
<p></p>
<span class="anchor" id="fragment-SampleBSDFforvirtuallightfrommonowi-0"></span><div class="fragmentname">&lt;&lt;Sample BSDF for virtual light from <tt>wi</tt>&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">uc = r();
pstd::optional&lt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample" class="code">BSDFSample</a>&gt; wis =
    exitInterface.<a href="../Reflection_Models/BSDF_Representation.html#BxDF::Sample_f" class="code">Sample_f</a>(<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>, uc, <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(r(), r()), !mode,
                           <a href="../Reflection_Models/BSDF_Representation.html#BxDFReflTransFlags::Transmission" class="code">BxDFReflTransFlags</a>::Transmission);
if (!wis || !wis-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::f" class="code">f</a> || wis-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::pdf" class="code">pdf</a> == 0 || wis-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>.z == 0)
    continue;</div><p>


</p>
<p>Moving forward to the random walk estimation of the equation of transfer,
the implementation
maintains the current path throughput weight <tt>beta</tt>, the depth <tt>z</tt>
of the last scattering event, and the ray direction <tt>w</tt>.

</p>
<p></p>
<span class="anchor" id="fragment-DeclarestateforrandomwalkthroughBSDFlayers-0"></span><div class="fragmentname">&lt;&lt;Declare state for random walk through BSDF layers&gt;&gt;=&nbsp;</div>
<div class="fragmentcode"><a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> beta = wos-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::f" class="code">f</a> * <a href="../Geometry_and_Transformations/Spherical_Geometry.html#AbsCosTheta" class="code">AbsCosTheta</a>(wos-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>) / wos-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::pdf" class="code">pdf</a>;
Float z = enteredTop ? <a href="#LayeredBxDF::thickness" class="code">thickness</a> : 0;
<a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> w = wos-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>;
<a href="../Volume_Scattering/Phase_Functions.html#HGPhaseFunction" class="code">HGPhaseFunction</a> phase(g);</div><p>


</p>
<p>We can now move to the body of the inner loop over scattering events along
the path.  After a Russian roulette test, a distance is sampled along the
ray to determine the next path vertex either within the medium or at
whichever interface the ray intersects.

</p>
<p></p>
<span class="anchor" id="fragment-SamplenexteventforlayeredBSDFevaluationrandomwalk-0"></span><div class="fragmentname">&lt;&lt;Sample next event for layered BSDF evaluation random walk&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">&lt;&lt;<span class="fragmentname"><a href="#fragment-PossiblyterminatelayeredBSDFrandomwalkwithRussianroulette-0">Possibly terminate layered BSDF random walk with Russian roulette</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2349" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2349"><i></i></a><div id="fragbit-2349" class="collapse show"><div class="fragmentcode">   if (depth &gt; 3 &amp;&amp; beta.<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum::MaxComponentValue" class="code">MaxComponentValue</a>() &lt; 0.25f) {
       Float q = std::max&lt;Float&gt;(0, 1 - beta.<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum::MaxComponentValue" class="code">MaxComponentValue</a>());
       if (r() &lt; q) break;
       beta /= 1 - q;
   }</div></div>
&lt;&lt;<span class="fragmentname"><a href="#fragment-Accountformediabetweenlayersandpossiblyscatter-0">Account for media between layers and possibly scatter</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2350" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2350"><i></i></a><div id="fragbit-2350" class="collapse show"><div class="fragmentcode">   if (!<a href="#LayeredBxDF::albedo" class="code">albedo</a>) {
       &lt;&lt;<span class="fragmentname"><a href="#fragment-Advancetonextlayerboundaryandupdatemonobetafortransmittance-0">Advance to next layer boundary and update <tt>beta</tt> for transmittance</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2351" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2351"><i></i></a><div id="fragbit-2351" class="collapse show"><div class="fragmentcode">          z = (z == <a href="#LayeredBxDF::thickness" class="code">thickness</a>) ? 0 : <a href="#LayeredBxDF::thickness" class="code">thickness</a>;
          beta *= <a href="#LayeredBxDF::Tr" class="code">Tr</a>(<a href="#LayeredBxDF::thickness" class="code">thickness</a>, w);</div></div>
   } else {
       &lt;&lt;<span class="fragmentname"><a href="#fragment-SamplemediumscatteringforlayeredBSDFevaluation-0">Sample medium scattering for layered BSDF evaluation</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2352" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2352"><i></i></a><div id="fragbit-2352" class="collapse show"><div class="fragmentcode">          Float sigma_t = 1;
          Float dz = <a href="../Sampling_Algorithms/Sampling_1D_Functions.html#SampleExponential" class="code">SampleExponential</a>(r(), sigma_t / std::abs(w.z));
          Float zp = w.z &gt; 0 ? (z + dz) : (z - dz);
          if (0 &lt; zp &amp;&amp; zp &lt; <a href="#LayeredBxDF::thickness" class="code">thickness</a>) {
              &lt;&lt;<span class="fragmentname"><a href="#fragment-HandlescatteringeventinlayeredBSDFmedium-0">Handle scattering event in layered BSDF medium</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2353" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2353"><i></i></a><div id="fragbit-2353" class="collapse show"><div class="fragmentcode">                 &lt;&lt;<span class="fragmentname"><a href="#fragment-AccountforscatteringthroughmonoexitInterfaceusingmonowis-0">Account for scattering through <tt>exitInterface</tt> using <tt>wis</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2354" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2354"><i></i></a><div id="fragbit-2354" class="collapse show"><div class="fragmentcode">                    Float wt = 1;
                    if (!<a href="../Reflection_Models/BSDF_Representation.html#BxDFFlags::IsSpecular" class="code">IsSpecular</a>(exitInterface.<a href="../Reflection_Models/BSDF_Representation.html#BxDF::Flags" class="code">Flags</a>()))
                        wt = <a href="../Monte_Carlo_Integration/Improving_Efficiency.html#PowerHeuristic" class="code">PowerHeuristic</a>(1, wis-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::pdf" class="code">pdf</a>, 1, phase.<a href="../Volume_Scattering/Phase_Functions.html#HGPhaseFunction::PDF" class="code">PDF</a>(-w, -wis-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>));
                    <a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::f" class="code">f</a> += beta * <a href="#LayeredBxDF::albedo" class="code">albedo</a> * phase.<a href="../Volume_Scattering/Phase_Functions.html#HGPhaseFunction::p" class="code">p</a>(-w, -wis-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>) * wt * <a href="#LayeredBxDF::Tr" class="code">Tr</a>(zp - exitZ, wis-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>) *
                         wis-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::f" class="code">f</a> / wis-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::pdf" class="code">pdf</a>;</div></div>
                 &lt;&lt;<span class="fragmentname"><a href="#fragment-Samplephasefunctionandupdatelayeredpathstate-0">Sample phase function and update layered path state</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2355" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2355"><i></i></a><div id="fragbit-2355" class="collapse show"><div class="fragmentcode">                    <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a> u{r(), r()};
                    pstd::optional&lt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample" class="code">PhaseFunctionSample</a>&gt; ps = phase.<a href="../Volume_Scattering/Phase_Functions.html#HGPhaseFunction::Sample_p" class="code">Sample_p</a>(-w, u);
                    if (!ps || ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::pdf" class="code">pdf</a> == 0 || ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::wi" class="code">wi</a>.z == 0)
                        continue;
                    beta *= <a href="#LayeredBxDF::albedo" class="code">albedo</a> * ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::p" class="code">p</a> / ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::pdf" class="code">pdf</a>;
                    w = ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::wi" class="code">wi</a>;
                    z = zp;</div></div>
                 &lt;&lt;<span class="fragmentname"><a href="#fragment-PossiblyaccountforscatteringthroughmonoexitInterface-0">Possibly account for scattering through <tt>exitInterface</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2356" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2356"><i></i></a><div id="fragbit-2356" class="collapse show"><div class="fragmentcode">                    if (((z &lt; exitZ &amp;&amp; w.z &gt; 0) || (z &gt; exitZ &amp;&amp; w.z &lt; 0)) &amp;&amp; 
                         !<a href="../Reflection_Models/BSDF_Representation.html#BxDFFlags::IsSpecular" class="code">IsSpecular</a>(exitInterface.<a href="../Reflection_Models/BSDF_Representation.html#BxDF::Flags" class="code">Flags</a>())) {
                        &lt;&lt;<span class="fragmentname"><a href="#fragment-AccountforscatteringthroughmonoexitInterface-0">Account for scattering through <tt>exitInterface</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2357" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2357"><i></i></a><div id="fragbit-2357" class="collapse show"><div class="fragmentcode">                           <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> fExit = exitInterface.<a href="../Reflection_Models/BSDF_Representation.html#BxDF::f" class="code">f</a>(-w, <a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::wi" class="code">wi</a>, mode);
                           if (fExit) {
                               Float exitPDF =
                                   exitInterface.<a href="../Reflection_Models/BSDF_Representation.html#BxDF::PDF" class="code">PDF</a>(-w, <a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::wi" class="code">wi</a>, mode, BxDFReflTransFlags::Transmission);
                               Float wt = <a href="../Monte_Carlo_Integration/Improving_Efficiency.html#PowerHeuristic" class="code">PowerHeuristic</a>(1, ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::pdf" class="code">pdf</a>, 1, exitPDF);
                               <a href="../Reflection_Models/BSDF_Representation.html#BxDF::f" class="code">f</a> += beta * <a href="#LayeredBxDF::Tr" class="code">Tr</a>(zp - exitZ, ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::wi" class="code">wi</a>) * fExit * wt;
                           }</div></div>
                    }</div></div></div></div>
              continue;
          }
          z = <a href="../Utilities/Mathematical_Infrastructure.html#Clamp" class="code">Clamp</a>(zp, 0, <a href="#LayeredBxDF::thickness" class="code">thickness</a>);</div></div> 
   }</div></div>
&lt;&lt;<span class="fragmentname"><a href="#fragment-Accountforscatteringatappropriateinterface-0">Account for scattering at appropriate interface</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2358" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2358"><i></i></a><div id="fragbit-2358" class="collapse show"><div class="fragmentcode">   if (z == exitZ) {
       &lt;&lt;<span class="fragmentname"><a href="#fragment-AccountforreflectionatmonoexitInterface-0">Account for reflection at <tt>exitInterface</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2359" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2359"><i></i></a><div id="fragbit-2359" class="collapse show"><div class="fragmentcode">          Float uc = r();
          pstd::optional&lt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample" class="code">BSDFSample</a>&gt; bs = exitInterface.<a href="../Reflection_Models/BSDF_Representation.html#BxDF::Sample_f" class="code">Sample_f</a>(
              -w, uc, <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(r(), r()), mode, <a href="../Reflection_Models/BSDF_Representation.html#BxDFReflTransFlags::Reflection" class="code">BxDFReflTransFlags</a>::Reflection);
          if (!bs || !bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::f" class="code">f</a> || bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::pdf" class="code">pdf</a> == 0 || bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>.z == 0)
              break;
          beta *= bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::f" class="code">f</a> * <a href="../Geometry_and_Transformations/Spherical_Geometry.html#AbsCosTheta" class="code">AbsCosTheta</a>(bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>) / bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::pdf" class="code">pdf</a>;
          w = bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>;</div></div>
   } else {
       &lt;&lt;<span class="fragmentname">Account for scattering at <tt>nonExitInterface</tt></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2360" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2360"><i></i></a><div id="fragbit-2360" class="collapse show"><div class="fragmentcode">          if (!IsSpecular(nonExitInterface.Flags())) {
              &lt;&lt;<span class="fragmentname">Add NEE contribution along presampled <tt>wis</tt> direction</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2361" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2361"><i></i></a><div id="fragbit-2361" class="collapse show"><div class="fragmentcode">                 Float wt = 1;
                 if (!IsSpecular(exitInterface.Flags()))
                     wt = PowerHeuristic(1, wis-&gt;pdf,
                                         1, nonExitInterface.PDF(-w, -wis-&gt;wi, mode));
                 f += beta * nonExitInterface.f(-w, -wis-&gt;wi, mode) *
                      AbsCosTheta(wis-&gt;wi) * wt * Tr(thickness, wis-&gt;wi) * wis-&gt;f / wis-&gt;pdf;</div></div>
          }
          &lt;&lt;<span class="fragmentname">Sample new direction using BSDF at <tt>nonExitInterface</tt></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2362" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2362"><i></i></a><div id="fragbit-2362" class="collapse show"><div class="fragmentcode">             Float uc = r();
             <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a> u(r(), r());
             pstd::optional&lt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample" class="code">BSDFSample</a>&gt; bs = nonExitInterface.Sample_f(
                 -w, uc, u, mode, BxDFReflTransFlags::Reflection);
             if (!bs || !bs-&gt;f || bs-&gt;pdf == 0 || bs-&gt;wi.z == 0)
                 break;
             beta *= bs-&gt;f * AbsCosTheta(bs-&gt;wi) / bs-&gt;pdf;
             w = bs-&gt;wi;</div></div>
          if (!IsSpecular(exitInterface.Flags())) {
              &lt;&lt;<span class="fragmentname">Add NEE contribution along direction from BSDF sample</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2363" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2363"><i></i></a><div id="fragbit-2363" class="collapse show"><div class="fragmentcode">                 <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> fExit = exitInterface.f(-w, wi, mode);
                 if (fExit) {
                     Float wt = 1;
                     if (!IsSpecular(nonExitInterface.Flags())) {
                         Float exitPDF = exitInterface.PDF(
                             -w, wi, mode, BxDFReflTransFlags::Transmission);
                         wt = PowerHeuristic(1, bs-&gt;pdf, 1, exitPDF);
                     }
                     f += beta * Tr(thickness, bs-&gt;wi) * fExit * wt;
                 }</div></div>
          }</div></div>
   }</div></div></div><p>


</p>
<p>It is worth considering terminating the path as the path throughput weight
becomes low, though here the termination probability is set less
aggressively than it was in the <a href="../Light_Transport_I_Surface_Reflection/A_Better_Path_Tracer.html#PathIntegrator"><tt>PathIntegrator</tt></a> and
<a href="../Light_Transport_II_Volume_Rendering/Volume_Scattering_Integrators.html#VolPathIntegrator"><tt>VolPathIntegrator</tt></a>.  This reflects the fact that each bounce here is
relatively inexpensive, so doing more work to improve the accuracy of the
estimate is worthwhile.

</p>
<p></p>
<span class="anchor" id="fragment-PossiblyterminatelayeredBSDFrandomwalkwithRussianroulette-0"></span><div class="fragmentname">&lt;&lt;Possibly terminate layered BSDF random walk with Russian roulette&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">if (depth &gt; 3 &amp;&amp; beta.<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum::MaxComponentValue" class="code">MaxComponentValue</a>() &lt; 0.25f) {
    Float q = std::max&lt;Float&gt;(0, 1 - beta.<a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum::MaxComponentValue" class="code">MaxComponentValue</a>());
    if (r() &lt; q) break;
    beta /= 1 - q;
}</div><p>


</p>
<p>The common case of no scattering in the medium is handled separately since
it is much simpler than the case where volumetric scattering must be
considered.

</p>
<p></p>
<span class="anchor" id="fragment-Accountformediabetweenlayersandpossiblyscatter-0"></span><div class="fragmentname">&lt;&lt;Account for media between layers and possibly scatter&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">if (!<a href="#LayeredBxDF::albedo" class="code">albedo</a>) {
    &lt;&lt;<span class="fragmentname"><a href="#fragment-Advancetonextlayerboundaryandupdatemonobetafortransmittance-0">Advance to next layer boundary and update <tt>beta</tt> for transmittance</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2364" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2364"><i></i></a><div id="fragbit-2364" class="collapse show"><div class="fragmentcode">       z = (z == <a href="#LayeredBxDF::thickness" class="code">thickness</a>) ? 0 : <a href="#LayeredBxDF::thickness" class="code">thickness</a>;
       beta *= <a href="#LayeredBxDF::Tr" class="code">Tr</a>(<a href="#LayeredBxDF::thickness" class="code">thickness</a>, w);</div></div>
} else {
    &lt;&lt;<span class="fragmentname"><a href="#fragment-SamplemediumscatteringforlayeredBSDFevaluation-0">Sample medium scattering for layered BSDF evaluation</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2365" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2365"><i></i></a><div id="fragbit-2365" class="collapse show"><div class="fragmentcode">       Float sigma_t = 1;
       Float dz = <a href="../Sampling_Algorithms/Sampling_1D_Functions.html#SampleExponential" class="code">SampleExponential</a>(r(), sigma_t / std::abs(w.z));
       Float zp = w.z &gt; 0 ? (z + dz) : (z - dz);
       if (0 &lt; zp &amp;&amp; zp &lt; <a href="#LayeredBxDF::thickness" class="code">thickness</a>) {
           &lt;&lt;<span class="fragmentname"><a href="#fragment-HandlescatteringeventinlayeredBSDFmedium-0">Handle scattering event in layered BSDF medium</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2366" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2366"><i></i></a><div id="fragbit-2366" class="collapse show"><div class="fragmentcode">              &lt;&lt;<span class="fragmentname"><a href="#fragment-AccountforscatteringthroughmonoexitInterfaceusingmonowis-0">Account for scattering through <tt>exitInterface</tt> using <tt>wis</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2367" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2367"><i></i></a><div id="fragbit-2367" class="collapse show"><div class="fragmentcode">                 Float wt = 1;
                 if (!<a href="../Reflection_Models/BSDF_Representation.html#BxDFFlags::IsSpecular" class="code">IsSpecular</a>(exitInterface.<a href="../Reflection_Models/BSDF_Representation.html#BxDF::Flags" class="code">Flags</a>()))
                     wt = <a href="../Monte_Carlo_Integration/Improving_Efficiency.html#PowerHeuristic" class="code">PowerHeuristic</a>(1, wis-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::pdf" class="code">pdf</a>, 1, phase.<a href="../Volume_Scattering/Phase_Functions.html#HGPhaseFunction::PDF" class="code">PDF</a>(-w, -wis-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>));
                 <a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::f" class="code">f</a> += beta * <a href="#LayeredBxDF::albedo" class="code">albedo</a> * phase.<a href="../Volume_Scattering/Phase_Functions.html#HGPhaseFunction::p" class="code">p</a>(-w, -wis-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>) * wt * <a href="#LayeredBxDF::Tr" class="code">Tr</a>(zp - exitZ, wis-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>) *
                      wis-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::f" class="code">f</a> / wis-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::pdf" class="code">pdf</a>;</div></div>
              &lt;&lt;<span class="fragmentname"><a href="#fragment-Samplephasefunctionandupdatelayeredpathstate-0">Sample phase function and update layered path state</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2368" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2368"><i></i></a><div id="fragbit-2368" class="collapse show"><div class="fragmentcode">                 <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a> u{r(), r()};
                 pstd::optional&lt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample" class="code">PhaseFunctionSample</a>&gt; ps = phase.<a href="../Volume_Scattering/Phase_Functions.html#HGPhaseFunction::Sample_p" class="code">Sample_p</a>(-w, u);
                 if (!ps || ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::pdf" class="code">pdf</a> == 0 || ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::wi" class="code">wi</a>.z == 0)
                     continue;
                 beta *= <a href="#LayeredBxDF::albedo" class="code">albedo</a> * ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::p" class="code">p</a> / ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::pdf" class="code">pdf</a>;
                 w = ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::wi" class="code">wi</a>;
                 z = zp;</div></div>
              &lt;&lt;<span class="fragmentname"><a href="#fragment-PossiblyaccountforscatteringthroughmonoexitInterface-0">Possibly account for scattering through <tt>exitInterface</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2369" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2369"><i></i></a><div id="fragbit-2369" class="collapse show"><div class="fragmentcode">                 if (((z &lt; exitZ &amp;&amp; w.z &gt; 0) || (z &gt; exitZ &amp;&amp; w.z &lt; 0)) &amp;&amp; 
                      !<a href="../Reflection_Models/BSDF_Representation.html#BxDFFlags::IsSpecular" class="code">IsSpecular</a>(exitInterface.<a href="../Reflection_Models/BSDF_Representation.html#BxDF::Flags" class="code">Flags</a>())) {
                     &lt;&lt;<span class="fragmentname"><a href="#fragment-AccountforscatteringthroughmonoexitInterface-0">Account for scattering through <tt>exitInterface</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2370" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2370"><i></i></a><div id="fragbit-2370" class="collapse show"><div class="fragmentcode">                        <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> fExit = exitInterface.<a href="../Reflection_Models/BSDF_Representation.html#BxDF::f" class="code">f</a>(-w, <a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::wi" class="code">wi</a>, mode);
                        if (fExit) {
                            Float exitPDF =
                                exitInterface.<a href="../Reflection_Models/BSDF_Representation.html#BxDF::PDF" class="code">PDF</a>(-w, <a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::wi" class="code">wi</a>, mode, BxDFReflTransFlags::Transmission);
                            Float wt = <a href="../Monte_Carlo_Integration/Improving_Efficiency.html#PowerHeuristic" class="code">PowerHeuristic</a>(1, ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::pdf" class="code">pdf</a>, 1, exitPDF);
                            <a href="../Reflection_Models/BSDF_Representation.html#BxDF::f" class="code">f</a> += beta * <a href="#LayeredBxDF::Tr" class="code">Tr</a>(zp - exitZ, ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::wi" class="code">wi</a>) * fExit * wt;
                        }</div></div>
                 }</div></div></div></div>
           continue;
       }
       z = <a href="../Utilities/Mathematical_Infrastructure.html#Clamp" class="code">Clamp</a>(zp, 0, <a href="#LayeredBxDF::thickness" class="code">thickness</a>);</div></div> 
}</div><p>


</p>
<p>If there is no medium scattering, then only the first term of
Equation&nbsp;(<a href="#eq:eot-1d">14.31</a>) needs to be evaluated.  The path vertices
alternate between the two interfaces.  Here <tt>beta</tt> is multiplied by
the transmittance for the ray segment through the medium; the <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.637ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 1135.4 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">upper L Subscript normal o</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D43F" d="M643 247c0 0 0 -3 -4 -14l-79 -216c-6 -17 -7 -17 -31 -17h-463c-18 0 -27 0 -27 11c0 20 10 20 27 20c79 0 81 8 91 47l134 537c3 12 4 15 4 19c0 13 -9 14 -27 16c-17 2 -38 2 -38 2c-19 0 -28 0 -28 11c0 20 12 20 19 20l133 -3l148 3c5 0 16 0 16 -12 c0 -19 -8 -19 -38 -19c-94 0 -97 -11 -106 -47l-135 -540c-5 -18 -5 -20 -5 -23c0 -8 3 -9 13 -10c6 -1 8 -1 22 -1h94c173 0 217 114 251 206c7 16 8 21 17 21s12 -7 12 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6F" d="M471 214c0 -127 -101 -225 -222 -225c-117 0 -221 96 -221 225c0 125 97 234 222 234c121 0 221 -106 221 -234zM388 222c0 38 0 96 -26 139s-69 65 -113 65c-40 0 -87 -21 -114 -67c-24 -44 -24 -98 -24 -137c0 -36 0 -97 25 -141c27 -46 71 -67 114 -67 c50 0 94 29 116 74c22 44 22 98 22 134Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D43F" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6F" x="963" y="-213"></use>
</g>
</svg>
factor is found by estimating Equation&nbsp;(<a href="#eq:boundary-scattering-1d">14.32</a>),
which will be handled shortly.

</p>
<p></p>
<span class="anchor" id="fragment-Advancetonextlayerboundaryandupdatemonobetafortransmittance-0"></span><div class="fragmentname">&lt;&lt;Advance to next layer boundary and update <tt>beta</tt> for transmittance&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">z = (z == <a href="#LayeredBxDF::thickness" class="code">thickness</a>) ? 0 : <a href="#LayeredBxDF::thickness" class="code">thickness</a>;
beta *= <a href="#LayeredBxDF::Tr" class="code">Tr</a>(<a href="#LayeredBxDF::thickness" class="code">thickness</a>, w);</div><p>


</p>
<p>If the medium is scattering, we only sample one of the two terms of the 1D
equation of transfer, choosing between taking a sample inside the medium
and scattering at the other interface.  A change in depth <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="3.022ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 1301 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">normal upper Delta z</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-394" d="M785 8c0 -8 -6 -8 -22 -8h-694c-16 0 -22 0 -22 8c0 0 0 3 5 12l338 678c7 13 9 18 26 18s19 -5 26 -18l338 -678c5 -9 5 -12 5 -12zM653 76l-269 540l-270 -540h539Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D467" d="M467 432c0 -4 -22 -52 -117 -145c-36 -36 -98 -90 -98 -90c-36 -31 -65 -56 -119 -114c9 3 27 3 27 3c21 0 36 -4 70 -17c21 -7 39 -13 59 -13c33 0 97 19 120 84c3 7 5 13 14 13c8 0 12 -5 12 -10c0 -27 -58 -154 -157 -154c-29 0 -47 16 -64 37c-25 29 -35 38 -58 38 c-32 0 -62 -27 -85 -62c-6 -11 -8 -13 -16 -13c0 0 -12 0 -12 10c0 7 35 64 103 131l90 84c19 16 103 88 139 131c-26 0 -37 0 -77 15c-23 8 -42 15 -63 15c-8 0 -66 -1 -85 -47c-2 -6 -4 -11 -13 -11s-12 6 -12 11c0 21 46 114 121 114c33 0 50 -20 69 -43 c15 -17 27 -32 51 -32s45 16 75 64c5 9 8 11 15 11c0 0 11 0 11 -10Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-394" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D467" x="833" y="0"></use>
</g>
</svg> can be perfectly
sampled from the 1D beam transmittance,
Equation&nbsp;(<a href="#eq:beamtrans-1d-homogeneous">14.30</a>).  Since <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="6.46ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 2781.5 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">sigma Subscript normal t Baseline equals 1</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D70E" d="M567 407c0 -34 -36 -34 -49 -34h-110c31 -44 31 -92 31 -109c0 -154 -133 -275 -251 -275c-91 0 -150 70 -150 158c0 119 111 284 262 284h228c18 0 39 0 39 -24zM375 276c0 31 -8 97 -92 97c-34 0 -94 -14 -136 -83c-35 -59 -47 -141 -47 -171c0 -72 40 -108 89 -108 c39 0 93 26 132 85c34 51 54 133 54 180Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-74" d="M332 124c0 -64 -28 -135 -99 -135c-36 0 -129 12 -129 135v276h-85v22c98 4 128 111 129 193h25v-184h143v-31h-143v-278c0 -17 0 -108 67 -108c37 0 67 38 67 112v55h25v-57Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3D" d="M722 347c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20zM722 153c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D70E" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-74" x="808" y="-213"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="1224" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-31" x="2280" y="0"></use>
</g>
</svg>, the PDF
is
</p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">
<div class="displaymath"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="20.103ex" height="6.343ex" style="vertical-align: -2.671ex; margin-left: -0.073ex;" viewBox="-31.5 -1580.7 8655.5 2730.8" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">p left-parenthesis normal upper Delta z right-parenthesis equals StartFraction 1 Over StartAbsoluteValue omega Subscript Baseline Subscript z Baseline EndAbsoluteValue EndFraction normal e Superscript minus StartFraction normal upper Delta z Over StartAbsoluteValue omega Super Subscript Superscript Super Subscript z Superscript EndAbsoluteValue EndFraction Baseline period</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45D" d="M490 282c0 -147 -125 -293 -241 -293c-51 0 -79 35 -92 64c-7 -25 -49 -188 -49 -200c0 -9 0 -16 50 -16c14 0 24 0 24 -11c0 -20 -13 -20 -18 -20c-32 0 -66 3 -99 3c-28 0 -57 -3 -84 -3c-8 0 -13 4 -13 12c0 19 11 19 23 19c44 0 46 7 54 41l112 445c4 17 7 28 7 51 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c37 0 80 -21 90 -75c33 39 81 75 131 75c76 0 133 -66 133 -160zM418 326c0 59 -24 94 -64 94c-17 0 -46 -7 -81 -38c-18 -15 -45 -43 -52 -70 l-49 -196c-3 -12 -3 -16 -3 -16c0 -6 13 -89 79 -89c37 0 85 33 119 103c18 38 51 153 51 212Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-394" d="M785 8c0 -8 -6 -8 -22 -8h-694c-16 0 -22 0 -22 8c0 0 0 3 5 12l338 678c7 13 9 18 26 18s19 -5 26 -18l338 -678c5 -9 5 -12 5 -12zM653 76l-269 540l-270 -540h539Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D467" d="M467 432c0 -4 -22 -52 -117 -145c-36 -36 -98 -90 -98 -90c-36 -31 -65 -56 -119 -114c9 3 27 3 27 3c21 0 36 -4 70 -17c21 -7 39 -13 59 -13c33 0 97 19 120 84c3 7 5 13 14 13c8 0 12 -5 12 -10c0 -27 -58 -154 -157 -154c-29 0 -47 16 -64 37c-25 29 -35 38 -58 38 c-32 0 -62 -27 -85 -62c-6 -11 -8 -13 -16 -13c0 0 -12 0 -12 10c0 7 35 64 103 131l90 84c19 16 103 88 139 131c-26 0 -37 0 -77 15c-23 8 -42 15 -63 15c-8 0 -66 -1 -85 -47c-2 -6 -4 -11 -13 -11s-12 6 -12 11c0 21 46 114 121 114c33 0 50 -20 69 -43 c15 -17 27 -32 51 -32s45 16 75 64c5 9 8 11 15 11c0 0 11 0 11 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3D" d="M722 347c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20zM722 153c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-7C" d="M159 -230c0 -11 -9 -20 -20 -20s-20 9 -20 20v960c0 11 9 20 20 20s20 -9 20 -20v-960Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-65" d="M415 119c0 -19 -45 -130 -167 -130c-115 0 -220 97 -220 231c0 125 92 228 208 228c125 0 179 -97 179 -196c0 -21 -3 -21 -25 -21h-279c0 -36 0 -102 30 -150c23 -37 63 -67 113 -67c10 0 100 0 135 103c2 8 4 14 13 14c5 0 13 -2 13 -12zM349 252 c0 39 -10 174 -113 174c-34 0 -118 -25 -124 -174h237Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2212" d="M722 250c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2E" d="M192 53c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="503" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-394" x="893" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D467" x="1726" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="2194" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="2861" y="0"></use>
<g transform="translate(3639,0)">
<g transform="translate(397,0)">
<rect stroke="none" width="1730" height="60" x="0" y="220"></rect>
 <use xlink:href="#E1-LATINMODERNMAIN-31" x="614" y="676"></use>
<g transform="translate(60,-771)">
 <use xlink:href="#E1-LATINMODERNMAIN-7C" x="0" y="0"></use>
<g transform="translate(278,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D467" x="880" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-7C" x="1331" y="0"></use>
</g>
</g>
</g>
<g transform="translate(5887,0)">
 <use xlink:href="#E1-LATINMODERNMAIN-65" x="0" y="0"></use>
<g transform="translate(444,700)">
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="0" y="0"></use>
<g transform="translate(550,0)">
<g transform="translate(120,0)">
<rect stroke="none" width="1122" height="60" x="0" y="146"></rect>
<g transform="translate(188,378)">
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNMAIN-394" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNNORMAL-1D467" x="833" y="0"></use>
</g>
<g transform="translate(60,-449)">
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNMAIN-7C" x="0" y="0"></use>
<g transform="translate(159,0)">
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNNORMAL-1D467" x="622" y="-150"></use>
</g>
 <use transform="scale(0.574)" xlink:href="#E1-LATINMODERNMAIN-7C" x="1468" y="0"></use>
</g>
</g>
</g>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2E" x="8345" y="0"></use>
</g>
</svg>
</div>
<p>


</p>
<p>Given a depth <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.989ex" height="2.343ex" style="vertical-align: -0.338ex;" viewBox="0 -863.1 856.3 1008.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">z prime</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D467" d="M467 432c0 -4 -22 -52 -117 -145c-36 -36 -98 -90 -98 -90c-36 -31 -65 -56 -119 -114c9 3 27 3 27 3c21 0 36 -4 70 -17c21 -7 39 -13 59 -13c33 0 97 19 120 84c3 7 5 13 14 13c8 0 12 -5 12 -10c0 -27 -58 -154 -157 -154c-29 0 -47 16 -64 37c-25 29 -35 38 -58 38 c-32 0 -62 -27 -85 -62c-6 -11 -8 -13 -16 -13c0 0 -12 0 -12 10c0 7 35 64 103 131l90 84c19 16 103 88 139 131c-26 0 -37 0 -77 15c-23 8 -42 15 -63 15c-8 0 -66 -1 -85 -47c-2 -6 -4 -11 -13 -11s-12 6 -12 11c0 21 46 114 121 114c33 0 50 -20 69 -43 c15 -17 27 -32 51 -32s45 16 75 64c5 9 8 11 15 11c0 0 11 0 11 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNVARIANTS-2032" d="M340 496c0 -10 -3 -20 -8 -28l-227 -372h-38l171 424c6 15 26 29 48 29c30 0 54 -24 54 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D467" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNVARIANTS-2032" x="662" y="513"></use>
</g>
</svg> found by adding or subtracting <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="3.022ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 1301 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">normal upper Delta z</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-394" d="M785 8c0 -8 -6 -8 -22 -8h-694c-16 0 -22 0 -22 8c0 0 0 3 5 12l338 678c7 13 9 18 26 18s19 -5 26 -18l338 -678c5 -9 5 -12 5 -12zM653 76l-269 540l-270 -540h539Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D467" d="M467 432c0 -4 -22 -52 -117 -145c-36 -36 -98 -90 -98 -90c-36 -31 -65 -56 -119 -114c9 3 27 3 27 3c21 0 36 -4 70 -17c21 -7 39 -13 59 -13c33 0 97 19 120 84c3 7 5 13 14 13c8 0 12 -5 12 -10c0 -27 -58 -154 -157 -154c-29 0 -47 16 -64 37c-25 29 -35 38 -58 38 c-32 0 -62 -27 -85 -62c-6 -11 -8 -13 -16 -13c0 0 -12 0 -12 10c0 7 35 64 103 131l90 84c19 16 103 88 139 131c-26 0 -37 0 -77 15c-23 8 -42 15 -63 15c-8 0 -66 -1 -85 -47c-2 -6 -4 -11 -13 -11s-12 6 -12 11c0 21 46 114 121 114c33 0 50 -20 69 -43 c15 -17 27 -32 51 -32s45 16 75 64c5 9 8 11 15 11c0 0 11 0 11 -10Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-394" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D467" x="833" y="0"></use>
</g>
</svg> from the
current depth <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.086ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 467.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">z</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D467" d="M467 432c0 -4 -22 -52 -117 -145c-36 -36 -98 -90 -98 -90c-36 -31 -65 -56 -119 -114c9 3 27 3 27 3c21 0 36 -4 70 -17c21 -7 39 -13 59 -13c33 0 97 19 120 84c3 7 5 13 14 13c8 0 12 -5 12 -10c0 -27 -58 -154 -157 -154c-29 0 -47 16 -64 37c-25 29 -35 38 -58 38 c-32 0 -62 -27 -85 -62c-6 -11 -8 -13 -16 -13c0 0 -12 0 -12 10c0 7 35 64 103 131l90 84c19 16 103 88 139 131c-26 0 -37 0 -77 15c-23 8 -42 15 -63 15c-8 0 -66 -1 -85 -47c-2 -6 -4 -11 -13 -11s-12 6 -12 11c0 21 46 114 121 114c33 0 50 -20 69 -43 c15 -17 27 -32 51 -32s45 16 75 64c5 9 8 11 15 11c0 0 11 0 11 -10Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D467" x="0" y="0"></use>
</g>
</svg> according to the ray&rsquo;s direction, medium scattering
is chosen if <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.989ex" height="2.343ex" style="vertical-align: -0.338ex;" viewBox="0 -863.1 856.3 1008.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">z prime</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D467" d="M467 432c0 -4 -22 -52 -117 -145c-36 -36 -98 -90 -98 -90c-36 -31 -65 -56 -119 -114c9 3 27 3 27 3c21 0 36 -4 70 -17c21 -7 39 -13 59 -13c33 0 97 19 120 84c3 7 5 13 14 13c8 0 12 -5 12 -10c0 -27 -58 -154 -157 -154c-29 0 -47 16 -64 37c-25 29 -35 38 -58 38 c-32 0 -62 -27 -85 -62c-6 -11 -8 -13 -16 -13c0 0 -12 0 -12 10c0 7 35 64 103 131l90 84c19 16 103 88 139 131c-26 0 -37 0 -77 15c-23 8 -42 15 -63 15c-8 0 -66 -1 -85 -47c-2 -6 -4 -11 -13 -11s-12 6 -12 11c0 21 46 114 121 114c33 0 50 -20 69 -43 c15 -17 27 -32 51 -32s45 16 75 64c5 9 8 11 15 11c0 0 11 0 11 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNVARIANTS-2032" d="M340 496c0 -10 -3 -20 -8 -28l-227 -372h-38l171 424c6 15 26 29 48 29c30 0 54 -24 54 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D467" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNVARIANTS-2032" x="662" y="513"></use>
</g>
</svg> is inside the medium and surface scattering is chosen
otherwise.  (The sampling scheme is thus similar to how the
<a href="../Light_Transport_II_Volume_Rendering/Volume_Scattering_Integrators.html#VolPathIntegrator"><tt>VolPathIntegrator</tt></a> chooses between medium and surface scattering.)  In
the case of scattering from an interface, the <tt>Clamp()</tt> call effectively
forces <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.086ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 467.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">z</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D467" d="M467 432c0 -4 -22 -52 -117 -145c-36 -36 -98 -90 -98 -90c-36 -31 -65 -56 -119 -114c9 3 27 3 27 3c21 0 36 -4 70 -17c21 -7 39 -13 59 -13c33 0 97 19 120 84c3 7 5 13 14 13c8 0 12 -5 12 -10c0 -27 -58 -154 -157 -154c-29 0 -47 16 -64 37c-25 29 -35 38 -58 38 c-32 0 -62 -27 -85 -62c-6 -11 -8 -13 -16 -13c0 0 -12 0 -12 10c0 7 35 64 103 131l90 84c19 16 103 88 139 131c-26 0 -37 0 -77 15c-23 8 -42 15 -63 15c-8 0 -66 -1 -85 -47c-2 -6 -4 -11 -13 -11s-12 6 -12 11c0 21 46 114 121 114c33 0 50 -20 69 -43 c15 -17 27 -32 51 -32s45 16 75 64c5 9 8 11 15 11c0 0 11 0 11 -10Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D467" x="0" y="0"></use>
</g>
</svg> to lie on whichever of the two interfaces the ray intersects
next.

</p>
<p></p>
<span class="anchor" id="fragment-SamplemediumscatteringforlayeredBSDFevaluation-0"></span><div class="fragmentname">&lt;&lt;Sample medium scattering for layered BSDF evaluation&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">Float sigma_t = 1;
Float dz = <a href="../Sampling_Algorithms/Sampling_1D_Functions.html#SampleExponential" class="code">SampleExponential</a>(r(), sigma_t / std::abs(w.z));
Float zp = w.z &gt; 0 ? (z + dz) : (z - dz);
if (0 &lt; zp &amp;&amp; zp &lt; <a href="#LayeredBxDF::thickness" class="code">thickness</a>) {
    &lt;&lt;<span class="fragmentname"><a href="#fragment-HandlescatteringeventinlayeredBSDFmedium-0">Handle scattering event in layered BSDF medium</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2371" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2371"><i></i></a><div id="fragbit-2371" class="collapse show"><div class="fragmentcode">       &lt;&lt;<span class="fragmentname"><a href="#fragment-AccountforscatteringthroughmonoexitInterfaceusingmonowis-0">Account for scattering through <tt>exitInterface</tt> using <tt>wis</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2372" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2372"><i></i></a><div id="fragbit-2372" class="collapse show"><div class="fragmentcode">          Float wt = 1;
          if (!<a href="../Reflection_Models/BSDF_Representation.html#BxDFFlags::IsSpecular" class="code">IsSpecular</a>(exitInterface.<a href="../Reflection_Models/BSDF_Representation.html#BxDF::Flags" class="code">Flags</a>()))
              wt = <a href="../Monte_Carlo_Integration/Improving_Efficiency.html#PowerHeuristic" class="code">PowerHeuristic</a>(1, wis-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::pdf" class="code">pdf</a>, 1, phase.<a href="../Volume_Scattering/Phase_Functions.html#HGPhaseFunction::PDF" class="code">PDF</a>(-w, -wis-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>));
          <a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::f" class="code">f</a> += beta * <a href="#LayeredBxDF::albedo" class="code">albedo</a> * phase.<a href="../Volume_Scattering/Phase_Functions.html#HGPhaseFunction::p" class="code">p</a>(-w, -wis-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>) * wt * <a href="#LayeredBxDF::Tr" class="code">Tr</a>(zp - exitZ, wis-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>) *
               wis-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::f" class="code">f</a> / wis-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::pdf" class="code">pdf</a>;</div></div>
       &lt;&lt;<span class="fragmentname"><a href="#fragment-Samplephasefunctionandupdatelayeredpathstate-0">Sample phase function and update layered path state</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2373" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2373"><i></i></a><div id="fragbit-2373" class="collapse show"><div class="fragmentcode">          <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a> u{r(), r()};
          pstd::optional&lt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample" class="code">PhaseFunctionSample</a>&gt; ps = phase.<a href="../Volume_Scattering/Phase_Functions.html#HGPhaseFunction::Sample_p" class="code">Sample_p</a>(-w, u);
          if (!ps || ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::pdf" class="code">pdf</a> == 0 || ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::wi" class="code">wi</a>.z == 0)
              continue;
          beta *= <a href="#LayeredBxDF::albedo" class="code">albedo</a> * ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::p" class="code">p</a> / ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::pdf" class="code">pdf</a>;
          w = ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::wi" class="code">wi</a>;
          z = zp;</div></div>
       &lt;&lt;<span class="fragmentname"><a href="#fragment-PossiblyaccountforscatteringthroughmonoexitInterface-0">Possibly account for scattering through <tt>exitInterface</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2374" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2374"><i></i></a><div id="fragbit-2374" class="collapse show"><div class="fragmentcode">          if (((z &lt; exitZ &amp;&amp; w.z &gt; 0) || (z &gt; exitZ &amp;&amp; w.z &lt; 0)) &amp;&amp; 
               !<a href="../Reflection_Models/BSDF_Representation.html#BxDFFlags::IsSpecular" class="code">IsSpecular</a>(exitInterface.<a href="../Reflection_Models/BSDF_Representation.html#BxDF::Flags" class="code">Flags</a>())) {
              &lt;&lt;<span class="fragmentname"><a href="#fragment-AccountforscatteringthroughmonoexitInterface-0">Account for scattering through <tt>exitInterface</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2375" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2375"><i></i></a><div id="fragbit-2375" class="collapse show"><div class="fragmentcode">                 <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> fExit = exitInterface.<a href="../Reflection_Models/BSDF_Representation.html#BxDF::f" class="code">f</a>(-w, <a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::wi" class="code">wi</a>, mode);
                 if (fExit) {
                     Float exitPDF =
                         exitInterface.<a href="../Reflection_Models/BSDF_Representation.html#BxDF::PDF" class="code">PDF</a>(-w, <a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::wi" class="code">wi</a>, mode, BxDFReflTransFlags::Transmission);
                     Float wt = <a href="../Monte_Carlo_Integration/Improving_Efficiency.html#PowerHeuristic" class="code">PowerHeuristic</a>(1, ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::pdf" class="code">pdf</a>, 1, exitPDF);
                     <a href="../Reflection_Models/BSDF_Representation.html#BxDF::f" class="code">f</a> += beta * <a href="#LayeredBxDF::Tr" class="code">Tr</a>(zp - exitZ, ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::wi" class="code">wi</a>) * fExit * wt;
                 }</div></div>
          }</div></div></div></div>
    continue;
}
z = <a href="../Utilities/Mathematical_Infrastructure.html#Clamp" class="code">Clamp</a>(zp, 0, <a href="#LayeredBxDF::thickness" class="code">thickness</a>);</div><p>


</p>
<p>If <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.989ex" height="2.343ex" style="vertical-align: -0.338ex;" viewBox="0 -863.1 856.3 1008.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">z prime</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D467" d="M467 432c0 -4 -22 -52 -117 -145c-36 -36 -98 -90 -98 -90c-36 -31 -65 -56 -119 -114c9 3 27 3 27 3c21 0 36 -4 70 -17c21 -7 39 -13 59 -13c33 0 97 19 120 84c3 7 5 13 14 13c8 0 12 -5 12 -10c0 -27 -58 -154 -157 -154c-29 0 -47 16 -64 37c-25 29 -35 38 -58 38 c-32 0 -62 -27 -85 -62c-6 -11 -8 -13 -16 -13c0 0 -12 0 -12 10c0 7 35 64 103 131l90 84c19 16 103 88 139 131c-26 0 -37 0 -77 15c-23 8 -42 15 -63 15c-8 0 -66 -1 -85 -47c-2 -6 -4 -11 -13 -11s-12 6 -12 11c0 21 46 114 121 114c33 0 50 -20 69 -43 c15 -17 27 -32 51 -32s45 16 75 64c5 9 8 11 15 11c0 0 11 0 11 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNVARIANTS-2032" d="M340 496c0 -10 -3 -20 -8 -28l-227 -372h-38l171 424c6 15 26 29 48 29c30 0 54 -24 54 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D467" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNVARIANTS-2032" x="662" y="513"></use>
</g>
</svg> is inside the medium, we have the estimator
</p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">
<div class="displaymath"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="23.152ex" height="6.509ex" style="vertical-align: -2.671ex;" viewBox="0 -1652.5 9968 2802.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">StartFraction upper T Subscript normal r Baseline left-parenthesis z right-arrow z Superscript prime Baseline right-parenthesis upper L Subscript normal s Superscript Baseline left-parenthesis z prime comma minus omega Subscript Baseline right-parenthesis Over p left-parenthesis normal upper Delta z right-parenthesis StartAbsoluteValue omega Subscript Baseline Subscript z Baseline EndAbsoluteValue EndFraction period</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D447" d="M704 666c0 -3 -1 -13 -2 -17l-27 -174c-2 -15 -4 -23 -15 -23c-9 0 -12 7 -12 13c0 3 2 15 3 19c4 26 8 65 8 80c0 78 -45 82 -146 82c-21 0 -54 0 -63 -2c-12 -3 -16 -9 -23 -37l-133 -531c-4 -15 -4 -21 -4 -21c0 -16 8 -19 37 -22c26 -2 39 -2 64 -2c26 0 34 0 34 -11 c0 -20 -12 -20 -22 -20c-28 0 -58 2 -87 2l-83 1l-85 -1c-27 0 -55 -2 -82 -2c-6 0 -17 0 -17 12c0 19 6 19 42 19c107 0 110 11 119 48l134 534c1 3 4 15 4 21c0 8 0 12 -28 12h-39c-148 0 -174 -18 -228 -173c-6 -16 -7 -21 -17 -21c-7 0 -12 5 -12 11c0 0 5 16 6 18 l60 176c7 19 8 20 32 20h555c17 0 27 0 27 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-72" d="M364 381c0 -32 -25 -44 -43 -44c-22 0 -43 15 -43 43c0 26 20 38 23 39c-2 1 -4 1 -11 1c-76 0 -118 -89 -118 -188v-154c0 -36 2 -47 76 -47h21v-31c-40 3 -87 3 -127 3l-114 -3v31c67 0 78 0 78 45v268c0 49 -8 56 -78 56v31l139 11v-110c14 43 50 110 123 110 c43 0 74 -29 74 -61Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D467" d="M467 432c0 -4 -22 -52 -117 -145c-36 -36 -98 -90 -98 -90c-36 -31 -65 -56 -119 -114c9 3 27 3 27 3c21 0 36 -4 70 -17c21 -7 39 -13 59 -13c33 0 97 19 120 84c3 7 5 13 14 13c8 0 12 -5 12 -10c0 -27 -58 -154 -157 -154c-29 0 -47 16 -64 37c-25 29 -35 38 -58 38 c-32 0 -62 -27 -85 -62c-6 -11 -8 -13 -16 -13c0 0 -12 0 -12 10c0 7 35 64 103 131l90 84c19 16 103 88 139 131c-26 0 -37 0 -77 15c-23 8 -42 15 -63 15c-8 0 -66 -1 -85 -47c-2 -6 -4 -11 -13 -11s-12 6 -12 11c0 21 46 114 121 114c33 0 50 -20 69 -43 c15 -17 27 -32 51 -32s45 16 75 64c5 9 8 11 15 11c0 0 11 0 11 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2192" d="M943 250c0 -6 -4 -11 -9 -13c-57 -19 -101 -59 -137 -104c-28 -36 -49 -80 -58 -127c-2 -9 -10 -16 -20 -16c-11 0 -20 9 -20 20c0 1 1 3 1 4c10 53 33 102 66 144c22 28 48 52 78 72h-766c-11 0 -20 9 -20 20s9 20 20 20h766c-30 20 -56 44 -78 72 c-33 42 -56 91 -66 144c0 1 -1 3 -1 4c0 11 9 20 20 20c10 0 18 -7 20 -16c9 -47 30 -91 58 -127c36 -45 80 -85 137 -104c5 -2 9 -7 9 -13Z"></path>
<path stroke-width="1" id="E1-LATINMODERNVARIANTS-2032" d="M340 496c0 -10 -3 -20 -8 -28l-227 -372h-38l171 424c6 15 26 29 48 29c30 0 54 -24 54 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D43F" d="M643 247c0 0 0 -3 -4 -14l-79 -216c-6 -17 -7 -17 -31 -17h-463c-18 0 -27 0 -27 11c0 20 10 20 27 20c79 0 81 8 91 47l134 537c3 12 4 15 4 19c0 13 -9 14 -27 16c-17 2 -38 2 -38 2c-19 0 -28 0 -28 11c0 20 12 20 19 20l133 -3l148 3c5 0 16 0 16 -12 c0 -19 -8 -19 -38 -19c-94 0 -97 -11 -106 -47l-135 -540c-5 -18 -5 -20 -5 -23c0 -8 3 -9 13 -10c6 -1 8 -1 22 -1h94c173 0 217 114 251 206c7 16 8 21 17 21s12 -7 12 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-73" d="M360 128c0 -72 -46 -139 -161 -139c-21 0 -66 1 -110 43c-18 -19 -18 -21 -20 -23c-19 -19 -20 -20 -25 -20c-11 0 -11 7 -11 24v132c0 18 0 25 13 25c10 0 11 -4 14 -17c19 -85 55 -142 139 -142c78 0 113 40 113 91c0 72 -82 88 -104 92c-72 14 -100 20 -132 46 c-27 22 -43 50 -43 85c0 56 38 123 160 123c15 0 56 0 94 -28c4 3 14 12 17 16c13 12 15 12 20 12c11 0 11 -7 11 -24v-101c0 -19 0 -24 -13 -24c0 0 -11 0 -12 9c-2 31 -7 121 -117 121c-86 0 -112 -41 -112 -76c0 -58 67 -71 123 -82c42 -8 81 -16 114 -48 c12 -12 42 -42 42 -95Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2212" d="M722 250c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45D" d="M490 282c0 -147 -125 -293 -241 -293c-51 0 -79 35 -92 64c-7 -25 -49 -188 -49 -200c0 -9 0 -16 50 -16c14 0 24 0 24 -11c0 -20 -13 -20 -18 -20c-32 0 -66 3 -99 3c-28 0 -57 -3 -84 -3c-8 0 -13 4 -13 12c0 19 11 19 23 19c44 0 46 7 54 41l112 445c4 17 7 28 7 51 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c37 0 80 -21 90 -75c33 39 81 75 131 75c76 0 133 -66 133 -160zM418 326c0 59 -24 94 -64 94c-17 0 -46 -7 -81 -38c-18 -15 -45 -43 -52 -70 l-49 -196c-3 -12 -3 -16 -3 -16c0 -6 13 -89 79 -89c37 0 85 33 119 103c18 38 51 153 51 212Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-394" d="M785 8c0 -8 -6 -8 -22 -8h-694c-16 0 -22 0 -22 8c0 0 0 3 5 12l338 678c7 13 9 18 26 18s19 -5 26 -18l338 -678c5 -9 5 -12 5 -12zM653 76l-269 540l-270 -540h539Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-7C" d="M159 -230c0 -11 -9 -20 -20 -20s-20 9 -20 20v960c0 11 9 20 20 20s20 -9 20 -20v-960Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2E" d="M192 53c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
<g transform="translate(120,0)">
<rect stroke="none" width="9449" height="60" x="0" y="220"></rect>
<g transform="translate(60,768)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D447" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-72" x="826" y="-213"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="962" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D467" x="1351" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2192" x="2096" y="0"></use>
<g transform="translate(3375,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D467" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNVARIANTS-2032" x="662" y="513"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="4231" y="0"></use>
<g transform="translate(4787,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D43F" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-73" x="963" y="-213"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="1060" y="0"></use>
<g transform="translate(1449,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D467" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNVARIANTS-2032" x="662" y="513"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="2306" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2212" x="2751" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="3529" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="4152" y="0"></use>
</g>
</g>
<g transform="translate(2544,-771)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="503" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-394" x="893" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D467" x="1726" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="2194" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-7C" x="2750" y="0"></use>
<g transform="translate(3028,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D467" x="880" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-7C" x="4081" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2E" x="9689" y="0"></use>
</g>
</svg>
</div>
<p>

Both the exponential factors and <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="3.74ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 1610.1 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">StartAbsoluteValue omega Subscript z Baseline EndAbsoluteValue</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-7C" d="M159 -230c0 -11 -9 -20 -20 -20s-20 9 -20 20v960c0 11 9 20 20 20s20 -9 20 -20v-960Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D467" d="M467 432c0 -4 -22 -52 -117 -145c-36 -36 -98 -90 -98 -90c-36 -31 -65 -56 -119 -114c9 3 27 3 27 3c21 0 36 -4 70 -17c21 -7 39 -13 59 -13c33 0 97 19 120 84c3 7 5 13 14 13c8 0 12 -5 12 -10c0 -27 -58 -154 -157 -154c-29 0 -47 16 -64 37c-25 29 -35 38 -58 38 c-32 0 -62 -27 -85 -62c-6 -11 -8 -13 -16 -13c0 0 -12 0 -12 10c0 7 35 64 103 131l90 84c19 16 103 88 139 131c-26 0 -37 0 -77 15c-23 8 -42 15 -63 15c-8 0 -66 -1 -85 -47c-2 -6 -4 -11 -13 -11s-12 6 -12 11c0 21 46 114 121 114c33 0 50 -20 69 -43 c15 -17 27 -32 51 -32s45 16 75 64c5 9 8 11 15 11c0 0 11 0 11 -10Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-7C" x="0" y="0"></use>
<g transform="translate(278,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNNORMAL-1D467" x="880" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-7C" x="1331" y="0"></use>
</g>
</svg> factors in <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.234ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 962 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">upper T Subscript normal r</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D447" d="M704 666c0 -3 -1 -13 -2 -17l-27 -174c-2 -15 -4 -23 -15 -23c-9 0 -12 7 -12 13c0 3 2 15 3 19c4 26 8 65 8 80c0 78 -45 82 -146 82c-21 0 -54 0 -63 -2c-12 -3 -16 -9 -23 -37l-133 -531c-4 -15 -4 -21 -4 -21c0 -16 8 -19 37 -22c26 -2 39 -2 64 -2c26 0 34 0 34 -11 c0 -20 -12 -20 -22 -20c-28 0 -58 2 -87 2l-83 1l-85 -1c-27 0 -55 -2 -82 -2c-6 0 -17 0 -17 12c0 19 6 19 42 19c107 0 110 11 119 48l134 534c1 3 4 15 4 21c0 8 0 12 -28 12h-39c-148 0 -174 -18 -228 -173c-6 -16 -7 -21 -17 -21c-7 0 -12 5 -12 11c0 0 5 16 6 18 l60 176c7 19 8 20 32 20h555c17 0 27 0 27 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-72" d="M364 381c0 -32 -25 -44 -43 -44c-22 0 -43 15 -43 43c0 26 20 38 23 39c-2 1 -4 1 -11 1c-76 0 -118 -89 -118 -188v-154c0 -36 2 -47 76 -47h21v-31c-40 3 -87 3 -127 3l-114 -3v31c67 0 78 0 78 45v268c0 49 -8 56 -78 56v31l139 11v-110c14 43 50 110 123 110 c43 0 74 -29 74 -61Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D447" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-72" x="826" y="-213"></use>
</g>
</svg>
and <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="6.074ex" height="2.843ex" style="vertical-align: -0.838ex; margin-left: -0.073ex;" viewBox="-31.5 -863.1 2615 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">p left-parenthesis normal upper Delta z right-parenthesis</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45D" d="M490 282c0 -147 -125 -293 -241 -293c-51 0 -79 35 -92 64c-7 -25 -49 -188 -49 -200c0 -9 0 -16 50 -16c14 0 24 0 24 -11c0 -20 -13 -20 -18 -20c-32 0 -66 3 -99 3c-28 0 -57 -3 -84 -3c-8 0 -13 4 -13 12c0 19 11 19 23 19c44 0 46 7 54 41l112 445c4 17 7 28 7 51 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c37 0 80 -21 90 -75c33 39 81 75 131 75c76 0 133 -66 133 -160zM418 326c0 59 -24 94 -64 94c-17 0 -46 -7 -81 -38c-18 -15 -45 -43 -52 -70 l-49 -196c-3 -12 -3 -16 -3 -16c0 -6 13 -89 79 -89c37 0 85 33 119 103c18 38 51 153 51 212Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-394" d="M785 8c0 -8 -6 -8 -22 -8h-694c-16 0 -22 0 -22 8c0 0 0 3 5 12l338 678c7 13 9 18 26 18s19 -5 26 -18l338 -678c5 -9 5 -12 5 -12zM653 76l-269 540l-270 -540h539Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D467" d="M467 432c0 -4 -22 -52 -117 -145c-36 -36 -98 -90 -98 -90c-36 -31 -65 -56 -119 -114c9 3 27 3 27 3c21 0 36 -4 70 -17c21 -7 39 -13 59 -13c33 0 97 19 120 84c3 7 5 13 14 13c8 0 12 -5 12 -10c0 -27 -58 -154 -157 -154c-29 0 -47 16 -64 37c-25 29 -35 38 -58 38 c-32 0 -62 -27 -85 -62c-6 -11 -8 -13 -16 -13c0 0 -12 0 -12 10c0 7 35 64 103 131l90 84c19 16 103 88 139 131c-26 0 -37 0 -77 15c-23 8 -42 15 -63 15c-8 0 -66 -1 -85 -47c-2 -6 -4 -11 -13 -11s-12 6 -12 11c0 21 46 114 121 114c33 0 50 -20 69 -43 c15 -17 27 -32 51 -32s45 16 75 64c5 9 8 11 15 11c0 0 11 0 11 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="503" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-394" x="893" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D467" x="1726" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="2194" y="0"></use>
</g>
</svg> cancel, and we are left with simply
the source function <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="10.549ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 4541.9 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">upper L Subscript normal s Superscript Baseline left-parenthesis z prime comma minus omega Subscript Baseline right-parenthesis</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D43F" d="M643 247c0 0 0 -3 -4 -14l-79 -216c-6 -17 -7 -17 -31 -17h-463c-18 0 -27 0 -27 11c0 20 10 20 27 20c79 0 81 8 91 47l134 537c3 12 4 15 4 19c0 13 -9 14 -27 16c-17 2 -38 2 -38 2c-19 0 -28 0 -28 11c0 20 12 20 19 20l133 -3l148 3c5 0 16 0 16 -12 c0 -19 -8 -19 -38 -19c-94 0 -97 -11 -106 -47l-135 -540c-5 -18 -5 -20 -5 -23c0 -8 3 -9 13 -10c6 -1 8 -1 22 -1h94c173 0 217 114 251 206c7 16 8 21 17 21s12 -7 12 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-73" d="M360 128c0 -72 -46 -139 -161 -139c-21 0 -66 1 -110 43c-18 -19 -18 -21 -20 -23c-19 -19 -20 -20 -25 -20c-11 0 -11 7 -11 24v132c0 18 0 25 13 25c10 0 11 -4 14 -17c19 -85 55 -142 139 -142c78 0 113 40 113 91c0 72 -82 88 -104 92c-72 14 -100 20 -132 46 c-27 22 -43 50 -43 85c0 56 38 123 160 123c15 0 56 0 94 -28c4 3 14 12 17 16c13 12 15 12 20 12c11 0 11 -7 11 -24v-101c0 -19 0 -24 -13 -24c0 0 -11 0 -12 9c-2 31 -7 121 -117 121c-86 0 -112 -41 -112 -76c0 -58 67 -71 123 -82c42 -8 81 -16 114 -48 c12 -12 42 -42 42 -95Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D467" d="M467 432c0 -4 -22 -52 -117 -145c-36 -36 -98 -90 -98 -90c-36 -31 -65 -56 -119 -114c9 3 27 3 27 3c21 0 36 -4 70 -17c21 -7 39 -13 59 -13c33 0 97 19 120 84c3 7 5 13 14 13c8 0 12 -5 12 -10c0 -27 -58 -154 -157 -154c-29 0 -47 16 -64 37c-25 29 -35 38 -58 38 c-32 0 -62 -27 -85 -62c-6 -11 -8 -13 -16 -13c0 0 -12 0 -12 10c0 7 35 64 103 131l90 84c19 16 103 88 139 131c-26 0 -37 0 -77 15c-23 8 -42 15 -63 15c-8 0 -66 -1 -85 -47c-2 -6 -4 -11 -13 -11s-12 6 -12 11c0 21 46 114 121 114c33 0 50 -20 69 -43 c15 -17 27 -32 51 -32s45 16 75 64c5 9 8 11 15 11c0 0 11 0 11 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNVARIANTS-2032" d="M340 496c0 -10 -3 -20 -8 -28l-227 -372h-38l171 424c6 15 26 29 48 29c30 0 54 -24 54 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2212" d="M722 250c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D43F" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-73" x="963" y="-213"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="1060" y="0"></use>
<g transform="translate(1449,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D467" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNVARIANTS-2032" x="662" y="513"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="2306" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2212" x="2751" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="3529" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="4152" y="0"></use>
</g>
</svg>, which should be scaled by the path throughput. The following
fragment adds an estimate of its value to the sum in <tt>f</tt>.

</p>
<p></p>
<span class="anchor" id="fragment-HandlescatteringeventinlayeredBSDFmedium-0"></span><div class="fragmentname">&lt;&lt;Handle scattering event in layered BSDF medium&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">&lt;&lt;<span class="fragmentname"><a href="#fragment-AccountforscatteringthroughmonoexitInterfaceusingmonowis-0">Account for scattering through <tt>exitInterface</tt> using <tt>wis</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2376" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2376"><i></i></a><div id="fragbit-2376" class="collapse show"><div class="fragmentcode">   Float wt = 1;
   if (!<a href="../Reflection_Models/BSDF_Representation.html#BxDFFlags::IsSpecular" class="code">IsSpecular</a>(exitInterface.<a href="../Reflection_Models/BSDF_Representation.html#BxDF::Flags" class="code">Flags</a>()))
       wt = <a href="../Monte_Carlo_Integration/Improving_Efficiency.html#PowerHeuristic" class="code">PowerHeuristic</a>(1, wis-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::pdf" class="code">pdf</a>, 1, phase.<a href="../Volume_Scattering/Phase_Functions.html#HGPhaseFunction::PDF" class="code">PDF</a>(-w, -wis-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>));
   <a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::f" class="code">f</a> += beta * <a href="#LayeredBxDF::albedo" class="code">albedo</a> * phase.<a href="../Volume_Scattering/Phase_Functions.html#HGPhaseFunction::p" class="code">p</a>(-w, -wis-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>) * wt * <a href="#LayeredBxDF::Tr" class="code">Tr</a>(zp - exitZ, wis-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>) *
        wis-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::f" class="code">f</a> / wis-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::pdf" class="code">pdf</a>;</div></div>
&lt;&lt;<span class="fragmentname"><a href="#fragment-Samplephasefunctionandupdatelayeredpathstate-0">Sample phase function and update layered path state</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2377" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2377"><i></i></a><div id="fragbit-2377" class="collapse show"><div class="fragmentcode">   <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a> u{r(), r()};
   pstd::optional&lt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample" class="code">PhaseFunctionSample</a>&gt; ps = phase.<a href="../Volume_Scattering/Phase_Functions.html#HGPhaseFunction::Sample_p" class="code">Sample_p</a>(-w, u);
   if (!ps || ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::pdf" class="code">pdf</a> == 0 || ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::wi" class="code">wi</a>.z == 0)
       continue;
   beta *= <a href="#LayeredBxDF::albedo" class="code">albedo</a> * ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::p" class="code">p</a> / ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::pdf" class="code">pdf</a>;
   w = ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::wi" class="code">wi</a>;
   z = zp;</div></div>
&lt;&lt;<span class="fragmentname"><a href="#fragment-PossiblyaccountforscatteringthroughmonoexitInterface-0">Possibly account for scattering through <tt>exitInterface</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2378" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2378"><i></i></a><div id="fragbit-2378" class="collapse show"><div class="fragmentcode">   if (((z &lt; exitZ &amp;&amp; w.z &gt; 0) || (z &gt; exitZ &amp;&amp; w.z &lt; 0)) &amp;&amp; 
        !<a href="../Reflection_Models/BSDF_Representation.html#BxDFFlags::IsSpecular" class="code">IsSpecular</a>(exitInterface.<a href="../Reflection_Models/BSDF_Representation.html#BxDF::Flags" class="code">Flags</a>())) {
       &lt;&lt;<span class="fragmentname"><a href="#fragment-AccountforscatteringthroughmonoexitInterface-0">Account for scattering through <tt>exitInterface</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2379" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2379"><i></i></a><div id="fragbit-2379" class="collapse show"><div class="fragmentcode">          <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> fExit = exitInterface.<a href="../Reflection_Models/BSDF_Representation.html#BxDF::f" class="code">f</a>(-w, <a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::wi" class="code">wi</a>, mode);
          if (fExit) {
              Float exitPDF =
                  exitInterface.<a href="../Reflection_Models/BSDF_Representation.html#BxDF::PDF" class="code">PDF</a>(-w, <a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::wi" class="code">wi</a>, mode, BxDFReflTransFlags::Transmission);
              Float wt = <a href="../Monte_Carlo_Integration/Improving_Efficiency.html#PowerHeuristic" class="code">PowerHeuristic</a>(1, ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::pdf" class="code">pdf</a>, 1, exitPDF);
              <a href="../Reflection_Models/BSDF_Representation.html#BxDF::f" class="code">f</a> += beta * <a href="#LayeredBxDF::Tr" class="code">Tr</a>(zp - exitZ, ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::wi" class="code">wi</a>) * fExit * wt;
          }</div></div>
   }</div></div></div><p>


</p>
<p>For a scattering event inside the medium, it is necessary to add the
contribution of the virtual light source to the path radiance estimate and
to sample a new direction to continue the path.  For the MIS lighting
sample based on sampling the interface&rsquo;s BTDF, the outgoing direction from
the path vertex is predetermined by the BTDF sample <tt>wis</tt>; all the
factors of the path contribution are easily evaluated and the MIS weight is
found using the PDF for the other sampling technique, sampling the phase
function.

</p>
<p></p>
<span class="anchor" id="fragment-AccountforscatteringthroughmonoexitInterfaceusingmonowis-0"></span><div class="fragmentname">&lt;&lt;Account for scattering through <tt>exitInterface</tt> using <tt>wis</tt>&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">Float wt = 1;
if (!<a href="../Reflection_Models/BSDF_Representation.html#BxDFFlags::IsSpecular" class="code">IsSpecular</a>(exitInterface.<a href="../Reflection_Models/BSDF_Representation.html#BxDF::Flags" class="code">Flags</a>()))
    wt = <a href="../Monte_Carlo_Integration/Improving_Efficiency.html#PowerHeuristic" class="code">PowerHeuristic</a>(1, wis-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::pdf" class="code">pdf</a>, 1, phase.<a href="../Volume_Scattering/Phase_Functions.html#HGPhaseFunction::PDF" class="code">PDF</a>(-w, -wis-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>));
<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::f" class="code">f</a> += beta * <a href="#LayeredBxDF::albedo" class="code">albedo</a> * phase.<a href="../Volume_Scattering/Phase_Functions.html#HGPhaseFunction::p" class="code">p</a>(-w, -wis-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>) * wt * <a href="#LayeredBxDF::Tr" class="code">Tr</a>(zp - exitZ, wis-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>) *
     wis-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::f" class="code">f</a> / wis-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::pdf" class="code">pdf</a>;</div><p>


</p>
<p>The second sampling strategy for the virtual light is based on sampling the
phase function and then connecting to the virtual light source through the
exit interface. Doing so shares some common work with sampling a new
direction for the path, so the implementation takes the opportunity to
update the path state after sampling the phase function here.

</p>
<p></p>
<span class="anchor" id="fragment-Samplephasefunctionandupdatelayeredpathstate-0"></span><div class="fragmentname">&lt;&lt;Sample phase function and update layered path state&gt;&gt;=&nbsp;</div>
<div class="fragmentcode"><a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a> u{r(), r()};
pstd::optional&lt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample" class="code">PhaseFunctionSample</a>&gt; ps = phase.<a href="../Volume_Scattering/Phase_Functions.html#HGPhaseFunction::Sample_p" class="code">Sample_p</a>(-w, u);
if (!ps || ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::pdf" class="code">pdf</a> == 0 || ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::wi" class="code">wi</a>.z == 0)
    continue;
beta *= <a href="#LayeredBxDF::albedo" class="code">albedo</a> * ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::p" class="code">p</a> / ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::pdf" class="code">pdf</a>;
w = ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::wi" class="code">wi</a>;
z = zp;</div><p>


</p>
<p>There is no reason to try connecting through the exit interface if the
current ray direction is pointing away from it or if its BSDF is perfect
specular.

</p>
<p></p>
<span class="anchor" id="fragment-PossiblyaccountforscatteringthroughmonoexitInterface-0"></span><div class="fragmentname">&lt;&lt;Possibly account for scattering through <tt>exitInterface</tt>&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">if (((z &lt; exitZ &amp;&amp; w.z &gt; 0) || (z &gt; exitZ &amp;&amp; w.z &lt; 0)) &amp;&amp; 
     !<a href="../Reflection_Models/BSDF_Representation.html#BxDFFlags::IsSpecular" class="code">IsSpecular</a>(exitInterface.<a href="../Reflection_Models/BSDF_Representation.html#BxDF::Flags" class="code">Flags</a>())) {
    &lt;&lt;<span class="fragmentname"><a href="#fragment-AccountforscatteringthroughmonoexitInterface-0">Account for scattering through <tt>exitInterface</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2380" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2380"><i></i></a><div id="fragbit-2380" class="collapse show"><div class="fragmentcode">       <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> fExit = exitInterface.<a href="../Reflection_Models/BSDF_Representation.html#BxDF::f" class="code">f</a>(-w, <a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::wi" class="code">wi</a>, mode);
       if (fExit) {
           Float exitPDF =
               exitInterface.<a href="../Reflection_Models/BSDF_Representation.html#BxDF::PDF" class="code">PDF</a>(-w, <a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::wi" class="code">wi</a>, mode, BxDFReflTransFlags::Transmission);
           Float wt = <a href="../Monte_Carlo_Integration/Improving_Efficiency.html#PowerHeuristic" class="code">PowerHeuristic</a>(1, ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::pdf" class="code">pdf</a>, 1, exitPDF);
           <a href="../Reflection_Models/BSDF_Representation.html#BxDF::f" class="code">f</a> += beta * <a href="#LayeredBxDF::Tr" class="code">Tr</a>(zp - exitZ, ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::wi" class="code">wi</a>) * fExit * wt;
       }</div></div>
}</div><p>


</p>
<p>If there is transmission through the interface, then because <tt>beta</tt>
has already been updated to include the effect of scattering at <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.989ex" height="2.343ex" style="vertical-align: -0.338ex;" viewBox="0 -863.1 856.3 1008.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">z prime</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D467" d="M467 432c0 -4 -22 -52 -117 -145c-36 -36 -98 -90 -98 -90c-36 -31 -65 -56 -119 -114c9 3 27 3 27 3c21 0 36 -4 70 -17c21 -7 39 -13 59 -13c33 0 97 19 120 84c3 7 5 13 14 13c8 0 12 -5 12 -10c0 -27 -58 -154 -157 -154c-29 0 -47 16 -64 37c-25 29 -35 38 -58 38 c-32 0 -62 -27 -85 -62c-6 -11 -8 -13 -16 -13c0 0 -12 0 -12 10c0 7 35 64 103 131l90 84c19 16 103 88 139 131c-26 0 -37 0 -77 15c-23 8 -42 15 -63 15c-8 0 -66 -1 -85 -47c-2 -6 -4 -11 -13 -11s-12 6 -12 11c0 21 46 114 121 114c33 0 50 -20 69 -43 c15 -17 27 -32 51 -32s45 16 75 64c5 9 8 11 15 11c0 0 11 0 11 -10Z"></path>
<path stroke-width="1" id="E1-LATINMODERNVARIANTS-2032" d="M340 496c0 -10 -3 -20 -8 -28l-227 -372h-38l171 424c6 15 26 29 48 29c30 0 54 -24 54 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D467" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNVARIANTS-2032" x="662" y="513"></use>
</g>
</svg>, only
the transmittance to the exit, MIS weight, and BTDF value need to be
evaluated to compute the light&rsquo;s contribution.  One important detail in the
following code is the ordering of arguments to the call to <tt>f()</tt> in
the first line: due to the non-reciprocity of BTDFs, swapping these would
lead to incorrect results.<button style="button" data-toggle="tooltip" data-placement="right" data-html="true" class="btn footnote-button" title="As was learned, painfully, during the
implementation of this <tt>BxDF</tt>.">
      <sup>&dagger;</sup>
    </button>
		

</p>
<p></p>
<span class="anchor" id="fragment-AccountforscatteringthroughmonoexitInterface-0"></span><div class="fragmentname">&lt;&lt;Account for scattering through <tt>exitInterface</tt>&gt;&gt;=&nbsp;</div>
<div class="fragmentcode"><a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> fExit = exitInterface.<a href="../Reflection_Models/BSDF_Representation.html#BxDF::f" class="code">f</a>(-w, <a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::wi" class="code">wi</a>, mode);
if (fExit) {
    Float exitPDF =
        exitInterface.<a href="../Reflection_Models/BSDF_Representation.html#BxDF::PDF" class="code">PDF</a>(-w, <a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::wi" class="code">wi</a>, mode, BxDFReflTransFlags::Transmission);
    Float wt = <a href="../Monte_Carlo_Integration/Improving_Efficiency.html#PowerHeuristic" class="code">PowerHeuristic</a>(1, ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::pdf" class="code">pdf</a>, 1, exitPDF);
    <a href="../Reflection_Models/BSDF_Representation.html#BxDF::f" class="code">f</a> += beta * <a href="#LayeredBxDF::Tr" class="code">Tr</a>(zp - exitZ, ps-&gt;<a href="../Volume_Scattering/Phase_Functions.html#PhaseFunctionSample::wi" class="code">wi</a>) * fExit * wt;
}</div><p>


</p>
<p>If no medium scattering event was sampled, the next path vertex is at
an interface.  In this case, the transmittance along the ray can be
ignored: as before, the probability of evaluating the first
term of Equation&nbsp;(<a href="#eq:eot-1d">14.31</a>) has probability equal to <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.234ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 962 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">upper T Subscript normal r</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D447" d="M704 666c0 -3 -1 -13 -2 -17l-27 -174c-2 -15 -4 -23 -15 -23c-9 0 -12 7 -12 13c0 3 2 15 3 19c4 26 8 65 8 80c0 78 -45 82 -146 82c-21 0 -54 0 -63 -2c-12 -3 -16 -9 -23 -37l-133 -531c-4 -15 -4 -21 -4 -21c0 -16 8 -19 37 -22c26 -2 39 -2 64 -2c26 0 34 0 34 -11 c0 -20 -12 -20 -22 -20c-28 0 -58 2 -87 2l-83 1l-85 -1c-27 0 -55 -2 -82 -2c-6 0 -17 0 -17 12c0 19 6 19 42 19c107 0 110 11 119 48l134 534c1 3 4 15 4 21c0 8 0 12 -28 12h-39c-148 0 -174 -18 -228 -173c-6 -16 -7 -21 -17 -21c-7 0 -12 5 -12 11c0 0 5 16 6 18 l60 176c7 19 8 20 32 20h555c17 0 27 0 27 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-72" d="M364 381c0 -32 -25 -44 -43 -44c-22 0 -43 15 -43 43c0 26 20 38 23 39c-2 1 -4 1 -11 1c-76 0 -118 -89 -118 -188v-154c0 -36 2 -47 76 -47h21v-31c-40 3 -87 3 -127 3l-114 -3v31c67 0 78 0 78 45v268c0 49 -8 56 -78 56v31l139 11v-110c14 43 50 110 123 110 c43 0 74 -29 74 -61Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D447" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-72" x="826" y="-213"></use>
</g>
</svg>
and thus the two <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.234ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 962 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">upper T Subscript normal r</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D447" d="M704 666c0 -3 -1 -13 -2 -17l-27 -174c-2 -15 -4 -23 -15 -23c-9 0 -12 7 -12 13c0 3 2 15 3 19c4 26 8 65 8 80c0 78 -45 82 -146 82c-21 0 -54 0 -63 -2c-12 -3 -16 -9 -23 -37l-133 -531c-4 -15 -4 -21 -4 -21c0 -16 8 -19 37 -22c26 -2 39 -2 64 -2c26 0 34 0 34 -11 c0 -20 -12 -20 -22 -20c-28 0 -58 2 -87 2l-83 1l-85 -1c-27 0 -55 -2 -82 -2c-6 0 -17 0 -17 12c0 19 6 19 42 19c107 0 110 11 119 48l134 534c1 3 4 15 4 21c0 8 0 12 -28 12h-39c-148 0 -174 -18 -228 -173c-6 -16 -7 -21 -17 -21c-7 0 -12 5 -12 11c0 0 5 16 6 18 l60 176c7 19 8 20 32 20h555c17 0 27 0 27 -11Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-72" d="M364 381c0 -32 -25 -44 -43 -44c-22 0 -43 15 -43 43c0 26 20 38 23 39c-2 1 -4 1 -11 1c-76 0 -118 -89 -118 -188v-154c0 -36 2 -47 76 -47h21v-31c-40 3 -87 3 -127 3l-114 -3v31c67 0 78 0 78 45v268c0 49 -8 56 -78 56v31l139 11v-110c14 43 50 110 123 110 c43 0 74 -29 74 -61Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D447" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-72" x="826" y="-213"></use>
</g>
</svg> factors cancel, leaving us only needing to
evaluate scattering at the boundary,
Equation&nbsp;(<a href="#eq:boundary-scattering-1d">14.32</a>).  The details differ depending
on which interface the ray intersected.

</p>
<p></p>
<span class="anchor" id="fragment-Accountforscatteringatappropriateinterface-0"></span><div class="fragmentname">&lt;&lt;Account for scattering at appropriate interface&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">if (z == exitZ) {
    &lt;&lt;<span class="fragmentname"><a href="#fragment-AccountforreflectionatmonoexitInterface-0">Account for reflection at <tt>exitInterface</tt></a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2381" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2381"><i></i></a><div id="fragbit-2381" class="collapse show"><div class="fragmentcode">       Float uc = r();
       pstd::optional&lt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample" class="code">BSDFSample</a>&gt; bs = exitInterface.<a href="../Reflection_Models/BSDF_Representation.html#BxDF::Sample_f" class="code">Sample_f</a>(
           -w, uc, <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(r(), r()), mode, <a href="../Reflection_Models/BSDF_Representation.html#BxDFReflTransFlags::Reflection" class="code">BxDFReflTransFlags</a>::Reflection);
       if (!bs || !bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::f" class="code">f</a> || bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::pdf" class="code">pdf</a> == 0 || bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>.z == 0)
           break;
       beta *= bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::f" class="code">f</a> * <a href="../Geometry_and_Transformations/Spherical_Geometry.html#AbsCosTheta" class="code">AbsCosTheta</a>(bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>) / bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::pdf" class="code">pdf</a>;
       w = bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>;</div></div>
} else {
    &lt;&lt;<span class="fragmentname">Account for scattering at <tt>nonExitInterface</tt></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2382" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2382"><i></i></a><div id="fragbit-2382" class="collapse show"><div class="fragmentcode">       if (!IsSpecular(nonExitInterface.Flags())) {
           &lt;&lt;<span class="fragmentname">Add NEE contribution along presampled <tt>wis</tt> direction</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2383" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2383"><i></i></a><div id="fragbit-2383" class="collapse show"><div class="fragmentcode">              Float wt = 1;
              if (!IsSpecular(exitInterface.Flags()))
                  wt = PowerHeuristic(1, wis-&gt;pdf,
                                      1, nonExitInterface.PDF(-w, -wis-&gt;wi, mode));
              f += beta * nonExitInterface.f(-w, -wis-&gt;wi, mode) *
                   AbsCosTheta(wis-&gt;wi) * wt * Tr(thickness, wis-&gt;wi) * wis-&gt;f / wis-&gt;pdf;</div></div>
       }
       &lt;&lt;<span class="fragmentname">Sample new direction using BSDF at <tt>nonExitInterface</tt></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2384" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2384"><i></i></a><div id="fragbit-2384" class="collapse show"><div class="fragmentcode">          Float uc = r();
          <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a> u(r(), r());
          pstd::optional&lt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample" class="code">BSDFSample</a>&gt; bs = nonExitInterface.Sample_f(
              -w, uc, u, mode, BxDFReflTransFlags::Reflection);
          if (!bs || !bs-&gt;f || bs-&gt;pdf == 0 || bs-&gt;wi.z == 0)
              break;
          beta *= bs-&gt;f * AbsCosTheta(bs-&gt;wi) / bs-&gt;pdf;
          w = bs-&gt;wi;</div></div>
       if (!IsSpecular(exitInterface.Flags())) {
           &lt;&lt;<span class="fragmentname">Add NEE contribution along direction from BSDF sample</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2385" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2385"><i></i></a><div id="fragbit-2385" class="collapse show"><div class="fragmentcode">              <a href="../Radiometry,_Spectra,_and_Color/Representing_Spectral_Distributions.html#SampledSpectrum" class="code">SampledSpectrum</a> fExit = exitInterface.f(-w, wi, mode);
              if (fExit) {
                  Float wt = 1;
                  if (!IsSpecular(nonExitInterface.Flags())) {
                      Float exitPDF = exitInterface.PDF(
                          -w, wi, mode, BxDFReflTransFlags::Transmission);
                      wt = PowerHeuristic(1, bs-&gt;pdf, 1, exitPDF);
                  }
                  f += beta * Tr(thickness, bs-&gt;wi) * fExit * wt;
              }</div></div>
       }</div></div>
}</div><p>


</p>
<p>If the ray intersected the exit interface, then it is only necessary to
update the path throughput: no connection is made to the virtual light
source since transmission through the exit interface to the light is
accounted for by the lighting computation at the previous vertex.  This
fragment samples only the reflection component of the path here, since a ray
that was transmitted outside the medium would end the path.

</p>
<p></p>
<span class="anchor" id="fragment-AccountforreflectionatmonoexitInterface-0"></span><div class="fragmentname">&lt;&lt;Account for reflection at <tt>exitInterface</tt>&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">Float uc = r();
pstd::optional&lt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample" class="code">BSDFSample</a>&gt; bs = exitInterface.<a href="../Reflection_Models/BSDF_Representation.html#BxDF::Sample_f" class="code">Sample_f</a>(
    -w, uc, <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(r(), r()), mode, <a href="../Reflection_Models/BSDF_Representation.html#BxDFReflTransFlags::Reflection" class="code">BxDFReflTransFlags</a>::Reflection);
if (!bs || !bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::f" class="code">f</a> || bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::pdf" class="code">pdf</a> == 0 || bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>.z == 0)
    break;
beta *= bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::f" class="code">f</a> * <a href="../Geometry_and_Transformations/Spherical_Geometry.html#AbsCosTheta" class="code">AbsCosTheta</a>(bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>) / bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::pdf" class="code">pdf</a>;
w = bs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>;</div><p>


</p>
<p>The &lt;&lt;<span class="fragmentname">Account for scattering at <tt>nonExitInterface</tt></span>&gt;&gt; fragment
handles scattering from the other interface.  It applies MIS to compute the
contribution of the virtual light and samples a new direction with a form very
similar to the case of scattering within the medium, just with the phase
function replaced by the BRDF for evaluation and sampling.
Therefore, we have not included its implementation here.

</p>
<p>

</p>
<p>

</p>
<p></p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">
<a href="#x2-BSDFSampling"><i class="fas fa-link h3h4marginlink"></i></a>
</div>
<div class="col-md-10 col-lg-8">
<span id="x2-BSDFSampling"></span><h4>BSDF Sampling</h4><p>


</p>
<p>The implementation of
<tt>Sample_f()</tt><span class="anchor" id="LayeredBxDF::Sample_f"></span> is generally similar
to <tt>f()</tt>, so we will not include its implementation here, either.  Its
task is actually simpler: given the initial direction <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.5ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 1076.4 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">omega Subscript normal o</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6F" d="M471 214c0 -127 -101 -225 -222 -225c-117 0 -221 96 -221 225c0 125 97 234 222 234c121 0 221 -106 221 -234zM388 222c0 38 0 96 -26 139s-69 65 -113 65c-40 0 -87 -21 -114 -67c-24 -44 -24 -98 -24 -137c0 -36 0 -97 25 -141c27 -46 71 -67 114 -67 c50 0 94 29 116 74c22 44 22 98 22 134Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6F" x="880" y="-213"></use>
</g>
</svg> at one of the
layer&rsquo;s boundaries, it follows a random walk of scattering events through
the layers and the medium, maintaining both the path throughput and the
product of PDFs for each of the sampling decisions.  When the random walk
exits the medium, the outgoing direction is the sampled direction that is
returned in the <a href="../Reflection_Models/BSDF_Representation.html#BSDFSample"><tt>BSDFSample</tt></a>.

</p>
<p>With this approach, it can be shown that the ratio of the path throughput
to the PDF is equal to the ratio of the actual value of the BSDF and its
PDF for the sampled direction (see the &ldquo;Further Reading&rdquo; section for
details).  Therefore, when the weighted path throughput is multiplied by
the ratio of <a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::f"><tt>BSDFSample::f</tt></a> and <a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::pdf"><tt>BSDFSample::pdf</tt></a>, the
correct weighting term is applied.  (Review, for example, the fragment
&lt;&lt;<span class="fragmentname"><a href="../Light_Transport_I_Surface_Reflection/A_Better_Path_Tracer.html#fragment-Updatepathstatevariablesaftersurfacescattering-0">Update path state variables after surface scattering</a></span>&gt;&gt; in the
<a href="../Light_Transport_I_Surface_Reflection/A_Better_Path_Tracer.html#PathIntegrator"><tt>PathIntegrator</tt></a>.)

</p>
<p>However, an implication of this is that the PDF value returned by
<tt>Sample_f()</tt> cannot be used to compute the multiple importance
sampling weight if the sampled ray hits an emissive surface; in that case,
an independent estimate of the PDF must be computed via a call to the
<tt>PDF()</tt> method.  The <a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::pdfIsProportional"><tt>BSDFSample::pdfIsProportional</tt></a> member
variable flags this case and is set by <tt>Sample_f()</tt> here.

</p>
<p>

</p>
<p>

</p>
<p></p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">
<a href="#x2-PDFEvaluation"><i class="fas fa-link h3h4marginlink"></i></a>
</div>
<div class="col-md-10 col-lg-8">
<span id="x2-PDFEvaluation"></span><h4>PDF Evaluation</h4><p>


</p>
<p></p>
<span class="anchor" id="fig:layered-pdf-sampling"></span><div class="card outerfigure"><div class="card-body figure"><p>



</p>
<div class="figure-row">
<img src="pha14f21.png" style="max-width: 100%; height: auto;" width=1332 height=503>
</div>
<p>


</p>
<figcaption class="caption">Figure 14.21: The First Two Terms of the Infinite Sum that Give a Layered BSDF&rsquo;s
PDF. <span class="legend">
(a)&nbsp;The PDF of the reflection component of the interface&rsquo;s BSDF accounts
for light that scatters without entering the layers.
(b)&nbsp;The second term is given by a double integral over directions.
A direction <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.347ex" height="2.343ex" style="vertical-align: -0.338ex;" viewBox="0 -863.1 1010.6 1008.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">omega prime Subscript</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
<path stroke-width="1" id="E1-LATINMODERNVARIANTS-2032" d="M340 496c0 -10 -3 -20 -8 -28l-227 -372h-38l171 424c6 15 26 29 48 29c30 0 54 -24 54 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNVARIANTS-2032" x="880" y="513"></use>
</g>
</svg> pointing into the medium is sampled; it gives the
second direction for the interface&rsquo;s BTDF PDF <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.753ex" height="3.009ex" style="vertical-align: -0.838ex; margin-left: -0.073ex;" viewBox="-31.5 -934.9 1185.5 1295.7" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">p Subscript normal t Superscript plus</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45D" d="M490 282c0 -147 -125 -293 -241 -293c-51 0 -79 35 -92 64c-7 -25 -49 -188 -49 -200c0 -9 0 -16 50 -16c14 0 24 0 24 -11c0 -20 -13 -20 -18 -20c-32 0 -66 3 -99 3c-28 0 -57 -3 -84 -3c-8 0 -13 4 -13 12c0 19 11 19 23 19c44 0 46 7 54 41l112 445c4 17 7 28 7 51 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c37 0 80 -21 90 -75c33 39 81 75 131 75c76 0 133 -66 133 -160zM418 326c0 59 -24 94 -64 94c-17 0 -46 -7 -81 -38c-18 -15 -45 -43 -52 -70 l-49 -196c-3 -12 -3 -16 -3 -16c0 -6 13 -89 79 -89c37 0 85 33 119 103c18 38 51 153 51 212Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2B" d="M722 250c0 -11 -9 -20 -20 -20h-293v-293c0 -11 -9 -20 -20 -20s-20 9 -20 20v293h-293c-11 0 -20 9 -20 20s9 20 20 20h293v293c0 11 9 20 20 20s20 -9 20 -20v-293h293c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-74" d="M332 124c0 -64 -28 -135 -99 -135c-36 0 -129 12 -129 135v276h-85v22c98 4 128 111 129 193h25v-184h143v-31h-143v-278c0 -17 0 -108 67 -108c37 0 67 38 67 112v55h25v-57Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2B" x="712" y="571"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-74" x="712" y="-384"></use>
</g>
</svg> and its negation
gives one of the two directions for <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.753ex" height="2.843ex" style="vertical-align: -0.671ex; margin-left: -0.073ex;" viewBox="-31.5 -934.9 1185.5 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">p Subscript normal r Superscript minus</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45D" d="M490 282c0 -147 -125 -293 -241 -293c-51 0 -79 35 -92 64c-7 -25 -49 -188 -49 -200c0 -9 0 -16 50 -16c14 0 24 0 24 -11c0 -20 -13 -20 -18 -20c-32 0 -66 3 -99 3c-28 0 -57 -3 -84 -3c-8 0 -13 4 -13 12c0 19 11 19 23 19c44 0 46 7 54 41l112 445c4 17 7 28 7 51 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c37 0 80 -21 90 -75c33 39 81 75 131 75c76 0 133 -66 133 -160zM418 326c0 59 -24 94 -64 94c-17 0 -46 -7 -81 -38c-18 -15 -45 -43 -52 -70 l-49 -196c-3 -12 -3 -16 -3 -16c0 -6 13 -89 79 -89c37 0 85 33 119 103c18 38 51 153 51 212Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2212" d="M722 250c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-72" d="M364 381c0 -32 -25 -44 -43 -44c-22 0 -43 15 -43 43c0 26 20 38 23 39c-2 1 -4 1 -11 1c-76 0 -118 -89 -118 -188v-154c0 -36 2 -47 76 -47h21v-31c-40 3 -87 3 -127 3l-114 -3v31c67 0 78 0 78 45v268c0 49 -8 56 -78 56v31l139 11v-110c14 43 50 110 123 110 c43 0 74 -29 74 -61Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="712" y="571"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-72" x="712" y="-211"></use>
</g>
</svg>. A second direction <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.741ex" height="2.343ex" style="vertical-align: -0.338ex;" viewBox="0 -863.1 1180.4 1008.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">omega double-prime Subscript</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E2-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
<path stroke-width="1" id="E2-LATINMODERNVARIANTS-2033" d="M340 496c0 -10 -3 -20 -8 -28l-227 -372h-38l171 424c6 15 26 29 48 29c30 0 54 -24 54 -53zM580 496c0 -10 -3 -20 -8 -28l-227 -372h-38l171 424c6 15 26 29 48 29c30 0 54 -24 54 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E2-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E2-LATINMODERNVARIANTS-2033" x="880" y="513"></use>
</g>
</svg> is
used for <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.753ex" height="2.843ex" style="vertical-align: -0.671ex; margin-left: -0.073ex;" viewBox="-31.5 -934.9 1185.5 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">p Subscript normal r Superscript minus</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45D" d="M490 282c0 -147 -125 -293 -241 -293c-51 0 -79 35 -92 64c-7 -25 -49 -188 -49 -200c0 -9 0 -16 50 -16c14 0 24 0 24 -11c0 -20 -13 -20 -18 -20c-32 0 -66 3 -99 3c-28 0 -57 -3 -84 -3c-8 0 -13 4 -13 12c0 19 11 19 23 19c44 0 46 7 54 41l112 445c4 17 7 28 7 51 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c37 0 80 -21 90 -75c33 39 81 75 131 75c76 0 133 -66 133 -160zM418 326c0 59 -24 94 -64 94c-17 0 -46 -7 -81 -38c-18 -15 -45 -43 -52 -70 l-49 -196c-3 -12 -3 -16 -3 -16c0 -6 13 -89 79 -89c37 0 85 33 119 103c18 38 51 153 51 212Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2212" d="M722 250c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-72" d="M364 381c0 -32 -25 -44 -43 -44c-22 0 -43 15 -43 43c0 26 20 38 23 39c-2 1 -4 1 -11 1c-76 0 -118 -89 -118 -188v-154c0 -36 2 -47 76 -47h21v-31c-40 3 -87 3 -127 3l-114 -3v31c67 0 78 0 78 45v268c0 49 -8 56 -78 56v31l139 11v-110c14 43 50 110 123 110 c43 0 74 -29 74 -61Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="712" y="571"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-72" x="712" y="-211"></use>
</g>
</svg> as well as for a second evaluation of&nbsp;<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.753ex" height="3.009ex" style="vertical-align: -0.838ex; margin-left: -0.073ex;" viewBox="-31.5 -934.9 1185.5 1295.7" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">p Subscript normal t Superscript plus</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45D" d="M490 282c0 -147 -125 -293 -241 -293c-51 0 -79 35 -92 64c-7 -25 -49 -188 -49 -200c0 -9 0 -16 50 -16c14 0 24 0 24 -11c0 -20 -13 -20 -18 -20c-32 0 -66 3 -99 3c-28 0 -57 -3 -84 -3c-8 0 -13 4 -13 12c0 19 11 19 23 19c44 0 46 7 54 41l112 445c4 17 7 28 7 51 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c37 0 80 -21 90 -75c33 39 81 75 131 75c76 0 133 -66 133 -160zM418 326c0 59 -24 94 -64 94c-17 0 -46 -7 -81 -38c-18 -15 -45 -43 -52 -70 l-49 -196c-3 -12 -3 -16 -3 -16c0 -6 13 -89 79 -89c37 0 85 33 119 103c18 38 51 153 51 212Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2B" d="M722 250c0 -11 -9 -20 -20 -20h-293v-293c0 -11 -9 -20 -20 -20s-20 9 -20 20v293h-293c-11 0 -20 9 -20 20s9 20 20 20h293v293c0 11 9 20 20 20s20 -9 20 -20v-293h293c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-74" d="M332 124c0 -64 -28 -135 -99 -135c-36 0 -129 12 -129 135v276h-85v22c98 4 128 111 129 193h25v-184h143v-31h-143v-278c0 -17 0 -108 67 -108c37 0 67 38 67 112v55h25v-57Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2B" x="712" y="571"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-74" x="712" y="-384"></use>
</g>
</svg>.
</span>
</figcaption><p>


</p>
</div></div><p>


</p>
<p>The PDF <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="8.721ex" height="2.843ex" style="vertical-align: -0.838ex; margin-left: -0.073ex;" viewBox="-31.5 -863.1 3755 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">p left-parenthesis omega Subscript normal o Baseline comma omega Subscript normal i Baseline right-parenthesis</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45D" d="M490 282c0 -147 -125 -293 -241 -293c-51 0 -79 35 -92 64c-7 -25 -49 -188 -49 -200c0 -9 0 -16 50 -16c14 0 24 0 24 -11c0 -20 -13 -20 -18 -20c-32 0 -66 3 -99 3c-28 0 -57 -3 -84 -3c-8 0 -13 4 -13 12c0 19 11 19 23 19c44 0 46 7 54 41l112 445c4 17 7 28 7 51 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c37 0 80 -21 90 -75c33 39 81 75 131 75c76 0 133 -66 133 -160zM418 326c0 59 -24 94 -64 94c-17 0 -46 -7 -81 -38c-18 -15 -45 -43 -52 -70 l-49 -196c-3 -12 -3 -16 -3 -16c0 -6 13 -89 79 -89c37 0 85 33 119 103c18 38 51 153 51 212Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6F" d="M471 214c0 -127 -101 -225 -222 -225c-117 0 -221 96 -221 225c0 125 97 234 222 234c121 0 221 -106 221 -234zM388 222c0 38 0 96 -26 139s-69 65 -113 65c-40 0 -87 -21 -114 -67c-24 -44 -24 -98 -24 -137c0 -36 0 -97 25 -141c27 -46 71 -67 114 -67 c50 0 94 29 116 74c22 44 22 98 22 134Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-69" d="M247 0c-34 1 -69 3 -104 3l-110 -3v31c67 0 78 0 78 45v269c0 49 -9 55 -74 55v31l140 11v-367c0 -39 4 -44 70 -44v-31zM192 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-28" x="503" y="0"></use>
<g transform="translate(893,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6F" x="880" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2C" x="1969" y="0"></use>
<g transform="translate(2414,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="880" y="-213"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-29" x="3334" y="0"></use>
</g>
</svg> that corresponds to a <tt>LayeredBxDF</tt>&rsquo;s BSDF can
be expressed as an infinite sum.  For
example, consider the case of having a bottom layer that reflects light
with BRDF <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.837ex" height="2.843ex" style="vertical-align: -0.671ex;" viewBox="0 -934.9 1221.6 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">f Subscript normal r Superscript minus</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D453" d="M552 636c0 -38 -29 -60 -55 -60c-19 0 -37 12 -37 35c0 15 10 50 54 54c-19 18 -45 18 -49 18c-21 0 -38 -15 -47 -34c-6 -12 -20 -83 -24 -104c-11 -58 -10 -56 -21 -114h83c17 0 27 0 27 -11c0 -20 -10 -20 -30 -20h-86l-60 -317c-1 -7 -24 -128 -56 -191 c-18 -38 -58 -97 -113 -97c-41 0 -85 24 -85 69c0 38 29 60 55 60c19 0 37 -12 37 -35c0 -15 -9 -51 -55 -54c19 -18 44 -18 48 -18c52 0 69 91 87 188l75 395h-66c-19 0 -28 0 -28 12c0 19 11 19 30 19h69c24 126 27 136 33 157c30 99 93 117 127 117c41 0 87 -23 87 -69Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2212" d="M722 250c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-72" d="M364 381c0 -32 -25 -44 -43 -44c-22 0 -43 15 -43 43c0 26 20 38 23 39c-2 1 -4 1 -11 1c-76 0 -118 -89 -118 -188v-154c0 -36 2 -47 76 -47h21v-31c-40 3 -87 3 -127 3l-114 -3v31c67 0 78 0 78 45v268c0 49 -8 56 -78 56v31l139 11v-110c14 43 50 110 123 110 c43 0 74 -29 74 -61Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D453" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="807" y="571"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-72" x="693" y="-211"></use>
</g>
</svg> and a top layer that both reflects light with
BRDF <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.837ex" height="2.843ex" style="vertical-align: -0.671ex;" viewBox="0 -934.9 1221.6 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">f Subscript normal r Superscript plus</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D453" d="M552 636c0 -38 -29 -60 -55 -60c-19 0 -37 12 -37 35c0 15 10 50 54 54c-19 18 -45 18 -49 18c-21 0 -38 -15 -47 -34c-6 -12 -20 -83 -24 -104c-11 -58 -10 -56 -21 -114h83c17 0 27 0 27 -11c0 -20 -10 -20 -30 -20h-86l-60 -317c-1 -7 -24 -128 -56 -191 c-18 -38 -58 -97 -113 -97c-41 0 -85 24 -85 69c0 38 29 60 55 60c19 0 37 -12 37 -35c0 -15 -9 -51 -55 -54c19 -18 44 -18 48 -18c52 0 69 91 87 188l75 395h-66c-19 0 -28 0 -28 12c0 19 11 19 30 19h69c24 126 27 136 33 157c30 99 93 117 127 117c41 0 87 -23 87 -69Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2B" d="M722 250c0 -11 -9 -20 -20 -20h-293v-293c0 -11 -9 -20 -20 -20s-20 9 -20 20v293h-293c-11 0 -20 9 -20 20s9 20 20 20h293v293c0 11 9 20 20 20s20 -9 20 -20v-293h293c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-72" d="M364 381c0 -32 -25 -44 -43 -44c-22 0 -43 15 -43 43c0 26 20 38 23 39c-2 1 -4 1 -11 1c-76 0 -118 -89 -118 -188v-154c0 -36 2 -47 76 -47h21v-31c-40 3 -87 3 -127 3l-114 -3v31c67 0 78 0 78 45v268c0 49 -8 56 -78 56v31l139 11v-110c14 43 50 110 123 110 c43 0 74 -29 74 -61Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D453" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2B" x="807" y="571"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-72" x="693" y="-211"></use>
</g>
</svg> and transmits it with BTDF <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.837ex" height="3.009ex" style="vertical-align: -0.838ex;" viewBox="0 -934.9 1221.6 1295.7" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">f Subscript normal t Superscript plus</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D453" d="M552 636c0 -38 -29 -60 -55 -60c-19 0 -37 12 -37 35c0 15 10 50 54 54c-19 18 -45 18 -49 18c-21 0 -38 -15 -47 -34c-6 -12 -20 -83 -24 -104c-11 -58 -10 -56 -21 -114h83c17 0 27 0 27 -11c0 -20 -10 -20 -30 -20h-86l-60 -317c-1 -7 -24 -128 -56 -191 c-18 -38 -58 -97 -113 -97c-41 0 -85 24 -85 69c0 38 29 60 55 60c19 0 37 -12 37 -35c0 -15 -9 -51 -55 -54c19 -18 44 -18 48 -18c52 0 69 91 87 188l75 395h-66c-19 0 -28 0 -28 12c0 19 11 19 30 19h69c24 126 27 136 33 157c30 99 93 117 127 117c41 0 87 -23 87 -69Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2B" d="M722 250c0 -11 -9 -20 -20 -20h-293v-293c0 -11 -9 -20 -20 -20s-20 9 -20 20v293h-293c-11 0 -20 9 -20 20s9 20 20 20h293v293c0 11 9 20 20 20s20 -9 20 -20v-293h293c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-74" d="M332 124c0 -64 -28 -135 -99 -135c-36 0 -129 12 -129 135v276h-85v22c98 4 128 111 129 193h25v-184h143v-31h-143v-278c0 -17 0 -108 67 -108c37 0 67 38 67 112v55h25v-57Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D453" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2B" x="807" y="571"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-74" x="693" y="-384"></use>
</g>
</svg>, with an
overall BSDF <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="14.451ex" height="3.009ex" style="vertical-align: -0.838ex;" viewBox="0 -934.9 6221.9 1295.7" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">f Superscript plus Baseline equals f Subscript normal r Superscript plus Baseline plus f Subscript normal t Superscript plus</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D453" d="M552 636c0 -38 -29 -60 -55 -60c-19 0 -37 12 -37 35c0 15 10 50 54 54c-19 18 -45 18 -49 18c-21 0 -38 -15 -47 -34c-6 -12 -20 -83 -24 -104c-11 -58 -10 -56 -21 -114h83c17 0 27 0 27 -11c0 -20 -10 -20 -30 -20h-86l-60 -317c-1 -7 -24 -128 -56 -191 c-18 -38 -58 -97 -113 -97c-41 0 -85 24 -85 69c0 38 29 60 55 60c19 0 37 -12 37 -35c0 -15 -9 -51 -55 -54c19 -18 44 -18 48 -18c52 0 69 91 87 188l75 395h-66c-19 0 -28 0 -28 12c0 19 11 19 30 19h69c24 126 27 136 33 157c30 99 93 117 127 117c41 0 87 -23 87 -69Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2B" d="M722 250c0 -11 -9 -20 -20 -20h-293v-293c0 -11 -9 -20 -20 -20s-20 9 -20 20v293h-293c-11 0 -20 9 -20 20s9 20 20 20h293v293c0 11 9 20 20 20s20 -9 20 -20v-293h293c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-3D" d="M722 347c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20zM722 153c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-72" d="M364 381c0 -32 -25 -44 -43 -44c-22 0 -43 15 -43 43c0 26 20 38 23 39c-2 1 -4 1 -11 1c-76 0 -118 -89 -118 -188v-154c0 -36 2 -47 76 -47h21v-31c-40 3 -87 3 -127 3l-114 -3v31c67 0 78 0 78 45v268c0 49 -8 56 -78 56v31l139 11v-110c14 43 50 110 123 110 c43 0 74 -29 74 -61Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-74" d="M332 124c0 -64 -28 -135 -99 -135c-36 0 -129 12 -129 135v276h-85v22c98 4 128 111 129 193h25v-184h143v-31h-143v-278c0 -17 0 -108 67 -108c37 0 67 38 67 112v55h25v-57Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D453" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2B" x="807" y="513"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-3D" x="1499" y="0"></use>
<g transform="translate(2555,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D453" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2B" x="807" y="571"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-72" x="693" y="-211"></use>
</g>
 <use xlink:href="#E1-LATINMODERNMAIN-2B" x="3999" y="0"></use>
<g transform="translate(5000,0)">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D453" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2B" x="807" y="571"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-74" x="693" y="-384"></use>
</g>
</g>
</svg>.  If those BSDFs have
associated PDFs <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.243ex" height="2.009ex" style="vertical-align: -0.671ex; margin-left: -0.073ex;" viewBox="-31.5 -576.1 535 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">p</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45D" d="M490 282c0 -147 -125 -293 -241 -293c-51 0 -79 35 -92 64c-7 -25 -49 -188 -49 -200c0 -9 0 -16 50 -16c14 0 24 0 24 -11c0 -20 -13 -20 -18 -20c-32 0 -66 3 -99 3c-28 0 -57 -3 -84 -3c-8 0 -13 4 -13 12c0 19 11 19 23 19c44 0 46 7 54 41l112 445c4 17 7 28 7 51 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c37 0 80 -21 90 -75c33 39 81 75 131 75c76 0 133 -66 133 -160zM418 326c0 59 -24 94 -64 94c-17 0 -46 -7 -81 -38c-18 -15 -45 -43 -52 -70 l-49 -196c-3 -12 -3 -16 -3 -16c0 -6 13 -89 79 -89c37 0 85 33 119 103c18 38 51 153 51 212Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
</g>
</svg> and if scattering in the medium is neglected, then the
overall PDF is
</p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">
<span class="anchor" id="eq:pdf-estimate-sum"></span><div class="displaymath"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="76.119ex" height="9.509ex" style="vertical-align: -3.88ex; margin-bottom: -0.291ex;" viewBox="0 -2298.3 32773.3 4094.3" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">StartLayout 1st Row 1st Column p left-parenthesis omega Subscript normal o Baseline comma omega Subscript normal i Baseline right-parenthesis 2nd Column equals p Subscript normal r Superscript plus Baseline left-parenthesis omega Subscript normal o Baseline comma omega Subscript normal i Baseline right-parenthesis 2nd Row 1st Column Blank 2nd Column plus integral Underscript script upper S squared Endscripts integral Underscript script upper S squared Endscripts p Subscript normal t Superscript plus Baseline left-parenthesis omega Subscript normal o Baseline comma omega prime Subscript Baseline right-parenthesis p Subscript normal r Superscript minus Baseline left-parenthesis minus omega prime Subscript Baseline comma omega double-prime Subscript Baseline right-parenthesis p Subscript normal t Superscript plus Baseline left-parenthesis minus omega double-prime Subscript Baseline comma omega Subscript normal i Baseline right-parenthesis normal d omega prime Subscript Baseline normal d omega double-prime Subscript plus midline-horizontal-ellipsis period EndLayout</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E2-LATINMODERNNORMAL-1D45D" d="M490 282c0 -147 -125 -293 -241 -293c-51 0 -79 35 -92 64c-7 -25 -49 -188 -49 -200c0 -9 0 -16 50 -16c14 0 24 0 24 -11c0 -20 -13 -20 -18 -20c-32 0 -66 3 -99 3c-28 0 -57 -3 -84 -3c-8 0 -13 4 -13 12c0 19 11 19 23 19c44 0 46 7 54 41l112 445c4 17 7 28 7 51 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c37 0 80 -21 90 -75c33 39 81 75 131 75c76 0 133 -66 133 -160zM418 326c0 59 -24 94 -64 94c-17 0 -46 -7 -81 -38c-18 -15 -45 -43 -52 -70 l-49 -196c-3 -12 -3 -16 -3 -16c0 -6 13 -89 79 -89c37 0 85 33 119 103c18 38 51 153 51 212Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E2-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-6F" d="M471 214c0 -127 -101 -225 -222 -225c-117 0 -221 96 -221 225c0 125 97 234 222 234c121 0 221 -106 221 -234zM388 222c0 38 0 96 -26 139s-69 65 -113 65c-40 0 -87 -21 -114 -67c-24 -44 -24 -98 -24 -137c0 -36 0 -97 25 -141c27 -46 71 -67 114 -67 c50 0 94 29 116 74c22 44 22 98 22 134Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-69" d="M247 0c-34 1 -69 3 -104 3l-110 -3v31c67 0 78 0 78 45v269c0 49 -9 55 -74 55v31l140 11v-367c0 -39 4 -44 70 -44v-31zM192 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-3D" d="M722 347c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20zM722 153c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-2B" d="M722 250c0 -11 -9 -20 -20 -20h-293v-293c0 -11 -9 -20 -20 -20s-20 9 -20 20v293h-293c-11 0 -20 9 -20 20s9 20 20 20h293v293c0 11 9 20 20 20s20 -9 20 -20v-293h293c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-72" d="M364 381c0 -32 -25 -44 -43 -44c-22 0 -43 15 -43 43c0 26 20 38 23 39c-2 1 -4 1 -11 1c-76 0 -118 -89 -118 -188v-154c0 -36 2 -47 76 -47h21v-31c-40 3 -87 3 -127 3l-114 -3v31c67 0 78 0 78 45v268c0 49 -8 56 -78 56v31l139 11v-110c14 43 50 110 123 110 c43 0 74 -29 74 -61Z"></path>
<path stroke-width="1" id="E2-LATINMODERNSIZE1-222B" d="M943 1268c0 -35 -25 -50 -49 -50c-23 0 -48 16 -48 49c0 25 17 47 50 49c-4 4 -29 23 -60 23c-39 0 -73 -129 -85 -178c-34 -129 -71 -329 -108 -542c-54 -321 -119 -640 -196 -956c-71 -290 -128 -524 -280 -524c-61 0 -111 42 -111 93c0 35 25 50 49 50 c23 0 48 -16 48 -49c0 -25 -17 -47 -49 -49c0 0 25 -23 61 -23c81 0 127 188 145 261c33 139 62 306 88 459c110 654 246 1156 249 1167c55 204 111 313 187 313c55 0 109 -39 109 -93Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-53" d="M499 186c0 -110 -80 -208 -197 -208c-89 0 -153 36 -184 70c-33 -53 -36 -57 -36 -57c-7 -11 -8 -13 -15 -13c-11 0 -11 7 -11 24v200c0 18 0 25 13 25c3 0 11 0 12 -10c1 -36 4 -100 62 -154c53 -49 129 -54 158 -54c84 0 134 72 134 143c0 33 -10 66 -31 92 c-28 37 -58 44 -85 51c-70 17 -121 29 -132 33c-78 27 -131 100 -131 183c0 106 84 194 195 194c89 0 130 -41 160 -70l35 57c7 12 8 13 15 13c11 0 11 -7 11 -24v-201c0 -19 0 -24 -13 -24c-11 0 -11 6 -12 12c-6 45 -28 209 -195 209c-78 0 -132 -61 -132 -131 c0 -58 39 -112 101 -127l128 -31c84 -20 150 -102 150 -202Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-32" d="M449 174l-28 -174h-371c0 24 0 26 11 37l192 214c55 62 105 141 105 221c0 82 -43 163 -134 163c-58 0 -112 -37 -135 -102c3 1 5 1 13 1c35 0 53 -26 53 -52c0 -41 -35 -53 -52 -53c-3 0 -53 0 -53 56c0 89 74 181 187 181c122 0 212 -80 212 -194 c0 -100 -60 -154 -216 -292l-106 -103h180c22 0 88 0 95 8c10 15 17 59 22 89h25Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-74" d="M332 124c0 -64 -28 -135 -99 -135c-36 0 -129 12 -129 135v276h-85v22c98 4 128 111 129 193h25v-184h143v-31h-143v-278c0 -17 0 -108 67 -108c37 0 67 38 67 112v55h25v-57Z"></path>
<path stroke-width="1" id="E2-LATINMODERNVARIANTS-2032" d="M340 496c0 -10 -3 -20 -8 -28l-227 -372h-38l171 424c6 15 26 29 48 29c30 0 54 -24 54 -53Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-2212" d="M722 250c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E2-LATINMODERNVARIANTS-2033" d="M340 496c0 -10 -3 -20 -8 -28l-227 -372h-38l171 424c6 15 26 29 48 29c30 0 54 -24 54 -53zM580 496c0 -10 -3 -20 -8 -28l-227 -372h-38l171 424c6 15 26 29 48 29c30 0 54 -24 54 -53Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-64" d="M527 0l-147 -11v66c-25 -32 -70 -66 -134 -66c-114 0 -212 99 -212 226c0 129 105 227 223 227c54 0 97 -26 126 -62v216c0 49 -8 56 -78 56v31l144 11v-607c0 -49 8 -56 78 -56v-31zM380 118v205c0 18 0 20 -11 37c-31 45 -73 60 -108 60c-54 0 -92 -33 -113 -64 c-29 -45 -31 -105 -31 -142c0 -41 3 -98 29 -139c24 -38 60 -64 105 -64c43 0 88 22 118 70c11 17 11 19 11 37Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-22EF" d="M162 250c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53zM441 250c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53zM720 250c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-2E" d="M192 53c0 -29 -24 -53 -53 -53s-53 24 -53 53s24 53 53 53s53 -24 53 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
<g transform="translate(167,0)">
<g transform="translate(-11,0)">
<g transform="translate(0,1353)">
 <use xlink:href="#E2-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use xlink:href="#E2-LATINMODERNMAIN-28" x="503" y="0"></use>
<g transform="translate(893,0)">
 <use xlink:href="#E2-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E2-LATINMODERNMAIN-6F" x="880" y="-213"></use>
</g>
 <use xlink:href="#E2-LATINMODERNMAIN-2C" x="1969" y="0"></use>
<g transform="translate(2414,0)">
 <use xlink:href="#E2-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E2-LATINMODERNMAIN-69" x="880" y="-213"></use>
</g>
 <use xlink:href="#E2-LATINMODERNMAIN-29" x="3334" y="0"></use>
</g>
</g>
<g transform="translate(3990,0)">
<g transform="translate(0,1353)">
 <use xlink:href="#E2-LATINMODERNMAIN-3D" x="0" y="0"></use>
<g transform="translate(1056,0)">
 <use xlink:href="#E2-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E2-LATINMODERNMAIN-2B" x="712" y="571"></use>
 <use transform="scale(0.707)" xlink:href="#E2-LATINMODERNMAIN-72" x="712" y="-211"></use>
</g>
 <use xlink:href="#E2-LATINMODERNMAIN-28" x="2210" y="0"></use>
<g transform="translate(2599,0)">
 <use xlink:href="#E2-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E2-LATINMODERNMAIN-6F" x="880" y="-213"></use>
</g>
 <use xlink:href="#E2-LATINMODERNMAIN-2C" x="3676" y="0"></use>
<g transform="translate(4121,0)">
 <use xlink:href="#E2-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E2-LATINMODERNMAIN-69" x="880" y="-213"></use>
</g>
 <use xlink:href="#E2-LATINMODERNMAIN-29" x="5040" y="0"></use>
</g>
<g transform="translate(0,-758)">
 <use xlink:href="#E2-LATINMODERNMAIN-2B" x="1000" y="0"></use>
<g transform="translate(1945,0)">
 <use xlink:href="#E2-LATINMODERNSIZE1-222B" x="0" y="0"></use>
<g transform="translate(574,-898)">
 <use transform="scale(0.707)" xlink:href="#E2-LATINMODERNMAIN-53" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E2-LATINMODERNMAIN-32" x="685" y="483"></use>
</g>
</g>
<g transform="translate(3537,0)">
 <use xlink:href="#E2-LATINMODERNSIZE1-222B" x="0" y="0"></use>
<g transform="translate(574,-898)">
 <use transform="scale(0.707)" xlink:href="#E2-LATINMODERNMAIN-53" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E2-LATINMODERNMAIN-32" x="685" y="483"></use>
</g>
</g>
<g transform="translate(5130,0)">
 <use xlink:href="#E2-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E2-LATINMODERNMAIN-2B" x="712" y="571"></use>
 <use transform="scale(0.707)" xlink:href="#E2-LATINMODERNMAIN-74" x="712" y="-384"></use>
</g>
 <use xlink:href="#E2-LATINMODERNMAIN-28" x="6284" y="0"></use>
<g transform="translate(6674,0)">
 <use xlink:href="#E2-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E2-LATINMODERNMAIN-6F" x="880" y="-213"></use>
</g>
 <use xlink:href="#E2-LATINMODERNMAIN-2C" x="7750" y="0"></use>
<g transform="translate(8195,0)">
 <use xlink:href="#E2-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E2-LATINMODERNVARIANTS-2032" x="880" y="583"></use>
</g>
 <use xlink:href="#E2-LATINMODERNMAIN-29" x="9206" y="0"></use>
<g transform="translate(9762,0)">
 <use xlink:href="#E2-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E2-LATINMODERNMAIN-2212" x="712" y="571"></use>
 <use transform="scale(0.707)" xlink:href="#E2-LATINMODERNMAIN-72" x="712" y="-211"></use>
</g>
 <use xlink:href="#E2-LATINMODERNMAIN-28" x="10916" y="0"></use>
 <use xlink:href="#E2-LATINMODERNMAIN-2212" x="11305" y="0"></use>
<g transform="translate(12084,0)">
 <use xlink:href="#E2-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E2-LATINMODERNVARIANTS-2032" x="880" y="583"></use>
</g>
 <use xlink:href="#E2-LATINMODERNMAIN-2C" x="13095" y="0"></use>
<g transform="translate(13540,0)">
 <use xlink:href="#E2-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E2-LATINMODERNVARIANTS-2033" x="880" y="583"></use>
</g>
 <use xlink:href="#E2-LATINMODERNMAIN-29" x="14720" y="0"></use>
<g transform="translate(15276,0)">
 <use xlink:href="#E2-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E2-LATINMODERNMAIN-2B" x="712" y="571"></use>
 <use transform="scale(0.707)" xlink:href="#E2-LATINMODERNMAIN-74" x="712" y="-384"></use>
</g>
 <use xlink:href="#E2-LATINMODERNMAIN-28" x="16430" y="0"></use>
 <use xlink:href="#E2-LATINMODERNMAIN-2212" x="16820" y="0"></use>
<g transform="translate(17598,0)">
 <use xlink:href="#E2-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E2-LATINMODERNVARIANTS-2033" x="880" y="583"></use>
</g>
 <use xlink:href="#E2-LATINMODERNMAIN-2C" x="18779" y="0"></use>
<g transform="translate(19224,0)">
 <use xlink:href="#E2-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E2-LATINMODERNMAIN-69" x="880" y="-213"></use>
</g>
 <use xlink:href="#E2-LATINMODERNMAIN-29" x="20143" y="0"></use>
 <use xlink:href="#E2-LATINMODERNMAIN-64" x="20699" y="0"></use>
<g transform="translate(21256,0)">
 <use xlink:href="#E2-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E2-LATINMODERNVARIANTS-2032" x="880" y="583"></use>
</g>
 <use xlink:href="#E2-LATINMODERNMAIN-64" x="22267" y="0"></use>
<g transform="translate(22823,0)">
 <use xlink:href="#E2-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E2-LATINMODERNVARIANTS-2033" x="880" y="583"></use>
</g>
 <use xlink:href="#E2-LATINMODERNMAIN-2B" x="24226" y="0"></use>
 <use xlink:href="#E2-LATINMODERNMAIN-22EF" x="25226" y="0"></use>
 <use xlink:href="#E2-LATINMODERNMAIN-2E" x="26169" y="0"></use>
</g>
</g>
</g>
</g>
</svg>
</div>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">
<div class="eqno">(<a href="#eq:pdf-estimate-sum">14.36</a>)</div>
</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">
<p>

The first term gives the contribution for the PDF at the top interface and
the second is the PDF for directions <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.135ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 919.4 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">omega Subscript normal i</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-69" d="M247 0c-34 1 -69 3 -104 3l-110 -3v31c67 0 78 0 78 45v269c0 49 -9 55 -74 55v31l140 11v-367c0 -39 4 -44 70 -44v-31zM192 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="880" y="-213"></use>
</g>
</svg> that were sampled via
transmission through the top interface, scattering at the bottom, and then
transmission back out in direction <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.135ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 919.4 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">omega Subscript normal i</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-69" d="M247 0c-34 1 -69 3 -104 3l-110 -3v31c67 0 78 0 78 45v269c0 49 -9 55 -74 55v31l140 11v-367c0 -39 4 -44 70 -44v-31zM192 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="880" y="-213"></use>
</g>
</svg>.  Note the coupling of directions
between the PDF factors in the integrand: the negation of the initial transmitted direction
<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.347ex" height="2.343ex" style="vertical-align: -0.338ex;" viewBox="0 -863.1 1010.6 1008.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">omega prime Subscript</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
<path stroke-width="1" id="E1-LATINMODERNVARIANTS-2032" d="M340 496c0 -10 -3 -20 -8 -28l-227 -372h-38l171 424c6 15 26 29 48 29c30 0 54 -24 54 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNVARIANTS-2032" x="880" y="513"></use>
</g>
</svg> gives the first direction for evaluation of the base PDF
<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.753ex" height="2.843ex" style="vertical-align: -0.671ex; margin-left: -0.073ex;" viewBox="-31.5 -934.9 1185.5 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">p Subscript normal r Superscript minus</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45D" d="M490 282c0 -147 -125 -293 -241 -293c-51 0 -79 35 -92 64c-7 -25 -49 -188 -49 -200c0 -9 0 -16 50 -16c14 0 24 0 24 -11c0 -20 -13 -20 -18 -20c-32 0 -66 3 -99 3c-28 0 -57 -3 -84 -3c-8 0 -13 4 -13 12c0 19 11 19 23 19c44 0 46 7 54 41l112 445c4 17 7 28 7 51 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c37 0 80 -21 90 -75c33 39 81 75 131 75c76 0 133 -66 133 -160zM418 326c0 59 -24 94 -64 94c-17 0 -46 -7 -81 -38c-18 -15 -45 -43 -52 -70 l-49 -196c-3 -12 -3 -16 -3 -16c0 -6 13 -89 79 -89c37 0 85 33 119 103c18 38 51 153 51 212Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2212" d="M722 250c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-72" d="M364 381c0 -32 -25 -44 -43 -44c-22 0 -43 15 -43 43c0 26 20 38 23 39c-2 1 -4 1 -11 1c-76 0 -118 -89 -118 -188v-154c0 -36 2 -47 76 -47h21v-31c-40 3 -87 3 -127 3l-114 -3v31c67 0 78 0 78 45v268c0 49 -8 56 -78 56v31l139 11v-110c14 43 50 110 123 110 c43 0 74 -29 74 -61Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="712" y="571"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-72" x="712" y="-211"></use>
</g>
</svg>, and so forth (see Figure&nbsp;<a href="#fig:layered-pdf-sampling">14.21</a>).
Subsequent terms of this sum account for
light that is reflected back downward at the top interface instead of
exiting the layers, and expressions of a similar form can be found for the
PDF if the base layer is also transmissive.

</p>
<p>It is possible to compute a stochastic estimate of the PDF by applying
Monte Carlo to the integrals and by terminating the infinite sum using
Russian roulette.
For example, for the integral in Equation&nbsp;(<a href="#eq:pdf-estimate-sum">14.36</a>), we have the
estimator
</p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">
<span class="anchor" id="eq:pdf-triple-estimate"></span><div class="displaymath"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="37.257ex" height="6.676ex" style="vertical-align: -2.671ex;" viewBox="0 -1724.2 16041.1 2874.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">StartFraction p Subscript normal t Superscript plus Baseline left-parenthesis omega Subscript normal o Baseline comma omega prime Subscript Baseline right-parenthesis p Subscript normal r Superscript minus Baseline left-parenthesis minus omega prime Subscript Baseline comma omega double-prime Subscript Baseline right-parenthesis p Subscript normal t Superscript plus Baseline left-parenthesis minus omega double-prime Subscript Baseline comma omega Subscript normal i Baseline right-parenthesis Over p 1 left-parenthesis omega prime Subscript Baseline right-parenthesis p 2 left-parenthesis omega double-prime Subscript Baseline right-parenthesis EndFraction comma</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E2-LATINMODERNNORMAL-1D45D" d="M490 282c0 -147 -125 -293 -241 -293c-51 0 -79 35 -92 64c-7 -25 -49 -188 -49 -200c0 -9 0 -16 50 -16c14 0 24 0 24 -11c0 -20 -13 -20 -18 -20c-32 0 -66 3 -99 3c-28 0 -57 -3 -84 -3c-8 0 -13 4 -13 12c0 19 11 19 23 19c44 0 46 7 54 41l112 445c4 17 7 28 7 51 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c37 0 80 -21 90 -75c33 39 81 75 131 75c76 0 133 -66 133 -160zM418 326c0 59 -24 94 -64 94c-17 0 -46 -7 -81 -38c-18 -15 -45 -43 -52 -70 l-49 -196c-3 -12 -3 -16 -3 -16c0 -6 13 -89 79 -89c37 0 85 33 119 103c18 38 51 153 51 212Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-2B" d="M722 250c0 -11 -9 -20 -20 -20h-293v-293c0 -11 -9 -20 -20 -20s-20 9 -20 20v293h-293c-11 0 -20 9 -20 20s9 20 20 20h293v293c0 11 9 20 20 20s20 -9 20 -20v-293h293c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-74" d="M332 124c0 -64 -28 -135 -99 -135c-36 0 -129 12 -129 135v276h-85v22c98 4 128 111 129 193h25v-184h143v-31h-143v-278c0 -17 0 -108 67 -108c37 0 67 38 67 112v55h25v-57Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E2-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-6F" d="M471 214c0 -127 -101 -225 -222 -225c-117 0 -221 96 -221 225c0 125 97 234 222 234c121 0 221 -106 221 -234zM388 222c0 38 0 96 -26 139s-69 65 -113 65c-40 0 -87 -21 -114 -67c-24 -44 -24 -98 -24 -137c0 -36 0 -97 25 -141c27 -46 71 -67 114 -67 c50 0 94 29 116 74c22 44 22 98 22 134Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E2-LATINMODERNVARIANTS-2032" d="M340 496c0 -10 -3 -20 -8 -28l-227 -372h-38l171 424c6 15 26 29 48 29c30 0 54 -24 54 -53Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-2212" d="M722 250c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-72" d="M364 381c0 -32 -25 -44 -43 -44c-22 0 -43 15 -43 43c0 26 20 38 23 39c-2 1 -4 1 -11 1c-76 0 -118 -89 -118 -188v-154c0 -36 2 -47 76 -47h21v-31c-40 3 -87 3 -127 3l-114 -3v31c67 0 78 0 78 45v268c0 49 -8 56 -78 56v31l139 11v-110c14 43 50 110 123 110 c43 0 74 -29 74 -61Z"></path>
<path stroke-width="1" id="E2-LATINMODERNVARIANTS-2033" d="M340 496c0 -10 -3 -20 -8 -28l-227 -372h-38l171 424c6 15 26 29 48 29c30 0 54 -24 54 -53zM580 496c0 -10 -3 -20 -8 -28l-227 -372h-38l171 424c6 15 26 29 48 29c30 0 54 -24 54 -53Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-69" d="M247 0c-34 1 -69 3 -104 3l-110 -3v31c67 0 78 0 78 45v269c0 49 -9 55 -74 55v31l140 11v-367c0 -39 4 -44 70 -44v-31zM192 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-32" d="M449 174l-28 -174h-371c0 24 0 26 11 37l192 214c55 62 105 141 105 221c0 82 -43 163 -134 163c-58 0 -112 -37 -135 -102c3 1 5 1 13 1c35 0 53 -26 53 -52c0 -41 -35 -53 -52 -53c-3 0 -53 0 -53 56c0 89 74 181 187 181c122 0 212 -80 212 -194 c0 -100 -60 -154 -216 -292l-106 -103h180c22 0 88 0 95 8c10 15 17 59 22 89h25Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
<g transform="translate(120,0)">
<rect stroke="none" width="15522" height="60" x="0" y="220"></rect>
<g transform="translate(60,799)">
 <use xlink:href="#E2-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E2-LATINMODERNMAIN-2B" x="712" y="571"></use>
 <use transform="scale(0.707)" xlink:href="#E2-LATINMODERNMAIN-74" x="712" y="-384"></use>
 <use xlink:href="#E2-LATINMODERNMAIN-28" x="1153" y="0"></use>
<g transform="translate(1543,0)">
 <use xlink:href="#E2-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E2-LATINMODERNMAIN-6F" x="880" y="-213"></use>
</g>
 <use xlink:href="#E2-LATINMODERNMAIN-2C" x="2619" y="0"></use>
<g transform="translate(3065,0)">
 <use xlink:href="#E2-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E2-LATINMODERNVARIANTS-2032" x="880" y="513"></use>
</g>
 <use xlink:href="#E2-LATINMODERNMAIN-29" x="4075" y="0"></use>
<g transform="translate(4631,0)">
 <use xlink:href="#E2-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E2-LATINMODERNMAIN-2212" x="712" y="571"></use>
 <use transform="scale(0.707)" xlink:href="#E2-LATINMODERNMAIN-72" x="712" y="-211"></use>
</g>
 <use xlink:href="#E2-LATINMODERNMAIN-28" x="5785" y="0"></use>
 <use xlink:href="#E2-LATINMODERNMAIN-2212" x="6175" y="0"></use>
<g transform="translate(6953,0)">
 <use xlink:href="#E2-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E2-LATINMODERNVARIANTS-2032" x="880" y="513"></use>
</g>
 <use xlink:href="#E2-LATINMODERNMAIN-2C" x="7964" y="0"></use>
<g transform="translate(8409,0)">
 <use xlink:href="#E2-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E2-LATINMODERNVARIANTS-2033" x="880" y="513"></use>
</g>
 <use xlink:href="#E2-LATINMODERNMAIN-29" x="9590" y="0"></use>
<g transform="translate(10146,0)">
 <use xlink:href="#E2-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E2-LATINMODERNMAIN-2B" x="712" y="571"></use>
 <use transform="scale(0.707)" xlink:href="#E2-LATINMODERNMAIN-74" x="712" y="-384"></use>
</g>
 <use xlink:href="#E2-LATINMODERNMAIN-28" x="11300" y="0"></use>
 <use xlink:href="#E2-LATINMODERNMAIN-2212" x="11689" y="0"></use>
<g transform="translate(12468,0)">
 <use xlink:href="#E2-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E2-LATINMODERNVARIANTS-2033" x="880" y="513"></use>
</g>
 <use xlink:href="#E2-LATINMODERNMAIN-2C" x="13648" y="0"></use>
<g transform="translate(14093,0)">
 <use xlink:href="#E2-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E2-LATINMODERNMAIN-69" x="880" y="-213"></use>
</g>
 <use xlink:href="#E2-LATINMODERNMAIN-29" x="15013" y="0"></use>
</g>
<g transform="translate(4846,-769)">
 <use xlink:href="#E2-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E2-LATINMODERNMAIN-31" x="712" y="-213"></use>
 <use xlink:href="#E2-LATINMODERNMAIN-28" x="957" y="0"></use>
<g transform="translate(1346,0)">
 <use xlink:href="#E2-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E2-LATINMODERNVARIANTS-2032" x="880" y="408"></use>
</g>
 <use xlink:href="#E2-LATINMODERNMAIN-29" x="2357" y="0"></use>
<g transform="translate(2913,0)">
 <use xlink:href="#E2-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E2-LATINMODERNMAIN-32" x="712" y="-213"></use>
</g>
 <use xlink:href="#E2-LATINMODERNMAIN-28" x="3871" y="0"></use>
<g transform="translate(4260,0)">
 <use xlink:href="#E2-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E2-LATINMODERNVARIANTS-2033" x="880" y="408"></use>
</g>
 <use xlink:href="#E2-LATINMODERNMAIN-29" x="5440" y="0"></use>
</g>
</g>
 <use xlink:href="#E2-LATINMODERNMAIN-2C" x="15762" y="0"></use>
</g>
</svg>
</div>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">
<div class="eqno">(<a href="#eq:pdf-triple-estimate">14.37</a>)</div>
</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">
<p>

where <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.347ex" height="2.343ex" style="vertical-align: -0.338ex;" viewBox="0 -863.1 1010.6 1008.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">omega prime Subscript</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
<path stroke-width="1" id="E1-LATINMODERNVARIANTS-2032" d="M340 496c0 -10 -3 -20 -8 -28l-227 -372h-38l171 424c6 15 26 29 48 29c30 0 54 -24 54 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNVARIANTS-2032" x="880" y="513"></use>
</g>
</svg> is sampled from some distribution <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.297ex" height="2.009ex" style="vertical-align: -0.671ex; margin-left: -0.073ex;" viewBox="-31.5 -576.1 988.9 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">p 1</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45D" d="M490 282c0 -147 -125 -293 -241 -293c-51 0 -79 35 -92 64c-7 -25 -49 -188 -49 -200c0 -9 0 -16 50 -16c14 0 24 0 24 -11c0 -20 -13 -20 -18 -20c-32 0 -66 3 -99 3c-28 0 -57 -3 -84 -3c-8 0 -13 4 -13 12c0 19 11 19 23 19c44 0 46 7 54 41l112 445c4 17 7 28 7 51 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c37 0 80 -21 90 -75c33 39 81 75 131 75c76 0 133 -66 133 -160zM418 326c0 59 -24 94 -64 94c-17 0 -46 -7 -81 -38c-18 -15 -45 -43 -52 -70 l-49 -196c-3 -12 -3 -16 -3 -16c0 -6 13 -89 79 -89c37 0 85 33 119 103c18 38 51 153 51 212Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="712" y="-213"></use>
</g>
</svg> and <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.741ex" height="2.343ex" style="vertical-align: -0.338ex;" viewBox="0 -863.1 1180.4 1008.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">omega double-prime Subscript</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E2-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
<path stroke-width="1" id="E2-LATINMODERNVARIANTS-2033" d="M340 496c0 -10 -3 -20 -8 -28l-227 -372h-38l171 424c6 15 26 29 48 29c30 0 54 -24 54 -53zM580 496c0 -10 -3 -20 -8 -28l-227 -372h-38l171 424c6 15 26 29 48 29c30 0 54 -24 54 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E2-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E2-LATINMODERNVARIANTS-2033" x="880" y="513"></use>
</g>
</svg> from a
distribution <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.297ex" height="2.009ex" style="vertical-align: -0.671ex; margin-left: -0.073ex;" viewBox="-31.5 -576.1 988.9 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">p 2</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45D" d="M490 282c0 -147 -125 -293 -241 -293c-51 0 -79 35 -92 64c-7 -25 -49 -188 -49 -200c0 -9 0 -16 50 -16c14 0 24 0 24 -11c0 -20 -13 -20 -18 -20c-32 0 -66 3 -99 3c-28 0 -57 -3 -84 -3c-8 0 -13 4 -13 12c0 19 11 19 23 19c44 0 46 7 54 41l112 445c4 17 7 28 7 51 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c37 0 80 -21 90 -75c33 39 81 75 131 75c76 0 133 -66 133 -160zM418 326c0 59 -24 94 -64 94c-17 0 -46 -7 -81 -38c-18 -15 -45 -43 -52 -70 l-49 -196c-3 -12 -3 -16 -3 -16c0 -6 13 -89 79 -89c37 0 85 33 119 103c18 38 51 153 51 212Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-32" d="M449 174l-28 -174h-371c0 24 0 26 11 37l192 214c55 62 105 141 105 221c0 82 -43 163 -134 163c-58 0 -112 -37 -135 -102c3 1 5 1 13 1c35 0 53 -26 53 -52c0 -41 -35 -53 -52 -53c-3 0 -53 0 -53 56c0 89 74 181 187 181c122 0 212 -80 212 -194 c0 -100 -60 -154 -216 -292l-106 -103h180c22 0 88 0 95 8c10 15 17 59 22 89h25Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-32" x="712" y="-213"></use>
</g>
</svg>.  There is great freedom in choosing the distributions
<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.297ex" height="2.009ex" style="vertical-align: -0.671ex; margin-left: -0.073ex;" viewBox="-31.5 -576.1 988.9 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">p 1</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45D" d="M490 282c0 -147 -125 -293 -241 -293c-51 0 -79 35 -92 64c-7 -25 -49 -188 -49 -200c0 -9 0 -16 50 -16c14 0 24 0 24 -11c0 -20 -13 -20 -18 -20c-32 0 -66 3 -99 3c-28 0 -57 -3 -84 -3c-8 0 -13 4 -13 12c0 19 11 19 23 19c44 0 46 7 54 41l112 445c4 17 7 28 7 51 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c37 0 80 -21 90 -75c33 39 81 75 131 75c76 0 133 -66 133 -160zM418 326c0 59 -24 94 -64 94c-17 0 -46 -7 -81 -38c-18 -15 -45 -43 -52 -70 l-49 -196c-3 -12 -3 -16 -3 -16c0 -6 13 -89 79 -89c37 0 85 33 119 103c18 38 51 153 51 212Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-31" x="712" y="-213"></use>
</g>
</svg> and <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.297ex" height="2.009ex" style="vertical-align: -0.671ex; margin-left: -0.073ex;" viewBox="-31.5 -576.1 988.9 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">p 2</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45D" d="M490 282c0 -147 -125 -293 -241 -293c-51 0 -79 35 -92 64c-7 -25 -49 -188 -49 -200c0 -9 0 -16 50 -16c14 0 24 0 24 -11c0 -20 -13 -20 -18 -20c-32 0 -66 3 -99 3c-28 0 -57 -3 -84 -3c-8 0 -13 4 -13 12c0 19 11 19 23 19c44 0 46 7 54 41l112 445c4 17 7 28 7 51 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c37 0 80 -21 90 -75c33 39 81 75 131 75c76 0 133 -66 133 -160zM418 326c0 59 -24 94 -64 94c-17 0 -46 -7 -81 -38c-18 -15 -45 -43 -52 -70 l-49 -196c-3 -12 -3 -16 -3 -16c0 -6 13 -89 79 -89c37 0 85 33 119 103c18 38 51 153 51 212Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-32" d="M449 174l-28 -174h-371c0 24 0 26 11 37l192 214c55 62 105 141 105 221c0 82 -43 163 -134 163c-58 0 -112 -37 -135 -102c3 1 5 1 13 1c35 0 53 -26 53 -52c0 -41 -35 -53 -52 -53c-3 0 -53 0 -53 56c0 89 74 181 187 181c122 0 212 -80 212 -194 c0 -100 -60 -154 -216 -292l-106 -103h180c22 0 88 0 95 8c10 15 17 59 22 89h25Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-32" x="712" y="-213"></use>
</g>
</svg>.  However, as
with algorithms like path tracing, care must be taken if some of the PDFs
are Dirac delta distributions.  For example, if the bottom layer is
perfect specular, then <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="12.494ex" height="3.009ex" style="vertical-align: -0.838ex; margin-left: -0.073ex;" viewBox="-31.5 -934.9 5379.1 1295.7" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">p Subscript normal r Superscript minus Baseline left-parenthesis minus omega prime Subscript Baseline comma omega double-prime Subscript Baseline right-parenthesis</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E2-LATINMODERNNORMAL-1D45D" d="M490 282c0 -147 -125 -293 -241 -293c-51 0 -79 35 -92 64c-7 -25 -49 -188 -49 -200c0 -9 0 -16 50 -16c14 0 24 0 24 -11c0 -20 -13 -20 -18 -20c-32 0 -66 3 -99 3c-28 0 -57 -3 -84 -3c-8 0 -13 4 -13 12c0 19 11 19 23 19c44 0 46 7 54 41l112 445c4 17 7 28 7 51 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c37 0 80 -21 90 -75c33 39 81 75 131 75c76 0 133 -66 133 -160zM418 326c0 59 -24 94 -64 94c-17 0 -46 -7 -81 -38c-18 -15 -45 -43 -52 -70 l-49 -196c-3 -12 -3 -16 -3 -16c0 -6 13 -89 79 -89c37 0 85 33 119 103c18 38 51 153 51 212Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-2212" d="M722 250c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-72" d="M364 381c0 -32 -25 -44 -43 -44c-22 0 -43 15 -43 43c0 26 20 38 23 39c-2 1 -4 1 -11 1c-76 0 -118 -89 -118 -188v-154c0 -36 2 -47 76 -47h21v-31c-40 3 -87 3 -127 3l-114 -3v31c67 0 78 0 78 45v268c0 49 -8 56 -78 56v31l139 11v-110c14 43 50 110 123 110 c43 0 74 -29 74 -61Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E2-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
<path stroke-width="1" id="E2-LATINMODERNVARIANTS-2032" d="M340 496c0 -10 -3 -20 -8 -28l-227 -372h-38l171 424c6 15 26 29 48 29c30 0 54 -24 54 -53Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E2-LATINMODERNVARIANTS-2033" d="M340 496c0 -10 -3 -20 -8 -28l-227 -372h-38l171 424c6 15 26 29 48 29c30 0 54 -24 54 -53zM580 496c0 -10 -3 -20 -8 -28l-227 -372h-38l171 424c6 15 26 29 48 29c30 0 54 -24 54 -53Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E2-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E2-LATINMODERNMAIN-2212" x="712" y="571"></use>
 <use transform="scale(0.707)" xlink:href="#E2-LATINMODERNMAIN-72" x="712" y="-211"></use>
 <use xlink:href="#E2-LATINMODERNMAIN-28" x="1153" y="0"></use>
 <use xlink:href="#E2-LATINMODERNMAIN-2212" x="1543" y="0"></use>
<g transform="translate(2321,0)">
 <use xlink:href="#E2-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E2-LATINMODERNVARIANTS-2032" x="880" y="513"></use>
</g>
 <use xlink:href="#E2-LATINMODERNMAIN-2C" x="3332" y="0"></use>
<g transform="translate(3777,0)">
 <use xlink:href="#E2-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E2-LATINMODERNVARIANTS-2033" x="880" y="513"></use>
</g>
 <use xlink:href="#E2-LATINMODERNMAIN-29" x="4958" y="0"></use>
</g>
</svg> will always be
zero unless <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.741ex" height="2.343ex" style="vertical-align: -0.338ex;" viewBox="0 -863.1 1180.4 1008.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">omega double-prime Subscript</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E2-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
<path stroke-width="1" id="E2-LATINMODERNVARIANTS-2033" d="M340 496c0 -10 -3 -20 -8 -28l-227 -372h-38l171 424c6 15 26 29 48 29c30 0 54 -24 54 -53zM580 496c0 -10 -3 -20 -8 -28l-227 -372h-38l171 424c6 15 26 29 48 29c30 0 54 -24 54 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E2-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E2-LATINMODERNVARIANTS-2033" x="880" y="513"></use>
</g>
</svg> was sampled according to its PDF.

</p>
<p>Consider what happens if <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.347ex" height="2.343ex" style="vertical-align: -0.338ex;" viewBox="0 -863.1 1010.6 1008.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">omega prime Subscript</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
<path stroke-width="1" id="E1-LATINMODERNVARIANTS-2032" d="M340 496c0 -10 -3 -20 -8 -28l-227 -372h-38l171 424c6 15 26 29 48 29c30 0 54 -24 54 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNVARIANTS-2032" x="880" y="513"></use>
</g>
</svg> is sampled using
<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.837ex" height="3.009ex" style="vertical-align: -0.838ex;" viewBox="0 -934.9 1221.6 1295.7" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">f Subscript normal t Superscript plus</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D453" d="M552 636c0 -38 -29 -60 -55 -60c-19 0 -37 12 -37 35c0 15 10 50 54 54c-19 18 -45 18 -49 18c-21 0 -38 -15 -47 -34c-6 -12 -20 -83 -24 -104c-11 -58 -10 -56 -21 -114h83c17 0 27 0 27 -11c0 -20 -10 -20 -30 -20h-86l-60 -317c-1 -7 -24 -128 -56 -191 c-18 -38 -58 -97 -113 -97c-41 0 -85 24 -85 69c0 38 29 60 55 60c19 0 37 -12 37 -35c0 -15 -9 -51 -55 -54c19 -18 44 -18 48 -18c52 0 69 91 87 188l75 395h-66c-19 0 -28 0 -28 12c0 19 11 19 30 19h69c24 126 27 136 33 157c30 99 93 117 127 117c41 0 87 -23 87 -69Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2B" d="M722 250c0 -11 -9 -20 -20 -20h-293v-293c0 -11 -9 -20 -20 -20s-20 9 -20 20v293h-293c-11 0 -20 9 -20 20s9 20 20 20h293v293c0 11 9 20 20 20s20 -9 20 -20v-293h293c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-74" d="M332 124c0 -64 -28 -135 -99 -135c-36 0 -129 12 -129 135v276h-85v22c98 4 128 111 129 193h25v-184h143v-31h-143v-278c0 -17 0 -108 67 -108c37 0 67 38 67 112v55h25v-57Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D453" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2B" x="807" y="571"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-74" x="693" y="-384"></use>
</g>
</svg>&rsquo;s sampling method, conditioned on <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.5ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 1076.4 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">omega Subscript normal o</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6F" d="M471 214c0 -127 -101 -225 -222 -225c-117 0 -221 96 -221 225c0 125 97 234 222 234c121 0 221 -106 221 -234zM388 222c0 38 0 96 -26 139s-69 65 -113 65c-40 0 -87 -21 -114 -67c-24 -44 -24 -98 -24 -137c0 -36 0 -97 25 -141c27 -46 71 -67 114 -67 c50 0 94 29 116 74c22 44 22 98 22 134Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6F" x="880" y="-213"></use>
</g>
</svg>, and if <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.741ex" height="2.343ex" style="vertical-align: -0.338ex;" viewBox="0 -863.1 1180.4 1008.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">omega double-prime Subscript</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E2-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
<path stroke-width="1" id="E2-LATINMODERNVARIANTS-2033" d="M340 496c0 -10 -3 -20 -8 -28l-227 -372h-38l171 424c6 15 26 29 48 29c30 0 54 -24 54 -53zM580 496c0 -10 -3 -20 -8 -28l-227 -372h-38l171 424c6 15 26 29 48 29c30 0 54 -24 54 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E2-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E2-LATINMODERNVARIANTS-2033" x="880" y="513"></use>
</g>
</svg> is
sampled using <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.837ex" height="3.009ex" style="vertical-align: -0.838ex;" viewBox="0 -934.9 1221.6 1295.7" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">f Subscript normal t Superscript plus</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D453" d="M552 636c0 -38 -29 -60 -55 -60c-19 0 -37 12 -37 35c0 15 10 50 54 54c-19 18 -45 18 -49 18c-21 0 -38 -15 -47 -34c-6 -12 -20 -83 -24 -104c-11 -58 -10 -56 -21 -114h83c17 0 27 0 27 -11c0 -20 -10 -20 -30 -20h-86l-60 -317c-1 -7 -24 -128 -56 -191 c-18 -38 -58 -97 -113 -97c-41 0 -85 24 -85 69c0 38 29 60 55 60c19 0 37 -12 37 -35c0 -15 -9 -51 -55 -54c19 -18 44 -18 48 -18c52 0 69 91 87 188l75 395h-66c-19 0 -28 0 -28 12c0 19 11 19 30 19h69c24 126 27 136 33 157c30 99 93 117 127 117c41 0 87 -23 87 -69Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2B" d="M722 250c0 -11 -9 -20 -20 -20h-293v-293c0 -11 -9 -20 -20 -20s-20 9 -20 20v293h-293c-11 0 -20 9 -20 20s9 20 20 20h293v293c0 11 9 20 20 20s20 -9 20 -20v-293h293c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-74" d="M332 124c0 -64 -28 -135 -99 -135c-36 0 -129 12 -129 135v276h-85v22c98 4 128 111 129 193h25v-184h143v-31h-143v-278c0 -17 0 -108 67 -108c37 0 67 38 67 112v55h25v-57Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D453" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2B" x="807" y="571"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-74" x="693" y="-384"></use>
</g>
</svg>&rsquo;s sampling method, conditioned on <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.135ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 919.4 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">omega Subscript normal i</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-69" d="M247 0c-34 1 -69 3 -104 3l-110 -3v31c67 0 78 0 78 45v269c0 49 -9 55 -74 55v31l140 11v-367c0 -39 4 -44 70 -44v-31zM192 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="880" y="-213"></use>
</g>
</svg>: the
first and last probabilities in the numerator cancel with the probabilities
in the denominator, and we are left simply with <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="12.494ex" height="3.009ex" style="vertical-align: -0.838ex; margin-left: -0.073ex;" viewBox="-31.5 -934.9 5379.1 1295.7" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">p Subscript normal r Superscript minus Baseline left-parenthesis minus omega prime Subscript Baseline comma omega double-prime Subscript Baseline right-parenthesis</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E2-LATINMODERNNORMAL-1D45D" d="M490 282c0 -147 -125 -293 -241 -293c-51 0 -79 35 -92 64c-7 -25 -49 -188 -49 -200c0 -9 0 -16 50 -16c14 0 24 0 24 -11c0 -20 -13 -20 -18 -20c-32 0 -66 3 -99 3c-28 0 -57 -3 -84 -3c-8 0 -13 4 -13 12c0 19 11 19 23 19c44 0 46 7 54 41l112 445c4 17 7 28 7 51 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c37 0 80 -21 90 -75c33 39 81 75 131 75c76 0 133 -66 133 -160zM418 326c0 59 -24 94 -64 94c-17 0 -46 -7 -81 -38c-18 -15 -45 -43 -52 -70 l-49 -196c-3 -12 -3 -16 -3 -16c0 -6 13 -89 79 -89c37 0 85 33 119 103c18 38 51 153 51 212Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-2212" d="M722 250c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-72" d="M364 381c0 -32 -25 -44 -43 -44c-22 0 -43 15 -43 43c0 26 20 38 23 39c-2 1 -4 1 -11 1c-76 0 -118 -89 -118 -188v-154c0 -36 2 -47 76 -47h21v-31c-40 3 -87 3 -127 3l-114 -3v31c67 0 78 0 78 45v268c0 49 -8 56 -78 56v31l139 11v-110c14 43 50 110 123 110 c43 0 74 -29 74 -61Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E2-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
<path stroke-width="1" id="E2-LATINMODERNVARIANTS-2032" d="M340 496c0 -10 -3 -20 -8 -28l-227 -372h-38l171 424c6 15 26 29 48 29c30 0 54 -24 54 -53Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E2-LATINMODERNVARIANTS-2033" d="M340 496c0 -10 -3 -20 -8 -28l-227 -372h-38l171 424c6 15 26 29 48 29c30 0 54 -24 54 -53zM580 496c0 -10 -3 -20 -8 -28l-227 -372h-38l171 424c6 15 26 29 48 29c30 0 54 -24 54 -53Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E2-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E2-LATINMODERNMAIN-2212" x="712" y="571"></use>
 <use transform="scale(0.707)" xlink:href="#E2-LATINMODERNMAIN-72" x="712" y="-211"></use>
 <use xlink:href="#E2-LATINMODERNMAIN-28" x="1153" y="0"></use>
 <use xlink:href="#E2-LATINMODERNMAIN-2212" x="1543" y="0"></use>
<g transform="translate(2321,0)">
 <use xlink:href="#E2-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E2-LATINMODERNVARIANTS-2032" x="880" y="513"></use>
</g>
 <use xlink:href="#E2-LATINMODERNMAIN-2C" x="3332" y="0"></use>
<g transform="translate(3777,0)">
 <use xlink:href="#E2-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E2-LATINMODERNVARIANTS-2033" x="880" y="513"></use>
</g>
 <use xlink:href="#E2-LATINMODERNMAIN-29" x="4958" y="0"></use>
</g>
</svg> as the estimate; the effect of <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.837ex" height="3.009ex" style="vertical-align: -0.838ex;" viewBox="0 -934.9 1221.6 1295.7" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">f Subscript normal t Superscript plus</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D453" d="M552 636c0 -38 -29 -60 -55 -60c-19 0 -37 12 -37 35c0 15 10 50 54 54c-19 18 -45 18 -49 18c-21 0 -38 -15 -47 -34c-6 -12 -20 -83 -24 -104c-11 -58 -10 -56 -21 -114h83c17 0 27 0 27 -11c0 -20 -10 -20 -30 -20h-86l-60 -317c-1 -7 -24 -128 -56 -191 c-18 -38 -58 -97 -113 -97c-41 0 -85 24 -85 69c0 38 29 60 55 60c19 0 37 -12 37 -35c0 -15 -9 -51 -55 -54c19 -18 44 -18 48 -18c52 0 69 91 87 188l75 395h-66c-19 0 -28 0 -28 12c0 19 11 19 30 19h69c24 126 27 136 33 157c30 99 93 117 127 117c41 0 87 -23 87 -69Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2B" d="M722 250c0 -11 -9 -20 -20 -20h-293v-293c0 -11 -9 -20 -20 -20s-20 9 -20 20v293h-293c-11 0 -20 9 -20 20s9 20 20 20h293v293c0 11 9 20 20 20s20 -9 20 -20v-293h293c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-74" d="M332 124c0 -64 -28 -135 -99 -135c-36 0 -129 12 -129 135v276h-85v22c98 4 128 111 129 193h25v-184h143v-31h-143v-278c0 -17 0 -108 67 -108c37 0 67 38 67 112v55h25v-57Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D453" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2B" x="807" y="571"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-74" x="693" y="-384"></use>
</g>
</svg> in the PDF is fully
encapsulated by the distribution of directions used to evaluate
<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.753ex" height="2.843ex" style="vertical-align: -0.671ex; margin-left: -0.073ex;" viewBox="-31.5 -934.9 1185.5 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">p Subscript normal r Superscript minus</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45D" d="M490 282c0 -147 -125 -293 -241 -293c-51 0 -79 35 -92 64c-7 -25 -49 -188 -49 -200c0 -9 0 -16 50 -16c14 0 24 0 24 -11c0 -20 -13 -20 -18 -20c-32 0 -66 3 -99 3c-28 0 -57 -3 -84 -3c-8 0 -13 4 -13 12c0 19 11 19 23 19c44 0 46 7 54 41l112 445c4 17 7 28 7 51 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c37 0 80 -21 90 -75c33 39 81 75 131 75c76 0 133 -66 133 -160zM418 326c0 59 -24 94 -64 94c-17 0 -46 -7 -81 -38c-18 -15 -45 -43 -52 -70 l-49 -196c-3 -12 -3 -16 -3 -16c0 -6 13 -89 79 -89c37 0 85 33 119 103c18 38 51 153 51 212Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2212" d="M722 250c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-72" d="M364 381c0 -32 -25 -44 -43 -44c-22 0 -43 15 -43 43c0 26 20 38 23 39c-2 1 -4 1 -11 1c-76 0 -118 -89 -118 -188v-154c0 -36 2 -47 76 -47h21v-31c-40 3 -87 3 -127 3l-114 -3v31c67 0 78 0 78 45v268c0 49 -8 56 -78 56v31l139 11v-110c14 43 50 110 123 110 c43 0 74 -29 74 -61Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="712" y="571"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-72" x="712" y="-211"></use>
</g>
</svg>.

</p>
<p>A stochastic estimate of the PDF can be computed by following a random walk
in a manner similar to the <tt>f()</tt> method, just with phase function and
BSDF evaluation replaced with evaluations of the corresponding PDFs.
However, because the <tt>PDF()</tt> method is only called to compute PDF
values that are used for computing MIS weights, the implementation here
will return an approximate PDF; doing so does not invalidate the MIS
estimator.<button style="button" data-toggle="tooltip" data-placement="right" data-html="true" class="btn footnote-button" title="It is admittedly unfriendly to provide an
implementation of a method with a name that very clearly indicates that it
should return a valid PDF and yet does not in fact do that, and to justify
this with the fact that doing so is fine due to the current usage of
the function.  This represents a potentially gnarly bug lying in wait for
someone in the future who might not expect this when extending the system.  For
that, our apologies in advance.">
      <sup>&dagger;</sup>
    </button>
		

</p>
<p></p>
<span class="anchor" id="fragment-LayeredBxDFPublicMethods-1"></span><div class="fragmentname">&lt;&lt;LayeredBxDF Public Methods&gt;&gt;+=&nbsp;<a href="#fragment-LayeredBxDFPublicMethods-0"><span class="fa fa-caret-up"></span></a></div>
<div class="fragmentcode">Float <span class="anchor" id="LayeredBxDF::PDF"></span>PDF(<a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> wo, <a href="../Geometry_and_Transformations/Vectors.html#Vector3f" class="code">Vector3f</a> wi, <a href="../Reflection_Models/Dielectric_BSDF.html#TransportMode" class="code">TransportMode</a> mode,
          <a href="../Reflection_Models/BSDF_Representation.html#BxDFReflTransFlags" class="code">BxDFReflTransFlags</a> sampleFlags = <a href="../Reflection_Models/BSDF_Representation.html#BxDFReflTransFlags" class="code">BxDFReflTransFlags</a>::All) const {
    &lt;&lt;<span class="fragmentname"><a href="#fragment-SetmonowoandmonowiforlayeredBSDFevaluation-0">Set <tt>wo</tt> and <tt>wi</tt> for layered BSDF evaluation</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2386" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2386"><i></i></a><div id="fragbit-2386" class="collapse show"><div class="fragmentcode">       if (<a href="#LayeredBxDF::twoSided" class="code">twoSided</a> &amp;&amp; wo.z &lt; 0) {
           wo = -wo;
           wi = -wi;
       }</div></div>
    &lt;&lt;<span class="fragmentname"><a href="#fragment-DeclaremonoRNGforlayeredPDFevaluation-0">Declare <tt>RNG</tt> for layered PDF evaluation</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2387" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2387"><i></i></a><div id="fragbit-2387" class="collapse show"><div class="fragmentcode">       <a href="../Utilities/Mathematical_Infrastructure.html#RNG" class="code">RNG</a> rng(<a href="../Utilities/Mathematical_Infrastructure.html#Hash" class="code">Hash</a>(<a href="../Utilities/System_Startup,_Cleanup,_and_Options.html#GetOptions" class="code">GetOptions</a>().<a href="../Utilities/System_Startup,_Cleanup,_and_Options.html#BasicPBRTOptions::seed" class="code">seed</a>, wi), <a href="../Utilities/Mathematical_Infrastructure.html#Hash" class="code">Hash</a>(wo));
       auto r = [&amp;rng]() { return std::min&lt;Float&gt;(rng.<a href="../Utilities/Mathematical_Infrastructure.html#RNG::UniformFloat" class="code">Uniform</a>&lt;Float&gt;(),
                                                  <a href="../Sampling_and_Reconstruction/Sampling_Interface.html#OneMinusEpsilon" class="code">OneMinusEpsilon</a>); };</div></div>
    &lt;&lt;<span class="fragmentname"><a href="#fragment-UpdatemonopdfSumforreflectionattheentrancelayer-0">Update <tt>pdfSum</tt> for reflection at the entrance layer</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2388" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2388"><i></i></a><div id="fragbit-2388" class="collapse show"><div class="fragmentcode">       bool enteredTop = twoSided || wo.z &gt; 0;
       Float pdfSum = 0;
       if (<a href="../Reflection_Models/BSDF_Representation.html#SameHemisphere" class="code">SameHemisphere</a>(wo, wi)) {
           auto reflFlag = <a href="../Reflection_Models/BSDF_Representation.html#BxDFReflTransFlags::Reflection" class="code">BxDFReflTransFlags</a>::Reflection;
           pdfSum += enteredTop ?
                     <a href="#LayeredBxDF::nSamples" class="code">nSamples</a> * <a href="#LayeredBxDF::top" class="code">top</a>.<a href="../Reflection_Models/BSDF_Representation.html#BxDF::PDF" class="code">PDF</a>(wo, wi, mode, reflFlag) :
                     <a href="#LayeredBxDF::nSamples" class="code">nSamples</a> * <a href="#LayeredBxDF::bottom" class="code">bottom</a>.<a href="../Reflection_Models/BSDF_Representation.html#BxDF::PDF" class="code">PDF</a>(wo, wi, mode, reflFlag);
       }</div></div>
    for (int s = 0; s &lt; nSamples; ++s) {
        &lt;&lt;<span class="fragmentname"><a href="#fragment-EvaluatelayeredBSDFPDFsample-0">Evaluate layered BSDF PDF sample</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2389" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2389"><i></i></a><div id="fragbit-2389" class="collapse show"><div class="fragmentcode">           if (<a href="../Reflection_Models/BSDF_Representation.html#SameHemisphere" class="code">SameHemisphere</a>(wo, wi)) {
               &lt;&lt;<span class="fragmentname"><a href="#fragment-EvaluateTRTtermforPDFestimate-0">Evaluate TRT term for PDF estimate</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2390" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2390"><i></i></a><div id="fragbit-2390" class="collapse show"><div class="fragmentcode">                  TopOrBottomBxDF&lt;TopBxDF, BottomBxDF&gt; rInterface, tInterface;
                  if (enteredTop) {
                      rInterface = &amp;bottom;  tInterface = &amp;top;
                  } else {
                      rInterface = &amp;top;     tInterface = &amp;bottom;
                  }
                  &lt;&lt;<span class="fragmentname"><a href="#fragment-SamplemonotInterfacetogetdirectionintothelayers-0">Sample <tt>tInterface</tt> to get direction into the layers</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2391" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2391"><i></i></a><div id="fragbit-2391" class="collapse show"><div class="fragmentcode">                     auto trans = BxDFReflTransFlags::Transmission;
                     pstd::optional&lt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample" class="code">BSDFSample</a>&gt; wos, wis;
                     wos = tInterface.Sample_f(wo, r(), {r(), r()},  mode, trans);
                     wis = tInterface.Sample_f(wi, r(), {r(), r()}, !mode, trans);</div></div>
                  &lt;&lt;<span class="fragmentname"><a href="#fragment-UpdatemonopdfSumaccountingforTRTscatteringevents-0">Update <tt>pdfSum</tt> accounting for TRT scattering events</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2392" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2392"><i></i></a><div id="fragbit-2392" class="collapse show"><div class="fragmentcode">                     if (wos &amp;&amp; wos-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::f" class="code">f</a> &amp;&amp; wos-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::pdf" class="code">pdf</a> &gt; 0 &amp;&amp; wis &amp;&amp; wis-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::f" class="code">f</a> &amp;&amp; wis-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::pdf" class="code">pdf</a> &gt; 0) {
                         if (!<a href="../Reflection_Models/BSDF_Representation.html#BxDFFlags::IsNonSpecular" class="code">IsNonSpecular</a>(tInterface.<a href="../Reflection_Models/BSDF_Representation.html#BxDF::Flags" class="code">Flags</a>()))
                             pdfSum += rInterface.<a href="../Reflection_Models/BSDF_Representation.html#BxDF::PDF" class="code">PDF</a>(-wos-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>, -wis-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>, mode);
                         else {
                             &lt;&lt;<span class="fragmentname"><a href="#fragment-UsemultipleimportancesamplingtoestimatePDFproduct-0">Use multiple importance sampling to estimate PDF product</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2393" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2393"><i></i></a><div id="fragbit-2393" class="collapse show"><div class="fragmentcode">                                pstd::optional&lt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample" class="code">BSDFSample</a>&gt; rs =
                                    rInterface.<a href="../Reflection_Models/BSDF_Representation.html#BSDF::Sample_f" class="code">Sample_f</a>(-wos-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>, r(), {r(), r()}, mode);
                                if (rs &amp;&amp; rs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::f" class="code">f</a> &amp;&amp; rs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::pdf" class="code">pdf</a> &gt; 0) {
                                    if (!<a href="../Reflection_Models/BSDF_Representation.html#BxDFFlags::IsNonSpecular" class="code">IsNonSpecular</a>(rInterface.<a href="../Reflection_Models/BSDF_Representation.html#BxDF::Flags" class="code">Flags</a>()))
                                        pdfSum += tInterface.<a href="../Reflection_Models/BSDF_Representation.html#BxDF::PDF" class="code">PDF</a>(-rs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>, <a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>, mode);
                                    else {
                                        &lt;&lt;<span class="fragmentname"><a href="#fragment-ComputeMIS-weightedestimateofEquationrefeq:pdf-triple-canceled-one-0">Compute MIS-weighted estimate of Equation (<a href="#eq:pdf-triple-canceled-one">14.38</a>)</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2394" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2394"><i></i></a><div id="fragbit-2394" class="collapse show"><div class="fragmentcode">                                           Float rPDF = rInterface.<a href="../Reflection_Models/BSDF_Representation.html#BxDF::PDF" class="code">PDF</a>(-wos-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>, -wis-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>, mode);
                                           Float wt = <a href="../Monte_Carlo_Integration/Improving_Efficiency.html#PowerHeuristic" class="code">PowerHeuristic</a>(1, wis-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::pdf" class="code">pdf</a>, 1, rPDF);
                                           pdfSum += wt * rPDF;
                                           Float tPDF = tInterface.<a href="../Reflection_Models/BSDF_Representation.html#BxDF::PDF" class="code">PDF</a>(-rs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>, <a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>, mode);
                                           wt = <a href="../Monte_Carlo_Integration/Improving_Efficiency.html#PowerHeuristic" class="code">PowerHeuristic</a>(1, rs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::pdf" class="code">pdf</a>, 1, tPDF);
                                           pdfSum += wt * tPDF;</div></div>
                                    }
                                }</div></div>
                         }
                     }</div></div></div></div>
           } else {
               &lt;&lt;<span class="fragmentname">Evaluate TT term for PDF estimate</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2395" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2395"><i></i></a><div id="fragbit-2395" class="collapse show"><div class="fragmentcode">                  TopOrBottomBxDF&lt;TopBxDF, BottomBxDF&gt; toInterface, tiInterface;
                  if (enteredTop) {
                      toInterface = &amp;top;
                      tiInterface = &amp;bottom;
                  } else {
                      toInterface = &amp;bottom;
                      tiInterface = &amp;top;
                  }
                  
                  Float uc = r();
                  <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a> u(r(), r());
                  pstd::optional&lt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample" class="code">BSDFSample</a>&gt; wos = toInterface.Sample_f(wo, uc, u, mode);
                  if (!wos || !wos-&gt;f || wos-&gt;pdf == 0 || wos-&gt;wi.z == 0 || wos-&gt;IsReflection())
                      continue;
                  
                  uc = r();
                  u = <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(r(), r());
                  pstd::optional&lt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample" class="code">BSDFSample</a>&gt; wis = tiInterface.Sample_f(wi, uc, u, !mode);
                  if (!wis || !wis-&gt;f || wis-&gt;pdf == 0 || wis-&gt;wi.z == 0 || wis-&gt;IsReflection())
                      continue;
                  
                  if (IsSpecular(toInterface.Flags()))
                      pdfSum += tiInterface.PDF(-wos-&gt;wi, wi, mode);
                  else if (IsSpecular(tiInterface.Flags()))
                      pdfSum += toInterface.PDF(wo, -wis-&gt;wi, mode);
                  else
                      pdfSum += (toInterface.PDF(wo, -wis-&gt;wi, mode) +
                                 tiInterface.PDF(-wos-&gt;wi, wi, mode)) /
                                2;</div></div>
           }</div></div>
    }
    &lt;&lt;<span class="fragmentname"><a href="#fragment-ReturnmixtureofPDFestimateandconstantPDF-0">Return mixture of PDF estimate and constant PDF</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2396" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2396"><i></i></a><div id="fragbit-2396" class="collapse show"><div class="fragmentcode">       return <a href="../Monte_Carlo_Integration/Sampling_Using_the_Inversion_Method.html#Lerp" class="code">Lerp</a>(0.9f, 1 / (4 * <a href="../Utilities/Mathematical_Infrastructure.html#Pi" class="code">Pi</a>), pdfSum / <a href="#LayeredBxDF::nSamples" class="code">nSamples</a>);</div></div>
}</div><p>


</p>
<p>It is important that the <a href="../Utilities/Mathematical_Infrastructure.html#RNG"><tt>RNG</tt></a> for the <tt>PDF()</tt> method is seeded
differently than it is for the <tt>f()</tt> method, since it will often be
called with the same pair of directions as are passed to <tt>f()</tt>, and we
would like to be certain that there is no correlation between the results
returned by the two of them.

</p>
<p></p>
<span class="anchor" id="fragment-DeclaremonoRNGforlayeredPDFevaluation-0"></span><div class="fragmentname">&lt;&lt;Declare <tt>RNG</tt> for layered PDF evaluation&gt;&gt;=&nbsp;</div>
<div class="fragmentcode"><a href="../Utilities/Mathematical_Infrastructure.html#RNG" class="code">RNG</a> rng(<a href="../Utilities/Mathematical_Infrastructure.html#Hash" class="code">Hash</a>(<a href="../Utilities/System_Startup,_Cleanup,_and_Options.html#GetOptions" class="code">GetOptions</a>().<a href="../Utilities/System_Startup,_Cleanup,_and_Options.html#BasicPBRTOptions::seed" class="code">seed</a>, wi), <a href="../Utilities/Mathematical_Infrastructure.html#Hash" class="code">Hash</a>(wo));
auto r = [&amp;rng]() { return std::min&lt;Float&gt;(rng.<a href="../Utilities/Mathematical_Infrastructure.html#RNG::UniformFloat" class="code">Uniform</a>&lt;Float&gt;(),
                                           <a href="../Sampling_and_Reconstruction/Sampling_Interface.html#OneMinusEpsilon" class="code">OneMinusEpsilon</a>); };</div><p>


</p>
<p>If both directions are on the same side of the surface, then part of the
full PDF is given by the PDF for reflection at the interface (this was the
first term of Equation&nbsp;(<a href="#eq:pdf-estimate-sum">14.36</a>)).  This component can be
evaluated non-stochastically, assuming that the underlying <tt>PDF()</tt>
methods are not themselves stochastic.

</p>
<p></p>
<span class="anchor" id="fragment-UpdatemonopdfSumforreflectionattheentrancelayer-0"></span><div class="fragmentname">&lt;&lt;Update <tt>pdfSum</tt> for reflection at the entrance layer&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">bool enteredTop = twoSided || wo.z &gt; 0;
Float pdfSum = 0;
if (<a href="../Reflection_Models/BSDF_Representation.html#SameHemisphere" class="code">SameHemisphere</a>(wo, wi)) {
    auto reflFlag = <a href="../Reflection_Models/BSDF_Representation.html#BxDFReflTransFlags::Reflection" class="code">BxDFReflTransFlags</a>::Reflection;
    pdfSum += enteredTop ?
              <a href="#LayeredBxDF::nSamples" class="code">nSamples</a> * <a href="#LayeredBxDF::top" class="code">top</a>.<a href="../Reflection_Models/BSDF_Representation.html#BxDF::PDF" class="code">PDF</a>(wo, wi, mode, reflFlag) :
              <a href="#LayeredBxDF::nSamples" class="code">nSamples</a> * <a href="#LayeredBxDF::bottom" class="code">bottom</a>.<a href="../Reflection_Models/BSDF_Representation.html#BxDF::PDF" class="code">PDF</a>(wo, wi, mode, reflFlag);
}</div><p>


</p>
<p>The more times light has been scattered, the more isotropic its directional
distribution tends to become.  We can take advantage of this fact by
evaluating only the first term of the stochastic PDF estimate and modeling
the remaining terms with a uniform distribution.  We further neglect the
effect of scattering in the medium, again under the assumption that if it
is significant, a uniform distribution will be a suitable approximation.

</p>
<p></p>
<span class="anchor" id="fragment-EvaluatelayeredBSDFPDFsample-0"></span><div class="fragmentname">&lt;&lt;Evaluate layered BSDF PDF sample&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">if (<a href="../Reflection_Models/BSDF_Representation.html#SameHemisphere" class="code">SameHemisphere</a>(wo, wi)) {
    &lt;&lt;<span class="fragmentname"><a href="#fragment-EvaluateTRTtermforPDFestimate-0">Evaluate TRT term for PDF estimate</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2397" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2397"><i></i></a><div id="fragbit-2397" class="collapse show"><div class="fragmentcode">       TopOrBottomBxDF&lt;TopBxDF, BottomBxDF&gt; rInterface, tInterface;
       if (enteredTop) {
           rInterface = &amp;bottom;  tInterface = &amp;top;
       } else {
           rInterface = &amp;top;     tInterface = &amp;bottom;
       }
       &lt;&lt;<span class="fragmentname"><a href="#fragment-SamplemonotInterfacetogetdirectionintothelayers-0">Sample <tt>tInterface</tt> to get direction into the layers</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2398" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2398"><i></i></a><div id="fragbit-2398" class="collapse show"><div class="fragmentcode">          auto trans = BxDFReflTransFlags::Transmission;
          pstd::optional&lt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample" class="code">BSDFSample</a>&gt; wos, wis;
          wos = tInterface.Sample_f(wo, r(), {r(), r()},  mode, trans);
          wis = tInterface.Sample_f(wi, r(), {r(), r()}, !mode, trans);</div></div>
       &lt;&lt;<span class="fragmentname"><a href="#fragment-UpdatemonopdfSumaccountingforTRTscatteringevents-0">Update <tt>pdfSum</tt> accounting for TRT scattering events</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2399" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2399"><i></i></a><div id="fragbit-2399" class="collapse show"><div class="fragmentcode">          if (wos &amp;&amp; wos-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::f" class="code">f</a> &amp;&amp; wos-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::pdf" class="code">pdf</a> &gt; 0 &amp;&amp; wis &amp;&amp; wis-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::f" class="code">f</a> &amp;&amp; wis-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::pdf" class="code">pdf</a> &gt; 0) {
              if (!<a href="../Reflection_Models/BSDF_Representation.html#BxDFFlags::IsNonSpecular" class="code">IsNonSpecular</a>(tInterface.<a href="../Reflection_Models/BSDF_Representation.html#BxDF::Flags" class="code">Flags</a>()))
                  pdfSum += rInterface.<a href="../Reflection_Models/BSDF_Representation.html#BxDF::PDF" class="code">PDF</a>(-wos-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>, -wis-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>, mode);
              else {
                  &lt;&lt;<span class="fragmentname"><a href="#fragment-UsemultipleimportancesamplingtoestimatePDFproduct-0">Use multiple importance sampling to estimate PDF product</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2400" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2400"><i></i></a><div id="fragbit-2400" class="collapse show"><div class="fragmentcode">                     pstd::optional&lt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample" class="code">BSDFSample</a>&gt; rs =
                         rInterface.<a href="../Reflection_Models/BSDF_Representation.html#BSDF::Sample_f" class="code">Sample_f</a>(-wos-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>, r(), {r(), r()}, mode);
                     if (rs &amp;&amp; rs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::f" class="code">f</a> &amp;&amp; rs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::pdf" class="code">pdf</a> &gt; 0) {
                         if (!<a href="../Reflection_Models/BSDF_Representation.html#BxDFFlags::IsNonSpecular" class="code">IsNonSpecular</a>(rInterface.<a href="../Reflection_Models/BSDF_Representation.html#BxDF::Flags" class="code">Flags</a>()))
                             pdfSum += tInterface.<a href="../Reflection_Models/BSDF_Representation.html#BxDF::PDF" class="code">PDF</a>(-rs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>, <a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>, mode);
                         else {
                             &lt;&lt;<span class="fragmentname"><a href="#fragment-ComputeMIS-weightedestimateofEquationrefeq:pdf-triple-canceled-one-0">Compute MIS-weighted estimate of Equation (<a href="#eq:pdf-triple-canceled-one">14.38</a>)</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2401" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2401"><i></i></a><div id="fragbit-2401" class="collapse show"><div class="fragmentcode">                                Float rPDF = rInterface.<a href="../Reflection_Models/BSDF_Representation.html#BxDF::PDF" class="code">PDF</a>(-wos-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>, -wis-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>, mode);
                                Float wt = <a href="../Monte_Carlo_Integration/Improving_Efficiency.html#PowerHeuristic" class="code">PowerHeuristic</a>(1, wis-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::pdf" class="code">pdf</a>, 1, rPDF);
                                pdfSum += wt * rPDF;
                                Float tPDF = tInterface.<a href="../Reflection_Models/BSDF_Representation.html#BxDF::PDF" class="code">PDF</a>(-rs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>, <a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>, mode);
                                wt = <a href="../Monte_Carlo_Integration/Improving_Efficiency.html#PowerHeuristic" class="code">PowerHeuristic</a>(1, rs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::pdf" class="code">pdf</a>, 1, tPDF);
                                pdfSum += wt * tPDF;</div></div>
                         }
                     }</div></div>
              }
          }</div></div></div></div>
} else {
    &lt;&lt;<span class="fragmentname">Evaluate TT term for PDF estimate</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2402" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2402"><i></i></a><div id="fragbit-2402" class="collapse show"><div class="fragmentcode">       TopOrBottomBxDF&lt;TopBxDF, BottomBxDF&gt; toInterface, tiInterface;
       if (enteredTop) {
           toInterface = &amp;top;
           tiInterface = &amp;bottom;
       } else {
           toInterface = &amp;bottom;
           tiInterface = &amp;top;
       }
       
       Float uc = r();
       <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a> u(r(), r());
       pstd::optional&lt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample" class="code">BSDFSample</a>&gt; wos = toInterface.Sample_f(wo, uc, u, mode);
       if (!wos || !wos-&gt;f || wos-&gt;pdf == 0 || wos-&gt;wi.z == 0 || wos-&gt;IsReflection())
           continue;
       
       uc = r();
       u = <a href="../Geometry_and_Transformations/Points.html#Point2f" class="code">Point2f</a>(r(), r());
       pstd::optional&lt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample" class="code">BSDFSample</a>&gt; wis = tiInterface.Sample_f(wi, uc, u, !mode);
       if (!wis || !wis-&gt;f || wis-&gt;pdf == 0 || wis-&gt;wi.z == 0 || wis-&gt;IsReflection())
           continue;
       
       if (IsSpecular(toInterface.Flags()))
           pdfSum += tiInterface.PDF(-wos-&gt;wi, wi, mode);
       else if (IsSpecular(tiInterface.Flags()))
           pdfSum += toInterface.PDF(wo, -wis-&gt;wi, mode);
       else
           pdfSum += (toInterface.PDF(wo, -wis-&gt;wi, mode) +
                      tiInterface.PDF(-wos-&gt;wi, wi, mode)) /
                     2;</div></div>
}</div><p>


</p>
<p>If both directions are on the same side of the interface, then the
remaining PDF integral is the double integral of the product of three PDFs
that we considered earlier.  We use the shorthand &ldquo;TRT&rdquo; for this case,
corresponding to transmission, then reflection, then transmission.

</p>
<p></p>
<span class="anchor" id="fragment-EvaluateTRTtermforPDFestimate-0"></span><div class="fragmentname">&lt;&lt;Evaluate TRT term for PDF estimate&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">TopOrBottomBxDF&lt;TopBxDF, BottomBxDF&gt; rInterface, tInterface;
if (enteredTop) {
    rInterface = &amp;bottom;  tInterface = &amp;top;
} else {
    rInterface = &amp;top;     tInterface = &amp;bottom;
}
&lt;&lt;<span class="fragmentname"><a href="#fragment-SamplemonotInterfacetogetdirectionintothelayers-0">Sample <tt>tInterface</tt> to get direction into the layers</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2403" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2403"><i></i></a><div id="fragbit-2403" class="collapse show"><div class="fragmentcode">   auto trans = BxDFReflTransFlags::Transmission;
   pstd::optional&lt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample" class="code">BSDFSample</a>&gt; wos, wis;
   wos = tInterface.Sample_f(wo, r(), {r(), r()},  mode, trans);
   wis = tInterface.Sample_f(wi, r(), {r(), r()}, !mode, trans);</div></div>
&lt;&lt;<span class="fragmentname"><a href="#fragment-UpdatemonopdfSumaccountingforTRTscatteringevents-0">Update <tt>pdfSum</tt> accounting for TRT scattering events</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2404" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2404"><i></i></a><div id="fragbit-2404" class="collapse show"><div class="fragmentcode">   if (wos &amp;&amp; wos-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::f" class="code">f</a> &amp;&amp; wos-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::pdf" class="code">pdf</a> &gt; 0 &amp;&amp; wis &amp;&amp; wis-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::f" class="code">f</a> &amp;&amp; wis-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::pdf" class="code">pdf</a> &gt; 0) {
       if (!<a href="../Reflection_Models/BSDF_Representation.html#BxDFFlags::IsNonSpecular" class="code">IsNonSpecular</a>(tInterface.<a href="../Reflection_Models/BSDF_Representation.html#BxDF::Flags" class="code">Flags</a>()))
           pdfSum += rInterface.<a href="../Reflection_Models/BSDF_Representation.html#BxDF::PDF" class="code">PDF</a>(-wos-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>, -wis-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>, mode);
       else {
           &lt;&lt;<span class="fragmentname"><a href="#fragment-UsemultipleimportancesamplingtoestimatePDFproduct-0">Use multiple importance sampling to estimate PDF product</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2405" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2405"><i></i></a><div id="fragbit-2405" class="collapse show"><div class="fragmentcode">              pstd::optional&lt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample" class="code">BSDFSample</a>&gt; rs =
                  rInterface.<a href="../Reflection_Models/BSDF_Representation.html#BSDF::Sample_f" class="code">Sample_f</a>(-wos-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>, r(), {r(), r()}, mode);
              if (rs &amp;&amp; rs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::f" class="code">f</a> &amp;&amp; rs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::pdf" class="code">pdf</a> &gt; 0) {
                  if (!<a href="../Reflection_Models/BSDF_Representation.html#BxDFFlags::IsNonSpecular" class="code">IsNonSpecular</a>(rInterface.<a href="../Reflection_Models/BSDF_Representation.html#BxDF::Flags" class="code">Flags</a>()))
                      pdfSum += tInterface.<a href="../Reflection_Models/BSDF_Representation.html#BxDF::PDF" class="code">PDF</a>(-rs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>, <a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>, mode);
                  else {
                      &lt;&lt;<span class="fragmentname"><a href="#fragment-ComputeMIS-weightedestimateofEquationrefeq:pdf-triple-canceled-one-0">Compute MIS-weighted estimate of Equation (<a href="#eq:pdf-triple-canceled-one">14.38</a>)</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2406" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2406"><i></i></a><div id="fragbit-2406" class="collapse show"><div class="fragmentcode">                         Float rPDF = rInterface.<a href="../Reflection_Models/BSDF_Representation.html#BxDF::PDF" class="code">PDF</a>(-wos-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>, -wis-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>, mode);
                         Float wt = <a href="../Monte_Carlo_Integration/Improving_Efficiency.html#PowerHeuristic" class="code">PowerHeuristic</a>(1, wis-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::pdf" class="code">pdf</a>, 1, rPDF);
                         pdfSum += wt * rPDF;
                         Float tPDF = tInterface.<a href="../Reflection_Models/BSDF_Representation.html#BxDF::PDF" class="code">PDF</a>(-rs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>, <a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>, mode);
                         wt = <a href="../Monte_Carlo_Integration/Improving_Efficiency.html#PowerHeuristic" class="code">PowerHeuristic</a>(1, rs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::pdf" class="code">pdf</a>, 1, tPDF);
                         pdfSum += wt * tPDF;</div></div>
                  }
              }</div></div>
       }
   }</div></div></div><p>


</p>
<p>We will apply two sampling strategies.  The first is sampling both
directions via <tt>tInterface</tt>, once conditioned on <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.5ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 1076.4 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">omega Subscript normal o</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6F" d="M471 214c0 -127 -101 -225 -222 -225c-117 0 -221 96 -221 225c0 125 97 234 222 234c121 0 221 -106 221 -234zM388 222c0 38 0 96 -26 139s-69 65 -113 65c-40 0 -87 -21 -114 -67c-24 -44 -24 -98 -24 -137c0 -36 0 -97 25 -141c27 -46 71 -67 114 -67 c50 0 94 29 116 74c22 44 22 98 22 134Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6F" x="880" y="-213"></use>
</g>
</svg> and once on
<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.135ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 919.4 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">omega Subscript normal i</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-69" d="M247 0c-34 1 -69 3 -104 3l-110 -3v31c67 0 78 0 78 45v269c0 49 -9 55 -74 55v31l140 11v-367c0 -39 4 -44 70 -44v-31zM192 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-69" x="880" y="-213"></use>
</g>
</svg>&mdash;effectively a bidirectional approach. The second is sampling one
direction via <tt>tInterface</tt> conditioned on <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.5ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 1076.4 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">omega Subscript normal o</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-6F" d="M471 214c0 -127 -101 -225 -222 -225c-117 0 -221 96 -221 225c0 125 97 234 222 234c121 0 221 -106 221 -234zM388 222c0 38 0 96 -26 139s-69 65 -113 65c-40 0 -87 -21 -114 -67c-24 -44 -24 -98 -24 -137c0 -36 0 -97 25 -141c27 -46 71 -67 114 -67 c50 0 94 29 116 74c22 44 22 98 22 134Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-6F" x="880" y="-213"></use>
</g>
</svg> and the other via
<tt>rInterface</tt> conditioned on the first sampled direction.  These are
then combined using multiple importance sampling.  After canceling
factors and introducing an MIS weight <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="6.215ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 2675.9 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">w left-parenthesis omega double-prime Subscript Baseline right-parenthesis</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E2-LATINMODERNNORMAL-1D464" d="M691 372c0 -48 -32 -182 -66 -260c-26 -60 -70 -123 -145 -123c-30 0 -99 6 -125 70c-40 -70 -87 -70 -104 -70c-75 0 -142 35 -142 126c0 38 12 84 56 202c7 17 18 45 18 70c0 32 -16 33 -25 33c-35 0 -74 -31 -101 -124c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10 c0 9 37 154 132 154c49 0 82 -37 82 -82c0 -20 -6 -34 -17 -64c-47 -123 -52 -162 -52 -194c0 -17 0 -91 80 -91c39 0 69 31 92 84c-1 5 -1 7 -1 18c0 18 2 36 9 66c7 26 54 217 57 224c7 20 25 28 37 28c15 0 29 -9 29 -27c0 -6 -10 -43 -15 -65l-42 -168 c-4 -14 -11 -45 -11 -73c0 -57 27 -87 74 -87c49 0 84 35 110 88c26 51 55 149 55 183c0 48 -25 74 -36 85c-9 8 -15 14 -15 27c0 22 25 48 50 48c17 0 44 -15 44 -70Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E2-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
<path stroke-width="1" id="E2-LATINMODERNVARIANTS-2033" d="M340 496c0 -10 -3 -20 -8 -28l-227 -372h-38l171 424c6 15 26 29 48 29c30 0 54 -24 54 -53zM580 496c0 -10 -3 -20 -8 -28l-227 -372h-38l171 424c6 15 26 29 48 29c30 0 54 -24 54 -53Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E2-LATINMODERNNORMAL-1D464" x="0" y="0"></use>
 <use xlink:href="#E2-LATINMODERNMAIN-28" x="716" y="0"></use>
<g transform="translate(1106,0)">
 <use xlink:href="#E2-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E2-LATINMODERNVARIANTS-2033" x="880" y="513"></use>
</g>
 <use xlink:href="#E2-LATINMODERNMAIN-29" x="2286" y="0"></use>
</g>
</svg>,
Equation&nbsp;(<a href="#eq:pdf-triple-estimate">14.37</a>) simplifies&nbsp;to
</p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">
<span class="anchor" id="eq:pdf-triple-canceled-one"></span><div class="displaymath"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="32.714ex" height="6.676ex" style="vertical-align: -2.671ex;" viewBox="0 -1724.2 14085.1 2874.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">w left-parenthesis omega double-prime Subscript Baseline right-parenthesis StartFraction p Subscript normal r Superscript minus Baseline left-parenthesis minus omega prime Subscript Baseline comma omega double-prime Subscript Baseline right-parenthesis p Subscript normal t Superscript plus Baseline left-parenthesis minus omega double-prime Subscript Baseline comma omega Subscript normal i Baseline right-parenthesis Over p left-parenthesis omega double-prime Subscript Baseline right-parenthesis EndFraction comma</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E2-LATINMODERNNORMAL-1D464" d="M691 372c0 -48 -32 -182 -66 -260c-26 -60 -70 -123 -145 -123c-30 0 -99 6 -125 70c-40 -70 -87 -70 -104 -70c-75 0 -142 35 -142 126c0 38 12 84 56 202c7 17 18 45 18 70c0 32 -16 33 -25 33c-35 0 -74 -31 -101 -124c-5 -16 -6 -18 -16 -18c0 0 -12 0 -12 10 c0 9 37 154 132 154c49 0 82 -37 82 -82c0 -20 -6 -34 -17 -64c-47 -123 -52 -162 -52 -194c0 -17 0 -91 80 -91c39 0 69 31 92 84c-1 5 -1 7 -1 18c0 18 2 36 9 66c7 26 54 217 57 224c7 20 25 28 37 28c15 0 29 -9 29 -27c0 -6 -10 -43 -15 -65l-42 -168 c-4 -14 -11 -45 -11 -73c0 -57 27 -87 74 -87c49 0 84 35 110 88c26 51 55 149 55 183c0 48 -25 74 -36 85c-9 8 -15 14 -15 27c0 22 25 48 50 48c17 0 44 -15 44 -70Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E2-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
<path stroke-width="1" id="E2-LATINMODERNVARIANTS-2033" d="M340 496c0 -10 -3 -20 -8 -28l-227 -372h-38l171 424c6 15 26 29 48 29c30 0 54 -24 54 -53zM580 496c0 -10 -3 -20 -8 -28l-227 -372h-38l171 424c6 15 26 29 48 29c30 0 54 -24 54 -53Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
<path stroke-width="1" id="E2-LATINMODERNNORMAL-1D45D" d="M490 282c0 -147 -125 -293 -241 -293c-51 0 -79 35 -92 64c-7 -25 -49 -188 -49 -200c0 -9 0 -16 50 -16c14 0 24 0 24 -11c0 -20 -13 -20 -18 -20c-32 0 -66 3 -99 3c-28 0 -57 -3 -84 -3c-8 0 -13 4 -13 12c0 19 11 19 23 19c44 0 46 7 54 41l112 445c4 17 7 28 7 51 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c37 0 80 -21 90 -75c33 39 81 75 131 75c76 0 133 -66 133 -160zM418 326c0 59 -24 94 -64 94c-17 0 -46 -7 -81 -38c-18 -15 -45 -43 -52 -70 l-49 -196c-3 -12 -3 -16 -3 -16c0 -6 13 -89 79 -89c37 0 85 33 119 103c18 38 51 153 51 212Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-2212" d="M722 250c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-72" d="M364 381c0 -32 -25 -44 -43 -44c-22 0 -43 15 -43 43c0 26 20 38 23 39c-2 1 -4 1 -11 1c-76 0 -118 -89 -118 -188v-154c0 -36 2 -47 76 -47h21v-31c-40 3 -87 3 -127 3l-114 -3v31c67 0 78 0 78 45v268c0 49 -8 56 -78 56v31l139 11v-110c14 43 50 110 123 110 c43 0 74 -29 74 -61Z"></path>
<path stroke-width="1" id="E2-LATINMODERNVARIANTS-2032" d="M340 496c0 -10 -3 -20 -8 -28l-227 -372h-38l171 424c6 15 26 29 48 29c30 0 54 -24 54 -53Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-2B" d="M722 250c0 -11 -9 -20 -20 -20h-293v-293c0 -11 -9 -20 -20 -20s-20 9 -20 20v293h-293c-11 0 -20 9 -20 20s9 20 20 20h293v293c0 11 9 20 20 20s20 -9 20 -20v-293h293c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-74" d="M332 124c0 -64 -28 -135 -99 -135c-36 0 -129 12 -129 135v276h-85v22c98 4 128 111 129 193h25v-184h143v-31h-143v-278c0 -17 0 -108 67 -108c37 0 67 38 67 112v55h25v-57Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-69" d="M247 0c-34 1 -69 3 -104 3l-110 -3v31c67 0 78 0 78 45v269c0 49 -9 55 -74 55v31l140 11v-367c0 -39 4 -44 70 -44v-31zM192 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E2-LATINMODERNNORMAL-1D464" x="0" y="0"></use>
 <use xlink:href="#E2-LATINMODERNMAIN-28" x="716" y="0"></use>
<g transform="translate(1106,0)">
 <use xlink:href="#E2-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E2-LATINMODERNVARIANTS-2033" x="880" y="583"></use>
</g>
 <use xlink:href="#E2-LATINMODERNMAIN-29" x="2286" y="0"></use>
<g transform="translate(2675,0)">
<g transform="translate(120,0)">
<rect stroke="none" width="10890" height="60" x="0" y="220"></rect>
<g transform="translate(60,799)">
 <use xlink:href="#E2-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E2-LATINMODERNMAIN-2212" x="712" y="571"></use>
 <use transform="scale(0.707)" xlink:href="#E2-LATINMODERNMAIN-72" x="712" y="-211"></use>
 <use xlink:href="#E2-LATINMODERNMAIN-28" x="1153" y="0"></use>
 <use xlink:href="#E2-LATINMODERNMAIN-2212" x="1543" y="0"></use>
<g transform="translate(2321,0)">
 <use xlink:href="#E2-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E2-LATINMODERNVARIANTS-2032" x="880" y="513"></use>
</g>
 <use xlink:href="#E2-LATINMODERNMAIN-2C" x="3332" y="0"></use>
<g transform="translate(3777,0)">
 <use xlink:href="#E2-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E2-LATINMODERNVARIANTS-2033" x="880" y="513"></use>
</g>
 <use xlink:href="#E2-LATINMODERNMAIN-29" x="4958" y="0"></use>
<g transform="translate(5514,0)">
 <use xlink:href="#E2-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E2-LATINMODERNMAIN-2B" x="712" y="571"></use>
 <use transform="scale(0.707)" xlink:href="#E2-LATINMODERNMAIN-74" x="712" y="-384"></use>
</g>
 <use xlink:href="#E2-LATINMODERNMAIN-28" x="6668" y="0"></use>
 <use xlink:href="#E2-LATINMODERNMAIN-2212" x="7057" y="0"></use>
<g transform="translate(7836,0)">
 <use xlink:href="#E2-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E2-LATINMODERNVARIANTS-2033" x="880" y="513"></use>
</g>
 <use xlink:href="#E2-LATINMODERNMAIN-2C" x="9016" y="0"></use>
<g transform="translate(9461,0)">
 <use xlink:href="#E2-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E2-LATINMODERNMAIN-69" x="880" y="-213"></use>
</g>
 <use xlink:href="#E2-LATINMODERNMAIN-29" x="10381" y="0"></use>
</g>
<g transform="translate(4213,-769)">
 <use xlink:href="#E2-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use xlink:href="#E2-LATINMODERNMAIN-28" x="503" y="0"></use>
<g transform="translate(893,0)">
 <use xlink:href="#E2-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E2-LATINMODERNVARIANTS-2033" x="880" y="408"></use>
</g>
 <use xlink:href="#E2-LATINMODERNMAIN-29" x="2073" y="0"></use>
</g>
</g>
</g>
 <use xlink:href="#E2-LATINMODERNMAIN-2C" x="13806" y="0"></use>
</g>
</svg>
</div>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">
<div class="eqno">(<a href="#eq:pdf-triple-canceled-one">14.38</a>)</div>
</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">
<p>

which is the estimator for both strategies.

</p>
<p>Both sampling methods will use the <tt>wos</tt> sample while only one uses
<tt>wis</tt>.

</p>
<p></p>
<span class="anchor" id="fragment-SamplemonotInterfacetogetdirectionintothelayers-0"></span><div class="fragmentname">&lt;&lt;Sample <tt>tInterface</tt> to get direction into the layers&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">auto trans = BxDFReflTransFlags::Transmission;
pstd::optional&lt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample" class="code">BSDFSample</a>&gt; wos, wis;
wos = tInterface.Sample_f(wo, r(), {r(), r()},  mode, trans);
wis = tInterface.Sample_f(wi, r(), {r(), r()}, !mode, trans);</div><p>


</p>
<p>If <tt>tInterface</tt> is perfect specular, then there is no need to
try sampling <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.753ex" height="2.843ex" style="vertical-align: -0.671ex; margin-left: -0.073ex;" viewBox="-31.5 -934.9 1185.5 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">p Subscript normal r Superscript minus</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45D" d="M490 282c0 -147 -125 -293 -241 -293c-51 0 -79 35 -92 64c-7 -25 -49 -188 -49 -200c0 -9 0 -16 50 -16c14 0 24 0 24 -11c0 -20 -13 -20 -18 -20c-32 0 -66 3 -99 3c-28 0 -57 -3 -84 -3c-8 0 -13 4 -13 12c0 19 11 19 23 19c44 0 46 7 54 41l112 445c4 17 7 28 7 51 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c37 0 80 -21 90 -75c33 39 81 75 131 75c76 0 133 -66 133 -160zM418 326c0 59 -24 94 -64 94c-17 0 -46 -7 -81 -38c-18 -15 -45 -43 -52 -70 l-49 -196c-3 -12 -3 -16 -3 -16c0 -6 13 -89 79 -89c37 0 85 33 119 103c18 38 51 153 51 212Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2212" d="M722 250c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-72" d="M364 381c0 -32 -25 -44 -43 -44c-22 0 -43 15 -43 43c0 26 20 38 23 39c-2 1 -4 1 -11 1c-76 0 -118 -89 -118 -188v-154c0 -36 2 -47 76 -47h21v-31c-40 3 -87 3 -127 3l-114 -3v31c67 0 78 0 78 45v268c0 49 -8 56 -78 56v31l139 11v-110c14 43 50 110 123 110 c43 0 74 -29 74 -61Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="712" y="571"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-72" x="712" y="-211"></use>
</g>
</svg> or to apply MIS.  The <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.753ex" height="2.843ex" style="vertical-align: -0.671ex; margin-left: -0.073ex;" viewBox="-31.5 -934.9 1185.5 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">p Subscript normal r Superscript minus</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45D" d="M490 282c0 -147 -125 -293 -241 -293c-51 0 -79 35 -92 64c-7 -25 -49 -188 -49 -200c0 -9 0 -16 50 -16c14 0 24 0 24 -11c0 -20 -13 -20 -18 -20c-32 0 -66 3 -99 3c-28 0 -57 -3 -84 -3c-8 0 -13 4 -13 12c0 19 11 19 23 19c44 0 46 7 54 41l112 445c4 17 7 28 7 51 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c37 0 80 -21 90 -75c33 39 81 75 131 75c76 0 133 -66 133 -160zM418 326c0 59 -24 94 -64 94c-17 0 -46 -7 -81 -38c-18 -15 -45 -43 -52 -70 l-49 -196c-3 -12 -3 -16 -3 -16c0 -6 13 -89 79 -89c37 0 85 33 119 103c18 38 51 153 51 212Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2212" d="M722 250c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-72" d="M364 381c0 -32 -25 -44 -43 -44c-22 0 -43 15 -43 43c0 26 20 38 23 39c-2 1 -4 1 -11 1c-76 0 -118 -89 -118 -188v-154c0 -36 2 -47 76 -47h21v-31c-40 3 -87 3 -127 3l-114 -3v31c67 0 78 0 78 45v268c0 49 -8 56 -78 56v31l139 11v-110c14 43 50 110 123 110 c43 0 74 -29 74 -61Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="712" y="571"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-72" x="712" y="-211"></use>
</g>
</svg> PDF is all that remains from
Equation&nbsp;(<a href="#eq:pdf-triple-canceled-one">14.38</a>).

</p>
<p></p>
<span class="anchor" id="fragment-UpdatemonopdfSumaccountingforTRTscatteringevents-0"></span><div class="fragmentname">&lt;&lt;Update <tt>pdfSum</tt> accounting for TRT scattering events&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">if (wos &amp;&amp; wos-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::f" class="code">f</a> &amp;&amp; wos-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::pdf" class="code">pdf</a> &gt; 0 &amp;&amp; wis &amp;&amp; wis-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::f" class="code">f</a> &amp;&amp; wis-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::pdf" class="code">pdf</a> &gt; 0) {
    if (!<a href="../Reflection_Models/BSDF_Representation.html#BxDFFlags::IsNonSpecular" class="code">IsNonSpecular</a>(tInterface.<a href="../Reflection_Models/BSDF_Representation.html#BxDF::Flags" class="code">Flags</a>()))
        pdfSum += rInterface.<a href="../Reflection_Models/BSDF_Representation.html#BxDF::PDF" class="code">PDF</a>(-wos-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>, -wis-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>, mode);
    else {
        &lt;&lt;<span class="fragmentname"><a href="#fragment-UsemultipleimportancesamplingtoestimatePDFproduct-0">Use multiple importance sampling to estimate PDF product</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2407" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2407"><i></i></a><div id="fragbit-2407" class="collapse show"><div class="fragmentcode">           pstd::optional&lt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample" class="code">BSDFSample</a>&gt; rs =
               rInterface.<a href="../Reflection_Models/BSDF_Representation.html#BSDF::Sample_f" class="code">Sample_f</a>(-wos-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>, r(), {r(), r()}, mode);
           if (rs &amp;&amp; rs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::f" class="code">f</a> &amp;&amp; rs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::pdf" class="code">pdf</a> &gt; 0) {
               if (!<a href="../Reflection_Models/BSDF_Representation.html#BxDFFlags::IsNonSpecular" class="code">IsNonSpecular</a>(rInterface.<a href="../Reflection_Models/BSDF_Representation.html#BxDF::Flags" class="code">Flags</a>()))
                   pdfSum += tInterface.<a href="../Reflection_Models/BSDF_Representation.html#BxDF::PDF" class="code">PDF</a>(-rs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>, <a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>, mode);
               else {
                   &lt;&lt;<span class="fragmentname"><a href="#fragment-ComputeMIS-weightedestimateofEquationrefeq:pdf-triple-canceled-one-0">Compute MIS-weighted estimate of Equation (<a href="#eq:pdf-triple-canceled-one">14.38</a>)</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2408" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2408"><i></i></a><div id="fragbit-2408" class="collapse show"><div class="fragmentcode">                      Float rPDF = rInterface.<a href="../Reflection_Models/BSDF_Representation.html#BxDF::PDF" class="code">PDF</a>(-wos-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>, -wis-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>, mode);
                      Float wt = <a href="../Monte_Carlo_Integration/Improving_Efficiency.html#PowerHeuristic" class="code">PowerHeuristic</a>(1, wis-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::pdf" class="code">pdf</a>, 1, rPDF);
                      pdfSum += wt * rPDF;
                      Float tPDF = tInterface.<a href="../Reflection_Models/BSDF_Representation.html#BxDF::PDF" class="code">PDF</a>(-rs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>, <a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>, mode);
                      wt = <a href="../Monte_Carlo_Integration/Improving_Efficiency.html#PowerHeuristic" class="code">PowerHeuristic</a>(1, rs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::pdf" class="code">pdf</a>, 1, tPDF);
                      pdfSum += wt * tPDF;</div></div>
               }
           }</div></div>
    }
}</div><p>


</p>
<p>Otherwise, we sample from <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.753ex" height="2.843ex" style="vertical-align: -0.671ex; margin-left: -0.073ex;" viewBox="-31.5 -934.9 1185.5 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">p Subscript normal r Superscript minus</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45D" d="M490 282c0 -147 -125 -293 -241 -293c-51 0 -79 35 -92 64c-7 -25 -49 -188 -49 -200c0 -9 0 -16 50 -16c14 0 24 0 24 -11c0 -20 -13 -20 -18 -20c-32 0 -66 3 -99 3c-28 0 -57 -3 -84 -3c-8 0 -13 4 -13 12c0 19 11 19 23 19c44 0 46 7 54 41l112 445c4 17 7 28 7 51 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c37 0 80 -21 90 -75c33 39 81 75 131 75c76 0 133 -66 133 -160zM418 326c0 59 -24 94 -64 94c-17 0 -46 -7 -81 -38c-18 -15 -45 -43 -52 -70 l-49 -196c-3 -12 -3 -16 -3 -16c0 -6 13 -89 79 -89c37 0 85 33 119 103c18 38 51 153 51 212Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2212" d="M722 250c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-72" d="M364 381c0 -32 -25 -44 -43 -44c-22 0 -43 15 -43 43c0 26 20 38 23 39c-2 1 -4 1 -11 1c-76 0 -118 -89 -118 -188v-154c0 -36 2 -47 76 -47h21v-31c-40 3 -87 3 -127 3l-114 -3v31c67 0 78 0 78 45v268c0 49 -8 56 -78 56v31l139 11v-110c14 43 50 110 123 110 c43 0 74 -29 74 -61Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2212" x="712" y="571"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-72" x="712" y="-211"></use>
</g>
</svg> as well.  If that sample is from a
perfect specular component, then again there is no need to use MIS and
the estimator is just <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="12.282ex" height="3.009ex" style="vertical-align: -0.838ex; margin-left: -0.073ex;" viewBox="-31.5 -934.9 5287.9 1295.7" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">p Subscript normal t Superscript plus Baseline left-parenthesis minus omega double-prime Subscript Baseline comma omega Subscript normal i Baseline right-parenthesis</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E2-LATINMODERNNORMAL-1D45D" d="M490 282c0 -147 -125 -293 -241 -293c-51 0 -79 35 -92 64c-7 -25 -49 -188 -49 -200c0 -9 0 -16 50 -16c14 0 24 0 24 -11c0 -20 -13 -20 -18 -20c-32 0 -66 3 -99 3c-28 0 -57 -3 -84 -3c-8 0 -13 4 -13 12c0 19 11 19 23 19c44 0 46 7 54 41l112 445c4 17 7 28 7 51 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c37 0 80 -21 90 -75c33 39 81 75 131 75c76 0 133 -66 133 -160zM418 326c0 59 -24 94 -64 94c-17 0 -46 -7 -81 -38c-18 -15 -45 -43 -52 -70 l-49 -196c-3 -12 -3 -16 -3 -16c0 -6 13 -89 79 -89c37 0 85 33 119 103c18 38 51 153 51 212Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-2B" d="M722 250c0 -11 -9 -20 -20 -20h-293v-293c0 -11 -9 -20 -20 -20s-20 9 -20 20v293h-293c-11 0 -20 9 -20 20s9 20 20 20h293v293c0 11 9 20 20 20s20 -9 20 -20v-293h293c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-74" d="M332 124c0 -64 -28 -135 -99 -135c-36 0 -129 12 -129 135v276h-85v22c98 4 128 111 129 193h25v-184h143v-31h-143v-278c0 -17 0 -108 67 -108c37 0 67 38 67 112v55h25v-57Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-2212" d="M722 250c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E2-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
<path stroke-width="1" id="E2-LATINMODERNVARIANTS-2033" d="M340 496c0 -10 -3 -20 -8 -28l-227 -372h-38l171 424c6 15 26 29 48 29c30 0 54 -24 54 -53zM580 496c0 -10 -3 -20 -8 -28l-227 -372h-38l171 424c6 15 26 29 48 29c30 0 54 -24 54 -53Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-69" d="M247 0c-34 1 -69 3 -104 3l-110 -3v31c67 0 78 0 78 45v269c0 49 -9 55 -74 55v31l140 11v-367c0 -39 4 -44 70 -44v-31zM192 604c0 -25 -20 -53 -54 -53c-30 0 -53 26 -53 53c0 25 20 53 54 53c30 0 53 -26 53 -53Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E2-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E2-LATINMODERNMAIN-2B" x="712" y="571"></use>
 <use transform="scale(0.707)" xlink:href="#E2-LATINMODERNMAIN-74" x="712" y="-384"></use>
 <use xlink:href="#E2-LATINMODERNMAIN-28" x="1153" y="0"></use>
 <use xlink:href="#E2-LATINMODERNMAIN-2212" x="1543" y="0"></use>
<g transform="translate(2321,0)">
 <use xlink:href="#E2-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E2-LATINMODERNVARIANTS-2033" x="880" y="513"></use>
</g>
 <use xlink:href="#E2-LATINMODERNMAIN-2C" x="3502" y="0"></use>
<g transform="translate(3947,0)">
 <use xlink:href="#E2-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E2-LATINMODERNMAIN-69" x="880" y="-213"></use>
</g>
 <use xlink:href="#E2-LATINMODERNMAIN-29" x="4866" y="0"></use>
</g>
</svg>.

</p>
<p></p>
<span class="anchor" id="fragment-UsemultipleimportancesamplingtoestimatePDFproduct-0"></span><div class="fragmentname">&lt;&lt;Use multiple importance sampling to estimate PDF product&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">pstd::optional&lt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample" class="code">BSDFSample</a>&gt; rs =
    rInterface.<a href="../Reflection_Models/BSDF_Representation.html#BSDF::Sample_f" class="code">Sample_f</a>(-wos-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>, r(), {r(), r()}, mode);
if (rs &amp;&amp; rs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::f" class="code">f</a> &amp;&amp; rs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::pdf" class="code">pdf</a> &gt; 0) {
    if (!<a href="../Reflection_Models/BSDF_Representation.html#BxDFFlags::IsNonSpecular" class="code">IsNonSpecular</a>(rInterface.<a href="../Reflection_Models/BSDF_Representation.html#BxDF::Flags" class="code">Flags</a>()))
        pdfSum += tInterface.<a href="../Reflection_Models/BSDF_Representation.html#BxDF::PDF" class="code">PDF</a>(-rs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>, <a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>, mode);
    else {
        &lt;&lt;<span class="fragmentname"><a href="#fragment-ComputeMIS-weightedestimateofEquationrefeq:pdf-triple-canceled-one-0">Compute MIS-weighted estimate of Equation (<a href="#eq:pdf-triple-canceled-one">14.38</a>)</a></span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2409" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2409"><i></i></a><div id="fragbit-2409" class="collapse show"><div class="fragmentcode">           Float rPDF = rInterface.<a href="../Reflection_Models/BSDF_Representation.html#BxDF::PDF" class="code">PDF</a>(-wos-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>, -wis-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>, mode);
           Float wt = <a href="../Monte_Carlo_Integration/Improving_Efficiency.html#PowerHeuristic" class="code">PowerHeuristic</a>(1, wis-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::pdf" class="code">pdf</a>, 1, rPDF);
           pdfSum += wt * rPDF;
           Float tPDF = tInterface.<a href="../Reflection_Models/BSDF_Representation.html#BxDF::PDF" class="code">PDF</a>(-rs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>, <a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>, mode);
           wt = <a href="../Monte_Carlo_Integration/Improving_Efficiency.html#PowerHeuristic" class="code">PowerHeuristic</a>(1, rs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::pdf" class="code">pdf</a>, 1, tPDF);
           pdfSum += wt * tPDF;</div></div>
    }
}</div><p>


</p>
<p>If neither interface has a specular sample, then both are combined.
For the first sampling technique, the second <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.753ex" height="3.009ex" style="vertical-align: -0.838ex; margin-left: -0.073ex;" viewBox="-31.5 -934.9 1185.5 1295.7" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">p Subscript normal t Superscript plus</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45D" d="M490 282c0 -147 -125 -293 -241 -293c-51 0 -79 35 -92 64c-7 -25 -49 -188 -49 -200c0 -9 0 -16 50 -16c14 0 24 0 24 -11c0 -20 -13 -20 -18 -20c-32 0 -66 3 -99 3c-28 0 -57 -3 -84 -3c-8 0 -13 4 -13 12c0 19 11 19 23 19c44 0 46 7 54 41l112 445c4 17 7 28 7 51 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c37 0 80 -21 90 -75c33 39 81 75 131 75c76 0 133 -66 133 -160zM418 326c0 59 -24 94 -64 94c-17 0 -46 -7 -81 -38c-18 -15 -45 -43 -52 -70 l-49 -196c-3 -12 -3 -16 -3 -16c0 -6 13 -89 79 -89c37 0 85 33 119 103c18 38 51 153 51 212Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2B" d="M722 250c0 -11 -9 -20 -20 -20h-293v-293c0 -11 -9 -20 -20 -20s-20 9 -20 20v293h-293c-11 0 -20 9 -20 20s9 20 20 20h293v293c0 11 9 20 20 20s20 -9 20 -20v-293h293c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-74" d="M332 124c0 -64 -28 -135 -99 -135c-36 0 -129 12 -129 135v276h-85v22c98 4 128 111 129 193h25v-184h143v-31h-143v-278c0 -17 0 -108 67 -108c37 0 67 38 67 112v55h25v-57Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2B" x="712" y="571"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-74" x="712" y="-384"></use>
</g>
</svg> factor cancels
out as well and the estimator is <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="14.302ex" height="3.009ex" style="vertical-align: -0.838ex; margin-left: -0.073ex;" viewBox="-31.5 -934.9 6157.6 1295.7" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">p Subscript normal r Superscript minus Baseline left-parenthesis minus omega prime Subscript Baseline comma minus omega double-prime Subscript Baseline right-parenthesis</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E2-LATINMODERNNORMAL-1D45D" d="M490 282c0 -147 -125 -293 -241 -293c-51 0 -79 35 -92 64c-7 -25 -49 -188 -49 -200c0 -9 0 -16 50 -16c14 0 24 0 24 -11c0 -20 -13 -20 -18 -20c-32 0 -66 3 -99 3c-28 0 -57 -3 -84 -3c-8 0 -13 4 -13 12c0 19 11 19 23 19c44 0 46 7 54 41l112 445c4 17 7 28 7 51 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c37 0 80 -21 90 -75c33 39 81 75 131 75c76 0 133 -66 133 -160zM418 326c0 59 -24 94 -64 94c-17 0 -46 -7 -81 -38c-18 -15 -45 -43 -52 -70 l-49 -196c-3 -12 -3 -16 -3 -16c0 -6 13 -89 79 -89c37 0 85 33 119 103c18 38 51 153 51 212Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-2212" d="M722 250c0 -11 -9 -20 -20 -20h-626c-11 0 -20 9 -20 20s9 20 20 20h626c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-72" d="M364 381c0 -32 -25 -44 -43 -44c-22 0 -43 15 -43 43c0 26 20 38 23 39c-2 1 -4 1 -11 1c-76 0 -118 -89 -118 -188v-154c0 -36 2 -47 76 -47h21v-31c-40 3 -87 3 -127 3l-114 -3v31c67 0 78 0 78 45v268c0 49 -8 56 -78 56v31l139 11v-110c14 43 50 110 123 110 c43 0 74 -29 74 -61Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-28" d="M332 -238c0 -5 -5 -10 -10 -10c-2 0 -4 1 -6 2c-110 83 -215 283 -215 454v84c0 171 105 371 215 454c2 1 4 2 6 2c5 0 10 -5 10 -10c0 -3 -2 -6 -4 -8c-104 -78 -173 -278 -173 -438v-84c0 -160 69 -360 173 -438c2 -2 4 -5 4 -8Z"></path>
<path stroke-width="1" id="E2-LATINMODERNNORMAL-1D714" d="M604 372c0 -40 -12 -90 -23 -133c-30 -121 -93 -250 -197 -250c-67 0 -102 44 -113 106c-38 -62 -90 -106 -153 -106c-76 0 -105 62 -105 143c0 35 5 74 15 112c16 63 41 127 82 184c5 6 12 9 18 9c3 0 6 0 9 -2c5 -3 9 -8 9 -14c0 -4 -2 -9 -5 -13 c-38 -53 -74 -109 -89 -169c-5 -22 -8 -45 -8 -65c0 -63 26 -113 87 -113c55 0 103 39 136 93c1 29 5 59 13 90c5 22 15 47 34 47c14 0 19 -11 19 -26c0 -8 -2 -17 -4 -26c-7 -30 -17 -60 -30 -88c9 -52 42 -90 98 -90c79 0 137 92 160 183c3 12 4 25 4 37 c0 35 -13 66 -38 88c-7 7 -11 15 -11 25c0 11 5 22 14 32c10 10 23 16 35 16c9 0 17 -3 23 -9c15 -13 20 -35 20 -61Z"></path>
<path stroke-width="1" id="E2-LATINMODERNVARIANTS-2032" d="M340 496c0 -10 -3 -20 -8 -28l-227 -372h-38l171 424c6 15 26 29 48 29c30 0 54 -24 54 -53Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-2C" d="M203 1c0 -117 -80 -194 -91 -194c-5 0 -10 4 -10 11c0 3 0 5 11 16c33 33 68 93 68 167c0 14 -2 15 -2 15s-2 -1 -5 -3c-10 -9 -23 -13 -35 -13c-33 0 -53 26 -53 53c0 28 20 53 53 53c39 0 64 -39 64 -105Z"></path>
<path stroke-width="1" id="E2-LATINMODERNVARIANTS-2033" d="M340 496c0 -10 -3 -20 -8 -28l-227 -372h-38l171 424c6 15 26 29 48 29c30 0 54 -24 54 -53zM580 496c0 -10 -3 -20 -8 -28l-227 -372h-38l171 424c6 15 26 29 48 29c30 0 54 -24 54 -53Z"></path>
<path stroke-width="1" id="E2-LATINMODERNMAIN-29" d="M288 208c0 -171 -105 -371 -215 -454c-2 -1 -4 -2 -6 -2c-5 0 -10 5 -10 10c0 3 2 6 4 8c104 78 173 278 173 438v84c0 160 -69 360 -173 438c-2 2 -4 5 -4 8c0 5 5 10 10 10c2 0 4 -1 6 -2c110 -83 215 -283 215 -454v-84Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E2-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E2-LATINMODERNMAIN-2212" x="712" y="571"></use>
 <use transform="scale(0.707)" xlink:href="#E2-LATINMODERNMAIN-72" x="712" y="-211"></use>
 <use xlink:href="#E2-LATINMODERNMAIN-28" x="1153" y="0"></use>
 <use xlink:href="#E2-LATINMODERNMAIN-2212" x="1543" y="0"></use>
<g transform="translate(2321,0)">
 <use xlink:href="#E2-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E2-LATINMODERNVARIANTS-2032" x="880" y="513"></use>
</g>
 <use xlink:href="#E2-LATINMODERNMAIN-2C" x="3332" y="0"></use>
 <use xlink:href="#E2-LATINMODERNMAIN-2212" x="3777" y="0"></use>
<g transform="translate(4556,0)">
 <use xlink:href="#E2-LATINMODERNNORMAL-1D714" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E2-LATINMODERNVARIANTS-2033" x="880" y="513"></use>
</g>
 <use xlink:href="#E2-LATINMODERNMAIN-29" x="5736" y="0"></use>
</g>
</svg> times the
MIS weight.

</p>
<p></p>
<span class="anchor" id="fragment-ComputeMIS-weightedestimateofEquationrefeq:pdf-triple-canceled-one-0"></span><div class="fragmentname">&lt;&lt;Compute MIS-weighted estimate of Equation (<a href="#eq:pdf-triple-canceled-one">14.38</a>)&gt;&gt;=&nbsp;<a href="#fragment-ComputeMIS-weightedestimateofEquationrefeq:pdf-triple-canceled-one-1"><span class="fa fa-caret-down"></span></a></div>
<div class="fragmentcode">Float rPDF = rInterface.<a href="../Reflection_Models/BSDF_Representation.html#BxDF::PDF" class="code">PDF</a>(-wos-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>, -wis-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>, mode);
Float wt = <a href="../Monte_Carlo_Integration/Improving_Efficiency.html#PowerHeuristic" class="code">PowerHeuristic</a>(1, wis-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::pdf" class="code">pdf</a>, 1, rPDF);
pdfSum += wt * rPDF;</div><p>


</p>
<p>Similarly, for the second sampling technique, we are left with a
<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.753ex" height="3.009ex" style="vertical-align: -0.838ex; margin-left: -0.073ex;" viewBox="-31.5 -934.9 1185.5 1295.7" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">p Subscript normal t Superscript plus</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D45D" d="M490 282c0 -147 -125 -293 -241 -293c-51 0 -79 35 -92 64c-7 -25 -49 -188 -49 -200c0 -9 0 -16 50 -16c14 0 24 0 24 -11c0 -20 -13 -20 -18 -20c-32 0 -66 3 -99 3c-28 0 -57 -3 -84 -3c-8 0 -13 4 -13 12c0 19 11 19 23 19c44 0 46 7 54 41l112 445c4 17 7 28 7 51 c0 38 -14 46 -31 46c-36 0 -56 -48 -73 -119c-6 -22 -7 -23 -17 -23c0 0 -12 0 -12 10c0 3 13 63 31 97c9 18 28 57 74 57c37 0 80 -21 90 -75c33 39 81 75 131 75c76 0 133 -66 133 -160zM418 326c0 59 -24 94 -64 94c-17 0 -46 -7 -81 -38c-18 -15 -45 -43 -52 -70 l-49 -196c-3 -12 -3 -16 -3 -16c0 -6 13 -89 79 -89c37 0 85 33 119 103c18 38 51 153 51 212Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2B" d="M722 250c0 -11 -9 -20 -20 -20h-293v-293c0 -11 -9 -20 -20 -20s-20 9 -20 20v293h-293c-11 0 -20 9 -20 20s9 20 20 20h293v293c0 11 9 20 20 20s20 -9 20 -20v-293h293c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-74" d="M332 124c0 -64 -28 -135 -99 -135c-36 0 -129 12 -129 135v276h-85v22c98 4 128 111 129 193h25v-184h143v-31h-143v-278c0 -17 0 -108 67 -108c37 0 67 38 67 112v55h25v-57Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNNORMAL-1D45D" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-2B" x="712" y="571"></use>
 <use transform="scale(0.707)" xlink:href="#E1-LATINMODERNMAIN-74" x="712" y="-384"></use>
</g>
</svg> PDF to evaluate and then weight using MIS.

</p>
<p></p>
<span class="anchor" id="fragment-ComputeMIS-weightedestimateofEquationrefeq:pdf-triple-canceled-one-1"></span><div class="fragmentname">&lt;&lt;Compute MIS-weighted estimate of Equation (<a href="#eq:pdf-triple-canceled-one">14.38</a>)&gt;&gt;+=&nbsp;<a href="#fragment-ComputeMIS-weightedestimateofEquationrefeq:pdf-triple-canceled-one-0"><span class="fa fa-caret-up"></span></a></div>
<div class="fragmentcode">Float tPDF = tInterface.<a href="../Reflection_Models/BSDF_Representation.html#BxDF::PDF" class="code">PDF</a>(-rs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>, <a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::wi" class="code">wi</a>, mode);
wt = <a href="../Monte_Carlo_Integration/Improving_Efficiency.html#PowerHeuristic" class="code">PowerHeuristic</a>(1, rs-&gt;<a href="../Reflection_Models/BSDF_Representation.html#BSDFSample::pdf" class="code">pdf</a>, 1, tPDF);
pdfSum += wt * tPDF;</div><p>


</p>
<p>The &lt;&lt;<span class="fragmentname">Evaluate TT term for PDF estimate</span>&gt;&gt; fragment is of a similar
form, so it is not included here.

</p>
<p>

</p>
<p>The final returned PDF value has the PDF for uniform spherical sampling,
<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.812ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 2072 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">1 slash 4 pi</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-31" d="M419 0c-35 3 -122 3 -162 3s-127 0 -162 -3v31h32c90 0 93 12 93 48v518c-52 -26 -111 -26 -131 -26v31c32 0 120 0 182 64c23 0 23 -2 23 -26v-561c0 -37 3 -48 93 -48h32v-31Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-2F" d="M445 730c0 -2 0 -5 -1 -7l-349 -960c-3 -8 -10 -13 -19 -13c-11 0 -20 9 -20 20c0 2 0 5 1 7l349 960c3 8 10 13 19 13c11 0 20 -9 20 -20Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-34" d="M471 165h-100v-87c0 -36 2 -47 76 -47h21v-31c-41 3 -94 3 -136 3s-94 0 -135 -3v31h21c74 0 76 11 76 47v87h-266v31l307 469c8 12 11 12 20 12c16 0 16 -6 16 -26v-455h100v-31zM300 196v373l-244 -373h244Z"></path>
<path stroke-width="1" id="E1-LATINMODERNNORMAL-1D70B" d="M567 407c0 -34 -36 -34 -49 -34h-114c-11 -52 -18 -106 -18 -159c0 -28 0 -93 29 -165c6 -14 6 -16 6 -22c0 -20 -21 -38 -41 -38c-15 0 -26 6 -36 50c-8 34 -8 61 -8 76c0 67 9 110 42 258h-113l-56 -221c-13 -50 -13 -52 -27 -98c-12 -37 -20 -65 -50 -65 c-13 0 -29 8 -29 27c0 7 0 9 8 24c42 91 96 212 128 333h-57c-20 0 -78 0 -127 -77c-6 -8 -8 -12 -16 -12c-12 0 -12 10 -12 10c0 5 26 51 61 90c44 47 82 47 104 47h335c19 0 40 0 40 -24Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-31" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-2F" x="500" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-34" x="1001" y="0"></use>
 <use xlink:href="#E1-LATINMODERNNORMAL-1D70B" x="1501" y="0"></use>
</g>
</svg>, mixed with the estimate to account for higher-order terms.

</p>
<p></p>
<span class="anchor" id="fragment-ReturnmixtureofPDFestimateandconstantPDF-0"></span><div class="fragmentname">&lt;&lt;Return mixture of PDF estimate and constant PDF&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">return <a href="../Monte_Carlo_Integration/Sampling_Using_the_Inversion_Method.html#Lerp" class="code">Lerp</a>(0.9f, 1 / (4 * <a href="../Utilities/Mathematical_Infrastructure.html#Pi" class="code">Pi</a>), pdfSum / <a href="#LayeredBxDF::nSamples" class="code">nSamples</a>);</div><p>


</p>
<p>

</p>
<p>

</p>
<p></p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">
<a href="#CoatedDiffuseandCoatedConductorMaterials"><i class="fas fa-link h3h4marginlink"></i></a>
</div>
<div class="col-md-10 col-lg-8">
<span class="anchor" id="sec:coated-bxdf-specializations"></span><span id="CoatedDiffuseandCoatedConductorMaterials"></span><h3>14.3.3  Coated Diffuse and Coated Conductor Materials</h3><p>



</p>
<p>Adding a dielectric interface on top of both diffuse materials and
conductors is often useful to model surface reflection.  For example,
plastic can be modeled by putting such an interface above a diffuse
material, and coated metals can be modeled by adding
such an interface as well.  In both cases, introducing a scattering layer
can model effects like tarnish or weathering.  Figure&nbsp;<a href="#fig:layered-bxdf-dragon-renderings">14.22</a>
shows the dragon model with a few variations of these.

</p>
<p><tt>pbrt</tt> provides both the <tt>CoatedDiffuseBxDF</tt> and the
<tt>CoatedConductorBxDF</tt> for such uses.  There is almost nothing to their
implementations other than a public inheritance from <a href="#LayeredBxDF"><tt>LayeredBxDF</tt></a> with
the appropriate types for the two interfaces.

</p>
<p></p>
<span class="anchor" id="fragment-CoatedDiffuseBxDFDefinition-0"></span><div class="fragmentname">&lt;&lt;CoatedDiffuseBxDF Definition&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">class <span class="anchor" id="CoatedDiffuseBxDF"></span>CoatedDiffuseBxDF :
    public <a href="#LayeredBxDF" class="code">LayeredBxDF</a>&lt;<a href="../Reflection_Models/Dielectric_BSDF.html#DielectricBxDF" class="code">DielectricBxDF</a>, <a href="../Reflection_Models/Diffuse_Reflection.html#DiffuseBxDF" class="code">DiffuseBxDF</a>, true&gt; {
  public:
    &lt;&lt;<span class="fragmentname">CoatedDiffuseBxDF Public Methods</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2410" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2410"><i></i></a><div id="fragbit-2410" class="collapse show"><div class="fragmentcode">       using LayeredBxDF::LayeredBxDF;
       PBRT_CPU_GPU
       static constexpr const char *Name() { return "CoatedDiffuseBxDF"; }</div></div>
};</div><p>


</p>
<p>

</p>
<p></p>
<span class="anchor" id="fragment-CoatedConductorBxDFDefinition-0"></span><div class="fragmentname">&lt;&lt;CoatedConductorBxDF Definition&gt;&gt;=&nbsp;</div>
<div class="fragmentcode">class <span class="anchor" id="CoatedConductorBxDF"></span>CoatedConductorBxDF :
    public <a href="#LayeredBxDF" class="code">LayeredBxDF</a>&lt;<a href="../Reflection_Models/Dielectric_BSDF.html#DielectricBxDF" class="code">DielectricBxDF</a>, <a href="../Reflection_Models/Conductor_BRDF.html#ConductorBxDF" class="code">ConductorBxDF</a>, true&gt; {
  public:
    &lt;&lt;<span class="fragmentname">CoatedConductorBxDF Public Methods</span>&gt;&gt;&nbsp;<a data-toggle="collapse" href="#fragbit-2411" role="button" class="fa codecarat" aria-expanded="true" aria-controls="fragbit-2411"><i></i></a><div id="fragbit-2411" class="collapse show"><div class="fragmentcode">       PBRT_CPU_GPU
       static constexpr const char *Name() { return "CoatedConductorBxDF"; }
       using LayeredBxDF::LayeredBxDF;</div></div>
};</div><p>


</p>
<p> </p>
<span class="anchor" id="fig:layered-bxdf-dragon-renderings"></span><div class="card outerfigure"><div class="card-body figure"><p>


</p>
<div class="figure-row">
<img src="dragon-diffuse.png" style="max-width: 100%; height: auto;" width=1500 height=900>
</div>
<p>

</p>
<div class="figure-row">
<img src="dragon-coated-diffuse-r0.png" style="max-width: 100%; height: auto;" width=1500 height=900>
</div>
<p>

</p>
<div class="figure-row">
<img src="dragon-coated-diffuse-r0.2.png" style="max-width: 100%; height: auto;" width=1500 height=900>
</div>
<p>

</p>
<figcaption class="caption">Figure 14.22: A Variety of Effects That Can Be Achieved Using Layered Materials.
<span class="legend">
(a)&nbsp;Dragon model with a blue diffuse BRDF.
(b)&nbsp;The effect of adding a smooth dielectric interface on top of the
diffuse BRDF.  In addition to the specular highlights, note how the 
color has become more saturated, which is due to multiple scattering from
paths that reflected back into the medium from the exit interface.
(c)&nbsp;The effect of roughening the interface.  The surface appears less
shiny, but the blue remains more saturated.
<em>(Dragon model courtesy of the Stanford Computer Graphics Laboratory.)</em>
</span>
</figcaption><p>


</p>
</div></div><p>


</p>
<p>There are also corresponding <a href="../Textures_and_Materials/Material_Interface_and_Implementations.html#Material"><tt>Material</tt></a> implementations,
<tt>CoatedDiffuseMaterial</tt><span class="anchor" id="CoatedDiffuseMaterial"></span> and
<tt>CoatedConductorMaterial</tt><span class="anchor" id="CoatedConductorMaterial"></span>.  Their
implementations follow the familiar pattern of evaluating textures and then
initializing the corresponding <tt>BxDF</tt>, and they are therefore not
included&nbsp;here.

</p>
<p>

</p>
<p>

</p>
<p>

</p>
<p></p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

</div>  <!-- container-fluid -->
</div>  <!-- maincontainer -->

<nav class="navbar navbar-expand-md bg-light navbar-light">
<div class="container-fluid">
  <span class="navbar-text"><i>Physically Based Rendering: From Theory To Implementation</i>,<br>
<a href="https://creativecommons.org/licenses/by-nc-nd/4.0/">&copy; 2004-2023</a> Matt Pharr, Wenzel Jakob, and Greg Humphreys.
<a href="https://github.com/mmp/pbr-book-website/"><span class="fab fa-github"></span></a><br>
Purchase a printed copy: <a href="https://www.amazon.com/Physically-Based-Rendering-fourth-Implementation/dp/0262048027?keywords=physically+based+rendering+4th+edition&qid=1671730412&sprefix=physically+based%!C(MISSING)aps%!C(MISSING)145&sr=8-1&linkCode=ll1&tag=pharr-20&linkId=81a816d90f0c7e872617f1f930a51fd6&language=en_US&ref_=as_li_ss_tl"><span class="fab fa-amazon"></span></a>
<a href="https://mitpress.mit.edu/9780262048026/physically-based-rendering/"><img src="/mitpress.png" width=10 height=16></a>
</span>
</div>
  <div class="container">
    <ul class="nav navbar-nav ml-auto">
      <li class="nav-item">Next: <a href="../Light_Transport_II_Volume_Rendering/Further_Reading.html">Light Transport II: Volume Rendering / Further Reading</a></li>
    </ul>
  </div>

</nav>

<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
<script>
  $(function () {
    $('[data-toggle="popover"]').popover()
    $('[data-toggle="tooltip"]').tooltip()
   })
</script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>

<script>
// https://stackoverflow.com/a/17535094
// The function actually applying the offset
function offsetAnchor() {
  if (location.hash.length !== 0) {
    window.scrollTo(window.scrollX, window.scrollY - window.innerHeight / 8);
  }
}

// Captures click events of all <a> elements with href starting with #
$(document).on('click', 'a[href^="#"]', function(event) {
  // Click events are captured before hashchanges. Timeout
  // causes offsetAnchor to be called after the page jump.
  window.setTimeout(function() {
    offsetAnchor();
  }, 500);
});

// Set the offset when entering page with hash present in the url
window.setTimeout(offsetAnchor, 1500);
</script>

</body>
</html>
